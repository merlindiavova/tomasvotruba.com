<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Dependency Juggling Code Smell | Tomas Votruba</title>
<meta charset="utf-8">
<meta name="robots" content="index, follow">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:creator" content="@votrubaT"/>

    <meta property="og:title" content="Dependency Juggling Code Smell" />
    <meta property="og:url" content="https://tomasvotruba.com/blog/dependency-juggling-code-smell" />

            <meta property="og:image" content="/assets/images/tomas_votruba.jpg"/>
        <meta name="twitter:image" content="/assets/images/tomas_votruba.jpg"/>
    
<link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">


<link rel="stylesheet" rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:700&amp;display=swap" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" media="print" onload="this.media='all'">

<link href="/assets/css/style.css?310713322" rel="stylesheet" type="text/css" />

                <meta name="description" property="og:description" content="The best way to pass dependencies is via constructor injection. Only in services, we need the dependency in. I&#039;ve noticed that **sometimes the dependency is passed way too early**, just to be passed to another service as a method argument.

Why is it a code smell, and how can we avoid it?
" />
    </head>

    <body>
        <!-- post_id: 313 -->
        <div id="menu">
    <div class="container-fluid">
        <a href="/">Home</a>
        <span class="pl-2 pr-2">‚Ä¢</span>

        <a href="/blog">Blog</a>
        <span class="pl-2 pr-2">‚Ä¢</span>

        <a href="/book/the-power-of-automated-refactoring">Book</a>
        <span class="pl-2 pr-2">‚Ä¢</span>

        <a href="/trainings">Trainings</a>
        <span class="pl-2 pr-2">‚Ä¢</span>

        <a href="/contact">Contact</a>
        <span class="pl-2 pr-2">‚Ä¢</span>

        <a href="/about-me">About Me</a>
        <span class="pl-2 pr-2">‚Ä¢</span>

        <a href="https://twitter.com/votrubaT" target="blank">Twitter</a>
        <span class="pl-2 pr-2">‚Ä¢</span>

        <a href="/rss.xml" target="blank">RSS</a>
    </div>
</div>

        <div class="container-fluid post" id="content">
            <div class="text-center book-banner">
                <a href="https://leanpub.com/rector-the-power-of-automated-refactoring" target="blank" class="text-center">
                    <img src="/assets/images/banner-rector-book.png" class="mb-2 ml-auto mr-auto rounded " style="max-height: 5em" alt="">
                </a>
            </div>

            <h1>Dependency Juggling Code Smell</h1>

            <div class="pull-right">
                <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/main/packages/blog/data/2021/2021-04-26-dependency-juggling-code-smell.md">Found a typo? Edit me</a>
            </div>

            <time datetime="2021-04-Mon" class="text-muted">
                2021-04-26
            </time>

            
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>The best way to pass dependencies is via constructor injection. Only in services, we need the dependency in. I've noticed that <strong>sometimes the dependency is passed way too early</strong>, just to be passed to another service as a method argument.
<br><br>
Why is it a code smell, and how can we avoid it?</p>
                </div>
            </div>

            <p>Because constructor injection has good karma, we automatically assume that everything in <code>__construct(...)</code> is correct. That's why we can easily miss it.</p>
<p>Imagine this code in your project:</p>
<pre><code class="language-php">final class TypeResolver
{
    public function __construct(
        // using PHP 8 property promotion here
        private StringTypeResolver $stringTypeResolver,
        private ConstantStringTypeResolver $constantStringTypeResolver,
    ) {
    }

    public function resolve(Expr $expr): Type
    {
        return $this-&gt;stringTypeResolver-&gt;resolveFromExpr(
            $expr,
            $this-&gt;constantStringTypeResolver,
        );
    }
}</code></pre>
<p>Can you see the smell in here? We have 2 services passed as a dependency in the constructor:</p>
<ul>
<li><code>StringTypeResolver</code></li>
<li><code>ConstantStringTypeResolver</code></li>
</ul>
<p>Constructor states what dependencies this class needs to work.</p>
<p><br></p>
<p>How many of them the <strong>class directly uses</strong>? Just the <code>StringTypeResolver</code> one.</p>
<p>The other one <code>ConstantStringTypeResolver</code> is juggled to <code>StringTypeResolver</code> as side dependency.</p>
<h2 id="2-Pair-of-Keys">2 Pair of Keys</h2>
<img src="https://user-images.githubusercontent.com/924196/116310231-03810c80-a7aa-11eb-8053-508de8ba8149.jpg" class="img-thumbnail">
<p>It's like your own keys from your home with one extra pair. You take them both with you everywhere. You use the first pair to unlock doors from your home. The extra pair you use exclusively when you open your door for your wife.</p>
<p>Why would you have these extra keys for your own? Instead, <strong>give them to your wife and let her handle it</strong>.</p>
<blockquote class="blockquote pt-3 pb-3 text-center">
Each service should take care only of its own dependencies.
<br>
not take responsibility for others.
</blockquote>
<p>If we apply this approach to our code, we can move the <code>ConstantStringTypeResolver</code> where it belongs:</p>
<pre><code class="language-diff"> final class TypeResolver
 {
     public function __construct(
        private StringTypeResolver $stringTypeResolver,
-       private ConstantStringTypeResolver $constantStringTypeResolver,
     ) {
     }

     public function resolve(Expr $expr): Type
     {
         return $this-&gt;stringTypeResolver-&gt;resolveFromExpr(
             $expr,
-            $this-&gt;constantStringTypeResolver,
         );
     }
 }</code></pre>
<p>The <code>StringTypeResolver</code> now handles its dependencies on its own:</p>
<pre><code class="language-diff"> final class StringTypeResolver
 {
+    public function __construct()
+    {
+        private ConstantStringTypeResolver $constantStringTypeResolver,
+    }

     public function resolveFromExpr(
        Expr $expr,
-       ConstantStringTypeResolver $constantStringTypeResolver,
     ) {
-        $constantStringTypeResolver-&gt;resolve(...);
+        $this-&gt;constantStringTypeResolver-&gt;resolve(...);
         // ...
     }
 }</code></pre>
<p>üëç</p>
<p><br></p>
<h2 id="PHPStan-Got-Your-Back">PHPStan Got Your Back</h2>
<p>The tricky part is to watch for these cases not to get into your code. It's easy to take 2 key sets instead of 1 when you're in a rush to catch a tram or taxi.</p>
<p><a href="https://github.com/symplify/phpstan-rules">Symplify PHPStan Rules</a> got you covered. Just install it:</p>
<pre><code class="language-bash">composer require symplify/phpstan-rules --dev</code></pre>
<p>Then add the rule to your <code>phpstan.neon</code> config:</p>
<pre><code class="language-yaml">services:
     -
        class: Symplify\PHPStanRules\Rules\NoDependencyJugglingRule
        tags: [phpstan.rules.rule]</code></pre>
<p>The rule looks for constructor dependencies that are juggled to method calls. Don't worry about it, and let your CI handle it.
That's all for today.</p>
<p><br></p>
<p>Happy coding!</p>

            <br>


            <div class="card mt-5 border-warning">
                <div class="card-body text-center mt-2">
                    <p>
                        Have you find this post useful? <strong>Do you want more?</strong>
                    </p>
                    <p>
                        Follow me on <a href="https://twitter.com/votrubaT">Twitter</a>, <a href="/rss.xml">RSS</a> or support me on <a href="https://github.com/sponsors/TomasVotruba">GitHub Sponsors</a>.
                    </p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body text-white bg-success text-center">
                                            <a href="/blog/how-can-we-use-github-actions-in-gitlab" class="d-block">
                            <div>
                                Read next ‚Üí <strong>How can We use GitHub Actions in Gitlab?</strong>
                            </div>
                        </a>
                                    </div>
            </div>

            <br>
            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />
        <script src="/assets/prism/prism.js"></script>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

        <script type="text/javascript">
            // @see https://stackoverflow.com/a/30776817/1348344
            var date = new Date();
            // display every 2nd hour, not to spam users
            if (date.getHours() % 2 === 1) {
                document.querySelector('.book-banner').style.display = 'visible';
            } else {
                document.querySelector('.book-banner').style.display = 'none';
            }
        </script>
    </body>
</html>
