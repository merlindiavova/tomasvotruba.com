<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Clean and Decoupled Controllers, Commands and Event Subscribers Once and for All with Delegator Pattern | Tomas Votruba</title>
<meta charset="utf-8">
<meta name="robots" content="index, follow">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:creator" content="@votrubaT"/>

<meta property="og:image" content="/assets/images/tomas_votruba.jpg"/>

<link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">


<link rel="stylesheet" rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:700&amp;display=swap" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" media="print" onload="this.media='all'">

<link href="/assets/css/style.css?1605901804" rel="stylesheet" type="text/css" />

                <meta property="og:title" content="Clean and Decoupled Controllers, Commands and Event Subscribers Once and for All with Delegator Pattern" />
        <meta property="og:url" content="https://tomasvotruba.com/blog/2018/01/08/clean-and-decoupled-controllers-commands-and-event-subscribers-once-and-for-all-with-delegator-pattern" />
        <meta name="description" property="og:description" content="Do you write your application for **better future sustainability** or just to get paid for it today?
If you&#039;re the first one, you care about design patterns. I&#039;m happy to see you!


Today I will show you **why and how to use *delegator pattern*** in your application so it makes it to the pension.
" />

                    <meta property="og:image" content="https://tomasvotruba.com/assets/images/posts/2018/delegator/trash-everywhere.jpg" />
            <meta name="twitter:card" content="summary_large_image"/>
            </head>

    <body>
        <!-- post_id: 71 -->
        <div id="menu">
    <div class="container-fluid">
        <a href="/">Home</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/blog">Blog</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/book/the-power-of-automated-refactoring">Book</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/trainings">Trainings</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/contact">Contact</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/about-me">About Me</a>
        <span class="pl-2 pr-2">•</span>

        <a href="https://twitter.com/votrubaT" target="blank">Twitter</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/rss.xml" target="blank">RSS</a>
    </div>
</div>

        <div class="container-fluid post" id="content">
            <div class="text-center book-banner">
                <a href="https://leanpub.com/rector-the-power-of-automated-refactoring" target="blank" class="text-center">
                    <img src="/assets/images/banner-rector-book.png" class="mb-2 ml-auto mr-auto rounded " style="max-height: 5em" alt="">
                </a>
            </div>

            <h1>Clean and Decoupled Controllers, Commands and Event Subscribers Once and for All with Delegator Pattern</h1>

            <div class="pull-right">
                <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/main/packages/blog/data/2018/2018-01-08-clean-and-decoupled-controllers-commands-and-event-subscribers-once-and-for-all-with-delegator-pattern.md">Found a typo? Edit me</a>
            </div>

            <time datetime="2018-01-Mon" class="text-muted">
                2018-01-08
            </time>

            
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>Do you write your application for <strong>better future sustainability</strong> or just to get paid for it today?
If you're the first one, you care about design patterns. I'm happy to see you!
<br>
<br>
Today I will show you <strong>why and how to use <em>delegator pattern</em></strong> in your application so it makes it to the pension.</p>
                </div>
            </div>

            <p><br></p>
<blockquote class="blockquote text-center">
    "Every code is trash!"
</blockquote>
<p><br></p>
<p>You'll see. But before we dig into code... what are the reasons to write sustainable code and how it looks like?</p>
<h2 id="Why-Should-You-Care-About-Future-Sustainability">Why Should You Care About Future Sustainability</h2>
<p>There are 3 levels of developers by the time-frame focus they work on. Every group has it's advantages and disadvantages. You'll soon see which one you fit in.</p>
<h3 id="1-Developers-who-Code-for-NOW">1. Developers who <strong>Code for NOW</strong></h3>
<p>This project. Single site for 2018 elections. Microsite for new product release in 2019. Include anything that is hype in socials last year.</p>
<p><strong>If the code would be a trash</strong> (literally!), they'd throw everything to 1 bag or maybe right in the city streets or nature. <strong>Someone
else will handle cleaning up the city</strong> #yolo</p>
<img src="/assets/images/posts/2018/delegator/trash-everywhere.jpg" class="img-thumbnail">
<h3 id="2-Developers-who-Code-for-next-1-2-YEARS">2. Developers who Code for next 1-2 YEARS</h3>
<p>The project has tests, continuous integration, uses stable packages with 1.0 release. It's startup or a project with profit. The team is fine and slowly growing. It's their first or second project and they try to take good care about it, with experiences they have.</p>
<p>They don't make any mess around the city and <strong>put all trash to 1 trash bin</strong>. Take them out regularly once a week. They're nice to the world. Well, at least at first sight.</p>
<img src="/assets/images/posts/2018/delegator/orbit-junk.jpg" class="img-thumbnail">
<h3 id="3-Developer-who-Code-for-next-5-10-YEARS-Future-Sustainability">3. Developer who Code for next 5-10 YEARS - Future Sustainability</h3>
<p>...or at least with that mindset in their minds. The code won't probably work with PHP 9.0, but they do their best to make it as easy as possible to do so.</p>
<p>They have great experience with handful of project described in previous group. They already worked on 5 open-source projects <strong>they need to last as long as possible without as little maintenance as possible</strong>.</p>
<p><strong>To the trash again...</strong></p>
<p>It's like recycling plastic bags, glass bottler and papers.</p>
<p>You put effort to it:</p>
<ul>
<li>create space in your home to keep 3 separated trash bins,</li>
<li>explain everyone to use them and split every product to own bin</li>
<li>and when it's full you take these bags out for 5 minutes walk to their destination.</li>
</ul>
<img src="/assets/images/posts/2018/delegator/manage-it-right.jpg" class="img-thumbnail">
<p><strong>Though you never see the trash again, you believe it's good for your future self and for your children</strong>, to keep planet clean and away from trash lands. Economists would call it <em>positive externality</em>.</p>
<p><br></p>
<p>Now you know <strong>why it's good to separate waste</strong> (= code), let's get to real code.</p>
<h2 id="4-years-in-life-of-New-Web-Application">4 years in life of New Web Application</h2>
<p>Let's have a project that was born in 2015 and see how it slowly grew. It will eventually use all patterns we described in the beginning - except <em>delegator</em>, which is unfortunate for the investors of this project.</p>
<h3 id="2015-Start-with-Controllers">2015 - Start with Controllers</h3>
<p>Project start with few controllers that contain most of logic. It's fast and easy to add new controller with new logic.</p>
<p>By the end of the year there are 50 controllers like this:</p>
<pre><code class="language-php">class ProductController extends Controller
{
    public function allAction()
    {
        $allProducts = $this-&gt;getEntityManager()-&gt;getRepository(Product::class)
            -&gt;fetchAll();

        return new TemplateResponse('all.twig', [
            'allProducts' =&gt; $allProducts
        ]);
    }
}</code></pre>
<p>Also, it's in the documentation of the framework, so it must be <a href="https://matthiasnoback.nl/2014/10/unnecessary-contrapositions-in-the-new-symfony-best-practices">the best practise</a>.</p>
<p>Little we know, here starts our <a href="https://blog.codinghorror.com/the-broken-window-theory">Broken Window Theory</a>, the most underestimated effect from social science in software world.</p>
<h3 id="2016-Add-few-Commands">2016 - Add few Commands</h3>
<p>Application grows and the size needs pre-caching handled by running commands in CRON. So you start using <a href="/blog/2019/08/12/standalone-symfony-console-from-scratch/">Symfony\Console</a>. You get inspired by <code>Controller</code>, because <code>Command</code> looks like it and by the end of year, there are many command like this one:</p>
<pre><code class="language-php">class CacheProductsCommand extends Command
{
    /**
     * @var EntityManager
     */
    private $entityManager;

    public function __construct(EntityManager $entityManager)
    {
        $this-&gt;entityManager = $entityManager;
    }

    public function execute()
    {
        $allProducts = $this-&gt;entityManager-&gt;getRepository(Product::class)
            -&gt;fetchAll();

        // cache them all
    }
}</code></pre>
<h3 id="2017-Add-just-few-more-EventSubscribers">2017 - Add just few more EventSubscribers</h3>
<p>It's 2017, AI is on hype and you start thinking about product recommendation feature. You use <a href="/blog/2019/08/05/standalone-symfony-event-dispatcher-from-the-scratch/">EventSubscribers</a> that saves many information about user behavior and return best producs just for him.</p>
<pre><code class="language-php">class RecommendedProductsEventSubscriber implements EventSubscriber
{
    /**
     * @var EntityManager
     */
    private $entityManager;

    public function __construct(EntityManager $entityManager)
    {
        $this-&gt;entityManager = $entityManager;
    }

    public static function subscribe()
    {
        return ['onPageVisit' =&gt; 'setRecommendedProducts'];
    }

    public function setRecommendedProducts(BehaviorPatternEvent $behaviorPatternEvent)
    {
        $productRepository = $this-&gt;entityManager-&gt;getRepository(Product::class);

        $product = $productRepository-&gt;findBestByBehavior($behaviorPatternEvent-&gt;getBehavior());
        $behaviorPatternEvent-&gt;setRecommendedProducts($product;
    }
}</code></pre>
<p>So far so good?</p>
<h3 id="2018-Year-of-Changes">2018 - Year of Changes</h3>
<blockquote class="blockquote text-center mt-5 mb-5">
    "Change is the only constant."
    <footer class="blockquote-footer">John Candee Dean</footer>
</blockquote>
<p>New owner with technical skills comes the the play. And he wants to finally use <code>VueJs</code>, the company is now big enough to use Docker as standards and <strong>there are more programmers that know <a href="https://laravel.com/docs/eloquent">Eloquent</a> than <a href="/blog/2017/03/27/why-is-doctrine-dying/">Doctrine</a> in his country</strong>:</p>
<p><em>&quot;Alibaba is catching up and we might lose the position #1 leader on market. Just switch it to Eloquent, so we can hire and on board faster.</em>&quot;</p>
<p>Ups! Your code is coupled to the Doctrine and Symfony pretty hard. You're standing in front of important question: <strong>Do you get extra $ 10 000 to refactor the code?</strong></p>
<p>Posing this question, now we finally understand <a href="https://blog.codinghorror.com/the-broken-window-theory">Broken Window Theory</a>...</p>
<img src="/assets/images/posts/2018/delegator/broken-window.jpg" class="img-thumbnail">
<p>...because we have personal experience with going it the wrong way. Little to late.</p>
<h2 id="Prevention-over-Experience">Prevention over Experience</h2>
<ul>
<li>What could be done better?</li>
<li>Could you prevent this?</li>
<li><strong>Do you separate your trash or do you wait till your country becomes plastic land?</strong></li>
</ul>
<img src="/assets/images/posts/2018/delegator/plastic-land.jpg" class="img-thumbnail">
<p>No. You think for <strong>the future</strong> with prevention!</p>
<blockquote class="blockquote text-center mt-5 mb-5">
    "Plan like you will live forever, and then live like there is no tomorrow."
    <footer class="blockquote-footer"> Mahatma Gandhi</footer>
</blockquote>
<p>Same can be applied to your code.</p>
<h3 id="Delegator-Pattern-to-the-Rescue-Prevention">Delegator Pattern to the <del>Rescue</del> Prevention</h3>
<p>This is what we did in <a href="https://www.lekarna.cz">Lekarna.cz</a> - The biggest online drugstore in the Czech Republic. It started on Nette 2.4 and Doctrine 2.5, with <a href="/blog/2017/12/25/composer-local-packages-for-dummies/">monorepo approach</a>.</p>
<p>When a class pattern is marked as <em>delegator</em>, it <strong>can't contain any direct connection to database layer</strong> (Doctrine in this case).</p>
<p>Among most popular delegators belongs:</p>
<ul>
<li>Controller</li>
<li>Command</li>
<li>EventSubscriber</li>
<li>Presenter or Component in <a href="https://nette.org">Nette</a></li>
<li>CommandHandler from <a href="https://ocramius.github.io/ShittyCQRSPresentation">CQRS</a> etc.</li>
</ul>
<p>In Lekarna, these classes can only use own service to access products - <code>ProductRepository</code>:</p>
<pre><code class="language-php">class ProductRepository
{
    public function __construct(EntityManager $entityManager)
    {
        $this-&gt;repository = $entityManager-&gt;getRepository(Product::class);
    }

    public function fetchAll()
    {
        return $this-&gt;repository-&gt;fetchAll();
    }
}</code></pre>
<p>You don't want to check this in code reviews (imagine 5 years doing it), just <a href="/blog/2017/07/17/how-to-write-custom-sniff-for-code-sniffer-3/">write a sniff for that</a> and forget it.</p>
<p>This will remove any database layer reference from all our <code>delegators</code>:</p>
<pre><code class="language-php">class CacheProductsCommand extends Command
{
    /**
     * @var ProductRepository
     */
    private $productRepository;

    public function __construct(ProductRepository $productRepository)
    {
        $this-&gt;productRepository = $productRepository;
    }

    public function execute()
    {
        $allProducts = $productRepository-&gt;fetchAll();

        // cache them all
    }
}</code></pre>
<p>Do you need to switch database layer? Easy!</p>
<pre><code class="language-diff"> class ProductRepository
 {
-     public function __construct(EntityManager $entityManager)
-     {
-         $this-&gt;repository = $entityManager-&gt;getRepository(Product::class);
-     }
+     public function __construct(Eloquent $eloquent)
+     {
+         $this-&gt;repository = $eloquent-&gt;getRepository(Product::class);
+     }

      public function fetchAll()
      {
          return $this-&gt;repository-&gt;fetchAll();
      }
 }</code></pre>
<p><strong>1 day of work instead of hundreds of hours.</strong> That's what delegator pattern is all about.</p>
<h2 id="Start-with-Best-on-the-Knowledge-Market">Start with Best on the Knowledge Market</h2>
<p>When you start with the best known approach possible, you'll end-up in well grown project that you'll love to contribute more the older it gets.</p>
<p><strong>Just like with children - invest in them right from the start and it will get back to you</strong>!</p>
<p><br></p>
<p>Happy Children and Project Raising!</p>

            <br>


            <div class="card mt-5 border-warning">
                <div class="card-body text-center mt-2">
                    <p>
                        Have you find this post useful? <strong>Do you want more?</strong>
                    </p>
                    <p>
                        Follow me on <a href="https://twitter.com/votrubaT">Twitter</a>, <a href="/rss.xml">RSS</a> or support me on <a href="https://github.com/sponsors/TomasVotruba">GitHub Sponsors</a>.
                    </p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body text-white bg-success text-center">
                                            <a href="/blog/2018/01/01/new-in-symplify-3-4-time-saving-coding-standard-checkers" class="d-block">
                            <div>
                                Read next → <strong>New in Symplify 3: 4 Time-saving Coding Standard Checkers</strong>
                            </div>
                        </a>
                                    </div>
            </div>

            <br>
            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />
        <script src="/assets/prism/prism.js"></script>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

        <script type="text/javascript">
            // @see https://stackoverflow.com/a/30776817/1348344
            var date = new Date();
            // display every 2nd hour, not to spam users
            if (date.getHours() % 2 === 1) {
                document.querySelector('.book-banner').style.display = 'visible';
            } else {
                document.querySelector('.book-banner').style.display = 'none';
            }
        </script>
    </body>
</html>
