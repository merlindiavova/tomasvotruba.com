<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Collector Pattern for Dummies | Tomas Votruba</title>
<meta charset="utf-8">
<meta name="robots" content="index, follow">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:creator" content="@votrubaT"/>

<meta property="og:image" content="/assets/images/tomas_votruba.jpg"/>

<link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">


<link rel="stylesheet" rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:700&amp;display=swap" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" media="print" onload="this.media='all'">

<link href="/assets/css/style.css?1555689388" rel="stylesheet" type="text/css" />

                <meta property="og:title" content="Collector Pattern for Dummies" />
        <meta property="og:url" content="https://tomasvotruba.com/blog/2018/06/14/collector-pattern-for-dummies" />
        <meta name="description" property="og:description" content="I wrote *[Why is Collector Pattern so Awesome](/blog/2018/03/08/why-is-collector-pattern-so-awesome/)* a while ago, but I got feeling and feedback that it&#039;s way too complicated.

The pattern itself is simple, but put in framework context, it might be too confusing to understand.

That&#039;s why we look on collector pattern in minimalistic plain PHP way today.
" />

            </head>

    <body>
        <!-- post_id: 114 -->
        <div id="menu">
    <div class="container-fluid">
        <a href="/">Home</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/blog">Blog</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/book/the-power-of-automated-refactoring">Book</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/trainings">Trainings</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/contact">Contact</a>
        <span class="pl-2 pr-2">•</span>

        <a href="https://twitter.com/votrubaT" target="blank">Twitter</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/rss.xml" target="blank">RSS</a>
    </div>
</div>

        <div class="container-fluid post" id="content">
            <div class="text-center book-banner">
                <a href="https://leanpub.com/rector-the-power-of-automated-refactoring" target="blank" class="text-center">
                    <img src="/assets/images/banner-rector-book.png" class="mb-2 ml-auto mr-auto rounded " style="max-height: 5em" alt="">
                </a>
            </div>

            <h1>Collector Pattern for Dummies</h1>

            <div class="pull-right">
                <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/main/packages/blog/data/2018/2018-06-14-collector-pattern-for-dummies.md">Found a typo? Edit me</a>
            </div>

            <time datetime="2018-06-Thu" class="text-muted">
                2018-06-14
            </time>

            
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>I wrote <em><a href="/blog/2018/03/08/why-is-collector-pattern-so-awesome/">Why is Collector Pattern so Awesome</a></em> a while ago, but I got feeling and feedback that it's way too complicated.
<br><br>
The pattern itself is simple, but put in framework context, it might be too confusing to understand.
<br><br>
That's why we look on collector pattern in minimalistic plain PHP way today.</p>
                </div>
            </div>

            <p>Let's say you have a simple <code>PriceCalculator</code> class that calculates a price for a product with a VAT:</p>
<pre><code class="language-php">class PriceCalculator
{
    public function calculate(Product $product): float
    {
        // compute vat
        $price = $product-&gt;getPrice() * 1.15;

        return $price;
    }
}</code></pre>
<p>Then we decide to have 50 % discount for admins:</p>
<pre><code class="language-diff"> class PriceCalculator
 {
     public function calculate(Product $product): float
     {
         // compute vat
         $price = $product-&gt;getPrice() * 1.15;

+        // discount for admin
+        if ($this-&gt;currentUser-&gt;getRole() === 'admin') {
+            $price *= 0.5;
+        }
+
         return $price;
     }
 }</code></pre>
<p>And another 20 % discount for students:</p>
<pre><code class="language-diff"> class PriceCalculator
 {
     public function calculate(Product $product): float
     {
         // compute vat
         $price = $product-&gt;getPrice() * 1.15;

         // discount for admin
         if ($this-&gt;currentUser-&gt;getRole() === 'admin') {
             $price *= 0.5;
         }

+        // discount for students
+        if ($this-&gt;currentUser-&gt;getOccupation() === 'student') {
+            $price *= 0.8;
+        }
+
         return $price;
     }
 }</code></pre>
<p>Our <code>PriceCalculator</code> grows and grows, our e-commerce platform expands all over Europe and we found out they have a different strategy to calculate price with VAT. How do we solve it?</p>
<p>&quot;Override the whole class and implements <code>calculate()</code> method for yourself.&quot;</p>
<pre><code class="language-php"> class UnitedKingdomPriceCalculator extends PriceCalculator
 {
     public function calculate(Product $product): float
     {
         // compute vat
         $price = $product-&gt;getPrice() * 1.15;

         return $price;
     }
 }</code></pre>
<p>That's an easy solution for the end-user. But it also means zero reusable code that leads to duplicated work. Imagine there will be 20 websites in the UK and <strong>each of them will have their own code to calculate price with VAT</strong>. 100 % similar code (if written correctly), because it applies to the whole country.</p>
<h2 id="Sharing-is-Caring">Sharing is Caring</h2>
<p>Instead, such UK solution can be one of many, that is openly shared.</p>
<ul>
<li>Do you need a UK price calculator? Plug it in.</li>
<li>Do you need a configurable discount based on role? Plug it in.</li>
<li>Do you need to decrease all price by 100 € if possible? Plug it in.</li>
</ul>
<p>No need to write it more than once for all of the e-commerce sites.</p>
<h2 id="How-Does-That-Look-in-the-Code">How Does That Look in the Code?</h2>
<h3 id="1-Turn-Your-Main-Class-to-A-Collector">1. Turn Your Main Class to A Collector</h3>
<pre><code class="language-php">class PriceCalculatorCollector
{
    /**
     * @var PriceCalculatorInterface[]
     */
    private $priceCalculators = [];

    /**
     * @param PriceCalculatorInterface[] $priceCalculators
     */
    public function __construct(array $priceCalculators)
    {
        $this-&gt;priceCalculators = $priceCalculators;
    }

    public function calculate(Product $product): float
    {
        $price = $product-&gt;getPrice();

        foreach ($this-&gt;priceCalculators as $priceCalculator) {
            $price = $priceCalculator-&gt;calculate($price);
        }

        return $price;
    }
}</code></pre>
<p>with interface decoupling:</p>
<pre><code class="language-php">interface PriceCalculatorInterface
{
    public function calculate(float $price): float;
}</code></pre>
<h3 id="2-Converts-Each-Case-to-Collected">2. Converts Each Case to Collected</h3>
<pre><code class="language-php">final class CzechVatPriceCalculator implements PriceCalculatorInterface
{
    public function calculate(float $price): float
    {
        return $price * 1.21;
    }
}</code></pre>
<pre><code class="language-php">final class AdminDiscountPriceCalculator implements PriceCalculatorInterface
{
    public function calculate(float $price): float
    {
        if (! $this-&gt;currentUser-&gt;getRole() === 'admin') {
            return $price;
        }

        return $price *= 0.5;
    }
}</code></pre>
<pre><code class="language-php">final class UnitedKingdomPriceCalculator implements PriceCalculatorInterface
{
   public function calculate(float $price): float
   {
       return $price * 1.15;
   }
}</code></pre>
<h3 id="3-Let-Collector-Collect-What-You-Need">3. Let Collector Collect What You Need</h3>
<p>Based on your needs, collect this or that service.</p>
<pre><code class="language-php">$priceCalculatorCollector = new PriceCalculatorCollector([
    new AdminDiscountPriceCalculator(),
    new UnitedKingdomPriceCalculator(),
]);

$price = $priceCalculatorCollector-&gt;calculatePrice($product);</code></pre>
<p>✅ single entry point for <code>Collector</code></p>
<p>✅ each solution that implements <code>PriceCalculatorInterface</code> <strong>is reusable</strong></p>
<p>✅ <strong>to extend</strong> <code>PriceCalculatorCollector</code> with another feature, e.g. have a discount for Lenovo laptops from now till the end of June 2018, <strong>we don't have to modify</strong> it - just register a new <code>PriceCalculator</code></p>
<p>✅ <strong>to reflect 1 change in reality</strong>, e.g. from 15 % to 20 % VAT, all we need to do it <strong>change 1 class for everyone</strong></p>
<p><br></p>
<p><strong>Win for the end-user, win for your project and win for the code.</strong></p>
<p><br></p>
<p><em>And that's all there is.</em> Just kidding, there is much more, but that's out of the scope of this simple tutorial.
Why the collector class doesn't implement the interface and other questions will be answered in following posts.</p>
<p><br><br></p>
<p>Happy collecting!</p>

            <br>


            <div class="card mt-5 border-warning">
                <div class="card-body text-center mt-2">
                    <p>
                        Have you find this post useful? <strong>Do you want more?</strong>
                    </p>
                    <p>
                        Follow me on <a href="https://twitter.com/votrubaT">Twitter</a>, <a href="/rss.xml">RSS</a> or support me on <a href="https://github.com/sponsors/TomasVotruba">GitHub Sponsors</a>.
                    </p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body text-white bg-success text-center">
                                            <a href="/blog/2018/06/11/how-to-turn-mocks-from-nightmare-to-solid-kiss-tests" class="d-block">
                            <div>
                                Read next → <strong>How to Turn Mocks from Nightmare to Solid Kiss Tests</strong>
                            </div>
                        </a>
                                    </div>
            </div>

            <br>
            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />
        <script src="/assets/prism/prism.js"></script>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

        <script type="text/javascript">
            // @see https://stackoverflow.com/a/30776817/1348344
            var date = new Date();
            // display every 2nd hour, not to spam users
            if (date.getHours() % 2 === 1) {
                document.querySelector('.book-banner').style.display = 'visible';
            } else {
                document.querySelector('.book-banner').style.display = 'none';
            }
        </script>
    </body>
</html>
