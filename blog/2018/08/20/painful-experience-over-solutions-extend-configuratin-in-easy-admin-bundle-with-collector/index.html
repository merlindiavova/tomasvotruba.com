<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Painful Experience over Solutions: Extend Configuration in Easy Admin Bundle | Tomas Votruba</title>
<meta charset="utf-8">
<meta name="robots" content="index, follow">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:creator" content="@votrubaT"/>

    <meta property="og:title" content="Painful Experience over Solutions: Extend Configuration in Easy Admin Bundle" />
    <meta property="og:url" content="https://tomasvotruba.com/blog/2018/08/20/painful-experience-over-solutions-extend-configuratin-in-easy-admin-bundle-with-collector" />

            <meta property="og:image" content="https://tomasvotruba.com/assets/images/posts/2018/collector-easy-admin-bundle/random.png?cache=123" />
        <meta name="twitter:image" content="https://tomasvotruba.com/assets/images/posts/2018/collector-easy-admin-bundle/random.png?cache=123"/>
    
<link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">


<link rel="stylesheet" rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:700&amp;display=swap" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" media="print" onload="this.media='all'">

<link href="/assets/css/style.css?753395371" rel="stylesheet" type="text/css" />

                <meta name="description" property="og:description" content="*Use SOLID to write Clean Code...* Are you tired of theoretical post about how to do achieve some therm? So am I.

Instead, let&#039;s **dive into real problems I came across while coding and let the code speak the theory between lines**.

Today we try to add own config option to YAML of Easy Admin Bundle (without pull-request to the package).
" />
    </head>

    <body>
        <!-- post_id: 133 -->
        <div id="menu">
    <div class="container-fluid">
        <a href="/">Home</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/blog">Blog</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/book/the-power-of-automated-refactoring">Book</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/trainings">Trainings</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/contact">Contact</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/about-me">About Me</a>
        <span class="pl-2 pr-2">•</span>

        <a href="https://twitter.com/votrubaT" target="blank">Twitter</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/rss.xml" target="blank">RSS</a>
    </div>
</div>

        <div class="container-fluid post" id="content">
            <div class="text-center book-banner">
                <a href="https://leanpub.com/rector-the-power-of-automated-refactoring" target="blank" class="text-center">
                    <img src="/assets/images/banner-rector-book.png" class="mb-2 ml-auto mr-auto rounded " style="max-height: 5em" alt="">
                </a>
            </div>

            <h1>Painful Experience over Solutions: Extend Configuration in Easy Admin Bundle</h1>

            <div class="pull-right">
                <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/main/packages/blog/data/2018/2018-08-20-painful-experience-over-solutions-extend-configuratin-in-easy-admin-bundle-with-collector.md">Found a typo? Edit me</a>
            </div>

            <time datetime="2018-08-Mon" class="text-muted">
                2018-08-20
            </time>

            
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p><em>Use SOLID to write Clean Code...</em> Are you tired of theoretical post about how to do achieve some therm? So am I.
<br>
Instead, let's <strong>dive into real problems I came across while coding and let the code speak the theory between lines</strong>.
<br><br>
Today we try to add own config option to YAML of Easy Admin Bundle (without pull-request to the package).</p>
                </div>
            </div>

            <blockquote class="blockquote text-center">
    Hindsight is 20/20.
</blockquote>
<p>Instead of writing about solution how to do and how awesome I am to know the solution right from the start of this page, I start right from the beginning, where I know nothing about it just like you.</p>
<p><br></p>
<h3 id="The-Application">The Application</h3>
<p>I'm coding an open-sourced training platform build Symfony 4.2 and Doctrine 2.7 for <a href="https://github.com/pehapkari">Pehapkari community training</a>. It's fully open-sourced on Github under the typical open-source name - <a href="https://github.com/tomasvotruba/open-training">Open Training</a>.</p>
<p>Admin is just a CRUD to maintain few entities, so I use <a href="https://github.com/easyCorp/EasyAdminBundle">EasyAdminBundle</a> to handle forms, grids, update, create, delete actions in controllers for me. Huge thanks to <a href="https://github.com/javiereguiluz">Javier Eguiluz</a> for this amazingly simple and powerful idea.</p>
<img src="https://symfony.com/doc/current/bundles/EasyAdminBundle/_images/easyadmin-default-backend.png">
<h3 id="The-Need">The Need</h3>
<p>There is <code>Training</code> entity with <code>name</code> and relation to <code>TrainingTerm</code> entity:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace App\Entity;

use Doctrine\Common\Collections\ArrayCollection;
use Doctrine\ORM\Mapping as ORM;

/**
 * @ORM\Entity
 */
class Training
{
    /**
     * @ORM\Id()
     * @ORM\GeneratedValue()
     * @ORM\Column(type="integer")
     * @var int
     */
    private $id;

    /**
     * @ORM\Column(type="string", length=255)
     * @var string
     */
    private $name;

    // ...

    /**
     * @ORM\OneToMany(targetEntity="App\Entity\TrainingTerm", mappedBy="training")
     * @var TrainingTerm[]|ArrayCollection
     */
    private $trainingTerms = [];
}</code></pre>
<p>I want to edit this entity in administration, so I add it to <code>config/packages/easy_admin.yaml</code>:</p>
<pre><code class="language-yaml">easy_admin:
    entities:
        Training:
            class: 'App\Entity\Training'</code></pre>
<p>This creates a grid and form with all the entity properties - <code>name</code> and <code>trainingTerms</code>. So, when I click <em>Add</em> in the admin I can change them both. <strong>But I want to change the <code>name</code> only and handle <code>TrainingTerm</code> entity in a standalone form.</strong></p>
<h3 id="Google-First">Google First</h3>
<p>Now what? I Google <em>easy admin custom field form</em> and after while I find <a href="https://symfony.com/doc/2.x/bundles/EasyAdminBundle/book/edit-new-configuration.html#customize-the-properties-displayed"><em>Customize the Properties Displayed</em></a> tutorial. It looks like exactly what I need.</p>
<pre><code class="language-diff"> easy_admin:
     entities:
         Training:
             class: 'App\Entity\Training'
+            fields: ['name']</code></pre>
<p>It works! The <code>trainingTerms</code> property is hidden in the form.</p>
<p><br></p>
<h3 id="But">But...</h3>
<p>After 2 hours I need to add <code>price</code>.</p>
<pre><code class="language-diff"> &lt;?php declare(strict_types=1);

 namespace App\Entity;

 use Doctrine\Common\Collections\ArrayCollection;
 use Doctrine\ORM\Mapping as ORM;

 /**
  * @ORM\Entity
  */
 class Training
 {
     // ...

+    /**
+     * @ORM\Column(type="integer")
+     * @var int
+     */
+    private $price;</code></pre>
<p>Price is there, great! Now we can earn some money. I <em>edit</em> training in admin... but, where is the price?</p>
<p>Because I'm coding many other features I don't realize, there is <em>memory-vendor-lock</em> - <strong>a code smell, when after doing the A, you always have to remember the B</strong>. Do you see it? When I add a property, I always have a to add it to <code>fields</code> in config.</p>
<pre><code class="language-diff"> easy_admin:
     entities:
         Training:
             class: 'App\Entity\Training'
-            fields: ['name']
+            fields: ['name', 'price']</code></pre>
<p>If this is the only case, that would be ok-ish. But now there are 10 entities with 50 properties. How the hell will I remember to do this on every new property I add?</p>
<pre><code class="language-diff"># ...
-            fields: ['name', 'price']
+            fields: ['name', 'price', 'capacity']</code></pre>
<p>And how can will anyone else find this out without me doing the code-review and remembering?</p>
<pre><code class="language-diff"># ...
-            fields: ['name', 'price', 'capacity']
+            fields: ['name', 'price', 'capacity', 'duration']</code></pre>
<p>So much <em>memory-leaks</em> it hurts my neurons.</p>
<h3 id="Creative-Time">Creative Time</h3>
<p>Life is not perfect and every code is legacy by the time you end the line with <code>;</code>.</p>
<blockquote class="blockquote text-center">
    There are no solutions. Just trade-offs.
</blockquote>
<p>I stop and think a bit. How can I write less code to prevent possible bugs and make changes as effective as possible?
<strong>I see there are fewer properties to exclude than properties to include</strong>, by 1:10. It would not be perfect code, but still 10 times safer and more effective code. Worth it!</p>
<pre><code class="language-diff"> easy_admin:
     entities:
         Training:
             class: 'App\Entity\Training'
-            fields: ['name', 'price', 'capacity', 'duration', 'perex', 'description', 'place', 'trainer']
+            exclude_fields: ['trainingTerms']</code></pre>
<h3 id="Make-that-Happen-and-Face-False-Expectations">Make that Happen and Face False Expectations</h3>
<p>But is that <code>exclude_fields</code> or <code>excluded_fields</code> or maybe <code>skip_fields</code>? I want to see the documentation, so I Google <a href="https://www.google.cz/search?q=easy+admin+bundle+exclude+fields&amp;oq=easy+admin+bundle+exclude+fields&amp;aqs=chrome..69i57.4891j0j7&amp;sourceid=chrome&amp;ie=UTF-8"><em>easy admin bundle excludes fields</em></a>. I find <a href="https://github.com/EasyCorp/EasyAdminBundle/issues/589"><em>Exclude fields in list fields</em> issue in EasyAdminBundle</a>. I read it and see the content <strong>is not what I need</strong>. It looks like this option is not supported. I'm sad. What now?</p>
<p><br></p>
<p>Open-source packages are closed to extension more than you'd expect. To add one custom feature, you have to basically copy and extend the whole class or use reflection. It's not <strong>because it's difficult to create an extendable code, it's because nobody <em>believes</em> it can be done in a nice way</strong>. It <em>can</em>, just keep reading.</p>
<p><br></p>
<p>Being that suspicious I start my <em>inner over-engineer</em> voice:</p>
<ul>
<li>&quot;Create own extension that will hack into the <code>EasyAdminExtension</code> and get the config and add <code>exclude_fields</code> option&quot;</li>
<li>&quot;Create own <code>BetterEasyAdminBundle</code> that will be run before the <code>EasyAdminBundle</code> and will pass parameters there&quot;</li>
</ul>
<p><strong>This might end-up wasting many hours</strong> on custom and useless solution (like &quot;create own Doctrine&quot; idea, true story). Instead I try to invest a bit more time and I continue the brainstorming:</p>
<ul>
<li>&quot;Send pull-request with this feature to the core code&quot;</li>
</ul>
<p>Slightly better, but what if Javier doesn't like it? Or what if he's on holiday for 3 weeks? I know, it's summer and very rare to happen, but I have to finish the app in 2 weeks and I don't want to think about bugs like these in the meantime. The <strong>least I can do is to create <a href="https://github.com/EasyCorp/EasyAdminBundle/issues/2325">an issue</a></strong> with this idea and my reasons for it.</p>
<h2 id="Wander-in-the-Code">Wander in the Code</h2>
<p>I need a solution and I need it today. What can I do? No hacking, no pull-request, just looking for something in files:</p>
<img src="/assets/images/posts/2018/collector-easy-admin-bundle/random.png" class="img-thumbnail">
<p>Do you think this is just a random screen-shot not worth your attention?</p>
<ul>
<li>there is a checkbox in <em>Match case</em> because <code>'fields'</code> is lowercased and we want to focus on that only (no properties or methods with <code>Fields</code>)</li>
<li>there is a limit to <code>*.php</code> because that <em>would be probably</em> place to extend</li>
<li>there is a limit to <em>Directory</em>: <code>/../vendor/easycorp</code>, because we want to hack into this package</li>
<li>there is <code>fields</code> word in search; later I improve it to <code>'fields'</code> to narrow results, because we know it's a string</li>
</ul>
<p><br></p>
<p><strong>I still have no idea about the solution I'll pick. I'm only randomly looking for the light, blindfolded in a dark foggy forest.</strong>
This is called <em>creative chaos</em> in coaching circles and it's the most important part of the client's work.</p>
<p><br></p>
<p>I scroll down a bit looking at both code and the file name. Suddenly, the fog starts slowly disappearing...</p>
<img src="/assets/images/posts/2018/collector-easy-admin-bundle/pass.png" class="img-thumbnail">
<p>I notice <code>*ConfigPass</code> suffix. Is that like <code>CompilerPassInterface</code>, a collector-pattern used in Symfony to modify services in the container?</p>
<p>Being curious I open <code>NormalizerConfigPass.php</code> file:</p>
<pre><code class="language-php">&lt;?php

// ...

namespace EasyCorp\Bundle\EasyAdminBundle\Configuration;

use Symfony\Component\DependencyInjection\ContainerInterface;

class NormalizerConfigPass implements ConfigPassInterface
{
    // ...
}</code></pre>
<p>An interface! That's a good sign.</p>
<h3 id="Keep-Wandering">Keep Wandering</h3>
<p>So I look for <code>ConfigPassInterface</code> in somewhere else than just <code>implements ConfigPassInterface</code>.</p>
<p>That doesn't work, so I try to look for <code>ConfigPass</code>.</p>
<p>That doesn't work, so I try to look for any file, not just <code>*.php</code>. That show as valuable, since services are defined in YAML or XML.</p>
<img src="/assets/images/posts/2018/collector-easy-admin-bundle/services.png" class="img-thumbnail">
<p>I see a tag: <code>easyadmin.config_pass</code>. Let's look for that string:</p>
<img src="/assets/images/posts/2018/collector-easy-admin-bundle/bingo.png" class="img-thumbnail">
<p>Warmer! <strong>I've just found a collector pattern.</strong> To config, I look for service under <code>easyadmin.config.manager</code> name - <a href="https://github.com/EasyCorp/EasyAdminBundle/blob/07194017918aebe382e1ab0e53c68f6242547a0e/src/Configuration/ConfigManager.php#L112-L119"><code>ConfigManager</code></a> and look for <code>foreach</code> on collected services:</p>
<pre><code class="language-php">private function doProcessConfig($backendConfig): array
    {
    foreach ($this-&gt;configPasses as $configPass) {
        $backendConfig = $configPass-&gt;process($backendConfig);
    }

    return $backendConfig;
}</code></pre>
<p>Bingo! <strong>That means, when I register a service with <code>easyadmin.config_pass</code> tag, I'll be able to read and modify the YAML configuration</strong>.</p>
<p>So I register a service:</p>
<pre><code class="language-yaml">services:
    ExcludeFieldsConfigPass:
        tags:
             -
                 name: "easyadmin.config_pass"
                 priority: 120 # it took me more time to figure out if -100 or 0 or 100 or 1000 means "the first"</code></pre>
<p>That does 1 thing:</p>
<p><code>fields</code> (value to be set) = entity properties − <code>exclude_fields</code> (value I set in the config)</p>
<p><br></p>
<p>It allows me to do simplify <code>config/packages/easy_admin.yaml</code> config:</p>
<pre><code class="language-diff"> easy_admin:
     entities:
         Training:
             class: 'App\Entity\Training'
-            fields: ['name', 'price', 'capacity', 'duration', 'perex', 'description', 'place', 'trainer']
+            exclude_fields: ['trainingTerms']</code></pre>
<p>You can see full code of <a href="https://github.com/TomasVotruba/open-training/pull/7/files#diff-318660bf4cd1ad8a5d0e608e94df8fae"><code>ExcludeFieldsConfigPass</code> on Github</a>.</p>
<p>Very smart move Javier - thank you!</p>
<h2 id="Learn-1-Algorithm-instead-of-10-Solutions">Learn 1 Algorithm instead of 10 Solutions</h2>
<p>And that's all folks. I hope I've shown you how to approach problems and how to find a way in situations you're the first time in.
The same way I don't memorize Wikipedia and just Google it instead, <strong>I don't remember solutions to 100 PHP problems, but have a couple of algorithms to approach problem solving</strong>.</p>
<ul>
<li>Try A - Failed?</li>
<li>Try B - Failed?</li>
<li>Try C - Failed?</li>
<li>Take a break to prevent <a href="https://en.wikipedia.org/wiki/Learned_helplessness">learned helplessness</a> :)</li>
<li>Try D - Failed?</li>
<li>Try E - Failed?</li>
<li>Try F - Kaboom! It works!</li>
</ul>
<p><br>
If artificial intelligence could figure this all out for us, we'd be screwed :).</p>
<p>Btw, are you coming to <a href="https://www.hlai-conf.org">Human Level AI Conference</a> in Prague this weekend? I'll be there and I'd be happy if you stop me and say Hi!</p>
<p><br></p>
<p>Happy solving!</p>

            <br>


            <div class="card mt-5 border-warning">
                <div class="card-body text-center mt-2">
                    <p>
                        Have you find this post useful? <strong>Do you want more?</strong>
                    </p>
                    <p>
                        Follow me on <a href="https://twitter.com/votrubaT">Twitter</a>, <a href="/rss.xml">RSS</a> or support me on <a href="https://github.com/sponsors/TomasVotruba">GitHub Sponsors</a>.
                    </p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body text-white bg-success text-center">
                                            <a href="/blog/2018/08/16/whats-new-in-php-73-in-30-seconds-in-diffs" class="d-block">
                            <div>
                                Read next → <strong>What&#039;s New in PHP 7.3 in 30 Seconds in Diffs</strong>
                            </div>
                        </a>
                                    </div>
            </div>

            <br>
            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />
        <script src="/assets/prism/prism.js"></script>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

        <script type="text/javascript">
            // @see https://stackoverflow.com/a/30776817/1348344
            var date = new Date();
            // display every 2nd hour, not to spam users
            if (date.getHours() % 2 === 1) {
                document.querySelector('.book-banner').style.display = 'visible';
            } else {
                document.querySelector('.book-banner').style.display = 'none';
            }
        </script>
    </body>
</html>
