<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Why and How to Avoid the Memory Lock | Tomas Votruba</title>
<meta charset="utf-8">
<meta name="robots" content="index, follow">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:creator" content="@votrubaT"/>

<meta property="og:image" content="/assets/images/tomas_votruba.jpg"/>

<link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">


<link rel="stylesheet" rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:700&amp;display=swap" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" media="print" onload="this.media='all'">

<link href="/assets/css/style.css?1153174720" rel="stylesheet" type="text/css" />

                <meta property="og:title" content="Why and How to Avoid the Memory Lock" />
        <meta property="og:url" content="https://tomasvotruba.com/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock" />
        <meta name="description" property="og:description" content="When you close the door of my home, they&#039;re closed and you need a key to get in. But what if your door has door handle? You have to also lock them.

Instead of just closing the door you have to close the door and *that one more thing*. Why is that a bad thing in the code and how to avoid it?
" />

            </head>

    <body>
        <!-- post_id: 135 -->
        <div id="menu">
    <div class="container-fluid">
        <a href="/">Home</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/blog">Blog</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/book/the-power-of-automated-refactoring">Book</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/trainings">Trainings</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/contact">Contact</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/about-me">About Me</a>
        <span class="pl-2 pr-2">•</span>

        <a href="https://twitter.com/votrubaT" target="blank">Twitter</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/rss.xml" target="blank">RSS</a>
    </div>
</div>

        <div class="container-fluid post" id="content">
            <div class="text-center book-banner">
                <a href="https://leanpub.com/rector-the-power-of-automated-refactoring" target="blank" class="text-center">
                    <img src="/assets/images/banner-rector-book.png" class="mb-2 ml-auto mr-auto rounded " style="max-height: 5em" alt="">
                </a>
            </div>

            <h1>Why and How to Avoid the Memory Lock</h1>

            <div class="pull-right">
                <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/main/packages/blog/data/2018/2018-08-27-why-and-how-to-avoid-the-memory-lock.md">Found a typo? Edit me</a>
            </div>

            <time datetime="2018-08-Mon" class="text-muted">
                2018-08-27
            </time>

            
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>When you close the door of my home, they're closed and you need a key to get in. But what if your door has door handle? You have to also lock them.
<br><br>
Instead of just closing the door you have to close the door and <em>that one more thing</em>. Why is that a bad thing in the code and how to avoid it?</p>
                </div>
            </div>

            <p>I started <a href="https://github.com/javiereguiluz/easybook/pull/185">refactoring <em>easybook</em> package</a> last week and I found a few interesting snippets there.</p>
<p>Let's start with a simple question: which of following 7 code snippets <strong>opens space for potential bug</strong> that will take your new colleague 2-3 hours to solve?</p>
<p><br></p>
<p>1.</p>
<pre><code class="language-php">&lt;?php

// ...

foreach ($this-&gt;publishingItems as $item) {
   $item['content'] = $this-&gt;decorateContent($item['content']);
}</code></pre>
<p><br></p>
<p>2.</p>
<pre><code class="language-php">&lt;?php

use Symfony\Component\EventDispatcher\EventSubscriberInterface;

final class SomeEventSubscriber implements EventSubscriberInterface
{
    /**
     * @return string[]
     */
    public static function getSubscribedEvents(): array
    {
         return ['processEvent'];
    }

    public function processEvent(ItemAwareEvent $itemAwareEvent)
    {
        $item = $itemAwareEvent-&gt;getItem();
        $item['content'] = 'new content';
    }
}</code></pre>
<p><br></p>
<p>3.</p>
<pre><code class="language-php">&lt;?php

// ...

$this-&gt;bookGenerator-&gt;setBookDirectory($bookDirectory);
$this-&gt;bookGenerator-&gt;generate();</code></pre>
<p><br></p>
<p>4.</p>
<pre><code class="language-php">&lt;?php

// ...

protected function setUp(): void
{
    $this-&gt;epub2Publisher = $this-&gt;container-&gt;get(Epub2Publisher::class);
}</code></pre>
<p><br></p>
<p>5.</p>
<pre><code class="language-php">&lt;?php

class SomeController
{
    public function someAction()
    {
        // ...

        $product = ...;

        $this-&gt;entityManager-&gt;persist($product);
        $this-&gt;entityManager-&gt;flush();
    }
}</code></pre>
<p><em>Don't mind the presence of Doctrine in Controller here. That's a code smell we don't look for right now.</em></p>
<p><br></p>
<p>6.</p>
<pre><code class="language-php">&lt;?php

use Symfony\Component\Console\Command\Command;

class SomeCommand extends Command
{
    /**
     * @var SomeDependency
     */
    private $someDependency;

    public function __construct(SomeDependency $someDependency)
    {
        $this-&gt;someDependency = $someDependency;
    }

    // ...
}</code></pre>
<p><br></p>
<p>7.</p>
<pre><code class="language-php">&lt;?php
use PhpParser\NodeTraverser;

class SomeNodeTraverser extends NodeTraverser
{
    /**
     * @var SomeDependency
     */
    private $someDependency;

    public function __construct(SomeDependency $someDependency)
    {
        $this-&gt;someDependency = $someDependency;
    }

    public function process()
    {
        foreach ($this-&gt;visitors as $visitor) {
            // ...
        }
    }
}</code></pre>
<p>Do you have your favorite number? Good, try to remember it.</p>
<p>The memory-lock <strong>is very difficult to spot</strong>. We owe that to <em>author blindness</em> and <em>thinking heuristics</em> (brain short-cuts), that limits our ability to work effectively in the chaos or under pressure. If you've read <a href="https://www.amazon.com/Thinking-Fast-Slow-Daniel-Kahneman-ebook/dp/B005MJFA2W/ref=sr_1_1?ie=UTF8&amp;qid=1535407760&amp;sr=8-1&amp;keywords=Thinking%2C+Fast+and+Slow">Thinking, Fast and Slow</a> (must have for anyone curious about his or her brain false positives) or any other book about social psychology, you know where I'm heading.</p>
<h2 id="When-Expectations-are-Met">When Expectations are Met</h2>
<p>Why it's difficult to spot? <strong>It depends on other code and it might code work if our expectations are met</strong>. What does it mean?</p>
<p>Let's take code snippet 7. Will this work or not? Under what condition?</p>
<pre><code class="language-php">&lt;?php

foreach ($this-&gt;visitors as $visitor) {
    // ...
}</code></pre>
<p><a href="https://github.com/nikic/PHP-Parser/pull/528">This pull-request</a> reveals the answer.</p>
<p>Now back to your coding:</p>
<ul>
<li>Do you want to create a code that works under certain assumption?</li>
<li>Do you want to remember to do the B after each A?</li>
<li>Do you want to <strong>keep over 50 of such A-B pairs in your head</strong> every time you open your main project?</li>
</ul>
<p>I don't. I want to be effective and create a valuable bullet-proof code that can be used only one way. A code that doesn't put the burden on the developer to investigate my code first. A code that is safe to use and cannot be broken (if possible).</p>
<p><br></p>
<p>So which of those 7 code snippets above are dangerous?</p>
<p><br></p>
<p><em>Drum rolls...</em></p>
<p><br></p>
<p><strong>Yes, all of them!</strong> I knew you'd reveal my poor confusion.</p>
<h3 id="Don-t-make-the-Programmer-Think">Don't make the Programmer Think</h3>
<p>I'm taking the title from my favorite <a href="http://sensible.com/dmmt.html">intro UX book</a> because it really punches the line. <strong>There are 3 groups of memory-locks that could be done better</strong> in the code snippets above.</p>
<h2 id="1-Change-Array-Return">1. Change Array Return</h2>
<div class="card">
    <div class="card-body">
        The memory lock: <em>after I change array value, I have to put it back into an original set of an array or return it</em>.
    </div>
</div>
<p>Snippets 1 and 2.</p>
<p>This code would change the <code>$item['content</code>] value, but <code>$this-&gt;publishingItems</code> remains unchanged:</p>
<pre><code class="language-php">&lt;?php

// ...

foreach ($this-&gt;publishingItems as $item) {
    $item['content'] = $this-&gt;decorateContent($item['content']);
}</code></pre>
<h3 id="How-to-Solve-it">How to Solve it?</h3>
<pre><code class="language-diff"> &lt;?php

 // ...

-foreach ($this-&gt;publishingItems as $item) {
+foreach ($this-&gt;publishingItems as $key =&gt; $item) {
     $item['content'] = $this-&gt;decorateContent($item['content']);
+    $this-&gt;publishingItems[$key] = $item;
 }</code></pre>
<p><strong>Use object instead</strong>:</p>
<pre><code class="language-diff"> &lt;?php

 // ...

 foreach ($this-&gt;publishingItems as $item) {
-     $item['content'] = $this-&gt;decorateContent($item['content']);
+     $item-&gt;changeContent($this-&gt;decorateContent($item['content']));
 }</code></pre>
<p>Objects <a href="https://gist.github.com/nikic/5015323">consume less memory</a> anyway and <strong>you are safe</strong> - more importantly, <strong>anyone extending this code ever after is safer</strong>.</p>
<h2 id="2-Double-Method-Call">2. Double-Method Call</h2>
<div class="card">
    <div class="card-body">
       The memory lock: <em>After I call this method I have to call that method to make it really work</em>.
    </div>
</div>
<p>Snippets 3 and 5.</p>
<p>You also have to think about the C - the order:</p>
<pre><code class="language-php">$this-&gt;bookGenerator-&gt;setBookDirectory($bookDirectory);
$this-&gt;bookGenerator-&gt;generate();</code></pre>
<p>vs.</p>
<pre><code class="language-php">$this-&gt;bookGenerator-&gt;generate();
$this-&gt;bookGenerator-&gt;setBookDirectory($bookDirectory);</code></pre>
<p>vs.</p>
<pre><code class="language-php">$this-&gt;bookGenerator-&gt;generate();</code></pre>
<h3 id="How-to-Solve-it">How to Solve it?</h3>
<p>Use one method that handles it both:</p>
<pre><code class="language-diff"> &lt;?php

 // ...

-$this-&gt;bookGenerator-&gt;setBookDirectory($bookDirectory);
-$this-&gt;bookGenerator-&gt;generate();
+$this-&gt;bookGenerator-&gt;generateFromDirectory($bookDirectory);</code></pre>
<p>Same applied to code snippet 5:</p>
<pre><code class="language-diff"> &lt;?php

 // ...

-$this-&gt;entityManager-&gt;persist($product);
-$this-&gt;entityManager-&gt;flush();
+$this-&gt;productRepository-&gt;save($product);</code></pre>
<p>I dare you to generate the book or save the product the wrong way now!</p>
<h2 id="3-Parent-Logic">3. Parent Logic</h2>
<p>Snippets 4, 6 and 7.</p>
<div class="card">
    <div class="card-body">
       The memory lock: <em>After I call anything in parent method, I have check if I need to call the constructor to prepare some logic</em>.
    </div>
</div>
<p>This would actually fail:</p>
<pre><code class="language-php">&lt;?php

foreach ($this-&gt;visitors as $visitor) {
    // ...
}</code></pre>
<p>Why? Because in <code>parent::__construct()</code> is set default value for property with null:</p>
<pre><code class="language-php">&lt;?php

// ...

public function __construct()
{
    $this-&gt;visitors = [];
}</code></pre>
<h3 id="How-to-Solve-it">How to Solve it?</h3>
<p>In this case just add default value to property itself:</p>
<pre><code class="language-diff">-private $visitors;
+private $visitors = [];</code></pre>
<p>There is even coding <a href="https://github.com/symplify/coding-standard#array-property-should-have-default-value-to-prevent-undefined-array-issues">standard fixer for that</a>.</p>
<p>Also, <strong>do not add any logic to constructor</strong> apart dependency injection. Constructor injection is the main reason to use the constructor in 99 %, so most people probably don't expect any extra logic there. Create extra method instead or decouple a class, put it into the constructor and call the method on it.</p>
<p><strong>Try to avoid these patterns in code, in door design or in architecture of the application as a whole.</strong> One day some programmer will silently thank you when he or she will find what <em>memory lock</em> is (the painful way).</p>
<p><br></p>
<p>Do you know any other <em>memory locks</em> we should watch out for? Share them in the comment!</p>
<p><br></p>
<blockquote class="twitter-tweet" data-lang="cs"><p lang="en" dir="ltr">"90% of the bugs I produced were for one of the two reasons:<br>1. Doing multiple things at one place<br>2. Doing one thing at multiple places" - <a href="https://twitter.com/pseudo_coder?ref_src=twsrc%5Etfw">@pseudo_coder</a></p>— Programming Wisdom (@CodeWisdom) <a href="https://twitter.com/CodeWisdom/status/998180793385209856?ref_src=twsrc%5Etfw">20. května 2018</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p><br></p>
<p>Happy brain cells liberation!</p>

            <br>


            <div class="card mt-5 border-warning">
                <div class="card-body text-center mt-2">
                    <p>
                        Have you find this post useful? <strong>Do you want more?</strong>
                    </p>
                    <p>
                        Follow me on <a href="https://twitter.com/votrubaT">Twitter</a>, <a href="/rss.xml">RSS</a> or support me on <a href="https://github.com/sponsors/TomasVotruba">GitHub Sponsors</a>.
                    </p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body text-white bg-success text-center">
                                            <a href="/blog/2018/08/23/9-features-of-symfony-plugin-you-should-not-miss-in-gifs" class="d-block">
                            <div>
                                Read next → <strong>9 Features of PHPStorm Symfony Plugin You Should Not Miss in Gifs</strong>
                            </div>
                        </a>
                                    </div>
            </div>

            <br>
            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />
        <script src="/assets/prism/prism.js"></script>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

        <script type="text/javascript">
            // @see https://stackoverflow.com/a/30776817/1348344
            var date = new Date();
            // display every 2nd hour, not to spam users
            if (date.getHours() % 2 === 1) {
                document.querySelector('.book-banner').style.display = 'visible';
            } else {
                document.querySelector('.book-banner').style.display = 'none';
            }
        </script>
    </body>
</html>
