<!DOCTYPE html>
<html lang="en">
    <head>
        <title>How to Make Github and Travis Split Monorepo to Multiple Git Repositories for You | Tomas Votruba</title>
<meta charset="utf-8">
<meta name="robots" content="index, follow">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:creator" content="@votrubaT"/>

    <meta property="og:title" content="How to Make Github and Travis Split Monorepo to Multiple Git Repositories for You" />
    <meta property="og:url" content="https://tomasvotruba.com/blog/2018/07/19/how-to-make-github-and-travis-split-monorepo-to-multiple-git-repositories-for-you" />

            <meta property="og:image" content="https://tomasvotruba.com/assets/images/posts/2018/monorepo-split/found-keys.jpg" />
        <meta name="twitter:image" content="https://tomasvotruba.com/assets/images/posts/2018/monorepo-split/found-keys.jpg"/>
    
<link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">


<link rel="stylesheet" rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:700&amp;display=swap" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" media="print" onload="this.media='all'">

<link href="/assets/css/style.css?1552914148" rel="stylesheet" type="text/css" />

                <meta name="description" property="og:description" content="Do you use a monorepo? Then you know [How to maintain multiple Git repositories with ease](https://blog.shopsys.com/how-to-maintain-multiple-git-repositories-with-ease-61a5e17152e0). If you&#039;re not there yet, you may wonder [How to Merge 15 Repositories to 1 Monorepo and Keep their Git History](https://blog.shopsys.com/how-to-merge-15-repositories-to-1-monorepo-keep-their-git-history-and-add-project-base-as-well-6e124f3a0ab3).

Are you and your monorepo ready? Today we&#039;ll focus on **fast, secured and outsourced monorepo auto split** - all that under 10 minutes.
" />
    </head>

    <body>
        <!-- post_id: 124 -->
        <div id="menu">
    <div class="container-fluid">
        <a href="/">Home</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/blog">Blog</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/book/the-power-of-automated-refactoring">Book</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/trainings">Trainings</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/contact">Contact</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/about-me">About Me</a>
        <span class="pl-2 pr-2">•</span>

        <a href="https://twitter.com/votrubaT" target="blank">Twitter</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/rss.xml" target="blank">RSS</a>
    </div>
</div>

        <div class="container-fluid post" id="content">
            <div class="text-center book-banner">
                <a href="https://leanpub.com/rector-the-power-of-automated-refactoring" target="blank" class="text-center">
                    <img src="/assets/images/banner-rector-book.png" class="mb-2 ml-auto mr-auto rounded " style="max-height: 5em" alt="">
                </a>
            </div>

            <h1>How to Make Github and Travis Split Monorepo to Multiple Git Repositories for You</h1>

            <div class="pull-right">
                <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/main/packages/blog/data/2018/2018-07-19-how-to-make-github-and-travis-split-monorepo-to-multiple-git-repositories-for-you.md">Found a typo? Edit me</a>
            </div>

            <time datetime="2018-07-Thu" class="text-muted">
                2018-07-19
            </time>

                            <div class="card border-danger mt-4">
                    <div class="card-header text-white bg-danger">
                        This post is deprecated since December 2020. Its knowledge is old and should not be used.
                        <br>
                        <strong>Why?</strong>
                    </div>
                    <div class="card-body pb-2">
                        <p>Travis and Monorepo Split is dead now. Use faster <a href="/blog/2020/11/09/new-in-symplify-9-monorepo-split-with-github-action/">GitHub Action</a> instead.</p>
                    </div>
                </div>

                <br>
            
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>Do you use a monorepo? Then you know <a href="https://blog.shopsys.com/how-to-maintain-multiple-git-repositories-with-ease-61a5e17152e0">How to maintain multiple Git repositories with ease</a>. If you're not there yet, you may wonder <a href="https://blog.shopsys.com/how-to-merge-15-repositories-to-1-monorepo-keep-their-git-history-and-add-project-base-as-well-6e124f3a0ab3">How to Merge 15 Repositories to 1 Monorepo and Keep their Git History</a>.
<br><br>
Are you and your monorepo ready? Today we'll focus on <strong>fast, secured and outsourced monorepo auto split</strong> - all that under 10 minutes.</p>
                </div>
            </div>

            <p>It's great to be alive in this era. We have solved maintaining multiple repositories, even merge migration of their git history to one repository. Creating huge code bases was more never cost effective and never had a steeper learning curve.</p>
<p>The same way it was never easier to drive an autonomous car. You just sit in the car, press the button of your destination, and Tesla will drive you there when you check all the news on <a href="https://www.reddit.com/r/PHP">/r/PHP</a>.</p>
<p>Well, the monorepo paradigm is not there yet but it's getting there.</p>
<h2 id="The-Split-Problem">The Split Problem</h2>
<p>One of the last problems I'm aware of is splitting the monorepo to particular packages. Imagine you have <a href="https://github.com/symfony/symfony">Symfony monorepo</a> and you're trying to split it to all standalone packages like <a href="https://github.com/symfony/console">symfony/console</a>, <a href="https://github.com/symfony/dependency-injection">symfony/dependency-injection</a> and so on.</p>
<h3 id="Current-Status">Current Status</h3>
<p>This whole &quot;take a code from this directory and put it into this repository in <code>master</code> branch and last tag&quot; process is now:</p>
<ul>
<li>complex</li>
<li>slow</li>
<li>requires a lot of setups</li>
</ul>
<p>Instead, we want it to be:</p>
<ul>
<li><strong>simple so you will understand it at the end of reading this post</strong></li>
<li><strong>fast like Travis build of your project</strong></li>
<li><strong>easy to set up in 1 composer package and 5 lines of YAML</strong></li>
</ul>
<p>Why? So you could amaze your friends at the party that you just set-up a monorepo split and they can enjoy merged PRs in a matter of minutes (even if you know almost nothing about git or PHP).</p>
<p>Do you think we can get there? You'll see.</p>
<h2 id="The-Best-Solutions-to-Split-So-Far">The Best Solutions to Split (So Far)</h2>
<p>Feel free to explore these following solutions. I did it for you and here are a few blockers that hold them from being massively adopted.</p>
<p>On the other hand, <strong>I'm grateful for each one of them, because they're pushing the evolution further and further. Thanks to them we don't have to reinvent the wheel and we can build on their shoulders</strong>.</p>
<h3 id="1-splitsh-lite">1. splitsh/lite</h3>
<ul>
<li><a href="https://github.com/splitsh/lite">https://github.com/splitsh/lite</a></li>
<li>You need to know Go and bash and be able to resolve conflicts of their dependencies.</li>
</ul>
<h3 id="2-dflydev-git-subsplit">2. dflydev/git-subsplit</h3>
<ul>
<li><a href="https://github.com/dflydev/git-subsplit">https://github.com/dflydev/git-subsplit</a></li>
<li>Extra splits that are not needed</li>
<li>Complex configuration</li>
<li>Requires manual bash install</li>
<li>It was used by Laravel and then by Symplify</li>
</ul>
<h2 id="What-Would-the-Ideal-State-Look-Like">What Would the Ideal State Look Like?</h2>
<p>Before diving into solution and how to do it, I try to stop and go into a wonderland. What would the ideal solution look like? How would I use it? How would I explain it to others? How fast would it be? Try to break away from your know-how limits (because they're limiting your thinking) and be free to come up with absolutely non-sense answers:</p>
<ul>
<li>&quot;1 command to install&quot;</li>
<li>&quot;zero setup&quot;</li>
<li>&quot;1 command to run&quot;</li>
<li>&quot;1 minute to finish the whole process&quot;</li>
<li>&quot;split only what I and people really need&quot;</li>
</ul>
<p><br></p>
<p>If we put it in the code, it might look like:</p>
<pre><code class="language-bash">composer require symplify/monorepo-builder --dev</code></pre>
<pre><code class="language-yaml"># monorepo-builder.yml
parameters:
    directories_to_repositories:
        packages/MonorepoBuilder: 'git@github.com:Symplify/MonorepoBuilder.git'</code></pre>
<pre><code class="language-bash">vendor/bin/monorepo-builder split</code></pre>
<p>That could do, right? At least from a <a href="https://symfony.com/blog/making-the-symfony-experience-exceptional">developer's experience</a> view.</p>
<p><br></p>
<p>But what would <a href="https://www.michalspacek.com">security expert Michal Špaček</a> say to lousy code like that?</p>
<img src="/assets/images/posts/2018/monorepo-split/found-keys.jpg" class="img-thumbnail">
<h2 id="How-To-Avoid-Rape-on-Github-and-Travis">How To Avoid Rape on Github and Travis?</h2>
<blockquote class="blockquote text-center">
    "So, anyone can now push to your repository whatever he wants?"
</blockquote>
<p>This is a valid question that was probably scratching your mind when you saw <em>Github + Travis + git + open-source</em> combination.
Travis is basically a terminal, that runs few command lines. What would prevent someone from using this to &quot;play with&quot; your repository?</p>
<p>Let's look at the repository address in our example:</p>
<pre><code class="language-bash">git@github.com:Symplify/MonorepoBuilder.git</code></pre>
<p>This basically means <strong>we need to make ssh key or username and a password public</strong>. Does that sound like a good idea to you?</p>
<p>Don't worry, Github and Travis thought about these cases - with a hashed <code>GITHUB_TOKEN</code> environment variable.</p>
<h3 id="1-Create-a-Personal-Access-Token-on-Github">1. Create a Personal Access Token on Github</h3>
<p>First, you need to create a custom token, that will authorize access to your Github repositories from any command line where it will be used.</p>
<p>Read <a href="https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line">the Github docs</a> or use <strong>tl;dr;</strong>:</p>
<ul>
<li>Go to your <a href="https://github.com/settings/tokens">Github Tokens</a></li>
<li>Click <em>Generate new token</em></li>
<li>Check only <em>repo</em> scope
<img src="/assets/images/posts/2018/monorepo-split/github-token.png" class="img-thumbnail"></li>
<li>Click <em>Generate token</em></li>
</ul>
<h3 id="2-Add-GITHUB-TOKEN-in-Repository-Settings-on-Travis">2. Add <code>GITHUB_TOKEN</code> in Repository Settings on Travis</h3>
<p>Then we need to store this token to Travis build, so Travis can be authorized to manipulate with your repositories without any password or ssh key.</p>
<p>Read <a href="https://docs.travis-ci.com/user/environment-variables/#Defining-Variables-in-Repository-Settings-">the Travis docs</a> or use <strong>tl;dr;</strong>:</p>
<ul>
<li>Go to Travis settings of your repository - <code>https://travis-ci.org/&lt;your&gt;/&lt;repository&gt;/settings</code></li>
<li>Jump to <em>Environment Variables</em> section</li>
<li>Create <code>GITHUB_TOKEN</code> with the value from Github</li>
<li>Click <em>Add</em></li>
</ul>
<p>In the end, it should look like this:</p>
<div class="text-center">
    <img src="/assets/images/posts/2018/monorepo-split/token-after.png" class="img-thumbnail">
</div>
<h3 id="GitHub-and-Travis-Protects-You">GitHub and Travis Protects You</h3>
<p>Now the best part. If you accidentally commit your access token in <code>.travis.yml</code> (like I did while testing), <strong>GitHub will immediately disable it</strong> and sends you an email (to bad I found that out the next day after 4 hours of debugging with that token).</p>
<p>And if you add the token to your repository on Travis as above, <strong>it will hide it in all logs for you</strong>. No need to hash it.</p>
<p>So instead of insecure</p>
<pre><code class="language-bash">git@github.com:Symplify/MonorepoBuilder.git
# or
https://aFjk02FJlkj1675jlk@github.com/Symplify/MonorepoBulder.git</code></pre>
<p>everyone will see:</p>
<pre><code class="language-bash">https://[secure]@github.com/Symplify/MonorepoBulder.git</code></pre>
<p>Sound and safe!</p>
<p><br></p>
<p><strong>Now we have:</strong></p>
<ul>
<li>the <code>symplify/monorepo-builder</code> package as a local dependency</li>
<li>configured package to repository paths in <code>monorepo-builder.yml</code></li>
<li>secured <code>GITHUB_TOKEN</code> in Travis settings for your monorepo repository</li>
<li>a command to run the split: <code>vendor/bin/monorepo-builder split</code></li>
</ul>
<p>Something is missing...</p>
<p>Oh right, <strong>when</strong> will the monorepo be split? Do we have to do it manually? How often? Should Travis CRON do it on daily basis?</p>
<h2 id="When-is-the-Best-Time-to-Split-our-Monorepo">When is the Best Time to Split our Monorepo?</h2>
<p>In times like these, get back to our ideal product:</p>
<ul>
<li>&quot;1 command to install&quot;</li>
<li>&quot;zero setup&quot;</li>
<li>&quot;1 command to run&quot;</li>
<li><strong>&quot;1 minute to finish the whole process&quot;</strong></li>
<li>&quot;split only what maintainer and users really need&quot;</li>
</ul>
<p>It often happens <strong>we merge fix or feature to monorepo and we want to try it</strong> before rushing to tagging a stable release. We want to do it <strong>as soon as possible</strong>, <strong>without manually triggering Travis</strong> to do it. Also, we <strong>don't want Travis to waste energy on pull-requests</strong> that are not merged to master. That would only slow the whole CI process down and frustrate contributors and maintainer.</p>
<p>Saying that how <code>.travis.yml</code> should look like?</p>
<pre><code class="language-yaml">language: php

# required for "git tag" presence for MonorepoBuilder split and ChangelogLinker git tags resolver
# see https://github.com/travis-ci/travis-ci/issues/7422
git:
  depth: false

matrix:
  include:
    - php: 7.2
      env: MONOREPO_SPLIT=true
    # ... other builds

install:
  - composer install

# ... other scripts

after_script:
  # split monorepo to packages - only on merge to master
  - |
    if [[ $TRAVIS_EVENT_TYPE == "push" &amp;&amp; $MONOREPO_SPLIT == true &amp;&amp; $TRAVIS_BRANCH == "master" ]]; then
      vendor/bin/monorepo-builder split -v
    fi</code></pre>
<p>That way the split command is run only merge to <code>master</code> and <strong>exactly once after each merge</strong>. So you can test your feature in a matter of minutes...</p>
<p>Wait wait, no vague statements like <em>a matter of minutes</em>. How <strong>fast it really is</strong>? To give you an idea, this is Symplify Travis build with a split of 10 packages:</p>
<img src="/assets/images/posts/2018/monorepo-split/speed.png" class="img-thumbnail mb-4">
<p><strong>It takes under 7,5 minutes</strong> including all the tests, static analysis and code style validation.</p>
<p>That's all folks. You're ready to go and try it on your monorepo.</p>
<p><br></p>
<p>So, do you think you're ready to fascinate your friends tonight with all your brand new monorepo split setup?</p>

            <br>


            <div class="card mt-5 border-warning">
                <div class="card-body text-center mt-2">
                    <p>
                        Have you find this post useful? <strong>Do you want more?</strong>
                    </p>
                    <p>
                        Follow me on <a href="https://twitter.com/votrubaT">Twitter</a>, <a href="/rss.xml">RSS</a> or support me on <a href="https://github.com/sponsors/TomasVotruba">GitHub Sponsors</a>.
                    </p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body text-white bg-success text-center">
                                            <a href="/blog/2018/07/16/new-in-statie-45-twig-support" class="d-block">
                            <div>
                                Read next → <strong>New in Statie 4.5: Twig Support</strong>
                            </div>
                        </a>
                                    </div>
            </div>

            <br>
            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />
        <script src="/assets/prism/prism.js"></script>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

        <script type="text/javascript">
            // @see https://stackoverflow.com/a/30776817/1348344
            var date = new Date();
            // display every 2nd hour, not to spam users
            if (date.getHours() % 2 === 1) {
                document.querySelector('.book-banner').style.display = 'visible';
            } else {
                document.querySelector('.book-banner').style.display = 'none';
            }
        </script>
    </body>
</html>
