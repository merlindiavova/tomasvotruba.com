<!DOCTYPE html>
<html lang="en">
    <head>
        <title>How to Test Monorepo in 3 Layers | Tomas Votruba</title>
<meta charset="utf-8">
<meta name="robots" content="index, follow">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:creator" content="@votrubaT"/>

<meta property="og:image" content="/assets/images/tomas_votruba.jpg"/>

<link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">


<link rel="stylesheet" rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:700&amp;display=swap" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" media="print" onload="this.media='all'">

<link href="/assets/css/style.css?584144211" rel="stylesheet" type="text/css" />

                <meta property="og:title" content="How to Test Monorepo in 3 Layers" />
        <meta property="og:url" content="https://tomasvotruba.com/blog/2018/11/22/how-to-test-monorepo-in-3-layers" />
        <meta name="description" property="og:description" content="Do you have a monorepo, with 2 packages at least, autoloaded with composer and splitting works?
Good! Now you&#039;re about to set up testing and code quality tools.

How to make testing so tight no bug can escape?
" />

            </head>

    <body>
                <!-- post_id: 161 -->
        <div id="menu">
    <div class="container-fluid">
        <a href="/">Home</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/blog">Blog</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/book/the-power-of-automated-refactoring">Book</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/trainings">Trainings</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/contact">Contact</a>
        <span class="pl-2 pr-2">•</span>

        <a href="https://twitter.com/votrubaT" target="blank">Twitter</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/rss.xml" target="blank">RSS</a>
    </div>
</div>

        <div class="container-fluid post" id="content">
            <h1>How to Test Monorepo in 3 Layers</h1>

            <div class="pull-right">
                <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/main/packages/blog/data/2018/2018-11-22-how-to-test-monorepo-in-3-layers.md">Found a typo? Edit me</a>
            </div>

            <time datetime="2018-11-Thu" class="text-muted">
                2018-11-22
            </time>

            
                            <div class="card border-success mt-4">
                    <div class="card-header text-white bg-success">
                        This post was updated at February 2021 with fresh know-how.
                        <br>
                        <strong>What is new?</strong>
                    </div>
                                            <div class="card-body pb-2">
                            <p>Changed from Travis to GitHub Actions, from post-split testing to local split testing.</p>
                        </div>
                                    </div>

                <br>
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>Do you have a monorepo, with 2 packages at least, autoloaded with composer and splitting works?
Good! Now you're about to set up testing and code quality tools.
<br><br>
How to make testing so tight no bug can escape?</p>
                </div>
            </div>

            <p>There are 3 layers you test your monorepo in. Most projects have 2 of them max.:</p>
<ul>
<li><strong>Testing Monorepo</strong> (Symfony, Sylius)</li>
<li><strong>Testing Standalone Packages in Monorepo</strong> (Symfony, Sylius)</li>
<li><strong>After Split Testing</strong></li>
</ul>
<p>I'm not sure why the last one is often skipped. Surprisingly, it's very easy to setup - a matter of single a new workflow file in <code>.github/workflows</code>.</p>
<p>Now we know the 3 testing layers. It's time to look <strong>why each particular layer is important</strong>.</p>
<h2 id="1-testing-monorepo">1. Testing Monorepo</h2>
<pre><code class="language-bash">/.github/workflows/...
/packages
    /first-package
    /second-package
phpunit.xml</code></pre>
<h3 id="why-is-it-important">Why is it Important?</h3>
<p>Monorepo is more complex than the classic package. The developers who use it needs to study more nested directories, special rules and exceptions he didn't have to before. He's already exhausted by learning all this and he's barely some energy left to contribute.</p>
<p>That's why <strong>your monorepo workflow has to be as simple as possible</strong>.</p>
<p>Testing should be as easy as:</p>
<pre><code class="language-bash">vendor/bin/phpunit</code></pre>
<p>One run and I we can see test are passing or failing. Must have.</p>
<h2 id="2-testing-standalone-packages-in-monorepo">2. Testing Standalone Packages in Monorepo</h2>
<pre><code class="language-diff"> /.github/workflows/...
 /packages
     /first-package
+        phpunit.xml
     /second-package
+        phpunit.xml
 phpunit.xml</code></pre>
<p>In this layer, each package has own PHPUnit setup. It still uses root <code>vendor/autoload.php</code>, but the testing scope is more similar to standalone package testing. If's <em>faking</em> split testing for poor people.</p>
<pre><code class="language-bash">vendor/bin/phpunit packages/first-package
vendor/bin/phpunit packages/second-package</code></pre>
<h3 id="why-is-it-important">Why is it Important?</h3>
<p>PHPUnit <strong>has own autoloading so it autoloads tests</strong> without relying on your <code>composer.json</code>. It's for historical reasons and also the fact, it's not standard to autoload test files or even user PSR-4 naming in them.</p>
<p><br></p>
<p>So when we run e.g. <code>vendor/bin/phpunit packages</code>, we basically tell the PHPUnit <em>autoload <code>packages</code> directory</em>.</p>
<p>What happens, when:</p>
<ul>
<li><code>packages/first-package/tests/Fixture/SomeClass.php</code> is used in test in</li>
<li><code>packages/second-package/tests/UnrelatedTest.php</code>?</li>
</ul>
<p>❌</p>
<p><strong>It will silently pass</strong>. Monorepo has many classes you work with and some test classes can be accidentally reused in another package. Your test run says it passes, even though it's broken.</p>
<p>You'll find out eventually when <code>second-package</code> is downloaded and break the code to somebody but isn't automated testing suppose to prevent that?</p>
<h2 id="3-split-testing">3. Split Testing</h2>
<h3 id="why-is-it-important">Why is it Important?</h3>
<p>This is like a double condom with birth control - the best quality testing we can get. It's <strong>almost identical with real use when programmer downloads</strong> a package by <code>packages/second-package</code>.</p>
<p>Our goal is to autoload:</p>
<ul>
<li>the second-package code in <code>packages/second-package/src</code></li>
<li>dependencies from <code>packages/second-package/composer.json</code> <strong>ONLY</strong></li>
</ul>
<p><br></p>
<p>You've figured out by now <em>the why</em> by seeing <strong>ONLY</strong>. You can't find this bug in layer 1 or 2.</p>
<p>Our first package uses Doctrine <code>packages/first-package/composer.json</code></p>
<pre><code class="language-json">{
    "name": "our-project/first-package",
    "require": {
        "php": "^7.2",
        "doctrine/orm": "^2.7"
    }
}</code></pre>
<p>At the same time, <code>second-package</code> is using the Doctrine class:</p>
<pre><code class="language-php">namespace OurProject\SecondPackage;

use Doctrine\ORM\EntityManagerInterface;

final class ProductController
{
    public function __construct(EntityManagerInterface $entityManager)
    {
    }
}</code></pre>
<p>But does <strong>not require Doctrine</strong> it in <code>composer.json</code>:</p>
<pre><code class="language-json">{
    "name": "our-project/second-package",
    "require": {
        "php": "^7.2"
    }
}</code></pre>
<p>How does the GitHub Action <strong>workflow look like exactly</strong>? Checkout <a href="/blog/2020/02/10/how-to-test-monorepo-after-split-before-actual-split/">How to Test Monorepo After Split Before Actual Split</a>.</p>
<p>That's why after split testing is so important. GitHub Action will tell us!</p>
<p><br></p>
<p>Happy coding!</p>

            <br>


            <div class="card mt-5">
                <div class="card-body text-center mt-2">
                    <p>
                        Have you find this post useful? <strong>Do you want more?</strong>
                    </p>
                    <p>
                        Follow me on <a href="https://twitter.com/votrubaT">Twitter</a>, <a href="/rss.xml">RSS</a> or support me on <a href="https://github.com/sponsors/TomasVotruba">GitHub Sponsors</a>.
                    </p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body text-white bg-success text-center">
                                                                <a href="/blog/2018/11/19/when-you-should-use-monorepo-and-when-local-packages" class="d-block">
                            <div>
                                Read next → <strong>When You Should Use Monorepo and When Local Packages</strong>
                            </div>
                        </a>
                                    </div>
            </div>

            <br>
            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>


        <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />
        <script src="/assets/prism/prism.js"></script>
    </body>
</html>
