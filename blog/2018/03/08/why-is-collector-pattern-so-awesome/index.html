<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Why is Collector Pattern so Awesome | Tomas Votruba</title>
<meta charset="utf-8">
<meta name="robots" content="index, follow">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:creator" content="@votrubaT"/>

    <meta property="og:title" content="Why is Collector Pattern so Awesome" />
    <meta property="og:url" content="https://tomasvotruba.com/blog/2018/03/08/why-is-collector-pattern-so-awesome" />

            <meta property="og:image" content="https://tomasvotruba.com/assets/images/posts/2018/collector/quote.jpg" />
        <meta name="twitter:image" content="https://tomasvotruba.com/assets/images/posts/2018/collector/quote.jpg"/>
    
<link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">


<link rel="stylesheet" rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:700&amp;display=swap" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" media="print" onload="this.media='all'">

<link href="/assets/css/style.css?1778827864" rel="stylesheet" type="text/css" />

                <meta name="description" property="og:description" content="How to achieve *open for extension* and *closed for modification* [one of sOlid principals](https://github.com/jupeter/clean-code-php#openclosed-principle-ocp)?

Why Collector pattern beats config tagging? How to use the in Symfony application? How it turns locked architecture into scaling one?
" />
    </head>

    <body>
        <!-- post_id: 80 -->
        <div id="menu">
    <div class="container-fluid">
        <a href="/">Home</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/blog">Blog</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/book/the-power-of-automated-refactoring">Book</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/trainings">Trainings</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/contact">Contact</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/about-me">About Me</a>
        <span class="pl-2 pr-2">•</span>

        <a href="https://twitter.com/votrubaT" target="blank">Twitter</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/rss.xml" target="blank">RSS</a>
    </div>
</div>

        <div class="container-fluid post" id="content">
            <div class="text-center book-banner">
                <a href="https://leanpub.com/rector-the-power-of-automated-refactoring" target="blank" class="text-center">
                    <img src="/assets/images/banner-rector-book.png" class="mb-2 ml-auto mr-auto rounded " style="max-height: 5em" alt="">
                </a>
            </div>

            <h1>Why is Collector Pattern so Awesome</h1>

            <div class="pull-right">
                <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/main/packages/blog/data/2018/2018-03-08-why-is-collector-pattern-so-awesome.md">Found a typo? Edit me</a>
            </div>

            <time datetime="2018-03-Thu" class="text-muted">
                2018-03-08
            </time>

                            <div class="card border-danger mt-4">
                    <div class="card-header text-white bg-danger">
                        This post is deprecated since August 2020. Its knowledge is old and should not be used.
                        <br>
                        <strong>Why?</strong>
                    </div>
                    <div class="card-body pb-2">
                        <p>The feature is not in Rector any more, yet the collector is still valid to SOLID code extending.</p>
                    </div>
                </div>

                <br>
            
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>How to achieve <em>open for extension</em> and <em>closed for modification</em> <a href="https://github.com/jupeter/clean-code-php#openclosed-principle-ocp">one of sOlid principals</a>?
<br><br>
Why Collector pattern beats config tagging? How to use the in Symfony application? How it turns locked architecture into scaling one?</p>
                </div>
            </div>

            <p>I already <a href="/blog/2017/04/14/3-symfony-and-laravel-patterns-that-make-code-easy-to-extends-without-modification/#3-like-collecting-stamps-just-on-steroids">wrote about Collector pattern as one we can learn from Symfony or Laravel</a>. But they're so useful and underused I have need to write a more about them.</p>
<p>Yesterday I worked on <a href="https://github.com/rectorphp/rector">Rector</a> and <strong>needed an entry point to add one or more Rectors by user</strong>.</p>
<p><br></p>
<p>To give you a context, now you can register particular Rectors to config as in Symfony:</p>
<pre><code class="language-php">use Rector\Privatization\Rector\MethodCall\PrivatizeLocalGetterToPropertyRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;rule(PrivatizeLocalGetterToPropertyRector::class);
};</code></pre>
<h2 id="Towards-Scalable-Architecture">Towards Scalable Architecture</h2>
<p>Well, we could accept PR and hard-code it into application, that would work too. But the point is to allow end-user to <strong>add as many customs services of specific type as he or she wants without need to modify our application</strong>.</p>
<h3 id="Open-to-Extension-Closed-to-Modification">Open to Extension, Closed to Modification</h3>
<p>This is how <em>open/closed principle</em> looks like. If you still don't have the idea, see very nice and descriptive examples in <a href="https://github.com/jupeter/clean-code-php#openclosed-principle-ocp">jupeter/clean-code-php</a>.</p>
<p>Let's start with ideas:</p>
<h2 id="1-Add-a-Provider-and-Collect-it-in-CompilerPass">1. Add a Provider and Collect it in CompilerPass?</h2>
<p>My first idea was a provider that would return such Rector:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace App\Rector;

use Rector\Contract\Rector\RectorInterface;

final class SymfonyRectorProvider implements RectorInterface
{
    public function provide()
    {
        $rector = new CustomSymfonyRector;
        // some custom modifications

        return $rector;
    }
}</code></pre>
<p><br></p>
<p>Such service is registered by user to the config:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();
    $services-&gt;defaults()
        -&gt;autowire();

    $services-&gt;set(\App\Rector\SymfonyRectorProvide::class);
};</code></pre>
<p><br></p>
<p>And collected by our application via <code>CompilerPass</code>:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace Rector\RectorBuilder\DependencyInjection\CompilerPass;

use Rector\Rector\RectorCollector;
use Rector\RectorBuilder\Contract\RectorProviderInterface;
use Symfony\Component\DependencyInjection\Compiler\CompilerPassInterface;
use Symfony\Component\DependencyInjection\ContainerBuilder;
use Symfony\Component\ExpressionLanguage\Expression;
use Symplify\PackageBuilder\DependencyInjection\DefinitionFinder;

final class RectorProvidersCompilerPass implements CompilerPassInterface
{
    public function process(ContainerBuilder $containerBuilder): void
    {
        $rectorCollectorDefinition = $containerBuilder-&gt;getDefinition(RectorCollector::class);

        $rectorProviderDefinitions = DefinitionFinder::findAllByType(
            $containerBuilder,
            RectorProviderInterface::class
        );

        foreach ($rectorProviderDefinitions as $rectorProviderDefinition) {
            $providedRector = new Expression(
                sprintf('service("%s").provide()', $rectorProviderDefinition-&gt;getClass())
            );
            $rectorCollectorDefinition-&gt;addMethodCall('addRector', [$providedRector]);
        }
    }
}</code></pre>
<p>Are you curious what <code>DefinitionFinder</code>? It's just <a href="https://github.com/symplify/symplify/blob/3d058becb57efefe2307c88ee94acbfbd15ebd1c/packages/PackageBuilder/src/DependencyInjection/DefinitionFinder.php">a helper class</a> around <code>ContainerBuilder</code>.</p>
<h2 id="2-Use-Expression-Language">2. Use Expression Language?</h2>
<p>Wait, what is this?</p>
<pre><code class="language-php">$providedRector = new Expression(
    sprintf('service("%s").provide()', $rectorProviderDefinition-&gt;getClass())
);</code></pre>
<p>That is part of <a href="https://symfony.com/doc/current/service_container/expression_language.html">Symfony Expression Language</a> that allows calling methods on services before container compilation.</p>
<p>Could you guess, how the final code in compiled container would look like?</p>
<p><br></p>
<p>Something like this:</p>
<pre><code class="language-php">$rectorCollector = new Rector\Rector\RectorCollector;
$rectorCollector-&gt;addRector((new App\Rector\SymfonyRectorProvider)-&gt;provide());</code></pre>
<p><br></p>
<p><strong>To be honest, it's magic and unclear code to me.</strong> It also needs <code>symfony\expression</code> package to be installed manually. I don't want to refer people to this paragraph just to understand 3 lines in <code>CompilerPass</code>. That code smells bad.</p>
<p>But what now?</p>
<h3 id="From-One-to-One-to-One-to-Many">From One-to-One to One-to-Many</h3>
<p>To simulate real life we should have at least 2 problems at once :)</p>
<p>The most common case is product in e-commerce. Product <em>JBL Charge 3</em> has 1 category - <em>speaker</em>. Ok, you write a code with Doctrine Entity that each product has one category. But as it happens in life, <em>change is the only constant</em>, website grows and search expands with new request from your boss: &quot;A product needs to have multiple categories&quot;. What now?</p>
<p>The same happened for Rector - <strong>I need to add multiple Rectors in <code>RectorProvider</code></strong>. What now?</p>
<p>Damn! Mmm, tell people to use one provider per Rector?</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();
    $services-&gt;defaults()
        -&gt;autowire();

    $services-&gt;set(\App\Rector\SymfonyRectorProvider::class);

    $services-&gt;set(\App\Rector\AnotherSymfonyRectorProvider::class);
};</code></pre>
<p>Quick solution, yet smelly:</p>
<ul>
<li>But how to share common code between similar RectorProvider?</li>
<li>Duplicate and decouple services?</li>
<li>And what is the point of provider, if it can only add 1 new Rector?</li>
<li>Why not register them in <code>services:</code> directly like the others?</li>
</ul>
<p>And flow of <em>WTFs</em> is coming at you.</p>
<h2 id="3-Does-Collector-Scale">3. Does Collector Scale?</h2>
<p>Let's try a different approach that Colletor pattern screams at us. We now have one-to-one <code>RectorColletor</code> implementation:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace Rector\Rector;

use Rector\Core\Contract\Rector\RectorInterface;

final class RectorCollector
{
    // ...

    public function addRector(RectorInterface $rector): void
    {
        $this-&gt;rectors[] = $rector;
    }
}</code></pre>
<h3 id="What-do-we-want">What do we want?</h3>
<ul>
<li>drop that expression language magic</li>
<li>support one-to-many case</li>
<li>have clear API with priority in PHP code rather in <code>CompilerPass</code> or config</li>
<li>have typehint control</li>
</ul>
<h3 id="Drop-that-Expression-Language-Magic">Drop that Expression Language Magic</h3>
<p>Thanks to Collector pattern we now <strong>have 1 place to solve these problems</strong> at:</p>
<pre><code class="language-diff"> &lt;?php declare(strict_types=1);

 namespace Rector\Rector;

 use Rector\Contract\Rector\RectorInterface;
 use Rector\RectorBuilder\Contract\RectorProviderInterface;

 final class RectorCollector
 {
     public function addRector(RectorInterface $rector): void
     {
         $this-&gt;rectors[] = $rector;
     }
+
+    public function addRectorProvider(RectorProviderInterface $rectorProvider): void
+    {
+         $this-&gt;addRector($rectorProvider-&gt;provide());
+    }
 }</code></pre>
<p><br></p>
<p>And thanks to that, <strong>we can cleanup</strong> <code>CompilerPass</code>:</p>
<pre><code class="language-diff">&lt;?php declare(strict_types=1);

namespace Rector\RectorBuilder\DependencyInjection\CompilerPass;

use Rector\Rector\RectorCollector;
use Rector\RectorBuilder\Contract\RectorProviderInterface;
use Symfony\Component\DependencyInjection\Compiler\CompilerPassInterface;
use Symfony\Component\DependencyInjection\ContainerBuilder;
use Symfony\Component\ExpressionLanguage\Expression;
use Symplify\PackageBuilder\DependencyInjection\DefinitionFinder;

final class RectorProvidersCompilerPass implements CompilerPassInterface
{
    public function process(ContainerBuilder $containerBuilder): void
    {
        $rectorCollectorDefinition = $containerBuilder-&gt;getDefinition(RectorCollector::class);

        $rectorProviderDefinitions = DefinitionFinder::findAllByType(
            $containerBuilder,
            RectorProviderInterface::class
        );

        foreach ($rectorProviderDefinitions as $rectorProviderDefinition) {
-           $providedRector = new Expression(
-               sprintf('service("%s").provide()', $rectorProviderDefinition-&gt;getClass())
-           );
-           $rectorCollectorDefinition-&gt;addMethodCall('addRector', [$providedRector]);
+           $rectorCollectorDefinition-&gt;addMethodCall('addRectorProvider', [
+               '@' . $rectorProviderDefinition-&gt;getClass()
+           ]);
        }
    }
}</code></pre>
<p><br></p>
<h3 id="How-do-we-Provide-Multiple-Items">How do we Provide Multiple Items?</h3>
<p>I didn't forget, our dear manager. Do you have idea how would you add it?</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace Rector\RectorBuilder\Contract;

use Rector\Core\Contract\Rector\RectorInterface;

interface RectorProviderInterface
{
   /**
    * @return RectorInterface[]
    */
   public function provide(): array
}</code></pre>
<p><br></p>
<p>And update <code>RectorCollector</code> class:</p>
<pre><code class="language-diff"> &lt;?php declare(strict_types=1);

 namespace Rector\Rector;

 use Rector\Contract\Rector\RectorInterface;
 use Rector\RectorBuilder\Contract\RectorProviderInterface;

 final class RectorCollector
 {
     public function addRector(RectorInterface $rector): void
     {
         $this-&gt;rectors[] = $rector;
     }

     public function addRectorProvider(RectorProviderInterface $rectorProvider): void
     {
-         $this-&gt;addRector($rectorProvider-&gt;provide());
+         foreach ($rectorProvider-&gt;provide() as $rector) {
+             $this-&gt;addRector($rector);
+         }
     }
 }</code></pre>
<p>Now we have:</p>
<p>✅ single entry point for <code>Collector</code> + <code>Provider</code></p>
<p>✅ typehinted <code>RectorInterface</code> control in code</p>
<p>✅ clean config for use and compiler for our code</p>
<p>✅ removed <code>symfony/expression-language</code> dependency</p>
<h2 id="4-Add-Tagging">4. Add Tagging?</h2>
<p>We forget tagging, right? The most <a href="/blog/2017/02/12/drop-all-service-tags-in-your-nette-and-symfony-applications/">spread useless code in Symfony configs</a>.</p>
<p><br></p>
<blockquote class="blockquote text-center">
    "Perfection is achieved, not when there is nothing more to add, but when there is nothing left to take away."
    <footer class="blockquote-footer">Antoine de Saint-Exupery</footer>
</blockquote>
<p><br></p>
<p>Why would you add it and where? I don't take arguments like &quot;well, it's historical reasons&quot; and <a href="https://symfony.com/blog/new-in-symfony-3-4-simpler-injection-of-tagged-services"><code>!tagged</code></a>, since it add more coupling.</p>
<p>Try to convince me though if you're sure about its advantages.</p>
<h3 id="How-was-our-Path-from-the-End">How was our Path from the End?</h3>
<p>✅ Add provider</p>
<p>❌ Use expression language?</p>
<p>✅ Does collector scale?</p>
<p>❌ Add tagging</p>
<h2 id="and-quot-Git-Story-and-quot-over-git-history">&quot;Git Story&quot; over git history</h2>
<p>I want to share with you one last idea. I could show you the final commit - or even worse - just the final versions of <code>RectorProviderInterface</code>, <code>RectorCollector</code> and <code>RectorProvidersCompilerPass</code>. But what could you take from such a code? <strong>Nothing, because only when we fail, we learn something new.</strong></p>
<p><strong>Same can be applied to git history. When I see 2 final files with 2 commits, I learn nothing new.</strong> And pose questions and comments on blind paths, that author already took (and explains me again in words to my comments).</p>
<p>Next time you squash 20 commits to 1, remember:</p>
<blockquote class="blockquote text-center">
    Git should tell the story, as the human history does.
</blockquote>
<p><br><br></p>
<p>Happy collecting!</p>

            <br>


            <div class="card mt-5 border-warning">
                <div class="card-body text-center mt-2">
                    <p>
                        Have you find this post useful? <strong>Do you want more?</strong>
                    </p>
                    <p>
                        Follow me on <a href="https://twitter.com/votrubaT">Twitter</a>, <a href="/rss.xml">RSS</a> or support me on <a href="https://github.com/sponsors/TomasVotruba">GitHub Sponsors</a>.
                    </p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body text-white bg-success text-center">
                                            <a href="/blog/2018/03/01/new-in-symplify-3-4-improvements-in-easy-coding-standard" class="d-block">
                            <div>
                                Read next → <strong>New in Symplify 3: 4 Improvements in EasyCodingStandard</strong>
                            </div>
                        </a>
                                    </div>
            </div>

            <br>
            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />
        <script src="/assets/prism/prism.js"></script>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

        <script type="text/javascript">
            // @see https://stackoverflow.com/a/30776817/1348344
            var date = new Date();
            // display every 2nd hour, not to spam users
            if (date.getHours() % 2 === 1) {
                document.querySelector('.book-banner').style.display = 'visible';
            } else {
                document.querySelector('.book-banner').style.display = 'none';
            }
        </script>
    </body>
</html>
