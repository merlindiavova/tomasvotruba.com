<!DOCTYPE html>
<html lang="en">
    <head>
        <title>How to Run Naked Unit Tests in a New Legacy Project | Tomas Votruba</title>
<meta charset="utf-8">
<meta name="robots" content="index, follow">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:creator" content="@votrubaT"/>

    <meta property="og:title" content="How to Run Naked Unit Tests in a New Legacy Project" />
    <meta property="og:url" content="https://tomasvotruba.com/blog/how-to-run-naked-unit-tests-in-a-new-legacy-project" />

            <meta property="og:image" content="/assets/images/tomas_votruba.jpg"/>
        <meta name="twitter:image" content="/assets/images/tomas_votruba.jpg"/>
    
<link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">


<link rel="stylesheet" rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:700&amp;display=swap" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" media="print" onload="this.media='all'">

<link href="/assets/css/style.css?161792182" rel="stylesheet" type="text/css" />

                <meta name="description" property="og:description" content="You know the situation. You come to a new project that you should upgrade and refactor. It has some tests that ~~you~~ long-term developer can run locally. But the automated CI that runs tests on every commit is missing.


Shall we start refactoring and adding CI tools like PHPStan or ECS? **How about using what is already there**? The tests.


But the tests require this PHP extension, those environment variables, this external service, and these few Docker images to be running.

What if we can **find the naked unit tests** and run them today by ourselves?
" />
    </head>

    <body>
        <!-- post_id: 346 -->
        <div id="menu">
    <div class="container-fluid">
        <a href="/">Home</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/blog">Blog</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/book/the-power-of-automated-refactoring">Book</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/trainings">Trainings</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/contact">Contact</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/about-me">About Me</a>
        <span class="pl-2 pr-2">•</span>

        <a href="https://twitter.com/votrubaT" target="blank">Twitter</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/rss.xml" target="blank">RSS</a>
    </div>
</div>

        <div class="container-fluid post" id="content">
            <div class="text-center book-banner">
                <a href="https://leanpub.com/rector-the-power-of-automated-refactoring" target="blank" class="text-center">
                    <img src="/assets/images/banner-rector-book.png" class="mb-2 ml-auto mr-auto rounded " style="max-height: 5em" alt="">
                </a>
            </div>

            <h1>How to Run Naked Unit&nbsp;Tests in a&nbsp;New&nbsp;Legacy&nbsp;Project</h1>

            <div class="pull-right">
                <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/main/packages/blog/data/2021/2021-11-08-how-to-run-naked-unit-tests-in-a-new-legacy-project.md">Found a typo? Edit me</a>
            </div>

            <time datetime="2021-11-Mon" class="text-muted">
                2021-11-08
            </time>

            
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>You know the situation. You come to a new project that you should upgrade and refactor. It has some tests that <del>you</del> long-term developer can run locally. But the automated CI that runs tests on every commit is missing.
<br>
<br>
Shall we start refactoring and adding CI tools like PHPStan or ECS? <strong>How about using what is already there</strong>? The tests.
<br>
<br>
But the tests require this PHP extension, those environment variables, this external service, and these few Docker images to be running.
<br><br>
What if we can <strong>find the naked unit tests</strong> and run them today by ourselves?</p>
                </div>
            </div>

            <div class="card border-warning mt-4">
    <div class="card-header text-black bg-warning shadow">
        <strong>Proof over theory?</strong>
        This technique allowed us to run 41 tests without any setup. That's 41 more than we usually have before investing a lot of learning time. Maybe it will help your legacy project too.
    </div>
</div>
<p><br></p>
<p>When we come to a project, the first thing to do is run tests. Just in case they work without any setup:</p>
<pre><code class="language-bash">vendor/bin/phpunit</code></pre>
<p><br></p>
<p>If we get a positive response and tests run successfully, we can thank the developers of this project and start upgrading and refactoring. But more likely, we get one of the following responses:</p>
<ul>
<li><em>function/extension is missing</em></li>
<li><em>ENV is missing</em></li>
<li><em>Redis is missing</em></li>
</ul>
<p>Then we can check for <code>.env</code>, <code>docker-compose.yml</code>, <code>phpunit.xml</code> extensions in <code>composer.json</code> or even <code>README.md</code> to figure out what extension we need to run the tests. But maybe, we don't have to.</p>
<h2 id="External-and-Local-test-Dependencies">External and Local test Dependencies</h2>
<p>Our tests depend on some manual steps we have to do. They do not work out of the box, but they might run after we complete this value here and run this CLI command.</p>
<p>The test dependency can be split into 2 categories:</p>
<ul>
<li>External: those which depend on <strong>on dynamic content</strong></li>
<li>Local: those that depend on the <strong>static source code</strong> itself</li>
</ul>
<p>The first group requires our manual input and research, so there is nothing we can do right now to run them except to learn more about the project.</p>
<p>However, we can run the second group right now:</p>
<pre><code class="language-php">use PHPUnit\Framework\TestCase;

use App\ValueObject\Tool;

final class SomeTest extends TestCase
{
    public function test()
    {
        $tool = new Tool('Rector');
        $this-&gt;assertSame('Rector', $tool-&gt;getName());
    }
}</code></pre>
<p>...and we can see if a test fails or passes. How?</p>
<pre><code class="language-bash">vendor/bin/phpunit</code></pre>
<p>Looks so easy, and it is.</p>
<p>But there is a catch. We <strong>have to know which of these are the local ones</strong> and which are hiding a fractal of dependencies.</p>
<p><br></p>
<h2 id="How-to-detect-Local-Test">How to detect Local Test?</h2>
<p>Let's look at examples. What dependencies does the following test have?</p>
<pre><code class="language-php">use Symfony\Bundle\FrameworkBundle\Test\KernelTestCase;

final class ControllerTest extends KernelTestCase
{
    public function tests()
    {
    }
}</code></pre>
<p>From <code>KernelTestCase</code> we can assume that:</p>
<ul>
<li>it depends on a framework</li>
<li>that depends on the dependency container being built</li>
<li>that depends on loaded bundles</li>
<li>that depends on a database</li>
<li>that depends on installed PHP extensions</li>
<li>that usually depends on Docker build</li>
<li>that depends on correct <code>.env</code> variables</li>
</ul>
<p>If the test meets one of these conditions, we can skip it.</p>
<p><br></p>
<p>All the other tests left are <strong>the ones we want to test</strong>. We put them explicitly into <code>phpunit.xml</code> into the new test suite:</p>
<pre><code class="language-xml">&lt;?xml version="1.0"?&gt;
&lt;phpunit
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="vendor/phpunit/phpunit/phpunit.xsd"
    bootstrap="vendor/autoload.php"
&gt;
    &lt;testsuites&gt;
        &lt;testsuite name="unit"&gt;
            &lt;file&gt;tests/Services/ConfigPrinterTest.php&lt;/file&gt;
            &lt;file&gt;tests/Services/PackageUpgradeTest.php&lt;/file&gt;
        &lt;/testsuite&gt;
    &lt;/testsuites&gt;
&lt;/phpunit&gt;</code></pre>
<p>So we go one test by one and carefully review their parent class...</p>
<p>That sounds like a lot of work. Hmm, how could we automate it?</p>
<h2 id="4-Steps-to-Automate-Local-Test-Detection">4 Steps to Automate Local Test Detection</h2>
<p>In previous post, we learned about few <a href="/blog/5-commands-from-easy-ci-that-makes-your-ci-stronger/">useful commands for Easy CI setup</a>. There is one more just for our use case.</p>
<p><br></p>
<p><strong>1. Install Composer Package</strong></p>
<pre><code class="language-bash">composer require symplify/easy-ci --dev</code></pre>
<p><br></p>
<p><strong>2. Run Command on your tests directory</strong></p>
<pre><code class="language-bash">vendor/bin/easy-ci detect-unit-tests tests</code></pre>
<p>This command generated a <code>phpunit-unit-files.xml</code> file that contains an XML list of detected test files.</p>
<p><br></p>
<p><strong>3. Open the <code>phpunit-unit-files.xml</code> and move files to your <code>phpunit.xml</code></strong></p>
<pre><code class="language-xml">&lt;?xml version="1.0"?&gt;
&lt;phpunit
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="vendor/phpunit/phpunit/phpunit.xsd"
    bootstrap="vendor/autoload.php"
&gt;
    &lt;testsuites&gt;
        &lt;testsuite name="unit"&gt;
            &lt;file&gt;tests/Services/ConfigPrinterTest.php&lt;/file&gt;
            &lt;file&gt;tests/Services/PackageUpgradeTest.php&lt;/file&gt;
        &lt;/testsuite&gt;
    &lt;/testsuites&gt;
&lt;/phpunit&gt;</code></pre>
<p><br></p>
<p><strong>4. Run <code>--testsuite</code> unit group</strong></p>
<pre><code class="language-bash">vendor/bin/phpunit --testsuite unit</code></pre>
<p>Then set up your CI to run all your local tests we've detected this way.</p>
<p>Your next refactoring is now a bit safer, and you can continue to learn more about the new project.</p>
<p><br></p>
<p>Happy coding!</p>

            <br>


            <div class="card mt-5 border-warning">
                <div class="card-body text-center mt-2">
                    <p>
                        Have you find this post useful? <strong>Do you want more?</strong>
                    </p>
                    <p>
                        Follow me on <a href="https://twitter.com/votrubaT">Twitter</a>, <a href="/rss.xml">RSS</a> or support me on <a href="https://github.com/sponsors/TomasVotruba">GitHub Sponsors</a>.
                    </p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body text-white bg-success text-center">
                                            <a href="/blog/decomposing-symfony-kernel-what-does-minimal-symfony-bundle-do" class="d-block">
                            <div>
                                Read next → <strong>Decomposing Symfony Kernel: What does Minimal Symfony Bundle Do</strong>
                            </div>
                        </a>
                                    </div>
            </div>

            <br>
            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />
        <script src="/assets/prism/prism.js"></script>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

        <script type="text/javascript">
            // @see https://stackoverflow.com/a/30776817/1348344
            var date = new Date();
            // display every 2nd hour, not to spam users
            if (date.getHours() % 2 === 1) {
                document.querySelector('.book-banner').style.display = 'visible';
            } else {
                document.querySelector('.book-banner').style.display = 'none';
            }
        </script>
    </body>
</html>
