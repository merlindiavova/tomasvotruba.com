<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Filters Pattern in Nette Database | Tomas Votruba</title>
<meta charset="utf-8">
<meta name="robots" content="index, follow">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:creator" content="@votrubaT"/>

<meta property="og:image" content="/assets/images/tomas_votruba.jpg"/>

<link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">


<link rel="stylesheet" rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:700&amp;display=swap" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" media="print" onload="this.media='all'">

<link href="/assets/css/style.css?765559521" rel="stylesheet" type="text/css" />

                <meta property="og:title" content="Filters Pattern in Nette Database" />
        <meta property="og:url" content="https://tomasvotruba.com/blog/2016/06/17/filters-pattern-in-nette-database" />
        <meta name="description" property="og:description" content="You want to delete comments, so your readers won&#039;t see any spam or violent content.
But you want to see them in administration. So you would have to create 2 different methods.
Today I will show you, how to make only single one.
" />

            </head>

    <body>
                <!-- post_id: 9 -->
        <div id="menu">
    <div class="container-fluid">
        <a href="/">Home</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/blog">Blog</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/book/the-power-of-automated-refactoring">Book</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/trainings">Trainings</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/contact">Contact</a>
        <span class="pl-2 pr-2">•</span>

        <a href="https://twitter.com/votrubaT" target="blank">Twitter</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/rss.xml" target="blank">RSS</a>
    </div>
</div>

        <div class="container-fluid post" id="content">
            <h1>Filters Pattern in Nette Database</h1>

            <div class="pull-right">
                <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/main/packages/blog/data/2016/2016-06-17-filters-pattern-in-nette-database.md">Found a typo? Edit me</a>
            </div>

            <time datetime="2016-06-Fri" class="text-muted">
                2016-06-17
            </time>

                            <div class="card border-danger mt-4">
                    <div class="card-header text-white bg-danger">
                        This post is deprecated since January 2017. Its knowledge is old and should not be used.
                        <br>
                        <strong>Why?</strong>
                    </div>
                    <div class="card-body pb-2">
                        <p>I have deprecated this package, because it was not very active - it has been downloaded only 5 times during past 4 months.</p>
<p>It is still available <a href="https://github.com/DeprecatedPackages/NetteDatabaseFilters">here for inspiration</a> though.</p>
                    </div>
                </div>

                <br>
            
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>You want to delete comments, so your readers won't see any spam or violent content.
But you want to see them in administration. So you would have to create 2 different methods.
Today I will show you, how to make only single one.</p>
                </div>
            </div>

            <h2 id="current-way-to-do-this">Current way to do this</h2>
<p>Let's say we have a <code>CommentRepository</code> class, where we put all methods that work with &quot;comment&quot; table.</p>
<p>In it, we have 2 methods:</p>
<ul>
<li>1 for frontend</li>
<li>1 for administration</li>
</ul>
<pre><code class="language-php">namespace App\Repository;

use Nette\Database\Context;
use Nette\Database\Table\Selection;

class CommentRepository
{

    /**
     * @var Selection
     */
    private $commentTable;

    public function __construct(Context $database)
    {
        $this-&gt;commentTable = $database-&gt;table('comment');
    }

    /**
     * Returns only comments, that are not deleted.
     */
    public function fetchCommentsForFrontend()
    {
        return $this-&gt;commentTable-&gt;where('is_deleted = ?', FALSE)
            -&gt;fetchAll();
    }

    public function fetchCommentsForAdministration()
    {
        return $this-&gt;commentTable-&gt;fetchAll();
    }

}</code></pre>
<p>And <strong>decide manually</strong>, where to use <code>fetchCommentsForFrontend()</code> and where to use <code>fetchAllCommentsForAdministration()</code>.</p>
<p>This approach is bad practise, because it will eventually <strong>make your every repository class double its size</strong>.</p>
<p>No need for that! This has been already solved somewhere else.</p>
<p>Do you know Doctrine Filters? No? Go check <a href="/blog/2016/04/30/decouple-your-doctrine-filters/">this short article to get the clue</a>. I'll wait here.</p>
<h2 id="soft-delete-filter-in-theory">Soft delete filter - in theory</h2>
<p>In short, with filters you can modify any query. In our case:</p>
<ul>
<li>detect if the query is for &quot;comment&quot; table</li>
<li>detect if we are frontend or backend</li>
<li>if frontend, add where &quot;is_deleted=0&quot; condition to hide deleted comment</li>
</ul>
<p>This will influence <strong>every query for &quot;comment&quot; table</strong>.
So you can be sure you'll never forget to add the condition.</p>
<h2 id="show-me-the-code">Show me the code</h2>
<p>There is not much to talk about, because filters are made to be simple. So here is filter:</p>
<pre><code class="language-php"># app/Database/Filter/SoftDeletableFilter.php

namespace App\Database\Filter;

use Nette\Application\Application;
use Nette\Database\Table\Selection;
use Zenify\NetteDatabaseFilters\Contract\FilterInterface;

class SoftDeletableFilter implements FilterInterface
{

    public function __construct(Application $application)
    {
        $this-&gt;application = $application;
    }

    public function applyFilter(Selection $selection)
    {
        // 1. apply only to "comment" table
        $tableName = $selection-&gt;getName();
        if ($tableName !== 'comment') {
            return;
        }

        // 2. skip for admin presenters
        // add your custom method, that detects admin presenter via name or class inheritance
        if ($this-&gt;isAdminPresenter($this-&gt;application-&gt;getPresenter())) {
            return;
        }

        // 3. show only visible (not deleted) comments
        $selection-&gt;where('is_deleted = ?', FALSE);
    }

}</code></pre>
<p>And that's all.</p>
<p>These filters are possible in Nette\Database only thanks to <a href="https://github.com/Zenify/NetteDatabaseFilters">Zenify/NetteDatabaseFilters</a> package.</p>
<p>Do you want to try it for yourself? Let's go.</p>
<h2 id="your-first-filter-in-4-steps">Your First Filter in 4 steps</h2>
<h3 id="1.-install-package">1. Install package</h3>
<pre><code class="language-bash">composer require zenify/nette-database-filters</code></pre>
<h3 id="2.-register-extension">2. Register Extension</h3>
<pre><code class="language-yaml"># app/config/config.neon
extensions:
    - Zenify\NetteDatabaseFilters\DI\NetteDatabaseFiltersExtension</code></pre>
<h3 id="3.-create-your-filter">3. Create your filter</h3>
<p>The one above...</p>
<h3 id="4.-register-it-as-a-service">4. Register it as a service</h3>
<pre><code class="language-yaml"># app/config/config.neon
services:
    - App\Database\Filter\SoftDeletableFilter</code></pre>
<p>And that's it! Now your filter will be reflected in whole application.</p>
<p>So you can reduce your repository code and use <code>fetchComments()</code> in all places.</p>
<pre><code class="language-php"># app/Repository/CommentRepository.php

namespace App\Repository;

use Nette\Database\Context;
use Nette\Database\Table\Selection;

class CommentRepository
{

    /**
     * @var Selection
     */
    private $commentTable;

    public function __construct(Context $database)
    {
        $this-&gt;commentTable = $database-&gt;table('comment');
    }

    public function fetchComments()
    {
        return $this-&gt;commentTable-&gt;fetchAll();
    }

}</code></pre>
<p>For further use just <strong>check Readme for <a href="https://github.com/Zenify/NetteDatabaseFilters#nette-database-filters">Zenify/NetteDatabaseFilters</a></strong>.</p>
<h2 id="protip-for-multiple-tables-with-the-same-column!">Protip for multiple tables with the same column!</h2>
<p>What if you have <strong>multiple tables with &quot;is_deleted&quot; column</strong>? &quot;comment&quot;, &quot;article&quot;, &quot;page&quot; table... maybe &quot;banner&quot;, &quot;user&quot; in the furture.</p>
<ul>
<li>
<p>Do you have to create filter for every one of them? <strong>No.</strong></p>
</li>
<li>
<p>Do you have to name them all in the filter class? <strong>No.</strong></p>
</li>
<li>
<p>Do you need to check the column presence only? <strong>YES!</strong></p>
</li>
</ul>
<p>And I will show you how do it:</p>
<pre><code class="language-php"># app/Database/Filter/SoftDeletableFilter.php

// ...

public function applyFilter(Selection $selection)
{
    if (!$this-&gt;isSoftdelable($selection)) {
        return;
    }

    // ... condition code
}

/**
 * @return bool
 */
private function isSoftdelable(Selection $selection)
{
    $selectionToCheck = clone $selection;
    return $selectionToCheck-&gt;fetch()
        -&gt;offsetExists('is_deleted');
}</code></pre>
<p>Pretty neat, huh?</p>
<h2 id="what-have-you-learned-today?">What Have You Learned Today?</h2>
<ul>
<li>that Database Filters is a pattern for decorating query of specific table</li>
<li>that Nette Database can implement this pattern in a form of service</li>
<li>that you can add filter via simple service with <a href="https://github.com/Zenify/NetteDatabaseFilters">Zenify/NetteDatabaseFilters</a></li>
</ul>
<p>If you have some tips how to this simpler or want to share your experience with filters, just let me know below.</p>
<p>Happy coding!</p>

            <br>


            <div class="card mt-5 border-warning">
                <div class="card-body text-center mt-2">
                    <p>
                        Have you find this post useful? <strong>Do you want more?</strong>
                    </p>
                    <p>
                        Follow me on <a href="https://twitter.com/votrubaT">Twitter</a>, <a href="/rss.xml">RSS</a> or support me on <a href="https://github.com/sponsors/TomasVotruba">GitHub Sponsors</a>.
                    </p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body text-white bg-success text-center">
                    
                                            <a href="/blog/2016/04/30/decouple-your-doctrine-filters" class="d-block">
                            <div>
                                Read next → <strong>Decouple Your Doctrine Filters</strong>
                            </div>
                        </a>
                                    </div>
            </div>

            <br>
            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />
        <script src="/assets/prism/prism.js"></script>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>
    </body>
</html>
