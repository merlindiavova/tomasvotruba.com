<!DOCTYPE html>
<html lang="en">
    <head>
        <title>STAMP #1: How to Compile Twig to PHP | Tomas Votruba</title>
<meta charset="utf-8">
<meta name="robots" content="index, follow">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:creator" content="@votrubaT"/>

    <meta property="og:title" content="STAMP #1: How to Compile Twig to PHP" />
    <meta property="og:url" content="https://tomasvotruba.com/blog/stamp-1-how-to-compile-twig-to-php" />

            <meta property="og:image" content="https://tomasvotruba.com/assets/images/posts/2021/stamp_twig_simple.png" />
        <meta name="twitter:image" content="https://tomasvotruba.com/assets/images/posts/2021/stamp_twig_simple.png"/>
    
<link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">


<link rel="stylesheet" rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:700&amp;display=swap" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" media="print" onload="this.media='all'">

<link href="/assets/css/style.css?217004350" rel="stylesheet" type="text/css" />

                <meta name="description" property="og:description" content="In the previous post, we looked [at *why* and *when* static analysis of templates matter](/blog/stamp-static-analysis-of-templates). Today we look at how to prepare starting point for Twig templates.

How can we analyze templates with PHPStan that understand only PHP? There are 2 ways: we could teach PHPStan the language of Twig - a new &quot;TWIGStan&quot; tool.

The other option is to take it from the other end - convert Twig to PHP.
" />
    </head>

    <body>
        <!-- post_id: 339 -->
        <div id="menu">
    <div class="container-fluid">
        <a href="/">Home</a>
        <span class="pl-2 pr-2">â€¢</span>

        <a href="/blog">Blog</a>
        <span class="pl-2 pr-2">â€¢</span>

        <a href="/book/the-power-of-automated-refactoring">Book</a>
        <span class="pl-2 pr-2">â€¢</span>

        <a href="/trainings">Trainings</a>
        <span class="pl-2 pr-2">â€¢</span>

        <a href="/contact">Contact</a>
        <span class="pl-2 pr-2">â€¢</span>

        <a href="/about-me">About Me</a>
        <span class="pl-2 pr-2">â€¢</span>

        <a href="https://twitter.com/votrubaT" target="blank">Twitter</a>
        <span class="pl-2 pr-2">â€¢</span>

        <a href="/rss.xml" target="blank">RSS</a>
    </div>
</div>

        <div class="container-fluid post" id="content">
            <div class="text-center book-banner">
                <a href="https://leanpub.com/rector-the-power-of-automated-refactoring" target="blank" class="text-center">
                    <img src="/assets/images/banner-rector-book.png" class="mb-2 ml-auto mr-auto rounded " style="max-height: 5em" alt="">
                </a>
            </div>

            <h1>STAMP #1: How to Compile Twig to PHP</h1>

            <div class="pull-right">
                <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/main/packages/blog/data/2021/2021-08-16-stamp-1-how-to-compile-twig-to-php.md">Found a typo? Edit me</a>
            </div>

            <time datetime="2021-08-Mon" class="text-muted">
                2021-08-16
            </time>

            
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>In the previous post, we looked <a href="/blog/stamp-static-analysis-of-templates">at <em>why</em> and <em>when</em> static analysis of templates matter</a>. Today we look at how to prepare starting point for Twig templates.
<br><br>
How can we analyze templates with PHPStan that understand only PHP? There are 2 ways: we could teach PHPStan the language of Twig - a new &quot;TWIGStan&quot; tool.
<br><br>
The other option is to take it from the other end - convert Twig to PHP.</p>
                </div>
            </div>

            <p>In the previous post we worked with <code>templates/meal.twig</code> with single method call:</p>
<pre><code class="language-twig">{{ meal.title }}</code></pre>
<p>Today we'll try to turn this single line into PHP syntax.</p>
<h2 id="How-do-we-Render-Twig-in-our-Projects">How do we Render Twig in our Projects?</h2>
<p>The most common use case for rendering templates is in a Symfony controller. We call <code>$this-&gt;render()</code> with a template name as 1st argument:</p>
<pre><code class="language-php">use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\Response;

final class DinnerController extends AbstractController
{
    public function __invoke(): Response
    {
        return $this-&gt;render('templates/meal.twig');
    }
}</code></pre>
<p>This creates rendered HTML. But we don't have a tool called &quot;HTMLStan&quot;, but PHPStan. How do we get a PHP syntax of the <code>templates/meal.twig</code> template?</p>
<h2 id="From-Controller-to-Twig-Environment">From Controller to Twig Environment</h2>
<p>Let's take it to step by step. We don't need the whole <code>symfony/framework-bundle</code> to render Twig. What does the <code>render()</code> method of <code>AbstractController</code> do? It can be decomposed into these calls:</p>
<pre><code class="language-php">use Symfony\Component\HttpFoundation\Response;

// ...
abstract class AbstractController
{
    protected function render(string $view): Response
    {
        /** @var string $content */
        $content = $this-&gt;environment-&gt;render($view);

        $response = new Response();
        $response-&gt;setContent($content);

        return $response;
    }
}</code></pre>
<p>As you've expected, it is a simple request and response with some <code>string</code>. The <code>$content</code> string is what we're interested in.</p>
<p>But <strong>what is this &quot;environment&quot; we're calling?</strong> First association to &quot;environment&quot; might be &quot;env&quot; or development, production, and tests. But such a name suggests a value object or a variable, not a service. I will save you from confusion - it's a Twig renderer service. A name like &quot;TwigRenderer&quot; or &quot;TwigApplication&quot; would save us this paragraph, but sometimes legacy is what we have to work with.</p>
<h2 id="From-Response-to-Twig-Render">From Response to Twig Render</h2>
<p>Let's strip of clutter from <code>render()</code> and keep only the relevant lines:</p>
<pre><code class="language-php">use Twig\Environment;

$environment = new Environment();

/** @var string $content */
$content = $environment-&gt;render('templates/meal.twig');</code></pre>
<p>We pass a TWIG <code>'templates/meal.twig'</code> and get rendered HTML <code>$content</code>. How can we use this as food for PHPStan?</p>
<h2 id="TWIG-HTML">TWIG â†’ ? â†’ HTML</h2>
<p>We're getting closer. Now we know how to render TWIG file path to HTML content with couple of PHP lines and the <code>twig/twig</code> package. That's great! But <strong>how is that useful for static analysis in PHP</strong>?</p>
<p>First, we need to understand TWIG rendering lifecycle. It would be costly to convert every TWIG template to PHP, then complete variables and <code>echo</code> it to HTML string.</p>
<p>How does TWIG make sure it's fast?</p>
<h2 id="3-Step-TWIG-Lifecycle">3-Step TWIG Lifecycle</h2>
<ol>
<li>find <code>templates/meal.twig</code> absolute path and load its contents</li>
<li><strong>check if this template was already parsed to PHP</strong>
<ul>
<li>NO? parse if to PHP and save it the PHP to filesystem cache</li>
<li>YES? load the parsed PHP from the filesystem cache</li>
</ul></li>
<li>complete dynamic parameters to PHP template and echo it</li>
</ol>
<p>Now it's clear what we need to do. We have to do step 1., then step 2. parse TWIG to PHP and save the file to filesystem. PHPStan can analyze files in the filesystem, so we have a clear goal!</p>
<h2 id="Stop-Rendering-TWIG-at-PHP-Step">Stop Rendering TWIG at PHP Step?</h2>
<p>In the last snippet, we can see only the <code>render()</code> method that outputs HTML string:</p>
<pre><code class="language-php">use Twig\Environment;

$environment = new Environment();

/** @var string $content */
$content = $environment-&gt;render('templates/meal.twig');</code></pre>
<p>That's not what we need; it's too late for us. But we have all we need here. We just deep dive into the <code>render()</code> method and find out the smaller steps.</p>
<p>Inside the <code>render()</code> method, we'll find many nested calls, but in the end, it's just 3 methods:</p>
<ul>
<li><code>parse()</code> â†’ <strong><code>compile()</code></strong> <del>â†’ <code>render()</code></del></li>
<li>TWIG â†’ PHP <del>â†’ HTML</del></li>
</ul>
<h2 id="Finally-Compile-TWIG-to-PHP">Finally: Compile TWIG to PHP</h2>
<p>If we extract this <code>compile()</code> method and remove clutter code, we'll get to 3 lines that do the job:</p>
<pre><code class="language-php">use Twig\Environment;

$environment = new Environment();

// 1. gets contents of TWIG file and parses to tokens like tokens_get_all()
$source = $environment-&gt;getLoader()-&gt;getSourceContext('templates/meal.twig');

// 2. compile TWIG tokens to the PHP as we know it
$phpContent = $environment-&gt;compileSource($source);</code></pre>
<p><br></p>
<p><strong>In <code>$phpContent</code> now we have PHP string that PHPStan can analyze, yay!</strong></p>
<h1 id="">ðŸŽ‰</h1>
<h2 id="What-is-in-phpContent">What is in <code>$phpContent</code>?</h2>
<p>Are you curious, how does the final compiled PHP code look like?</p>
<p>I will not lie to you. It's not nice. It's even worse. It's not readable. That's probably because in 2009 when the TWIG was released, nobody thought of creating beautiful cached PHP code for PHPStan.</p>
<p><br></p>
<p>Are you ready? Here is it:</p>
<pre><code class="language-php">use Twig\Environment;
use Twig\Source;
use Twig\Template;

/* templates/meal.twig */
class __TwigTemplate_8a9d1381e8329967... extends Template
{
    private $source;
    private $macros = [];

    public function __construct(Environment $env)
    {
        parent::__construct($env);

        $this-&gt;source = $this-&gt;getSourceContext();

        $this-&gt;parent = false;

        $this-&gt;blocks = [
        ];
    }

    protected function doDisplay(array $context, array $blocks = [])
    {
        $macros = $this-&gt;macros;
        // line 1
        echo twig_escape_filter(
            $this-&gt;env,
            twig_get_attribute(
                $this-&gt;env,
                $this-&gt;source,
                ($context["meal"] ?? null),
                "title",
                "any",
                 false,
                 false,
                 false,
                 1
            ),
            "html",
            null,
            true
        );
    }

    public function getTemplateName()
    {
        return "templates/meal.twig";
    }

    public function isTraitable()
    {
        return false;
    }

    public function getDebugInfo()
    {
        return array (37 =&gt; 1);
    }

    public function getSourceContext()
    {
        return new Source("", "templates/meal.twig", "");
    }
}</code></pre>
<h2 id="How-is-this-PHP-Mess-Helpful">How is this PHP Mess Helpful?</h2>
<p>Not much, to be honest. Yet.</p>
<p>We'll give it a look <a href="/blog/stamp-2-how-to-turn-messy-twig-php-to-something-useful">in the next post</a>. Maybe we can come up with something useful.</p>
<p><br></p>
<p>Happy coding!</p>

            <br>


            <div class="card mt-5 border-warning">
                <div class="card-body text-center mt-2">
                    <p>
                        Have you find this post useful? <strong>Do you want more?</strong>
                    </p>
                    <p>
                        Follow me on <a href="https://twitter.com/votrubaT">Twitter</a>, <a href="/rss.xml">RSS</a> or support me on <a href="https://github.com/sponsors/TomasVotruba">GitHub Sponsors</a>.
                    </p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body text-white bg-success text-center">
                                            <a href="/blog/stamp-2-how-to-turn-messy-twig-php-to-something-useful" class="d-block">
                            <div>
                                Read next â†’ <strong>STAMP #2: How to Turn Messy TWIG PHP to Something Useful</strong>
                            </div>
                        </a>
                                    </div>
            </div>

            <br>
            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />
        <script src="/assets/prism/prism.js"></script>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

        <script type="text/javascript">
            // @see https://stackoverflow.com/a/30776817/1348344
            var date = new Date();
            // display every 2nd hour, not to spam users
            if (date.getHours() % 2 === 1) {
                document.querySelector('.book-banner').style.display = 'visible';
            } else {
                document.querySelector('.book-banner').style.display = 'none';
            }
        </script>
    </body>
</html>
