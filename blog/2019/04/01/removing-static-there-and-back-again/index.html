<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Removing Static - There and Back Again | Tomas Votruba</title>
<meta charset="utf-8">
<meta name="robots" content="index, follow">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:creator" content="@votrubaT"/>

<meta property="og:image" content="/assets/images/tomas_votruba.jpg"/>

<link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">


<link rel="stylesheet" rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:700&amp;display=swap" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" media="print" onload="this.media='all'">

<link href="/assets/css/style.css?602136065" rel="stylesheet" type="text/css" />

                <meta property="og:title" content="Removing Static - There and Back Again" />
        <meta property="og:url" content="https://tomasvotruba.com/blog/2019/04/01/removing-static-there-and-back-again" />
        <meta name="description" property="og:description" content="The more companies I meet, the more I see `static` and `new` everywhere. Not like `new Product`, but rather `new ProductRepository(new Database())`. Not just Laravel, but across all PHP frameworks. I wish frameworks could prevent antipatterns, but they don&#039;t, do they?

Instead of &quot;refactor all the things&quot; step by step, class by class, I&#039;d **like share my thoughts when exploring full automated path**. I look for feedback to improve this process.
" />

                    <meta property="og:image" content="https://tomasvotruba.com/assets/images/posts/2019/removing-static/there.jpg" />
            <meta name="twitter:card" content="summary_large_image"/>
            </head>

    <body>
        <!-- post_id: 199 -->
        <div id="menu">
    <div class="container-fluid">
        <a href="/">Home</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/blog">Blog</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/book/the-power-of-automated-refactoring">Book</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/trainings">Trainings</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/contact">Contact</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/about-me">About Me</a>
        <span class="pl-2 pr-2">•</span>

        <a href="https://twitter.com/votrubaT" target="blank">Twitter</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/rss.xml" target="blank">RSS</a>
    </div>
</div>

        <div class="container-fluid post" id="content">
            <div class="text-center book-banner">
                <a href="https://leanpub.com/rector-the-power-of-automated-refactoring" target="blank" class="text-center">
                    <img src="/assets/images/banner-rector-book.png" class="mb-2 ml-auto mr-auto rounded " style="max-height: 5em" alt="">
                </a>
            </div>

            <h1>Removing Static - There and Back Again</h1>

            <div class="pull-right">
                <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/main/packages/blog/data/2019/2019-04-01-removing-static-there-and-back-again.md">Found a typo? Edit me</a>
            </div>

            <time datetime="2019-04-Mon" class="text-muted">
                2019-04-01
            </time>

            
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>The more companies I meet, the more I see <code>static</code> and <code>new</code> everywhere. Not like <code>new Product</code>, but rather <code>new ProductRepository(new Database())</code>. Not just Laravel, but across all PHP frameworks. I wish frameworks could prevent antipatterns, but they don't, do they?
<br><br>
Instead of &quot;refactor all the things&quot; step by step, class by class, I'd <strong>like share my thoughts when exploring full automated path</strong>. I look for feedback to improve this process.</p>
                </div>
            </div>

            <h2 id="1-Show-Code">1. Show Code</h2>
<p>I usually start with a minimal code snippet possible, that explore the problem. No comments, no types, just the code. This is the real code I'm currently refactoring:</p>
<pre><code class="language-php">&lt;?php

final class Product
{
    private $price;

    public function __construct(float $price)
    {
        $this-&gt;price = $price;
    }

    public function getPrice(): Price
    {
        return new Price($this-&gt;price, CurrencyProvider::get());
    }
}

final class Price
{
    private $amount;

    private $currency;

    public function __construct(float $amount, Currency $currency)
    {
        $this-&gt;amount = $amount;
        $this-&gt;currency = $currency;
    }

    public function getAmount()
    {
        return $this-&gt;currency-&gt;convertFromCzk($this-&gt;amount);
    }
}</code></pre>
<h2 id="2-Describe-the-Code">2. Describe the Code</h2>
<p>Then I describe the problem with a few words using your common sense. No censorship, just flow of words.</p>
<p>&quot;There is a <code>Product</code> object... no, an entity since I can have multiple products. It has <em>active record pattern</em> since it creates <code>Price</code> in itself. There is also <em>static service locator</em> <code>CurrencyProvider::get()</code> to get current currency. I have no idea where the currency is set and it can be <em>overridden</em> multiple times during code run.</p>
<p>The goal of all this is probably to have price <em>always</em> in the same currency. Which is not true, since I can change the currency anytime I want. The price computation is input/output relations - so it should be solved by service, not an entity. I'm confused.&quot;</p>
<h2 id="3-Break-The-Code">3. Break The Code</h2>
<p>My favorite part. How can we break this code?</p>
<pre><code class="language-php">&lt;?php

$product = new Product(100.0);

CurrencyProvider::set('czk');
$product-&gt;getPrice(); // 100

CurrencyProvider::set('eur'); // this will be invoked in some other method, where the user needs a special price for newletter in Germany
$product-&gt;getPrice(); // ups, 2500?</code></pre>
<div class="alert alert-danger mt-3">
   1. An entity with the same ID can return different values on different calls of the same method.
</div>
<p>It's like my name would be &quot;Tom&quot; in the morning and &quot;John&quot; in the afternoon.</p>
<hr />
<pre><code class="language-php">&lt;?php

$product = new Product(100.0);
$product-&gt;getPrice(); // Error: 2nd argument of price cannot be null

CurrencyProvider::set('czk');</code></pre>
<div class="alert alert-danger mt-3">
    2. Due to a static design of <code>CurrencyProvider</code>, we cannot set currency at the single place of application, e.g. container creation, but we have to put it in the "right" place so it doesn't break the code. Here it broke the code because we set it too late.
</div>
<hr />
<pre><code class="language-php">&lt;?php

$product = new Product(100.0);

$allCurrencies = /* get from database */;
foreach ($allCurrencies as $currency) {
    CurrencyProvider::set($currency);
    echo $product-&gt;getPrice();
}

// what is the currency now?</code></pre>
<div class="alert alert-danger mt-3">
   3. How do I show a price for all the currencies we support?
</div>
<h2 id="3-The-Ideal-World">3. The Ideal World</h2>
<p>Now I imagine how I want this code to be designed in an ideal world, with enough time and skills. My goal is to make code work, while minimal as possible, while readable as quickly as possible. So when I leave the company, the person who reads the code will understand it at the same speed as I did.</p>
<ol>
<li>
<p>There will be a service that will take care of price computation.</p>
</li>
<li>
<p>It will accept <code>Product</code> and <code>Currency</code> as an argument.</p>
</li>
<li>
<p>That way it's easy to tests, method parameters are clearly stating dependencies, nothing to surprise.</p>
</li>
</ol>
<h2 id="4-Put-Ideal-World-into-Code">4. Put Ideal World into Code</h2>
<p>Now put that ideal into PHP code:</p>
<pre><code class="language-php">&lt;?php

final class Product
{
    private $price;

    public function __construct(float $price)
    {
        $this-&gt;price = $price;
    }

    public function getPrice()
    {
        return $this-&gt;price;
    }
}

final class Currency
{
    private $name;

    public function __construct(string $name)
    {
        $this-&gt;name = $name;
    }
}

final class PriceCalculator
{
    public function calculatePriceForProductAndCurrency(Product $product, Currency $currency): float
    {
        // ... computing algorithm ...
        return $price;
    }
}</code></pre>
<p>And then use:</p>
<pre><code class="language-php">&lt;?php

final class ProductController
{
    public function render()
    {
        $product = new Product(1000.0);
        $currency = new Currency('czk'); // default will be configured parameters in config.yaml

        $price = $this-&gt;priceCalculator-&gt;calculatePriceForProductAndCurrency($product, $currency);

        echo $price;
    }
}</code></pre>
<p>This is the thought process of most refactorings. It is mostly intuition until now. A small piece of code → the problem → the idea of how code should look like → the solution. Just commit and send for review, right?</p>
<p><br></p>
<p><a href="https://stackoverflow.com/a/454012/1348344">Martin Fowler</a> once said:</p>
<blockquote class="blockquote">
Refactoring is a controlled technique for improving the design of an existing code base. Its essence is applying <strong>a series of small</strong> behavior-preserving transformations, each of which "too small to be worth doing".<br><br>However the cumulative effect of each of these transformations is quite significant. <strong>By doing them in small steps you reduce the risk of introducing errors</strong>. You also avoid having the system broken while you are carrying out the restructuring - which allows you to gradually refactor a system over an <strong>extended period of time</strong>.
</blockquote>
<p>This worked well for a long period of time. Today I feel confident enough to say <strong>this paradigm is dead</strong> - and it's a good thing!</p>
<ul>
<li>&quot;series of small&quot;</li>
<li>&quot;small steps&quot;</li>
<li>&quot;extended period of time&quot;</li>
</ul>
<p>In 2019, we can do refactoring in <strong><a href="/blog/2019/02/21/how-we-migrated-from-nette-to-symfony-in-3-weeks-part-1/">one big step in short period of time</a></strong> - and still get working application in the end.</p>
<p>Clear proof is <strong>PHPStorm refactorings</strong> over the whole code base. They're still dumb compared to human and sometimes cause errors, but <a href="https://www.jetbrains.com/phpstorm/whatsnew">they get better and better each version</a>. Trend beats the status quo. You probably also know <strong><a href="https://github.com/kalessil/phpinspectionsea">Php Inspections (EA Extended)</a> plugin</strong> to PHPStorm.</p>
<p><br></p>
<p>It's easy to use these tools, but they still tend to solve the most generic problems. Instead of <strong>just blindly using
rules in these tools, we'll learn how to build them</strong> to solve your problem.</p>
<p><br></p>
<img src="/assets/images/posts/2019/removing-static/there.jpg" class="img-thumbnail">
<h2 id="5-Extract-The-Journey">5. Extract The Journey</h2>
<p>Back to the thinking process. This last step might seem a bit weird. We already have the clear code up and running and it's ready to ship. Why would we invest more energy into this? If I don't learn from this, I'm sentencing my future self to do it again in the future. It's funny to watch companies how they go for &quot;a business value&quot;, try to delivery features fast, but never pause to realize, that they do mostly repetitive tasks for the same price as the first one. So by this strategy to deliver business value fast, they cut their business value in half.</p>
<h3 id="Think-Big-Think-Absolute"><del>Think Big</del> Think Absolute</h3>
<p>Instead, I ask myself: &quot;how would I describe the process step by step to a machine, so it could refactor <strong>all PHP code</strong> on Github, Gitlab and the whole world with the same issue to the one in the end?&quot; There could be billions of such cases in the whole-world PHP code base.</p>
<p>If we're able to describe the process, <strong>we'll turn billions of use cases to 1 pattern transformation</strong>.</p>
<p>Imagine you try to fix typoes one-by-one manually. Or you could write a function, that fixes 5 most common typos for the user and hooks it on the Internet and SMS network (regardless of security) - to process every electronic message in the world. Just like that, the world became smarter thanks to you single function.</p>
<p>I disagree with Martin's statement: &quot;Its essence is applying a series of small behavior-preserving transformations&quot;. It's not about the behavior of code anymore. Much more important is the pattern in the code. We don't care about <code>Price</code>, nor <code>Currency</code> (it could be also called <code>Name</code> and <code>Invoice</code>).</p>
<p><br></p>
<p><strong>Instead we look at &quot;static call in an object&quot;.</strong></p>
<p><br></p>
<p>And what we did with that pattern it? Give your ideas in the comments or wait for the next post.</p>
<p><br></p>
<p>Happy coding!</p>

            <br>


            <div class="card mt-5 border-warning">
                <div class="card-body text-center mt-2">
                    <p>
                        Have you find this post useful? <strong>Do you want more?</strong>
                    </p>
                    <p>
                        Follow me on <a href="https://twitter.com/votrubaT">Twitter</a>, <a href="/rss.xml">RSS</a> or support me on <a href="https://github.com/sponsors/TomasVotruba">GitHub Sponsors</a>.
                    </p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body text-white bg-success text-center">
                                            <a href="/blog/2019/03/28/how-to-mock-final-classes-in-phpunit" class="d-block">
                            <div>
                                Read next → <strong>How to Mock Final Classes in PHPUnit</strong>
                            </div>
                        </a>
                                    </div>
            </div>

            <br>
            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />
        <script src="/assets/prism/prism.js"></script>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

        <script type="text/javascript">
            // @see https://stackoverflow.com/a/30776817/1348344
            var date = new Date();
            // display every 2nd hour, not to spam users
            if (date.getHours() % 2 === 1) {
                document.querySelector('.book-banner').style.display = 'visible';
            } else {
                document.querySelector('.book-banner').style.display = 'none';
            }
        </script>
    </body>
</html>
