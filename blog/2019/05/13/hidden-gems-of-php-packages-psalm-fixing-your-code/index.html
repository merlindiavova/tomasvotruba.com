<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Hidden Gems of PHP Packages: Psalm Fixing Your Code | Tomas Votruba</title>
<meta charset="utf-8">
<meta name="robots" content="index, follow">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:creator" content="@votrubaT"/>

    <meta property="og:image" content="/assets/images/tomas_votruba.jpg"/>

    <meta name="twitter:image" content="/assets/images/tomas_votruba.jpg"/>

<link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">


<link rel="stylesheet" rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:700&amp;display=swap" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" media="print" onload="this.media='all'">

<link href="/assets/css/style.css?693734641" rel="stylesheet" type="text/css" />

                <meta name="description" property="og:description" content="Psalm is a static analyzer of PHP code originated at Vimeo and developed by [Muglug](https://github.com/muglug). It can analyze your code for incorrect type declarations or unused code.

But did you know it can automatically fix these issues?
" />
    </head>

    <body>
        <!-- post_id: 211 -->
        <div id="menu">
    <div class="container-fluid">
        <a href="/">Home</a>
        <span class="pl-2 pr-2">‚Ä¢</span>

        <a href="/blog">Blog</a>
        <span class="pl-2 pr-2">‚Ä¢</span>

        <a href="/book/the-power-of-automated-refactoring">Book</a>
        <span class="pl-2 pr-2">‚Ä¢</span>

        <a href="/trainings">Trainings</a>
        <span class="pl-2 pr-2">‚Ä¢</span>

        <a href="/contact">Contact</a>
        <span class="pl-2 pr-2">‚Ä¢</span>

        <a href="/about-me">About Me</a>
        <span class="pl-2 pr-2">‚Ä¢</span>

        <a href="https://twitter.com/votrubaT" target="blank">Twitter</a>
        <span class="pl-2 pr-2">‚Ä¢</span>

        <a href="/rss.xml" target="blank">RSS</a>
    </div>
</div>

        <div class="container-fluid post" id="content">
            <div class="text-center book-banner">
                <a href="https://leanpub.com/rector-the-power-of-automated-refactoring" target="blank" class="text-center">
                    <img src="/assets/images/banner-rector-book.png" class="mb-2 ml-auto mr-auto rounded " style="max-height: 5em" alt="">
                </a>
            </div>

            <h1>Hidden Gems of PHP Packages: Psalm Fixing Your Code</h1>

            <div class="pull-right">
                <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/main/packages/blog/data/2019/2019-05-13-hidden-gems-of-php-packages-psalm-fixing-your-code.md">Found a typo? Edit me</a>
            </div>

            <time datetime="2019-05-Mon" class="text-muted">
                2019-05-13
            </time>

            
                            <div class="card border-success mt-4">
                    <div class="card-header text-white bg-success">
                        This post was updated at June 2019 with fresh know-how.
                        <br>
                        <strong>What is new?</strong>
                    </div>
                                            <div class="card-body pb-2">
                            <p>A new option <code>--issues=all</code> is added in Psalm 3.3.1</p>
                        </div>
                                    </div>

                <br>
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>Psalm is a static analyzer of PHP code originated at Vimeo and developed by <a href="https://github.com/muglug">Muglug</a>. It can analyze your code for incorrect type declarations or unused code.
<br><br>
But did you know it can automatically fix these issues?</p>
                </div>
            </div>

            <p>I did not and I was surprised. Psalm added this feature long time ago in March 2018 (as <a href="https://www.reddit.com/r/PHP/comments/84xrgy/fixing_code_that_aint_broken_vimeo_engineering">reported on Reddit</a>)! I was also surprised because static analyzer is read-only tools - &quot;here is error ‚Üí fix it yourself manually&quot;</p>
<h2 id="Static-Analyzers-Evolving-to-Code-Fixers">Static Analyzers Evolving to Code Fixers</h2>
<p><strong>But it's not an unexpected development.</strong> As I wrote in <em><a href="/blog/2018/10/22/brief-history-of-tools-watching-and-changing-your-php-code/">Brief History of Tools Watching and Changing Your PHP Code</a></em>, coding standard tools were <em>read-only</em> too and you had to change all the spaces manually. That was so annoying with large code-bases and many programmers didn't adopt it because it added the extra work on a daily basis, instead of saving time.</p>
<p>In response to this pressure, they <strong>had to become more useful by working for the programmer</strong>. PHP CS Fixer fixed code from the very first commit and PHP_CodeSniffer added this feature in response.</p>
<p>We can assume PHPStan and Phan will follow Psalm path since human-fixing is hard to scale and will become annoying in time compared to automated instant upgrades.</p>
<p><br></p>
<p>So what Psalm can do for you?</p>
<h2 id="1-Missing-Type-Declaration">1. Missing Type Declaration?</h2>
<p>Do you know that feeling when PHPStan reports &quot;Method X is returning an int, but should be a string&quot; in 10 000 places? Yes, you can use <a href="/blog/2019/04/22/hidden-gems-of-php-packages-srab/">Baseliner</a> to ignore them and check only new code, <strong>but that only postpones the problem</strong>. One day there still will be 3-4 days of full-time boring work ahead of you.</p>
<pre><code class="language-php">/**
 * @return int
 */
function foo()
{
  return 'hello';
}</code></pre>
<p>That's what Psalm fixes for you and even adds the return type declaration:</p>
<pre><code class="language-diff">-/**
- * @return int
- */
-function foo()
+function foo(): string
 {
   return 'hello';
 }</code></pre>
<h3 id="How-to-Run-it">How to Run it?</h3>
<p>Just use binary with <code>--alter</code> (that says &quot;fix&quot; this) + the <code>--issues</code> option:</p>
<pre><code class="language-bash">vendor/bin/psalm src --alter --issues=MissingReturnType
vendor/bin/psalm src --alter --issues=MissingClosureReturnType
vendor/bin/psalm src --alter --issues=InvalidReturnType
vendor/bin/psalm src --alter --issues=InvalidNullableReturnType</code></pre>
<p>The docs doesn't say if they stack together, but I'd assume so by the plural in &quot;issues&quot;:</p>
<pre><code class="language-bash">vendor/bin/psalm src --alter --issues=MissingReturnType,MissingClosureReturnType,InvalidReturnType,InvalidNullableReturnType</code></pre>
<h2 id="2-Falseable-Strings">2. Falseable Strings?</h2>
<p>Though the same kind of <em>detect type ‚Üí complete it</em> logic, this example is really nice:</p>
<pre><code class="language-php">function foo(): string {
  return rand(0, 1) ? 'hello' : false;
}</code></pre>
<p>‚Üì</p>
<pre><code>/**
 * @return string|false
 */
function foo() {
  return rand(0, 1) ? 'hello' : false;
}</code></pre>
<h2 id="3-Unused-Property-or-Method">3. Unused Property or Method?</h2>
<p>I wish this would be run before each code-review. Imagine you decouple a method during refactoring and stop using one of the existing methods in the same class. A dead method is born. <strong>A dead method that you need to maintain, test and upgrade to new version of PHP or your framework.</strong></p>
<p>Not anymore.</p>
<pre><code class="language-diff"> class A {
-     private function foo() : void {}
-     protected function bar() : void {}
-     public function baz() : void {}
 }

 new A();</code></pre>
<p>Same goes for properties:</p>
<pre><code class="language-diff"> class A {
-    /** @var string */
-    public $foo;

-    /** @var string */
-    protected $bar;
 }

 new A();</code></pre>
<h3 id="How-to-Run-it">How to Run it?</h3>
<pre><code class="language-bash">vendor/bin/psalm src --alter --issues=UnusedMethod
vendor/bin/psalm src --alter --issues=PossiblyUnusedMethod
vendor/bin/psalm src --alter --issues=UnusedProperty
vendor/bin/psalm src --alter --issues=PossiblyUnusedProperty</code></pre>
<h2 id="4-Undefined-Variable">4. Undefined Variable?</h2>
<p>How do you like this code?</p>
<pre><code class="language-php">if (rand(0, 1)) {
  $a = 5;
}
echo $a;</code></pre>
<p>Ups, <code>$a</code> is not defined (sometimes).</p>
<p>PHPStorm would tell you what's wrong with this code if you'd be writing this code. But again, it adds you extra manual work and doesn't <del>check</del> fix the rest of your huge code base from your CI.</p>
<p>Psalm can:</p>
<pre><code class="language-diff">+$a = null;
 if (rand(0, 1)) {
   $a = 5;
 }
 echo $a;</code></pre>
<p>If you're into static analysis, you know it's very hard to examine this flow of control and moreover add the variable not just the beginning of file or method, but to the right place where you or I would add it.</p>
<p>Cudos to <a href="https://github.com/muglug">Mathew</a>! üëç</p>
<h3 id="How-to-Run-it">How to Run it?</h3>
<pre><code class="language-bash">vendor/bin/psalm src --alter --issues=PossiblyUndefinedVariable</code></pre>
<h2 id="Check-all-13-of-them">Check all 13 of them</h2>
<p>At the time of writing this post, there is 13 issue alters now. I believe we can expect up to 100 more in next year or two.</p>
<p>You can run them all like this:</p>
<pre><code class="language-bash">vendor/bin/psalm src --alter --issues=all</code></pre>
<p><strong>Read about them and about extra options like <code>--php-version</code>, <code>--dry-run</code> or <code>--safe-types</code> in <a href="https://psalm.dev/docs/fixing_code">very beautiful and short documentation</a></strong>.</p>
<h2 id="Try-it-Even-if-you-use-PHPStan">Try it, Even if you use PHPStan</h2>
<p>Personally, I use PHPStan because I'm not good with XML. But even if I should <strong>install Psalm just to complete type-declarations and remove dead code</strong>, it's worth the 10 minutes time to set it up. Give a try, it's huge time saver the bigger code base you have.</p>
<p>You don't have to take my word for it:</p>
<blockquote class="twitter-tweet mt-5 mb-5" data-lang="en"><p lang="en" dir="ltr">Damn, <a href="https://twitter.com/psalmphp?ref_src=twsrc%5Etfw">@psalmphp</a> type declarations are saving me *TONS* of time and testing.</p>‚Äî null (@Ocramius) <a href="https://twitter.com/Ocramius/status/1120797947921350656?ref_src=twsrc%5Etfw">April 23, 2019</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p><br></p>
<p>This is the future = PHP tools working for us - enjoy it :)</p>
<p><br><br></p>
<p>Happy coding!</p>

            <br>


            <div class="card mt-5 border-warning">
                <div class="card-body text-center mt-2">
                    <p>
                        Have you find this post useful? <strong>Do you want more?</strong>
                    </p>
                    <p>
                        Follow me on <a href="https://twitter.com/votrubaT">Twitter</a>, <a href="/rss.xml">RSS</a> or support me on <a href="https://github.com/sponsors/TomasVotruba">GitHub Sponsors</a>.
                    </p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body text-white bg-success text-center">
                                            <a href="/blog/2019/05/09/is-rector-saving-you-time-support-it-on-patreon" class="d-block">
                            <div>
                                Read next ‚Üí <strong>Is Rector Saving you Time? Support it on GitHub Sponsors</strong>
                            </div>
                        </a>
                                    </div>
            </div>

            <br>
            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />
        <script src="/assets/prism/prism.js"></script>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

        <script type="text/javascript">
            // @see https://stackoverflow.com/a/30776817/1348344
            var date = new Date();
            // display every 2nd hour, not to spam users
            if (date.getHours() % 2 === 1) {
                document.querySelector('.book-banner').style.display = 'visible';
            } else {
                document.querySelector('.book-banner').style.display = 'none';
            }
        </script>
    </body>
</html>
