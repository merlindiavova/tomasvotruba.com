<!DOCTYPE html>
<html lang="en">
    <head>
        <title>From 0 Doc Types to Full Type Declaration with Dynamic Analysis | Tomas Votruba</title>
<meta charset="utf-8">
<meta name="robots" content="index, follow">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:creator" content="@votrubaT"/>

<meta property="og:image" content="/assets/images/tomas_votruba.jpg"/>

<link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">


<link rel="stylesheet" rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:700&amp;display=swap" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" media="print" onload="this.media='all'">

<link href="/assets/css/style.css?1754643334" rel="stylesheet" type="text/css" />

                <meta property="og:title" content="From 0 Doc Types to Full Type Declaration with Dynamic Analysis" />
        <meta property="og:url" content="https://tomasvotruba.com/blog/2019/11/11/from-0-doc-types-to-full-type-declaration-with-dynamic-analysis" />
        <meta name="description" property="og:description" content="I wrote [How we Completed Thousands of Missing @var Annotations in a Day](/blog/2019/07/29/how-we-completed-thousands-of-missing-var-annotations-in-a-day/). If you have at least some annotations, you can use Rector to do the dirty work.


To be honest, open-source is the top 1 % code there is, but out **in the wild of ~~legacy~~ established PHP companies, it&#039;s a miracle to see just one `string` type declaration**.


Are these projects lost? Do you have to quit them? And what if the annotations are lying?
" />

                    <meta property="og:image" content="https://tomasvotruba.com/assets/images/posts/2019/dynamic-analysis/probe.png" />
            <meta name="twitter:card" content="summary_large_image"/>
            </head>

    <body>
                <!-- post_id: 225 -->
        <div id="menu">
    <div class="container-fluid">
        <a href="/">Home</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/blog">Blog</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/book/the-power-of-automated-refactoring">Book</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/trainings">Trainings</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/contact">Contact</a>
        <span class="pl-2 pr-2">•</span>

        <a href="https://twitter.com/votrubaT" target="blank">Twitter</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/rss.xml" target="blank">RSS</a>
    </div>
</div>

        <div class="container-fluid post" id="content">
            <h1>From 0 Doc Types to Full Type Declaration with Dynamic Analysis</h1>

            <div class="pull-right">
                <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/main/packages/blog/data/2019/2019-11-11-from-0-doc-types-to-full-type-declaration-with-dynamic-analysis.md">Found a typo? Edit me</a>
            </div>

            <time datetime="2019-11-Mon" class="text-muted">
                2019-11-11
            </time>

            
                            <div class="card border-success mt-4">
                    <div class="card-header text-white bg-success">
                        This post was updated at August 2020 with fresh know-how.
                        <br>
                        <strong>What is new?</strong>
                    </div>
                                            <div class="card-body pb-2">
                            <p>Updated Rector YAML to PHP configuration, as current standard.</p>
                        </div>
                                    </div>

                <br>
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>I wrote <a href="/blog/2019/07/29/how-we-completed-thousands-of-missing-var-annotations-in-a-day/">How we Completed Thousands of Missing @var Annotations in a Day</a>. If you have at least some annotations, you can use Rector to do the dirty work.
<br>
<br>
To be honest, open-source is the top 1 % code there is, but out <strong>in the wild of <del>legacy</del> established PHP companies, it's a miracle to see just one <code>string</code> type declaration</strong>.
<br>
<br>
Are these projects lost? Do you have to quit them? And what if the annotations are lying?</p>
                </div>
            </div>

            <p>I had a great trip with a friend of mine <a href="https://github.com/DaveLiddament">Dave Liddament</a> after <a href="https://2019.phpday.it">PHP Day 2019 in Verona</a>. During Venice sightseeing in beautiful wild rain, we had a short coffee break to talk about Rector. Dave was amazed by what Rector can do for the developer, with such a few lines of YAML config.</p>
<p>As a proper curious developer, <strong>he challenged me with series</strong> of &quot;Can it do...?&quot; or &quot;How can it...?&quot; questions.</p>
<p><br></p>
<p>The one we spent almost an hour on one was:</p>
<p><strong>&quot;How can Rector help with type declarations, if there are no docblocks and no type hints?&quot;</strong></p>
<pre><code class="language-php">&lt;?php

class SomeClass
{
    public function run($value)
    {
        return $value;
    }
}</code></pre>
<p>First I was cold stone and said: &quot;That's far beyond static analysis. That's a job for a human, Rector can't help here&quot;.</p>
<p>I vividly recall I was sure was <em>this is impossible</em> (← now this line my motto pick project that is interesting enough, lol).</p>
<p><br></p>
<p>But David sticks with it questioning:</p>
<ul>
<li>&quot;If we know there is <strong>always a string coming inside and nothing else</strong>, we could do this:&quot;</li>
</ul>
<pre><code class="language-diff"> &lt;?php

 class SomeClass
 {
-    public function run($value)
+    public function run(string $value): string
     {
         return $value;
     }
 }</code></pre>
<ul>
<li>&quot;Well... yes, you're right.&quot;</li>
</ul>
<h2 id="detect-every-argument-type">Detect Every Argument Type</h2>
<p>I started to see a very small candle at the end of the tunnel and said:</p>
<ul>
<li>&quot;We could do some kind of logging types that come to the method. Collect enough data and decide based on that.&quot;</li>
</ul>
<p>There is a similar technique for dead-code analysis - <a href="https://github.com/krakjoe/tombs">tombs</a>. But the problem is, <strong>it's not written in PHP</strong>. And if it's not written in the language we use, we are not able to extend it or fix it. That's why PHPStorm plugins written Java take so long to catch up with framework releases.</p>
<p>We wanted to have the code just once in the whole application. If possible in the end and collect all the method calls and their arguments. We tried to use <code>register_shutdown_function</code> and <code>debug_trace</code> for it. But after some time spends hacking them, we gave up.</p>
<p>So it will have to be good old <strong>static call under each class method</strong>, something like:</p>
<pre><code class="language-diff"> &lt;?php

 class SomeClass
 {
    public function run($value)
    {
+       TypeCollector::collect($value, __METHOD__, 0);
        return $value;
    }
 }</code></pre>
<h2 id="what-about-performance">What about Performance?</h2>
<p><code>file_put_contents()</code> takes <a href="https://www.php.net/manual/en/function.file-put-contents.php#105421">~10 ms for 10 000 writes</a> writes, so writing in filesystem might work.</p>
<p>Still, it's safer to use <strong>feature toggles</strong> or direct <strong>small fraction of traffic</strong> to a standalone server with these static methods.</p>
<h2 id="how-long-should-we-collect-data">How Long Should we Collect Data?</h2>
<p>This needs to be tested in the wild. It depends on many factors, for a blogging platform, it can be a week of data.
For a payment system, a month would be better, maybe more to be sure.</p>
<p>Also, the same way we collect data first <strong>with feature toggle/traffic fraction</strong>, we can test added types after they're added to the code.</p>
<h2 id="the-simple-idea">The Simple Idea</h2>
<p>To make the idea more solid, we looked for the edge cases:</p>
<ul>
<li>&quot;Wait, so we just collect types and then analyze them?&quot;</li>
<li>&quot;Yes, if there are 10 000 calls for the method and it gets a string in 100 % cases, it's a <code>string</code>.&quot;</li>
<li>&quot;But, if 5 % of them is null... it will be nullable <code>?string</code>&quot;</li>
<li>&quot;Exactly, and if it's 5 different types, there is nothing we can do.&quot;</li>
<li>&quot;I see, but the point is to complete everything that can be completed, based on data and experience instead of docblock that can contain anything.&quot;</li>
</ul>
<p>The idea is pretty clear, right?</p>
<h2 id="how-can-we-bring-it-to-all-php-developers-in-need">How can we bring it to all PHP developers in Need?</h2>
<p>It all seemed like a nice brain exercise for our brains... but we looked for <strong>practical appliance that would help every PHP developer in the world</strong>.</p>
<p>To automate this process fully, we came with 4 automated steps:</p>
<ul>
<li>
<ol>
<li>Add type collector to all public class and trait methods</li>
</ol>
<pre><code class="language-diff"> &lt;?php

 class SomeClass
 {
    public function run($value)
    {
+       TypeCollector::collect($value, __METHOD__, 0);
        return $value;
    }
 }</code></pre>
</li>
<li>
<ol start="2">
<li>Collect data for a 1-4 weeks</li>
</ol>
</li>
<li>
<ol start="3">
<li>Complete collected types that can be added</li>
</ol>
<pre><code class="language-diff"> &lt;?php

 class SomeClass
 {
-    public function run($value)
+    public function run(string $value)
     {
         TypeCollector::collect($value, __METHOD__, 0);
         return $value;
     }
 }</code></pre>
</li>
<li>
<ol start="4">
<li>Remove type collector</li>
</ol>
<pre><code class="language-diff"> &lt;?php

 class SomeClass
 {
     public function run(string $value)
     {
-        TypeCollector::collect($value, __METHOD__, 0);
         return $value;
     }
 }</code></pre>
</li>
</ul>
<p>This was May 2019 and it was just an idea. Now, 6 months later, I'm proud to say this <strong>4-step process is now possible</strong>.
I've  <a href="https://github.com/rectorphp/rector/pull/2264/files">merged the PR into Rector</a> just a few minutes ago.</p>
<p>↓</p>
<h3 id="step-1-add-type-collector">Step 1 - Add Type Collector</h3>
<pre><code class="language-php">&lt;?php

// rector.php

declare(strict_types=1);

use Rector\DynamicTypeAnalysis\Rector\ClassMethod\DecorateMethodWithArgumentTypeProbeRector;
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();
    $services-&gt;set(DecorateMethodWithArgumentTypeProbeRector::class);
};</code></pre>
<pre><code class="language-bash">vendor/bin/rector process src</code></pre>
<h3 id="step-2-wait-for-it">Step 2 - Wait for it...</h3>
<h3 id="step-3-complete-collected-types">Step 3 - Complete Collected Types</h3>
<pre><code class="language-php">&lt;?php

// rector.php

declare(strict_types=1);

use Rector\DynamicTypeAnalysis\Rector\ClassMethod\AddArgumentTypeWithProbeDataRector;
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();
    $services-&gt;set(AddArgumentTypeWithProbeDataRector::class);
};</code></pre>
<pre><code class="language-bash">vendor/bin/rector process src</code></pre>
<h3 id="step-4-remove-type-collector">Step 4 - Remove Type Collector</h3>
<pre><code class="language-php">&lt;?php

// rector.php

declare(strict_types=1);

use Rector\DynamicTypeAnalysis\Rector\StaticCall\RemoveArgumentTypeProbeRector;
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();
    $services-&gt;set(RemoveArgumentTypeProbeRector::class);
};</code></pre>
<pre><code class="language-bash">vendor/bin/rector process src</code></pre>
<p><br></p>
<h2 id="it-s-not-perfect-but-done">It's not Perfect, But Done</h2>
<p>In all means, it's not perfect. There is still missing support for arrays, nested arrays, type co/ntra/variance, return types, union types, etc. <strong>But it's ready to be tested and prototype works</strong> (at least that's what unit tests say).</p>
<p>Now it's up to you. Make your code-base filled with real data it already uses. No guessing, no hoping, <strong>just science fully-automated</strong>.</p>
<p><br></p>
<p>Last but not least, thank you <a href="https://github.com/DaveLiddament">Dave</a> for a great afternoon and sorry it took me so long to publish this.</p>
<p><br></p>
<p>Happy lazy coding!</p>

            <br>


            <div class="card mt-5 border-warning">
                <div class="card-body text-center mt-2">
                    <p>
                        Have you find this post useful? <strong>Do you want more?</strong>
                    </p>
                    <p>
                        Follow me on <a href="https://twitter.com/votrubaT">Twitter</a>, <a href="/rss.xml">RSS</a> or support me on <a href="https://github.com/sponsors/TomasVotruba">GitHub Sponsors</a>.
                    </p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body text-white bg-success text-center">
                    
                                            <a href="/blog/2019/11/04/still-on-phpunit-4-come-to-phpunit-8-together-in-a-day" class="d-block">
                            <div>
                                Read next → <strong>Still on PHPUnit 4? Come to PHPUnit 8 Together in a Day</strong>
                            </div>
                        </a>
                                    </div>
            </div>

            <br>
            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />
        <script src="/assets/prism/prism.js"></script>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>
    </body>
</html>
