<!DOCTYPE html>
<html lang="en">
    <head>
        <title>How Dangerous is Your Nette Template Assign | Tomas Votruba</title>
<meta charset="utf-8">
<meta name="robots" content="index, follow">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:creator" content="@votrubaT"/>

<meta property="og:image" content="/assets/images/tomas_votruba.jpg"/>

<link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">


<link rel="stylesheet" rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:700&amp;display=swap" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" media="print" onload="this.media='all'">

<link href="/assets/css/style.css?1215524181" rel="stylesheet" type="text/css" />

                <meta property="og:title" content="How Dangerous is Your Nette Template Assign" />
        <meta property="og:url" content="https://tomasvotruba.com/blog/2021/02/15/how-dangerous-is-your-nette-template-assign" />
        <meta name="description" property="og:description" content="Symfony documentation contains a few [&quot;best practices&quot; that teach people to create bad code](https://matthiasnoback.nl/2014/10/unnecessary-contrapositions-in-the-new-symfony-best-practices/). It&#039;s important to talk about them so the framework can improve and thus its community can improve. Do you remember GitHub discussions about autowiring before it became part of Symfony?

Nette documentation is no different. **Today, we&#039;ll look at configuring templates and how to use them better and safer**.
" />

                    <meta property="og:image" content="https://tomasvotruba.com/assets/images/posts/2021/override_evil.png" />
            <meta name="twitter:card" content="summary_large_image"/>
            </head>

    <body>
                <!-- post_id: 303 -->
        <div id="menu">
    <div class="container-fluid">
        <a href="/">Home</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/blog">Blog</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/book/the-power-of-automated-refactoring">Book</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/trainings">Trainings</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/contact">Contact</a>
        <span class="pl-2 pr-2">•</span>

        <a href="https://twitter.com/votrubaT" target="blank">Twitter</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/rss.xml" target="blank">RSS</a>
    </div>
</div>

        <div class="container-fluid post" id="content">
            <h1>How Dangerous is Your Nette Template&nbsp;Assign</h1>

            <div class="pull-right">
                <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/main/packages/blog/data/2021/2021-02-15-how-dangerous-is-your-nette-template-assign.md">Found a typo? Edit me</a>
            </div>

            <time datetime="2021-02-Mon" class="text-muted">
                2021-02-15
            </time>

            
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>Symfony documentation contains a few <a href="https://matthiasnoback.nl/2014/10/unnecessary-contrapositions-in-the-new-symfony-best-practices/">&quot;best practices&quot; that teach people to create bad code</a>. It's important to talk about them so the framework can improve and thus its community can improve. Do you remember GitHub discussions about autowiring before it became part of Symfony?
<br><br>
Nette documentation is no different. <strong>Today, we'll look at configuring templates and how to use them better and safer</strong>.</p>
                </div>
            </div>

            <h2 id="what-is-the-main-purpose-of-template?">What is the Main Purpose of Template?</h2>
<p>What should a template engine do? Render some content to an end-user. Sometimes, it can be a static page; sometimes, there can be parameters. But fundamentally, that's it. Anything else is just fancy syntax sugar.</p>
<p>Let's look at a simple template example:</p>
<pre><code class="language-html">I'll give 10 Bitcoins to people in need</code></pre>
<p>Hmm, maybe the number will change. Let's make a parameter out of it:</p>
<pre><code class="language-php">$bitcoinCount = 10;</code></pre>
<pre><code class="language-html">&lt;!-- templates/giveaway.latte --&gt;
I'll give {$bitcoinCount} Bitcoins to people in need</code></pre>
<p>That was easy!</p>
<p><br></p>
<p>Are you curious about how other frameworks handle simple rendering? Me too!</p>
<p><br></p>
<p><a href="https://book.cakephp.org/4/en/controllers.html#rendering-a-view"><strong>CakePHP 4</strong></a></p>
<pre><code class="language-php">public function giveaway()
{
    $this-&gt;set('bitcoinCount', 100);
    return $this-&gt;render('templates/giveaway');
}</code></pre>
<p><br></p>
<p><a href="https://www.yiiframework.com/doc/guide/2.0/en/structure-views#rendering-views"><strong>Yii 2</strong></a></p>
<pre><code class="language-php">public function giveaway()
{
    return $this-&gt;render('giveaway', [
        'bitcoinCount' =&gt; 100,
    ]);
}</code></pre>
<p><br></p>
<p><a href="https://laravel.com/docs/8.x/controllers#basic-controllers"><strong>Laravel 8</strong></a></p>
<pre><code class="language-php">public function giveaway()
{
    return view('giveaway', [
        'bitcoinCount' =&gt; 100
    ]);
}</code></pre>
<p><br></p>
<p><a href="https://symfony.com/doc/current/templates.html#creating-templates"><strong>Symfony 5</strong></a></p>
<pre><code class="language-php">public function giveaway()
{
    return $this-&gt;render('templates/giveaway.twig', [
        'bitcoinCount' =&gt; 100
    ]);
}</code></pre>
<p><br></p>
<p>And <a href="https://doc.nette.org/en/3.1/components#toc-rendering"><strong>Nette 3.1</strong></a></p>
<pre><code class="language-php">public function render(): void
{
    $this-&gt;template-&gt;bitcoinCount = 100;
    $this-&gt;template-&gt;render(__DIR__ . '/templates/giveaway.latte');
}</code></pre>
<p><br></p>
<p>What do they have in common?</p>
<ul>
<li>every approach is using some name or absolute path as <strong>template identifier</strong></li>
<li>the template identifier is passed <strong>first argument of &quot;render&quot; method</strong></li>
</ul>
<p>But how are parameters handled? There are 2 groups:</p>
<ul>
<li>parameter can be set <strong>anywhere above</strong> the &quot;render&quot; method</li>
<li>parameters are passed <strong>exactly once</strong> into the &quot;render&quot; method</li>
</ul>
<p>The 2nd approach is far better than 1st one. Could you guess <strong>9 reasons why</strong>?</p>
<h2 id="1.-variable-override-bug">1. Variable Override Bug</h2>
<p>Why don't we use public properties? Because they can be overridden anywhere without us knowing:</p>
<pre><code class="language-php">final class Product
{
    public $price;
}</code></pre>
<p>We have at least setters that we can somehow monitor:</p>
<pre><code class="language-php">final class Product
{
    private $price;

    public function changePrice($price)
    {
        $this-&gt;price = $price;
    }
}</code></pre>
<p>You might be thinking - why would anyone make such a rookie mistake? I assure you, <strong>this is one the most hated bug in legacy code</strong>. Single variable change can take days or weeks to find out... if you have to go through 2 500 000 lines of code, you see for the first time.</p>
<p>Private property and change methods are still crappy though:</p>
<pre><code class="language-php">$product = new Product();

$product-&gt;changePrice(100);

// 1000 lines bellow

$product-&gt;changePrice(10);</code></pre>
<p>So after many years of tears we learned to <strong>use a constructor, where we require the values that cannot be changed</strong>:</p>
<pre><code class="language-php">final class Product
{
    public function __construct(
        private $price
    ) {
    }
}</code></pre>
<p>How is this related to <code>$this-&gt;template</code>? The same way we can break <code>Product</code> price, we can break <code>$this-&gt;template</code> parameters:</p>
<pre><code class="language-php">public function render(): void
{
    $this-&gt;template-&gt;bitcoinCount = 100;

    // 1000 lines bellow

    $this-&gt;template-&gt;bitcoinCount = 10;

    $this-&gt;template-&gt;render(__DIR__ . '/templates/giveaway.latte');
}</code></pre>
<p>Or more evil example:</p>
<pre><code class="language-php">public function render(): void
{
    $this-&gt;template-&gt;bitcoinCount = 100;

    $this-&gt;sendNotification();

    $this-&gt;template-&gt;render(__DIR__ . '/templates/giveaway.latte');
}

// 1000 lines bellow

private function sendNotification(): void
{
    // oh, someone needs to do little unrelated change here
    $this-&gt;template-&gt;bitcoinCount = 10;
}</code></pre>
<p>What is the <code>$bitcoinCount</code>? <code>10</code> or <code>100</code>? It depends on the <code>$this-&gt;template</code> override mechanism, I guess.</p>
<p>❌</p>
<h2 id="2.-call-me...-maybe">2. Call Me... Maybe</h2>
<p>With property access like this, we can define parameters... just sometimes:</p>
<pre><code class="language-php">public function render(): void
{
    if ($this-&gt;inGoodMood) {
        $this-&gt;template-&gt;bitcoinCount = 100;
    }

    $this-&gt;template-&gt;render(__DIR__ . '/templates/giveaway.latte');
}</code></pre>
<p>Quick quiz: <strong>what is the <code>$bitcoinCount</code> value in the template?</strong></p>
<ul>
<li><code>false</code></li>
<li><code>null</code></li>
<li>nothing, use <code>isset()</code> to check if exists</li>
<li>nothing, use <code>empty()</code> to check if exists</li>
</ul>
<p>❌</p>
<h2 id="3.-unset-or-nullable-variable?">3. Unset or Nullable Variable?</h2>
<p>This bug build on previous weakness. Let's say we have a <a href="https://afilina.com/null-hell">null-hell</a> nullable return:</p>
<pre><code class="language-php">private function getBitcoinCount(): ?int
{
    // ...
}</code></pre>
<p>How can we differentiate between variable set to <code>null</code>...</p>
<pre><code class="language-php">$this-&gt;template-&gt;bitcoinCount = $this-&gt;getBitcoinCount();</code></pre>
<p>...and variable that is missing?</p>
<pre><code class="language-php">if ($this-&gt;inGoodMood) {
    $this-&gt;template-&gt;bitcoinCount = $this-&gt;getBitcoinCount();
}</code></pre>
<p>❌</p>
<h2 id="4.-forgotten-require-variable">4. Forgotten Require Variable</h2>
<p>The example above would also fail, because the <code>{$bitcoinCount}</code> is required in template:</p>
<pre><code class="language-html">&lt;!-- templates/giveaway.latte --&gt;
I'll give {$bitcoinCount} Bitcoins to people in need</code></pre>
<p>How can you <strong>define what is required variable</strong>? In objects and services, we have <code>__construct()</code> for that, but here?</p>
<p>❌</p>
<h2 id="5.-two-ways-to-do-one-thing">5. Two Ways to do One Thing</h2>
<img src="/assets/images/posts/2021/two_thing_one.jpg" class="img-thumbnail mt-4 mb-2">
<p>Let's say we manage to set variable once in the template. Many months later, a new developer learns about 2nd <code>render()</code> parameters and uses them:</p>
<pre><code class="language-diff"> public function render(): void
 {
     $this-&gt;template-&gt;bitcoinCount = 100;

-    $this-&gt;template-&gt;render(__DIR__ . '/templates/giveaway.latte');
+    $this-&gt;template-&gt;render(__DIR__ . '/templates/giveaway.latte', [
+        'bitcoinCount' =&gt; 10
+    ]);
 }</code></pre>
<p>What is the final template we'll see?</p>
<ul>
<li>A. <code>I'll give 100 Bitcoins to people in need</code></li>
<li>B. <code>I'll give 10 Bitcoins to people in need</code></li>
</ul>
<p>❌</p>
<h2 id="6.-read-it!">6. Read It!</h2>
<p>As with any other public property, we can read it and modify it:</p>
<pre><code class="language-php">public function render(): void
{
    $this-&gt;template-&gt;bitcoinCount = 100;

    if ($this-&gt;template-&gt;bitcoinCount &gt; 100) {
        $this-&gt;template-&gt;bitcoinCount += 10;
    }
}</code></pre>
<p>Soon we're using <code>$this-&gt;template</code> for any variable operation.</p>
<p>❌</p>
<h2 id="7.-killing-known-types">7. Killing Known Types</h2>
<p>We know that type of <code>100</code> is <code>int</code>, so do PHPStan, PHPStorm, and Rector. But once we set it to magical <code>$this-&gt;template</code>, everybody becomes blind:</p>
<pre><code class="language-php">public function render(): void
{
    $this-&gt;template-&gt;bitcoinCount = 100;

    // condition is always true... but who knows?
    if (is_int($this-&gt;template-&gt;bitcoinCount)) {
        // ...
    }
}</code></pre>
<p>❌</p>
<h2 id="8.-making-magic-more-magical">8. Making Magic more Magical</h2>
<p>With Nette 3.0, there has been an attempt to fix the magic with <a href="https://blog.nette.org/en/latte-how-to-use-type-system">typed template objects</a>. The intention to have a typed template is good, but it adds more magic to rendering.</p>
<p>The <code>$this-&gt;template</code> is not a service anymore, but a value object. That can hold parameters. And also render itself somehow. That's typical example of <strong><a href="https://en.wikipedia.org/wiki/Active_record_pattern">active record anti-pattern</a></strong>. Are you able to give birth yourself? <strong>Not a way to go.</strong></p>
<p>❌</p>
<p>There is a better way to have both <strong>typed template</strong> and <strong>pass parameters just once</strong>. I'll write about it soon - stay tuned.</p>
<h2 id="9.-typos-everywhere">9. Typos Everywhere</h2>
<p>Could you guess, what will happen here?</p>
<pre><code class="language-php">public function render(): void
{
    $this-&gt;template-&gt;bitcoinCount = 100;

    if ($this-&gt;template-&gt;bitcointCount &gt; 10) {
        $this-&gt;template-&gt;bitcoinCount -= 10;
    }

    // ...
}</code></pre>
<p>The condition is obviously a <code>true</code>, right?</p>
<p>Well, the second variable <em>bitcoin<strong>t</strong>Count</em> does not exists, so we're now <code>-10</code> bitcoints.</p>
<p>❌</p>
<h2 id="back-to-basics">Back to Basics</h2>
<p>There is one more surprise. How does <a href="https://latte.nette.org/en/guide#toc-installation-and-usage">Latte documentation</a> look like? <strong>It promotes the clear approach!</strong></p>
<pre><code class="language-php">$latte = new Latte\Engine;

$latte-&gt;render('template.latte', [
    'items' =&gt; ['one', 'two', 'three']
]);</code></pre>
<p>So why is every presenter and component using it wrong? Because Occam's razor - people <strong>tend to pick the first solution they see and use it everywhere</strong>.</p>
<h2 id="the-correct-way-to-render-templates-with-parameters">The Correct Way to Render Templates With Parameters</h2>
<p>What if there is a way to avoid all 7 possible bugs above? Like we don't have enough bug potential in our code-bases.</p>
<p>I know you've already guessed it, but just to Google can find it too. The correct way to render parameters is to <strong>pass them exactly once</strong> as 2nd parameter of <code>render()</code> method:</p>
<pre><code class="language-php">public function render(): void
{
    $this-&gt;template-&gt;render(__DIR__ . '/templates/giveaway.latte', [
        'bitcoinCount' =&gt; 10
    ]);
}</code></pre>
<p>Do we work with a value above the render? <strong>Use a variable</strong> to separate templating system from business logic:</p>
<pre><code class="language-php">public function render(): void
{
    $bitcoinCount = $this-&gt;getBitcoinCount();
    if ($bitcoinCount === null) {
        $bitcoinCount = self::MINIMUM_REQUIRED_AMOUNT;
    }

    $this-&gt;template-&gt;render(__DIR__ . '/templates/giveaway.latte', [
        'bitcoinCount' =&gt; $bitcoinCount,
    ]);
}</code></pre>
<p>Do we need an optional parameter? <strong>Such code smell</strong> suggests our template architecture is wrong:</p>
<ul>
<li>Maybe there should be an extra component?</li>
<li>Maybe the parameter should be required and have a value of <code>0</code>?</li>
</ul>
<p><br></p>
<p>Do you have more magical objects like this one? Please get rid of them before they get rid of your sanity. Now you have nine reasons why :)</p>
<p><br></p>
<p>Happy coding!</p>

            <br>


            <div class="card mt-5 border-warning">
                <div class="card-body text-center mt-2">
                    <p>
                        Have you find this post useful? <strong>Do you want more?</strong>
                    </p>
                    <p>
                        Follow me on <a href="https://twitter.com/votrubaT">Twitter</a>, <a href="/rss.xml">RSS</a> or support me on <a href="https://github.com/sponsors/TomasVotruba">GitHub Sponsors</a>.
                    </p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body text-white bg-success text-center">
                    
                                            <a href="/blog/2021/02/11/tree-coding-vs-bush-coding" class="d-block">
                            <div>
                                Read next → <strong>Tree Coding vs. Bush Coding</strong>
                            </div>
                        </a>
                                    </div>
            </div>

            <br>
            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />
        <script src="/assets/prism/prism.js"></script>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>
    </body>
</html>
