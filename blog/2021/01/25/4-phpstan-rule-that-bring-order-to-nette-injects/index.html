<!DOCTYPE html>
<html lang="en">
    <head>
        <title>4 PHPStan Rules that Bring Order to Nette Injects | Tomas Votruba</title>
<meta charset="utf-8">
<meta name="robots" content="index, follow">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:creator" content="@votrubaT"/>

    <meta property="og:title" content="4 PHPStan Rules that Bring Order to Nette Injects" />
    <meta property="og:url" content="https://tomasvotruba.com/blog/2021/01/25/4-phpstan-rule-that-bring-order-to-nette-injects" />

            <meta property="og:image" content="https://tomasvotruba.com/assets/images/tomas_votruba.jpg"/>
        <meta name="twitter:image" content="https://tomasvotruba.com/assets/images/tomas_votruba.jpg"/>
    
<link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">


<link rel="stylesheet" rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:700&amp;display=swap" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" media="print" onload="this.media='all'">

<link href="/assets/css/style.css?934557828" rel="stylesheet" type="text/css" />

                <meta name="description" property="og:description" content="Do you have at least one `@inject` property or `inject*()` method in your Nette project? If no, stop reading and have fun with another post.


If you do, you probably have some internal rules where what and how to use them and where to avoid them. But how do you keep order?
" />
    </head>

    <body>
        <!-- post_id: 299 -->
        <div id="menu">
    <div class="container-fluid">
        <a href="/">Home</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/blog">Blog</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/book/the-power-of-automated-refactoring">Book</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/trainings">Trainings</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/contact">Contact</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/about-me">About Me</a>
        <span class="pl-2 pr-2">•</span>

        <a href="https://twitter.com/votrubaT" target="blank">Twitter</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/rss.xml" target="blank">RSS</a>
    </div>
</div>

        <div class="container-fluid post" id="content">
            <div class="text-center book-banner">
                <a href="https://leanpub.com/rector-the-power-of-automated-refactoring" target="blank" class="text-center">
                    <img src="/assets/images/banner-rector-book.png" class="mb-2 ml-auto mr-auto rounded " style="max-height: 5em" alt="">
                </a>
            </div>

            <h1>4 PHPStan Rules that Bring Order to Nette Injects</h1>

            <div class="pull-right">
                <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/main/packages/blog/data/2021/2021-01-25-4-phpstan-rule-that-bring-order-to-nette-injects.md">Found a typo? Edit me</a>
            </div>

            <time datetime="2021-01-Mon" class="text-muted">
                2021-01-25
            </time>

            
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>Do you have at least one <code>@inject</code> property or <code>inject*()</code> method in your Nette project? If no, stop reading and have fun with another post.
<br>
<br>
If you do, you probably have some internal rules where what and how to use them and where to avoid them. But how do you keep order?</p>
                </div>
            </div>

            <p>If you talk about your project's standards that everyone <em>should</em> follow, remember the old lazy programmer's saying:</p>
<blockquote class="blockquote text-center">
    "In CI,<br>
    or won't happen."
</blockquote>
<h2 id="Injection-Everywhere">Injection Everywhere?</h2>
<p>Using injection makes sense in some cases, like avoiding circular dependencies. Another use case is an abstract class with dozens of child classes, but mostly it's <a href="/blog/2020/06/01/inject-or-required-will-get-you-any-service-fast/">a killer for a healthy dependency tree</a>.</p>
<p>In a one <a href="https://nette.org/">Nette</a> project I worked on within the last five years, they had a very &quot;cool&quot; DI extension. A DI extension that enables <code>@inject</code> everywhere:</p>
<pre><code class="language-php">final class SomeClass
{
    /**
     * @var EventDispatcher
     * @inject
     */
    public $eventDispatcher;
}</code></pre>
<p>Why needs <code>__construct()</code>. right? Get PHP 8 promoted properties today.</p>
<blockquote class="blockquote text-center">
    "If it's not forbidden,<br>
    it's allowed."
</blockquote>
<p>Luckily, nowadays, we have a <a href="https://github.com/symplify/phpstan-rules">Symplify PHPStan rules</a> to help us.</p>
<h2 id="1-Do-Not-Combine-Nette-Inject-and-construct">1. Do Not Combine Nette Inject and <code>__construct()</code></h2>
<p>If there is a constructor already, there an exact working way to get dependencies:</p>
<pre><code class="language-php">class SomeClass
{
    private $someType;

    private $anotherType;

    public function __construct(AnotherType $anotherType)
    {
        $this-&gt;anotherType = $anotherType;
        // ...
    }

    public function injectSomeType(SomeType $someType)
    {
        $this-&gt;someType = $someType;
    }
}</code></pre>
<p>❌</p>
<p><br></p>
<p>It's better to use far cleaner <code>__construct()</code> inection:</p>
<pre><code class="language-php">class SomeClass
{
    private $someType;

    private $anotherType;

    public function __construct(AnotherType $anotherType, SomeType $someType)
    {
        $this-&gt;anotherType = $anotherType;
        $this-&gt;someType = $someType;
    }
}</code></pre>
<p>✅</p>
<p>Covered by <code>Symplify\PHPStanRules\Rules\NoNetteInjectAndConstructorRule</code> rule.</p>
<p><br></p>
<h2 id="2-Use-Single-Nette-inject-Method">2. Use Single Nette <code>inject*()</code> Method</h2>
<p>Using the <code>inject*()</code> method is an equal alternative to <code>@inject</code> property that does not require a property to be public.
It like an extra <code>__construct()</code> that is caller by the framework to set other dependencies.</p>
<p>Single <code>__construct()</code> has its meaning. Imagine this use case:</p>
<pre><code class="language-php">class SomeClass
{
    private $type;

    private $anotherType;

    public function injectOne(SameType $type)
    {
        $this-&gt;type = $type;
    }

    public function injectTwo(SameType $anotherType)
    {
        $this-&gt;anotherType = $anotherType;
    }
}</code></pre>
<p>❌</p>
<p>Having multiple <code>inject*()</code> methods allow us to <strong>accidentally put two dependencies</strong> in the same class. This has performance hit, maintenance hit, and duplicated parasitic code that needs our attention for no gain.</p>
<p><br></p>
<p>We can solve all this with a single <code>inject*()</code> method per class:</p>
<pre><code class="language-php">class SomeClass
{
    private $someType;

    public function injectSomeClass(SomeType $someType)
    {
        $this-&gt;someType = $someType;
    }
}</code></pre>
<p>✅</p>
<p>Covered by <code>Symplify\PHPStanRules\Rules\SingleNetteInjectMethodRule</code> rule.</p>
<p><br></p>
<h2 id="3-Validate-at-inject-Format">3. Validate <code>@inject</code> Format</h2>
<p>I'm proud to admit I made this bug last week. With IDE autocomplete, class annotations, and PHP 8 attributes, I'm removing my skill to type precisely the word:</p>
<pre><code class="language-php">class SomeClass
{
    /**
     * @injects
     * @var SomeDependency
     */
    public  $someDependency;
}</code></pre>
<p>...and the property was <code>null</code>.</p>
<p>❌</p>
<p><br></p>
<p>Let's not do that ever again and validate <strong>letter by letter</strong> of <code>@inject</code> annotation:</p>
<pre><code class="language-diff"> class SomeClass
 {
     /**
-     * @injects
+     * @inject
      * @var SomeDependency
      */
     public $someDependency;
}</code></pre>
<p>✅</p>
<p>Covered by <code>Symplify\PHPStanRules\Rules\ValidNetteInjectRule </code> rule.</p>
<h2 id="4-No-at-inject-on-final-Class">4. No <code>@inject</code> on <code>final</code> Class</h2>
<p>Last but not least, this rule finally put an order to our codebase.</p>
<p>A specific need for injects is an abstract class with a couple of children:</p>
<pre><code class="language-php">abstract class AbstractPresenter
{
}

final class ProductPresenter extends AbstractPresenter
{
}</code></pre>
<p><strong>Where would you allow injects?</strong></p>
<ul>
<li>in both classes</li>
<li>in children classes only</li>
<li>in abstract class only</li>
</ul>
<p><br></p>
<p>What would be the consequences:</p>
<ul>
<li><strong>In both classes?</strong> It's a mess that leads to injection hell. Would you get vaccinated against covid every week? No, so don't force your code to suffer either.</li>
<li><strong>In children classes only?</strong> Putting responsibility on every single child can be quite a challenge.</li>
<li><strong>In <code>abstract</code> class only?</strong> Well, a single parent with five children is quite a responsibility, but it's clear and one place to go in case of problems.</li>
</ul>
<p>The ideal options is 3). Using inject only abstract classes make children cleaner and less coupled to the framework. There are more children classes than abstract, so code base quality will be much higher if children classes are strict and clean.</p>
<pre><code class="language-php">final class ProductPresenter extends AbstractPresenter
{
    /**
     * @inject
     * @var AnotherDependency
     */
    public $anotherDependency;
}</code></pre>
<p>✅</p>
<p>Covered by <code>Symplify\PHPStanRules\Rules\NoInjectOnFinalRule</code> rule.</p>
<p><br></p>
<p>That's it for today. Try the rule one by one and run PHPStan to see how it helps your project:</p>
<pre><code class="language-bash">composer require symplify/phpstan-rules --dev</code></pre>
<p><br></p>
<p>Happy coding!</p>

            <br>


            <div class="card mt-5 border-warning">
                <div class="card-body text-center mt-2">
                    <p>
                        Have you find this post useful? <strong>Do you want more?</strong>
                    </p>
                    <p>
                        Follow me on <a href="https://twitter.com/votrubaT">Twitter</a>, <a href="/rss.xml">RSS</a> or support me on <a href="https://github.com/sponsors/TomasVotruba">GitHub Sponsors</a>.
                    </p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body text-white bg-success text-center">
                                            <a href="/blog/2021/01/18/4-ways-symplify-makes-working-with-symfony-more-fun" class="d-block">
                            <div>
                                Read next → <strong>4 Ways Symplify makes Working With Symfony More Fun</strong>
                            </div>
                        </a>
                                    </div>
            </div>

            <br>
            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />
        <script src="/assets/prism/prism.js"></script>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

        <script type="text/javascript">
            // @see https://stackoverflow.com/a/30776817/1348344
            var date = new Date();
            // display every 2nd hour, not to spam users
            if (date.getHours() % 2 === 1) {
                document.querySelector('.book-banner').style.display = 'visible';
            } else {
                document.querySelector('.book-banner').style.display = 'none';
            }
        </script>
    </body>
</html>
