<!DOCTYPE html>
<html lang="en">
    <head>
        <title>How to Replace Single Node with Two Nodes in Abstract Syntax Tree | Tomas Votruba</title>
<meta charset="utf-8">
<meta name="robots" content="index, follow">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:creator" content="@votrubaT"/>

    <meta property="og:image" content="https://tomasvotruba.com/assets/images/posts/2021/replace_two_nodes_stmt.png" />
    <meta property="og:title" content="How to Replace Single Node with Two Nodes in Abstract Syntax Tree" />
    <meta property="og:url" content="%env(SITE_URL)/blog/how-to-replace-single-node-with-two-nodes-in-abstract-syntax-tree" />

    <meta name="twitter:image" content="https://tomasvotruba.com/assets/images/posts/2021/replace_two_nodes_stmt.png"/>

<link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">


<link rel="stylesheet" rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:700&amp;display=swap" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" media="print" onload="this.media='all'">

<link href="/assets/css/style.css?1069350165" rel="stylesheet" type="text/css" />

                <meta name="description" property="og:description" content="Already over 120 people bought [the Rector book](/blog/rector-the-power-of-automated-refactoring-book-released) that we released just a month ago. The continuously growing interest in abstract syntax technology makes me very happy.

It leads to more developers **who can write their own custom Rector rules to improve their specific projects**. That leads to more &quot;how-to&quot; questions in the Rector repository. I&#039;ve decided to answer one of the frequent ones today.
" />
    </head>

    <body>
        <!-- post_id: 325 -->
        <div id="menu">
    <div class="container-fluid">
        <a href="/">Home</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/blog">Blog</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/book/the-power-of-automated-refactoring">Book</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/trainings">Trainings</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/contact">Contact</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/about-me">About Me</a>
        <span class="pl-2 pr-2">•</span>

        <a href="https://twitter.com/votrubaT" target="blank">Twitter</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/rss.xml" target="blank">RSS</a>
    </div>
</div>

        <div class="container-fluid post" id="content">
            <div class="text-center book-banner">
                <a href="https://leanpub.com/rector-the-power-of-automated-refactoring" target="blank" class="text-center">
                    <img src="/assets/images/banner-rector-book.png" class="mb-2 ml-auto mr-auto rounded " style="max-height: 5em" alt="">
                </a>
            </div>

            <h1>How to Replace Single&nbsp;Node with Two&nbsp;Nodes in Abstract Syntax Tree</h1>

            <div class="pull-right">
                <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/main/packages/blog/data/2021/2021-06-28-how-to-replace-single-node-with-two-nodes-in-abstract-syntax-tree.md">Found a typo? Edit me</a>
            </div>

            <time datetime="2021-06-Mon" class="text-muted">
                2021-06-28
            </time>

            
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>Already over 120 people bought <a href="/blog/rector-the-power-of-automated-refactoring-book-released">the Rector book</a> that we released just a month ago. The continuously growing interest in abstract syntax technology makes me very happy.
<br><br>
It leads to more developers <strong>who can write their own custom Rector rules to improve their specific projects</strong>. That leads to more &quot;how-to&quot; questions in the Rector repository. I've decided to answer one of the frequent ones today.</p>
                </div>
            </div>

            <p>Standard rules usually replace one node with another, or change it. There are three operations you can make. Let's take them one by one, starting from the simplest.</p>
<p><br></p>
<h2 id="1-Change-one-Node">1. Change one Node</h2>
<p>E.g. when here it renames one class in a constructor to another:</p>
<pre><code class="language-diff"> public function __construct(
-    EntityManager $entityManager
+    EntityManagerInterface $entityManager
 ) {
 }</code></pre>
<p><br></p>
<p>In Rector rule AST syntax, it looks like this:</p>
<pre><code class="language-php">use PhpParser\Node\Param;
use Rector\Core\Rector\AbstractRector;

final class RenameEntityManagerRector extends AbstractRector
{
    /**
     * @param Param $node
     */
    public function refactor(Node $node)
    {
        // here we only change `type` property, everything else remains the same
        $node-&gt;type = new Name('EntityManagerInterface');

        // then we return original node
        return $node;
    }

    // ...
}</code></pre>
<p>We change a node and return the changed node. Let's move to level 2.</p>
<h2 id="2-Replacing-One-Node-by-Another">2. Replacing One Node by Another</h2>
<p>Let's say we want to upgrade to PHP 8 and use new <code>str_contains()</code> function:</p>
<pre><code class="language-diff">-Nette\Utils\Strings::contains($content, 'letter');
+str_contains($content, 'letter');</code></pre>
<p><br></p>
<p>Here we replace <code>StaticCall</code> node with <code>FuncCall</code>:</p>
<pre><code class="language-php">use PhpParser\Node\Expr\FuncCall;use PhpParser\Node\Expr\StaticCall;
use PhpParser\Node\Name;use Rector\Core\Rector\AbstractRector;

final class ReplaceStrContainsRector extends AbstractRector
{
    /**
     * @param StaticCall $node
     */
    public function refactor(Node $node)
    {
        // we'll use arguments from the original node
        $args = $node-&gt;args;

        // here we create a new func call node, with specific name and args
        $funcCallName = new Name('str_contains');

        return new FuncCall($funcCallName, $args);
    }

    // ...
}</code></pre>
<p>Are you still with me? Let's get to the most complex one.</p>
<p><br></p>
<h2 id="3-Replacing-Single-Node-by-Two-Nodes">3. Replacing Single Node by Two Nodes</h2>
<p>Let's say we have an extremely complex line where a lot of operations happens at once:</p>
<pre><code class="language-php">$result = 5 + 10;</code></pre>
<p>I'm a bit exaggerating here, but I believe <strong>any code should be easily readable</strong> even after 3 glasses of wine. How can we improve the code, so we understand the code even late in the night?</p>
<p>Let's separate one operation per line:</p>
<pre><code class="language-diff">-$result = 5 + 10;
+$input = 10;
+$result = 5 + $input;</code></pre>
<p>One line per one operation. Now we can easily see what is going on. How would such modification look like in a Rector rule?</p>
<pre><code class="language-php">use PhpParser\Node\Expr\Assign;
use PhpParser\Node\Expr\BinaryOp\Plus;
use PhpParser\Node\Expr\Variable;
use Rector\Core\Rector\AbstractRector;

final class RenameEntityManagerRector extends AbstractRector
{
    /**
     * @param Assign $node
     */
    public function refactor(Node $node)
    {
        /** @var Plus $plus */
        $plus = $node-&gt;expr;

        // stands for: 5
        $leftSideOfPlus = $plus-&gt;left;

        // stands for: 10
        $rightSideOfPlus = $plus-&gt;right;

        // stands for: "$result"
        $resultVariable = $node-&gt;var;

        // this will create "$input = 10;"
        $inputVariable = new Variable('input');
        $firstLine = new Assign($inputVariable, $rightSideOfPlus);

        // this will create "$result = 5 + $input;"
        $secondLine = new Assign($resultVariable, new Plus($leftSideOfPlus, $inputVariable));

        // magic happens here?
    }

    // ...
}</code></pre>
<p>What should we return in the <code>refactor()</code> method to change the original line and add one extra line?</p>
<p>I'll give you a hint: we always returned the content we wanted to change in previous examples.</p>
<p>So what do we return here? Again, the content we want to change:</p>
<pre><code class="language-php">use PhpParser\Node;

// ...

public function refactor(Node $node)
{
    // ...

    return [
        $firstLine,
        $secondLine
    ];
}</code></pre>
<p>Just instead of a single node, it's 2 nodes. How easy is that?</p>
<p>But in practice, this rule would not work. We need to respect the abstract syntax tree node traverser architecture of php-parser.
Don't worry. We're 2 steps away from success. But first, you need to understand one big difference...</p>
<h2 id="Statements-vs-Expressions">Statements vs. Expressions</h2>
<p>In php-parser, there are 2 kinds of nodes:</p>
<p><br></p>
<div class="row">
    <div class="col-md-6">
        <p>First extend <code>PhpParser\Node\Expr</code> class</p>
        <img src="/assets/images/posts/2021/replace_two_nodes_expr.png" class="img-thumbnail">
    </div>
    <div class="col-md-6">
        <p>Second extend <code>PhpParser\Node\Stmt</code> class</p>
        <img src="/assets/images/posts/2021/replace_two_nodes_stmt.png" class="img-thumbnail">
    </div>
</div>
<p><br></p>
<p>Look at the first picture and pick one node from there... e.g., <code>PhpParser\Node\Scalar\MagicConst\Dir</code>.
What is it?</p>
<pre><code class="language-php">__DIR__</code></pre>
<p>It's an expression that <strong>holds a value</strong>. <code>__DIR__</code> returns a <code>string</code> with an absolute path to the current directory.</p>
<p><br></p>
<p>Let's look at the second picture... what do we pick from there? E.g. <code>ClassMethod</code>. It's a method in a class, interface, or trait. It does not <strong>hold any value</strong>. It's part of a structure. A typical example is a constructor method:</p>
<pre><code class="language-php">public function __construct()
{
}</code></pre>
<p><br></p>
<h3 id="Expr"><strong><code>Expr</code></strong></h3>
<ul>
<li>holds a value</li>
<li>can be used as part of operation (<code>__DIR__ . '/Fixture'</code>)</li>
<li>can be nested in other expressions (<code>strlen(__DIR__ . '/Fixture') &gt; 10</code>)</li>
</ul>
<h3 id="Stmt"><strong><code>Stmt</code></strong></h3>
<ul>
<li>is part of code</li>
<li>it <em>just exists</em></li>
<li>is a structural element among other elements</li>
</ul>
<p>If you're still missing the difference, check other classes that implement <code>Expr</code> or <code>Stmt</code>. It will give you a better idea.</p>
<p><br></p>
<h2 id="The-Golden-Rule-of-Replacing-Nodes">The Golden Rule of Replacing Nodes</h2>
<p>Why do we even talk about this?
<strong>Because we can only replace one <code>Stmt</code> by multiple <code>Stmt</code></strong>.</p>
<p>Let's get back to our example:</p>
<pre><code class="language-diff">-$result = 5 + 10;
+$input = 10;
+$result = 5 + $input;</code></pre>
<p>We had an <code>Assign</code> on the input... what is this node extending?</p>
<pre><code class="language-php">namespace PhpParser\Node\Expr;

use PhpParser\Node\Expr;

class Assign extends Expr
{
    // ...
}</code></pre>
<p>It's an <code>Expr</code>, so we cannot replace it... we're screwed... or are we?</p>
<p>There is a neat trick to overcome this - every line that is not an <code>Stmt</code> is wrapped with an <code>Expression</code> node that is <code>Stmt</code>.</p>
<p>What does it mean?</p>
<pre><code class="language-php">// Assign (Expr)
$result = 5 + 10

// Expressions (Stmt)
$result = 5 + 10;</code></pre>
<p>Mind the missing <code>;</code> in the first line. With this trick, now we're able to update the original rule to make it work for us:</p>
<p><br></p>
<pre><code class="language-php">use PhpParser\Node\Stmt\Expression;
use PhpParser\Node\Expr\Assign;

/**
 * @param Expression $node
 */
public function refactor(Node $node)
{
    if (! $node-&gt;expr instanceof Assign) {
        return null;
    }

    $assign = $node-&gt;expr;

    // ... here the change is the same

    return [
        new Expression($firstLine),
        new Expression($secondLine)
    ];
}</code></pre>
<p>And that's it! Now we've replaced the <code>Assign</code> node with two different <code>Assing</code>s ✅ .</p>
<p><br></p>
<p><strong>Would you like to learn more about Rector internals like this and how to make it work for your project?</strong>
<a href="/trainings">Get a Rector training</a> where you'll learn practical tips and tricks in just 3 hours and save dozens of self-learning.</p>
<p><br></p>
<p>Happy coding!</p>

            <br>


            <div class="card mt-5 border-warning">
                <div class="card-body text-center mt-2">
                    <p>
                        Have you find this post useful? <strong>Do you want more?</strong>
                    </p>
                    <p>
                        Follow me on <a href="https://twitter.com/votrubaT">Twitter</a>, <a href="/rss.xml">RSS</a> or support me on <a href="https://github.com/sponsors/TomasVotruba">GitHub Sponsors</a>.
                    </p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body text-white bg-success text-center">
                                            <a href="/blog/how-to-make-upgrade-safe-with-bridge-testing" class="d-block">
                            <div>
                                Read next → <strong>How to make Upgrade Safe with Bridge Testing</strong>
                            </div>
                        </a>
                                    </div>
            </div>

            <br>
            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />
        <script src="/assets/prism/prism.js"></script>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

        <script type="text/javascript">
            // @see https://stackoverflow.com/a/30776817/1348344
            var date = new Date();
            // display every 2nd hour, not to spam users
            if (date.getHours() % 2 === 1) {
                document.querySelector('.book-banner').style.display = 'visible';
            } else {
                document.querySelector('.book-banner').style.display = 'none';
            }
        </script>
    </body>
</html>
