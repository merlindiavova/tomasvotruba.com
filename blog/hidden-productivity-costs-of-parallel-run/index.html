<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Hidden Productivity Costs of Parallel Run | Tomas Votruba</title>
<meta charset="utf-8">
<meta name="robots" content="index, follow">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:creator" content="@votrubaT"/>

    <meta property="og:title" content="Hidden Productivity Costs of Parallel Run" />
    <meta property="og:url" content="https://tomasvotruba.com/blog/hidden-productivity-costs-of-parallel-run" />

            <meta property="og:image" content="https://tomasvotruba.com/assets/images/posts/2021/cores.jpg" />
        <meta name="twitter:image" content="https://tomasvotruba.com/assets/images/posts/2021/cores.jpg"/>
    
<link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">


<link rel="stylesheet" rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:700&amp;display=swap" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" media="print" onload="this.media='all'">

<link href="/assets/css/style.css?761674862" rel="stylesheet" type="text/css" />

                <meta name="description" property="og:description" content="Have you enabled parallel run in PHPStan and ECS? You know the speed gain is brutal. On the other hand, there are **few hidden costs in developer experience** I haven&#039;t faced before.

What are they, and how to mitigate their impact?
" />
    </head>

    <body>
        <!-- post_id: 334 -->
        <div id="menu">
    <div class="container-fluid">
        <a href="/">Home</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/blog">Blog</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/book/the-power-of-automated-refactoring">Book</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/trainings">Trainings</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/contact">Contact</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/about-me">About Me</a>
        <span class="pl-2 pr-2">•</span>

        <a href="https://twitter.com/votrubaT" target="blank">Twitter</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/rss.xml" target="blank">RSS</a>
    </div>
</div>

        <div class="container-fluid post" id="content">
            <div class="text-center book-banner">
                <a href="https://leanpub.com/rector-the-power-of-automated-refactoring" target="blank" class="text-center">
                    <img src="/assets/images/banner-rector-book.png" class="mb-2 ml-auto mr-auto rounded " style="max-height: 5em" alt="">
                </a>
            </div>

            <h1>Hidden Productivity Costs of Parallel Run</h1>

            <div class="pull-right">
                <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/main/packages/blog/data/2021/2021-09-27-hidden-productivity-costs-of-parallel-run.md">Found a typo? Edit me</a>
            </div>

            <time datetime="2021-09-Mon" class="text-muted">
                2021-09-27
            </time>

            
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>Have you enabled parallel run in PHPStan and ECS? You know the speed gain is brutal. On the other hand, there are <strong>few hidden costs in developer experience</strong> I haven't faced before.
<br><br>
What are they, and how to mitigate their impact?</p>
                </div>
            </div>

            <h2 id="All-CPUs-are-Fully-Used">All CPUs are Fully Used</h2>
<p>PHPStan parallel implementation uses your CPU cores to process multiple files at once. When I run it on my PC, it looks like this:</p>
<img src="/assets/images/posts/2021/hidden_cost_cpu_history.png" class="img-thumbnail mt-3" style="max-width: 38em">
<p>That's great! 16 threads, all fully used. It means the static analysis process of any project ends up in 15 seconds. That's fast, and then I'll be able to continue.</p>
<p>The problem is, for these 15 seconds, the laptop does not have any spare computation power. It only focuses on tasks given by PHPStan, but <strong>everything else is slowed down</strong>.</p>
<p><a href="/blog/2020/01/13/why-is-first-instant-feedback-crucial-to-developers/">Instant feedback is essential</a> to stay in the flow and focused on the project. Any lag can destroy <a href="/blog/2018/09/13/your-brain-is-your-garden/">state of beautiful deep work</a>.</p>
<h2 id="Short-but-Complete-Lag">Short but Complete Lag?</h2>
<p>Imagine you're writing a post or a code, and then you have to pause for 15 seconds... or even 10 or 5 seconds. Your brain has to stop thinking, start caching the thoughts and code you want to write.</p>
<blockquote class="blockquote text-center mt-3 mb-5">
    Would you use PHPStorm<br>
    if it has 5 seconds lag everytime you create a new class?
</blockquote>
<p>What if you want to run PHPStan and one more tool, e.g., PHPUnit or ECS? The <strong>latter will suffer from low computation power</strong> and take much longer than parallel of PHPStan.</p>
<p><br></p>
<h2 id="Keep-1-CPU-Always-Free">Keep 1 CPU Always Free</h2>
<p>There is a workaround for this. We can tell PHPStan to use fewer threads than is our maximum. That way, there will always be one free:</p>
<pre><code class="language-yaml"># phpstan.neon
parameters:
    parallel:
        # for Tomas: 16 threads - 1
        maximumNumberOfProcesses: 15</code></pre>
<h2 id="Max-Full-Min-Free">Max Full !== Min Free</h2>
<p>Well, there will be one always free <em>on my pc</em>. The problem is, all the developers share the main <code>phpstan.neon</code> config. But what is the chance the developers use computers with the same amount of CPU threads?</p>
<p><br></p>
<p>It would be much better to have the option to see the number of accessible CPUs. Something like:</p>
<pre><code class="language-yaml"># phpstan.neon
parameters:
    parallel:
        minimumNumberOfFreeThreads: 1</code></pre>
<p>P.S.: If you know of such a feature, let me know.</p>
<p><br></p>
<h2 id="All-at-Once-of-One-by-One">All at Once of One by One?</h2>
<p>Imagine you have to compute 5 algebraic formulas. You can choose one from 2 ways to receive them:</p>
<ul>
<li>A) you'll get one every 10 minutes</li>
<li>B) you'll get all formulas at once</li>
</ul>
<p><br></p>
<p><strong>Which will cost you more time and which more energy?</strong></p>
<h2 id="Parallel-Drains-your-Battery-Much-Faster">Parallel Drains your Battery Much Faster</h2>
<p>Before parallel run was added to PHPStan, my laptop worked for only 4-5 hours of coding. I could go for coffee in the morning, see a client, do little mentoring, and it was still running in the afternoon.</p>
<p><br></p>
<p>As only 1 core was working, <strong>there was lot of energy left.</strong></p>
<img src="/assets/images/posts/2021/cores.jpg" class="img-thumbnail mt-2 mb-4" style="max-width: 27em">
<p>That changed since parallel. When you develop PHPStan rules or work on various projects, PHPStan often needs to analyze the whole project from scratch. That's fast in time but costly in energy.</p>
<p><br></p>
<p><strong>Suddenly, my laptop battery duration dropped from 5 hours to 2,5 hours</strong>. It turned off, charger at home and I was free to meditate.</p>
<p>The battery duration estimates were jumping like crazy from 6 hours to 30 minutes and back. First, I assumed it's some bug in my Ubuntu. Then I found out it depended if PHPStan was <strong>running or not</strong>.</p>
<h2 id="Charger-is-Your-Friend">Charger is Your Friend</h2>
<p>This is not a life-ending situation, but it's something you should be aware of. If you're a cable type and stay in one place always plugged in, you don't mind.</p>
<img src="/assets/images/posts/2021/parallel_charger.jpg" class="img-thumbnail mt-4 mb-3" style="max-width: 25em">
<p>But <strong>if you love to travel, work, or write posts on the train</strong> like me, keep it in mind.</p>
<p><br></p>
<p>Happy coding!</p>

            <br>


            <div class="card mt-5 border-warning">
                <div class="card-body text-center mt-2">
                    <p>
                        Have you find this post useful? <strong>Do you want more?</strong>
                    </p>
                    <p>
                        Follow me on <a href="https://twitter.com/votrubaT">Twitter</a>, <a href="/rss.xml">RSS</a> or support me on <a href="https://github.com/sponsors/TomasVotruba">GitHub Sponsors</a>.
                    </p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body text-white bg-success text-center">
                                            <a href="/blog/introducing-up-to-16-times-faster-easy-coding-standard" class="d-block">
                            <div>
                                Read next → <strong>Introducing up-to 16 Times Faster Easy Coding Standard</strong>
                            </div>
                        </a>
                                    </div>
            </div>

            <br>
            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />
        <script src="/assets/prism/prism.js"></script>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

        <script type="text/javascript">
            // @see https://stackoverflow.com/a/30776817/1348344
            var date = new Date();
            // display every 2nd hour, not to spam users
            if (date.getHours() % 2 === 1) {
                document.querySelector('.book-banner').style.display = 'visible';
            } else {
                document.querySelector('.book-banner').style.display = 'none';
            }
        </script>
    </body>
</html>
