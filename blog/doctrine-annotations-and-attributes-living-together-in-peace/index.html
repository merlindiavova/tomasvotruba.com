<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Doctrine Annotations and Attributes Living Together in Peace | Tomas Votruba</title>
<meta charset="utf-8">
<meta name="robots" content="index, follow">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:creator" content="@votrubaT"/>

<meta property="og:image" content="/assets/images/tomas_votruba.jpg"/>

<link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">


<link rel="stylesheet" rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:700&amp;display=swap" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" media="print" onload="this.media='all'">

<link href="/assets/css/style.css?605053482" rel="stylesheet" type="text/css" />

                <meta property="og:title" content="Doctrine Annotations and Attributes Living Together in Peace" />
        <meta property="og:url" content="https://tomasvotruba.com/blog/doctrine-annotations-and-attributes-living-together-in-peace" />
        <meta name="description" property="og:description" content="In previous post [How to Refactor Custom Doctrine Annotations to Attributes](/blog/how-to-refactor-custom-doctrine-annotations-to-attributes) we looked on how to make the `@annotation` to `#[Attribute]` transition.

Last week, we started refactoring in [my favorite long-term project](https://www.startupjobs.cz/startup/scrumworks-s-r-o), and we came to a challenging situation. When we started to move all annotations to attributes at once, we lost control over the results. It was also impossible because 3rd party annotations were not attributes ready.

We had to **support annotations and attributes at the same time**. Do you have plenty of custom annotations yourself? In this post, you&#039;ll learn to build a bridge with both annotations and attributes on board.
" />

                    <meta property="og:image" content="https://tomasvotruba.com/assets/images/posts/2021/named_argument_constructor.png" />
            <meta name="twitter:card" content="summary_large_image"/>
            </head>

    <body>
        <!-- post_id: 323 -->
        <div id="menu">
    <div class="container-fluid">
        <a href="/">Home</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/blog">Blog</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/book/the-power-of-automated-refactoring">Book</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/trainings">Trainings</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/contact">Contact</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/about-me">About Me</a>
        <span class="pl-2 pr-2">•</span>

        <a href="https://twitter.com/votrubaT" target="blank">Twitter</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/rss.xml" target="blank">RSS</a>
    </div>
</div>

        <div class="container-fluid post" id="content">
            <div class="text-center book-banner">
                <a href="https://leanpub.com/rector-the-power-of-automated-refactoring" target="blank" class="text-center">
                    <img src="/assets/images/banner-rector-book.png" class="mb-2 ml-auto mr-auto rounded " style="max-height: 5em" alt="">
                </a>
            </div>

            <h1>Doctrine Annotations and Attributes Living Together in Peace</h1>

            <div class="pull-right">
                <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/main/packages/blog/data/2021/2021-06-14-doctrine-annotations-and-attributes-living-together-in-peace.md">Found a typo? Edit me</a>
            </div>

            <time datetime="2021-06-Mon" class="text-muted">
                2021-06-14
            </time>

            
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>In previous post <a href="/blog/how-to-refactor-custom-doctrine-annotations-to-attributes">How to Refactor Custom Doctrine Annotations to Attributes</a> we looked on how to make the <code>@annotation</code> to <code>#[Attribute]</code> transition.
<br><br>
Last week, we started refactoring in <a href="https://www.startupjobs.cz/startup/scrumworks-s-r-o">my favorite long-term project</a>, and we came to a challenging situation. When we started to move all annotations to attributes at once, we lost control over the results. It was also impossible because 3rd party annotations were not attributes ready.
<br><br>
We had to <strong>support annotations and attributes at the same time</strong>. Do you have plenty of custom annotations yourself? In this post, you'll learn to build a bridge with both annotations and attributes on board.</p>
                </div>
            </div>

            <blockquote class="blockquote text-center">
    "United we stand,<br>
    Divided we fall"
</blockquote>
<h2 id="Safety-First">Safety First</h2>
<p>Before we start, we'll make sure we have <a href="/blog/2020/01/13/why-is-first-instant-feedback-crucial-to-developers">instant feedback</a> about code. We'll prepare a special kind of test designed for refactoring, where we need 2 mechanism to work at once - <a href="/blog/how-to-make-upgrade-safe-with-bridge-testing">a bridge testing</a>. In linked post we'll build a test that we use here, so if you're coding with me, be sure to read it first.</p>
<h2 id="Teaching-Annotation-Attributes">Teaching Annotation Attributes</h2>
<p>We already know the first steps <a href="/blog/how-to-refactor-custom-doctrine-annotations-to-attributes">from previous post</a> - add <code>#[Attribute]</code>:</p>
<pre><code class="language-php">/**
 * @Annotation()
 */
#[Attribute]
class AttentionPrice
{
    // ...

    public function __construct(array $values)
    {
        $this-&gt;amount = $values['amount'];
    }

    // ...
}</code></pre>
<p>The problem is that annotation requires an array in the constructor - <code>array $values</code>.
But attributes accept specific value:</p>
<pre><code class="language-php">    /**
     * @AttentionPrice(1000) // array with int
     */
    #[AttentionPrice(1000)] // int
    public $publicProperty;</code></pre>
<p><br></p>
<p>What can we do about different construction needs?</p>
<h3 id="2-Different-Classes">2 Different Classes?</h3>
<p>An annotation class with <code>array</code> contract:</p>
<pre><code class="language-php">/**
 * @Annotation()
 */
class AttentionPrice
{
    public function __construct(array $values)
    {
        // ...
    }
}</code></pre>
<p>And an attribute class with <code>int</code> contract:</p>
<pre><code class="language-php">#[Attribute]
class AttentionPrice
{
    public function __construct(int $amount)
    {
        // ...
    }
}</code></pre>
<h3 id="2-Constructors">2 Constructors?</h3>
<pre><code class="language-php">    public function __construct($values)
    {
        // annotatoin
        if (is_array($values)) {
            $this-&gt;amount = $values['amount'];
        // attribute
        } elseif (is_int($values)) {
            $this-&gt;amount = $values;
        } else {
            // exception
        }
    }</code></pre>
<p><br></p>
<p>Try both options, and you'll soon see that <strong>they both smell</strong>:</p>
<ul>
<li>First is nice and clean but gives you extra work with duplicated classes ❌</li>
<li>Second is a headache to write and read. A that's only one value, imagine there are 2 or 3 values ❌</li>
</ul>
<p>Hmm, what can we do now?</p>
<p><br></p>
<h2 id="at-NamedArgumentConstructor-to-the-Rescue"><code>@NamedArgumentConstructor</code> to the Rescue</h2>
<p>We're lucky, <code>doctrine/annotations</code> got us covered since <code>1.12</code>. I've learned this trick from <a href="https://github.com/koriym/Koriym.Attributes">Koriym</a> - thanks!</p>
<pre><code class="language-diff">+use Doctrine\Common\Annotations\NamedArgumentConstructor;

 /**
  * @Annotation()
+ * @NamedArgumentConstructor()
  */
+#[Attribute]
 class AttentionPrice
 {
     private int $amount;

-    public function __construct(array $values)
+    public function __construct(int $amount)
     {
         $this-&gt;amount = $amount;
     }

     // ...
 }</code></pre>
<p>Thanks to the <code>@NamedArgumentConstructor</code>, the constructors are now the same for both annotation and attribute ✅</p>
<p><br></p>
<p>Big thanks to Alexander M. Turek, who <a href="https://github.com/doctrine/annotations/pull/391">contributed this feature</a> for <code>doctrine/annotations</code> and Vincent who added support for <a href="https://github.com/doctrine/annotations/pull/402">default value</a> unwrap.</p>
<p><br></p>
<p>Now we can use both annotation and attributes in our code with the same result:</p>
<pre><code class="language-php">    /**
     * @AttentionPrice(1000) // int
     */
    #[AttentionPrice(1000)] // int
    public $publicProperty;
</code></pre>
<p><br></p>
<p>Happy coding!</p>

            <br>


            <div class="card mt-5 border-warning">
                <div class="card-body text-center mt-2">
                    <p>
                        Have you find this post useful? <strong>Do you want more?</strong>
                    </p>
                    <p>
                        Follow me on <a href="https://twitter.com/votrubaT">Twitter</a>, <a href="/rss.xml">RSS</a> or support me on <a href="https://github.com/sponsors/TomasVotruba">GitHub Sponsors</a>.
                    </p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body text-white bg-success text-center">
                                            <a href="/blog/why-should-we-talk-about-our-mitakes-in-php-community" class="d-block">
                            <div>
                                Read next → <strong>Why Should We Talk about Our Mistakes in PHP Community?</strong>
                            </div>
                        </a>
                                    </div>
            </div>

            <br>
            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />
        <script src="/assets/prism/prism.js"></script>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

        <script type="text/javascript">
            // @see https://stackoverflow.com/a/30776817/1348344
            var date = new Date();
            // display every 2nd hour, not to spam users
            if (date.getHours() % 2 === 1) {
                document.querySelector('.book-banner').style.display = 'visible';
            } else {
                document.querySelector('.book-banner').style.display = 'none';
            }
        </script>
    </body>
</html>
