<!DOCTYPE html>
<html lang="en">
    <head>
        <title>What if We Remove Strings from Symfony Extension Configuration | Tomas Votruba</title>
<meta charset="utf-8">
<meta name="robots" content="index, follow">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:creator" content="@votrubaT"/>

    <meta property="og:title" content="What if We Remove Strings from Symfony Extension Configuration" />
    <meta property="og:url" content="https://tomasvotruba.com/blog/2020/08/24/what-if-we-remove-strings-from-symfony-extension-configuratoin" />

            <meta property="og:image" content="https://tomasvotruba.com/assets/images/posts/2020/remove_string_extension.png?cache=123" />
        <meta name="twitter:image" content="https://tomasvotruba.com/assets/images/posts/2020/remove_string_extension.png?cache=123"/>
    
<link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">


<link rel="stylesheet" rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:700&amp;display=swap" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" media="print" onload="this.media='all'">

<link href="/assets/css/style.css?1125410763" rel="stylesheet" type="text/css" />

                <meta name="description" property="og:description" content="You can tell I&#039;m a [huge fan PHP configs](/blog/2020/07/16/10-cool-features-you-get-after-switching-from-yaml-to-php-configs/). To be honest, I don&#039;t care; I&#039;m just extremely lazy.

Yet, my laziness got me itching when I see **configuration of extensions**.
" />
    </head>

    <body>
        <!-- post_id: 275 -->
        <div id="menu">
    <div class="container-fluid">
        <a href="/">Home</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/blog">Blog</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/book/the-power-of-automated-refactoring">Book</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/trainings">Trainings</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/contact">Contact</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/about-me">About Me</a>
        <span class="pl-2 pr-2">•</span>

        <a href="https://twitter.com/votrubaT" target="blank">Twitter</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/rss.xml" target="blank">RSS</a>
    </div>
</div>

        <div class="container-fluid post" id="content">
            <div class="text-center book-banner">
                <a href="https://leanpub.com/rector-the-power-of-automated-refactoring" target="blank" class="text-center">
                    <img src="/assets/images/banner-rector-book.png" class="mb-2 ml-auto mr-auto rounded " style="max-height: 5em" alt="">
                </a>
            </div>

            <h1>What if We Remove Strings from Symfony Extension Configuration</h1>

            <div class="pull-right">
                <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/main/packages/blog/data/2020/2020-08-24-what-if-we-remove-strings-from-symfony-extension-configuratoin.md">Found a typo? Edit me</a>
            </div>

            <time datetime="2020-08-Mon" class="text-muted">
                2020-08-24
            </time>

            
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>You can tell I'm a <a href="/blog/2020/07/16/10-cool-features-you-get-after-switching-from-yaml-to-php-configs/">huge fan PHP configs</a>. To be honest, I don't care; I'm just extremely lazy.
<br><br>
Yet, my laziness got me itching when I see <strong>configuration of extensions</strong>.</p>
                </div>
            </div>

            <p>I like the service configuration provided by Symfony. Typo-proof, everything is autocompleted by IDE, hard to put the wrong argument or make a typo.</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();

    $services-&gt;defaults()
        -&gt;autowire()
        -&gt;autoconfigure()
        -&gt;public();

    $services-&gt;set(SomeService::class)
        -&gt;args(['some', 'value']);
};</code></pre>
<p>This config is a joy to use in IDE. Only the values that can change, like class name or arg value, are strings. <strong>Everything else is API of the modeling tool</strong>, here <code>ContainerConfigurator</code> from Symfony. This code is a state of Art.</p>
<p><br></p>
<p>But that's not everything we have in our configs. Let's look at a common extension you can found in <code>config/packages/doctrine.php</code> in your Symfony project:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $containerConfigurator-&gt;extension('break', [
        'dbal' =&gt; [
            'host' =&gt; '%env(DATABASE_HOST)%',
            'user' =&gt; '%env(DATABASE_USER)%',
            'password' =&gt; '%env(DATABASE_PASS)%',
        ],
    ]);
};</code></pre>
<p>How do you like this?</p>
<p>I'll share you secret deep from my traumatized mind - this is what I see:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $containerConfigurator-&gt;extension('error', [
        'bug' =&gt; [
            'typo' =&gt; ' _missing',
            ' problem ' =&gt; 'sorry_renamed',
            'forgotten' =&gt; 'FALSE POSITIVE',
        ],
    ]);
};</code></pre>
<blockquote class="blockquote text-center">
    "Anything that can go wrong, will go wrong.<br>
    In the worst possible order. When you least expect it."
</blockquote>
<p><br></p>
<h2 id="How-can-we-make-Extension-as-Good-as-Service-Registration">How can we make Extension as Good as Service Registration?</h2>
<p>If we look at <a href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/DependencyInjection/Loader/Configurator/ContainerConfigurator.php"><code>ContainerConfigurator</code></a>, it inherits from abstract class <a href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/DependencyInjection/Loader/Configurator/AbstractConfigurator.php"><code>AbstractConfigurator</code></a>.</p>
<p>What if we use per-extension Configurator... e.g. <code>DoctrineConfigurator</code>?</p>
<pre><code class="language-php">return static function (DoctrineConfigurator $doctrineConfigurator): void {
    $doctrineConfigurator-&gt;dbal()
        -&gt;user('%env(DATABASE_USER)%')
        -&gt;password('%env(DATABASE_PASS)%');
};</code></pre>
<p>Slightly less space fo bug... Still, I managed to split one there. It can cause a &quot;connection to database rejected&quot; error.</p>
<h2 id="Environment-Variables-for-Everyone">Environment Variables for Everyone</h2>
<p>Have you spotted it?</p>
<pre><code class="language-diff"> return static function (DoctrineConfigurator $doctrineConfigurator): void {
     $doctrineConfigurator-&gt;dbal()
         -&gt;user('%env(DATABASE_USER)%')
-        -&gt;password('%env(DATABASE_PASS)%');
+        -&gt;password('%env(DATABASE_PASSWORD)%');
};</code></pre>
<ul>
<li>How could we prevent this?</li>
<li>How can one know the conventions of database env values without studying them?</li>
<li>What are other ENV values for the database we can use?</li>
</ul>
<p><a href="https://github.com/JanMikes">Jan Mikes</a> shared with me an interesting idea that <strong>removes this problem</strong>:</p>
<pre><code class="language-php">use DoctrineEnvs;

return static function (DoctrineConfigurator $doctrineConfigurator): void {
    $doctrineConfigurator-&gt;dbal()
        -&gt;user('%env(' . DoctrineEnvs::DATABASE_PASSWORD . ')%')
        -&gt;password('%env(' . DoctrineEnvs::DATABASE_PASSWORD . ')%');
};</code></pre>
<p><br></p>
<p>That seems like too much clutter... can we make it simpler and safes?</p>
<pre><code class="language-php">use DoctrineEnvParams;

return static function (DoctrineConfigurator $doctrineConfigurator): void {
    $doctrineConfigurator-&gt;dbal()
        -&gt;user(DoctrineEnvParams::DATABASE_PASSWORD)
        -&gt;password(DoctrineEnvParams::DATABASE_PASSWORD);
};</code></pre>
<p><br></p>
<p>In what cases is this the most useful?</p>
<p><br></p>
<p>Common key for the &quot;database name&quot; is never the same across database platforms and language integration. Imagine the saved hours and lifes on Docker/Doctrine/CI typos:</p>
<pre><code class="language-php">return static function (DoctrineConfigurator $doctrineConfigurator): void {
    $doctrineConfigurator-&gt;dbal()
        -&gt;database('%env(DATABASE_NAME)%');
        // or...?
        -&gt;database('%env(DATABASE_DBNAME)%');
        // or...?
        -&gt;database('%env(DATABASE_DATABASE)%');
        // or...?
        -&gt;database('%env(DB_NAME)%');
};</code></pre>
<p>Just don't care and use IDE autocomplete:</p>
<pre><code class="language-php">use DoctrineEnvParams;

return static function (DoctrineConfigurator $doctrineConfigurator): void {
    $doctrineConfigurator-&gt;dbal()
        -&gt;database(DoctrineEnvParams::DATABASE_NAME);
};</code></pre>
<h2 id="What-are-Benefits-over-Array-configuration">What are Benefits over Array configuration?</h2>
<ul>
<li><strong>the parameter is validated by standard PHP</strong> - if you put database name with <code>int</code>, the PHP throws an exception right on that line</li>
</ul>
<h3 id="Focus-on-Config-without-Jumping-Elsewhere">Focus on Config without Jumping Elsewhere</h3>
<ul>
<li>the IDE autocompletes method names - <strong>no need to look into configuration</strong>, what can be used - you can stay focused on your code</li>
<li>the IDE autocompletes ENV names - <strong>no need to look into configs or extension on Github</strong> - you can stay focused on your code</li>
</ul>
<h3 id="Narrow-Context">Narrow Context</h3>
<ul>
<li>context-aware autocomplete - when you type <code>dbal()</code> or <code>orm()</code> you only get methods, that are relevant in that context</li>
</ul>
<pre><code class="language-php">return static function (DoctrineConfigurator $doctrineConfigurator): void {
    $doctrineConfigurator-&gt;dbal()
        -&gt;... // dbal specific methods

    $doctrineConfigurator-&gt;orm()
        -&gt;... // orm specific methods
};</code></pre>
<ul>
<li>we can also go to a more narrow scope, like single <code>connection()</code></li>
</ul>
<pre><code class="language-php">return static function (DoctrineConfigurator $doctrineConfigurator): void {
    $doctrineConfigurator-&gt;dbal()
        -&gt;conntection()
            -&gt;... // only connection specific methods
};</code></pre>
<p>The <code>DoctrineConfigurator</code> with specific <code>methods()</code> and <code>Constant::KEYS</code> is one way to get rid of all string possible.</p>
<h2 id="What-about-Value-Objects">What about Value Objects?</h2>
<p>With PHP 8.0 to be released in 11/2020 will come <a href="https://stitcher.io/blog/php-8-named-arguments">named arguments</a>. With them, the IDE autocomplete becomes more powerful. If we combine it along with <code>__construct</code> validation in value objects, we have another solid way to add parameters:</p>
<pre><code class="language-php">return static function (DoctrineConfigurator $doctrineConfigurator): void {
    $doctrineConfigurator-&gt;dbal()
        -&gt;connection(new DbalConnection(
            DoctrineEnvParams::DATABASE_USER,
            DoctrineEnvParams::DATABASE_PASSWORD,
            DoctrineEnvParams::DATABASE_NAME
        ));
};</code></pre>
<p>Compared to method() autocomplete, we can also see <strong>what arguments are required</strong> and which optional:</p>
<pre><code class="language-php">// using PHP 8.0 syntax with constructor promotion

final class DbalConnection
{
    public function __construct(
        private string $user,
        private string $password,
        private string $database,
        private ?string $version = null
    ) {
        // ...
    }
}</code></pre>
<h2 id="Instant-Feedback-Loop">Instant Feedback Loop</h2>
<p>If we get rid of strings that can go wrong, we've made a big shift <a href="/blog/2020/03/02/we-do-not-need-senior-developers-we-need-senior-code-bases/">to senior codebase</a>.</p>
<p>Another huge benefit for programmers <strong>is focus - along with <a href="/blog/2020/01/13/why-is-first-instant-feedback-crucial-to-developers/">instant feedback loop</a></strong>.</p>
<blockquote class="blockquote text-center">
    "If something goes wrong, I want to know it the moment it went wrong"
</blockquote>
<ul>
<li>
<p>If we put the wrong password to the database, the project works on the localhost server, the tests are passing, and CI is green, our feedback loop is slow, and we have to speed it up.</p>
</li>
<li>
<p>If the project crashes on the localhost server and tests are failing, our feedback look is fast.</p>
</li>
</ul>
<p><br></p>
<p><strong>How is instant feedback loop related to value objects and require arguments?</strong> Good question!</p>
<p>If we put user and password but forget the database name, the application will crash <strong>when</strong> it's connected:</p>
<pre><code class="language-php">use DoctrineEnvParams;

return static function (DoctrineConfigurator $doctrineConfigurator): void {
    $doctrineConfigurator-&gt;dbal()
        -&gt;user(DoctrineEnvParams::DATABASE_USER)
        -&gt;password(DoctrineEnvParams::DATABASE_PASSWORD);
};</code></pre>
<p>That's very late!</p>
<p>With value objects, we'll get the &quot;missing 3rd argument&quot; error:</p>
<pre><code class="language-php">return static function (DoctrineConfigurator $doctrineConfigurator): void {
    $doctrineConfigurator-&gt;dbal()
        -&gt;connection(new DbalConnection(
            DoctrineEnvParams::DATABASE_USER,
            DoctrineEnvParams::DATABASE_PASSWORD
            // boom :(
        ));
};</code></pre>
<p><strong>That's fast feedback loop!</strong></p>
<p><br></p>
<p>These were few ideas, how to <strong>get rid of strings</strong> in <code>/config</code> directory, so we can instead focus on something we love - algorithms, coding, and maybe a coffee cup!</p>
<p><br></p>
<p>I bet you can't come up with a better way to do this... share in comments to prove me wrong ;)</p>
<p><br></p>
<p>Happy coding!</p>

            <br>


            <div class="card mt-5 border-warning">
                <div class="card-body text-center mt-2">
                    <p>
                        Have you find this post useful? <strong>Do you want more?</strong>
                    </p>
                    <p>
                        Follow me on <a href="https://twitter.com/votrubaT">Twitter</a>, <a href="/rss.xml">RSS</a> or support me on <a href="https://github.com/sponsors/TomasVotruba">GitHub Sponsors</a>.
                    </p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body text-white bg-success text-center">
                                            <a href="/blog/2020/08/17/how-to-get-rid-of-magic-static-and-chaos-from-latte-filters" class="d-block">
                            <div>
                                Read next → <strong>How to Get Rid of Magic, Static and Chaos from Latte Filters</strong>
                            </div>
                        </a>
                                    </div>
            </div>

            <br>
            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />
        <script src="/assets/prism/prism.js"></script>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

        <script type="text/javascript">
            // @see https://stackoverflow.com/a/30776817/1348344
            var date = new Date();
            // display every 2nd hour, not to spam users
            if (date.getHours() % 2 === 1) {
                document.querySelector('.book-banner').style.display = 'visible';
            } else {
                document.querySelector('.book-banner').style.display = 'none';
            }
        </script>
    </body>
</html>
