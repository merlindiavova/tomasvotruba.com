<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Don&#039;t Show Your Privates to Public | Tomas Votruba</title>
<meta charset="utf-8">
<meta name="robots" content="index, follow">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:creator" content="@votrubaT"/>

<meta property="og:image" content="/assets/images/tomas_votruba.jpg"/>

<link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">


<link rel="stylesheet" rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:700&amp;display=swap" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" media="print" onload="this.media='all'">

<link href="/assets/css/style.css?1699248242" rel="stylesheet" type="text/css" />

                <meta property="og:title" content="Don&#039;t Show Your Privates to Public" />
        <meta property="og:url" content="https://tomasvotruba.com/blog/2020/03/30/dont-show-your-privates-to-public" />
        <meta name="description" property="og:description" content="With typed properties in PHP 7.4, there comes **a natural tendency for using properties as public**. The type check is already there, right? It&#039;s a dangerous path that opens the door to static code with public properties everywhere, that is asking for a change in any place.



But is that ok to show privates to the public?
" />

                    <meta property="og:image" content="https://tomasvotruba.com/assets/images/posts/2020/privates_meme.jpg" />
            <meta name="twitter:card" content="summary_large_image"/>
            </head>

    <body>
        <!-- post_id: 245 -->
        <div id="menu">
    <div class="container-fluid">
        <a href="/">Home</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/blog">Blog</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/book/the-power-of-automated-refactoring">Book</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/trainings">Trainings</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/contact">Contact</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/about-me">About Me</a>
        <span class="pl-2 pr-2">•</span>

        <a href="https://twitter.com/votrubaT" target="blank">Twitter</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/rss.xml" target="blank">RSS</a>
    </div>
</div>

        <div class="container-fluid post" id="content">
            <div class="text-center book-banner">
                <a href="https://leanpub.com/rector-the-power-of-automated-refactoring" target="blank" class="text-center">
                    <img src="/assets/images/banner-rector-book.png" class="mb-2 ml-auto mr-auto rounded " style="max-height: 5em" alt="">
                </a>
            </div>

            <h1>Don't Show Your Privates to Public</h1>

            <div class="pull-right">
                <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/main/packages/blog/data/2020/2020-03-30-dont-show-your-privates-to-public.md">Found a typo? Edit me</a>
            </div>

            <time datetime="2020-03-Mon" class="text-muted">
                2020-03-30
            </time>

            
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>With typed properties in PHP 7.4, there comes <strong>a natural tendency for using properties as public</strong>. The type check is already there, right? It's a dangerous path that opens the door to static code with public properties everywhere, that is asking for a change in any place.
<br>
<br></p>
<p>But is that ok to show privates to the public?</p>
                </div>
            </div>

            <p>Last week you probably spotted <strong><a href="https://wiki.php.net/rfc/constructor_promotion">RFC: Constructor Promotion</a></strong> proposed by my favorite mentor <a href="https://github.com/nikic">Nikita Popov</a>. This RFC counters <em>public property by default</em> approach and <strong>reduces the redundant code at the same time</strong>.</p>
<p><br></p>
<p>Another counter point for public properties or methods nailed <a href="https://thephp.cc/company/consultants/stefan-priebsch">Stefan Priebsch</a>:</p>
<img src="/assets/images/posts/2020/privates_meme.jpg" class="img-thumbnail">
<h2 id="How-Many-Public-Methods-Has-Your-Project">How Many Public Methods Has Your Project?</h2>
<p>That meme had just 1 public method. But what about real projects?</p>
<p>To get <strong>real numbers from a real project</strong>, I run <a href="https://matthiasnoback.nl/2019/09/using-phploc-for-quick-code-quality-estimation-part-1">phploc</a> to measure size of <a href="https://github.com/rectorphp/rector">Rector's code</a>.</p>
<pre><code class="language-bash">phploc src packages rules --exclude tests</code></pre>
<p>These are <strong>the results</strong>:</p>
<pre><code class="language-bash">Size
  Non-Comment Lines of Code (NCLOC)              99033 (85.46%)

Structure
  Methods                                         5185
    Visibility
      Public Methods                              3516 (67.81%)</code></pre>
<p><br></p>
<p>Let's put 100 children in one square:</p>
<img src="/assets/images/posts/2020/privates_100_children.jpg" class="img-thumbnail">
<p>This <strong>is 3 500 children</strong>:</p>
<img src="/assets/images/posts/2020/privates_3500_children.jpg" class="img-thumbnail">
<p>There is <a href="https://github.com/rectorphp/rector/blob/master/docs/rector_rules_overview.md">~480 Rector rules</a>, each has 3 public methods required by interface contract. That's 1 500 public contract methods. Even if we remove thos, 3 500 - 1 500, we still have <strong>over 2 000 public methods</strong>:</p>
<img src="/assets/images/posts/2020/privates_2000_children.jpg" class="img-thumbnail">
<p>Good luck with getting all your 2 000 children to university... or bed ... or make them breakfast for them... for one day. No pressure, right?</p>
<h2 id="How-to-Take-Care-for-as-Few-Children-as-Possible">How to Take Care for as Few Children as Possible?</h2>
<p>We want to reduce the number of public methods to a minimum. How?</p>
<h3 id="1-A-Method-by-Method-Human-Refactoring">1. A Method by Method Human Refactoring</h3>
<p>We can go for a method by method refactoring with careful analysis if the method should be public or private and how we can change it to private. <strong>It takes time, patience, attention, human performance and doesn't scale on massive projects.</strong> That's way too expensive.</p>
<p>❌</p>
<p>What simpler way can we apply today on an any-sized project? What low hanging fruit can we focus on?</p>
<h3 id="2-Fake-Public-Method-Detection">2. Fake Public Method Detection</h3>
<p>What is <em>fake public</em> method, property, or constant?</p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

final class SomeController
{
    /**
     * @Route(path="/")
     */
    public function homepage()
    {
        return $this-&gt;prepareData();
    }

    public function prepareData(): array
    {
        return ['status' =&gt; 'quarantine'];
    }
}</code></pre>
<p>Can you see it?</p>
<pre><code class="language-diff">+public function prepareData(): array
-private function prepareData(): array</code></pre>
<p>✅</p>
<p><br></p>
<p>Same applies for constants and properties, that is <strong>used only locally in the class they're defined in</strong>:</p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

final class AirCleaner
{
    public const NAME = 'cleaner';

    public function getName()
    {
        return self::NAME;
    }
}</code></pre>
<pre><code class="language-diff">-public const NAME = 'cleaner';
+private const NAME = 'cleaner';</code></pre>
<p>✅</p>
<p>The most common <em>false publics</em> are constants because they're <a href="https://wiki.php.net/rfc/class_const_visibility">last that got visibility in PHP 7.1</a>.</p>
<h2 id="Why-Should-We-Care-about-Privatization">Why Should We Care about Privatization?</h2>
<p>&quot;Nice intellectual exercise, Tom, but nothing more,&quot; you may think, and close this post and go back to your quarantine work.</p>
<p>But remember our children:</p>
<blockquote class="blockquote text-center">
    A public method is like a child: Once you've written it,<br>
    you are going to maintain it for the rest of its life.
</blockquote>
<p>What happens if we don't care about it? Well, <strong><code>public</code> element is designed to be used somewhere else.</strong></p>
<p>Same way <code>static</code> method is a method to be used everywhere (and <a href="/blog/2018/04/26/how-i-got-into-static-trap-and-made-fool-of-myself">then slowly kill you</a>/).</p>
<p><br></p>
<p>It's easy to spot now because we focus on ten lines of code, we knew that's a controller method only, and that's a clear miss-use. But in the real world, <strong>we don't have so much time to think about 10 lines of code</strong>.</p>
<p><br></p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">10 lines of code = 10 issues.<br><br>500 lines of code = "looks fine."<br><br>Code reviews.</p>— I Am Devloper (@iamdevloper) <a href="https://twitter.com/iamdevloper/status/397664295875805184?ref_src=twsrc%5Etfw">November 5, 2013</a></blockquote>
<p><br></p>
<p>Limited attention span is one of the reasons. We had plenty of such potential <em>legacy back doors</em> in Rector:</p>
<img src="/assets/images/posts/2020/privates_sample.png" class="img-thumbnail">
<h2 id="Unused-Method">Unused Method</h2>
<p>Another reason is that <strong>the method is completely unused</strong>, but PHPStorm won't tell you because it is <code>public</code>. When we turned this method into <code>private</code>, we saw it's unused, and we got rid of it:</p>
<img src="/assets/images/posts/2020/privates_sample_2.png" class="img-thumbnail">
<h2 id="Not-Used-Method">Not-Used Method</h2>
<p>The effect of privatization is surprising. Take this case:</p>
<img src="/assets/images/posts/2020/privates_sample_3.png" class="img-thumbnail">
<p>How can the privatization of methods lead to more code? Easily. The method was <code>public</code>, but never used. After Rector run it was <code>private</code>, but never used and then removed... and that could work.</p>
<p>Actually, that was not a feature, it was a bug. <strong>This method should have been used many months ago.</strong> So we used it in the right place, the feature was complete, and potential future bug.</p>
<p><br></p>
<p>Do you want to know all the possible code changes?</p>
<p><a href="https://github.com/rectorphp/rector/pull/3084/commits/626287ec76ed16d15136115e1510b2154c2712a9" class="btn btn-dark btn-sm">
See pull-request
</a></p>
<h2 id="In-CI-pipeline-or-Won-t-Happen">In CI pipeline, or Won't Happen</h2>
<p>What now? Go to your code and check method one by one clicking on them in PHPStorm to <em>Find Usages</em>, if they're used somewhere else or <em>false public</em> and should be private. It will make your code much more robust and senior...</p>
<p><em>Just kidding</em>. Let Rector handle it with <code>PRIVATIZATION</code> set:</p>
<pre><code class="language-php">use Rector\Set\ValueObject\SetList;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;import(SetList::PRIVATIZATION);
};</code></pre>
<pre><code class="language-bash">vendor/bin/rector process src</code></pre>
<p>It has now 4 rules:</p>
<ul>
<li><strong>privatize local-only constant</strong></li>
<li><strong>privatize local-only property</strong></li>
<li><strong>privatize local-only method</strong></li>
<li><strong>privatize local getter to local property</strong></li>
</ul>
<p>Do you have an idea for another privatization rule? <a href="https://github.com/rectorphp/rector/issues/new?template=2_Feature_request.md">Let us know on GitHub</a>.</p>
<p>Stay lazy and alive!</p>
<p><br></p>
<p>Happy coding!</p>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

            <br>


            <div class="card mt-5 border-warning">
                <div class="card-body text-center mt-2">
                    <p>
                        Have you find this post useful? <strong>Do you want more?</strong>
                    </p>
                    <p>
                        Follow me on <a href="https://twitter.com/votrubaT">Twitter</a>, <a href="/rss.xml">RSS</a> or support me on <a href="https://github.com/sponsors/TomasVotruba">GitHub Sponsors</a>.
                    </p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body text-white bg-success text-center">
                                            <a href="/blog/2020/03/23/doctrine-entity-typed-properties-with-php74" class="d-block">
                            <div>
                                Read next → <strong>Doctrine Entity Typed Properties With PHP 7.4</strong>
                            </div>
                        </a>
                                    </div>
            </div>

            <br>
            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />
        <script src="/assets/prism/prism.js"></script>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

        <script type="text/javascript">
            // @see https://stackoverflow.com/a/30776817/1348344
            var date = new Date();
            // display every 2nd hour, not to spam users
            if (date.getHours() % 2 === 1) {
                document.querySelector('.book-banner').style.display = 'visible';
            } else {
                document.querySelector('.book-banner').style.display = 'none';
            }
        </script>
    </body>
</html>
