<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Doctrine Entity Typed Properties With PHP 7.4 | Tomas Votruba</title>
<meta charset="utf-8">
<meta name="robots" content="index, follow">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:creator" content="@votrubaT"/>

<meta property="og:image" content="/assets/images/tomas_votruba.jpg"/>

<link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">


<link rel="stylesheet" rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:700&amp;display=swap" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" media="print" onload="this.media='all'">

<link href="/assets/css/style.css?589021457" rel="stylesheet" type="text/css" />

                <meta property="og:title" content="Doctrine Entity Typed Properties With PHP 7.4" />
        <meta property="og:url" content="https://tomasvotruba.com/blog/2020/03/23/doctrine-entity-typed-properties-with-php74" />
        <meta name="description" property="og:description" content="Recently we&#039;ve upgraded our [Czech PHP community website](https://pehapkari.cz) to PHP 7.4. As a side effect, it broke most of our entities.
Do you love how making language more strict reveals weak points in your code just by using it?


Today we&#039;ll look at **the impact of typed properties on weak points of Doctrine entities and how to solve them**.
" />

                    <meta property="og:image" content="https://tomasvotruba.com/assets/images/posts/2020/typed_doctrine_properties_collection.png" />
            <meta name="twitter:card" content="summary_large_image"/>
            </head>

    <body>
        <!-- post_id: 244 -->
        <div id="menu">
    <div class="container-fluid">
        <a href="/">Home</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/blog">Blog</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/book/the-power-of-automated-refactoring">Book</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/trainings">Trainings</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/contact">Contact</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/about-me">About Me</a>
        <span class="pl-2 pr-2">•</span>

        <a href="https://twitter.com/votrubaT" target="blank">Twitter</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/rss.xml" target="blank">RSS</a>
    </div>
</div>

        <div class="container-fluid post" id="content">
            <div class="text-center book-banner">
                <a href="https://leanpub.com/rector-the-power-of-automated-refactoring" target="blank" class="text-center">
                    <img src="/assets/images/banner-rector-book.png" class="mb-2 ml-auto mr-auto rounded " style="max-height: 5em" alt="">
                </a>
            </div>

            <h1>Doctrine Entity Typed Properties With PHP 7.4</h1>

            <div class="pull-right">
                <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/main/packages/blog/data/2020/2020-03-23-doctrine-entity-typed-properties-with-php74.md">Found a typo? Edit me</a>
            </div>

            <time datetime="2020-03-Mon" class="text-muted">
                2020-03-23
            </time>

            
                            <div class="card border-success mt-4">
                    <div class="card-header text-white bg-success">
                        This post was updated at November 2020 with fresh know-how.
                        <br>
                        <strong>What is new?</strong>
                    </div>
                                            <div class="card-body pb-2">
                            <p>Switch from deprecated <code>--set</code> option to <code>rector.php</code> config.
Updated with <strong>PHPStorm and PHPStan friendly</strong> <code>Collection</code> syntax and <a href="https://github.com/rectorphp/rector/pull/4442">Rector rule</a> that handles the change for you.</p>
                        </div>
                                    </div>

                <br>
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>Recently we've upgraded our <a href="https://pehapkari.cz">Czech PHP community website</a> to PHP 7.4. As a side effect, it broke most of our entities.
Do you love how making language more strict reveals weak points in your code just by using it?
<br>
<br>
Today we'll look at <strong>the impact of typed properties on weak points of Doctrine entities and how to solve them</strong>.</p>
                </div>
            </div>

            <h2 id="The-Collections">The Collections</h2>
<p>In the Czech PHP community, we have skilled trainers that share their knowledge with others on training. We help them to share the knowledge by handling the tedious organization processes for them and let them enjoy the training day itself.</p>
<p>Each trainer has many trainings, so the <code>Trainer</code> entity looks like this in PHP 7.3-:</p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Entity;

use Doctrine\Common\Collections\Collection;
use Doctrine\ORM\Mapping as ORM;

/**
 * @ORM\Entity
 */
class Trainer
{
    /**
     * @ORM\OneToMany(targetEntity=Training::class, mappedBy="trainer")
     * @var Collection|Trainer[]
     */
    private $trainings = [];

    /**
     * @param Collection&lt;int, Training&gt;|Training[] $collection
     */
    public function setTrainings(array $collection): void
    {
        $this-&gt;trainings = $collection;
    }

    /**
     * @return Collection&lt;int, Training&gt;|Training[]
     */
    public function getTrainings(): iterable
    {
        return $this-&gt;trainings;
    }
}</code></pre>
<p>What can we say about this code?</p>
<ul>
<li>works in PHP 7.4</li>
<li>provides IDE enough information about types for autocomplete</li>
<li>makes PHPStan happy with types</li>
<li>...broke with PHP 7.4 typed properties :)</li>
</ul>
<p>How do we <strong>add property types without breaking everything</strong>?</p>
<h2 id="1-The-Property">1. The Property</h2>
<p>In PHP 7.4, <strong>the property is the king</strong> - the rest of the code has to respect the type, and it's the default value. Let's start with that.</p>
<pre><code class="language-diff"> /**
  * @ORM\OneToMany(targetEntity=Training::class, mappedBy="trainer")
  * @var Collection|Trainer[]
  */
-private $trainings = [];
+private array $trainings = [];
+private iterable $trainings = [];
+private Collection $trainings = [];</code></pre>
<p>What is the type here?</p>
<ul>
<li>1) <code>array $trainings = [];</code></li>
<li>2) <code>iterable $trainings = [];</code></li>
<li>3) <code>Collection $trainings = [];</code></li>
</ul>
<p>Pick one...</p>
<p><br>
<br>
<br></p>
<pre><code class="language-diff"> /**
  * @ORM\OneToMany(targetEntity=Training::class, mappedBy="trainer")
  * @var Collection&lt;int, Trainer&gt;|Trainer[]
  */
-private $trainings = [];
+private Collection $trainings = [];</code></pre>
<p>This one worked the best (= code worked).</p>
<p>But PHP 7.4 now complains that the <code>Collection</code> object cannot be <code>[]</code> by default.</p>
<pre><code class="language-diff"> /**
  * @ORM\OneToMany(targetEntity=Training::class, mappedBy="trainer")
  * @var Collection&lt;int, Trainer&gt;|Trainer[]
  */
-private Collection $trainings = [];
+private Collection $trainings;</code></pre>
<p>But PHP 7.4 now complains that it's <code>null</code> by default, so it has to nullable.</p>
<blockquote class="blockquote text-center">
If it's not enforced, nobody cares.
</blockquote>
<p>Here is where <em>best practices</em> become defaults. Do you know the &quot;<a href="https://www.doctrine-project.org/projects/doctrine-orm/en/2.7/reference/best-practices.html#initialize-collections-in-the-constructor">initialize collections in the constructor</a>&quot; best practice?</p>
<img src="/assets/images/posts/2020/typed_doctrine_properties_best_practise.png" class="img-thumbnail">
<p>This was an optional improvement to help Doctrine work in a more realiable way. Well, it <em>was</em>.
Now we <strong>have to use it</strong> to make our code work:</p>
<pre><code class="language-diff"> &lt;?php

 declare(strict_types=1);

 namespace App\Entity;

 use Doctrine\Common\Collections\ArrayCollection;
+use Doctrine\Common\Collections\Collection;
 use Doctrine\ORM\Mapping as ORM;

 /**
  * @ORM\Entity
  */
 class Trainer
 {
     // ...

+    public function __construct()
+    {
+        $this-&gt;trainings = new ArrayCollection();
+    }

     // ...
 }</code></pre>
<p>All right, we have the correct type, it's initialized in the constructor.</p>
<p>Our property is ready!</p>
<p><br></p>
<h2 id="2-Getter-Method">2. Getter Method?</h2>
<pre><code class="language-php">&lt;?php

// ...

/**
 * @return Collection&lt;int, Training&gt;|Training[]
 */
public function getTrainings(): iterable
{
    return $this-&gt;trainings;
}</code></pre>
<p>What about the return type? Look at the property type:</p>
<pre><code class="language-diff"> &lt;?php

 /**
  * @return Collection&lt;int, Training&gt;|Training[]
  */
-public function getTrainings(): iterable
+public function getTrainings(): Collection
 {
     return $this-&gt;trainings;
 }</code></pre>
<p>And we're ready to go!</p>
<h2 id="3-Setter-Method">3. Setter Method?</h2>
<p>I bet you handled this already from the top of your head, so let's compare:</p>
<pre><code class="language-diff"> &lt;?php

 /**
  * @param Collection&lt;int, Training&gt;|Training[] $trainings
  */
-public function setTrainings(array $trainings): void
+public function setTrainings(Collection $trainings): void
 {
     $this-&gt;trainings = $trainings;
 }</code></pre>
<p><br></p>
<p>Do you want to see real code? Look at the full pull request:</p>
<p><a href="https://github.com/pehapkari/pehapkari.cz/pull/297/files"></p>
<img src="/assets/images/posts/2020/typed_doctrine_properties_collection.png" class="img-thumbnail">
<p></a></p>
<h2 id="EasyAdminBundle">EasyAdminBundle?</h2>
<p>Have you tried <a href="https://github.com/EasyCorp/EasyAdminBundle">EasyAdminBundle</a> to delegate your full administration? If not, give it go.</p>
<p><strong>It creates data grids, forms, edit/update/add/delete controllers. All this with simple and beautiful UX. All you need to do is define your entities and register them in YAML config.</strong> I love it!</p>
<p><br></p>
<p>Huge thanks to <a href="https://github.com/javiereguiluz">Javier Eguiluz</a>, creator and maintainer of this bundle, who's also behind amazing <strong>690&nbsp;issues</strong> of <a href="https://symfony.com/blog/category/a-week-of-symfony">Weeks of Symfony</a>.</p>
<p><br></p>
<p>To make this all happen, the design choice is to allow every property to be nullable. Some people disagree and try to make EasyAdminBundle work with value objects. But they fail by killing the simplicity and re-inventing admin again.</p>
<blockquote class="blockquote text-center">
There are no best solutions, there are just trade offs.
</blockquote>
<p>So what does <em>every property is nullable</em> mean for PHP 7.4 typed properties?</p>
<pre><code class="language-diff">&lt;?php

declare(strict_types=1);

namespace App\Entity;

use Doctrine\ORM\Mapping as ORM;

/**
 * @ORM\Entity
 */
class Training
{
    /**
     * @ORM\Id()
     * @ORM\GeneratedValue()
     * @ORM\Column(type="integer")
-    * @var int
     */
-   private $id;
+   private ?int $id = null;

    // ...
}</code></pre>
<p>Do you prefer code over text? <a href="https://github.com/pehapkari/pehapkari.cz/pull/297/files">Here is the PHP 7.4 upgrade pull-request</a>.</p>
<h2 id="Upgrade-Instantly-with-Rector">Upgrade Instantly with Rector</h2>
<p>I did not do the upgrade pull-request myself (I'm way too lazy for that), <a href="https://getrector.org">Rector</a> did. Thanks to testing out Rector on Doctrine entities, its PHP 7.4 set got much more precise.</p>
<p><strong>Do you want to see how Rector can upgrade your code?</strong></p>
<ol>
<li>
<p>Install Rector</p>
<pre><code class="language-bash">composer require rector/rector --dev</code></pre>
</li>
<li>
<p>Create <code>rector.php</code> config</p>
</li>
</ol>
<pre><code class="language-php">// rector.php
use Rector\Doctrine\Set\DoctrineSetList;
use Rector\Set\ValueObject\SetList;
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $containerConfigurator-&gt;import(SetList::PHP_74);
    // Protip: Do you want to update your `Collection` syntax for PHPStorm and PHPStan friendly?
    $containerConfigurator-&gt;import(DoctrineSetList::DOCTRINE_CODE_QUALITY);
};</code></pre>
<p>If you got any troubles, <a href="https://github.com/rectorphp/rector/issues/new/choose">let us know on GitHub</a>. That's all, folks.</p>
<p><br></p>
<p>Happy coding!</p>

            <br>


            <div class="card mt-5 border-warning">
                <div class="card-body text-center mt-2">
                    <p>
                        Have you find this post useful? <strong>Do you want more?</strong>
                    </p>
                    <p>
                        Follow me on <a href="https://twitter.com/votrubaT">Twitter</a>, <a href="/rss.xml">RSS</a> or support me on <a href="https://github.com/sponsors/TomasVotruba">GitHub Sponsors</a>.
                    </p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body text-white bg-success text-center">
                                            <a href="/blog/2020/03/16/statie-is-dead-long-live-symfony-static-dumper" class="d-block">
                            <div>
                                Read next → <strong>Statie is Dead, Long live Symfony Static Dumper</strong>
                            </div>
                        </a>
                                    </div>
            </div>

            <br>
            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />
        <script src="/assets/prism/prism.js"></script>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

        <script type="text/javascript">
            // @see https://stackoverflow.com/a/30776817/1348344
            var date = new Date();
            // display every 2nd hour, not to spam users
            if (date.getHours() % 2 === 1) {
                document.querySelector('.book-banner').style.display = 'visible';
            } else {
                document.querySelector('.book-banner').style.display = 'none';
            }
        </script>
    </body>
</html>
