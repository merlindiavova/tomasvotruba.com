<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Cleaning Lady Notes: From Class Mess to PSR-4 Step by Step With Confidence | Tomas Votruba</title>
<meta charset="utf-8">
<meta name="robots" content="index, follow">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:creator" content="@votrubaT"/>

<meta property="og:image" content="/assets/images/tomas_votruba.jpg"/>

<link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">


<link rel="stylesheet" rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:700&amp;display=swap" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" media="print" onload="this.media='all'">

<link href="/assets/css/style.css?576627616" rel="stylesheet" type="text/css" />

                <meta property="og:title" content="Cleaning Lady Notes: From Class Mess to PSR-4 Step by Step With Confidence" />
        <meta property="og:url" content="https://tomasvotruba.com/blog/2020/07/06/cleaning-lady-notes-from-class-mess-to-psr4-step-by-step-with-confidence" />
        <meta name="description" property="og:description" content="Today I&#039;m starting a new post series - *Cleaning Notes*. These posts are for people who are [aspiring legacy migrators](/blog/2020/06/29/how-will-programming-look-like-in-2025/) with a vision to improve private PHP ecosystem and bring joy to coding with gigantic applications again. The same vision we have in the Rector team.

In this series, you can learn about my experience, tricks, tips, and what fucked me up. So you **save some frustration, where is not needed, discover hidden shortcuts and cool tools you never saw before**.

We start with the most problematic topic in PHP legacy, that every project needs, but almost none has - **transition to [PSR-4](https://www.php-fig.org/psr/psr-4)**.
" />

            </head>

    <body>
        <!-- post_id: 267 -->
        <div id="menu">
    <div class="container-fluid">
        <a href="/">Home</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/blog">Blog</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/book/the-power-of-automated-refactoring">Book</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/trainings">Trainings</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/contact">Contact</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/about-me">About Me</a>
        <span class="pl-2 pr-2">•</span>

        <a href="https://twitter.com/votrubaT" target="blank">Twitter</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/rss.xml" target="blank">RSS</a>
    </div>
</div>

        <div class="container-fluid post" id="content">
            <div class="text-center book-banner">
                <a href="https://leanpub.com/rector-the-power-of-automated-refactoring" target="blank" class="text-center">
                    <img src="/assets/images/banner-rector-book.png" class="mb-2 ml-auto mr-auto rounded " style="max-height: 5em" alt="">
                </a>
            </div>

            <h1>Cleaning Lady Notes: From Class Mess to PSR-4 Step by Step With Confidence</h1>

            <div class="pull-right">
                <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/main/packages/blog/data/2020/2020-07-06-cleaning-lady-notes-from-class-mess-to-psr4-step-by-step-with-confidence.md">Found a typo? Edit me</a>
            </div>

            <time datetime="2020-07-Mon" class="text-muted">
                2020-07-06
            </time>

            
                            <div class="card border-success mt-4">
                    <div class="card-header text-white bg-success">
                        This post was updated at August 2020 with fresh know-how.
                        <br>
                        <strong>What is new?</strong>
                    </div>
                                            <div class="card-body pb-2">
                            <p>Updated Rector YAML to PHP configuration, as current standard.</p>
                        </div>
                                    </div>

                <br>
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>Today I'm starting a new post series - <em>Cleaning Notes</em>. These posts are for people who are <a href="/blog/2020/06/29/how-will-programming-look-like-in-2025/">aspiring legacy migrators</a> with a vision to improve private PHP ecosystem and bring joy to coding with gigantic applications again. The same vision we have in the Rector team.
<br><br>
In this series, you can learn about my experience, tricks, tips, and what fucked me up. So you <strong>save some frustration, where is not needed, discover hidden shortcuts and cool tools you never saw before</strong>.
<br><br>
We start with the most problematic topic in PHP legacy, that every project needs, but almost none has - <strong>transition to <a href="https://www.php-fig.org/psr/psr-4">PSR-4</a></strong>.</p>
                </div>
            </div>

            <p><em>Dedicated to <a href="https://github.com/Kerrialn">Kerrial</a>, my great friend who teaches me so much about not giving a f_ck and just do the stuff.<br>Thanks, dude!</em></p>
<p><br></p>
<h2 id="How-to-Approach-the-Migration-Itself">How to Approach the Migration Itself?</h2>
<h3 id="Know-Your-Enemy">Know Your Enemy</h3>
<p>There are many use cases that we have to handle to get to PSR-4. Honestly, I find it easier to <a href="/blog/2019/08/26/how-we-migrated-54-357-lines-of-code-nette-to-symfony-in-2-people-under-80-hours/">switch a framework</a>, where start is clear and goal is clear.</p>
<p>In PSR-4 migration, we have a clear goal:</p>
<ul>
<li>PSR-4: in 1 file, there is 1 class/trait/interface</li>
<li>the class/trait/interface has a unique fully qualified name, that reflects file location</li>
<li>nothing else exists</li>
</ul>
<h3 id="Start-has-Many-Ugly-Forms">Start has Many Ugly Forms</h3>
<ul>
<li><strong>in 1 file, there is a dozen classes</strong> - very popular for exceptions or test fixtures</li>
<li>some classes have <strong>identical name</strong> and custom class loader gives one or the other preference (e.g., Magento and Drupal use this in some version)</li>
<li>there are classes without any namespace</li>
<li>there are classes with <code>Fake_Namespace</code></li>
<li>file has a different name than the class, e.g. <code>random_file.php</code> with <code>class SomeClass {}</code> in it</li>
<li>in 1 file, there are classes and functions, so the file has to be manually included to &quot;autoload&quot; the functions</li>
<li>there are conditional classes, e.g.</li>
</ul>
<pre><code class="language-php">if (! class_exists('SomeClass')) {
    final class SomeClass
    {
        // ...
    }
}</code></pre>
<p>A lot to suck in, right? Don't worry; each of them has a guide to follow.</p>
<h3 id="Low-Hanging-Fruit">Low Hanging Fruit</h3>
<p>Each project is different, some of them has <a href="/blog/2020/04/13/how-to-migrate-spaghetti-to-304-symfony-5-controllers-over-weekend/">functions mixed with HTML</a>, some is missing composer completely, some needs to <a href="/blog/2020/06/08/drop-robot-loader-and-let-composer-deal-with-autoloading/">switch from custom-framework autoloading</a>.</p>
<p>But you should always apply basic rule:</p>
<blockquote class="blockquote text-center mt-5 mb-5">
    "Take the low hanging fruit first."
</blockquote>
<p>Always <strong>go for a simple target first</strong>. Don't be a hero. A hero falls from the sky after a massive battle over Atlantic, forgot to charge his smartphone... and dies alone.</p>
<p><strong>Be professional, close quickly, close early</strong>. Are there 3 files with 20 classes in them?</p>
<ul>
<li>split them to 20 classes</li>
<li>don't deal with namespaces, don't care about file naming</li>
<li>create pull-request</li>
<li>merge it</li>
</ul>
<p>✅</p>
<p>Done. You've just made a first small step. Cross one step of your list, 9/10 is left.
But all those 9 steps are now 10 % less complicated.</p>
<blockquote class="blockquote text-center mt-5 mb-5">
    "Even if you die, the code you wrote is merged."
    <footer class="blockquote-footer text-center">Bus Boy Scout Factor</footer>
</blockquote>
<p>I love this coding principle. Why? Because it takes minimalism and productivity to the practical world. It narrows our focus, so any developer becomes a 10x programmer effortlessly.</p>
<p><br></p>
<h2 id="What-Exactly-to-Do-Case-Study">What Exactly to Do? - Case Study</h2>
<p>Enough theory. <strong>Let's look at the project we've recently migrate to PSR-4 and how exactly we did it</strong>.</p>
<p>This is not paid promo, but <a href="https://www.startupjobs.cz/en/startup/scrumworks-s-r-o">Amateri are hiriging</a>. We're far enough with the migration, so I'm confident it would be fun to work with such codebase.</p>
<h2 id="1-Split-Multiple-Classes-in-1-File">1. Split Multiple Classes in 1 File</h2>
<p>How does it look?</p>
<pre><code class="language-diff"> // SomeFile.php
 class SomeClass
 {
 }

 class AnotherClass
 {
 }</code></pre>
<pre><code class="language-diff">+// AnotherClass.php
+class AnotherClass
+{
+}</code></pre>
<p><br></p>
<p>The <strong>1st cool tool</strong> we look at today is <a href="https://github.com/symplify/easy-ci">symplify/easy-ci</a>.
It doesn't need projects' autoloader so that it can be installed outside the project, e.g., in <code>/var/www/tools</code>, while your project is in <code>/var/www/old_project</code>.</p>
<p>Install it:</p>
<pre><code class="language-bash">composer require symplify/easy-ci --dev</code></pre>
<p>It would be great to have a list of all such multi-class files, right?</p>
<pre><code class="language-bash">vendor/bin/easy-ci find-multi-classes /src</code></pre>
<p>↓</p>
<pre><code class="language-bash">* SomeFile.php
    * SomeClass
    * AnotherClass</code></pre>
<p>Now we know how big a problem we're dealing with.</p>
<ul>
<li>Are there 3 files with 20 classes? <strong>Separate them manually</strong>.</li>
<li>Is that 50 files with 300 classes? Use <strong>Rector rule</strong> - <a href="https://github.com/rectorphp/rector/blob/main/docs/rector_rules_overview.md#multipleclassfiletopsr4classesrector"><code>MultipleClassFileToPsr4ClassesRector</code></a>.</li>
</ul>
<p>Now 1 file has exactly 1 class/interface/trait.</p>
<p>Send pull request, make sure your project's autoloader autoloads them, and tests are passing. Merge it, and you're done.</p>
<h2 id="2-Check-Class-Short-name-vs-Filename">2. Check Class Short name vs. Filename</h2>
<pre><code class="language-diff"> // Cucumber.php
-class Car
+class Cucumber
 {
 }</code></pre>
<p>If we only knew how many such files are there and where... back to Easy CI:</p>
<pre><code class="language-bash">vendor/bin/easy-ci check-file-class-name src</code></pre>
<p>You will get a list of files that don't match. Use PHPStorm refactoring to change the class name everywhere:</p>
<img src="/assets/images/posts/2020/psr4_rename_class.gif" class="img-thumbnail">
<p>Commit, PR, CI passes, merge.</p>
<p>✅</p>
<h2 id="3-Upper-case-Directories-First-Letter">3. Upper-case Directories First Letter</h2>
<p>In PSR-4, any non-root directory must start with the first big letter. Root is e.g. <code>/app</code>, <code>/src</code>.</p>
<pre><code class="language-diff">-/app/form/someForm
+/app/Form/SomeForm</code></pre>
<p>Go through directory in the left panel in PHPStorm and rename the directories there:</p>
<img src="/assets/images/posts/2020/psr4_rename_dirs.gif" class="img-thumbnail">
<p>Commit, PR, CI passes, merge.</p>
<p>✅</p>
<h2 id="4-Check-PSR-4-root">4. Check PSR-4 root</h2>
<p>We've done 3 steps so far. Now comes the biggest one, actually adding PSR-4 roots to <code>composer.json</code>.</p>
<p>It will not be as pretty as 1 root line, but that's not what we go here now. Our goal is <strong>to have all classes loaded with PSR-4, no matter how many lines</strong> in <code>composer.json</code> does it need.</p>
<pre><code class="language-json">{
    "autoload": {
        "psr-4": {
            "Amateri\\Payment\\": "src/somewhere-else/Payment",
            "Amateri\\Delivery\\": "src/another-dir/Delivery"
        }
    }
}</code></pre>
<p>We can guess what namespace roots (<code>"Amateri\\Payment\\"</code>) should be loaded from which directory (<code>"src/somewhere-else/Payment"</code>)... or we can use science!</p>
<pre><code class="language-bash">vendor/bin/easy-ci generate-psr4-paths project/src --composer-json project/composer.json</code></pre>
<p>The command will generate such paths for us, based on existing namespaces and file locations.
There may be over 10 or even 50 of those. <strong>Don't worry about it now</strong>.</p>
<ul>
<li>put generated output to <code>composer.json</code> instead of <code>classmap</code>,</li>
<li>run <code>composer dump-autoload</code> to let composer know about news paths</li>
<li>run PHPStan to see if all classes are loaded</li>
</ul>
<p>If everything passes... Commit, PR, CI passes, merge.</p>
<p>✅</p>
<h2 id="5-Narrow-the-Namespace-Root-and-Directories-in-composer-json">5. Narrow the Namespace Root and Directories in <code>composer.json</code></h2>
<p>Now comes my favorite part. Here we move all directories <strong>to use as little namespace root as possible</strong>.</p>
<p>It might be a little bit unclear, but give it time and it will fit in. Let's look at the example:</p>
<pre><code class="language-diff"> {
     "autoload": {
         "psr-4": {
-            "Amateri\\Payment\\": "src/somewhere-else/Payment",
-            "Amateri\\Delivery\\": "src/another-dir/Delivery",
+            "Amateri\\": "src"
        }
    }
}</code></pre>
<p>What happens with files?</p>
<pre><code class="language-diff">-src/somewhere-else/Payment
+src/Payment</code></pre>
<pre><code class="language-diff">-src/another-dir/Delivery
+src/Delivery</code></pre>
<p>Here use PHPStorm refactoring on the directory as in step 3.</p>
<ul>
<li>run <code>composer dump-autoload</code> to let composer know about news paths</li>
<li>run PHPStan to see if all classes are loaded</li>
</ul>
<p>If everything passes... Commit, PR, CI passes, merge.</p>
<p>✅</p>
<h2 id="6-What-if-there-are-No-Namespaces-or-Are-Very-Very-Bad">6. What if there are No Namespaces or Are Very Very Bad?</h2>
<p><div class="card ml-4 mt-4 border-warning float-right post-snippet" style="width: 14em">
    <div class="card-body">
        Would you like to <strong>learn more about Rector</strong>? Step by step, from zero to hero?
        <br>

        <div class="text-center">
            <a href="/book/the-power-of-automated-refactoring/">
                <img src="/assets/images/rector_book.png" class="mb-3 mt-3 shadow">
                Get our new book
            </a>
        </div>
    </div>
</div>
</p>
<p>In many code bases, there are just random files—no namespace, no fake namespace, etc.</p>
<p>For these, we have help of Rector with these 2 rules:</p>
<ul>
<li><a href="https://github.com/rectorphp/rector/blob/main/docs/rector_rules_overview.md#normalizenamespacebypsr4composerautoloadfilesystemrector"><code>NormalizeNamespaceByPSR4ComposerAutoloadRector</code></a></li>
<li><a href="https://github.com/rectorphp/rector/blob/main/docs/rector_rules_overview.md#normalizenamespacebypsr4composerautoloadrector"><code>NormalizeNamespaceByPSR4ComposerAutoloadFileSystemRector</code></a></li>
</ul>
<p><br></p>
<p>Register them in <code>rector.php</code>:</p>
<pre><code class="language-php">use Rector\PSR4\Rector\FileSystem\NormalizeNamespaceByPSR4ComposerAutoloadFileSystemRector;
use Rector\PSR4\Rector\Namespace_\NormalizeNamespaceByPSR4ComposerAutoloadRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;rule(NormalizeNamespaceByPSR4ComposerAutoloadRector::class);
    $rectorConfig-&gt;rule(NormalizeNamespaceByPSR4ComposerAutoloadFileSystemRector::class);
};</code></pre>
<p>And <strong>manually add the desired namespace</strong> to your <code>composer.json</code>:</p>
<pre><code class="language-diff"> {
+   "autoload": {
+        "psr-4": {
+            "Amateri\\": "src"
+        }
+    }
 }</code></pre>
<p>When you run the Rector, it will try to autocomplete all the namespaces to respect your <code>composer.json</code>:</p>
<pre><code class="language-bash">vendor/bin/rector p src</code></pre>
<p>This is one of <strong>the most significant changes in your application</strong>, so <strong>be sure to check it carefully</strong>. Not all cases are covered by Rector yet.</p>
<ul>
<li>run <code>composer dump-autoload</code> to let composer know about news paths</li>
<li>run PHPStan to see if all classes are loaded</li>
</ul>
<p>If everything passes... Commit, PR, CI passes, merge.</p>
<p>✅</p>
<p><br></p>
<p>Then we added few manual tweaks here and there, and we were PSR-4 compliant with ~7 lines in PSR-4 in <code>composer.json</code>.</p>
<p><br></p>
<p><strong>Have you found a case that is not covered or a better way to this</strong>? Let me know in the comments.</p>
<p><br></p>
<p>Happy coding!</p>

            <br>


            <div class="card mt-5 border-warning">
                <div class="card-body text-center mt-2">
                    <p>
                        Have you find this post useful? <strong>Do you want more?</strong>
                    </p>
                    <p>
                        Follow me on <a href="https://twitter.com/votrubaT">Twitter</a>, <a href="/rss.xml">RSS</a> or support me on <a href="https://github.com/sponsors/TomasVotruba">GitHub Sponsors</a>.
                    </p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body text-white bg-success text-center">
                                            <a href="/blog/2020/07/02/how-to-patch-package-in-vendor-yet-allow-its-updates" class="d-block">
                            <div>
                                Read next → <strong>How to Patch a Package in Vendor, Yet Allow its Updates</strong>
                            </div>
                        </a>
                                    </div>
            </div>

            <br>
            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />
        <script src="/assets/prism/prism.js"></script>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

        <script type="text/javascript">
            // @see https://stackoverflow.com/a/30776817/1348344
            var date = new Date();
            // display every 2nd hour, not to spam users
            if (date.getHours() % 2 === 1) {
                document.querySelector('.book-banner').style.display = 'visible';
            } else {
                document.querySelector('.book-banner').style.display = 'none';
            }
        </script>
    </body>
</html>
