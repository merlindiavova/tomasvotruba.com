<!DOCTYPE html>
<html lang="en">
    <head>
        <title>How to make Upgrade Safe with Bridge Testing | Tomas Votruba</title>
<meta charset="utf-8">
<meta name="robots" content="index, follow">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:creator" content="@votrubaT"/>

    <meta property="og:title" content="How to make Upgrade Safe with Bridge Testing" />
    <meta property="og:url" content="https://tomasvotruba.com/blog/how-to-make-upgrade-safe-with-bridge-testing" />

            <meta property="og:image" content="https://tomasvotruba.com/assets/images/tomas_votruba.jpg"/>
        <meta name="twitter:image" content="https://tomasvotruba.com/assets/images/tomas_votruba.jpg"/>
    
<link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">


<link rel="stylesheet" rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:700&amp;display=swap" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" media="print" onload="this.media='all'">

<link href="/assets/css/style.css?324254728" rel="stylesheet" type="text/css" />

                <meta name="description" property="og:description" content="Upgrading can go smooth without no bugs and just work. We can make our customer happy, even though we don&#039;t have any tests.


**The older I am, the more I care about safety**. Not just for now, but for tomorrow and for my safety of my colleagues. Also for the developers, who will work on the project even though I&#039;m long gone.


That&#039;s why before I start upgrading one approach to another, I want to prepare a safe environment. No razors, no matches, and a couple of tests. The bridge testing technique is one of the safety nets I use while refactoring to new technology.
" />
    </head>

    <body>
        <!-- post_id: 324 -->
        <div id="menu">
    <div class="container-fluid">
        <a href="/">Home</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/blog">Blog</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/book/the-power-of-automated-refactoring">Book</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/trainings">Trainings</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/contact">Contact</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/about-me">About Me</a>
        <span class="pl-2 pr-2">•</span>

        <a href="https://twitter.com/votrubaT" target="blank">Twitter</a>
        <span class="pl-2 pr-2">•</span>

        <a href="/rss.xml" target="blank">RSS</a>
    </div>
</div>

        <div class="container-fluid post" id="content">
            <div class="text-center book-banner">
                <a href="https://leanpub.com/rector-the-power-of-automated-refactoring" target="blank" class="text-center">
                    <img src="/assets/images/banner-rector-book.png" class="mb-2 ml-auto mr-auto rounded " style="max-height: 5em" alt="">
                </a>
            </div>

            <h1>How to make Upgrade Safe with Bridge&nbsp;Testing</h1>

            <div class="pull-right">
                <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/main/packages/blog/data/2021/2021-06-21-how-to-make-upgrade-safe-with-bridge-testing.md">Found a typo? Edit me</a>
            </div>

            <time datetime="2021-06-Mon" class="text-muted">
                2021-06-21
            </time>

            
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>Upgrading can go smooth without no bugs and just work. We can make our customer happy, even though we don't have any tests.
<br>
<br>
<strong>The older I am, the more I care about safety</strong>. Not just for now, but for tomorrow and for my safety of my colleagues. Also for the developers, who will work on the project even though I'm long gone.
<br>
<br>
That's why before I start upgrading one approach to another, I want to prepare a safe environment. No razors, no matches, and a couple of tests. The bridge testing technique is one of the safety nets I use while refactoring to new technology.</p>
                </div>
            </div>

            <p>The idea is simple - in total, we should have 3 tests:</p>
<ul>
<li>test for current behavior - compare with exact output</li>
<li><em>add alternative feature</em></li>
<li>test new behavior - compare with exact output</li>
<li>test current and new behavior - compare both results together</li>
</ul>
<p><br></p>
<p>It will be more clear from an example. Let's say we use <code>@AttentionPrice</code> annotation to express the amount of attention we should spend while reading the code:</p>
<pre><code class="language-php">/**
 * @Annotation()
 */
class AttentionPrice
{
    private int $amount;

    public function __construct(array $values)
    {
        $this-&gt;amount = $values['amount'];
    }

    public function getAmount(): int
    {
        return $this-&gt;amount;
    }
}</code></pre>
<p>In our code, we'll use annotation to express required attention for specific elements:</p>
<pre><code class="language-php">final class DesignPattern
{
    /**
     * @AttentionPrice(1000)
     */
    public $publicProperty;

    /**
     * @AttentionPrice(100)
     */
    private $privateProperty;
}</code></pre>
<p>Here we can see that public property takes much more attention than private one. Public properties can be used in the class, outside the class, and changed anytime. On the other hand, private property can be used exclusively in this class.</p>
<h2 id="Bridge-Test">Bridge Test</h2>
<p>Let's add a bridge test so we are sure the refactoring works for both annotations and attributes. How would the bridge test look like for public property?</p>
<pre><code class="language-php">use PHPUnit\Framework\TestCase;

final class BridgeTest extends TestCase
{
    private Reader $reader;

    protected function setUp(): void
    {
        // create Reader instance or get it from container
        $this-&gt;reader = // ...;
    }

    public function testCurrent(): void
    {
        $resolvedValue = $this-&gt;reader-&gt;resolveAnnotationValue(
            'DesignPattern', 'publicProperty'
        );
        $this-&gt;assertSame($resolvedValue, 1000);
    }
}</code></pre>
<p>Let's run the test:</p>
<pre><code class="language-bash">vendor/bin/phpunit tests/BridgeTest.php</code></pre>
<p>It should pass - it only confirms already existing behavior.</p>
<p><br></p>
<p>Let's add a new method, <code>resolveAttributeValue()</code> that will be able to read PHP 8 attribute values too:</p>
<pre><code class="language-php">    // ...

    public function testNew(): void
    {
        $resolvedValue = $this-&gt;reader-&gt;resolveAttributeValue(
            'DesignPattern', 'publicProperty'
        );
        $this-&gt;assertSame($resolvedValue, 1000);
    }

    // ...</code></pre>
<p>Now the test should fail because we have yet to implement the <code>resolveAttributeValue()</code> method:</p>
<pre><code class="language-bash">vendor/bin/phpunit tests/BridgeTest.php</code></pre>
<p><br></p>
<p>Last but not least, the bridge test compares the results of both methods:</p>
<pre><code class="language-php">
    // ...

    public function testBridge(): void
    {
        $resolvedAnnotationValue = $this-&gt;reader-&gt;resolveAnnotationValue(
            'DesignPattern', 'publicProperty'
        );
        $resolvedAttributeValue = $this-&gt;reader-&gt;resolveAttributeValue(
            'DesignPattern', 'publicProperty'
        );

        $this-&gt;assertSame($resolvedAnnotationValue, $resolvedAttributeValue);
    }

    // ...</code></pre>
<h2 id="Why-Not-Just-The-Bridge-Test">Why Not Just The Bridge Test?</h2>
<p>Looking at the test, it seems the <code>testBridge()</code> already includes the test of their former two methods. Why not delete those two? ...
Wait, wouldn't that be like cutting our safety ropes?</p>
<img src="https://images.squarespace-cdn.com/content/v1/5a54afc2e9bfdf89573d7cf7/1551374451263-U7I7L1NLOJY6XWNL028T/ke17ZwdGBToddI8pDm48kJUlZr2Ql5GtSKWrQpjur5t7gQa3H78H3Y0txjaiv_0fDoOvxcdMmMKkDsyUqMSsMWxHk725yiiHCCLfrh8O1z5QPOohDIaIeljMHgDF5CVlOqpeNLcJ80NK65_fV7S1UfNdxJhjhuaNor070w_QAc94zjGLGXCa1tSmDVMXf8RUVhMJRmnnhuU1v2M8fLFyJw/Rope-Bridge-project-Salwa+Resort-Abu+Samra-Qatar-5.jpeg?format=500w" class="img-thumbnail">
<p><br></p>
<p>At first, the test passes, and both methods return <code>1000</code> and <code>assertSame()</code> works correctly.</p>
<pre><code class="language-php">$resolvedAnnotationValue = ...; // 1000
$resolvedAttributeValue = ...; // 1000
$this-&gt;assertSame($resolvedAnnotationValue, $resolvedAttributeValue);</code></pre>
<p><br></p>
<p>Later that day, we do a bit of refactoring. Let's run tests now:</p>
<pre><code class="language-bash">vendor/bin/phpunit tests/BridgeTest.php</code></pre>
<p>It still passes, yay!</p>
<p><br></p>
<p>A few weeks later, we find out the production annotations and attributes <strong>were ignored</strong>, your admin was publicly available, and the test passes with these values:</p>
<pre><code class="language-php">$this-&gt;assertSame(null, null);</code></pre>
<p>That's why it's essential to have two previous methods and compare exact values.
Now that we have safety rules defined let's start the dirty work!</p>
<p><br></p>
<p>Happy coding!</p>

            <br>


            <div class="card mt-5 border-warning">
                <div class="card-body text-center mt-2">
                    <p>
                        Have you find this post useful? <strong>Do you want more?</strong>
                    </p>
                    <p>
                        Follow me on <a href="https://twitter.com/votrubaT">Twitter</a>, <a href="/rss.xml">RSS</a> or support me on <a href="https://github.com/sponsors/TomasVotruba">GitHub Sponsors</a>.
                    </p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body text-white bg-success text-center">
                                            <a href="/blog/doctrine-annotations-and-attributes-living-together-in-peace" class="d-block">
                            <div>
                                Read next → <strong>Doctrine Annotations and Attributes Living Together in Peace</strong>
                            </div>
                        </a>
                                    </div>
            </div>

            <br>
            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />
        <script src="/assets/prism/prism.js"></script>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

        <script type="text/javascript">
            // @see https://stackoverflow.com/a/30776817/1348344
            var date = new Date();
            // display every 2nd hour, not to spam users
            if (date.getHours() % 2 === 1) {
                document.querySelector('.book-banner').style.display = 'visible';
            } else {
                document.querySelector('.book-banner').style.display = 'none';
            }
        </script>
    </body>
</html>
