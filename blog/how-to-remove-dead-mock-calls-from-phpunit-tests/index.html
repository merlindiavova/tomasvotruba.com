<!DOCTYPE html>
<html lang="en">
    <head>
        <title>How to Remove Dead Mock Calls from PHPUnit Tests | Tomas Votruba</title>
<meta charset="utf-8">
<meta name="robots" content="index, follow">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:creator" content="@votrubaT"/>

    <meta property="og:title" content="How to Remove Dead Mock Calls from PHPUnit Tests" />
    <meta property="og:url" content="https://tomasvotruba.com/blog/how-to-remove-dead-mock-calls-from-phpunit-tests" />

            <meta property="og:image" content="https://tomasvotruba.com/assets/images/posts/2022/cleaning_city.jpg" />
        <meta name="twitter:image" content="https://tomasvotruba.com/assets/images/posts/2022/cleaning_city.jpg"/>
    
<link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">


<link rel="stylesheet" rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:700&amp;display=swap" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" media="print" onload="this.media='all'">

<link href="/assets/css/style.css?1332334445" rel="stylesheet" type="text/css" />

                <meta name="description" property="og:description" content="We&#039;re going to visit a foreign country where living costs are just 1/3 of ours. Let&#039;s say from UK or Germany to Brno, Czechia. We&#039;re organizing a bachelor party for our best friend.

The night has come, and our group walks around the city and drinks beers, the groom wears baby piggy clothes, and we&#039;re happily celebrating. We&#039;re losing one more wingman that will settle down with a beautiful wife and soon-to-come child. It&#039;s fun and exciting. We&#039;ve never been abroad before with so many friends to celebrate the next step in man&#039;s life.
" />
    </head>

    <body>
        <!-- post_id: 358 -->
        <div id="menu">
    <div class="container-fluid">
        <a href="/">Home</a>
        <span class="pl-2 pr-2">â€¢</span>

        <a href="/blog">Blog</a>
        <span class="pl-2 pr-2">â€¢</span>

        <a href="/book/the-power-of-automated-refactoring">Book</a>
        <span class="pl-2 pr-2">â€¢</span>

        <a href="/trainings">Trainings</a>
        <span class="pl-2 pr-2">â€¢</span>

        <a href="/contact">Contact</a>
        <span class="pl-2 pr-2">â€¢</span>

        <a href="/about-me">About Me</a>
        <span class="pl-2 pr-2">â€¢</span>

        <a href="https://twitter.com/votrubaT" target="blank">Twitter</a>
        <span class="pl-2 pr-2">â€¢</span>

        <a href="/rss.xml" target="blank">RSS</a>
    </div>
</div>

        <div class="container-fluid post" id="content">
            <div class="text-center book-banner">
                <a href="https://leanpub.com/rector-the-power-of-automated-refactoring" target="blank" class="text-center">
                    <img src="/assets/images/banner-rector-book.png" class="mb-2 ml-auto mr-auto rounded " style="max-height: 5em" alt="">
                </a>
            </div>

            <h1>How to Remove Dead&nbsp;Mock&nbsp;Calls from&nbsp;PHPUnit&nbsp;Tests</h1>

            <div class="pull-right">
                <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/main/packages/blog/data/2022/2022-04-25-how-to-remove-dead-mock-calls-from-phpunit-tests.md">Found a typo? Edit me</a>
            </div>

            <time datetime="2022-04-Mon" class="text-muted">
                2022-04-25
            </time>

            
            
            <div class="card card-bigger mb-5">
                <div class="card-body pb-2">
                    <p>We're going to visit a foreign country where living costs are just 1/3 of ours. Let's say from UK or Germany to Brno, Czechia. We're organizing a bachelor party for our best friend.
<br><br>
The night has come, and our group walks around the city and drinks beers, the groom wears baby piggy clothes, and we're happily celebrating. We're losing one more wingman that will settle down with a beautiful wife and soon-to-come child. It's fun and exciting. We've never been abroad before with so many friends to celebrate the next step in man's life.</p>
                </div>
            </div>

            <p>It's a Sunday morning, and we fly back home. Just a little hangover, but apart from that, the best party of this year!</p>
<p>That's one side of the story.</p>
<blockquote class="blockquote text-center">
"A person's freedom ends<br>
where another man's freedom begins."
</blockquote>
<p>We can see the same weekend via 3 different glasses:</p>
<ul>
<li>
<p>We're working for the hotel as a cleaning service. We wake up at 5 AM, ready to wash another dirty puked bathroom.</p>
</li>
<li>
<p>The public cleaning service wakes up at 4 AM to pick up broken glass in the streets. People going through the morning always get what they expect - a clean city ready for their dogs and children to walk around safely.</p>
</li>
<li>
<p>We're a family living in the city who has a bad weekend. We could not sleep till 3 AM. Why? The streets were noisy, with singing drunks arguing with police, then playing some techno music from their Bluetooth speaker.</p>
</li>
</ul>
<p><br></p>
<img src="/assets/images/posts/2022/brno_empty.jpg" class="img-thumbnail" style="max-width: 25em">
<p><br></p>
<p>For these people, it's a tiring day, cleaning other people's mess and dealing with the consequences of one &quot;fun&quot; time.</p>
<p><br><br></p>
<p>Let's take this story to our work, a city being our project. Every new feature might seems cool and very useful to implement, but it has its consequences on the side of long-term use.</p>
<h2 id="Mocking-is-Fun-but-at-What-Cost">Mocking is Fun... but at What Cost?</h2>
<p>That's how mocking seems to be used these days. <strong>On one side</strong>, an excited team wants to apply this new testing framework to add a new test to their super legacy project that is hard to tackle. Finally, there is a tool that makes testing of anything possible because they do not have to deal with dependencies, types, or versioning. Everything can be mocked, and we only test the result!</p>
<p><strong>On the other hand</strong>, new developers come to the project 2 years later. Their job is to upgrade the framework and PHP version. The upgrade itself goes well, but they have to deal with tests. &quot;Deal&quot; with tests? Should not tests be the helpful positive assets of the project?</p>
<h2 id="Refactoring-Tests-Maintenance">Refactoring + Tests Maintenance</h2>
<p>Test have to update too: renamed methods, changed classes of updated dependencies etc. Even worse, some tests are false positively passing, because all the bearing parts were mocked. <strong>They're not testing the business code but the mocking framework itself</strong>. They give us an impression of tested code... until it fails on production on the actual class.</p>
<p><br></p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">How much do you mock?<br><br>Got 2 projects overrun with mocks, that make maintaining test terribly painful.<br><br>Exploring options to get to 0 mocks in an automated fashion.<a href="https://t.co/1NCIXIWjjK">https://t.co/1NCIXIWjjK</a></p>â€” Tomas Votruba ðŸ‡ºðŸ‡¦ (@VotrubaT) <a href="https://twitter.com/VotrubaT/status/1519732183614775300?ref_src=twsrc%5Etfw">April 28, 2022</a></blockquote>
<p><br></p>
<p>There is handful of wise posts about <strong>why not to use mocks</strong> and move to readable PHP code:</p>
<ul>
<li><a href="https://blog.frankdejonge.nl/testing-without-mocking-frameworks/">Testing without mocking frameworks</a></li>
<li><a href="https://mnapoli.fr/anonymous-classes-in-tests/">Using anonymous classes to write simpler tests</a></li>
<li><a href="https://steemit.com/php/@crell/don-t-use-mocking-libraries">Don't use Mocking libraries</a></li>
<li><a href="https://davegebler.com/post/php/better-php-unit-testing-avoiding-mocks">Better PHP unit testing: avoiding mocks</a></li>
</ul>
<p><br></p>
<p>This post will not be about &quot;why&quot;, but rather about <strong>how to deal with mock flood</strong> in a 10+ year project we took over.</p>
<h2 id="The-Low-Hanging-Fruit-Mock">The Low Hanging <del>Fruit</del> Mock</h2>
<p>Would you use 3 constructors to pass your dependency to class? No, we would use the exact amount needed - one. The same way we treat mocks - bring value or leave.</p>
<p>The project we took over is old but successful. Fortunately for us, it has excellent test coverage, running CI, PHPStan, ECS, and Rector. There is just one catch: <strong>roughly 30 % of the tests are bare mocks</strong>.</p>
<p>We need easy to maintain tests, to move move fast and safely. The last thing we want to deal with is upgrading strings in tests. How can we get out of the mock jungle?</p>
<h2 id="Taking-Dead-Mocks-First-to-Lower-Complexity">Taking Dead Mocks First to Lower Complexity</h2>
<p>This year, <a href="https://getrector.org/for-companies">with Rector cleaning services</a>, we're cleaning 2 projects from mock jungle.</p>
<p><br></p>
<p>Our goal is simple:</p>
<ul>
<li>remove useless mocks</li>
<li>keep only those mocks that bring value</li>
<li>improve the codebase at once</li>
<li>make sure safety is priority</li>
</ul>
<p><br></p>
<p>So what does the universally useless mock look like? The idea is the same with dead code in PHP:</p>
<pre><code class="language-diff">-$value = 100;
 $value = 150;</code></pre>
<p>Here we know the only 2nd value will remain, as the last assigned wins. We can remove the 1st line without changing anything. We can also detect this pattern with Rector and automate this.</p>
<h2 id="Detecting-Dead-Mocks">Detecting Dead Mocks</h2>
<h3 id="1-Replace-getMockBuilder-with-createMock">1. Replace <code>getMockBuilder()</code> with <code>createMock()</code></h3>
<p>The <code>getMockBuilder()</code> is an old method that was used <a href="https://stackoverflow.com/questions/38363086/what-is-the-difference-between-createmock-and-getmockbuilder-in-phpunit">for detailed strict testing</a>. Replacing this method will remove a lot of clutter and most likely will not change the test:</p>
<pre><code class="language-diff">-$cacheServiceMock = $this-&gt;getMockBuilder(CacheInterface::class)
-    -&gt;disableOriginalConstructor()
-    -&gt;setMethods(['del', 'get', 'set'])
-    -&gt;getMock();
+$cacheServiceMock = $this-&gt;createMock(CacheInterface::class);</code></pre>
<p>We've done this refactoring on one code base, removing 59 cases, and tests are passing well.</p>
<p><br></p>
<h3 id="2-Remove-expects-this-and-gt-any-as-default">2. Remove <code>expects($this-&gt;any())</code> as default</h3>
<p>This method defined expected input on the following method call. The &quot;any&quot; type is the default input so that it can be safely removed:</p>
<pre><code class="language-diff"> $siteServiceMock
-    -&gt;expects($this-&gt;any())
     -&gt;method('getMetadata')
     -&gt;willReturn(['name' =&gt; 'John']);</code></pre>
<p>In our project, 63 lines are now gone.</p>
<p><br></p>
<h3 id="3-Replace-will-returnValue-with-willReturn">3. Replace <code>will()</code> + <code>returnValue()</code> with <code>willReturn()</code></h3>
<p>A handy shortcut that might help us in the next refactoring:</p>
<pre><code class="language-diff"> $requestMock
     -&gt;method('getPathInfo')
-    -&gt;will($this-&gt;returnValue($url));
+    -&gt;willReturn($url);</code></pre>
<h2 id="Empower-your-CI-to-Work-for-You">Empower your CI to Work for You</h2>
<p>After all this effort, our tests are getting slim. We're not there yet, but it's a start to spark the fire. But what if someone will send a PR or IDE/tool-generated code that will give us the clutter back?</p>
<p>No worries, add this set to your <code>rector.php</code>, enable Rector in CI, and you're covered forever:</p>
<pre><code class="language-php">use Rector\Config\RectorConfig;
use Rector\Set\ValueObject\SetList;
use Rector\PHPUnit\Set\PHPUnitSetList;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;sets([
        PHPUnitSetList::REMOVE_MOCKS,
    ]);
};</code></pre>
<p><br></p>
<p>Do you know <strong>another pattern refactoring to reduce mocks we should include here</strong>? Please share with me in the comments. I'm eager to learn, as this is a widespread problem we can easily automate.</p>
<p><br></p>
<p>Happy coding!</p>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

            <br>


            <div class="card mt-5 border-warning">
                <div class="card-body text-center mt-2">
                    <p>
                        Have you find this post useful? <strong>Do you want more?</strong>
                    </p>
                    <p>
                        Follow me on <a href="https://twitter.com/votrubaT">Twitter</a>, <a href="/rss.xml">RSS</a> or support me on <a href="https://github.com/sponsors/TomasVotruba">GitHub Sponsors</a>.
                    </p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body text-white bg-success text-center">
                                            <a href="/blog/how-to-make-configs-like-rector-config-or-ecs-config-for-your-symfony-project" class="d-block">
                            <div>
                                Read next â†’ <strong>How to Make Configs like RectorConfig or ECSConfig for your Symfony Project</strong>
                            </div>
                        </a>
                                    </div>
            </div>

            <br>
            <br>

            <a name="comments"></a>
            <div id="disqus_thread"></div>

<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://itsworthsharing.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>

        <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />
        <script src="/assets/prism/prism.js"></script>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

        <script type="text/javascript">
            // @see https://stackoverflow.com/a/30776817/1348344
            var date = new Date();
            // display every 2nd hour, not to spam users
            if (date.getHours() % 2 === 1) {
                document.querySelector('.book-banner').style.display = 'visible';
            } else {
                document.querySelector('.book-banner').style.display = 'none';
            }
        </script>
    </body>
</html>
