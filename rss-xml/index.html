<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0"
    xmlns:content="https://purl.org/rss/1.0/modules/content/"
    xmlns:dc="https://purl.org/dc/elements/1.1/"
    xmlns:atom="https://www.w3.org/2005/Atom"
>
    <channel>
        <title>Tomas Votruba writes about PHP and education</title>
        <link>https://tomasvotruba.com/</link>
        <description>PHP, Communities and Communication posts by Tomas Votruba</description>
        <pubDate>Mon, 08 Aug 2022 00:10:46 +0000</pubDate>
        <atom:link href="https://tomasvotruba.com/rss.xml" rel="self" type="application/rss+xml" />

        <lastBuildDate>Mon, 18 Jul 2022 00:00:00 +0000</lastBuildDate>

                            
            <item>
                <title><![CDATA[ 8 News in Config Transformer that Converts Symfony YML to PHP ]]></title>
                <link>https://tomasvotruba.com/blog/8-news-in-config-transformer-that-converts-symfony-yml-to-php</link>
                <description><![CDATA[ <p>If you have not switched your <a href="/blog/2020/07/27/how-to-switch-from-yaml-xml-configs-to-php-today-with-migrify/">Symfony configs from YAML to PHP</a>, there no better time like present.
<br><br>
This month we tested the ConfigTransformer to its limit. It had to deal with edge-cases from Symfony 2.8 all the way through Symfony 3.4. With features that were removed for years. As a result, we added default processing of <code>*.yaml</code> and <code>.yml</code> syntax at the same time and support for scalars like <code>::hi</code> and <code>'hello::'</code>.
<br><br>
That's just the tip of the iceberg. <strong>What are the 5 new features you'll be able to enjoy in the upcoming release</strong>?</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="1-New-Support-for-Directory-Loader">1. New Support for Directory Loader</h2>
<p>Since Symfony 2.8, it is possible to <a href="https://github.com/symfony/symfony/issues/11045">load configs from a single directory</a>. That means you can use the shorter syntax...</p>
<pre><code class="language-diff"> imports:
-    - { resource: packages/doctrine.yml }
-    - { resource: packages/framework.yml }
-    - { resource: packages/security.yml }
+    - { resource: packages/ }</code></pre>
<p>...with the same effect. Now you won't forget to include the config here. It's pretty rare with legacy projects, but still possible syntax.</p>
<p><br></p>
<p>In the new ConfigTransformer version, we <strong>cover directory loading out of the box ✅</strong></p>
<p><br></p>
<h2 id="2-New-Defaults-Extensions-Autoloaded">2. New Defaults Extensions Autoloaded</h2>
<p>The directory loading opened a complete feature list we can cover. E.g., now it's possible to load extensions from these imported configs:</p>
<pre><code class="language-yaml">doctrine:
    key: value</code></pre>
<p><br></p>
<p>We've added the list of 10 default extensions to cover - <code>'doctrine'</code>, <code>'framework'</code>, <code>'monolog'</code>, <code>'security'</code>, <code>'twig'</code> and more. Including the deprecated ones, e.g. <code>'assetic'</code>.</p>
<p><br></p>
<p>This allows us converting a much lower Symfony version than ever - <strong>Symfony 2.8 ✅</strong></p>
<p><br></p>
<h2 id="3-Added-Support-for-autowiring-types">3. Added Support for <code>autowiring_types</code></h2>
<p>This option <a href="https://github.com/symfony/symfony/pull/21494">was deprecated in Symfony 3.3</a>. If any config contained it, it was skipped.</p>
<p><br></p>
<p>It was quite a complex challenge because the code is removed in Symfony 6, and ConfigTransformer is built on that version.</p>
<p>But in the end, we managed to add it:</p>
<pre><code class="language-yaml">services:
    some_service:
        class: App\SomeClass
        autowiring_types: App\SomeInterface</code></pre>
<p>↓</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use App\SomeClass;
use App\SomeInterface;

return static function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();

    $services-&gt;set('some_service', SomeClass::class)
        -&gt;addAutowiringType(SomeInterface::class);</code></pre>
<p><strong>Now it's covered as expected ✅</strong></p>
<p><br></p>
<h2 id="4-Add-Support-for-Unquoted-Scalars">4. Add Support for Unquoted Scalars</h2>
<p>Unquoted scalars were deprecated <a href="https://symfony.com/blog/new-in-symfony-3-1-yaml-deprecations#deprecated-starting-scalars-with-characters">in Symfony 3.1</a>. If your config had it, the conversion crashed:</p>
<pre><code class="language-yaml">framework:
    secret: %secret%</code></pre>
<p><br></p>
<p>Are you using a Symfony version where this is still valid syntax? We have good news for you.</p>
<p><strong>We added automated pre-quoting of scalar so this can be parsed with ease ✅</strong></p>
<p><br></p>
<h2 id="5-Skip-PHP-Configs-Loading">5. Skip PHP Configs Loading</h2>
<p>Usually, we take many little steps when it comes to huge changes. We don't convert all the files at once, but rather one group at a time, e.g. first parameters, then services, then extensions.</p>
<p>That means in certain point of time, we have part configs in PHP and part in YAML:</p>
<pre><code class="language-bash">/configs
    config.yml
    /parameters
        items.php</code></pre>
<p><br></p>
<p>Before, the ConfigTransformer tried to load the PHP configs and invoked a bunch of class loading and config interpretation, that could crash.</p>
<p><strong>Now it will skip PHP and focuses solely on the YAML files ✅</strong></p>
<p><br></p>
<h2 id="6-Informative-Output-with-Beautiful-Colored-Diff">6. Informative Output with Beautiful Colored Diff</h2>
<p>Do you want first to try it on a single file? That's completely normal. I often do that, too, to verify the output is the same as I expect.</p>
<p>At the moment, we can run a <code>--dry-run</code> so we see what changes:</p>
<img src="/assets/images/posts/2022/config_trans_before.png" class="img-thumbnail mb-4" style="max-width: 35em">
<p>We see some files are removed, and other files are added. Okay, but what about content? At this point, the <code>--dry-run</code> does not change anything, which is correct. But it also doesn't give us any indices to decide to run a command without it. We can do better.</p>
<p><br></p>
<p>That's why we've <strong>redesigned the output to provide the following</strong>:</p>
<ul>
<li>Information about the file rename</li>
<li>full diff of what you expect</li>
</ul>
<img src="/assets/images/posts/2022/config_trans_after.png" class="img-thumbnail mt-3 mb-4" style="max-width: 35em">
<p><strong>Beautiful and clear ✅</strong></p>
<p><br></p>
<h2 id="7-Improved-Support-for-when-at-env">7. Improved Support for <code>when@env</code></h2>
<p>Thanks to <a href="https://github.com/Tofandel">Tofandel</a> you can enjoy this <a href="https://github.com/symplify/symplify/pull/4247">impressive feature</a> that handles complex cases of conditional environments:</p>
<p><br></p>
<pre><code class="language-yaml">when@local:
    web_profiler:
        toolbar: true
        intercept_redirects: false

    framework:
        profiler: true</code></pre>
<p>↓</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return static function (ContainerConfigurator $containerConfigurator): void {
    if ($containerConfigurator-&gt;env() === 'local') {
        $containerConfigurator-&gt;extension('web_profiler', [
            'toolbar' =&gt; true,
            'intercept_redirects' =&gt; false,
        ]);
        $containerConfigurator-&gt;extension('framework', [
            'profiler' =&gt; true
        ]);
    }
};</code></pre>
<p><br></p>
<h2 id="8-Refactored-Constant-Support">8. Refactored Constant Support</h2>
<p>Last but not least is a feature that focuses on constant. Constants were one of the weakest parts of ConfigTransformer, with a lot of hacking. It was prone to error on non-existing or non-autoloaded constants, which should not happen as the scope of this tool is entirely static.</p>
<p>Again, big thanks to Tofandel, who <a href="https://github.com/symplify/symplify/pull/4246">refactorted it into a smooth solution</a>. It now handles any constant possible:</p>
<pre><code class="language-yaml">parameters:
    class_constant: !php/const App\SomeConst::TEST
    class: !php/const App\SomeConst::class
    unexisting_constant: !php/const App\MissingClass::NOT_HERE
    another_key: '%env(string:default::CODE_EDITOR)%'</code></pre>
<p>↓</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return static function (ContainerConfigurator $containerConfigurator): void {
    $parameters = $containerConfigurator-&gt;parameters();

    $parameters-&gt;set('class_constant', App\SomeConst::TEST);
    $parameters-&gt;set('class', App\SomeConst::class);
    $parameters-&gt;set('unexisting_constant', App\MissingClass::NOT_HERE);
    $parameters-&gt;set('another_key', '%env(string:default::CODE_EDITOR)%');
};</code></pre>
<p>As a bonus, it cut down the converting speed on one project from 3 seconds to 200 ms. That's <strong>1500 % faster</strong>.</p>
<p>Thank you ✅</p>
<p><br></p>
<h2 id="Start-Now-to-Save-Work">Start Now to Save Work</h2>
<p>I'm proud of this leap forward and better support for older Symfony versions. It allows to convert configs <strong>to a broader range of projects and start using PHP in earlier stages</strong>. That brings Rector, ECS, and PHPStan to help as well, as they cover any PHP file, even configs.</p>
<p>Now it's the best time to switch - <a href="/blog/2020/07/27/how-to-switch-from-yaml-xml-configs-to-php-today-with-migrify/">here is how</a></p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/8-news-in-config-transformer-that-converts-symfony-yml-to-php</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 18 Jul 2022 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/8-news-in-config-transformer-that-converts-symfony-yml-to-php#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Can PHPStan find Dead Public Methods? ]]></title>
                <link>https://tomasvotruba.com/blog/can-phpstan-find-dead-public-methods</link>
                <description><![CDATA[ <p>This bold question has been around PHP Internet for many years... <a href="https://stackoverflow.com/questions/11532/how-can-i-find-unused-functions-in-a-php-project">at least since 2008</a>. In 2017 I added <a href="https://github.com/symplify/symplify/pull/466">dead public method sniff</a> to Symplify Coding Standard.
<br><br>
It runs on bare PHP tokens without any type or AST, so the capability was limited. Yet it was able to detect a few unused methods. Now, 5 years later, we maybe have a better solution.</p> ]]></description>
                <content:encoded><![CDATA[ <p><a href="/blog/2019/03/14/remove-dead-public-methdos-from-your-code/">The sniff rule</a> looked for unused public method with very basic algorithm:</p>
<h3 id="1-Collect-all-Public-Methods">1. Collect all Public Methods</h3>
<pre><code class="language-php">public function speedUp()
{
}

public function slowDown()
{
}</code></pre>
<p>↓</p>
<ul>
<li><code>speedUp</code></li>
<li><code>slowDown</code></li>
</ul>
<p><br></p>
<h3 id="2-Collect-all-Method-Calls">2. Collect all Method Calls</h3>
<pre><code class="language-php">$someObject-&gt;speedUp();</code></pre>
<p>↓</p>
<ul>
<li><code>speedUp</code></li>
</ul>
<p><br></p>
<h3 id="3-Subtract-First-List-from-Second">3. Subtract First List from Second</h3>
<p>There we have a list of unused public methods:</p>
<ul>
<li><code>slowDown</code></li>
</ul>
<p><br></p>
<p>That's it!</p>
<p><br></p>
<p>This sniff helped to <a href="https://github.com/rectorphp/rector-src/commit/3ef5f555b729dfc7758043674c15ea2354af71f2">detect many dead methods</a>, but without types, it misses a few essential details:</p>
<pre><code class="language-php">class Car
{
    public function speedUp()
    {
    }
}</code></pre>
<pre><code class="language-php">class Bus
{
    public function speedUp()
    {
    }
}</code></pre>
<p>Like the same-name methods in 2 different classes. Even if only one is used, both are reported as used. Later <a href="/blog/2019/03/14/remove-dead-public-methods-from-your-code/">I've removed the rule</a>, because the token architecture is rather crappy, as you can see.</p>
<p><br></p>
<p>A week ago <a href="https://github.com/phpstan/phpstan/releases/tag/1.8.0">PHPStan 1.8</a> introduced similar feature, <a href="https://phpstan.org/developing-extensions/collectors">called collectors</a>.
The principle is simple:</p>
<ul>
<li>collect one group of data</li>
<li>collect another group of data</li>
<li>compare both groups and show the result</li>
</ul>
<p><br></p>
<p>I got excited and wanted to try this feature as soon as I had some free time.</p>
<p>Last week I made the first rule that detects unused public constants:</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">I'm roughly playing with new collectors from PHPStan 1.8 😇<br><br>This is how "unused public constant" is found ↓<a href="https://t.co/SkTCITcLh4">https://t.co/SkTCITcLh4</a> <a href="https://t.co/zt4yyq0Hmh">pic.twitter.com/zt4yyq0Hmh</a></p>— Tomas Votruba 🇺🇦 (@VotrubaT) <a href="https://twitter.com/VotrubaT/status/1542459395203911682?ref_src=twsrc%5Etfw">June 30, 2022</a></blockquote>
<p><br></p>
<p>Detecting constant call is relatively easy because there is always one exact class and constant name:</p>
<pre><code class="language-php">SomeClass::SOME_CONSTANT</code></pre>
<p><br></p>
<p>We've added rules to a few projects, and the results are fantastic.</p>
<p>How about trying the same approach to public methods?</p>
<p><br></p>
<h2 id="PHPStan-Collector-for-Unused-Method">PHPStan Collector for Unused Method</h2>
<p>With method calls, this is a bit complex, as caller type could be anything:</p>
<pre><code class="language-php">$value-&gt;speedUp(); // $value is mixed type

function run(?Car $value) {
    $value-&gt;speedUp(); // $value is null|Car
}

/** @var Car $value;
$value-&gt;speedUp(); // $value is probably Car</code></pre>
<p><br></p>
<p>I wanted to see how many false positives this rule will catch and try out collectors. Take this as a joyful learning experience.</p>
<p>To keep the rule simple and more reliable, I've narrowed the scope further down:</p>
<ul>
<li>skip static methods</li>
<li>skip protected methods</li>
<li>skip private methods</li>
<li>skip <code>Trait_</code> methods</li>
<li>skip <code>Enum</code> methods</li>
<li>skip <code>Interface</code> methods</li>
<li>skip methods overriding parent class</li>
<li>skip methods required by an interface</li>
<li>skip methods that have <code>@api</code> annotation</li>
<li>skip methods that has a class with <code>@api</code> annotation</li>
<li>skip methods in PHPUnit test case</li>
<li>skip methods with an attribute</li>
</ul>
<pre><code class="language-php">#[Required]
public function autowire(...)
{
    // ...
}

#[Inject]
public function inject(....)
{
    // ...
}</code></pre>
<p><br></p>
<p>Are you maintaining an open-source project? Do you have a method that is never called but is designed for external use? Mark it with <code>@api</code> to make clear the method is for devs to use. The rule will skip it then.</p>
<h2 id="Use-at-Your-Own-Risk">Use at Your Own Risk</h2>
<p>I've prototyped <a href="https://github.com/symplify/symplify/pull/4195">the <code>UnusedPublicClassMethodRule</code> rule</a>. In PR, you'll find both collectors for public methods, their calls, and the rule that compares them both. The test included, of course. Do you want to build a collector of your own? I recommend checking it out and mimicking behavior.</p>
<p><br></p>
<p>Are you willing to try this rule on your code base? Even if there will be false positives?</p>
<p>You've been warned. There you go...</p>
<pre><code class="language-bash">composer require symplify/phpstan-rules --dev</code></pre>
<p><br></p>
<p>Register rule with both collectors to <code>phpstan.neon</code>:</p>
<pre><code class="language-neon">rules:
    - Symplify\PHPStanRules\DeadCode\UnusedPublicClassMethodRule

services:
    -
        class: Symplify\PHPStanRules\Collector\ClassMethod\PublicClassMethodCollector
        tags:
            - phpstan.collector

    -
        class: Symplify\PHPStanRules\Collector\ClassMethod\MethodCallCollector
        tags:
            - phpstan.collector</code></pre>
<p>Run PHPStan and see the results.</p>
<p>Do you have a tip to improve this rule or architecture? It's my 2nd collector rule, and it has flaws in the design, so don't hesitate and share it in the comments so that I can improve it. Thank you, good luck, and have fun!</p>
<p><br></p>
<p>Happy coding!</p>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/can-phpstan-find-dead-public-methods</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 04 Jul 2022 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/can-phpstan-find-dead-public-methods#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Twig Smoke Rendering - Fortune Favors the Bold ]]></title>
                <link>https://tomasvotruba.com/blog/twig-smoke-rendering-fortune-favors-the-bold</link>
                <description><![CDATA[ <p>In the previous post, we set on <a href="/blog/twig-smoke-rendering-journey-of-fails">journey of fails</a> with ups and downs. Well, mostly downs. I'm trying to be honest about the blind path process behind the final published work.
<br><br>
We made it through heaven and hell. Now we're rested and back to continue. Can we smoke render twig templates, or shall we give up?</p> ]]></description>
                <content:encoded><![CDATA[ <p>After 5 challenging steps we made last time, we need to recharge our fuel. This episode will be more relaxing and more fun.</p>
<p><br></p>
<h2 id="6-Way-Too-Tolerant-Constants">6. Way Too Tolerant Constants</h2>
<p>Do you use constants in your TWIG files? Then you've come across this issue:</p>
<pre><code class="language-twig">{{ constant("YourneyPath::WOODS") }}</code></pre>
<p>This filter <a href="https://github.com/twigphp/Twig/blob/760341fa8c41c764a5a819a31deb3c5ad66befb1/src/Extension/CoreExtension.php#L1369">calls native <code>constant()</code> function</a>.</p>
<p><br></p>
<p>Few years later, we rename the  constant in the <code>YourneyPath</code> class:</p>
<pre><code class="language-diff"> final class YourneyPath
 {
-    const WOODS = 'woods;
+    const FOREST = 'forest;
 }</code></pre>
<p>We trust the IDE to handle renames for us, so we will not check any other files or templates.</p>
<p><br></p>
<p>Since PHP 8.0, we would get a Fatal error on missing constant, but <a href="https://3v4l.org/NMPXC">PHP 7.4 and bellow is only warning</a> 🚫</p>
<p><br></p>
<p><strong>How do we make the <code>constant()</code> filter strictly on lower PHP versions?</strong></p>
<p>In the same way, we made filters/functions input tolerant. We add a modified filter:</p>
<pre><code class="language-php">$constantFunction = new TwigFunction('constant', function ($constant) {
    if (defined($constant) === false) {
        throw new \Exception(sprintf('Constant "%s" not found', $constant));
    }

    return constant($constant);
}));</code></pre>
<p><br></p>
<p>Now we carefully catch any missing constant on any TWIG and PHP version.</p>
<img src="/assets/images/posts/2022/frodo_and_sam.jpg" class="img-thumbnail" style="max-width: 30em">
<h2 id="">✅</h2>
<p><br></p>
<h2 id="7-Where-is-the-Form">7. Where is the Form?</h2>
<p>We have covered functions, filters, and variables. Now, most edge-cases <strong>depends on the specific features you use from TWIG</strong>.</p>
<p>In our case, there is one feature that will throw us a curve ball:</p>
<pre><code class="language-twig">{% form_theme form "some_theme.twig" %}</code></pre>
<p>What is this element?</p>
<p><br></p>
<p>It's pretty hard to Google, but in the end, we found out it's a &quot;token parser&quot;. It's a <strong>way to parse TWIG syntax between <code>{% ... %}</code></strong> to native PHP code. This <em>token</em> is called &quot;form_theme&quot; and sets a style theme only for the current form.</p>
<p><br></p>
<p>When we run this part of the code, we get an error:</p>
<pre><code class="language-bash">The "form" variable is missing</code></pre>
<p><br></p>
<h2 id="Faking-Token-Parser">Faking Token Parser?</h2>
<p>We tried to <strong>replace</strong> <a href="https://twig.symfony.com/doc/2.x/advanced.html#defining-a-token-parser"><strong>token parser according</strong> to Twig Documentation</a>, but failed.</p>
<p>In the end, we realized we use a <code>$form</code> variable as a name for any form. There was no other name used, and templates were perfectly isolated from each other. We come up with the simple solution of adding a simple form:</p>
<pre><code class="language-php">use Symfony\Component\Form\AbstractType;
use Symfony\Component\Form\Extension\Core\Type\TextType;
use Symfony\Component\Form\FormBuilderInterface;

final class SimpleFormType extends AbstractType
{
    public function buildForm(FormBuilderInterface $formBuilder, array $options)
    {
        $formBuilder-&gt;add('name', TextType::class);
    }
}</code></pre>
<p><br></p>
<p>Then we provide it the render method by default:</p>
<pre><code class="language-php">$simpleFormType = $this-&gt;formFactory-&gt;create(SimpleFormType::class);
$context['form'] = $simpleFormType-&gt;createView();

$environment-&gt;render($templateName, $context);</code></pre>
<p>It feels a bit hacky, but it works, and we can control our form easily without pre-parsing the templates with regexes.</p>
<p><br></p>
<h2 id="">✅</h2>
<p><br></p>
<h2 id="Fortune-Favors-the-Bold">Fortune Favors the Bold</h2>
<p>After 2 weeks of hard work, but mainly counter-intuitive thinking and countless mad experiments, we have <strong>a working tool that can smoke parse any of 200 template files we have</strong> in 2 seconds:</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">We've just added our latest toy to CI😋 with ✅<br><br>Tolerant <a href="https://twitter.com/hashtag/twig?src=hash&amp;ref_src=twsrc%5Etfw">#twig</a> renderer 🎉🎉🎉<br><br>* covers all TWIG files<br>* dynamic rendering<br>* finds non-existing filters + functions + tags<br>* even wrong constants!<br>* blazing fast ⚡️<br>* no php-parser, no magic transform<br>* fun to make 😎 <a href="https://t.co/5H8iXVNyGS">pic.twitter.com/5H8iXVNyGS</a></p>— Tomas Votruba 🇺🇦 (@VotrubaT) <a href="https://twitter.com/VotrubaT/status/1540004210888040452?ref_src=twsrc%5Etfw">June 23, 2022</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p><br></p>
<p>Based on this 3-post series, you can build your own tailored TWIG, Latte, or Blade Smoke Renderer. It might not be easy at the start, but if you make it, <strong>you'll enjoy sweet fruits</strong>.</p>
<p><br></p>
<h2 id="Believe-in-Yourself">Believe in Yourself</h2>
<p>Next time there is a challenge that presents itself, it will look as impossible, crazy, and weird. Think about it differently, be naive, even crazy. Take on your journey; believe you can make it, and you will.</p>
<img src="/assets/images/posts/2022/frodo_end.jpg" class="img-thumbnail" style="max-width: 30em">
<p>These experiences are priceless stories to share.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/twig-smoke-rendering-fortune-favors-the-bold</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 27 Jun 2022 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/twig-smoke-rendering-fortune-favors-the-bold#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Twig Smoke Rendering - Journey of Fails ]]></title>
                <link>https://tomasvotruba.com/blog/twig-smoke-rendering-journey-of-fails</link>
                <description><![CDATA[ <p>In previous post, we explored <a href="/blog/twig-smoke-rendering-why-do-we-even-need-it">the &quot;whys&quot; for Twig Smoke Rendering</a>.
<br><br>
Today we will set on the journey towards this tool and mainly. Get ready for failure, demotivation, and despair. As with every new invention, the fuel can make us faster or burn us to death.</p> ]]></description>
                <content:encoded><![CDATA[ <p>How did we define the goal of twig smoke rendering? We want to render any template and validate the code, and its context works. To start, let's look at this first simple <code>homepage.twig</code> template:</p>
<pre><code class="language-twig">{% include "snippet/menu.twig" %}

{% for item in items %}
    {{ item }}
{% endfor %}</code></pre>
<p><br></p>
<p>That's the goal. What is our starting point? The typical render we know is from a Symfony controller will process the template like this:</p>
<ul>
<li>include the <code>snippet/menu.twig</code> loaded in TWIG loaders</li>
<li>render it to HTML</li>
<li>iterates the <code>$items</code> array and renders each item to string</li>
</ul>
<h2 id="1-Naive-Render-First">1. Naive Render First</h2>
<p>This journey will be very long, so we have to save as much energy as possible. Before we use the brain for thinking, let's approach the code naively. Maybe <a href="https://fourweekmba.com/occams-razor/">the most straightforward solution will work</a> right from the start.</p>
<p><br></p>
<p>First, we prepare a minimal setup of the TWIG environment with a template loader:</p>
<pre><code class="language-php">use Twig\Environment;
use Twig\Loader\ArrayLoader;

// here we load the "homepage.twig" template and all the TWIG files in our project
$loader = new ArrayLoader(['homepage.twig']);

$twigEnvironment = new Environment($loader);
$twigEnvironment-&gt;render('homepage.twig');</code></pre>
<p>We run the code... any guess what happens?</p>
<p><br></p>
<h2 id="2-There-is-No-Variable">2. There is No Variable</h2>
<img src="/assets/images/posts/2022/there_is_no_spoon.jpg" class="img-thumbnail" style="max-width: 18em">
<p>First, we get an error on the non-existing <code>$items</code> variable 🚫</p>
<p><br></p>
<p>Did we forget to provide it? There is an easy fix for that. We see the template is foreaching an array of strings. Let's pass some made-up value as 2nd parameter:</p>
<pre><code class="language-php">$twigEnvironment-&gt;render('homepage.twig', [
    'items' =&gt; ['first', 'second'],
]);</code></pre>
<p>We re-run... and it works!</p>
<p><br></p>
<h2 id="Lure-of-Manual-Thinking">Lure of Manual Thinking</h2>
<p>We made a single little template to render correctly. At the same time, we also made a massive step back from any attempt to automate the process. We've just <strong>used our brain for static analysis</strong>:</p>
<ul>
<li>we looked into the code with our eyes,</li>
<li>we deduce from the <code>for</code> tag called on <code>$items</code> that the value is an <code>array</code></li>
<li>we deduced from writing the <code>item</code> to the output that it is an array of strings.</li>
</ul>
<p>It is correct, but how long will it take us for all 3214 variables in all our templates? 🚫</p>
<p><br></p>
<p>This solution is not generic, and without us, the CI would fail. The CI has to run without any intervention, <strong>the same way we raise an adult from our child</strong>. First, we can feed them manually, but in the long term, we should teach them how to use their hands, what food is, and how to get and eat it.</p>
<p><br></p>
<p>The <code>render()</code> has to <strong>run generically without variables</strong> . How? Thanks to <a href="https://twitter.com/alex_s_/status/1537030374651572225">Alexandr for the rescue</a>. Twig has an option to disable check for variable existence:</p>
<pre><code class="language-php">$twigEnvironment = new Twig\Environment($loader, [
    'strict_variables' =&gt; false
]);
$twigEnvironment-&gt;render('homepage.twig');</code></pre>
<p>Now we re-run the test... and <strong>it works</strong> precisely as we need to!</p>
<h2 id="">✅</h2>
<p><br></p>
<h2 id="3-Without-Variables-There-is-no-Type">3. Without Variables, There is no Type</h2>
<img src="/assets/images/posts/2022/there_is_no_spoon.jpg" class="img-thumbnail" style="max-width: 18em">
<p><br></p>
<p>The variables are missing, but we can still render the file. That's fantastic!</p>
<p>Well, until we use a filter or function:</p>
<pre><code class="language-twig">{{ login_name|length }}</code></pre>
<p>The <code>$login_name</code> is not there, but the filter/function still needs an argument 🚫.</p>
<p>Ironically, if we care about code quality and strict type declaration, it is even worse. Filter <strong>needs an argument of specific type</strong>. The filter expects a <code>string</code> argument but gets <code>null</code>—a fatal error 🚫</p>
<p><br></p>
<p>What can we do about it?</p>
<ul>
<li>Remove all filters and functions?</li>
<li>Use regex to strip them away from the template, then render it?</li>
</ul>
<p>That will turn into crazy regex depression, or we will remove too many templates from the analysis. Nothing will work.</p>
<p><br></p>
<p><strong>At this moment, I'm seriously doomed</strong>. This <em>great excellent idea</em> to make an automated command is falling apart. We still have to provide all the variables in the templates.</p>
<p><br></p>
<p>There is this moment in every journey towards automation that hasn't been done before. The moment you stop and think - &quot;Is this worth it? Is this even possible? Should I turn to manual work and accept the risk of a bug? Should I lick my wounds and give up?&quot;</p>
<img src="/assets/images/posts/2022/frodo_give_up.jpg" class="img-thumbnail" style="max-width: 30em">
<p><br></p>
<h3 id="Let-s-Take-a-Break-and-Think-Different">Let's Take a Break and Think Different</h3>
<p>Hm, what if we could emulate something like the <code>'strict_variables'</code> option, just on another level. No idea how to do that.</p>
<blockquote class="blockquote text-center">
    "A big win is a summary of many small improvements."
</blockquote>
<p>Let's list what we already know and work with:</p>
<ul>
<li>We accept the filter/function must exist, and that's ok.</li>
<li>We know it has to accept any number and types of arguments.</li>
<li>We know they're just simple callbacks:</li>
</ul>
<pre><code class="language-php">new TwigFunction('form_label', function ($value) {
    // ...
});</code></pre>
<p><br></p>
<h2 id="4-Faking-Tolerant-Functions-Filters">4. Faking Tolerant Functions/Filters</h2>
<p>Those callbacks are defined and tight to a filter/function name. If we know the filter name, we can override and make it <strong>tolerant to any input</strong>:</p>
<pre><code class="language-diff">-return new TwigFunction('form_label', function ($value) {
+return new TwigFunction('form_label', function () {
     // ...
 });</code></pre>
<p><br></p>
<p>Let's give it a try:</p>
<pre><code class="language-php">$environment-&gt;addFunction(new TwigFunction('form_label', function () {
    return '';
}));</code></pre>
<p><br></p>
<p>Hm, it has already defined the <code>form_label</code> function... and crashes 🚫</p>
<p><br></p>
<p>Twig has an immutable extension design. Once it loads functions/filters, we cannot override it. I&nbsp;love this design because we know the <code>join</code> function will be the same and never change. But <strong>how do we change an immutable object</strong>? 🚫</p>
<img src="/assets/images/posts/2022/frodo_and_troll.jpg" class="img-thumbnail" style="max-width: 30em">
<p><strong>More despair</strong> is coming... is this all waste of time? Should we give up?</p>
<p><br></p>
<h3 id="We-got-Beaten">We got Beaten...</h3>
<img src="/assets/images/posts/2022/gandalf_beaten.jpg" class="img-thumbnail">
<p>...but we're not dead.</p>
<p><br></p>
<p>Let's step back. What else can we do? The filter/function cannot be changed once loaded. Maybe we could fake custom twig extensions that would get loaded instead of the core ones?</p>
<p>But we would have to <strong>be responsible for manual work listing all the extensions</strong>, functions, and filters from the core - e.g., CoreExtension, FormExtension, etc. 🚫</p>
<p><br></p>
<p>There must be some better way.</p>
<p>The environment is locked and protected from change, but it must have been writable at the start. Otherwise, the TWIG would not have the core functions and filters. That means <strong>there must be some lock mechanism</strong>. Like entity manager from Doctrine has. If we can unlock entity manager, we can un this.... new plan is getting shape:</p>
<ul>
<li>we have to open the lock</li>
<li>detect core filter/function names</li>
<li>add them with tolerant closures</li>
<li>that's it!</li>
</ul>
<p><br></p>
<p>That's the basic plan. We tried to apply it in one project... and it worked! After 2 more days of struggle, we polished it to a working state. Now we can render a TWIG file with variables, functions, and filters, and it will pass!</p>
<h2 id="">✅</h2>
<p><br></p>
<h2 id="5-Check-for-Existing-Filters-and-Functions-out-of-the-Box">5. Check for Existing Filters and Functions out of the Box</h2>
<blockquote class="blockquote text-center">
    "When we find ourselves in times of troubles,
    <br>
    it is time to always look on the bright side of life."
</blockquote>
<p>This achievement moves us light years ahead. The rendering checks filters/functions by default. Variables don't have to exist, but filters are still run on them. That way, we will know 3 invalid states that can happen to filter/function:</p>
<ul>
<li>if <strong>template uses filter/function that does not exist</strong> we will know about it ✅</li>
<li>if the filter exists in PHP code, but <strong>extensions are not loaded for missing tag</strong>, we will know about it ✅</li>
<li>if the filter exists, the extension is loaded, but the <strong>array closure is missing</strong>, we will know about it ✅</li>
</ul>
<pre><code class="language-php">return [
    new TwigFunction('some_function', [$this, 'some_method']);
];

// ... no "some_method" found here</code></pre>
<h2 id="">✅</h2>
<p><br></p>
<p>We're getting close, but it still does not run in CI 🚫</p>
<p><br></p>
<p>Will we make it to the glory, or will we give up and walk in shame? Stay tuned for the next episode to find out.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/twig-smoke-rendering-journey-of-fails</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 20 Jun 2022 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/twig-smoke-rendering-journey-of-fails#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Twig Smoke Rendering - Why do we Even Need it? ]]></title>
                <link>https://tomasvotruba.com/blog/twig-smoke-rendering-why-do-we-even-need-it</link>
                <description><![CDATA[ <p>Two weeks ago <a href="https://getrector.org/for-companies">our upgrade team started</a> to upgrade Twig 1 to 2 and Latte 2 to 3 for two clients. There was no test that covers the templates, just a few integration ones that might have invoked a few % of happy paths render. Not good enough.
<br><br>
We <strong>need a CI test to be sure</strong> templates are working. I had an initial idea, but knowing the value of external input, I asked on <a href="https://twitter.com/VotrubaT/status/1537029650379116544">Twitter for brainstorming</a>. I'm happy I did. Alexander Schranz came with <a href="https://twitter.com/alex_s_/status/1537030374651572225">a tip</a> that led me on a 2-week journey, and I would love to share it with you today.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Why-do-we-need-Smoke-Render-all-Templates">Why do we need Smoke Render all Templates?</h2>
<p>First, let me tell you about the <strong>3 reasons</strong> why we need smoke-render all TWIG templates:</p>
<p><br></p>
<ol>
<li>Twig 1 and 2 contains a few BC breaks. Not only in Twig itself but also in related Twig Bundle. We're not interested in the complete list of BC breaks, but rather <strong>if they break our templates</strong> and <strong>where exactly</strong>.</li>
</ol>
<p><br></p>
<ol start="2">
<li>We need to render templates directly, without controllers and variables. The controller renders only a specific path. Based on variables, it can include one template snippet but forget the other:</li>
</ol>
<pre><code class="language-twig">{% if value %}
    {% include 'snippet/first_option.twig' %}
{% else %}
    {% include 'snippet/second_option.twig' %}
{% endif %}</code></pre>
<p><br></p>
<ol start="3">
<li>We must ensure all the functions, filters, and constants exist. What if the <code>join</code> filter was removed and replaced by <code>implode</code>? This is also useful for <a href="/blog/stamp-static-analysis-of-templates/">static analysis of templates</a>.</li>
</ol>
<p><br></p>
<p>The smoke rendering means &quot;test that everything works&quot;. Render template and expect valid HTML. Not a file by file, test by test, but all TWIG files we can find in the project in a single test run. It could look like this:</p>
<pre><code class="language-bash">bin/console twig-smoke-render templates</code></pre>
<h3 id="Why-not-use-the-TWIG-Lint-command">Why not use the TWIG Lint command?</h3>
<p>You might think: &quot;but Tomas, Symfony is already doing that for you&quot;:</p>
<pre><code class="language-bash">bin/console lint:twig templates</code></pre>
<p>That could work if we care about syntax errors like <code>{{ value }</code>. But we care about more than bare language syntax. We care about meaning and context:</p>
<ul>
<li>variable types,</li>
<li>filter/functions/constant existence,</li>
<li>include of layout and snippet templates.</li>
</ul>
<p>That's why we don't use only <code>php -l</code>, but also PHPStan to check PHP code with context.</p>
<p><br>
<br></p>
<p>Now we have a Goal of Doom and a team of <em>why</em>s.</p>
<p>We're ready to set on the journey!</p>
<img src="/assets/images/posts/2022/fellowship.jpg" class="img-thumbnail">
<p><br></p>
<p>To be continued...</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/twig-smoke-rendering-why-do-we-even-need-it</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 13 Jun 2022 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/twig-smoke-rendering-why-do-we-even-need-it#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 5 Pitfalls of Upgrade to Native PHP Enums and How to Avoid Them ]]></title>
                <link>https://tomasvotruba.com/blog/five-pitfalls-of-upgrade-to-native-php-enums-and-how-to-avoid-them</link>
                <description><![CDATA[ <p>Native PHP Enums came almost a year ago in PHP 8.1. It's pretty easy to add a new enum. But how do we handle the old hacks we used to use before enums were legal in PHP land? MyCLabs, Spatie, or constants list.
<br><br>
Today we'll upgrade them all. Is it a simple constant to enum replace? Surprisingly, there are <strong>few blind paths we have to be aware of</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="The-MyClabs-or-Spatie-Early-Access">The MyClabs or Spatie Early Access</h2>
<p>Before PHP 8.1, the best way to get enums to a code base was to use <a href="https://github.com/spatie/enum">Spatie</a> or <a href="https://github.com/myclabs/php-enum">MyClabs</a> packages. They provided an abstract class, <code>Enum</code>, that provided a set of methods to validate used constants. These constants could be public or faked as static methods:</p>
<pre><code class="language-php">use Spatie\Enum\Enum;
// or
// use MyCLabs\Enum\Enum;

/**
 * @method static self draft()
 * @method static self published()
 */
final class PostStatusEnum extends Enum
{
}</code></pre>
<p>We can also use a different approach for refactoring from &quot;enums&quot; from entities called constant list. It's &quot;enums for poor people&quot; that do not depend on any 3rd party package:</p>
<pre><code class="language-php">final class PostStatusEnum
{
    public const DRAFT = 'draft';

    public const PUBLISHED = 'published';
}</code></pre>
<p>The class has different parent classes, but the way we use them is identical.
Let's dive into 5 pitfalls of upgrade to native enums. It is basically just 2 patterns to be careful about, but 5 places they can go wrong. If we miss just one of them, the whole upgrade can collapse. Let's dive in and get through.</p>
<p><br></p>
<p>Let's say we have a <code>Post</code> class with <code>getStatus()</code> method. In the project, we use the &quot;constant static call&quot; fake to compare the value with post status:</p>
<pre><code class="language-php">if ($post-&gt;getStatus() === Post::DRAFT()) {
   echo 'Not yet published';
}</code></pre>
<p><br></p>
<h3 id="Pre-enum-to-Enum">Pre-enum to Enum?</h3>
<p>How should we upgrade this comparison to native PHP enums?</p>
<pre><code class="language-diff">-($post-&gt;getStatus() === Post::DRAFT()) {
+($post-&gt;getStatus() === Post::DRAFT) {</code></pre>
<p>Is it correct? From this code of view, it is. But what does the <code>getStatus()</code> method return?</p>
<h2 id="Pitfall-1-Method-Return-Types">Pitfall #1: Method Return Types</h2>
<p>We upgraded the comparison above; now it's time to look at the <code>getStatus()</code> method.</p>
<p>It's a common standard that the &quot;pre-enum&quot; value is just a lowercased enum value. Method and constant can be written only as string, so the type is usually a <code>string</code>. If we use this convention, we could use it as a return type, right?</p>
<pre><code class="language-php">final class Post
{
    // ...

    public function getStatus(): string
    {
        return $this-&gt;status;
    }
}</code></pre>
<p>This is technically correct but far from being helpful or domain correct. To define post status, we use an enum with exactly 2 values - &quot;draft&quot; and &quot;published&quot;. But all we require here is any <code>string</code> type. Imagine all the words you could put into Google.</p>
<p><br></p>
<p>Instead, we should make it explicit, <strong>this method only returns these 2 constants</strong>.</p>
<p>How? Fortunately, we have static analysis tools that solve precisely this case:</p>
<pre><code class="language-php">    /**
     * @return Status::DRAFT|Status::PUBLISHED
     */
    public function getStatus(): string
    {
        return $this-&gt;status;
    }</code></pre>
<p><br></p>
<p><strong>Now the PHPStan and Rector know</strong>, the return type of <code>getStatus()</code> has only 2 exact values. If we add new status in the future, we'd have to extend all docblocks everywhere. That's wasted time and space for bugs.</p>
<p><br></p>
<p>Instead, we can use the shortcut that stands for all &quot;pre-enum&quot; values available:</p>
<pre><code class="language-php">    /**
     * @return Status::*
     */
    public function getStatus(): string
    {
        return $this-&gt;status;
    }</code></pre>
<p>Now the PHPStan knows the exact type of this return is one of the enums.</p>
<h3 id="Pre-enum-to-Enum">Pre-enum to Enum?</h3>
<p>If PHPStan knowns it, now it's easy to upgrade:</p>
<pre><code class="language-diff">-    /**
-     * @return Status::*
-     */
-    public function getStatus(): string
+    public function getStatus(): Status
     {
         return $this-&gt;status;
     }</code></pre>
<p>👍</p>
<p>This way, you can use PHPStan and Rector rules to automate your upgrade.</p>
<p><br></p>
<p>But not only that, but it also <strong>gives you code narrow context that can propagate to other calls</strong>. Even if you stay on PHP 8.0 and won't use enums, your code base still benefits from enum-like::* types:</p>
<pre><code class="language-php">$copyPost-&gt;changeStatus($post-&gt;getStatus());</code></pre>
<p><br></p>
<p>What is the param of the <code>changeStatus()</code> method?</p>
<h2 id="Pitfall-2-Method-Param-Types">Pitfall #2: Method Param Types</h2>
<p>This is similar to the previous case, just in param types:</p>
<pre><code class="language-php">final class Post
{
    public function changeStatus(string $status)
    {
        $this-&gt;status = $status;
    }
}</code></pre>
<p><br></p>
<p>Here, we again know the status is not just a <code>string</code> but one of the provided constants. Let's put this knowledge into the code:</p>
<pre><code class="language-php">    /**
     * @param Status::* $status
     */
    public function changeStatus(string $status)
    {
        $this-&gt;status = $status;
    }
}</code></pre>
<p>👍</p>
<h3 id="Pre-enum-to-Enum">Pre-enum to Enum?</h3>
<p>To upgrade param, just inline the param docblock to param type declaration:</p>
<pre><code class="language-diff">-   /**
-    * @param Status::* $status
-    */
-   public function changeStatus(string $status)
+   public function changeStatus(Status $status)
    {
        $this-&gt;status = $status;
    }
}</code></pre>
<p><br></p>
<h2 id="Pitfall-3-Property-Type">Pitfall #3: Property Type</h2>
<p>Last but not least, the getter and changer methods have one thing in common. They access a property:</p>
<pre><code class="language-php">final class Post
{
    /**
     * @var string
     */
    private $status;
}</code></pre>
<p><br></p>
<p>We know the status is not a string but one of the enum-like values:</p>
<pre><code class="language-php">final class Post
{
    /**
     * @var Status::*|null
     */
    private string|null $status = null;
}</code></pre>
<p>👍</p>
<h3 id="Pre-enum-to-Enum">Pre-enum to Enum?</h3>
<p>By now, you probably know the upgrade path by heart:</p>
<pre><code class="language-diff"> final class Post
 {
-    /**
-     * @var Status::*|null
-     */
-    private string|null $status = null;
+    private Status|null $status = null;
}</code></pre>
<p><br></p>
<h2 id="Pitfall-4-Input-Boundary">Pitfall #4: Input Boundary</h2>
<p>The post has status value, and we can now use it safely in the whole PHP code base. Setters, getters, and property types are covered. Are we finished with the upgrade? Depends. How can we upgrade this method?</p>
<pre><code class="language-php">final class PostController
{
    /**
     * @param Status::* $status
     */
    public function actionPostList(string $status)
    {
        // ...
    }
}</code></pre>
<p><br></p>
<p>We've upgraded param types before. Let's apply the same approach here:</p>
<pre><code class="language-diff">-   /**
-    * @param Status::* $status
-    */
-   public function actionPostList(string $status)
+   public function actionPostList(Status $status)
    {
        // ...
    }</code></pre>
<p><br></p>
<p>We refresh the <code>/post/post-list/?status=draft</code> page and... the controller action crashes. The param takes the &quot;draft&quot; string value, but the method expects a <code>Status</code> enum.</p>
<h3 id="Pre-enum-to-Enum">Pre-enum to Enum?</h3>
<p>It depends on the framework you use, of course. In the future, we expect Symfony param converter, which will similarly handle these cases <a href="https://github.com/Ex3v/MyCLabsEnumParamConverter">it handled myclabs/enums</a>.</p>
<p>But for now, we have to <strong>convert the scalar value</strong> to enum:</p>
<pre><code class="language-php">    /**
     * @param Status::* $status
     */
    public function actionPostList(string $status)
    {
        $status = Status::from($status);
        // ...
    }</code></pre>
<p>👍</p>
<p><br></p>
<p>We must approach input values <strong>with the same care as REST API calls</strong>.
In the same way, we convert API scalar values from scalar to value objects; we have to convert string/integer values to enums.</p>
<p><br></p>
<h2 id="Pitfall-5-Output-Boundary">Pitfall #5: Output Boundary</h2>
<p>Before I publish this post, I prepare a draft to review and save it (to a GitHub pull request):</p>
<pre><code class="language-php">$post = new Post('Five Pitfalls of Upgrade to native PHP Enums', Status::DRAFT);
$this-&gt;postRepository-&gt;save($post);</code></pre>
<p><br></p>
<p>It will be published only after review and Grammarly checks.</p>
<p>We have a title, enum, and strictly typed param, property, and return types. Everything work on our side... but <strong>how do
our external storage handle enums</strong>? We talk about databases.</p>
<p><br></p>
<h3 id="Pre-enum-to-Enum">Pre-enum to Enum?</h3>
<p>Doctrine entities support enums <a href="https://www.doctrine-project.org/2022/01/11/orm-2.11.html">since <code>doctrine/orm</code> 2.11</a>. All we have to do is to upgrade the type to <code>enumType</code>:</p>
<pre><code class="language-diff"> use Doctrine\ORM\Mapping\Entity;
 use Doctrine\ORM\Mapping\Column;

 #[Entity]
 final class Post
 {
-    #[Column(type: 'string')]
+    #[Column(type: 'string', enumType: Status::class)]
     private $status;
 }</code></pre>
<p>👍</p>
<p><br></p>
<p>In case of different ORM or database layers, check &quot;enum support&quot; in the package documentation.</p>
<p><br></p>
<h2 id="Automate-with-Rector-and-Prepare-for-Future-with-PHPStan">Automate with Rector and Prepare for Future with PHPStan</h2>
<p>Check Rector rules, that handles <a href="https://github.com/rectorphp/rector/blob/main/docs/rector_rules_overview.md#spatieenumclasstoenumrector">Spatie enum class</a> and <a href="https://github.com/rectorphp/rector/blob/main/docs/rector_rules_overview.md#myclabsclasstoenumrector">MyClabs enum class</a>. Do you use constant lists? <a href="https://github.com/rectorphp/rector/blob/main/docs/rector_rules_overview.md#constantlistclasstoenumrector">Rector covers them too</a>.</p>
<p><br></p>
<p><strong>Are you stuck on PHP 8.0</strong> for a while? Get your code-base strict and ready <a href="https://phpstan.org/writing-php-code/phpdoc-types#literals-and-constants">with PHPStan enum-like <code>type::*</code></a>. Your future upgrade will be a piece of cake, and the types you pass around will shine bright with <strong>narrow context</strong>.</p>
<hr />
<p>Have you come across different problems? Let me know in the comments so we can learn together.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/five-pitfalls-of-upgrade-to-native-php-enums-and-how-to-avoid-them</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 06 Jun 2022 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/five-pitfalls-of-upgrade-to-native-php-enums-and-how-to-avoid-them#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Make Configs like RectorConfig or ECSConfig for your Symfony Project ]]></title>
                <link>https://tomasvotruba.com/blog/how-to-make-configs-like-rector-config-or-ecs-config-for-your-symfony-project</link>
                <description><![CDATA[ <p>We've introduced a new way to configure PHP tools on Symfony DI. A way that is decoupled brings new methods with autocomplete and validates your input. I talk about <a href="https://getrector.org/blog/new-in-rector-012-introducing-rector-config-with-autocomplete">RectorConfig</a> and <a href="https://tomasvotruba.com/blog/new-in-ecs-simpler-config/">ECSConfig</a>.
<br><br>
At first, I thought it was not possible. Symfony is very strict about this and does not allow any extensions. After a few days of hacking Symfony, I found a space to squash <code>&lt;x&gt;Config</code> class. After meeting with <a href="https://twitter.com/schreiberten">Sebastian Schreiber</a> last week, we found an even better generic solution.
<br><br>
Are you interested in a better developer experience for your Symfony project? Keep reading.</p> ]]></description>
                <content:encoded><![CDATA[ <p>This is <code>ECSConfig</code> in action:</p>
<img src="/assets/images/posts/2022/ecs_config.gif" class="img-thumbnail">
<p><br></p>
<h2 id="What-is-Good-For">What is Good For?</h2>
<h3 id="1-Isolate-from-Framework">1. Isolate from Framework</h3>
<p>This is very important for projects like <a href="https://getrector.org/">Rector</a> or <a href="https://github.com/symplify/easy-coding-standard/">ECS</a>, as you'll use them to analyze or refactor code that uses Symfony.</p>
<p><br></p>
<p>You can have 2 classes with the same <code>Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator</code> name but different return types or event methods:</p>
<ul>
<li>an ECS class in Symfony 6.0</li>
<li>your project class in Symfony 5.0</li>
</ul>
<p>The autoload will get confused, and your project <a href="https://github.com/rectorphp/rector/issues/6698">will crash</a>. Config class in <strong>your namespace prevents this</strong>.</p>
<h3 id="2-Add-own-Config-Methods-with-Instant-Validation">2. Add own Config Methods with Instant Validation</h3>
<p>This is a significant side effect from a developer experience point of view. We can still add parameters and services with the bare <code>ContainerConfigurator</code> class. But <strong>what about domain specifics</strong>? E.g., In Rector, we want to register rules and run them on specific paths:</p>
<pre><code class="language-php">use Rector\Config\RectorConfig;
use Rector\Php74\Rector\Closure\ClosureToArrowFunctionRector;

return static function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;paths([
        __DIR__.'/src',
    ]);

    $rectorConfig-&gt;rule(ClosureToArrowFunctionRector::class);
};</code></pre>
<p><br></p>
<p>Here we have <strong>2 domain-specific</strong> methods tailored to our developer needs:</p>
<ul>
<li>
<p>We wrote a <code>paths()</code> method that validates provided directory exists. That way, we know about typos or incorrect nesting right in the first second.</p>
</li>
<li>
<p>As for the <code>rule()</code> method, we can validate the class exists and that its type is <code>RectorInterface</code>. Such validation can prevent passing non-existing classes that Symfony silently skips.</p>
</li>
</ul>
<h3 id="3-Narrow-Context-to-Narrow-Focus">3. Narrow Context to Narrow Focus</h3>
<p>If we explore all Symfony config features like <code>autowire()</code>, <code>parameters()</code>, or autodiscovery, we'll slowly drift away. When we're driving a car, we should not try to check what cylinder has gasoline and which is exploding. Too much complexity will make our driving distracted and make it easier to crash.</p>
<p>We should provide <strong>focus by design</strong>. Does your tool generate a static blog? Add <code>sourcePath()</code> and <code>outputPath()</code> methods. Do you work with real-time stats of cryptocurrencies? Create <code>watchCurrencies([...])</code> method to list currencies to watch, etc.</p>
<p>With the exact 3 methods of simple scalar arguments, <strong>your users know what to do</strong>.</p>
<p><br></p>
<h2 id="How-to-teach-Symfony-to-work-with-our-Custom-Config">How to teach Symfony to work with our Custom Config?</h2>
<p>Let's try to implement such a config class from scratch, e.g., for a cryptocurrency watcher. We use the <code>ContainerConfigurator</code> as a base-building stone:</p>
<pre><code class="language-php">namespace CryptoWatch\Config;

use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator

final class CryptoWatchConfig extends ContainerConfigurator
{
    /**
     * @param string[] $currencies
     */
    public function watchCurrencies(array $currencies): void
    {
        // you can validate $currencies to contain only currencies you handle

        // set parameter (or create service), depending on your domain
        $parameters = $this-&gt;parameters();
        $parameters-&gt;set('currencies', $currencies);
    }
}</code></pre>
<p><br></p>
<p>The config uses public API methods from <code>ContainerConfigurator</code> to work with parameters and services.
But the user of our package will be saved from those implementation details.</p>
<p>They will <strong>simply use it like this</strong>:</p>
<pre><code class="language-php">// config/config.php
namespace CryptoWatch\Config\CryptoWatchConfig;

return function (CryptoWatchConfig $cryptoWatchConfig): void {
    $cryptoWatchConfig-&gt;watchCurrencies(['btc', 'eth']);
};</code></pre>
<p>That's it! How simple implementation, right?</p>
<p>Here we expect the Symfony to take the <code>CryptoWatchConfig</code> type from the closure, create an instance, and pass it to the dependency injection container.
That way, our project will have parameters of key <code>currencies</code> with value <code>['btc', 'eth']</code>. That's at least how <a href="https://symfony.com/blog/new-in-symfony-5-3-config-builder-classes">config builders like <code>SecurityConfig</code></a> in Symfony 5.3 should work.</p>
<p><br></p>
<p>That's how we <em>wish</em> the Symfony to work, but the reality is slightly... unexpected.</p>
<p><br></p>
<h2 id="How-to-Teach-Symfony-to-Accept-Custom-Configs">How to Teach Symfony to Accept Custom Configs</h2>
<p>When we run the project with the config above, it will crash with the following message:</p>
<pre><code class="language-bash">Could not resolve argument "CryptoWatchConfig $cryptoWatchConfig"</code></pre>
<h3 id="1-New-Instance">1. New Instance</h3>
<p>But why? The config builders <strong>only work for extensions</strong>, and methods are automatically generated in a temp directory. They're not &quot;use your own config class&quot; friendly.</p>
<p><br></p>
<p>The <code>PhpFileLoader</code> class is responsible for creating configs. When we explore it, <a href="https://github.com/symfony/symfony/blob/a10071bd657c350bb8f995361643072a97ff5819/src/Symfony/Component/DependencyInjection/Loader/PhpFileLoader.php#L67">there is a line</a> responsible for creating <code>ContainerConfigurator</code>:</p>
<pre><code class="language-php">$this-&gt;executeCallback($callback, new ContainerConfigurator(...), $path);</code></pre>
<p>It only creates exactly <code>ContainerConfigurator</code>. Nothing else.</p>
<p><br></p>
<h3 id="What-can-we-Improve-Here">What can we Improve Here?</h3>
<p>We need to create the same type, as we put in the closure param type. This closure:</p>
<pre><code class="language-php">return function (CryptoWatchConfig $cryptoWatchConfig): void {
    // ...
}</code></pre>
<p><br></p>
<p>Should result into:</p>
<pre><code class="language-php">$containerBuilder = new CryptoWatchConfig(...);</code></pre>
<p><br></p>
<p>In other words, we need to change <code>PhpFileLoader</code> code into generic solution that takes param type and creates a class from it:</p>
<pre><code class="language-php">$reflectionFunction = new \ReflectionFunction($callback);
$firstParameterReflection = $reflectionFunction-&gt;getParameters()[0];
$containerConfiguratorClass = $firstParameterReflection-&gt;getType()-&gt;getName();

// the $containerConfiguratorClass is `CryptoWatchConfig` or any config we provide

$this-&gt;executeCallback($callback, new $containerConfiguratorClass(...), $path);</code></pre>
<p>👍️</p>
<h3 id="2-Open-Param-Type">2. Open Param Type</h3>
<p>But there is 2nd problem. The type is resolved from <a href="https://github.com/symfony/symfony/blob/a10071bd657c350bb8f995361643072a97ff5819/src/Symfony/Component/DependencyInjection/Loader/PhpFileLoader.php#L121-L137">param reflection here</a>:</p>
<pre><code class="language-php">switch ($type) {
    case ContainerConfigurator::class:
        $arguments[] = $containerConfigurator;
        break;

    // ...
    default:
        throw new \InvalidArgumentException(sprintf(
            'Could not resolve argument "%s"', $type
        ));</code></pre>
<p><br></p>
<p>What can be improved here? <code>Switch</code> for type detection is generally a terrible idea, and it only matches a single exact type:</p>
<pre><code class="language-php">// exclusive 1 entrance :(
get_class($class) === Controller::class

// children on-board :)
$class instanceof Controller</code></pre>
<p><br></p>
<p>In other words, we change the code to this:</p>
<pre><code class="language-php">if ($type instanceof ContainerConfigurator) {
    $arguments[] = $containerConfigurator;
} else {
    // ... fallback to switch
}</code></pre>
<p>👍️</p>
<p>That's it!</p>
<p><br></p>
<p>We had to change that to make <code>ECSConfig</code>, <code>RectorConfig</code>, <code>MBConfig</code> <code>EasyCIConfig</code>, and the rest work with Symfony. It's a single change to allow all of them, including your custom config that extends <code>ContainerConfigurator</code>.</p>
<p>Do you think this should be part of Symfony core? Let me know in the comments.</p>
<p><br></p>
<p><strong>tl;dr;</strong> Add <a href="https://github.com/symplify/vendor-patch-files/blob/main/patches/generic-php-config-loader.patch">the patch file</a> and create your config today.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/how-to-make-configs-like-rector-config-or-ecs-config-for-your-symfony-project</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 30 May 2022 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/how-to-make-configs-like-rector-config-or-ecs-config-for-your-symfony-project#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Upgrade Latte 2 Macro to Latte 3 Tag ]]></title>
                <link>https://tomasvotruba.com/blog/how-to-upgrade-latte-2-macro-to-latte-3-tag</link>
                <description><![CDATA[ <p>Latte 3 running on abstract syntax tree was released this week. Do you want to upgrade? First, check <a href="/blog/5-steps-to-get-ready-for-latte-3">5 steps to get ready</a>.
<br><br>
Do you have any custom macros in your project? They're the biggest challenge of the Latte 3 upgrade. But don't worry, today we'll rewrite them together.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="For-Early-Adopters">For Early Adopters</h2>
<p>Note: this is an early way to upgrade macro to Latte 3 based on trial/error, and it might improve based on to-be-released documentation.
Suppose you get stuck with your macro, <a href="https://forum.nette.org/cs/35141-latte-3-nejvetsi-vyvojovy-skok-v-dejinach-nette">ask in the dedicated topic on Nette Forum</a>.</p>
<p><br></p>
<p>Latte macro is a Latte &quot;shortcut&quot; that unwraps to compiled PHP code of the cached template, and it is compiled once, re-used, and improves the performance. In Latte 3, they're called <em>tags</em>.</p>
<p>That's enough for theory. Now we check <a href="https://www.startupjobs.cz/nabidka/24580/hleda-se-senior-php-programator-se-zapalem-pro-vec">upgrade of actual code in Amateri</a>.</p>
<p><br></p>
<p>A macro that inlines SVG files right to HTML code. From macro in Latte file...</p>
<pre><code class="language-html">{embeddedSvg "circle.svg"}
{embeddedSvg "circle.svg", "class" =&gt; "blue"}</code></pre>
<p><br></p>
<p>...to compiled template PHP code:</p>
<pre><code class="language-html">echo '&lt;svg width="10" height="10"&gt;&lt;circle cx="4.5" cy="4.5" r="3.5"/&gt;&lt;/svg&gt;';
echo '&lt;svg width="10" height="10" class="blue"&gt;&lt;circle cx="4.5" cy="4.5" r="3.5"/&gt;&lt;/svg&gt;';</code></pre>
<h2 id="Before-We-Start">Before We Start...</h2>
<p>We can upgrade the first macro to Latte 3 today, but in the case of 2nd, 3rd... or external dependency, it might take some time. We could stay in a traffic jam between both versions for a few weeks.</p>
<p><br></p>
<p>To support both Latte 2 macros and Latte 3 tags, use <a href="https://forum.nette.org/cs/35141-latte-3-nejvetsi-vyvojovy-skok-v-dejinach-nette?p=2#p220012">following trick</a>:</p>
<pre><code class="language-php">if (version_compare(Latte\Engine::VERSION, '3', '&lt;')) {
    // Latte 2
    $this-&gt;latte-&gt;onCompile[] = function { ... };
} else {
    // Latte 3
    $this-&gt;latte-&gt;addExtension(...);
}</code></pre>
<h2 id="1-From-DI-extension-ot-Latte-Extension">1. From DI extension ot Latte Extension</h2>
<p>Huh, what is this <code>addExtension()</code> method? Latte 3 uses its own extensions. No, it is not a usual a<code>CompilerExtension</code> as we know it.</p>
<p>What does it look like for our embeddedSvg macro, then?</p>
<pre><code class="language-php">namespace App\Latte;

use Latte\Extension;

final class EmbeddedSvgLatteExtension extends Extension
{
    // here we pass the configuration from config
    public function __construct(
        private string $baseDir
    ) {
    }
}</code></pre>
<p><br></p>
<p>Then we replace the DI extension with the Latte extension in <code>config.neon</code>:</p>
<pre><code class="language-diff">-extensions:
-    embeddedSvg: App\Latte\DI\EmbeddedSvgExtension
-
-embeddedSvg:
-    baseDir: %wwwDir%/images

+latte:
+    extensions:
+        - App\Latte\EmbeddedSvgLatteExtension(baseDir: %wwwDir%/images)</code></pre>
<p><br></p>
<p>We've just added Latte 3 extension that loads itself and does nothing. Time to add the first node!</p>
<h2 id="2-From-Macro-to-an-AST-Node">2. From Macro to an AST Node</h2>
<p>Abstract syntax tree landed in Latte Three. What does it mean for macros? The macro set is gone, and we'll create our own node class instead. Let's call it <code>EmbeddedSvgNode</code>.</p>
<p>First, we register it in our newly created Latte extension in the <code>getTags()</code> method:</p>
<pre><code class="language-php">namespace App\Latte;

use Latte\Extension;
use Latte\Compiler\Tag;
use App\Latte\Node\EmbeddedSvgNode;

final class EmbeddedSvgLatteExtension extends Extension
{
    public function __construct(
        private string $baseDir
    ) {
    }

    public function getTags(): array
    {
        return [
            'embeddedSvg' =&gt; function (Tag $tag): EmbeddedSvgNode {
                return new EmbeddedSvgNode($tag, $this-&gt;baseDir);
            },
        ];
    }
}</code></pre>
<p>How should we read this? Everytime we call <code>{embeddedSvg ...}</code> in Latte, the <code>new EmbeddedSvgNode($tag, $this-&gt;baseDir)</code> will be created on that place.</p>
<p>We can pass any arguments into its constructor. In our case:</p>
<ul>
<li><code>$tag</code> that holds every information from Latte, e.g., the file path argument</li>
<li><code>$this-&gt;baseDir</code> path that leads to a base directory with all images</li>
</ul>
<p><br></p>
<h2 id="3-From-Macro-open-to-the-AST-Node">3. From <code>Macro::open()</code> to the AST Node</h2>
<p>In the old Latte 2 macro, we used an <code>open()</code> method that handles both input parsing and node printing:</p>
<pre><code class="language-php">use Latte\MacroNode;
use Latte\Macros\MacroSet;
use Latte\PhpWriter;

final class EmbeddedSvgMacro extends MacroSet
{
    // ...

    public function open(MacroNode $node, PhpWriter $writer): string
    {
        // here we get string of first argument, the file path
        $file = $node-&gt;tokenizer-&gt;fetchWord();
        if ($file === null) {
            throw new CompileException('Missing SVG file path.');
        }

        // don't forget to clean the quotes
        $svgFilepath = $this-&gt;baseDir . DIRECTORY_SEPARATOR . trim($file, '\'"');

        // get optional arguments
        $macroAttributes = $writer-&gt;formatArray();

        // print bellow
        // ...
    }</code></pre>
<p>The <code>EmbeddedSvgNode</code> class splits these jobs into 2 separate methods:</p>
<ul>
<li>parse Latte input,</li>
<li>print itself to compiled PHP templates</li>
</ul>
<p><br></p>
<p>How do we write input parsing of the macro above in the Latte 3 node?</p>
<pre><code class="language-php">use Latte\Compiler\Nodes\AreaNode;
use Latte\Compiler\Nodes\Php\Expression\ArrayNode;

// we chose AreaNode for parent, suitable for HTML nodes like &lt;svg&gt;
final class EmbeddedSvgNode extends AreaNode
{
    private ArrayNode $arguments;

    private string $svgFilepath;

    public function __construct(Tag $tag, string $baseDir)
    {
        // parse first argument
        $stringNode = $tag-&gt;parser-&gt;parseUnquotedStringOrExpression();
        if (! $stringNode instanceof StringNode) {
            // we need string node
            throw new InvalidArgumentException('File must be string value');
        }

        // fullpath to directory
        $this-&gt;svgFilepath = $baseDir . DIRECTORY_SEPARATOR . $stringNode-&gt;value;

        // parse optional arguments, after ","
        $tag-&gt;parser-&gt;stream-&gt;tryConsume(',');
        $this-&gt;arguments = $tag-&gt;parser-&gt;parseArguments();
    }
}</code></pre>
<p><br></p>
<h2 id="What-has-Changed-in-the-Input">What has Changed in the Input?</h2>
<ul>
<li>instead of <code>string</code> for file name, we get a <code>StringNode</code> object</li>
<li>instead of <code>string</code> for arguments (yes, <a href="https://github.com/nette/latte/blob/f2e16d3ec6968854029740452c20c38a514e6842/src/Latte/Compiler/PhpWriter.php#L164">it's a <code>string</code></a>), we have an <code>ArrayNode</code> object</li>
</ul>
<p>Beautiful object API with IDE autocomplete and static validation!</p>
<p><br></p>
<p>Back to our <del>macro</del> node. Now we have 2 essential pieces ready:</p>
<ul>
<li>the SVG file path</li>
<li>the optional arguments, e.g. &quot;class&quot; =&gt; &quot;blue&quot;</li>
</ul>
<p><br></p>
<p>The last step is <strong>to print them to compiled PHP code</strong>.</p>
<p><br></p>
<h2 id="4-From-writer-and-gt-write-To-node-and-gt-print">4. From <code>$writer-&gt;write(...)</code> To <code>$node-&gt;print(...)</code></h2>
<p>For the printing, we re-use the original macro. What should we print?</p>
<pre><code class="language-php">use Latte\MacroNode;
use Latte\Macros\MacroSet;
use Latte\PhpWriter;

final class EmbeddedSvgMacro extends MacroSet
{
    // ...

    public function open(MacroNode $node, PhpWriter $writer): string
    {
        // ...

        // contains ['width' =&gt; '10', 'height' =&gt; '10']
        $svgAttributes = $this-&gt;resolveSvgAttributes($svgFilepath);

        // contains &lt;circle cx="4.5" cy="4.5" r="3.5"/&gt;
        $innerSvgContent = $this-&gt;resolveSvgString($svgFilepath);

        return $writer-&gt;write('
            echo "&lt;svg";
            foreach (%0.var + %1.raw as $key =&gt; $value) {
                echo " " . %escape($key) . "=\"" . %escape($value) . "\"";
         };
         echo "&gt;" . %2.var . "&lt;/svg&gt;";
         ',
            $svgAttributes,
            $macroAttributes,
            $innerSvgContent
        );
    }
}</code></pre>
<p><br></p>
<p>It seems we have to:</p>
<ul>
<li>foreach svg attributes, in bare <code>array</code> format via <code>%0.var%</code> mask</li>
<li>macro defined arguments in <code>string</code> format via <code>%1.raw</code> mask</li>
<li>print inner SVG <code>string</code> via <code>%2.var</code></li>
</ul>
<p><br></p>
<p>How do we include it in <code>EmbeddedSvgNode::print()</code> method?</p>
<pre><code class="language-php">use Latte\Compiler\Nodes\AreaNode;
use Latte\Compiler\Nodes\TextNode;
use Latte\Compiler\PrintContext;

final class EmbeddedSvgNode extends AreaNode
{
    // ...

    public function print(PrintContext $context): string
    {
        // contains ['width' =&gt; '10', 'height' =&gt; '10']
        $svgAttributes = $this-&gt;resolveSvgAttributes($svgFilepath);

        // contains &lt;circle cx="4.5" cy="4.5" r="3.5"/&gt;
        $innerSvgContent = $this-&gt;resolveSvgString($svgFilepath);

        return $context-&gt;format(
            &lt;&lt;&lt;'PHP_CONTENT'
echo '&lt;svg';

foreach (%dump + %node as $key =&gt; $value) {
    echo ' ' . %escape($key) . "='" . %escape($value) . "'";
}

%node
echo '&lt;/svg&gt;';
PHP_CONTENT,
            $svgAttributes,
            $this-&gt;arguments,
            new TextNode($innerSvgContent)
        );
    }</code></pre>
<p><br></p>
<p>Tip: open this post in the 2nd tab and compare the old Latte 2 macro on the left side and the new Latte 3 node on the right side.</p>
<p><br></p>
<h3 id="What-has-Changed-in-Printing">What has Changed in Printing?</h3>
<pre><code class="language-diff">-* foreach SVG attributes, in bare `array` format via `%0.var%` mask</code></pre>
<ul>
<li>print raw <code>array</code> via <code>%dump</code> mask</li>
</ul>
<p><br></p>
<pre><code class="language-diff">-* + macro defined arguments in `string` format via `%1.raw` mask</code></pre>
<ul>
<li>print latte defined argument <code>ArrayNode</code> via <code>%node</code> mask</li>
</ul>
<p><br></p>
<pre><code class="language-diff">-* print inner SVG `string` via `%2.var`</code></pre>
<ul>
<li>print <code>TextNode</code> via <code>%node</code> mask</li>
</ul>
<p><br></p>
<p><strong>Proof over promise?</strong> Find an open-source version of this upgrade in <a href="https://github.com/TomasVotruba/embedded-svg/pull/4/files">this pull-request</a>, including tests and detailed parsing SVG via XML.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/how-to-upgrade-latte-2-macro-to-latte-3-tag</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 23 May 2022 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/how-to-upgrade-latte-2-macro-to-latte-3-tag#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 5 Steps to Get Ready for Latte 3 ]]></title>
                <link>https://tomasvotruba.com/blog/5-steps-to-get-ready-for-latte-3</link>
                <description><![CDATA[ <p>After 3 months of intensive testing, David released <a href="https://github.com/nette/latte/releases/tag/v3.0.0">Latte 3.0</a> two days ago, with massive evolution under the hood. We've been using it <a href="https://www.startupjobs.cz/nabidka/24580/hleda-se-senior-php-programator-se-zapalem-pro-vec">in Amateri</a> past weeks, and today I will share our experience with you about how <strong>to get prepared for it</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Today, our goal is not to get your project to Latte 3. Developers of Latte Extensions will need a few weeks to catch up with the upgrade and test it, as macros have entirely new syntax.</p>
<p>Despite that, there are a few steps that we can <strong>do before the upgrade itself to prepare</strong> for boarding the beautiful ship called Latte 3.</p>
<h2 id="1-Replace-ifCurrent-with-if-isLinkCurrent">1. Replace <code>{ifCurrent ...}</code> with <code>{if isLinkCurrent(...)}</code></h2>
<p>The macro <code>ifCurrent</code> calls function <code>isLinkCurrent</code> on the background. It will trigger an error in Latte 3.</p>
<p>Now, use the function directly instead:</p>
<pre><code class="language-diff"> &lt;a href="/friends" class="
-    {ifCurrent friends}active{/ifCurrent}
+    {if isLinkCurrent('friends')}active{/if}
 "&gt;Friends&lt;/a&gt;</code></pre>
<p>And also:</p>
<pre><code class="language-diff">-{ifCurrent 'meeting:lunch'}eat{/ifCurrent}
+{if isLinkCurrent('meeting:lunch')}win{/if}</code></pre>
<p><br></p>
<p><strong>💡 Tip: Do you use PHPStorm?</strong> This is <a href="https://github.com/TomasVotruba/barista/blob/fce40f5805cfbd529e4ae1bcdd22890db9a66164/src/Upgrade/IfCurrentLatteSyntaxUpgrader.php#L16">the regex</a> that handles change for you.</p>
<p><br></p>
<p>There is a particular case for the <code>n:ifCurrent</code> macro that is better to handle manually:</p>
<pre><code class="language-diff">-&lt;a href="/profile/change-password" n:ifCurrent="profile"&gt;Change Password&lt;/a&gt;
+{if isLinkCurrent('profile')}
+    &lt;a href="/profile/change-password"&gt;Change Password&lt;/a&gt;
+{/if}</code></pre>
<h2 id="2-Get-the-Latest-Latte-2-version">2. Get the Latest Latte 2.* version</h2>
<p>This version is the latest you can get from 2.11.*. It does not break anything, and it helps you with the upgrade:</p>
<pre><code class="language-bash">composer require latte/latte:^2.11.3</code></pre>
<p>Do you have it in your project? Great, now we can use it in the next step ↓</p>
<h2 id="3-Try-Latte-Linter-Today">3. Try Latte Linter Today</h2>
<p>Syntax changes are <a href="https://forum.nette.org/cs/35141-latte-3-nejvetsi-vyvojovy-skok-v-dejinach-nette#p219574">described in this forum post</a>, but how many of those <strong>are actually in our project</strong>? Maybe all of them? In our case it was just 4.</p>
<p>But how can we find them quickly? With the new Latte linter command. Just run it in CLI:</p>
<pre><code class="language-bash">vendor/bin/latte-lint templates</code></pre>
<p><br></p>
<p>During our testing, we assumed linter is an intelligent static analyzer (like PHPStan) that will not let us make mistakes. That's not the case.</p>
<p>The <em>linter</em> only <strong>checks the syntax of the Latte language is valid</strong>. It does not have the context or logic of your Latte files. Something like <code>php -l</code>.</p>
<p><br></p>
<p>Latte linter has a few spots to improve:</p>
<ul>
<li>It create own isolated <code>Latte\Engine</code>. That means it misses your custom macros and filters. You <a href="https://github.com/nette/latte/blob/8742292dc2723fd42dd9f0b928a0c8e0764df0b2/src/Tools/Linter.php#L21">can hack in your Latte Engine</a>, but it seems like a heavy workaround.</li>
<li>The CI will keep failing because of these errors, so you have to allow the job to fail or skip it completely</li>
<li>It only accepts directories as arguments, so you can't check a single Latte file:</li>
</ul>
<pre><code class="language-bash">vendor/bin/latte-lint templates/single-file.latte</code></pre>
<p>David is committing improvement coming the last 2 days, so upcoming patch versions might change it.</p>
<p><br></p>
<p>Latte <strong>syntax is now CASE sensitive</strong> and the Linter will tell you where it matters:</p>
<pre><code class="language-diff">-{foreach $items AS $item}
+{foreach $items as $item}</code></pre>
<p>Let me know in the comments what deprecations you've found in your code.</p>
<h2 id="4-Prepare-for-the-Translations">4. Prepare for the Translations</h2>
<p>Since Latte 3, there are few changes in translate macros as we know them:</p>
<pre><code class="language-html">{_$bookTitle}</code></pre>
<p><br></p>
<p>The single <code>_</code> still works, but the dual <code>_</code> macro <strong>will be replaced by <code>translate</code></strong>:</p>
<pre><code class="language-diff">-{_}Nice tree! How do you grow it?{/_}
+{translate}Nice tree! How do you grow it?{/translate}</code></pre>
<p><br></p>
<p>The <code>_</code>, <code>-</code> or <code>:</code> could be part the language syntax. I think this is an improvement, as &quot;translate&quot; is self-explanatory.</p>
<p><br></p>
<p><strong>Warning</strong>: the <code>translate</code> macro is not yet available in Latte 2.x. I think it's worth mentioning, as in our case, it means a change of hundreds of cases, and we have to prepare a plan to get ready for it.</p>
<h2 id="5-Ping-Your-Latte-3-Dependencies">5. Ping Your Latte 3.* Dependencies</h2>
<p>Let's say our project is ready, we've updated all macros, Latte syntax, and Latte linter works. We want to board Latte 3...</p>
<p>But what about <strong>the external Latte extensions we use</strong>? We can find out easily by triggering the requirements:</p>
<pre><code class="language-bash">composer require latte/latte:^3.0</code></pre>
<p>Does the install pass? Congratulations, there is no blocker in your vendor and you're ready to sail!</p>
<p><br></p>
<p>Has the composer reported some conflicts?</p>
<ul>
<li><a href="https://github.com/milo/embedded-svg">https://github.com/milo/embedded-svg</a></li>
<li><a href="https://github.com/contributte/mailing">https://github.com/contributte/mailing</a> (dev-master allows)</li>
<li><a href="https://github.com/nextras/mail-panel">https://github.com/nextras/mail-panel</a></li>
</ul>
<p>Help out these packages to:</p>
<ul>
<li>allow <code>latte/latte</code> 3.0</li>
<li>fix possible BC breaks</li>
</ul>
<p>The sooner these packages are ready and tagged, the sooner whole Latte 3 community can sail together.</p>
<p><br></p>
<p>How to upgrade a Latte extension to Latte 3? Stay tuned for the next post.
If you want to know earlier, we <a href="https://www.startupjobs.cz/en/job/24580/hleda-se-senior-php-programator-se-zapalem-pro-vec">are looking for a new lazy and curious PHP colleague</a>.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/5-steps-to-get-ready-for-latte-3</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 19 May 2022 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/5-steps-to-get-ready-for-latte-3#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ New in ECS: Simpler Config ]]></title>
                <link>https://tomasvotruba.com/blog/new-in-ecs-simpler-config</link>
                <description><![CDATA[ <p>ECS runs on Symfony container configuration to build the service model. While it brings automated autowiring, array autowiring, and native container features, the downside is that ECS configuration syntax is complex and talkative.
<br><br>
We decided to simplify it so ECS is truly easy to use.</p> ]]></description>
                <content:encoded><![CDATA[ <p>How do we configure ECS now?</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\EasyCodingStandard\ValueObject\Option;

// ups, possible conflict with ContainerConfigurator
return static function (ContainerConfigurator $containerConfigurator): void {
    $parameters = $containerConfigurator-&gt;parameters();

    // too verbose params, constants and possible typo in param value
    $parameters-&gt;set(Option::PATHS, [[ // ups, "[[" typo
        __DIR__ . '/src/',
    ]]);

    $services = $containerConfigurator-&gt;services();
    $services-&gt;set(ArraySyntaxFixer::class);
};</code></pre>
<p><br></p>
<p>Phew! Such complexity is confusing just to read and easy to make an error in.</p>
<h2 id="The-new-Way-to-Configure-ECS">The new Way to Configure ECS</h2>
<p>The new ECS version introduces its own <code>ECSConfig</code>object that wraps around Symfony configuration and makes setup even more straightforward.</p>
<p><br></p>
<p>It brings:</p>
<ul>
<li>full IDE autocomplete,</li>
<li>isolation from Symfony - useful for Symfony projects</li>
<li>validation of configuration on entry</li>
<li>makes sure there are no duplicated rules in a single config that might lead to unexpected behavior</li>
</ul>
<p><br></p>
<p>How does it look?</p>
<pre><code class="language-php">use Symplify\EasyCodingStandard\Config\ECSConfig;
use Symplify\EasyCodingStandard\ValueObject\Set\SetList;

return static function (ECSConfig $ecsConfig): void {
    $ecsConfig-&gt;paths([
        __DIR__ . '/src',
    ]);

    $ecsConfig-&gt;rule(ArraySyntaxFixer::class);

    $ecsConfig-&gt;sets([SetList::PSR_12]);
};</code></pre>
<h2 id="How-to-upgrade-to-ECSConfig">How to upgrade to <code>ECSConfig</code>?</h2>
<p>First, upgrade your ECS to 10.2 to enjoy this feature. Then, replace <code>ContainerConfigurator</code> in your <code>ecs.php</code> with <code>ECSConfig</code>. And then? Use your IDE - <strong>autocomplete methods</strong> will lead you:</p>
<img src="/assets/images/posts/2022/ecs_config.gif" class="img-thumbnail mb-2" style="max-width: 45em">
<p><br></p>
<p>Do you configure your rules? Use <code>ruleWithConfiguration()</code> method:</p>
<pre><code class="language-php">    $ecsConfig-&gt;ruleWithConfiguration(ArraySyntaxFixer::class, [
        'syntax' =&gt; 'short',
    ]);</code></pre>
<p><br></p>
<p>What if you miss upgrading an imported config? Don't worry. We've added a <strong>safe checker</strong> that goes through provided configs and warns you about an old configuration.</p>
<img src="/assets/images/posts/2022/ecs_warning.png" class="img-thumbnail mb-2" style="max-width: 45em">
<p>So you won't miss any of your configs to upgrade.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/new-in-ecs-simpler-config</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 09 May 2022 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/new-in-ecs-simpler-config#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to test Symfony Routes to make Huge Refactoring Safe ]]></title>
                <link>https://tomasvotruba.com/blog/how-to-test-symfony-routes-to-make-huge-refactorings-safe</link>
                <description><![CDATA[ <p>The beauty of <a href="/blog/2019/04/15/pattern-refactoring/">pattern refactoring</a> with Rector is transforming thousands of elements at once. Like nuclear chain reaction. But to do it safely, we need a high-quality test to ensure the code still works.
<br><br>
Does a high-quality test mean <em>a lot of</em> tests? Not necessarily. Instead of writing many tests to cover all our routes, we can write one smart one. How?</p> ]]></description>
                <content:encoded><![CDATA[ <p>I was working on routing refactoring the Symfony 2.8 project a month ago. The test for routing we had only was able to count the routes. That's it.</p>
<p>That's like assuming the nuclear reactor works because there is no fire in the village 5 miles away.</p>
<p>We needed a better test that covers the loading of every route, path, prefix, and everything that <code>@Route</code> can hold. This was a rough 10 line idea:</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">I'm refactoring configuration ~80 routes from YAML to PHP, but need them to work 😊<br><br>How would you test that all routes all still the same in <a href="https://twitter.com/hashtag/symfony?src=hash&amp;ref_src=twsrc%5Etfw">#symfony</a>?<br><br>This is my go ↓ <a href="https://t.co/hdqLDAEk3v">pic.twitter.com/hdqLDAEk3v</a></p>— Tomas Votruba 🇺🇦 (@VotrubaT) <a href="https://twitter.com/VotrubaT/status/1519201806819205120?ref_src=twsrc%5Etfw">April 27, 2022</a></blockquote>
<p><br></p>
<h2 id="One-Month-Later">One Month Later...</h2>
<p>We still have this test that is performing great. So far it:</p>
<ul>
<li>discovered 5 bugs in pull-request CI checks</li>
<li>helped us to find 1 dead route</li>
</ul>
<p>That's why I want to share it with you, step by step. The beauty of it is <strong>you can write this test in 10 minutes and have 0 maintenance cost</strong>. You can use this approach not just for Symfony routing but for loaded entities or anything in the form of an array. The CI feedback that everything still works is priceless.</p>
<h2 id="1-Get-loaded-Routes-from-Symfony">1. Get loaded Routes from Symfony</h2>
<p>The first step that we have to do is to get all the loaded routes. For that, we need a <code>RouterInterface</code>. We'll look at how to get normalized routed data. Then we'll put everything together in a test case:</p>
<pre><code class="language-php">/** @var \Symfony\Component\Routing\RouterInterface $router */
$routeCollection = $router-&gt;getRouteCollection();

// here we collect route data to an array
$routeMap = [];

foreach ($routeCollection-&gt;all() as $name =&gt; $route) {
    // we wanted to test only attributes we use, but you can name all of them
    $routeMap[$name] = [
        'path' =&gt; $route-&gt;getPath(),
        'requirements' =&gt; $route-&gt;getRequirements(),
        'defaults' =&gt; $route-&gt;getDefaults(),
        'methods' =&gt; $route-&gt;getMethods(),
    ];
}

// sort A → Z for nice standardized output
ksort($routeMap);</code></pre>
<p>You can try this quickly in a controller or command. <code>dump($routeMap)</code> to see if you have collected routes.</p>
<p><br></p>
<p>All right! We have the data about routes our project has now. How do we turn it into a future-proof test to avoid nuclear core failure?</p>
<h2 id="2-Persist-Snapshot-to-File">2. Persist Snapshot to File</h2>
<p>The following testing is sometimes called &quot;snapshot&quot;, and is very useful for testing HTML outputs. We have data in an <code>array</code> with strings. How do we turn it into a snapshot stored in a file?</p>
<p>Well, even more complex test <a href="/blog/2020/07/13/the-most-effetive-test-i-found-in-7-years-of-testing">like Rector I/O</a> can be turned into snapshots.</p>
<p>We can handle an <code>array</code>, right? We'll use the good old &quot;what is an array, is a JSON; what is a JSON, is an array&quot; axiom:</p>
<pre><code class="language-php">use Nette\Utils\Json;

$routeMapJson = Json::encode($routeMap, Json::PRETTY);</code></pre>
<p><br></p>
<p>What is a string, can be persisted to file:</p>
<pre><code class="language-php">file_put_contents(__DIR__ . '/Fixture/expected_route_map.json', $routeMapJson);</code></pre>
<p>Now we have a snapshot of our routes <strong>in a single JSON file</strong>. Not just long line, but beautiful indented JSON file. We can open it and go through it ourselves. The routes include prefixes, YAML, XML, annotation, and attribute routes. We don't care about the format, just if everything is in the same place in the end.</p>
<p>If one route name is changed by just one character, we know it. If a new route is added, we know it.</p>
<h2 id="Easy-Maintenance">Easy Maintenance?</h2>
<p>If we add a new route, we know it. The test would fail. But that is not what we expect. We added a new route, so we want it there. Oh, we'll have to update the <code>__DIR__ . '/Fixture/expected_route_map.json'</code> file.</p>
<p>But how? Is this price for snapshot testing? Do we have to go to the file and manually update it? Do we have to run <code>file_put_contents()</code> to update the file contents?</p>
<p><strong>That's a waste of time we want to use for more meaningful work.</strong></p>
<p><br></p>
<p>Here we'll leverage <a href="/blog/2020/07/20/how-to-update-hundreds-of-test-fixtures-with-single-phpunit-run/">testing trick</a> I learned from Nikita Popov while I've been contributing php-parser. It's not only a joy to contribute, but you can update tests from a command line. That's right, no work, no manual editing, just <code>vendor/bin/phpunit</code> run.</p>
<pre><code class="language-php">if (getenv('UT')) {
    // update test fixture knowingly, e.g. when new route is added
    FileSystem::write($routeMapJson, __DIR__ . '/Fixture/expected_route_map.json');
}</code></pre>
<p><br></p>
<p>It could not be simpler. To update the test fixture, add <code>UT=1</code> before the PHPUnit run:</p>
<pre><code class="language-bash">UT=1 vendor/bin/phpunit</code></pre>
<h2 id="The-Final-RoutingSnapshotTest">The Final <code>RoutingSnapshotTest</code></h2>
<p>We have the pieces... now we just put them together:</p>
<pre><code class="language-php">namespace App\Tests\Routing;

use PHPUnit\Framework\TestCase;
use Symfony\Component\Routing\RouteCollection;

final class RoutingSnapshotTest extends TestCase
{
    public function test(): void
    {
        // create container from Kernel or using KernelTestCase
        $container = $this-&gt;createContainer();

        $router = $container-&gt;get('router');

        $routeCollection = $router-&gt;getRouteCollection();
        $routeMap = $this-&gt;createRouteMap($routeCollection);

        $currentRouteMapJson = Json::encode($routeMap, Json::PRETTY);

        $expectedRouteMapFile = __DIR__ . '/Fixture/expected_route_map.json';

        if (getenv('UT')) {
            FileSystem::write($expectedRouteMapFile, $currentRouteMapJson);
        }

        $this-&gt;assertJsonStringEqualsJsonFile(
            $expectedRouteMapFile,
            $currentRouteMapJson
        );
    }

    private function createRouteMap(RouteCollection $routeCollection): array
    {
        $routeMap = [];
        foreach ($routeCollection-&gt;all() as $name =&gt; $route) {
            $routeMap[$name] = [
                'path' =&gt; $route-&gt;getPath(),
                'requirements' =&gt; $route-&gt;getRequirements(),
                'defaults' =&gt; $route-&gt;getDefaults(),
                'methods' =&gt; $route-&gt;getMethods(),
            ];
        }

        ksort($routeMap);

        return $routeMap;
    }
}</code></pre>
<p><br></p>
<p>Let's add this test and run it... oh, it fails.
First, we have to generate the fixture file with our little trick:</p>
<pre><code class="language-bash">UT=1 vendor/bin/phpunit</code></pre>
<p><br></p>
<p>That's it! Now you're testing all your routes, and you can be sure the nuclear power station is safe.</p>
<p><br></p>
<p>Happy coding!</p>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/how-to-test-symfony-routes-to-make-huge-refactorings-safe</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 02 May 2022 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/how-to-test-symfony-routes-to-make-huge-refactorings-safe#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Remove Dead Mock Calls from PHPUnit Tests ]]></title>
                <link>https://tomasvotruba.com/blog/how-to-remove-dead-mock-calls-from-phpunit-tests</link>
                <description><![CDATA[ <p>We're going to visit a foreign country where living costs are just 1/3 of ours. Let's say from UK or Germany to Brno, Czechia. We're organizing a bachelor party for our best friend.
<br><br>
The night has come, and our group walks around the city and drinks beers, the groom wears baby piggy clothes, and we're happily celebrating. We're losing one more wingman that will settle down with a beautiful wife and soon-to-come child. It's fun and exciting. We've never been abroad before with so many friends to celebrate the next step in man's life.</p> ]]></description>
                <content:encoded><![CDATA[ <p>It's a Sunday morning, and we fly back home. Just a little hangover, but apart from that, the best party of this year!</p>
<p>That's one side of the story.</p>
<blockquote class="blockquote text-center">
"A person's freedom ends<br>
where another man's freedom begins."
</blockquote>
<p>We can see the same weekend via 3 different glasses:</p>
<ul>
<li>
<p>We're working for the hotel as a cleaning service. We wake up at 5 AM, ready to wash another dirty puked bathroom.</p>
</li>
<li>
<p>The public cleaning service wakes up at 4 AM to pick up broken glass in the streets. People going through the morning always get what they expect - a clean city ready for their dogs and children to walk around safely.</p>
</li>
<li>
<p>We're a family living in the city who has a bad weekend. We could not sleep till 3 AM. Why? The streets were noisy, with singing drunks arguing with police, then playing some techno music from their Bluetooth speaker.</p>
</li>
</ul>
<p><br></p>
<img src="/assets/images/posts/2022/brno_empty.jpg" class="img-thumbnail" style="max-width: 25em">
<p><br></p>
<p>For these people, it's a tiring day, cleaning other people's mess and dealing with the consequences of one &quot;fun&quot; time.</p>
<p><br><br></p>
<p>Let's take this story to our work, a city being our project. Every new feature might seems cool and very useful to implement, but it has its consequences on the side of long-term use.</p>
<h2 id="Mocking-is-Fun-but-at-What-Cost">Mocking is Fun... but at What Cost?</h2>
<p>That's how mocking seems to be used these days. <strong>On one side</strong>, an excited team wants to apply this new testing framework to add a new test to their super legacy project that is hard to tackle. Finally, there is a tool that makes testing of anything possible because they do not have to deal with dependencies, types, or versioning. Everything can be mocked, and we only test the result!</p>
<p><strong>On the other hand</strong>, new developers come to the project 2 years later. Their job is to upgrade the framework and PHP version. The upgrade itself goes well, but they have to deal with tests. &quot;Deal&quot; with tests? Should not tests be the helpful positive assets of the project?</p>
<h2 id="Refactoring-Tests-Maintenance">Refactoring + Tests Maintenance</h2>
<p>Test have to update too: renamed methods, changed classes of updated dependencies etc. Even worse, some tests are false positively passing, because all the bearing parts were mocked. <strong>They're not testing the business code but the mocking framework itself</strong>. They give us an impression of tested code... until it fails on production on the actual class.</p>
<p><br></p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">How much do you mock?<br><br>Got 2 projects overrun with mocks, that make maintaining test terribly painful.<br><br>Exploring options to get to 0 mocks in an automated fashion.<a href="https://t.co/1NCIXIWjjK">https://t.co/1NCIXIWjjK</a></p>— Tomas Votruba 🇺🇦 (@VotrubaT) <a href="https://twitter.com/VotrubaT/status/1519732183614775300?ref_src=twsrc%5Etfw">April 28, 2022</a></blockquote>
<p><br></p>
<p>There is handful of wise posts about <strong>why not to use mocks</strong> and move to readable PHP code:</p>
<ul>
<li><a href="https://blog.frankdejonge.nl/testing-without-mocking-frameworks/">Testing without mocking frameworks</a></li>
<li><a href="https://mnapoli.fr/anonymous-classes-in-tests/">Using anonymous classes to write simpler tests</a></li>
<li><a href="https://steemit.com/php/@crell/don-t-use-mocking-libraries">Don't use Mocking libraries</a></li>
<li><a href="https://davegebler.com/post/php/better-php-unit-testing-avoiding-mocks">Better PHP unit testing: avoiding mocks</a></li>
</ul>
<p><br></p>
<p>This post will not be about &quot;why&quot;, but rather about <strong>how to deal with mock flood</strong> in a 10+ year project we took over.</p>
<h2 id="The-Low-Hanging-Fruit-Mock">The Low Hanging <del>Fruit</del> Mock</h2>
<p>Would you use 3 constructors to pass your dependency to class? No, we would use the exact amount needed - one. The same way we treat mocks - bring value or leave.</p>
<p>The project we took over is old but successful. Fortunately for us, it has excellent test coverage, running CI, PHPStan, ECS, and Rector. There is just one catch: <strong>roughly 30 % of the tests are bare mocks</strong>.</p>
<p>We need easy to maintain tests, to move move fast and safely. The last thing we want to deal with is upgrading strings in tests. How can we get out of the mock jungle?</p>
<h2 id="Taking-Dead-Mocks-First-to-Lower-Complexity">Taking Dead Mocks First to Lower Complexity</h2>
<p>This year, <a href="https://getrector.org/for-companies">with Rector cleaning services</a>, we're cleaning 2 projects from mock jungle.</p>
<p><br></p>
<p>Our goal is simple:</p>
<ul>
<li>remove useless mocks</li>
<li>keep only those mocks that bring value</li>
<li>improve the codebase at once</li>
<li>make sure safety is priority</li>
</ul>
<p><br></p>
<p>So what does the universally useless mock look like? The idea is the same with dead code in PHP:</p>
<pre><code class="language-diff">-$value = 100;
 $value = 150;</code></pre>
<p>Here we know the only 2nd value will remain, as the last assigned wins. We can remove the 1st line without changing anything. We can also detect this pattern with Rector and automate this.</p>
<h2 id="Detecting-Dead-Mocks">Detecting Dead Mocks</h2>
<h3 id="1-Replace-getMockBuilder-with-createMock">1. Replace <code>getMockBuilder()</code> with <code>createMock()</code></h3>
<p>The <code>getMockBuilder()</code> is an old method that was used <a href="https://stackoverflow.com/questions/38363086/what-is-the-difference-between-createmock-and-getmockbuilder-in-phpunit">for detailed strict testing</a>. Replacing this method will remove a lot of clutter and most likely will not change the test:</p>
<pre><code class="language-diff">-$cacheServiceMock = $this-&gt;getMockBuilder(CacheInterface::class)
-    -&gt;disableOriginalConstructor()
-    -&gt;setMethods(['del', 'get', 'set'])
-    -&gt;getMock();
+$cacheServiceMock = $this-&gt;createMock(CacheInterface::class);</code></pre>
<p>We've done this refactoring on one code base, removing 59 cases, and tests are passing well.</p>
<p><br></p>
<h3 id="2-Remove-expects-this-and-gt-any-as-default">2. Remove <code>expects($this-&gt;any())</code> as default</h3>
<p>This method defined expected input on the following method call. The &quot;any&quot; type is the default input so that it can be safely removed:</p>
<pre><code class="language-diff"> $siteServiceMock
-    -&gt;expects($this-&gt;any())
     -&gt;method('getMetadata')
     -&gt;willReturn(['name' =&gt; 'John']);</code></pre>
<p>In our project, 63 lines are now gone.</p>
<p><br></p>
<h3 id="3-Replace-will-returnValue-with-willReturn">3. Replace <code>will()</code> + <code>returnValue()</code> with <code>willReturn()</code></h3>
<p>A handy shortcut that might help us in the next refactoring:</p>
<pre><code class="language-diff"> $requestMock
     -&gt;method('getPathInfo')
-    -&gt;will($this-&gt;returnValue($url));
+    -&gt;willReturn($url);</code></pre>
<h2 id="Empower-your-CI-to-Work-for-You">Empower your CI to Work for You</h2>
<p>After all this effort, our tests are getting slim. We're not there yet, but it's a start to spark the fire. But what if someone will send a PR or IDE/tool-generated code that will give us the clutter back?</p>
<p>No worries, add this set to your <code>rector.php</code>, enable Rector in CI, and you're covered forever:</p>
<pre><code class="language-php">use Rector\Config\RectorConfig;
use Rector\Set\ValueObject\SetList;
use Rector\PHPUnit\Set\PHPUnitSetList;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;sets([
        PHPUnitSetList::REMOVE_MOCKS,
    ]);
};</code></pre>
<p><br></p>
<p>Do you know <strong>another pattern refactoring to reduce mocks we should include here</strong>? Please share with me in the comments. I'm eager to learn, as this is a widespread problem we can easily automate.</p>
<p><br></p>
<p>Happy coding!</p>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/how-to-remove-dead-mock-calls-from-phpunit-tests</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 25 Apr 2022 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/how-to-remove-dead-mock-calls-from-phpunit-tests#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Test Latte Macro in 4 Steps ]]></title>
                <link>https://tomasvotruba.com/blog/how-to-test-latte-macro-in-4-steps</link>
                <description><![CDATA[ <p>We're upgrading a couple of Latte macros into Latte 3. None of them have tests, and all of them will change entirely because of a complete rewrite of the Latte parser.
<br><br>
To get ready, we want to prepare tests first. Although writing Latte macros is the most complicated feature in Latte, testing is easier than you think.</p> ]]></description>
                <content:encoded><![CDATA[ <p>In another post, we focused on how to change the macro contents from Latte 2 to Latte 3 syntax. Today we'll see how to <strong>prepare a test that helps you upgrade easily</strong>. I never wrote any Latte macro in my life, but tests proved very helpful.</p>
<h2 id="1-Create-Test-Case-with-Container">1. Create Test Case with Container</h2>
<p>We'll need a <code>Latte\Engine</code> instance to load the Latte extension from provided <code>config.neon</code>.</p>
<p>We could create manual registration of <code>Latte\Engine</code>, but using <code>nette/di</code> will be closer to the actual use of Latte in our framework and scales easily in case of adding more extensions.</p>
<p>First, create a <code>ContainerFactory</code> that accepts config:</p>
<pre><code class="language-php">namespace Tests\DI;

use Nette\Bootstrap\Configurator;
use Nette\DI\Container;
use Nette\Utils\FileSystem;

final class ContainerFactory
{
    public function create(string $config): Container
    {
        $tempDirectory = __DIR__ . '/../temp';

        // clear before factory create to invoke cache rebuild
        FileSystem::delete($tempDirectory);

        $configurator = new Configurator();
        $configurator-&gt;addConfig($config);
        $configurator-&gt;setTempDirectory($tempDirectory);

        return $configurator-&gt;createContainer();
    }
}</code></pre>
<h2 id="2-Prepare-Latte-Engine-Service">2. Prepare <code>Latte\Engine</code> Service</h2>
<p>We cannot get <code>Latte\Engine</code> directly, as the service does not exist.
Instead, we'll use <code>LatteFactory</code> to create it. Create a simple test case and prepare the <code>Latte\Engine</code> in <code>setUp()</code>:</p>
<pre><code class="language-php">namespace Tests\Latte\Macros;

use PHPUnit\Framework\TestCase;
use Latte\Engine;
use Latte\Loaders\StringLoader;
use Nette\Bridges\ApplicationLatte\LatteFactory;

final class EmbeddedSvgMacroTest extends TestCase
{
    private Engine $latteEngine;

    protected function setUp(): void
    {
        $containerFactory = new ContainerFactory();
        $container = $containerFactory-&gt;create(__DIR__ . '/config/svg_macro.neon');

        /** @var LatteFactory $latteFactory */
        $latteFactory = $container-&gt;getByType(LatteFactory::class);
        $this-&gt;latteEngine = $latteFactory-&gt;create();

        $this-&gt;latteEngine-&gt;setLoader(new StringLoader());
    }
}</code></pre>
<p><br></p>
<h3 id="What-is-the-Loader-change-for">What is the Loader change for?</h3>
<p>You might have noticed that we've added the extra sauce to the <code>Latte\Engine</code>:</p>
<pre><code class="language-php">$this-&gt;latteEngine-&gt;setLoader(new StringLoader());</code></pre>
<p><br></p>
<p>Latte uses by default <code>Latte\Loaders\FileLoader</code>, which accepts the name of the template or path. So when we try to render string:</p>
<pre><code class="language-php">$this-&gt;latteEngine-&gt;setLoader('{embeddedSvg "file.svg"}');</code></pre>
<p>It looks for the <code>{embeddedSvg "file.svg"}</code> file and obviously - fails to find.</p>
<p><br></p>
<p>With the <code>StringLoader</code>, on the other hand, it will render the Latte input string directly.</p>
<h2 id="3-Dump-Your-Macro-Contents">3. Dump Your Macro Contents</h2>
<p>The macro has a straightforward job, and it converts input Latte to PHP contents of the cached template. When we test macro, we expect specific output.</p>
<p>We have to create PHP output first from the first test run.</p>
<pre><code class="language-php">public function test(): void
{
    $compiledPhpCode = $this-&gt;latteEngine-&gt;render('{embeddedSvg "file.svg"}');

    // this creates first fixture file - run this only once, then remove!
    file_put_contents(__DIR__ . '/expected_file.php', $compiledPhpCode);

    $this-&gt;assertStringEqualsFile(__DIR__ . '/expected_file.php', $compiledPhpCode);
}</code></pre>
<p><br></p>
<p>Latte uses tabs by default. Depending on your code style, you might want to convert them to 4 spaces:</p>
<pre><code class="language-php">$compiledPhpCode = Strings::replace($compiledPhpCode, "#\t#", '    ');</code></pre>
<p><br></p>
<p>Run PHPUnit to create the first fixture file:</p>
<pre><code class="language-bash">vendor/bin/phpunit</code></pre>
<p>The test should pass, as the run just created the fixture.</p>
<p>Good job!</p>
<h2 id="4-Extend-Test-for-Various-Situations">4. Extend Test for Various Situations</h2>
<p>One more thing. Just to be sure, we'll cover all various input situations:</p>
<pre><code class="language-html">// basic
{embeddedSvg "file.svg"}

// no key argument
{embeddedSvg "file.svg", "single_no_value"}

// multiple arguments
{embeddedSvg "file.svg", "class" =&gt; "blue", "size" =&gt; "medium"}</code></pre>
<p><br></p>
<p>Now our tests cover all possible situations this macro can use.</p>
<p>Commit, push and merge. That's it!</p>
<p><br></p>
<p><em>P.S.: Are interested in working with bleeding edge technologies and instant upgrades? <a href="https://www.startupjobs.cz/en/job/24580/hleda-se-senior-php-programator-se-zapalem-pro-vec">There is one chair left</a> in Amateri.</em></p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/how-to-test-latte-macro-in-4-steps</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 18 Apr 2022 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/how-to-test-latte-macro-in-4-steps#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 5 Constant Lists That Give Context to your Integers and Strings ]]></title>
                <link>https://tomasvotruba.com/blog/5-constant-lists-that-give-context-to-your-integers-and-strings</link>
                <description><![CDATA[ <p><a href="https://php.watch/versions/8.1/enums">Native enums</a> is a new PHP 8.1 feature. This feature brings more focus on <em>what</em> enums are <em>where</em> we can use them.</p>
<p><strong>Not on PHP 8.1 yet?</strong> Don't worry, before that, enums were emulated by public constants. Few constant lists are already part of your favorite framework, ORM, or utils package for years.
<br><br>
Today we look at 5 constant lists that you can use today to replace that <code>int</code> or <code>string</code> and give it a context.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Why-even-Bother-with-Enums">Why even Bother with Enums?</h2>
<pre><code class="language-php">if ($duration &lt; 14400) {
   return 'today';
}

return 'later';</code></pre>
<p><br></p>
<p>We might ask, why even bother using some constants? Everybody knows 14400 is the number of minutes in a day or is it seconds... or is it 1440?</p>
<pre><code class="language-diff">-if ($duration &lt; 14400) {
+if ($duration &lt; self::DAY_IN_MINUTES) {
    return 'today';
 }

 return 'later;</code></pre>
<p>We are using constant to remove these questions. Somebody already did the calculation before me and was much better at the result. We avoid the crash of <a href="https://www.amazon.com/Thinking-Fast-Slow-Daniel-Kahneman/dp/0374533555">thinking fast and thinking slow</a> at the same time - great book about how we think about others peoples' thinking.</p>
<p><br></p>
<p>There is <a href="/blog/2020/07/16/10-cool-features-you-get-after-switching-from-yaml-to-php-configs#10-Constants-over-Strings">more pratcical benefits in using constants over scalars</a>:</p>
<ul>
<li>we <strong>give the context</strong> to any reader, who will come 5 years later</li>
<li>we reduce maintenance of all usages <strong>to single place</strong></li>
<li>and we don't have to ever think about it anymore</li>
</ul>
<p><br></p>
<hr />
<p>I've shared one such constant on Twitter, and it got much more traction and responses than I expected:</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Did you know <a href="https://twitter.com/symfony?ref_src=twsrc%5Etfw">@symfony</a> offers constant codes for HTTP?<br><br>Since PHP 8.1 even more useful as enum! <a href="https://t.co/n1jpBYiu8i">pic.twitter.com/n1jpBYiu8i</a></p>— Tomas Votruba 🇺🇦 (@VotrubaT) <a href="https://twitter.com/VotrubaT/status/1502360490328080384?ref_src=twsrc%5Etfw">March 11, 2022</a></blockquote>
<p>I've picked <strong>the best and least known constant lists</strong> in this post.</p>
<p><br></p>
<p>Ready for some hot constant code? Let's go:</p>
<h2 id="1-HTTP-Response-Codes">1. HTTP Response Codes</h2>
<p>After calling outside API service, we have to verify the result or the reason why it failed. Codes like 404 and 200 are mainstream, but what about the less known ones?</p>
<p>Can you tell me in 2 seconds what is the condition checking here?</p>
<pre><code class="language-php">$response = $this-&gt;callExternalApi(...);
if ($response-&gt;getCode() === 403) {
    // what happened?
}</code></pre>
<p>We know something is wrong... maybe something was not found? Maybe the URL is outdated?</p>
<p><em>Maybe</em> is not good enough, and maybe, we can simply read it:</p>
<pre><code class="language-diff">+use Symfony\Component\HttpFoundation\Response;

 $response = $this-&gt;callExternalApi(...);
-if ($response-&gt;getCode() === 403) {
+if ($response-&gt;getCode() === Response::HTTP_FORBIDDEN) {
     // what happened?
 }</code></pre>
<p>The constant also differentiates HTTP response value, <a href="https://en.wikipedia.org/wiki/Area_code_403#:~:text=Area%20code%20403%20is%20a,assigned%20by%20AT%26T%20in%201947">Calgary telephone code</a> and an integer id in a test.</p>
<h3 id="Where-is-the-List">Where is the List?</h3>
<ul>
<li><a href="https://github.com/symfony/symfony/blob/2f27b39add8c8cdf7c70f2acfe8c9905eb56dfcc/src/Symfony/Component/HttpFoundation/Response.php#L24-L86"><code>Symfony\Component\HttpFoundation\Response</code></a></li>
<li><a href="https://github.com/nette/http/blob/17314395a830257e5db7167d5cccd1e6d1183ac9/src/Http/IResponse.php#L18-L79"><code>Nette\Http\IResponse</code></a></li>
</ul>
<h2 id="2-Request-Methods">2. Request Methods</h2>
<p>Where is a response, there must be a request first:</p>
<pre><code class="language-php">$response = $this-&gt;callExternalApi(..., 'get');</code></pre>
<p>We've all debugged an external API. If we're lucky, it has documentation. <strong>If we're not lucky, the documentation is outdated</strong> and the endpoint silently fails (I look at you Twitter, Meetup.com...).</p>
<p>A few hours later, we try the constant out of despair:</p>
<pre><code class="language-diff">+use Symfony\Component\HttpFoundation\Request;

-$response = $this-&gt;callExternalApi(..., 'get');
+$response = $this-&gt;callExternalApi(..., Request::METHOD_GET);</code></pre>
<p>And it works!</p>
<p><br></p>
<p>Why? Some API packages can mitigate the lowercased <code>"get"</code> to correct <code>"GET"</code>, but some can not. <strong>We can mitigate bugs like these</strong> by using a standardized constant that uses the correct version.</p>
<p><br></p>
<h3 id="Where-is-the-List">Where is the List?</h3>
<ul>
<li><a href="https://github.com/symfony/symfony/blob/2f27b39add8c8cdf7c70f2acfe8c9905eb56dfcc/src/Symfony/Component/HttpFoundation/Request.php#L54-L63"><code>Symfony\Component\HttpFoundation\Request</code></a></li>
<li><a href="https://github.com/nette/http/blob/17314395a830257e5db7167d5cccd1e6d1183ac9/src/Http/IRequest.php#L21-L28"><code>Nette\Http\IRequest</code></a></li>
</ul>
<p><br></p>
<p>P.S. Be creative... where else do we use <code>"GET"</code> or <code>"POST"</code> methods?</p>
<pre><code class="language-php">use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\Routing\Annotation\Route;

final class PostController extends AbstractController
{
    #[Route(path: '/blog/{slug}', methods: [Request::METHOD_GET])]
    public function __invoke(string $slug): Response
    {
    }
}</code></pre>
<h2 id="3-An-hour-a-Month-or-a-Year">3. An hour, a Month, or a Year?</h2>
<p>During my 19-years PHP developer career, I've used the calculator countless times just to produce correct <em>time numbers</em> like <del><code>8640</code></del>... ehm, <code>86400</code>.</p>
<p><br></p>
<p>The moment I saw the following constant list first time, it blew both my mind and calculator away:</p>
<pre><code class="language-diff">+use Nette\Utils\DateTime;

-if ($durationInSeconds &lt; 86400) {
+if ($durationInSeconds &lt; DateTime::DAY) {
     return 'less than a day';
 }

 return 'keep waiting';</code></pre>
<p>The <code>DAY_IN_SECONDS</code> name would be better, but at least the constant has a comment to clarify this.</p>
<p><br></p>
<p>These constants come very handily with header expiration or <a href="https://en.wikipedia.org/wiki/Time_to_live"><em>time to leave</em> (TTLs)</a> in cache:</p>
<pre><code class="language-php">use Nette\Utils\DateTime;

$httpResponse-&gt;setHeader('Access-Control-Max-Age', 12 * DateTime::HOUR);</code></pre>
<h3 id="Where-is-the-List">Where is the List?</h3>
<ul>
<li><a href="https://github.com/nette/utils/blob/4f7d3da873c4e3762cf7ebb9d3073efcd1bd56fc/src/Utils/DateTime.php#L22-L38"><code>Nette\Utils\DateTime</code></a></li>
</ul>
<h2 id="4-Accurate-Event-Subscribers">4. Accurate Event Subscribers</h2>
<p>There are probably dozens of events in the Symfony event system we can hook into. We already <a href="/blog/2019/05/16/don-t-ever-use-listeners/">use subscribers over listeners</a> and the <code>getSubscribedEvents()</code> method:</p>
<pre><code class="language-php">use Symfony\Component\EventDispatcher\EventSubscriberInterface;

final class SomeEventSubscriber implements EventSubscriberInterface
{
    public static function getSubscribedEvents(): array
    {
        return [
            'kernel.controller' =&gt; ['onKernelController'],
        ];
    }
}</code></pre>
<p><br></p>
<p>Instead of strings for event names, we can use Symfony constant list:</p>
<pre><code class="language-diff">+use Symfony\Component\HttpKernel\KernelEvents;

 return [
-    'kernel.controller' =&gt; ['onKernelController'],
+    KernelEvents::CONTROLLER =&gt; ['onKernelController'],
 ];</code></pre>
<p><br></p>
<p>Thanks to this constant, we <strong>open previously hidden knowledge</strong> = where is the event invoked and what subscribers use the event:</p>
<img src="/assets/images/posts/2022/kernel_events_usage.png" class="img-thumbnail" style="max-width: 35em">
<h3 id="Where-are-the-Lists">Where are the Lists?</h3>
<ul>
<li><a href="https://github.com/symfony/symfony/blob/6.1/src/Symfony/Component/HttpKernel/KernelEvents.php#L28-L111"><code>Symfony\Component\HttpKernel\KernelEvents</code></a></li>
<li><a href="https://github.com/symfony/symfony/blob/2f27b39add8c8cdf7c70f2acfe8c9905eb56dfcc/src/Symfony/Component/Console/ConsoleEvents.php#L24-L59"><code>Symfony\Component\Console\ConsoleEvents</code></a></li>
<li><a href="https://github.com/symfony/symfony/blob/2f27b39add8c8cdf7c70f2acfe8c9905eb56dfcc/src/Symfony/Component/Security/Http/SecurityEvents.php#L19-L36"><code>Symfony\Component\Security\Http\SecurityEvents</code></a></li>
</ul>
<h2 id="5-Doctrine-Column-Types">5. Doctrine Column Types</h2>
<p>Back in the PHP 7.4 days, we used to write Doctrine annotations in a weird string-like format, called comments, right above the property:</p>
<pre><code class="language-php">use Doctrine\ORM\Mapping as ORM;

class Post
{
    /**
     * @ORM\Column(type="int")
     */
    private $wordCount;
}</code></pre>
<p>Based on the <code>type=</code> part, the Doctrine was able to with database column type. Now I'm not sure about my memory, was it &quot;int&quot; or &quot;integer&quot;? We use &quot;int&quot; everywhere, even in native PHP type declarations, so that should be correct, right?</p>
<p><br></p>
<p>Well, time flew by, and now we can use <a href="https://php.watch/versions/8.0/attributes">PHP 8.0-native attributes</a>:</p>
<pre><code class="language-php">use Doctrine\ORM\Mapping as ORM;

class Post
{
    #[ORM\Column(type: "int")]
    private $wordCount;
}</code></pre>
<p><br></p>
<p>The syntax changed, PHPStan and Rector can work with these better, and PhpStorm autocomplete more reliable. <strong>But my memory issue remains</strong> - was it &quot;int&quot; or &quot;integer&quot;? Is there some solution for my memory leak?</p>
<p>Fortunately, there is:</p>
<pre><code class="language-diff"> use Doctrine\ORM\Mapping as ORM;
+use Doctrine\DBAL\Types\Types;

 class Post
 {
-     #[ORM\Column(type: "int")]
+     #[ORM\Column(type: Types::INTEGER)]
     private $wordCount;
 }</code></pre>
<p>Now we can state the intention - define a column to work with integer numbers,
and the knowledge is safely delegated to the tool itself - a constant it uses.</p>
<h3 id="Where-is-the-List">Where is the List?</h3>
<ul>
<li><a href="https://github.com/doctrine/dbal/blob/83f779beaea1893c0bece093ab2104c6d15a7f26/src/Types/Types.php#L12-L36"><code>Doctrine\DBAL\Types\Types</code></a></li>
</ul>
<p>Thanks to <a href="https://twitter.com/alex_s_/status/1504064803719024645">Alexander Schranz</a> for mentioning.</p>
<hr />
<h2 id="Who-do-we-Write-Code-For">Who do we Write Code For?</h2>
<p>Now we know <em>what</em> constant enum-like lists we can use, but I'd like to return to <em>why</em> we use them. We all know that <code>200</code> is success code, and <code>301</code> is a permanent redirect... but do we know how many bits are in 1024 bytes?</p>
<blockquote class="blockquote text-center">
"We don't write the code for use at present.<br>
We write for future fellow developers we'll never meet."
</blockquote>
<p>If we pay more attention to writing standardized code now, future developers will thank us for making their lives easier. Maybe we will also thanks ourselves ;).</p>
<h2 id="Honorable-Mentions">Honorable Mentions</h2>
<ul>
<li><a href="https://github.com/symfony/symfony/blob/2f27b39add8c8cdf7c70f2acfe8c9905eb56dfcc/src/Symfony/Component/Console/Command/Command.php#L36-L39"><code>Symfony\Component\Console\Command\Command::SUCCESS|FAILURE</code></a> for command line exit codes in <code>Command::execute()</code> and CLI apps</li>
<li><a href="https://github.com/php-fig/log/blob/fe5ea303b0887d5caefd3d431c3e61ad47037001/src/LogLevel.php#L10-L17"><code>Psr\Log\LogLevel::*</code></a> for logging - thanks to <a href="https://twitter.com/OliverNybroe/status/1503308677306011650">Oliver Nybroe</a></li>
<li><a href="https://github.com/symfony/symfony/blob/2f27b39add8c8cdf7c70f2acfe8c9905eb56dfcc/src/Symfony/Component/Form/FormEvents.php#L29-L95"><code>Symfony\Component\Form\FormEvents</code></a> - thanks to <a href="https://twitter.com/Shyim97/status/1503030223608107019">Shyim</a></li>
</ul>
<p>Have I missed a constant list that you use daily and makes your life easier? Please share in the comments or on Twitter to put it here too.</p>
<p><br></p>
<p>Happy coding!</p>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/5-constant-lists-that-give-context-to-your-integers-and-strings</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 07 Mar 2022 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/5-constant-lists-that-give-context-to-your-integers-and-strings#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Create Symfony Kernel for Tests with Different Configs ]]></title>
                <link>https://tomasvotruba.com/blog/how-to-create-symfony-kernel-for-tests-with-different-configs</link>
                <description><![CDATA[ <p>How can we create 2 tests scenarios for the Symfony Kernel project with 2 different parameters? How can we inject 2 different instances of the same interface? How can we do it in the same way we already configure both of them?
<br><br>
Today we'll look at a little trick that allows us to create Symfony Kernel with different configs.</p> ]]></description>
                <content:encoded><![CDATA[ <p>In Symfony, we can use config to define almost any container change - from parameter, a specific implementation of service to extension configuration. That's why it's so easy to use them for tests.</p>
<p>To make the example simple, we'll go with the simplest difference - a bool parameter value.</p>
<p><br></p>
<p>We want to run tests with 2 different configs:</p>
<pre><code class="language-yaml">parameters:
    auto_import: true</code></pre>
<p>and</p>
<pre><code class="language-yaml">parameters:
    auto_import: false</code></pre>
<p>When we load the first config, the project automatically imports long FQN class names.
If we use the 2nd config, the FQN class names will be untouched. And that's precisely what we want to test!</p>
<p><br></p>
<p>What options do we have?</p>
<h2 id="1-ENV-Variable">1. ENV Variable</h2>
<p>The first one that comes to mind is the environment. We have a different environment for development, production, and tests. We can define it in the <code>phpunit.xml</code> or directly in the command line before running the test:</p>
<pre><code class="language-bash">APP_ENV=tests vendor/bin/phpunit</code></pre>
<p><br></p>
<p>This way, the Symfony project will try to load configs from a specific path, like you can see in <a href="https://github.com/symfony/demo/tree/main/config/packages"><code>symfony/demo</code></a>:</p>
<pre><code class="language-bash">/config/packages/tests</code></pre>
<p><br></p>
<p>This way, we can use the environment to load our configs:</p>
<pre><code class="language-bash">APP_ENV=tests-import-enabled vendor/bin/phpunit
# loads configs from ↓
/config/packages/tests-import-enabled

APP_ENV=tests-import-disabled vendor/bin/phpunit
# loads configs from ↓
/config/packages/tests-import-disabled</code></pre>
<p><br></p>
<p>As you can see, it's not a very flexible solution.</p>
<h3 id="Pros-and-Cons">Pros and Cons</h3>
<p>❌ We'd have to create a new environment for every test</p>
<p>❌ The environment is miss-used as a feature flag</p>
<p>❌ It feels bizarre</p>
<p>❌ We can come across cache issues when we re-run the test with config modifications</p>
<h2 id="2-Unit-Mocking-the-Service-Configuration">2. Unit Mocking the Service Configuration</h2>
<p>Another option we have is to step away from the Kernel and container completely.
The service we want to test is only a <code>ClassNameImporter</code>. Why not use it directly in unit tests?</p>
<pre><code class="language-php">use PHPUnit\Framework\TestCase;

final class ClassNameImporterTest extends TestCase
{
    public function testImport()
    {
        $classNameImporter = new ClassNameImporter(autoImport: true);
        // ...
    }

    public function testNoImport()
    {
        $classNameImporter = new ClassNameImporter(autoImport: false);
        // ...
    }
}</code></pre>
<p>Then we can run tests quickly with expected input and output.</p>
<p><br></p>
<p>There is one little problem with false positives. How do we handle <code>ClassNameImporter</code> dependencies? We can create our services manually or <a href="/blog/2018/08/30/ways-i-fucked-up-open-source-code-mock-everything-and-test-units/">mock the external one</a>:</p>
<pre><code class="language-php">$classNameImporter = new ClassNameImporter(
    classNameResolver: new ClassNameResolver(),
    reflectionProvider: $this-&gt;getMock(ReflectionProvider::class),
    autoImport: false,
);</code></pre>
<p><br></p>
<h3 id="Tested-Context-Real-Context">Tested Context !== Real Context</h3>
<p>We run the test, it passes, and we merge the pull request. A few hours later, we got a server 500 error reports stream.</p>
<ul>
<li>Mocked method in <code>ReflectionProvider</code> is removed on actual code</li>
<li><code>ClassNameResolver</code> dependency was resolved incorrectly by the Symfony kernel container.</li>
<li>Symfony Kernel could not pass the <code>$autoImport</code> parameter because the config used <code>auto_import</code>.</li>
</ul>
<p>These errors <em>can</em> be discovered by other tests or static analysis in our CI, but that's wish-full thinking. Instead, we should aim for <strong>standalone robust tests</strong>.</p>
<h3 id="Pros-and-Cons">Pros and Cons</h3>
<p>✅ Clear unit approach</p>
<p>✅ Useful for fast bootstrapping of a small project</p>
<p>❌ Rather a puristic approach than pragmatic code</p>
<p>❌ Not flexible for modification - in case of new parameter use or new dependencies, we have to modify the test</p>
<p>❌ Creates technical debt as we have to maintain tests</p>
<p>❌ Does test only minimal part, we miss the framework lifecycle test</p>
<h2 id="3-Build-Your-Custom-Dependency-Container">3. Build Your Custom Dependency Container</h2>
<p>Now we know that we need the Symfony dependency container to test interdependencies between our code and the framework.
How can we build it with different configs?</p>
<p><br></p>
<p>I wrote about <a href="/blog/when-symfony-http-kernel-is-too-big-hammer-to-use">heavy Symfony Kernel</a> and how to make your <a href="/blog/introducing-light-kernel-for-symfony-console-apps">own light container factory</a>.</p>
<p><br></p>
<p>With this approach, we can load the exact config and fetch the configured service from the DI container:</p>
<pre><code class="language-php">use PHPUnit\Framework\TestCase;

final class ClassNameImporterTest extends TestCase
{
    public function testImport()
    {
        $containerBuilder = new ContainerBuilder();

        $yamlFileLoader = new YamlFileLoader($containerBuilder);
        $yamlFileLoader-&gt;load(__DIR__ . '/config/import_enabled.yaml');

        // compiler passes?
        // bundles?
        // extensions?

        $containerBuilder-&gt;compile();
        $classNameImporter = $containerBuilder-&gt;get(ClassNameImporter::class);
        // ...
    }

    // ...
}</code></pre>
<p>We're getting closer to Symfony lifecycle. But we moved from mocking issues to building Symfony components manually, replacing one problem with another.</p>
<h3 id="Pros-and-Cons">Pros and Cons</h3>
<p>✅ The tested context is now much closer to a real-life context</p>
<p>✅ We delegate building dependency container to framework</p>
<p>❌ It's too much code to write and maintain on our own.</p>
<p>❌ We have moved technical debt from our code to framework code maintenance.</p>
<p>❌ It requires deep Symfony container internals knowledge, mainly when it &quot;does not work anymore&quot;.</p>
<p>❌ We missed bundles and compiler passes registered in Kernel</p>
<h2 id="4-Kernel-with-Configurable-Configs">4. Kernel with Configurable Configs</h2>
<p>With this approach, we don't have to learn anything new about Symfony internals, and we can re-use existing methods we already know.</p>
<p>Before we start to enjoy testing with the configurable Kernel, we have to do 2 steps:</p>
<h3 id="1-Modify-the-AppKernel-to-Accept-custom-Configs-on-Constructor">1. Modify the <code>AppKernel</code> to Accept custom Configs on Constructor</h3>
<pre><code class="language-diff">use Symfony\Component\DependencyInjection\Container;
use Symfony\Component\HttpKernel\Kernel;

 final class AppKernel extends Kernel
 {
+    /**
+     * @var string[]
+     */
+    private $extraConfigs = [];
-    public function __construct($environment, $debug)
+    /**
+     * @param string[] $configs
+     */
+    public function __construct(string $environment, bool $debug, array $extraConfigs = [])
     {
         parent::__construct($environment, $debug);
+        $this-&gt;extraConfigs = $extraConfigs;
     }

     public function registerContainerConfiguration(LoaderInterface $loader)
     {
         // ...
+        foreach ($this-&gt;extraConfigs as $extraConfig) {
+            $loader-&gt;load($extraConfig);
+        }
     }
 }</code></pre>
<p>Now the Kernel can accept an array of configs, and everything else remains in its original shape and untouched.</p>
<h3 id="2-Create-a-test-Factory">2. Create a test Factory</h3>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Container;
use Symfony\Component\Filesystem\Filesystem;

final class ConfigurableContainerFactory
{
    /**
     * @param string[] $configs
     */
    public function create(array $configs): Container
    {
        // clear cache directory for fresh start
        $filesystem = new Filesystem();
        $filesystem-&gt;remove($cacheDirectory);

        $appKernel = new AppKernel('test', true, $configs);
        $appKernel-&gt;boot();

        return $appKernel-&gt;getContainer();
    }
}</code></pre>
<p><br></p>
<p>We've done the hard work. Now we can enjoy a simple test as a reward:</p>
<pre><code class="language-php">final class ClassNameImporterTest extends TestCase
{
    public function testImports()
    {
        $configurableContainerFactory = new ConfigurableContainerFactory();
        $container = $configurableContainerFactory-&gt;create([__DIR__ . '/config/import_enabled.yaml');

        $nameImporter = $container-&gt;get(NameImporter::class);

        // ...
    }
}</code></pre>
<h3 id="What-about-the-Performance">What about the Performance?</h3>
<p>In the case of hundreds of tests like these, we might experience slower tests as a new container is built on every test run. But it's rarely the case when we need to test hundreds of different parameters.</p>
<p>Usually, there is 1 shared container for 95 % of tests, then 5 % test with various combinations of parameters of service modifications.</p>
<h3 id="Pros-and-Cons">Pros and Cons</h3>
<p>✅ The tested context is identical to a real-life context</p>
<p>✅ When we upgrade to newer Symfony, there is 0-work with an upgrade as we don't use any of Symfony internals</p>
<p>✅ Verified by time - we've used this approach from Symfony 3 through Symfony 6</p>
<p>✅ Zero test maintenance if our or external dependencies changes</p>
<p>✅ Easy to modify</p>
<p>✅ Easy to add container cache with the same config</p>
<p>✅ Useful for both testing of Symfony apps and Symfony packages</p>
<p>✅ No technical debt</p>
<p>❌ We need to modify the Kernel class</p>
<p><br></p>
<p>That's all for today. How do you test your Symfony projects with minimal effort?</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/how-to-create-symfony-kernel-for-tests-with-different-configs</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 07 Feb 2022 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/how-to-create-symfony-kernel-for-tests-with-different-configs#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Get Rid of Mixed Callables with PHPStan ]]></title>
                <link>https://tomasvotruba.com/blog/get-rid-of-mixed-callables-with-phpstan</link>
                <description><![CDATA[ <p>Working with PHPStan on level 8 is a luxury, at least for a project where you've just introduced it. To give you a practical non-open-source perspective: <strong>we're at level 5 after 2 years of hard work</strong>.
<br><br>
In this level, we've noticed that PHPStan skips expression on variables that it resolved as <code>mixed</code>. Level 5 already provides valuable checks that we wanted for all <strong>method calls and property fetches</strong>. So <a href="/blog/not-all-mixed-types-are-equally-useless">we added custom rule to report those</a>.
<br><br>
After we cut the low-hanging fruit, we discovered the same way are skipped all <em>callable</em> types. How to deal with those?</p> ]]></description>
                <content:encoded><![CDATA[ <div class="card border-warning mt-4 mb-4">
    <div class="card-header text-black bg-warning shadow">
        <strong>Proof over theory?</strong>
        Thanks to this PHPStan rule, the Symplify <a href="https://github.com/symplify/symplify/commit/61e8bf67d52f0759d2efb688728a4ebd2c72b64b">improved 8 callables</a> from <code>mixed</code> to param and return typed.
    </div>
</div>
<h2 id="mixed-mixed"><code>mixed</code> !== <code>mixed</code></h2>
<p>Dealing with mixed is so hard. That's why it's included in the highest level of PHPStan - level 9.</p>
<p>Let's look at quite a typical code snippet. How would you this detect type?</p>
<pre><code class="language-php">final class TripController
{
    public function showFlights($destination)
    {
        // what exactly is $destination?
        echo $destination;
    }
}</code></pre>
<p>This can be tricky with scalar variables and entry points like controller or API calls.
To be 100 % sure, we have to run the code <a href="/blog/2019/11/11/from-0-doc-types-to-full-type-declaration-with-dynamic-analysis">collect production types with dynamic analysis</a>, verify the user input, etc.</p>
<p><br></p>
<p>We won't deal with those now. Instead, we take the low hanging fruit, like method calls or property fetches:</p>
<pre><code class="language-php">public function fetchFlights($destination): array
{
    $destination-&gt;getCovidRestrictions();
}</code></pre>
<p>For the human eye, it's obvious how to type this parameter. But how to detect these with PHPStan? <a href="/blog/not-all-mixed-types-are-equally-useless">See the previous post for unlocking the secret</a>.</p>
<p>But today, we'll look at something different.</p>
<h2 id="From-Typed-Method-to-a-Callable">From Typed Method to a Callable</h2>
<p>Try to follow this analogy with class structure. We have a class with 1 method, with clearly defined types:</p>
<pre><code class="language-php">final class CovidRestrictionResolver implements RestrictionResolverInterface
{
    public function resolve(Destination $destination): Restrictions
    {
        // ...
    }
}</code></pre>
<p><br></p>
<p>Now we go one level lower, from class method to a function. We still have types and know what comes there:</p>
<pre><code class="language-php">function resolve(Destination $destination): Restrictions
{
    // ...
}</code></pre>
<p><br></p>
<p>Let's say we need to use callable for JSON input/output, parallel run, or because we love functional programming.</p>
<pre><code class="language-php">$restrictionResolver = function (Destination $destination): Restrictions
{
    // ...
};

echo $restrictionResolver(new Destination('Portugal'));</code></pre>
<p><br></p>
<p>Do you see what happened with <code>$restrictionResolver</code>? From the typed class method, nested in beautiful final class with the interface we got to... <code>mixed</code>.</p>
<p>We can use any of the following lines, and static analysis would silently pass:</p>
<pre><code class="language-php">echo $restrictionResolver('Portugal');
echo $restrictionResolver(new Destination('Portugal'));
echo $restrictionResolver(776);</code></pre>
<h2 id="How-to-Type-a-Callable">How to Type a Callable?</h2>
<p>What if we love defensive programming? We promote the closure back to the class method with type declarations and use the <code>RestrictionResolverInterface</code> interface to type it in place of use:</p>
<pre><code class="language-php">/** @var RestrictionResolverInterface $restrictionResolver */
$restrictionResolver-&gt;resolve(...);</code></pre>
<p>Here the PHPStan knows everything and has our back <p class="text-success pt-3 pb-3">✅</p></p>
<p><strong>But how do we get the same luxury with callables?</strong> We can use docblock to define the types explicitly. We just move class method declaration from the very start to a <code>@var</code> format:</p>
<pre><code class="language-php">/** @var callable(Destination $destination): Restrictions $restrictionResolver */
$restrictionResolver(...);</code></pre>
<p>We have defined parameter types and a return type.</p>
<p><br></p>
<p>You can read more <a href="https://phpstan.org/writing-php-code/phpdoc-types#callables">in PHPStan docs</a>:</p>
<img src="/assets/images/posts/2022/mixed_callable_rule.png" class="img-thumbnail" style="max-width: 35em">
<p>It's almost identical to PHP type declaration syntax, except union type has to be wrapped in brackets <code>()</code>:</p>
<p><br></p>
<p>Now we know how to type callables in our code. Just image it's a class method and write the types:</p>
<pre><code class="language-php">/** @var callable(&lt;paramNamesWithTypes&gt;): &lt;returnType&gt; $&lt;variableName&gt; */</code></pre>
<p>In our case:</p>
<pre><code class="language-php">/** @var callable(Destination $destination): Restrictions $restrictionResolver */</code></pre>
<p><br></p>
<p>But how do we detect this in CI before merging them in our code base?</p>
<h2 id="Detect-Mixed-Callables-in-2-Steps">Detect Mixed Callables in 2 Steps</h2>
<ol>
<li>Add new rule from <a href="https://github.com/symplify/phpstan-rules"><code>symplify/phpstan-rules</code></a>:</li>
</ol>
<pre><code class="language-yaml"># phpstan.neon
rules:
    - Symplify\PHPStanRules\Rules\Explicit\NoMixedCallableRule</code></pre>
<p>Update: Ondra shared with me, that you can also <a href="https://twitter.com/OndrejMirtes/status/1495064465339039751">use parameter</a> for similar check outside levels:</p>
<pre><code class="language-yaml">parameters:
    checkMissingCallableSignature: true</code></pre>
<ol start="2">
<li>Run PHPStan:</li>
</ol>
<pre><code class="language-bash">vendor/bin/phpstan</code></pre>
<p>That's it!</p>
<p><br></p>
<p>To make the type as strict as possible, we always have to type all the places with callable:</p>
<ul>
<li>the assigned property with <code>@var</code>,</li>
<li>the parameter with <code>@param</code>,</li>
<li>the return value with <code>@return</code>,</li>
<li>and the inlined variables with <code>@var ... $variableName</code>.</li>
</ul>
<p>Then your PHPStan will see much more than before, making your code <strong>even safer to work with</strong>!</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/get-rid-of-mixed-callables-with-phpstan</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 31 Jan 2022 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/get-rid-of-mixed-callables-with-phpstan#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Not all Mixed Types are Equally Useless ]]></title>
                <link>https://tomasvotruba.com/blog/not-all-mixed-types-are-equally-useless</link>
                <description><![CDATA[ <p>Do you have a big project where you try to raise the PHPStan level as high as possible? Yet, you're stuck on level 4 or 5 with thousands of errors? We all have one and try to chip away a few errors now and then.
<br><br>
The <code>mixed</code> type is the worst of all of them. Fixing all <code>mixed</code> types to a specific type is a nightmare for the REST of your life (pun intended). But what if there are places where fixing <code>mixed</code> type <strong>brings much more value than</strong> in the others?</p> ]]></description>
                <content:encoded><![CDATA[ <img src="/assets/images/posts/2021/equal_animals.png" style="max-width: 32em" class="img-thumbnail mt-2 mb-5">
<p>We're in a state where code runs, tests pass, and everything works. We can find snippets like this one:</p>
<pre><code class="language-php">function printNames(array $names)
{
    foreach ($names as $name)
    {
        echo $name;
    }
}</code></pre>
<p>We know that the <code>$names</code> parameter is <code>mixed[]</code> type. It is probably a <code>string[]</code>, <code>int[]</code> or <code>StringableInterface</code> type. We could run the code, write the test, detect the type and complete it.</p>
<p>But by adding a specific type here, <strong>we will not get much new information</strong>. The value will still be echo-able, and the code will still work. We will have one less ignored error in <code>phpstan.neon</code>.</p>
<h2 id="Business-Focused-Low-Hanging-Fruit">Business-Focused Low Hanging Fruit</h2>
<p>Maybe my boss would let me remove all the <code>mixed</code> types from the project, but it would make their expenses high enough to fire me. The coding must be economical and beneficial for the project's future.</p>
<p>Instead of looking for the origin of <code>mixed</code> with the attention of detective Colombo, we could do something better with our time. We could find those <code>mixed</code> type that is now blocking PHPStan from further analysis. We do not have to test manually a <code>mixed</code> type and hope for the user input.</p>
<p>In the same project, we find the following code:</p>
<pre><code class="language-php">function printNames(array $videos)
{
    foreach ($videos as $video)
    {
        echo $this-&gt;renderUrl($video-&gt;getUrl());
    }
}</code></pre>
<p>From the PHPStan point of view, this snippet is identical to the previous one. There is a variable <code>$videos</code> with <code>mixed[]</code> type. <strong>PHPStan can't analyze the <code>mixed</code> type</strong>, as it can be anything from scalar, <code>null</code>, <code>false</code>, object, collection of objects and nested array of all above, etc.</p>
<p>What can we assume from this code?</p>
<pre><code class="language-php">$video-&gt;getUrl()</code></pre>
<ul>
<li>it's a method call</li>
<li>the <code>$video</code> is an object</li>
<li>the <code>$video</code> object has a <code>getUrl()</code> method</li>
</ul>
<p>How can we deduct the type of object here?</p>
<h2 id="PHPStorm-Search-to-the-Rescue">PHPStorm Search to the Rescue</h2>
<p>Here you could read a complex passage about types, abstract syntax tree, static analysis, etc.</p>
<p><br></p>
<p>Instead, we'll be KISSing PHPStorm:</p>
<ul>
<li>use <em>Find in files</em> action</li>
<li>search for a &quot;public function getUrl()&quot; string</li>
</ul>
<img src="/assets/images/posts/2021/find_in.png" style="max-width: 32em" class="img-thumbnail mt-2 mb-2">
<p><br></p>
<p>We see the responsible type is <code>Video</code> object, and we can complete it to our code:</p>
<pre><code class="language-diff">+/**
+ * @param Video[] $videos
+ */
 function printNames(array $videos)
 {
     foreach ($videos as $video)
     {
         echo $this-&gt;renderUrl($video-&gt;getUrl());
     }
 }</code></pre>
<p>Thanks to this type the PHPStan now can analyze if:</p>
<ul>
<li>arguments in <code>getUrl()</code> are valid (if any provided)</li>
<li>the <code>$this-&gt;renderUrl()</code> param type is compatible with <code>getUrl()</code> return type</li>
</ul>
<p class="text-success pt-3 pb-3">
    ✅
</p>
<p>That's how we can use a method call on <code>mixed</code> to our advantage.</p>
<p><br></p>
<h2 id="The-and-quot-Object-mixed-and-quot-and-gt-any-mixed">The &quot;Object <code>mixed</code>&quot; &gt; any <code>mixed</code></h2>
<p>The second use case for object <code>mixed</code> is similar. You can probably already guess it:</p>
<pre><code class="language-php">function collectIds(array $videos): array
{
    $ids = [];
    foreach ($videos as $video)
    {
        $ids[] = $video-&gt;id;
    }

    return $ids;
}</code></pre>
<p>Yes, it's property fetch. We can fetch property only on a specific object. Well, except <code>stdClass</code> that is typical for <code>json_decode()</code> return values. But apart from that, property fetch is a sure sign of a known object.</p>
<p>Again, we'll be KISSing PHPStorm:</p>
<ul>
<li>use <em>Find in files</em> action</li>
<li>search for a &quot;public $id;&quot; string</li>
</ul>
<p><br></p>
<p>And complete the types based on found <code>Video</code> object:</p>
<pre><code class="language-diff">+/**
+ * @param Video[] $video
+ * @return int[]
+ */
 function collectIds(array $videos): array
 {
     $ids = [];
     foreach ($videos as $video)
     {
         $ids[] = $video-&gt;id;
     }

     return $ids;
 }</code></pre>
<p><br></p>
<p>Our code is now slightly more intelligent, and PHPStan now sees:</p>
<ul>
<li>if <code>$video</code> has property <code>$id</code></li>
<li>the <code>@var</code>/strict type of <code>$id</code> property</li>
</ul>
<p class="text-success pt-3 pb-3">
    ✅
</p>
<h2 id="How-detect-Object-mixed-with-PHPStan">How detect Object <code>mixed</code> with PHPStan?</h2>
<p>We can teach PHPStan to report these low-hanging fruit cases. The conditions are straightforward:</p>
<ul>
<li>the variable must be <code>Variable</code> (no magic)</li>
<li>the variable type must be <code>mixed</code></li>
<li>the element must be one of ↓</li>
</ul>
<pre><code class="language-php">// method call → MethodCall node
$video-&gt;getUrl();

$video-&gt;id;
// property fetch → PropertyFetch node</code></pre>
<p><br></p>
<p>You'd be surprised if you'd have to write those rules on your own.</p>
<p>They're freshly included in <a href="https://github.com/symplify/phpstan-rules">symplify/phpstan-rules</a> ↓</p>
<ul>
<li><a href="https://github.com/symplify/symplify/pull/3913">NoMixedMethodCallerRule</a></li>
<li><a href="https://github.com/symplify/symplify/pull/3912">NoMixedPropertyFetcherRule</a></li>
</ul>
<p><br></p>
<p>How did the rule perform on Symplify itself? The property rule passed without any report, but the method called one <strong>found over 20 cases of unknown type</strong>. Despite the fact we have PHPStan on level 8. Pretty neat, right?</p>
<p><br></p>
<h2 id="How-and-quot-Equal-and-quot-is-Your-Project">How &quot;Equal&quot; is Your Project?</h2>
<p>How many <code>object</code> mixed types do you have? Register rules and let PHPStan disclose the magic:</p>
<pre><code class="language-yaml"># phpstan.neon
rules:
    - Symplify\PHPStanRules\Rules\Explicit\NoMixedPropertyFetcherRule
    - Symplify\PHPStanRules\Rules\Explicit\NoMixedMethodCallerRule</code></pre>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/not-all-mixed-types-are-equally-useless</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 22 Nov 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/not-all-mixed-types-are-equally-useless#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Introducing Light Kernel for Symfony Console Apps ]]></title>
                <link>https://tomasvotruba.com/blog/introducing-light-kernel-for-symfony-console-apps</link>
                <description><![CDATA[ <p>In the first post of this miniseries, we look at Symfony Http Kernel with a critical eye on <a href="/blog/when-symfony-http-kernel-is-too-big-hammer-to-use">how it causes project overweight</a>.
<br><br>
In the second post, we <a href="/blog/decomposing-symfony-kernel-what-does-minimal-symfony-bundle-do">looked at bundles</a> from a very raw point of view - what do we need from them?
<br><br>
In the spirit of <a href="https://link.springer.com/referenceworkentry/10.1007%2F978-1-4020-8265-8_200183">thesis, antithesis, and synthesis</a> philosophy, today, we'll combine both parts. We'll look for a solution to the original question: <strong>How can we build Kernel in Console Application without the Http burden?</strong></p> ]]></description>
                <content:encoded><![CDATA[ <div class="card border-warning mt-4">
    <div class="card-header text-black bg-warning shadow">
        <strong>Proof over theory?</strong>
        ECS, Monorepo Builder, EasyCI, Config Transformer and Rector are using this method since 1st November 2021. ECS is now <a href="https://github.com/symplify/easy-coding-standard/commit/278d4d52958c1ca01c21219cb6e14ca4493914ad">40 000 lines lighter</a>, while keeping all the features running.
        <img src="/assets/images/posts/2021/ecs_light_commit.png" class="img-thumbnail mt-4">
    </div>
</div>
<blockquote class="blockquote">
    "Perfection is achieved, not when there is nothing more to add,<br>
    but when there is nothing left to take away."
    <footer class="blockquote-footer text-right">Antoine de Saint-Exupery</footer>
</blockquote>
<h2 id="Striving-for-Simplicity">Striving for Simplicity</h2>
<p>In previous posts, we defined requirements that we want from Symfony Kernel from Console Applications:</p>
<ul>
<li>build dependency injection container</li>
<li>use only <code>symfony/console</code> and <code>symfony/dependency-injection</code> packages</li>
<li>use as simple API as possible, ideally Kernel with 1 method that loads configs</li>
<li>avoid the <em>http</em> part of Symfony Kernel, as we don't use it in CLI</li>
</ul>
<h2 id="What-do-we-Have">What do we Have?</h2>
<p>Currently, we have old projects that use <code>symfony/http-kernel</code> with a bunch of bundles. But when we look closer at Symfony bundles, we'll see <a href="/blog/decomposing-symfony-kernel-what-does-minimal-symfony-bundle-do">they only add configs and compiler passes</a>. So we can drop bundles and extensions altogether.</p>
<h2 id="What-do-we-Want">What do we Want?</h2>
<p>Drop dependency on <code>symfony/http-kernel</code>, but make the project work as before.</p>
<img src="/assets/images/posts/2021/light_remove_http_kernel.png" class="img-thumbnail" style="max-width: 25em">
<p><br></p>
<p>In an ideal world, we want a container factory class that loads provided configs:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\ContainerBuilder;

final class ContainerBuilderFactory
{
    /**
     * @param string[] $configFiles
     * @param CompilerPassInterface[] $compilerPasses
     * @param ExtensionInterface[] $extensions
     */
    public function create(
        array $configFiles,
        array $compilerPasses,
        array $extensions
    ): ContainerBuilder {
        $containerBuilder = new ContainerBuilder();

        foreach ($extensions as $extension) {
            $containerBuilder-&gt;registerExtension($extension);
        }

        foreach ($configFiles as $configFile) {
            $delegatingLoader-&gt;load($configFile);
        }

        foreach ($compilerPasses as $compilerPass) {
            $containerBuilder-&gt;addCompilerPass($compilerPass);
        }

        return $containerBuilder;
    }
}</code></pre>
<p><br></p>
<p>Then we could use it directly in any command-line application Kernel:</p>
<pre><code class="language-php">use Psr\Container\ContainerInterface;
use Symplify\SymplifyKernel\ContainerBuilderFactory;
use Symplify\ComposerJsonManipulator\ValueObject\ComposerJsonManipulatorConfig;

final class MonorepoBuilderKernel
{
    /**
     * @param string[] $configFiles
     */
    public function createFromConfigs(array $configFiles): ContainerInterface
    {
        // provide local config here
        $configFiles[] = __DIR__ . '/../../config/config.php';

        // external configs
        $configFiles[] = ComposerJsonManipulatorConfig::FILE_PATH;

        $containerBuilderFactory = new ContainerBuilderFactory();

        $containerBuilder = $containerBuilderFactory-&gt;create($configFiles, [], []);

        // build the container
        $containerBuilder-&gt;compile();

        return $containerBuilder;
    }
}</code></pre>
<p><br></p>
<p>How would it meet our requirements?</p>
<ul>
<li>single method <span class="text-success pt-3 pb-3">✅</span></li>
<li>only <code>symfony/dependency-injection</code> <span class="text-success pt-3 pb-3">✅</span></li>
<li>no http <span class="text-success pt-3 pb-3">✅</span></li>
</ul>
<h2 id="How-to-use-ContainerBuilderFactory-in-3-Steps">How to use ContainerBuilderFactory in 3 Steps</h2>
<p>For a couple of years, the <a href="https://github.com/symplify/symplify">Symplify</a> uses own Symfony Kernel wrapper package - the <code>symplify/symplify-kernel</code>. It abstracts repeated methods and eases testing. What better place we could use for adding a dependency container factory?</p>
<p><br></p>
<p><strong>1. Install Symplify Kernel</strong></p>
<pre><code class="language-bash">composer require symplify/symplify-kernel</code></pre>
<p><br></p>
<p><strong>2. Extend <code>AbstractSymplifyKernel</code> and provide config files</strong></p>
<p>This the full kernel for the <a href="/blog/5-commands-from-easy-ci-that-makes-your-ci-stronger/">EasyCI package</a> looks like:</p>
<pre><code class="language-php">namespace Symplify\EasyCI\Kernel;

use Psr\Container\ContainerInterface;
use Symplify\Astral\ValueObject\AstralConfig;
use Symplify\ComposerJsonManipulator\ValueObject\ComposerJsonManipulatorConfig;
use Symplify\SymplifyKernel\HttpKernel\AbstractSymplifyKernel;

final class EasyCIKernel extends AbstractSymplifyKernel
{
    /**
     * @param string[] $configFiles
     */
    public function createFromConfigs(array $configFiles): ContainerInterface
    {
        $configFiles[] = __DIR__ . '/../../config/config.php';
        $configFiles[] = ComposerJsonManipulatorConfig::FILE_PATH;
        $configFiles[] = AstralConfig::FILE_PATH;

        return $this-&gt;create([], [], $configFiles);
    }
}</code></pre>
<p><br></p>
<p><strong>3. Boot Kernel in your bin file and enjoy the Symfony DI</strong></p>
<pre><code class="language-php">$easyCIKernel = new EasyCIKernel();
$easyCIKernel-&gt;createFromConfigs([__DIR__ . '/config/config.php']);

$container = $easyCIKernel-&gt;getContainer();

/** @var Application $application */
$application = $container-&gt;get(Application::class);
exit($application-&gt;run());</code></pre>
<p>That's it! In the end, the setup is very simple.</p>
<p>It allowed us to drop the following files from 4 Simplify CLI packages:</p>
<img src="/assets/images/posts/2021/light_kernel_vendor_diff.gif" class="img-thumbnail">
<p>Less code to transfer, faster CI pipelines, and environment-friendly code.</p>
<p><br></p>
<p>What would be even better? If Symfony core would provide a similar factory out of the box. Maybe one day, it will.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/introducing-light-kernel-for-symfony-console-apps</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 15 Nov 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/introducing-light-kernel-for-symfony-console-apps#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Run Naked Unit Tests in a New Legacy Project ]]></title>
                <link>https://tomasvotruba.com/blog/how-to-run-naked-unit-tests-in-a-new-legacy-project</link>
                <description><![CDATA[ <p>You know the situation. You come to a new project that you should upgrade and refactor. It has some tests that <del>you</del> long-term developer can run locally. But the automated CI that runs tests on every commit is missing.
<br>
<br>
Shall we start refactoring and adding CI tools like PHPStan or ECS? <strong>How about using what is already there</strong>? The tests.
<br>
<br>
But the tests require this PHP extension, those environment variables, this external service, and these few Docker images to be running.
<br><br>
What if we can <strong>find the naked unit tests</strong> and run them today by ourselves?</p> ]]></description>
                <content:encoded><![CDATA[ <div class="card border-warning mt-4">
    <div class="card-header text-black bg-warning shadow">
        <strong>Proof over theory?</strong>
        This technique allowed us to run 41 tests without any setup. That's 41 more than we usually have before investing a lot of learning time. Maybe it will help your legacy project too.
    </div>
</div>
<p><br></p>
<p>When we come to a project, the first thing to do is run tests. Just in case they work without any setup:</p>
<pre><code class="language-bash">vendor/bin/phpunit</code></pre>
<p><br></p>
<p>If we get a positive response and tests run successfully, we can thank the developers of this project and start upgrading and refactoring. But more likely, we get one of the following responses:</p>
<ul>
<li><em>function/extension is missing</em></li>
<li><em>ENV is missing</em></li>
<li><em>Redis is missing</em></li>
</ul>
<p>Then we can check for <code>.env</code>, <code>docker-compose.yml</code>, <code>phpunit.xml</code> extensions in <code>composer.json</code> or even <code>README.md</code> to figure out what extension we need to run the tests. But maybe, we don't have to.</p>
<h2 id="External-and-Local-test-Dependencies">External and Local test Dependencies</h2>
<p>Our tests depend on some manual steps we have to do. They do not work out of the box, but they might run after we complete this value here and run this CLI command.</p>
<p>The test dependency can be split into 2 categories:</p>
<ul>
<li>External: those which depend on <strong>on dynamic content</strong></li>
<li>Local: those that depend on the <strong>static source code</strong> itself</li>
</ul>
<p>The first group requires our manual input and research, so there is nothing we can do right now to run them except to learn more about the project.</p>
<p>However, we can run the second group right now:</p>
<pre><code class="language-php">use PHPUnit\Framework\TestCase;

use App\ValueObject\Tool;

final class SomeTest extends TestCase
{
    public function test()
    {
        $tool = new Tool('Rector');
        $this-&gt;assertSame('Rector', $tool-&gt;getName());
    }
}</code></pre>
<p>...and we can see if a test fails or passes. How?</p>
<pre><code class="language-bash">vendor/bin/phpunit</code></pre>
<p>Looks so easy, and it is.</p>
<p>But there is a catch. We <strong>have to know which of these are the local ones</strong> and which are hiding a fractal of dependencies.</p>
<p><br></p>
<h2 id="How-to-detect-Local-Test">How to detect Local Test?</h2>
<p>Let's look at examples. What dependencies does the following test have?</p>
<pre><code class="language-php">use Symfony\Bundle\FrameworkBundle\Test\KernelTestCase;

final class ControllerTest extends KernelTestCase
{
    public function tests()
    {
    }
}</code></pre>
<p>From <code>KernelTestCase</code> we can assume that:</p>
<ul>
<li>it depends on a framework</li>
<li>that depends on the dependency container being built</li>
<li>that depends on loaded bundles</li>
<li>that depends on a database</li>
<li>that depends on installed PHP extensions</li>
<li>that usually depends on Docker build</li>
<li>that depends on correct <code>.env</code> variables</li>
</ul>
<p>If the test meets one of these conditions, we can skip it.</p>
<p><br></p>
<p>All the other tests left are <strong>the ones we want to test</strong>. We put them explicitly into <code>phpunit.xml</code> into the new test suite:</p>
<pre><code class="language-xml">&lt;?xml version="1.0"?&gt;
&lt;phpunit
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="vendor/phpunit/phpunit/phpunit.xsd"
    bootstrap="vendor/autoload.php"
&gt;
    &lt;testsuites&gt;
        &lt;testsuite name="unit"&gt;
            &lt;file&gt;tests/Services/ConfigPrinterTest.php&lt;/file&gt;
            &lt;file&gt;tests/Services/PackageUpgradeTest.php&lt;/file&gt;
        &lt;/testsuite&gt;
    &lt;/testsuites&gt;
&lt;/phpunit&gt;</code></pre>
<p>So we go one test by one and carefully review their parent class...</p>
<p>That sounds like a lot of work. Hmm, how could we automate it?</p>
<h2 id="4-Steps-to-Automate-Local-Test-Detection">4 Steps to Automate Local Test Detection</h2>
<p>In previous post, we learned about few <a href="/blog/5-commands-from-easy-ci-that-makes-your-ci-stronger/">useful commands for Easy CI setup</a>. There is one more just for our use case.</p>
<p><br></p>
<p><strong>1. Install Composer Package</strong></p>
<pre><code class="language-bash">composer require symplify/easy-ci --dev</code></pre>
<p><br></p>
<p><strong>2. Run Command on your tests directory</strong></p>
<pre><code class="language-bash">vendor/bin/easy-ci detect-unit-tests tests</code></pre>
<p>This command generated a <code>phpunit-unit-files.xml</code> file that contains an XML list of detected test files.</p>
<p><br></p>
<p><strong>3. Open the <code>phpunit-unit-files.xml</code> and move files to your <code>phpunit.xml</code></strong></p>
<pre><code class="language-xml">&lt;?xml version="1.0"?&gt;
&lt;phpunit
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="vendor/phpunit/phpunit/phpunit.xsd"
    bootstrap="vendor/autoload.php"
&gt;
    &lt;testsuites&gt;
        &lt;testsuite name="unit"&gt;
            &lt;file&gt;tests/Services/ConfigPrinterTest.php&lt;/file&gt;
            &lt;file&gt;tests/Services/PackageUpgradeTest.php&lt;/file&gt;
        &lt;/testsuite&gt;
    &lt;/testsuites&gt;
&lt;/phpunit&gt;</code></pre>
<p><br></p>
<p><strong>4. Run <code>--testsuite</code> unit group</strong></p>
<pre><code class="language-bash">vendor/bin/phpunit --testsuite unit</code></pre>
<p>Then set up your CI to run all your local tests we've detected this way.</p>
<p>Your next refactoring is now a bit safer, and you can continue to learn more about the new project.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/how-to-run-naked-unit-tests-in-a-new-legacy-project</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 08 Nov 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/how-to-run-naked-unit-tests-in-a-new-legacy-project#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Decomposing Symfony Kernel: What does Minimal Symfony Bundle Do ]]></title>
                <link>https://tomasvotruba.com/blog/decomposing-symfony-kernel-what-does-minimal-symfony-bundle-do</link>
                <description><![CDATA[ <p>In the previous post, we looked at <a href="/blog/when-symfony-http-kernel-is-too-big-hammer-to-use">When Symfony Http Kernel is a Too Big Hammer to Use</a>. We talked about the enormous content this package provides, but we don't need it.
<br><br>
Today we'll have a little self-reflecting pause in the middle of the 4-post journey. We'll look at the main glue in Symfony Kernel - the Bundle. <strong>Can we find a way to decompose it and use it without Kernel?</strong></p> ]]></description>
                <content:encoded><![CDATA[ <p>In the previous post, we described the problem: the Symfony Kernel requires a lot of http-related code <strong>that we don't need in command line applications</strong>. We still have to maintain it, require-dev dependencies in production, and handle their downgrade.</p>
<p>When a pandemic hit our world in 2020, we didn't think about our studies, where we would go for a vacation, or what car we'd buy. We care about our family, what we eat for dinner, and where we can buy everyday life essentials. When we find ourselves in times of trouble, we try to look at bare essentials.</p>
<h2 id="What-are-the-Kernel-Essentials">What are the Kernel Essentials?</h2>
<p>How can we use this approach in the &quot;my application kernel is way too big&quot; situation?</p>
<p><br></p>
<p><strong>What do we need from Kernel?</strong></p>
<ul>
<li>To build our dependency injection container from provided PHP config.</li>
</ul>
<p><br></p>
<p><strong>How can Kernel do that?</strong></p>
<ul>
<li>It takes the main config, few bundles, and loads them together.</li>
</ul>
<p><br></p>
<p><strong>What is the bundle class doing?</strong></p>
<ul>
<li>It collects one PHP config, sometimes Extension or compiler passes, and passes it to Kernel to process further.</li>
</ul>
<p><br></p>
<p><strong>Which do we need from those 3?</strong></p>
<ul>
<li>The config, because it defines service autodiscovery, parameters, and sometimes manual arguments.</li>
<li>The Extension primarily refers to the config, so we don't need that.</li>
<li>We need compiler passes because they decorate service definitions and interact with each other.</li>
</ul>
<p><br></p>
<h2 id="1-The-Bundle">1. The Bundle</h2>
<p>Let's look at one of the Symplify bundles to demonstrate actual code. This is <code>AstralBundle</code>, which allows other kernels to register <code>symplify/astral</code> service and use them:</p>
<pre><code class="language-php">namespace Symplify\Astral\Bundle;

use Symfony\Component\HttpKernel\Bundle\Bundle;
use Symplify\Astral\DependencyInjection\Extension\AstralExtension;

final class AstralBundle extends Bundle
{
    protected function createContainerExtension(): AstralExtension
    {
        return new AstralExtension();
    }
}</code></pre>
<h3 id="2-The-Extension">2. The Extension</h3>
<p>The Bundle class contains <code>createContainerExtension()</code> that further creates <code>AstralExtension</code>. What is that extension doing?</p>
<pre><code class="language-php">namespace Symplify\Astral\DependencyInjection\Extension;

use Symfony\Component\Config\FileLocator;
use Symfony\Component\DependencyInjection\ContainerBuilder;
use Symfony\Component\DependencyInjection\Extension\Extension;
use Symfony\Component\DependencyInjection\Loader\PhpFileLoader;

final class AstralExtension extends Extension
{
    public function load(array $configs, ContainerBuilder $containerBuilder): void
    {
        $phpFileLoader = new PhpFileLoader(
            $containerBuilder,
            new FileLocator(__DIR__ . '/../../config')
        );

        $phpFileLoader-&gt;load('config.php');
    }
}</code></pre>
<p><br></p>
<p>It seems it loads the <code>../../config/config.php</code>. There we define services and parameters.</p>
<p>So we need:</p>
<ul>
<li>a <code>*Bundle</code> class,</li>
<li>an <code>*Extension</code> class,</li>
<li>and register the <code>*Bundle</code> class in <code>*Kernel.php</code> in the <code>registerBundles()</code> method.</li>
</ul>
<pre><code class="language-php">$fileLoader-&gt;load(__DIR__ . '/../../config.php');</code></pre>
<h2 id="Where-Else-can-we-Load-Configs">Where Else can we Load Configs?</h2>
<p>Does this look familiar? There are at least 2 places that handle the same operation. Nothing special, and they're pretty standard - you can see both in the code of this website.</p>
<p>One of them is <code>MicroKernelTrait::configureContainer()</code> method:</p>
<pre><code class="language-php">use Symfony\Bundle\FrameworkBundle\Kernel\MicroKernelTrait;
use Symfony\Component\Config\Loader\LoaderInterface;
use Symfony\Component\DependencyInjection\ContainerBuilder;
use Symfony\Component\HttpKernel\Kernel;

final class TomasVotrubaKernel extends Kernel
{
    use MicroKernelTrait;

    protected function configureContainer(
        ContainerBuilder $containerBuilder,
        LoaderInterface $loader
    ): void {
        $loader-&gt;load(__DIR__ . '/../../vendor/symplify/astral/config/config.php');
    }
}</code></pre>
<p><br></p>
<p>The other is in any <code>config/config.php</code> that we already load in our Kernel:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $containerConfigurator-&gt;import(
        __DIR__ . '/../../vendor/symplify/astral/config/config.php'
    );
};</code></pre>
<p>As you can see, we can replace Bundle + Extension classes with single-line import either in Kernel or in <code>config.php</code>. That's <strong>2 classes and one method we don't have to worry about anymore</strong>.</p>
<p class="text-success pt-3 pb-3">
    ✅
</p>
<p><br></p>
<p><del>Extension</del> is gone, and we can import config elsewhere. What about the compiler passes? We can <a href="https://symfony.com/doc/current/service_container/compiler_passes.html">add them in the Kernel</a> in <code>build()</code> method:</p>
<pre><code class="language-php">use Symfony\Bundle\FrameworkBundle\Kernel\MicroKernelTrait;
use Symfony\Component\DependencyInjection\ContainerBuilder;
use Symfony\Component\HttpKernel\Kernel as BaseKernel;

class Kernel extends BaseKernel
{
    use MicroKernelTrait;

    protected function build(ContainerBuilder $containerBuilder): void
    {
        $containerBuilder-&gt;addCompilerPass(new SomeCompilerPass());
    }
}</code></pre>
<p>We've managed to tidy up the Kernel a bit. With less code to work with, we might see the solution more easily... or <strong>have we just moved the same problem to somewhere else</strong>?</p>
<p>We'll see about that next time.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/decomposing-symfony-kernel-what-does-minimal-symfony-bundle-do</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 01 Nov 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/decomposing-symfony-kernel-what-does-minimal-symfony-bundle-do#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ When Symfony Http Kernel is a Too Big Hammer to Use ]]></title>
                <link>https://tomasvotruba.com/blog/when-symfony-http-kernel-is-too-big-hammer-to-use</link>
                <description><![CDATA[ <p>I've been a big fan of Symfony components for ages. I use them as core bricks of my projects <a href="/blog/2019/08/26/how-we-migrated-54-357-lines-of-code-nette-to-symfony-in-2-people-under-80-hours">migrate other frameworks to it</a>, and every 6 months, I'm excited about what new features are coming in the next minor release.
<br><br>
But, one tough spot has been bothering me for the last 4 years. I tried to find my way out of it, hack around it or accept it. In March 2021, we <a href="https://getrector.org/blog/2021/03/22/rector-010-released-with-php71-support#rector-on-php-7-1-and-7-2-without-docker">downgrade Rector 0.10 from PHP 8 to 7.1</a>, and the issue became visible more than ever.
<br><br>
I knew there was a time for a change.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Http-Kernel-and-Console-Applications">Http Kernel and Console Applications</h2>
<p>The command-line application is anything we run from CLI - PHPUnit, PHPStan, Rector, Composer, or ECS. At the start of building such an application, you stand in front of an important decision:</p>
<ul>
<li>manual construction of every service, aka &quot;manual dependency injection&quot;,</li>
</ul>
<pre><code class="language-php">use Symfony\Component\Console\Application;

$application = new Application();
$fileAnalyzer = new FileAnalyzer();
$application-&gt;addCommand(new ProcessCommand($fileAnalyzer));
$application-&gt;run();</code></pre>
<ul>
<li>or re-use of existing DI container</li>
</ul>
<pre><code class="language-php">use Symfony\Component\Console\Application;

$application = $container-&gt;get(Application::class);
$application-&gt;run();</code></pre>
<p>I grew up on DI containers, so I'm spoiled by the automatic injection and service management this pattern handle for me. That's why <a href="/blog/2018/05/28/build-your-first-symfony-console-application-with-dependency-injection-under-4-files/">I picked <code>symfony/http-kernel</code> to build console application</a>.</p>
<h2 id="What-about-symfony-dependency-injection">What about <code>symfony/dependency-injection</code>?</h2>
<p>The name seems quite fitting, right? We could provide a single config file, and that's it. Unfortunately, the name is a bit misleading. It does not handle compiler passes, extensions, service autodiscovery, container cache, and container build. You'll find most of the building bricks there, <strong>but the glue is missing</strong>.</p>
<p>There is no &quot;container factory&quot; class in <code>symfony/dependency-injection</code>, that would handle even the simplest use case:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\ContainerFactory;
use Symfony\Component\Console\Application;

$containerFactory = new ContainerFactory();
$container = $containerFactory-&gt;createFromConfigs([__DIR__ . '/config/config.php']);

$application = $container-&gt;get(Application::class);</code></pre>
<p><br></p>
<p>On the other hand, there is an <a href="https://matthiasnoback.nl/2014/04/theres-no-such-thing-as-an-optional-dependency/">&quot;optional dependency&quot;</a> on <code>symfony/http-kernel</code> package. Some Symfony components are decoupled well, but some are <a href="https://paul-m-jones.com/post/2013/01/02/symfony-components-sometimes-decoupled-sometimes-not/">mutually dependent even if you don't need them</a>:</p>
<img src="/assets/images/posts/2021/symfony_kernel/symfony_paul_m_jones.png" class="img-thumbnail">
<p>And we're forced to use Kernel with Http.</p>
<p><br></p>
<p>Btw, both articles by <a href="https://matthiasnoback.nl/2014/04/theres-no-such-thing-as-an-optional-dependency/">Matthias Noback</a> and <a href="https://paul-m-jones.com/post/2013/01/02/symfony-components-sometimes-decoupled-sometimes-not/">Paul M. Jones</a> are not just critics of tight coupling, but great specific tips about how to create a future proof and solid architecture design. If you haven't seen them, make sure you grasp the main ideas, and they will serve you in the future.</p>
<h2 id="There-is-no-and-quot-Http-and-quot-in-CLI">There is no &quot;Http&quot; in CLI</h2>
<p>The command-line application run in a command line. There is no HTTP request, no browser, no routes, no session, no-cache.</p>
<p>Instead of URL with parameters, <strong>we run command-line arguments and options</strong>:</p>
<pre><code class="language-bash">composer require symfony/http-kernel --dev</code></pre>
<h2 id="The-4-Components-you-don-t-Need-but-Must-Have">The 4 Components you don't Need, but Must Have</h2>
<p>If there few more &quot;http&quot; classes we never use, we can live with that.</p>
<p>But what do we get when we actually run the composer command above?</p>
<img src="/assets/images/posts/2021/symfony_kernel/composer_require.gif" class="img-thumbnail">
<p><br></p>
<p>There are some packages related to http that's expected. But why is there debugging package in our production tool?</p>
<img src="/assets/images/posts/2021/symfony_kernel/symfony_dependent_var_dumper.gif" class="img-thumbnail">
<p><br></p>
<p>So when we require <code>symfony/http-kernel</code>, we also get 4 more packages we don't use:</p>
<ul>
<li><code>symfony/error-handler</code> - for debug?</li>
<li><code>symfony/event-dispatcher</code> - in case we <em>might use</em> events some day?</li>
<li><a href="https://github.com/symfony/http-foundation"><code>symfony/http-foundation</code></a> - over 40 classes related exclusively to http request and response</li>
<li><code>symfony/var-dumper</code> - for debug?</li>
</ul>
<p><br></p>
<p>Maybe we could say:</p>
<blockquote class="blockquote text-center">
That's "optional dependency" in case of<br>
"dev" environment to report bugs.
</blockquote>
<p>That's completely ok for <a href="https://en.wikipedia.org/wiki/Request%E2%80%93response">request and response</a> http workflow, but <strong>one more package we'll never use, but have to maintain</strong>.</p>
<p>Now we understand why most CLI app developers decided not to use any container but <a href="https://github.com/composer/composer/blob/e6cfc924f24089bc02cf8f4d27367b283247610e/src/Composer/Console/Application.php#L490-L519">create their services manually</a>.</p>
<h2 id="The-Downgrade-Covariance-of-Symfony-Config">The Downgrade Covariance of Symfony Config</h2>
<p>You might think:</p>
<blockquote class="blockquote text-center">
What do you mean by 'maintain'? It's few dependencies<br>
that we'll never use and just take little space on a disk.
<br>
What's the big deal?
</blockquote>
<p>Let's get back to the start. In April 2021, we started to develop Rector on PHP 8 and <a href="https://getrector.org/blog/2021/03/22/rector-010-released-with-php71-support#rector-on-php-7-1-and-7-2-without-docker">release PHP 7.1 downgraded version</a>. Downgraded and scoped version means fully downgraded and scoped <code>/vendor</code>. Yes, including all Symfony components we use.</p>
<p>The downgrade PHP market is still quite a niche, but <strong>the community is interested more and more in this field</strong>. In December 2021 alone, there have been over 20 brand new downgrade rules contributed from Rector users.</p>
<h2 id="Try-to-Downgrade-Invalid-Code-with-Invalid-Types">Try to Downgrade Invalid Code with Invalid Types</h2>
<p>When we started downgrading Rector, we often came to incompatible types in <code>FileLoader</code> classes. The <a href="https://wiki.php.net/rfc/covariant-returns-and-contravariant-parameters">covariant parameters added in PHP 7.4</a> started to cause problems on PHP 7.3 and bellow.</p>
<p>The most problematic was a downgrade of <code>import()</code> methods.</p>
<p><br></p>
<p>In <a href="https://github.com/symfony/symfony/blob/54015cccf0236bbdb38cd5abae5b2bdc89aa8ac2/src/Symfony/Component/Config/Loader/FileLoader.php#L71">config <code>FileLoader.php</code></a> they require <code>bool</code> parameter:</p>
<pre><code class="language-php">public function import($resource, $type = null, bool $ignoreErrors = false) {}</code></pre>
<p>But in a <a href="https://github.com/symfony/symfony/blob/54015cccf0236bbdb38cd5abae5b2bdc89aa8ac2/src/Symfony/Component/DependencyInjection/Loader/FileLoader.php#L55">dependency injection <code>FileLoader.php</code></a> that inherits former class, it is <code>string|bool</code>:</p>
<pre><code class="language-php">public function import($resource, $type = null, bool|string $ignoreErrors = false) {}</code></pre>
<p><br></p>
<p>We worked on a downgrade fix for 2 months before figuring our rules were correct. The problem is in contracts of Symfony method, which is invalid on PHP 7.3 and below.</p>
<h2 id="Accidental-Complexity">Accidental Complexity?</h2>
<p>The problem is not about invalid contracts, and anyone could make a mistake in those. The problem is in <strong>maintaining code we don't need nor use</strong>.</p>
<h2 id="Need-for-Really-Decoupled-Container-Factory">Need for Really Decoupled Container Factory</h2>
<p>I wish there were a more straightforward container factory service that we could add to the project:</p>
<pre><code class="language-bash">symfony/dependency-container-factory

Installing...
* symfony/dependency-container-factory
* symfony/dependency-injection</code></pre>
<p><br></p>
<p>That would allow us only to create the container. With no extra dependencies, with a focus on service tree construction:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\ContainerFactory;
use Symfony\Component\Console\Application;

$compilerPasses = [...];
$extensions = [...];

$containerFactory = new ContainerFactory($compilerPasses, $extensions);
$container = $containerFactory-&gt;createFromConfigs([__DIR__ . '/config/config.php']);

$application = $container-&gt;get(Application::class);</code></pre>
<p class="text-success pt-3 pb-3">✅</p>
<p><br></p>
<p>It would make CLI apps much cleaner and easier to use Symfony in them.</p>
<p><br></p>
<p>What do you think? <strong>What is your approach to creating service in your CLI applications?</strong></p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/when-symfony-http-kernel-is-too-big-hammer-to-use</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 25 Oct 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/when-symfony-http-kernel-is-too-big-hammer-to-use#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 5 Commands from Easy CI that Makes Your CI Stronger ]]></title>
                <link>https://tomasvotruba.com/blog/5-commands-from-easy-ci-that-makes-your-ci-stronger</link>
                <description><![CDATA[ <p>Sometimes my clients need a specific CI check that spots tiny but annoying bugs, and they cannot be discovered by PHPStan, Rector, or coding standard tool. It can be unresolved conflict <code>&lt;&lt;&lt;&lt;&lt;&lt;</code>, invalid config syntax, or forgotten commented code.
<br><br>
Usually, we write specific PHP commands just for the particular project and let them rotten in spaghetti time. Instead, I cherry-pick those commands to <strong>a package called <code>symplify/easy-ci</code></strong>. That way, I can use them in any project and improve them.
<br><br>
Today we'll look at 5 commands you can use in your CI. <strong>They might save you from bugs that no other tool can check</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>To start, we first add the package:</p>
<pre><code class="language-bash">composer require symplify/easy-ci --dev</code></pre>
<h2 id="1-Check-Latte-templates-for-Existing-Code">1. Check Latte templates for Existing Code</h2>
<p>PHPStorm is very good at renaming classes and methods. But its power stops at templates and configs, leading to bugs when the template contains a non-existing method. It can take days to discover this, as not everyone has tested and not everyone has I test that check every single render path of every template.</p>
<h3 id="What-does-it-do">What does it do?</h3>
<p>This command checks <code>*.latte</code> templates for:</p>
<ul>
<li>existing classes</li>
<li>existing methods</li>
<li>existing constants</li>
</ul>
<pre><code class="language-html">{if App\Utils::validateUlr($url)}
    ...
    &lt;p&gt;{App\ErrorMessg:VALID}&lt;/p&gt;
{else}
    ...
    &lt;p&gt;{App\ErrorMessage::NOT_VALID}&lt;/p&gt;
{/if}</code></pre>
<h3 id="How-to-Use-it">How to Use it?</h3>
<pre><code class="language-bash">vendor/bin/easy-ci check-latte-template &lt;paths&gt;

# e.g.
vendor/bin/easy-ci check-latte-template app src</code></pre>
<p class="text-success pt-3 pb-3">✅</p>
<h2 id="2-Checks-NEON-YAML-Configs-for-Existing-Classes">2. Checks NEON/YAML Configs for Existing Classes</h2>
<p>This command is similar to the above. If PHPStorm or any developer renames a class, it can be missed in configs.</p>
<h3 id="What-does-it-do">What does it do?</h3>
<p>It checks all <code>*.neon</code> and <code>*.yaml</code> files for:</p>
<ul>
<li>existing classes</li>
<li>existing class constants</li>
</ul>
<pre><code class="language-yaml">services:
    -
        class: App\SomeService
        arguments:
            level: App\Level::TOPP</code></pre>
<h3 id="How-to-Use-it">How to Use it?</h3>
<pre><code class="language-bash">vendor/bin/easy-ci check-config &lt;paths&gt;

# e.g.
vendor/bin/easy-ci check-config config</code></pre>
<p class="text-success pt-3 pb-3">✅</p>
<h2 id="3-Check-NEON-for-Complex-Syntax">3. Check NEON for Complex Syntax</h2>
<p>How can we write the YAML syntax above in NEON? Very similar, but also in a much shorter way thanks to &quot;NEON entities&quot;:</p>
<pre><code class="language-neon">services:
    - App\SomeService([App\Level::TOPP])</code></pre>
<p>Do you understand this code? I'm not sure if it's interface, class, arguments of the method call.
<br>
<br>
This magic syntax also proven very hard to analyze with other tools. That's why we added a check to require explicit and straightforward code:</p>
<pre><code class="language-yaml">services:
    -
        class: App\SomeService
        arguments:
            level: App\Level::TOPP</code></pre>
<h3 id="What-does-it-do">What does it do?</h3>
<p>It checks <code>*.neon</code> files to a magical inlined configuration that can be written explicit and transparent way.</p>
<h3 id="How-to-Use-it">How to Use it?</h3>
<pre><code class="language-bash">vendor/bin/easy-ci check-neon &lt;paths&gt;

# e.g.
vendor/bin/easy-ci check-neon config</code></pre>
<p class="text-success pt-3 pb-3">✅</p>
<h2 id="4-Check-for-Unresolved-Conflicts">4. Check for Unresolved Conflicts</h2>
<p>Sometimes we merge old pull-request, and we have to rebase dozens of commits in the past. In 99 % of use cases, it goes well, or the CI reports a failure, but in 1 %, it hits us.</p>
<pre><code class="language-html">The price of this product is
&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD
0
=======
100
&gt;&gt;&gt;&gt;&gt;&gt;&gt; branch-a</code></pre>
<p>And then we have to explore how it got here, who added it etc. Why waste the energy if you can find this before merging?</p>
<h3 id="What-does-it-do">What does it do?</h3>
<p>Goes through all files and detects any unresolved <code>&lt;&lt;&lt;&lt;&lt;&lt;&lt;</code> code.</p>
<h3 id="How-to-Use-it">How to Use it?</h3>
<pre><code class="language-bash">vendor/bin/easy-ci check-conflicts &lt;paths&gt;

# e.g.
vendor/bin/easy-ci check-conflicts .</code></pre>
<p class="text-success pt-3 pb-3">✅</p>
<h2 id="5-Detect-Commented-Code">5. Detect Commented Code</h2>
<p>Last but not least, sometimes, we temporarily comment out a chunk of code. We're testing something, or we don't need the method right now, so we comment it. Keeping commented code in main codebase is wrong for couple reasons:</p>
<ul>
<li>We have tools like <code>git history</code> and <code>git blame</code> to re-use old code.</li>
<li>When we merge the pull-request, we don't known if we've left some commented code we forgot to use or remove.</li>
<li>If the commented code is part of security layer, we might have a business chasing our tail.</li>
</ul>
<h3 id="What-does-it-do">What does it do?</h3>
<p>It goes through all <code>*.php</code> files and looks for lines of <code>//</code> commented code:</p>
<pre><code class="language-php">final class MoneyTransferer
{
    public function run()
    {
           // @todo enable before merge
//         if (! $this-&gt;ensureHasAccess()) {
//              throw new ForbiddenAccessException();
//         }

        $this-&gt;sendMoney();
    }
}</code></pre>
<p>If there are 3 and more commented lines in a row, it will let you know.</p>
<h3 id="How-to-Use-it">How to Use it?</h3>
<pre><code class="language-bash">vendor/bin/easy-ci check-commented-code &lt;paths&gt;

# e.g.
vendor/bin/easy-ci check-commented-code app src packages</code></pre>
<p><br></p>
<p>Is the line limit too strict for your project?
<br>
Use <code>--line-limit</code> option to modify it to your needs:</p>
<pre><code class="language-bash">vendor/bin/easy-ci check-commented-code app src packages --line-limit 6</code></pre>
<p class="text-success pt-3 pb-3">✅</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/5-commands-from-easy-ci-that-makes-your-ci-stronger</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 18 Oct 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/5-commands-from-easy-ci-that-makes-your-ci-stronger#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Introducing up-to 16 Times Faster Easy Coding Standard ]]></title>
                <link>https://tomasvotruba.com/blog/introducing-up-to-16-times-faster-easy-coding-standard</link>
                <description><![CDATA[ <p>Do you use <a href="https://github.com/symplify/easy-coding-standard">Easy Coding Standard</a>? Do you find <strong>extremely useful and easy to use, but a little slow on a huge code base</strong>?
<br><br>
If you <a href="https://twitter.com/votrubaT">follow me carefully on Twitter</a>, you already know that the ECS got a new parallel run feature. I wanted to test it in a circle of early adopters first, so we make the run as smooth as possible for you.
<br><br>
Today, we're sharing the ECS Parallel run with the public, so you <strong>can cut down ECS run times from minutes to seconds</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <blockquote class="twitter-tweet"><p lang="en" dir="ltr">Have you already updated <a href="https://twitter.com/hashtag/ecs?src=hash&amp;ref_src=twsrc%5Etfw">#ecs</a> to parallel run? ☺️<br><br>This is what you're missing out ↓ <a href="https://t.co/fuBKMpl8ID">pic.twitter.com/fuBKMpl8ID</a></p>— Tomas Votruba (@VotrubaT) <a href="https://twitter.com/VotrubaT/status/1446065404976279558?ref_src=twsrc%5Etfw">October 7, 2021</a></blockquote>
<hr />
<h2 id="Bottle-Neck">Bottle Neck?</h2>
<p><a href="/blog/2018/10/22/brief-history-of-tools-watching-and-changing-your-php-code/">Coding Standard tools</a> are <strong>very fast in processing single file</strong>. They parse PHP code to tokens, analyze tokens in a foreach loop, and report found issues. The performance hit is in the number of processed files. If we have 10 files, the 1st file is processed. The 2nd file cannot start until the 1st file is finished.</p>
<p>Fortunately, this architecture has <strong>huge potential in performance improvement</strong> once we add a parallel run. That's what I've been working for July and August this summer. Huge thanks to Ondrej Mirtes for inspiration in <a href="https://phpstan.org/blog/from-minutes-to-seconds-massive-performance-gains-in-phpstan">PHPStan parallel run</a>.</p>
<h2 id="ECS-is-now-X-times-Faster">ECS is now X-times Faster!</h2>
<p>...where X = number of your CPU <em>threads</em>. What does it mean?</p>
<ul>
<li>
<p>Let's say your CPU has 4 cores. The ECS was running for 60 seconds on your project. Now it runs <strong>15 seconds</strong>. But there is more.</p>
</li>
<li>
<p>Some CPUs have 4 cores, but 8 <em>threads</em>. That means an improvement to <strong>7,5 seconds</strong>.</p>
</li>
</ul>
<p><br></p>
<p>You might think: &quot;such CPUs must be expensive and available only for high-end laptops&quot;. You'll be surprised.</p>
<ul>
<li>My middle-end laptop uses <a href="https://en.wikipedia.org/wiki/Ryzen#Mobile_3">Ryzen 7 made in 2020</a>. It has 8 cores with 16 threads. Now we have <strong>16-times faster runs</strong>, from 60 seconds to <strong>3,75 seconds</strong>.</li>
</ul>
<h2 id="Don-t-Take-My-Word-for-It">Don't Take My Word for It</h2>
<p>We've got few reports from our early adopters. How does ECS handle their projects?</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Thanks, <a href="https://twitter.com/VotrubaT?ref_src=twsrc%5Etfw">@VotrubaT</a> for adding parallel run to ECS 🥰. Running on Shopware 6 needs now 24s instead of 229s. <a href="https://t.co/cuxKy2ubfE">pic.twitter.com/cuxKy2ubfE</a></p>— Shyim (@Shyim97) <a href="https://twitter.com/Shyim97/status/1447588634203508739?ref_src=twsrc%5Etfw">October 11, 2021</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<h2 id="Enjoy-Parallel-ECS-in-Your-Project-Today">Enjoy Parallel ECS in Your Project Today</h2>
<p>How to add this feature to your project?</p>
<p>Be sure to use at least ECS 9.4.70:</p>
<pre><code class="language-bash">composer require symplify/easy-coding-standard:^9.4.70</code></pre>
<p>And enable a new parameter in your <code>ecs.php</code> config file:</p>
<pre><code class="language-diff"> use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
 use Symplify\EasyCodingStandard\ValueObject\Option;

 return function (ContainerConfigurator $containerConfigurator): void {
     $parameters = $containerConfigurator-&gt;parameters();
+    $parameters-&gt;set(Option::PARALLEL, true);
 };</code></pre>
<p>That's it!</p>
<p><br></p>
<p>The parallel run might become enabled by default in ECS 10. We have enough time to test it on real projects and make it reliable till then. So far, it has been tested on Linux and Windows. If you're lucky enough to find the edge case, <a href="https://github.com/symplify/symplify/issues/new">please let us know in issues</a>, so we can cover it.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/introducing-up-to-16-times-faster-easy-coding-standard</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 11 Oct 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/introducing-up-to-16-times-faster-easy-coding-standard#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 7 Steps to Start with Parallel Run in PHP CLI App ]]></title>
                <link>https://tomasvotruba.com/blog/7-steps-to-start-with-parallel-run-in-php-cli-app</link>
                <description><![CDATA[ <p>To be honest, I have no idea what I'm doing. I've read a couple of posts about parallel processes in PHP, but most got me confused even more than before. Too much vague theory links to dozens of open-source packages, 5 alternatives to one operation, and other education faults.
<br><br>
What I missed <strong>was a to-do list for a 6-year old PHP programmer</strong>. Straightforward, with everyday terminology developers, already know.
<br><br>
Do you want to have <strong>a better idea of how to add a parallel run to one of PHP CLI apps</strong>?<br>
<br>
This post will get you from 0 to padawan in a couple of minutes.</p> ]]></description>
                <content:encoded><![CDATA[ <p><em>Disclaimer: if you do parallel for a couple of years, this post is not for you. This post will only confuse you with incorrect interpretations that you have to correct in tweets and comments. This post is not for experts but for those who want to try it today for the first time.</em></p>
<blockquote class="blockquote text-center">
    "If you can't explain it to a 6-year-old,<br>
    you don't understand it yourself."
</blockquote>
<p>Last month I tweeted about <a href="/blog/introducing-up-to-16-times-faster-easy-coding-standard/">16x faster ECS</a>, the most significant performance improvement I've ever seen since upgrade to PHP 7.</p>
<p><br></p>
<p>I got one question about the architecture:</p>
<p><br></p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Blog post coming on how you achieved it? It would be good to have blog post on how to do parallel run efficiently in PHP.</p>— Ishan Vyas (@Ishanvyas22) <a href="https://twitter.com/Ishanvyas22/status/1446085620535758850?ref_src=twsrc%5Etfw">October 7, 2021</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>Today I'll share my limited experience with parallel <strong>CLI PHP Apps</strong>. It's an experience I got by exploring PHPStan code and hundreds of trials and errors. What is CLI PHP App? <strong>A PHP tools that you run in command line</strong> - ECS, php-cs-fixer, PHP_CodeSniffer, PHPStan, Rector, PHPUnit, Composer etc.</p>
<p>Is all clear? Let's start.</p>
<p><br></p>
<img src="/assets/images/posts/2021/parallel_dummy.jpg" class="img-thumbnail">
<h2 id="1-It-s-Simpler-Then-You-Think">1. It's Simpler Then You Think</h2>
<p>I met with parallel in <a href="https://www.youtube.com/watch?v=ktfyEKUrabw">a live stream 4 years ago</a>. My first problem with a parallel run was that developers who talked about it made the topic sound very complex. I asked one question to understand one concept better, but in the end, I was even more confused than before I asked.</p>
<p>That made me think:</p>
<ul>
<li><em>&quot;parallel run in PHP is something very complicated&quot;</em></li>
<li><em>&quot;it requires dozens of hours of studying, maybe even studying university courses&quot;</em></li>
<li><em>&quot;I need a private paid project that needs this feature, so I have a chance to learn it for a couple of months&quot;</em></li>
</ul>
<p>I have good news for you - none of it is true. You just have to be lucky to come around <strong>sources that make you feel smarter</strong>.</p>
<p>The first point is: <strong>it's simpler than you think</strong>.</p>
<h2 id="2-Main-Goal-Faster">2. Main Goal? Faster!</h2>
<p>We don't implement it because it's cool, not because PHP allows it or not because it improves our architecture.</p>
<p><strong>We want to get somewhere significantly faster</strong>. We're talking 10-20x faster.</p>
<h2 id="3-It-s-about-CPU-Threads">3. It's about CPU Threads</h2>
<p>Last year, my laptop got a little shower from wild traveling and decided to stop working. Czech law gives the seller a month to process the warranty, so I had to get a replacement for the next month.</p>
<p>I bought the first Lenovo Thinkpad that looked similar to the one I used, so I don't have to learn a new keyboard for a single month. I got a surprise: <strong>the PHPStan run was cut down to half</strong>.</p>
<p>Why? The parallel run is as x-faster, where x is a number of CPU threads. It's not about CPU cores, but <strong>about CPU threads</strong>. In my temporary laptop, there was an <a href="https://en.wikipedia.org/wiki/Ryzen">AMD Ryzen</a> CPU that had 8 cores but excellent 16 threads.</p>
<p>That means every parallel process based on CPU cores is 16x faster.</p>
<p>Have you waited 2 minutes to finish a command-line process? <strong>Now it's 8 seconds.</strong></p>
<h2 id="4-Look-for-The-Bottle-Neck">4. Look for The Bottle Neck</h2>
<p>Typical ECS command looks like this:</p>
<pre><code class="language-bash">vendor/bin/ecs check src</code></pre>
<p>This command finds all PHP files in the <code>/src</code> directory and runs foreach to check for coding standard violations. Roughly like this:</p>
<pre><code class="language-php">$foundFiles = $this-&gt;findFiles(__DIR__ . '/src');

foreach ($foundFiles as $foundFile) {
    $this-&gt;codingStandardApplication-&gt;processFile($foundFile);
}</code></pre>
<p>Before the 2nd file can be processed by coding standard, we have to wait for the 1st file to finish.</p>
<p><strong>This is the bottleneck.</strong></p>
<p>How to start with parallelization? Look for &quot;the main&quot; <code>foreach (...)</code> in your code.</p>
<h2 id="5-Processes-are-on-Their-Own">5. Processes are on Their Own</h2>
<p>What do you do when you need a repository service in your project? We inject it via the constructor and use it. It has access to a database, where are data all up-to-date, and we can load, edit and delete them. We trust the stability.</p>
<p>In parallel, this is a bit different. How?</p>
<p><br></p>
<p>This point started as a few sentences, but soon grew to its own post with. It's a metaphor that hits the nail on the head.</p>
<p><strong>Go read <a href="/blog/parallel-in-php-for-dummies-cooking-a-family-dinner">Parallel in PHP for Dummies? Cooking a Family Dinner</a></strong> and then come back for the best experience of this list.</p>
<h2 id="6-From-Foreach-to-Command">6. From Foreach to Command</h2>
<p>So now we know the processes run separately, each in its paste. But above we still have foreach. How do we run them separately without waiting for each other?</p>
<p>We refactor services call to another command-line command:</p>
<pre><code class="language-diff"> foreach ($familyMembers as $key =&gt; $familyMember) {
     $ingredientsChunk = $ingredientsChunks[$key];
-    $foundIngredients[] = $familyMember-&gt;findIngredients($ingredientsChunk);
+    $foundIngredients[] = exec(
+        'vendor/bin/find-ingredient --member $familyMember --chunk $ingredientsChunk
+     );
 }</code></pre>
<p>This way, we create as many subcommands on the background as many family members we have. Each of them runs separately.</p>
<p><br></p>
<p>How does this work in ECS? Before, we had one command to process all the files:</p>
<pre><code class="language-bash">vendor/bin/ecs check /src</code></pre>
<p>Now the main command is the same, but it runs itself on the background in multiple threads:</p>
<pre><code class="language-bash"># this is what we type
vendor/bin/ecs check /src

# this is what really happens
→    vendor/bin/ecs check-worker --cpu-thread 1 --files /src/first.php /src/second.php
→    vendor/bin/ecs check-worker --cpu-thread 2 --files /src/third.php /src/fourth.php</code></pre>
<p>What is the <code>check-worker</code> command exactly doing? It's the exact copy of the <code>check</code> command.
The <code>check</code> command used to be <code>foreach (...)</code> caller of service, but now it calls standalone processes.</p>
<h2 id="7-It-s-like-Calling-a-Rest-API-Route">7. It's like Calling a Rest API Route</h2>
<p>This step was blowing for me. The typical run of ECS checked files for coding standard violations and printed the errors - all inside on PHP container:</p>
<pre><code class="language-bash">vendor/bin/ecs check /src

Found 25 errors. Fix them with the "--fix" option.</code></pre>
<p>But how can we work with nested command calls? We do only have bash there, no PHP, no services, no container. <strong>Like when we call external API:</strong></p>
<pre><code class="language-bash">curl /app/find-ingredient --member 1 --chunk onion,garlic</code></pre>
<p>Does this remind you of something? What kind of response do we get when we call an API?</p>
<pre><code class="language-bash">curl /app/find-ingredient --member 1 --chunk onion,garlic
{"onion": "found", "garlic": "not_found"}</code></pre>
<p><strong>A JSON!</strong></p>
<p><br></p>
<p>So when we call the ECS worker command, we expect the JSON:</p>
<pre><code class="language-bash">→    vendor/bin/ecs check-worker --cpu-thread 1 --files /src/first.php /src/second.php
{"/src/first.php": {"error_count": 0}, "/src/second.php": {"error_count": 3}}</code></pre>
<p>This step makes sense to the whole previous workflow. It means we only have to return primary data. We cannot return services, value objects or nested arrays, or metadata. <strong>Only return what you need to show the user.</strong></p>
<p><br></p>
<p>To give you an idea, in ECS, the result for a single file looks like this:</p>
<pre><code class="language-json">[
    {
        "file_path": "/src/first.php",
        "error_messages": [
            "Use spaces over tabs"
        ],
        "file_diffs": [
            "-$value=1;\n;$value = 1;"
        ]
    }
]</code></pre>
<h2 id="Bonus-Tip-Strings-Value-Objects-to-the-Confidence">Bonus Tip: Strings? Value Objects to the Confidence</h2>
<p>This bonus tip is not limited to parallel, but it's a general lifesaver in an unstable environment.</p>
<p>Seeing arrays and strings above might give you shivers. How can we work with such unreliable data and pass them around our application? I feel you. When I don't have an object in my hand, I feel like I'm naked.</p>
<p>Let's put on pants and use value objects the instant we can:</p>
<pre><code class="language-php">final class FileResult implements JsonSerializable
{
    public function __construct(
        private string $filePath,
        private array $errorMessages,
        private array $fileDiffs,
    ) {
    }

    // we'll use this method in worker command to send the JSON result
    public function jsonSerialize(): array
    {
        return [
            'file_path' =&gt; $this-&gt;filePath,
            'error_messages' =&gt; $this-&gt;errorMessages,
            'file_diffs' =&gt; $this-&gt;fileDiffs,
        ];
    }
}</code></pre>
<p>When the worker command returns a string response, we'll turn it into value objects:</p>
<pre><code class="language-php">// string
$checkWorkerResult = exec(
    'vendor/bin/ecs check-worker --cpu-thread 1 --files /src/first.php /src/second.php'
);

// json
$checkWorkerJson = Json::decode($checkWorkerResult);

// array of FileResult value objects
$fileResults = [];
foreach ($checkWorkerJson as $fileResultJson) {
    $fileResults[] = new FileResult(
        $fileResultJson['file_path'],
        $fileResultJson['error_messages'],
        $fileResultJson['file_diffs']
    );
}</code></pre>
<p>That's it! Give it time, start slowly and make small pull requests.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/7-steps-to-start-with-parallel-run-in-php-cli-app</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 04 Oct 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/7-steps-to-start-with-parallel-run-in-php-cli-app#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Hidden Productivity Costs of Parallel Run ]]></title>
                <link>https://tomasvotruba.com/blog/hidden-productivity-costs-of-parallel-run</link>
                <description><![CDATA[ <p>Have you enabled parallel run in PHPStan and ECS? You know the speed gain is brutal. On the other hand, there are <strong>few hidden costs in developer experience</strong> I haven't faced before.
<br><br>
What are they, and how to mitigate their impact?</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="All-CPUs-are-Fully-Used">All CPUs are Fully Used</h2>
<p>PHPStan parallel implementation uses your CPU cores to process multiple files at once. When I run it on my PC, it looks like this:</p>
<img src="/assets/images/posts/2021/hidden_cost_cpu_history.png" class="img-thumbnail mt-3" style="max-width: 38em">
<p>That's great! 16 threads, all fully used. It means the static analysis process of any project ends up in 15 seconds. That's fast, and then I'll be able to continue.</p>
<p>The problem is, for these 15 seconds, the laptop does not have any spare computation power. It only focuses on tasks given by PHPStan, but <strong>everything else is slowed down</strong>.</p>
<p><a href="/blog/2020/01/13/why-is-first-instant-feedback-crucial-to-developers/">Instant feedback is essential</a> to stay in the flow and focused on the project. Any lag can destroy <a href="/blog/2018/09/13/your-brain-is-your-garden/">state of beautiful deep work</a>.</p>
<h2 id="Short-but-Complete-Lag">Short but Complete Lag?</h2>
<p>Imagine you're writing a post or a code, and then you have to pause for 15 seconds... or even 10 or 5 seconds. Your brain has to stop thinking, start caching the thoughts and code you want to write.</p>
<blockquote class="blockquote text-center mt-3 mb-5">
    Would you use PHPStorm<br>
    if it has 5 seconds lag everytime you create a new class?
</blockquote>
<p>What if you want to run PHPStan and one more tool, e.g., PHPUnit or ECS? The <strong>latter will suffer from low computation power</strong> and take much longer than parallel of PHPStan.</p>
<p><br></p>
<h2 id="Keep-1-CPU-Always-Free">Keep 1 CPU Always Free</h2>
<p>There is a workaround for this. We can tell PHPStan to use fewer threads than is our maximum. That way, there will always be one free:</p>
<pre><code class="language-yaml"># phpstan.neon
parameters:
    parallel:
        # for Tomas: 16 threads - 1
        maximumNumberOfProcesses: 15</code></pre>
<h2 id="Max-Full-Min-Free">Max Full !== Min Free</h2>
<p>Well, there will be one always free <em>on my pc</em>. The problem is, all the developers share the main <code>phpstan.neon</code> config. But what is the chance the developers use computers with the same amount of CPU threads?</p>
<p><br></p>
<p>It would be much better to have the option to see the number of accessible CPUs. Something like:</p>
<pre><code class="language-yaml"># phpstan.neon
parameters:
    parallel:
        minimumNumberOfFreeThreads: 1</code></pre>
<p>P.S.: If you know of such a feature, let me know.</p>
<p><br></p>
<h2 id="All-at-Once-of-One-by-One">All at Once of One by One?</h2>
<p>Imagine you have to compute 5 algebraic formulas. You can choose one from 2 ways to receive them:</p>
<ul>
<li>A) you'll get one every 10 minutes</li>
<li>B) you'll get all formulas at once</li>
</ul>
<p><br></p>
<p><strong>Which will cost you more time and which more energy?</strong></p>
<h2 id="Parallel-Drains-your-Battery-Much-Faster">Parallel Drains your Battery Much Faster</h2>
<p>Before parallel run was added to PHPStan, my laptop worked for only 4-5 hours of coding. I could go for coffee in the morning, see a client, do little mentoring, and it was still running in the afternoon.</p>
<p><br></p>
<p>As only 1 core was working, <strong>there was lot of energy left.</strong></p>
<img src="/assets/images/posts/2021/cores.jpg" class="img-thumbnail mt-2 mb-4" style="max-width: 27em">
<p>That changed since parallel. When you develop PHPStan rules or work on various projects, PHPStan often needs to analyze the whole project from scratch. That's fast in time but costly in energy.</p>
<p><br></p>
<p><strong>Suddenly, my laptop battery duration dropped from 5 hours to 2,5 hours</strong>. It turned off, charger at home and I was free to meditate.</p>
<p>The battery duration estimates were jumping like crazy from 6 hours to 30 minutes and back. First, I assumed it's some bug in my Ubuntu. Then I found out it depended if PHPStan was <strong>running or not</strong>.</p>
<h2 id="Charger-is-Your-Friend">Charger is Your Friend</h2>
<p>This is not a life-ending situation, but it's something you should be aware of. If you're a cable type and stay in one place always plugged in, you don't mind.</p>
<img src="/assets/images/posts/2021/parallel_charger.jpg" class="img-thumbnail mt-4 mb-3" style="max-width: 25em">
<p>But <strong>if you love to travel, work, or write posts on the train</strong> like me, keep it in mind.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/hidden-productivity-costs-of-parallel-run</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 27 Sep 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/hidden-productivity-costs-of-parallel-run#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Parallel in PHP for Dummies? Cooking a Family Dinner ]]></title>
                <link>https://tomasvotruba.com/blog/parallel-in-php-for-dummies-cooking-a-family-dinner</link>
                <description><![CDATA[ <p>Would you like to <strong>understand parallel in PHP apps</strong>?
<br>
Do you have just <strong>60 seconds</strong>?</p> ]]></description>
                <content:encoded><![CDATA[ <p>Imagine you're cooking dinner for your family, and you <strong>miss 4 ingredients</strong> to make the meal tasty.</p>
<p>Onion, garlic, pepper, and chilli:</p>
<img src="/assets/images/posts/2021/dinner_cooking.jpg" class="img-thumbnail mt-2 mb-4" style="max-width: 20em">
<p>Thank God you have exactly 2 kids that want to help you to cook your favorite meal!</p>
<img src="/assets/images/posts/2021/kids.jpg" class="img-thumbnail mt-2 mb-4" style="max-width: 20em">
<p>You could send them both to get 4 ingredients, but it would be faster if each of them could get just 2 ingredients.</p>
<p>You're rushing them to get it, and after they leave, you realize they forgot their phones. <strong>They can't talk to you, and they can't talk to each other</strong>. We don't know when they'll be back, if they have enough money or if they found what you need.</p>
<p><strong>We have to wait till everyone gets back to see the result</strong>.</p>
<p><br></p>
<h2 id="How-does-this-Story-Look-in-PHP-code">How does this Story Look in PHP code?</h2>
<pre><code class="language-php">// 1. what we have and what we want?
$neededIngredients = ['onion', 'garlic', 'pepper', 'chilli'];
$familyMembers = ['son', 'daughter'];

// 2. tell the instructions
$familyMembersCount = count($familyMembers);
$ingredientsChunks = array_chunk($neededIngredients, $familyMembersCount)

// 3. let them free and wait for the result
$foundIngredients = [...];
foreach ($familyMembers as $key =&gt; $familyMember) {
    $ingredientsChunk = $ingredientsChunks[$key];
    $foundIngredients[] = $familyMember-&gt;findIngredients($ingredientsChunk);
}

return $foundIngredients;</code></pre>
<p><br></p>
<p>And that's precisely how parallel works ECS!</p>
<h2 id="From-Food-to-Technical-Terminology">From Food to Technical Terminology</h2>
<ul>
<li>1 family member = 1 CPU thread</li>
<li>1 needed ingredient = 1 input file</li>
<li>ingredients chunk (2 items) = array of input files for 1 CPU thread</li>
</ul>
<p>That's it! Now you understand parallel processes.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/parallel-in-php-for-dummies-cooking-a-family-dinner</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 20 Sep 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/parallel-in-php-for-dummies-cooking-a-family-dinner#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ STAMP #5: How do we Know Types of Template Variables ]]></title>
                <link>https://tomasvotruba.com/blog/stamp-5-how-do-we-know-types-of-template-variables</link>
                <description><![CDATA[ <p>In the previous post, we finished the conversion of <a href="/blog/stamp-4-how-to-run-phpstan-rules-on-temporary-php-file">TWIG to PHP, run PHPStan on temporary PHP file and got list of found errors</a>. We've done a full circle, and PHPStan analyses our TWIG templates.
<br><br>
I've shared the intro post <a href="https://www.reddit.com/r/PHP/comments/qbwudj/stamp_0_static_analysis_of_templates">on Reddit</a>, that sparked many exciting questions.<br>
Today we'll answer one of them.</p> ]]></description>
                <content:encoded><![CDATA[ <div class="pl-4">
    <iframe id="reddit-embed" src="https://www.redditmedia.com/r/PHP/comments/qbwudj/stamp_0_static_analysis_of_templates/hhcrdlr/?depth=1&amp;showmore=false&amp;embed=true&amp;showmedia=false" sandbox="allow-scripts allow-same-origin allow-popups" style="border: none;" height="309" width="860" scrolling="no"></iframe>
</div>
<p>This is a great question! We skipped this piece to complete the TWIG rendering itself first and keep your cognitive load focused. Now we have time and space to bring the answer.</p>
<hr />
<h2 id="Context-First">Context First</h2>
<p>First, let's define what PHP and TWIG files we work with. We render a template with 1 parameter:</p>
<pre><code class="language-php">use App\Meal;

return $this-&gt;render('meal.twig', [
    'meal' =&gt; new Meal()
]);</code></pre>
<p><br></p>
<p>The TWIG template contains one method call:</p>
<pre><code class="language-html">{{ meal.title }}</code></pre>
<p><br></p>
<p>Using TWIG and php-parser <a href="/blog/stamp-1-how-to-compile-twig-to-php">we compile TWIG</a> into <a href="/blog/stamp-2-how-to-turn-messy-twig-php-to-something-useful">nice and clean PHP</a>:</p>
<pre><code class="language-php">echo $meal-&gt;getTitle();</code></pre>
<p><br></p>
<p>Is this clear? Now we can level up.</p>
<h2 id="Where-does-the-Variable-meal-come-From">Where does the Variable <code>$meal</code> come From?</h2>
<p>Looking at the code, the <code>$meal</code> looks like coming out of nowhere. Where is it defined? In TWIG, these variables are created from a <code>$context</code> array, passed as a parameter of the main <code>doDisplay()</code> method in the compiled template class.</p>
<p>This <code>$context</code> is an array made mostly of 2nd argument in <code>$this-&gt;render()</code> method.</p>
<p><br></p>
<p>In our compiled PHP, we get the <code>$meal</code> variable from the <code>$context</code> array:</p>
<pre><code class="language-php">public function doDisplay(array $context)
{
    $meal = $context['meal'];
    echo $meal-&gt;getTitle();
}</code></pre>
<p>And that's how TWIG variables are born in compiled PHP.</p>
<h2 id="What-is-the-Type-of-meal-Variable">What is the Type of <code>$meal</code> Variable?</h2>
<p>Now PHPStan and we know <strong>the variable <code>$meal</code> exists</strong> and comes from some <code>$context</code> array. But the type is still <code>mixed</code>. How do we know <code>$meal</code> is <code>App\Meal</code>?</p>
<p><br></p>
<p>Let's back up a little bit and look into first place the type appeared - in our controller:</p>
<pre><code class="language-php">use App\Meal;

return $this-&gt;render('meal.twig', [
    'meal' =&gt; new Meal()
]);</code></pre>
<p>Here we see that the <code>meal</code> string is the type of <code>App\Meal</code>. Could we add this type somehow to <code>meal.twig</code>?</p>
<p><br></p>
<p>Not so fast! The templates are reusable so that another developer can render them in the following way:</p>
<pre><code class="language-php">use App\Meal;

return $this-&gt;render('meal.twig', [
    'meal' =&gt; 'Dinner'
]);</code></pre>
<p>Here the <code>$meal</code> variable is a type of <code>string</code> and the template <code>{{ meal.title }}</code> will crash.</p>
<p><br></p>
<p>So to answer the question - the <strong>type depends on the place it's rendered in PHP</strong>. The same way <a href="https://phpstan.org/blog/how-phpstan-analyses-traits">PHPStan does not analyze traits standalone, but only in the context of specific class</a>.</p>
<h2 id="Template-Context-and-Variables-Types">Template Context and Variables Types</h2>
<p>We see that rendering the same template in different places can result in different types. Also, we should not forget, the <strong>PHPStan sees only the final compiled PHP file</strong> - it has no idea about the controller the template is rendered in.</p>
<p><br></p>
<p>Now that we know the rules of the game, the plan is pretty straightforward:</p>
<ol>
<li>collect known variable types in the exact place in PHP</li>
<li>compile the TWIG to PHP</li>
<li>decorate the compiled PHP with variable types</li>
</ol>
<p>Let's take step by step in our practical example.</p>
<h3 id="1-Collect-Variable-Types">1. Collect Variable Types</h3>
<p>We collect types at the exact moment we see the <code>$twig-&gt;render()</code> method in PHP code.</p>
<pre><code class="language-php">use App\Meal;

return $this-&gt;render('meal.twig', [
    'meal' =&gt; new Meal()
]);</code></pre>
<p>The 2nd argument is an array, and we can traverse that array and detect the type with PHPStan's <code>$scope</code>.</p>
<p><br></p>
<p>At the end of this step, we'll have an array with a variable name and its type:</p>
<ul>
<li><code>meal</code> =&gt; <code>PHPStan\Type\ObjectType</code> of <code>App\Meal</code></li>
</ul>
<h3 id="2-Compile-the-TWIG-to-PHP">2. Compile the TWIG to PHP</h3>
<p>We've already covered this process in previous parts:</p>
<ul>
<li><a href="/blog/stamp-1-how-to-compile-twig-to-php">STAMP #1: How to Compile Twig to PHP</a></li>
<li><a href="/blog/stamp-2-how-to-turn-messy-twig-php-to-something-useful">STAMP #2: How to Turn Messy TWIG PHP to Something Useful</a></li>
<li><a href="/blog/stamp-3-how-to-turn-twig-helper-functions-to-origin-object">STAMP #3: How to Turn TWIG Helper Functions to Origin Object</a></li>
</ul>
<h3 id="3-Decorate-the-Compiled-PHP">3. Decorate the Compiled PHP</h3>
<p>The TWIG is now compiled to PHP, and we know the types of variables. But the PHPStan has still no idea about types:</p>
<pre><code class="language-php">public function doDisplay(array $context)
{
    $meal = $context['meal'];
    echo $meal-&gt;getTitle();
}</code></pre>
<p><br></p>
<p>How do we help PHPStan in standard PHP code if we know about some types that are not clear from the code?</p>
<p>Like this:</p>
<pre><code class="language-diff"> public function doDisplay(array $context)
 {
+    /** @var \App\Meal $meal */
     $meal = $context['meal'];
     echo $meal-&gt;getTitle();
 }</code></pre>
<p>We'll automate this process again with <code>php-parser</code>. Now the <strong>PHPStan can analyze the code with all the known types</strong>.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/stamp-5-how-do-we-know-types-of-template-variables</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 13 Sep 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/stamp-5-how-do-we-know-types-of-template-variables#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ STAMP #4: How to Run PHPStan Rules on Temporary PHP File ]]></title>
                <link>https://tomasvotruba.com/blog/stamp-4-how-to-run-phpstan-rules-on-temporary-php-file</link>
                <description><![CDATA[ <p>In the previous post, we finished the conversion of <a href="/blog/stamp-3-how-to-turn-twig-helper-functions-to-origin-object">TWIG template to clean and objective PHP</a> that PHPStan can analyze.
<br><br>
Today, we'll discover the last missing pieces of the puzzle. How to run PHPStan rules in temporarily compiled PHP code.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Note: <strong>all credit for technique in this post goes to <a href="https://twitter.com/lulco">Michal Lulco</a></strong>. He's an impressive developer from Slovakia who comes with innovative, simple ideas that work. It's a scarce combination to see in the world, and I'm very grateful for him.</p>
<p>I'm only putting the idea into words to share. &quot;What trick,&quot; you ask?</p>
<h2 id="From-TWIG-to-PHP">From TWIG to PHP</h2>
<p>In previous parts, we've managed to compile TWIG to cached PHP code and then clean this PHP code into readable PHP objective code:</p>
<pre><code class="language-php">{{ meal.title }}</code></pre>
<p>↓</p>
<pre><code class="language-php">echo $meal-&gt;getTitle();</code></pre>
<p>We have just-in-time input we generated on the fly for PHPStan.</p>
<h2 id="How-to-run-all-PHPStan-Rules-on-Temporary-File">How to run all PHPStan Rules on Temporary File?</h2>
<p>The first option is to run the PHPStan manually on the freshly generated PHP file:</p>
<pre><code class="language-bash">vendor/bin/phpstan analyze /temp/twig/__TwigTemplate_8a9d1381e8329967...php</code></pre>
<p>But that's adding more work to our simple PHPStan workflow:</p>
<pre><code class="language-bash">vendor/bin/phpstan</code></pre>
<p>We're lazy developers, and we don't want to run any command more than once. Also, the CI is lazy and can run just once on the whole codebase.</p>
<h2 id="Meta-Rule">Meta-Rule</h2>
<p>To achieve that, we create a meta-rule. We register this rule in <code>phpstan.neon</code> and run along with other rules:</p>
<pre><code class="language-php">use PHPStan\Rules\Rule;

final class TwigCompleteCheckRule implements Rule
{
    public function getNodeType(): string
    {
        return MethodCall::class;
    }

    /**
     * @param MethodCall $node
     */
    public function processNode(Node $node, Scope $scope): array
    {
        // ...
    }
}</code></pre>
<p><br></p>
<p>This rule looks for method calls that render TWIG templates:</p>
<pre><code class="language-php">$twig-&gt;render('some_path.twig');

// in controller
$this-&gt;render('templates/some_path.twig', [
    'meal' =&gt; $meal
])</code></pre>
<p>The TWIG templates are converted to temporary PHP content and analyzed... how?</p>
<h2 id="The-processNode-Method">The <code>processNode()</code> Method</h2>
<p>In the meta-rule, we find the TWIG template paths, convert them to a temporary PHP file and feed PHPStan to analyze it.</p>
<p>Let the code speak for itself:</p>
<pre><code class="language-php">use PhpParser\Node\Expr\MethodCall;

final class TwigCompleteCheckRule implements Rule
{
    public function getNodeType(): string
    {
        return MethodCall::class;
    }

    /**
     * @param MethodCall $node
     */
    public function processNode(Node $node, Scope $scope): array
    {
        // 1. here we detect if it's Twig render method call
        if (! $this-&gt;isTwigRenderMethodCall($node)) {
            // skip if not
            return []
        }

        // 2. compile TWIG to PHP
        $temporaryPHPFileContent = $this-&gt;twigToPHPCompiler-&gt;compile($node);

        // 3. PHPStan needs physical file, so we dump string to temporary file
        file_put_contents('temporary_file.php', $temporaryPHPFileContent);

        // 4. pseudo-code! feed PHPStan the temporary file
        $foundErrors = $this-&gt;phpstanAnalyzer-&gt;analyzeFile($temporaryPHPFileContent);

        // 5. return errors found in this file
        return $foundErrors;
    }
}</code></pre>
<p>Pretty straightforward. All the steps are already working, except number 4.</p>
<h2 id="How-can-we-Feed-PHPStan-the-Temporary-File">How can we Feed PHPStan the Temporary File?</h2>
<p>The dependency injection mantra says, &quot;if you want something, ask for it in the constructor&quot;. The PHPStan service that analyzes files is called... <code>PHPStan\Analyser\FileAnalyser</code>.</p>
<p>The <code>FileAnalyser</code> has single public method <a href="https://github.com/phpstan/phpstan-src/blob/2c1107588603afaa8cd3e97165b7eb1736cb4393/src/Analyser/FileAnalyser.php#L59"><code>analyzeFile()</code></a>, with 4 required parameters.</p>
<h2 id="Ask-for-It-Create-New-Container-With-Fresh-Instance"><del>Ask for It</del> Create New Container With Fresh Instance!</h2>
<p>Now, we could ask for <code>PHPStan\Analyser\FileAnalyser</code> in the constructor as any other service. But that will lead to side-effects and bugs. Instead, Ondrej Mirtes advised me to use own instance with help of <code>DerivativeContainerFactory</code>:</p>
<pre><code class="language-php">use PHPStan\DependencyInjection\DerivativeContainerFactory;

public function __construct(
    private DerivativeContainerFactory $derivativeContainerFactory
) {
}

public function analyse()
{
    // @todo add cache to create just once
    $container = $this-&gt;derivativeContainerFactory-&gt;create([__DIR__ . '/../config/php-parser.neon']);
    $fileAnalyser = $container-&gt;getByType(FileAnalyser::class);
}</code></pre>
<p>PHPStan 1.0 uses <a href="https://github.com/rectorphp/rector/issues/6744#issuecomment-950282826">various of php-parser versions</a>, depending on use case - some are optimized for cache, some for performance and some for deep analysis. Saying that, we need to ask for the right one in our custom config:</p>
<pre><code class="language-yaml">// config/php-parser.neon
services:
    defaultAnalysisParser:
        factory: @cachedCurrentPhpVersionRichParser
        arguments!: []

    cachedCurrentPhpVersionRichParser:
        class: PHPStan\Parser\CachedParser
        arguments:
            originalParser: @currentPhpVersionRichParser
            cachedNodesByStringCountMax: 1024
        autowired: no</code></pre>
<p>Now we created custom container with fresh <code>PHPStan\Analyser\FileAnalyser</code> that will work exactly for our use case!</p>
<h2 id="Make-use-of-FileAnalyser">Make use of FileAnalyser</h2>
<p>Let's combine the parts together:</p>
<pre><code class="language-diff"> use PhpParser\Node\Expr\MethodCall;
+use PHPStan\DependencyInjection\DerivativeContainerFactory;
+use PHPStan\Analyser\FileAnalyser;
+use PHPStan\Rules\Registry;

 final class TwigCompleteCheckRule implements Rule
 {
+    public function __construct(
+        private DerivativeContainerFactory $derivativeContainerFactory,
+        private Registry $registry,
+    ) {
+    }

     public function getNodeType(): string
     {
         return MethodCall::class;
     }

     /**
      * @param MethodCall $node
      */
     public function processNode(Node $node, Scope $scope): array
     {
         // 1. here we detect if it's Twig render method call
         if (! $this-&gt;isTwigRenderMethodCall($node)) {
             // skip if not
             return []
         }

         // 2. compile TWIG to PHP
         $temporaryPHPFileContent = $this-&gt;twigToPHPCompiler-&gt;compile($node);

         // 3. PHPStan needs physical file, so we dump string to temporary file
         file_put_contents('temporary_file.php', $temporaryPHPFileContent);

         // 4. feed PHPStan the temporary file
-        $foundErrors = $this-&gt;phpstanAnalyzer-&gt;analyzeFile($temporaryPHPFileContent);
+        $container = $this-&gt;derivativeContainerFactory-&gt;create([
+            __DIR__ . '/../config/php-parser.neon'
+        ]);
+
+        $fileAnalyser = $container-&gt;getByType(FileAnalyser::class);
+        $fileAnalyserResult = $fileAnalyser-&gt;analyseFile(
+            $temporaryPHPFileContent, [], $this-&gt;registry, null
+        );

         // 5. return errors found in this file
-        return $foundErrors;
+        return $fileAnalyserResult-&gt;getErrors();
     }
 }</code></pre>
<p><br></p>
<p>One service, one method. Nice and clean design in practice.
All is looking good. Let's run PHPStan:</p>
<pre><code class="language-bash">vendor/bin/phpstan</code></pre>
<p>↓</p>
<p>PHPStan crashes with following error:</p>
<pre><code class="language-bash">InvalidStateException: Circular reference detected for services: 0282, registry.</code></pre>
<p><br></p>
<p>That's a pickle!</p>
<h2 id="Circular-Rule-References">Circular Rule References</h2>
<p>The &quot;registry&quot; service is used in some dependency injection that is injected in a circle. We're trying to run <code>TwigCompleteCheckRule</code>, which asks for <code>PHPStan\Rules\Registry</code>. How does the <a href="https://github.com/phpstan/phpstan-src/blob/2c1107588603afaa8cd3e97165b7eb1736cb4393/src/Rules/Registry.php#L17"><code>PHPStan\Rules\Registry</code> constructor</a> look like?</p>
<pre><code class="language-php">/**
* @param \PHPStan\Rules\Rule[] $rules
*/
public function __construct(array $rules)
{
    // ...
}</code></pre>
<p><br></p>
<p>Aha! So then we have the full circle:</p>
<ul>
<li><code>PHPStan\Rules\Registry</code> asks for all rules in the constructor</li>
<li>one of all rules is <code>TwigCompleteCheckRule</code></li>
<li>the <code>TwigCompleteCheckRule</code> asks for <code>PHPStan\Rules\Registry</code> in the constructor</li>
<li><code>PHPStan\Rules\Registry</code> asks for all rules in the constructor</li>
<li>...</li>
</ul>
<h2 id="Stepping-out-of-the-Circle">Stepping out of the Circle</h2>
<p>Seeing this, we cannot use <code>PHPStan\Rules\Registry</code> in our <code>TwigCompleteCheckRule</code> rule. What else can we do? We need to get the list of all rules, except this one. <strong>Get ready for the trick!</strong> I tried to get here but failed. I was amazed when I saw how Lulco solved this elegantly.</p>
<p>In our single rule, we need all the other rules. <code>PHPStan\Rules\Registry</code> is just injected service; it's a wrapper object. We can unwrap this object!</p>
<pre><code class="language-diff"> use PHPStan\Rules\Registry;
+use PHPStan\Rules\Rule;

 final class TwigCompleteCheckRule implements Rule
 {
+    private Registry $registry;

     /**
      * @param Rules[]
      */
     public function __construct(
-        private Registry $registry,
+        array $rules,
+    ) {
+        $this-&gt;registry = new Registry($rules);
+    }

     // ...
 }</code></pre>
<p><br></p>
<p>That's it? Let's try to run the PHPStan rule and see if it works:</p>
<img src="/assets/images/posts/2021/twig_final_example.gif" class="img-thumbnail">
<h2 id="">🥳️🥳️🥳️</h2>
<p><br></p>
<p>Once more time, <a href="https://twitter.com/lulco">huge thanks to Lulco</a>, who made all this possible!<br>
Also, thank you <a href="https://twitter.com/ondrejmirtes">Ondra Mirtes</a> for PHPStan 1.0 tips with custom <code>PHPStan\Analyser\FileAnalyser</code>.</p>
<p><br></p>
<p>That's all for TWIG templates, and that's all for theory. In the next post, we'll look at more practical. You'll learn how to run such a rule <strong>in your codebase</strong>.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/stamp-4-how-to-run-phpstan-rules-on-temporary-php-file</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 06 Sep 2021 00:00:00 +0000</pubDate>
                                    <updated>2021-11-01UTC00:00:000</updated>
                    <atom:updated>Mon, 01 Nov 2021 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Mon, 01 Nov 2021 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/stamp-4-how-to-run-phpstan-rules-on-temporary-php-file#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ STAMP #3: How to Turn TWIG Helper Functions to Origin Object ]]></title>
                <link>https://tomasvotruba.com/blog/stamp-3-how-to-turn-twig-helper-functions-to-origin-object</link>
                <description><![CDATA[ <p>In the previous post, we looked at <a href="/blog/stamp-2-how-to-turn-messy-twig-php-to-something-useful"><em>how</em> to turn Messy TWIG PHP to something useful</a> in general.
<br>
<br>
Today we'll look at how to <strong>change TWIG helper functions to their original object form</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Have you joined our &quot;STAMP&quot; series just in this post? We're trying to convert the TWIG file. In the TWIG template, we use the single variable <code>meal</code>, an <code>App\Meal</code> type object.</p>
<pre><code class="language-twig">{{ meal.title }}</code></pre>
<p>What do we want as an output? A PHP code that PHPStan can understand and analyze. All steps must happen automatically, without any manual effort, on a typical PHPStan run:</p>
<pre><code class="language-bash">vendor/bin/phpstan</code></pre>
<p>In the previous post, we managed to narrow the TWIG mess to a single proper method, <code>doDisplay()</code>:</p>
<pre><code class="language-php">use Twig\Template;

/* templates/meal.twig */
class __TwigTemplate_8a9d1381e8329967... extends Template
{
    protected function doDisplay(array $context, array $blocks = [])
    {
        // line 1
        echo twig_escape_filter(
            $this-&gt;env,
            twig_get_attribute(
                $this-&gt;env,
                ($context["meal"] ?? null),
                "title",
                "any",
                false,
                false,
                false,
                1
            ),
            "html",
            null,
            true
        );
    }
}</code></pre>
<p>Would it be enough to run PHPStan on an analyze <code>App\Meal</code> object? There is no single mention about <code>App\Meal</code> type, not even an object - we can see: functions, <code>$this-&gt;env</code> property, and some <code>$context</code> array.</p>
<h2 id="Keep-it-Simple">Keep it Simple</h2>
<p>This looks like a desperate situation in a new job when they tell you, &quot;we have strict clean code standards&quot;.</p>
<p>Time to quit? Not so fast.</p>
<p><br></p>
<p>Let's get back to basics, our TWIG template:</p>
<pre><code class="language-twig">{{ meal.title }}</code></pre>
<p>Now forget everything we know about TWIG PHP and complex <code>php-parser</code>.</p>
<h2 id="Back-to-the-Facts">Back to the Facts</h2>
<p>What are the known axioms we can work with?</p>
<ul>
<li>the <code>meal</code> is an object of <code>App\Meal</code> type</li>
<li>the <code>.title</code> is TWIG magic syntax
<ul>
<li>for something like <code>getTitle()</code> method call</li>
<li>or <code>-&gt;title</code> property fetch in case of public property</li>
</ul></li>
<li>in <a href="/blog/stamp-static-analysis-of-templates">the first post</a> we mentioned how <code>App\Meal</code> class looks like</li>
</ul>
<pre><code class="language-php">namespace App;

final class Meal
{
    public function getTitle(): string
    {
        return 'Potato Salad and Schnitzel';
    }
}</code></pre>
<p><br></p>
<p>Knowing only this, how <strong>could we write this code in pure PHP</strong>?</p>
<pre><code class="language-php">$meal-&gt;title</code></pre>
<p>Probably not, there is no public property <code>$title</code>, so it would fail on undefined pubic property.</p>
<p><br></p>
<pre><code class="language-php">$meal-&gt;getTitle()</code></pre>
<p>Better, but what does this method do? <code>void</code>. It does not show anything. How can we improve it?</p>
<p><br></p>
<pre><code class="language-php">echo $meal-&gt;getTitle()</code></pre>
<p>Wow, almost like the original!
But seeing only this line of code, the <code>$meal</code> could be just an empty string for PHPStan. What about that?</p>
<p><br></p>
<pre><code class="language-php">/** @var \App\Meal $meal */
echo $meal-&gt;getTitle()</code></pre>
<p>Great! It would be better to define the type in parameter type of some function, but we don't see any function there. The important one is that <strong>PHPStan now sees an object of a specific type and method call of a specific name on it</strong>.</p>
<h2 id="Stripping-down-twig-get-attribute">Stripping down <code>twig_get_attribute()</code></h2>
<p>It's important to know what one wants. Now we can modify the original <code>echo</code> statement in <code>doDisplay()</code> method. First, we can drop the <code>twig_escape_filter()</code> function call, which is TWIG internal, unrelated to our template code.</p>
<pre><code class="language-diff">// line 1
-echo twig_escape_filter(
-    $this-&gt;env,
-    twig_get_attribute(
+echo twig_get_attribute(
         $this-&gt;env,
         ($context["meal"] ?? null),
         "title",
         "any",
          false,
          false,
          false,
          1
-    ),
+    );
-    "html",
-    null,
-    true
-);</code></pre>
<p><br></p>
<p>We now have just the <code>twig_get_attribute()</code> function call:</p>
<pre><code class="language-php">// line 1
echo twig_get_attribute(
    $this-&gt;env,
    ($context["meal"] ?? null),
    "title",
    "any",
    false,
    false,
    false,
    1
);</code></pre>
<p><br></p>
<h2 id="Drop-the-Boolean-and-Repeated-Values">Drop the Boolean and Repeated Values</h2>
<p>Let's take it further. What does <code>twig_get_attribute()</code> probably do?</p>
<ul>
<li>It checks if the variable <code>meal</code> is defined.</li>
<li>Then tries to call <code>getTitle()</code> or fetch <code>title</code> property on it.</li>
</ul>
<p>Now, we could drop always-present arguments unrelated to our original TWIG template:</p>
<pre><code class="language-diff"> // line 1
 echo twig_get_attribute(
-    $this-&gt;env,
     ($context["meal"] ?? null),
     "title",
-    "any",
-    false,
-    false,
-    false,
-    1
 );</code></pre>
<h2 id="Still-Keep-it-Simple">Still, Keep it Simple</h2>
<p>What do we already know about our new code snippet?</p>
<pre><code class="language-php">// line 1
echo twig_get_attribute(
    ($context["meal"] ?? null),
    "title",
);</code></pre>
<ul>
<li>the <code>$meal</code> variable always exists</li>
<li>the <code>$meal</code> is an object of <code>App\Meal</code> type</li>
<li>the <code>getTitle()</code> is the existing public method</li>
</ul>
<p><br></p>
<p>Let's apply this knowledge:</p>
<pre><code class="language-diff"> // line 1
 echo twig_get_attribute(
-    ($context["meal"] ?? null),
+    /** @var \App\Meal $meal */
+    $meal,
-    "title",
+    "getTitle",
 );</code></pre>
<p><br></p>
<p>↓</p>
<p><br></p>
<p>What do we know about this code snippet?</p>
<pre><code class="language-php">// line 1
echo twig_get_attribute(
    /** @var \App\Meal $meal */
    $meal,
    "getTitle",
);</code></pre>
<ul>
<li>the <code>twig_get_attribute</code> is not needed, as its internal TWIG function</li>
<li>the <code>"getTitle"</code> will be called directly on <code>$meal</code></li>
</ul>
<p><br></p>
<pre><code class="language-diff"> // line 1
-echo twig_get_attribute(
-    /** @var \App\Meal $meal */
-    $meal,
-    "getTitle",
- );
+/** @var \App\Meal $meal */
+echo $meal-&gt;getTitle();</code></pre>
<p><br></p>
<p>Great! It's a <strong>method call we've been waiting for:</strong></p>
<pre><code class="language-php">/** @var \App\Meal $meal */
echo $meal-&gt;getTitle();</code></pre>
<p>Now PHPStan can check the file and tell us if the <code>getTitle</code> method exists on <code>App\Meal</code> or not.</p>
<p>PHPStan now knows that <code>$meal-&gt;getTitle()</code> returns a <code>string</code>, and can report type errors:</p>
<pre><code class="language-twig">10 * {{ meal.title }}</code></pre>
<h2 id="PHP-Line-vs-TWIG-Line">PHP Line vs. TWIG Line</h2>
<p>You've probably noticed we kept <code>// line 1</code> comment in every snippet. What is it for?</p>
<p><strong>Every proper PHPStan error</strong> has:</p>
<ul>
<li>an error message,</li>
<li>file of origin,</li>
<li>and exact line.</li>
</ul>
<p><br></p>
<p>Here we analyze a PHP file that is much bigger than the original TWIG file. Our 1 line in TWIG template was compiled to <strong>~80 lines of PHP.</strong></p>
<p>So why is the <code>// line 1</code> important? The metadata from the native TWIG compiler tells us that <strong>code under this comment belongs to line <code>X</code> in the TWIG template</strong>.</p>
<h2 id="Smart-PHP-and-gt-TWIG-Line-Mapping">Smart PHP =&gt; TWIG Line Mapping</h2>
<p>How can we use line mapping? Let's say we change the method name in our template:</p>
<pre><code class="language-diff">-{{ meal.title }}
+{{ meal.name }}</code></pre>
<p>PHPStan then reports non-existing <code>getName()</code> method error. Without mapping, it would report line that does not even exist:</p>
<pre><code class="language-bash">Error in /templates/meal.twig file on line 54:</code></pre>
<p>With mapping, we get <strong>correct TWIG line</strong>:</p>
<pre><code class="language-bash">Error in /templates/meal.twig file on line 1:</code></pre>
<p><br></p>
<h2 id="To-Sum-Up">To Sum Up</h2>
<p>All right, we have removed clutter from the compiled PHP template file and used <code>NodeVisitor</code> from <code>php-parser</code> to convert magical TWIG functions to explicit PHP code.</p>
<p>We're now ready use PHPStan for analysis:</p>
<pre><code class="language-bash">vendor/bin/phpstan analyze /temp/twig/__TwigTemplate_8a9d1381e8329967...php</code></pre>
<p><br></p>
<p>Or is there a better way to run all PHPStan rules on a single file? 🤔</p>
<p>You'll find the answer in the next post.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/stamp-3-how-to-turn-twig-helper-functions-to-origin-object</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 30 Aug 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/stamp-3-how-to-turn-twig-helper-functions-to-origin-object#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ STAMP #2: How to Turn Messy TWIG PHP to Something Useful ]]></title>
                <link>https://tomasvotruba.com/blog/stamp-2-how-to-turn-messy-twig-php-to-something-useful</link>
                <description><![CDATA[ <p>In the previous post, we looked <a href="/blog/stamp-1-how-to-compile-twig-to-php">at <em>how</em> to compile TWIG to raw PHP</a>. It's one step forward, but it's not enough.
<br><br>
Today we look at <em>how</em> we turn <strong>the raw PHP code to the code PHPStan understands</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>In the previous post, we successfully <del>rendered</del> compiled <code>templates/meal.twig</code> template:</p>
<pre><code class="language-twig">{{ meal.title }}</code></pre>
<p><br></p>
<h2 id="Rendered-or-Compiled">Rendered or Compiled?</h2>
<p>What is the difference between <em>rendered</em> and <em>compiled</em> in our context?</p>
<ul>
<li>When we <em>render</em> a TWIG template, the result will be the <strong>final HTML that users see</strong> when they open the website.</li>
<li>When we <em>compile</em> a TWIG template, we'll get a <strong>PHP code with class</strong>, that TWIG uses for the cache.</li>
</ul>
<p><br></p>
<p>After compilation <code>templates/meal.twig</code> to PHP, we'll get a child of <code>Twig\Template</code> class:</p>
<pre><code class="language-php">use Twig\Environment;
use Twig\Source;
use Twig\Template;

/* templates/meal.twig */
class __TwigTemplate_8a9d1381e8329967... extends Template
{
    private $source;
    private $macros = [];

    public function __construct(Environment $env)
    {
        parent::__construct($env);
        $this-&gt;source = $this-&gt;getSourceContext();
        $this-&gt;parent = false;
        $this-&gt;blocks = [];
    }

    protected function doDisplay(array $context, array $blocks = [])
    {
        $macros = $this-&gt;macros;
        // line 1
        echo twig_escape_filter(
            $this-&gt;env,
            twig_get_attribute(
                $this-&gt;env,
                $this-&gt;source,
                ($context["meal"] ?? null),
                "title",
                "any",
                false,
                false,
                false,
                1
            ),
            "html",
            null,
            true
        );
    }

    public function getTemplateName()
    {
        return "templates/meal.twig";
    }

    public function isTraitable()
    {
        return false;
    }

    public function getDebugInfo()
    {
        return array (37 =&gt; 1);
    }

    public function getSourceContext()
    {
        return new Source("", "templates/meal.twig", "");
    }
}</code></pre>
<p><br></p>
<p>What a mess, right? Don't worry; you don't have to understand a single line of it.</p>
<p>What is our plan for today? Somehow &quot;transform&quot; this code so <strong>PHPStan can analyze it</strong>.</p>
<blockquote class="blockquote mt-5 mb-5 text-center">
    "Perfection is achieved not when there is nothing more to add,<br>
    but when there is nothing left to take away"
    <footer class="blockquote-footer">Antoine de Saint-Exupery</footer>
</blockquote>
<h2 id="Keep-only-the-Necessary-Code">Keep only the Necessary Code</h2>
<p>The first step is to <strong>remove the clutter</strong> helpful only for TWIG internals. These methods do not provide any information about the original TWIG code. In other words: remove the PHP content that is always the same, regardless of the TWIG input file we use.</p>
<p><br></p>
<h2 id="and-quot-Why-we-don-t-Run-PHPStan-on-This-PHP-File-and-quot">&quot;Why we don't Run PHPStan on This PHP File?&quot;</h2>
<p>Great question! What would happen if we did? The PHPStan would analyze the content based on the TWIG template, but it would also <strong> analyze the TWIG generator for template classes</strong>. This way, we would get dozens of always the same errors repeated for every single TWIG file.</p>
<p>We don't want to run PHPStan on TWIG itself; that's a job for Symfony maintainers. We want to only know about possible bugs coming from our TWIG template code:</p>
<pre><code class="language-twig">{{ meal.title }}</code></pre>
<h2 id="Which-Methods-are-Useful">Which Methods are Useful?</h2>
<p>How do we define if the class method is proper? Let's use common sense to drop class methods that look like &quot;metadata&quot;. If we drop a method that proves helpful in the future, we'll return it.</p>
<p>Look for the keywords mentioned in TWIG template: &quot;meal&quot; and &quot;title&quot;. They are mentioned in <code>doDisplay()</code> class method, let's keep that.</p>
<pre><code class="language-diff">-use Twig\Environment;
-use Twig\Source;
 use Twig\Template;

 /* templates/meal.twig */
 class __TwigTemplate_8a9d1381e8329967... extends Template
 {
-    private $source;
-    private $macros = [];
-
-    public function __construct(Environment $env)
-    {
-        parent::__construct($env);
-        $this-&gt;source = $this-&gt;getSourceContext();
-        $this-&gt;parent = false;
-        $this-&gt;blocks = [];
-    }
-
    protected function doDisplay(array $context, array $blocks = [])
    {
-       $macros = $this-&gt;macros;
        // line 1
        echo twig_escape_filter(
            $this-&gt;env,
            twig_get_attribute(
                $this-&gt;env,
-               $this-&gt;source,
                ($context["meal"] ?? null),
                "title",
                "any",
                 false,
                 false,
                 false,
                 1
            ),
            "html",
            null,
            true
        );
    }
-
-    public function getTemplateName()
-    {
-        return "templates/meal.twig";
-    }
-
-    public function isTraitable()
-    {
-        return false;
-    }
-
-    public function getDebugInfo()
-    {
-        return array (37 =&gt; 1);
-    }
-
-    public function getSourceContext()
-    {
-        return new Source("", "templates/meal.twig", "");
-    }
 }</code></pre>
<p><br></p>
<p>In the end we keep only <code>__construct</code> and <code>doDisplay()</code> methods:</p>
<pre><code class="language-php">use Twig\Template;

/* templates/meal.twig */
class __TwigTemplate_8a9d1381e8329967... extends Template
{
    protected function doDisplay(array $context, array $blocks = [])
    {
        // line 1
        echo twig_escape_filter(
            $this-&gt;env,
            twig_get_attribute(
                $this-&gt;env,
                ($context["meal"] ?? null),
                "title",
                "any",
                 false,
                 false,
                 false,
                 1
            ),
            "html",
            null,
            true
        );
    }
}</code></pre>
<p><br></p>
<p>That looks better. 75 % less code!</p>
<p>But wait...</p>
<h2 id="How-do-we-Remove-these-Red-Lines">How do we Remove these Red Lines?</h2>
<p>We're editing a cache PHP code that TWIG compiles. Do we open this file in PHPStorm, edit it, save it and feed it PHPStan?</p>
<pre><code class="language-bash">vendor/bin/phpstan analyse temp/twig/__TwigTemplate_8a9d1381e8329967...php</code></pre>
<p>That might give us the PHPStan analysis we aim for, but would you like to edit cache files for every single TWIG file manually? I thought so.</p>
<p>So how do we automate PHP code modifications based on specific rules? Yes, we could use <a href="http://github.com/rectorphp/rector">Rector</a>, but that's a far too heavy tool to include just for a single PHPStan rule.</p>
<p>Instead, we use bare <code>nikic/php-parser</code> and custom <code>NodeVisitor</code>. We don't want to focus on AST modifications, but to give you an idea:</p>
<pre><code class="language-php">use PhpParser\Node\Stmt\ClassMethod;
use PhpParser\NodeVisitorAbstract;
use PhpParser\NodeTraverser;

final class TwigCleaningNodeVisitor extends NodeVisitorAbstract
{
    public function enterNode(Node $node)
    {
        // not a class method? skip it
        if (! $node instanceof ClassMethod) {
            return null;
        }

        // is one of these class method names? skip it
        if ($node-&gt;name-&gt;toString() === 'doDisplay') {
            return null;
        }

        // remove the class method
        return NodeTraverser::REMOVE_NODE;
    }
}</code></pre>
<p>This node visitor will remove all but <code>doDisplay()</code> method.</p>
<p><em>Would you like to know more about this? Read <a href="https://leanpub.com/rector-the-power-of-automated-refactoring">Programmatically Modifying PHP Code chapter</a> of the Rector book. Matthias describes behavior in nice short examples</em>.</p>
<p><br></p>
<p>That's all for today, to keep the reading light. In the next post, we'll try to give <code>doDisplay()</code> a more transparent form.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/stamp-2-how-to-turn-messy-twig-php-to-something-useful</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 23 Aug 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/stamp-2-how-to-turn-messy-twig-php-to-something-useful#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ STAMP #1: How to Compile Twig to PHP ]]></title>
                <link>https://tomasvotruba.com/blog/stamp-1-how-to-compile-twig-to-php</link>
                <description><![CDATA[ <p>In the previous post, we looked <a href="/blog/stamp-static-analysis-of-templates">at <em>why</em> and <em>when</em> static analysis of templates matter</a>. Today we look at how to prepare starting point for Twig templates.
<br><br>
How can we analyze templates with PHPStan that understand only PHP? There are 2 ways: we could teach PHPStan the language of Twig - a new &quot;TWIGStan&quot; tool.
<br><br>
The other option is to take it from the other end - convert Twig to PHP.</p> ]]></description>
                <content:encoded><![CDATA[ <p>In the previous post we worked with <code>templates/meal.twig</code> with single method call:</p>
<pre><code class="language-twig">{{ meal.title }}</code></pre>
<p>Today we'll try to turn this single line into PHP syntax.</p>
<h2 id="How-do-we-Render-Twig-in-our-Projects">How do we Render Twig in our Projects?</h2>
<p>The most common use case for rendering templates is in a Symfony controller. We call <code>$this-&gt;render()</code> with a template name as 1st argument:</p>
<pre><code class="language-php">use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\Response;

final class DinnerController extends AbstractController
{
    public function __invoke(): Response
    {
        return $this-&gt;render('templates/meal.twig');
    }
}</code></pre>
<p>This creates rendered HTML. But we don't have a tool called &quot;HTMLStan&quot;, but PHPStan. How do we get a PHP syntax of the <code>templates/meal.twig</code> template?</p>
<h2 id="From-Controller-to-Twig-Environment">From Controller to Twig Environment</h2>
<p>Let's take it to step by step. We don't need the whole <code>symfony/framework-bundle</code> to render Twig. What does the <code>render()</code> method of <code>AbstractController</code> do? It can be decomposed into these calls:</p>
<pre><code class="language-php">use Symfony\Component\HttpFoundation\Response;

// ...
abstract class AbstractController
{
    protected function render(string $view): Response
    {
        /** @var string $content */
        $content = $this-&gt;environment-&gt;render($view);

        $response = new Response();
        $response-&gt;setContent($content);

        return $response;
    }
}</code></pre>
<p>As you've expected, it is a simple request and response with some <code>string</code>. The <code>$content</code> string is what we're interested in.</p>
<p>But <strong>what is this &quot;environment&quot; we're calling?</strong> First association to &quot;environment&quot; might be &quot;env&quot; or development, production, and tests. But such a name suggests a value object or a variable, not a service. I will save you from confusion - it's a Twig renderer service. A name like &quot;TwigRenderer&quot; or &quot;TwigApplication&quot; would save us this paragraph, but sometimes legacy is what we have to work with.</p>
<h2 id="From-Response-to-Twig-Render">From Response to Twig Render</h2>
<p>Let's strip of clutter from <code>render()</code> and keep only the relevant lines:</p>
<pre><code class="language-php">use Twig\Environment;

$environment = new Environment();

/** @var string $content */
$content = $environment-&gt;render('templates/meal.twig');</code></pre>
<p>We pass a TWIG <code>'templates/meal.twig'</code> and get rendered HTML <code>$content</code>. How can we use this as food for PHPStan?</p>
<h2 id="TWIG-HTML">TWIG → ? → HTML</h2>
<p>We're getting closer. Now we know how to render TWIG file path to HTML content with couple of PHP lines and the <code>twig/twig</code> package. That's great! But <strong>how is that useful for static analysis in PHP</strong>?</p>
<p>First, we need to understand TWIG rendering lifecycle. It would be costly to convert every TWIG template to PHP, then complete variables and <code>echo</code> it to HTML string.</p>
<p>How does TWIG make sure it's fast?</p>
<h2 id="3-Step-TWIG-Lifecycle">3-Step TWIG Lifecycle</h2>
<ol>
<li>find <code>templates/meal.twig</code> absolute path and load its contents</li>
<li><strong>check if this template was already parsed to PHP</strong>
<ul>
<li>NO? parse if to PHP and save it the PHP to filesystem cache</li>
<li>YES? load the parsed PHP from the filesystem cache</li>
</ul></li>
<li>complete dynamic parameters to PHP template and echo it</li>
</ol>
<p>Now it's clear what we need to do. We have to do step 1., then step 2. parse TWIG to PHP and save the file to filesystem. PHPStan can analyze files in the filesystem, so we have a clear goal!</p>
<h2 id="Stop-Rendering-TWIG-at-PHP-Step">Stop Rendering TWIG at PHP Step?</h2>
<p>In the last snippet, we can see only the <code>render()</code> method that outputs HTML string:</p>
<pre><code class="language-php">use Twig\Environment;

$environment = new Environment();

/** @var string $content */
$content = $environment-&gt;render('templates/meal.twig');</code></pre>
<p>That's not what we need; it's too late for us. But we have all we need here. We just deep dive into the <code>render()</code> method and find out the smaller steps.</p>
<p>Inside the <code>render()</code> method, we'll find many nested calls, but in the end, it's just 3 methods:</p>
<ul>
<li><code>parse()</code> → <strong><code>compile()</code></strong> <del>→ <code>render()</code></del></li>
<li>TWIG → PHP <del>→ HTML</del></li>
</ul>
<h2 id="Finally-Compile-TWIG-to-PHP">Finally: Compile TWIG to PHP</h2>
<p>If we extract this <code>compile()</code> method and remove clutter code, we'll get to 3 lines that do the job:</p>
<pre><code class="language-php">use Twig\Environment;

$environment = new Environment();

// 1. gets contents of TWIG file and parses to tokens like tokens_get_all()
$source = $environment-&gt;getLoader()-&gt;getSourceContext('templates/meal.twig');

// 2. compile TWIG tokens to the PHP as we know it
$phpContent = $environment-&gt;compileSource($source);</code></pre>
<p><br></p>
<p><strong>In <code>$phpContent</code> now we have PHP string that PHPStan can analyze, yay!</strong></p>
<h1 id="">🎉</h1>
<h2 id="What-is-in-phpContent">What is in <code>$phpContent</code>?</h2>
<p>Are you curious, how does the final compiled PHP code look like?</p>
<p>I will not lie to you. It's not nice. It's even worse. It's not readable. That's probably because in 2009 when the TWIG was released, nobody thought of creating beautiful cached PHP code for PHPStan.</p>
<p><br></p>
<p>Are you ready? Here is it:</p>
<pre><code class="language-php">use Twig\Environment;
use Twig\Source;
use Twig\Template;

/* templates/meal.twig */
class __TwigTemplate_8a9d1381e8329967... extends Template
{
    private $source;
    private $macros = [];

    public function __construct(Environment $env)
    {
        parent::__construct($env);

        $this-&gt;source = $this-&gt;getSourceContext();

        $this-&gt;parent = false;

        $this-&gt;blocks = [
        ];
    }

    protected function doDisplay(array $context, array $blocks = [])
    {
        $macros = $this-&gt;macros;
        // line 1
        echo twig_escape_filter(
            $this-&gt;env,
            twig_get_attribute(
                $this-&gt;env,
                $this-&gt;source,
                ($context["meal"] ?? null),
                "title",
                "any",
                 false,
                 false,
                 false,
                 1
            ),
            "html",
            null,
            true
        );
    }

    public function getTemplateName()
    {
        return "templates/meal.twig";
    }

    public function isTraitable()
    {
        return false;
    }

    public function getDebugInfo()
    {
        return array (37 =&gt; 1);
    }

    public function getSourceContext()
    {
        return new Source("", "templates/meal.twig", "");
    }
}</code></pre>
<h2 id="How-is-this-PHP-Mess-Helpful">How is this PHP Mess Helpful?</h2>
<p>Not much, to be honest. Yet.</p>
<p>We'll give it a look <a href="/blog/stamp-2-how-to-turn-messy-twig-php-to-something-useful">in the next post</a>. Maybe we can come up with something useful.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/stamp-1-how-to-compile-twig-to-php</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 16 Aug 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/stamp-1-how-to-compile-twig-to-php#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ STAMP #0: Static Analysis of Templates ]]></title>
                <link>https://tomasvotruba.com/blog/stamp-static-analysis-of-templates</link>
                <description><![CDATA[ <p>Today we have static analysis checking every line of our PHP code - with PHPStan, Psalm, and PHPStorm. With php-parser and abstract syntax tree, we can do <strong>instant changes across hundreds of files</strong> in a second, with a precision of human hair.
<br><br>
With all this power and utils having our back, we can see templates as the next low-hanging fruit that needs our attention.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Are you hungry? I hope so. Let's cook some dinner for our whole family.</p>
<p>What are we having? Let's say we have a template with the title of the meal for tonight:</p>
<pre><code class="language-html">&lt;!-- TWIG syntax --&gt;
{{ meal.title }}

&lt;!-- Latte syntax --&gt;
{$meal-&gt;getTitle()}</code></pre>
<p>The meal is an elementary object:</p>
<pre><code class="language-php">namespace App;

final class Meal
{
    public function getTitle(): string
    {
        return 'Potato Salad and Schnitzel';
    }

    // ...
}</code></pre>
<p>Then we run our website to show our whole family the meal for tonight:</p>
<pre><code class="language-html">Potato Salad and Schnitzel</code></pre>
<p>Pretty clear, right?</p>
<h2 id="Renamed-a-Method">Renamed a Method</h2>
<p>When you look at the <code>App\Meal</code> object, what does feel itchy about it? The name of <code>getTitle()</code> method. When we first created this <code>App\Meal</code> class, we probably thought more about <em>post</em> or <em>news</em>. There it makes more sense.</p>
<p>In this case, maybe the <em>name</em> would be a better choice. Do you agree? Let's rename it.</p>
<p>We rename it using PHPStorm and &quot;Rename Method&quot; action:</p>
<pre><code class="language-diff"> namespace App;

 final class Meal
 {
-    public function getTitle(): string
+    public function getName(): string
     {
         return 'Potato Salad and Schnitzel';
     }

     // ...
 }</code></pre>
<p>Now it feels better to read the code. We'll reload the webpage to show our changes to our family...</p>
<p><br></p>
<p>...and it crashes with <em>Error 500</em>.</p>
<h2 id="We-Forgot-Something-What-Was-it-Kevin">We Forgot Something, What Was it?... Kevin!</h2>
<p>We missed one crucial spot. PHPStorm is an excellent tool to handle PHP code. But it's PHPStorm, not <em>TemplateStorm</em>, so it missed rename in the template:</p>
<pre><code class="language-html">&lt;!-- TWIG syntax --&gt;
{{ meal.title }}

&lt;!-- Latte syntax --&gt;
{$meal-&gt;getTitle()}</code></pre>
<p>Once we see the error, we know what to do to make it go away:</p>
<pre><code class="language-diff"> &lt;!-- TWIG syntax --&gt;
-{{ meal.title }}
+{{ meal.name }}

 &lt;!-- Latte syntax --&gt;
-{$meal-&gt;getTitle()}
+{$meal-&gt;getName()}</code></pre>
<p>That's it! We refresh the website, and it works as before:</p>
<pre><code class="language-html">Potato Salad and Schnitzel</code></pre>
<p>👍</p>
<h2 id="Manual-Fix-Does-not-Scale">Manual Fix Does not Scale</h2>
<p>The focused and simple use case above might work in a demo article like this one, but in real projects, it's pretty rare to see a template with 1 line of code.</p>
<p>We do such renames in projects that make money. There might be some tests, but not every single template render path is tested. We can't afford to wait for &quot;user testing&quot; and error 500 in our logs.</p>
<p>Let's see what would happen in a PHP-only world. We can do method rename either manually, with PHPStorm, or Rector. What happens if we forget a single spot?</p>
<pre><code class="language-php">$meal = new Meal();
echo $meal-&gt;getTitle();</code></pre>
<p>The pull-request CI pipeline fails red with a message:</p>
<pre><code class="language-bash">Calling unknown method "getTitle" on "App\Meal" object</code></pre>
<p>Yes, PHPStan protects us. If such a bug got into the code, it would be idiotic.</p>
<p>Should we treat templates with lower expectations? No!
<strong>The same rules that apply for our PHP code must apply for templates as well.</strong></p>
<h2 id="Starting-Post-Series">Starting Post Series</h2>
<p>There are a couple of interesting topics in the area of static analysis in templates.  I consider them highly joyful and worth sharing with you. <strong>It's a brand new topic, so I would like to invite you to shape the future of it</strong>.</p>
<p>What do you think about it? Let me know in the comments below or on <a href="https://twitter.com/votrubat">Twitter</a>.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/stamp-static-analysis-of-templates</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 09 Aug 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/stamp-static-analysis-of-templates#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Easily Protect your Code Base from Commented PHP Code ]]></title>
                <link>https://tomasvotruba.com/blog/how-to-easily-protected-your-code-base-from-commented-php-code</link>
                <description><![CDATA[ <p>When it comes to merging huge pull-request, here and there, a bit of commented code slips to our codebase. Do you trust your reckless developers to check every single line? Are you sure?
<br><br>
We <strong>cherish our developers' attention</strong> so we come with a simple solution that we added to our CI. Now we know for sure. Do you think you have 0 % unwanted commented code? I dare you to have more.</p> ]]></description>
                <content:encoded><![CDATA[ <p>With following approach, <a href="https://github.com/rectorphp/rector-src/commit/37b06023b666cac8ec2997e8e1605f93c25d3b6f">we've discovered more than 150 commented out PHP lines</a> in Rector code today:</p>
<img src="/assets/images/posts/2021/quick-easy-commented-code-detection.png" class="img-thumbnail">
<p><br></p>
<h2 id="How-we-Detect-Commented-PHP-Code-Today">How we Detect Commented PHP Code Today?</h2>
<p>The &quot;best&quot; way to detect commented code was with a sniff from PHP_CodeSniffer. It parsed every token in a comment and tried to decide if it's a commented PHP code, an example of PHP code, or normal text. It is instead a complex process with lots of false positives.</p>
<p>Is this PHP code?</p>
<pre><code class="language-php">// if useful, remove</code></pre>
<p>Or this one?</p>
<pre><code class="language-php">// for example
// $value = 1000;</code></pre>
<p><br></p>
<h2 id="Re-Define-the-and-quot-Commented-PHP-Code-and-quot">Re-Define the &quot;Commented PHP Code&quot;</h2>
<p>We had such a sniff, and it was not working correctly. We stopped to think about the problem. How does commented PHP code look like? Let's say we have this code:</p>
<pre><code class="language-php">private function resolveFromNodeAndType(Node $node, Type $type): ?string
{
    $variableName = $this-&gt;resolveBareFromNode($node);
    if ($variableName === null) {
        return null;
    }

    $stringy = new Stringy($variableName);
    return (string) $stringy-&gt;camelize();
}</code></pre>
<p>What happens when you try to comment it out in PHPStorm?</p>
<pre><code class="language-php">//private function resolveFromNodeAndType(Node $node, Type $type): ?string
//{
//    $variableName = $this-&gt;resolveBareFromNode($node);
//    if ($variableName === null) {
//        return null;
//    }
//
//    $stringy = new Stringy($variableName);
//    return (string) $stringy-&gt;camelize();
//}</code></pre>
<p>What has changed? Every line starts with <code>//</code>.</p>
<p><br></p>
<p>What do we use if we want to comment logic and explain behavior? The doc block:</p>
<pre><code class="language-php">/**
 * If used on Monday, produces this code:
 *    $value = 'Monday is here';
 *    finally;
 * The rest of the week is off
 */</code></pre>
<p><br></p>
<p>In the end, all we look for <strong>is a more significant amount of lines starting with <code>//</code></strong>.</p>
<pre><code class="language-php">// ...
// ...
// ...</code></pre>
<p><br></p>
<p>After we re-defined the problem to a much simpler one, it was pretty easy to add this command to <a href="https://github.com/symplify/easy-ci">symplify/easy-ci</a> utils package.</p>
<h2 id="3-Steps-to-Detect-Commented-PHP-Code-in-Your-CI">3 Steps to Detect Commented PHP Code in Your CI</h2>
<p><strong>1. Install Easy CI</strong></p>
<pre><code class="language-bash">composer require symplify/easy-ci --dev</code></pre>
<p><br></p>
<p><strong>2. Run it</strong></p>
<pre><code class="language-bash">vendor/bin/easy-ci check-commented-code &lt;directory|ies&gt;
vendor/bin/easy-ci check-commented-code src packages</code></pre>
<p><br></p>
<p>Is it too strict? Tune line limit to your needs:</p>
<pre><code class="language-bash">vendor/bin/easy-ci check-commented-code src packages --line-limit 10</code></pre>
<p><br></p>
<p><strong>3. Add it to your CI</strong></p>
<p><br></p>
<p>That's it!</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/how-to-easily-protected-your-code-base-from-commented-php-code</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 02 Aug 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/how-to-easily-protected-your-code-base-from-commented-php-code#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How I made Huge Mistake with Interpretation of Laravel Downloads ]]></title>
                <link>https://tomasvotruba.com/blog/how-i-made-huge-mistake-with-interpretation-of-laravel-downloads</link>
                <description><![CDATA[ <p>The <a href="/blog/sunsetting-php-framework-trends">PHP FW Trends</a> project was introduced 2 years ago to compare download statistics over &quot;what they say on the internet&quot;. The methodology is based on Packagist data, which worked but had some flaws.
<br><br>
Also, monorepo and split packages downloads lead to a problem when one monorepo download has hidden 10-30 package downloads. <strong>There is no way to detect what packages are downloaded or used exactly</strong>, so <a href="/blog/2020/03/09/art-of-letting-go/">this project should be stopped to avoid showing miss-leading</a> data far from reality.</p> ]]></description>
                <content:encoded><![CDATA[ <p>This project had some controversial feedback, mainly because the numbers put some frameworks into a lower position than framework communities expected.</p>
<p>Let's look at 3 main problems.</p>
<h2 id="Composer-vs-Not-Composer-Downloads">Composer vs. Not Composer Downloads</h2>
<p>Most frameworks are accessible via packagist nowadays. If you need it, you use <code>composer require x/y</code>, and the package is there. But not all frameworks that are used in the PHP community have this install model.</p>
<p>One of them is <a href="https://packagist.org/packages/phalcon/cphalcon">phalcon/cphalcon</a>, which is also distributed on packagist but not exclusively. This means unknown X downloads from <code>wget</code>, <code>git clone</code> from the internal repository or zip files. I could leave this package with minimal downloads from packagist, suggesting that nobody uses this framework, or remove it from stats altogether, suggesting similar status.</p>
<p>Both wrong solutions had to be explained in methodology that very few people read based on feedback on Reddit.</p>
<h2 id="How-Laravel-adds-to-Symfony">How Laravel adds to Symfony?</h2>
<p>Next problem was that Laravel depends on Symfony with <a href="https://packagist.org/packages/laravel/framework">most of the packages</a>. E.g. <code>illuminate/console</code> depends on <code>symfony/console</code> (see <a href="https://packagist.org/packages/illuminate/console">packagist</a>).</p>
<p>10 millions download of the Laravel package probably produces 10 million downloads of Symfony packages. In some cases, even more, because one Laravel package can depend on multiple Symfony packages.</p>
<p>This has to be reflected in negated downloads per each Laravel package to Symfony. But was it good enough?</p>
<h2 id="How-is-Laravel-Itself-Downloaded">How is Laravel Itself Downloaded?</h2>
<p>Let's get to the</p>
<p>I only had experience from ~10 Laravel projects, so what might be obvious was some was hidden for me. It was not easy to find out why the numbers are so skewed against it, but now I know. I'm sorry about that.</p>
<p>Let's look where I made the mistake in the interpretation:</p>
<img src="https://user-images.githubusercontent.com/924196/127477591-8b1550a8-f2f9-41ad-8492-0b16496663f8.png" class="img-thumbnail">
<p><br></p>
<p>In the previous paragraph, I linked <code>illuminate/console</code>. How can you download it?</p>
<pre><code class="language-bash">composer require illuminate/console</code></pre>
<p>but also</p>
<pre><code class="language-bash">composer require illuminate/framework</code></pre>
<p>The first package has 2.x million downloads, and the second has 24.x million downloads. Yet both will get us <code>illuminate/console</code> content.</p>
<p><br></p>
<h2 id="Can-You-See-the-Problem">Can You See the Problem?</h2>
<ul>
<li><code>illuminate/framework</code> will give us all Laravel packages but will mark only one download</li>
<li><code>illuminate/console</code> will give us one Laravel package and will mark only 1 download too</li>
</ul>
<p>I assumed that <code>illuminate/framework</code> is not used for downloading packages anymore (data are for the last 12 months), like Symfony, Nette, Doctrine, and Zend developers don't use monorepo for downloads. In ~10 Laravel projects, the dependencies were always used separately, one package by another. But that was not a rule but rather an exception.</p>
<p><strong>Saying that there is no way to find out real per-package downloads numbers for Laravel.</strong> We can only guess, and guess is not good enough to make final assumptions.</p>
<p>Until the most used PHP frameworks use the per-package download approach and use packagist exclusively, these stats cannot be considered representative.</p>
<h2 id="It-s-not-about-Numbers-It-s-about-Emotions">It's not about Numbers, It's about Emotions</h2>
<p>Last but not least, I've realized using your favorite tool is not about number of other people using it or not using it. The most important is to have fun - so if you're having fun, use whatever you need to keep the fun on.</p>
<p><br></p>
<p>For these reasons, I'm sunsetting the <a href="https://phpfwtrends.org/">phpfwtrends.org</a> project.</p>
<p><br><br></p>
<p>Thank you for constructive feedback and patience till I figure it out.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/how-i-made-huge-mistake-with-interpretation-of-laravel-downloads</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 26 Jul 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/how-i-made-huge-mistake-with-interpretation-of-laravel-downloads#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Improve your Rector, PHPStan and CI Skills with 3 New Trainings ]]></title>
                <link>https://tomasvotruba.com/blog/launching-3-trainings-rector-phpstan-and-bulletproof-ci</link>
                <description><![CDATA[ <p>Do you have time to read a book now and then after work? Yes? Get <a href="/book/the-power-of-automated-refactoring">Rector - The Power of Automated Refactoring</a> and practice AST katas daily.
<br><br>
But not everyone has such a passion for technology and yet wants to get the work done with as few mistakes as possible. <strong>Learning a new technology alone is hard.</strong> There is too much edge-case to think about on every level of technology we use.
<br><br>
What if there was someone to pull you through the steep learning curve?</p> ]]></description>
                <content:encoded><![CDATA[ <p>I believe code automation has been changing the world as we know it. From automated deploys, through coding with CI, to self-repairing systems and GitHub Co-Pilot working for you.</p>
<p>If you work with software, it's worth learning. Do you believe it too, but have <strong>only one spare day to spend on learning</strong>?</p>
<p><br></p>
<p><strong>For you and your team, I've prepared 3 practical trainings</strong>. Each focuses on a specific area of automation that helps you automate your daily work:</p>
<h2 id="1-Rector-Ownage">1. Rector Ownage</h2>
<p>Do you want to run Rector on your project and get the most out of it? The first steps with AST are the hardest. This training aims to fast-forward you three months of self-taught know-how in a couple of days.</p>
<h2 id="2-PHPStan-Guru">2. PHPStan Guru</h2>
<p>Do you use PHPStan every day? Would you like to learn to use more rules that would help you find bugs faster?</p>
<h2 id="3-Bulletproof-CI">3. Bulletproof CI</h2>
<p>Would you like to learn from your CI? Would you like to shorten code reviews to fraction and speed up onboarding? Do you want to avoid repeating bugs that are not part of tests?</p>
<p><br></p>
<p>Would you like to know more about each specific training? <strong>Check the <a href="/trainings">training</a> page.</strong></p>
<p><br></p>
<div class="text-center">
    <img src="/assets/images/trainings/training_online.png" class="img-thumbnail w-75">
    <br>
    <em>Rector training with Quentic</em>
</div>
<h2 id="Single-Format">Single Format</h2>
<p>Successful and long-term automation stands on intuitive patterns. To make life easier and transparent for you, every training has:</p>
<ul>
<li>united price</li>
<li>united duration, two half-days</li>
<li>online for the pandemic time being, then anywhere in Europe</li>
</ul>
<h2 id="Focused-on-Your-Team">Focused on Your Team</h2>
<p>Why two half-days instead of 1 day? 1 day is easier to plan by the company and easier to sell to business people. It's more cost-effective for the trainer too, when it comes to attention and money.</p>
<p>Yet, the primary purpose of the training <strong>is to pass knowledge to your team and help your team use the knowledge in the long term</strong>. The well-rested brain learns better, and people are having more fun when the training is spread over 2 shorter days.</p>
<p>After the first half day, you still have the energy to try the tool at home after work. Maybe you have <strong>some questions or errors that you need to solve</strong>. Usually, you'd have to google them or ask the trainer after the training via email, waiting for a reply. <strong>That's what second half-day is for - to fill your gaps and make you grow.</strong></p>
<p><br></p>
<p>Would you save time wasted on repeated boring work and make tools work for you? <a href="/contact">Let me know</a>.</p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/launching-3-trainings-rector-phpstan-and-bulletproof-ci</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 19 Jul 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/launching-3-trainings-rector-phpstan-and-bulletproof-ci#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ A Week in a Life of Employed Open&amp;#8209;Source Developer ]]></title>
                <link>https://tomasvotruba.com/blog/a-week-in-a-life-of-employed-open-source-developer</link>
                <description><![CDATA[ <p>Would you contribute an open-source project if it would help your private one? How do you measure such cost-effectiveness? Maybe it's better to fork the package to your own or create your single local service. But who will maintain it and write a test for it? Who will upgrade it when PHP 8 is in EOL?
<br><br>
I want to share my point of view on prisoners' dilemma, which you maybe know from your daily work.</p> ]]></description>
                <content:encoded><![CDATA[ <p>We are almost finished with upgrade to PHP 8. We already <a href="/blog/how-to-refactor-custom-doctrine-annotations-to-attributes">migrated our custom</a> <code>@annotations</code> classes to <code>#[attributes]</code> classes and upgrade whole code base to new PHP 8 syntax.</p>
<p><strong>Why do we want PHP 8 attributes</strong> instead of annotations everywhere?</p>
<ul>
<li>strict autocomplete</li>
<li>single united syntax</li>
<li>no place for docblock <code>{("key"='s',),}}</code> bugs due to a bit of typo here and there</li>
<li>full native support of PHPStorm autocomplete, PHPStan custom rules, and Rector automated upgrades</li>
</ul>
<p>But you know what they say:</p>
<blockquote class="blockquote text-center">
    "Upgrading your code is a piece of cake,<br>
    the Devil is in the vendor."
</blockquote>
<h2 id="The-Devil-of-Upgrade">The Devil of Upgrade</h2>
<p>I think you knew this from your project. You've added a feature or changed behavior. Everything works. Just this tiny file has one bug that you need to solve. Too bad it has <code>/vendor</code> in its absolute path.</p>
<p>Our code now looks like this:</p>
<pre><code class="language-php">final class SomeController
{
    /**
     * @ExternalAnnotation
     */
    #[OurAttribute]
    public function __invoke()
    {
        // ...
    }
}</code></pre>
<p>What do you think about when you see this code?</p>
<p><br></p>
<ul>
<li>Does the annotation and attribute work in inverse order?</li>
</ul>
<pre><code class="language-diff">-    /**
-     * @ExternalAnnotation
-     */
     #[OurAttribute]
+    /**
+     * @ExternalAnnotation
+     */
     public function __invoke()</code></pre>
<p><br></p>
<ul>
<li>What if we have annotation and attribute of the same name?</li>
</ul>
<pre><code class="language-php">    /**
     * @OurAttribute
     */
    #[OurAttribute]
    public function __invoke()</code></pre>
<p><br></p>
<ul>
<li>How does the annotation parser handles these conflicts?</li>
<li>What happens when we want to get just one item of <code>OurAttribute</code>?</li>
<li>...</li>
</ul>
<h2 id="2-Ways-to-Do-1-Thing">2 Ways to Do 1 Thing?</h2>
<p>These questions seem like a decent topic to think about in the evening over a glass of smoked whiskey... But <strong>they're rather a sign of design smell in our architecture</strong>. There should exactly one way to add metadata above methods, <a href="/blog/how-exception-to-the-convention-does-more-harm-than-good">no exception</a> allowed.</p>
<p>What happens if there is an exception and we have at least two ways to add metadata? Cognitive dissonance kicks in, and we can use whatever we want anywhere we want:</p>
<pre><code class="language-php">/**
 * @OurAttribute
 */
public function __invoke()

// another class

#[OurAttribute]
public function __invoke()</code></pre>
<p>Too bad our project only supports attributes now, and <code>@OurAttribute</code> is silently ignored. It will cause the server down on Saturday morning and make a couple of families very happy about having their developer half work a whole weekend to figure this out.</p>
<h2 id="Back-to-Vendor">Back to Vendor</h2>
<p>Now that we've made clear attributes are the only way to go:</p>
<pre><code class="language-php">#[ExternalAnnotation]
#[OurAttribute]
public function __invoke()</code></pre>
<p>First, we have to make sure the <code>@ExternalAnnotation</code> supports attribute syntax. The PHP 8 is out for 8 months now, so someone else must have already done it. After all, it's <a href="/blog/how-to-refactor-custom-doctrine-annotations-to-attributes">as simple as</a> adding an <code>#[Attribute]</code> above <a href="/blog/doctrine-annotations-and-attributes-living-together-in-peace">each annotation</a>, right?</p>
<blockquote class="blockquote text-center">
I expect that the whole open-source world<br>
is here for me only to solve my personal problems.
</blockquote>
<p>I've checked the <a href="https://github.com/apitte/core/">apitte/core</a> package we used for annotations and found out. It does not support attributes. Hm, what now? There <a href="https://github.com/apitte/core/issues/151">is an issue</a> from January 2021, but that's it. I've decided to contribute back to the package developers and maintainers... and clicked on the 👍 button under the issue.</p>
<h2 id="It-s-Never-so-Easy">It's <del>Never</del> so Easy</h2>
<p>Oh no, life is not aligned with my wishful thinking again. What now? Maybe it's time to give up and teach my teammates a new exception they <a href="/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock/">only have to remember</a>: &quot;The A, B, and C are always attributes and D, E, and F are always annotations.&quot;</p>
<p>I liked this option initially, but then thought of <strong>being paid for adding my coworkers more meta-work</strong>, making them logarithmically more expensive, which seemed a bit embarrassing for me.</p>
<p>What other options do I have?</p>
<p>Maybe I could add this feature to the <code>apitte/core</code> package? Hm, I haven't worked with Nette open-source for the past 5 years, so that it will require some temporary learning - the worst use of my brain cells if you ask me. Well, if it's adding an <code>#[Attribute]</code> above each class, I think I can handle it.</p>
<p>This is how the pull request looks in my head:</p>
<pre><code class="language-diff"> /**
  * @Annotation
  */
+#[Attribute]
 class SomeClass
 {
 }</code></pre>
<p>I'm daydreaming about the fame and glory I will receive from the PHP community just for the 10&nbsp;minutes of my work. Let's do this!</p>
<p>I fork the package, create a pull request, learn how to run the <code>make X</code> command, and send the pull request. I'm thinking, hm, maybe I should <strong>add a test</strong> to guarantee my contribution works and make the maintainer more open to merge it. I don't want to bother them twice just to ask me for a test.</p>
<p>My plan is simple: copy-paste existing test, duplicate controller fixture class, replace annotations with attributes, and expected the same result as annotations have. That sounds simple enough, right?</p>
<h2 id="Can-Doctrine-Annotations-Reader-handle-Attributes">Can Doctrine Annotations Reader handle Attributes?</h2>
<p>I made this plan happen and run the test. Nothing. It seems no attribute classes were found. What is wrong? Everything is 1:1. Just instead of <code>@SomeClass</code>, there is <code>#[SomeClass]</code> - this must work! I run just a single test for a single attribute, only to confirm the previously failed result.</p>
<p>I do a bit of reflecting on a toilet and have an epiphany - there is another vendor package that handles metadata reading.  The <code>Doctrine\Common\Annotations\AnnotationReader</code> service!</p>
<p>I'm thinking... the Doctrine annotations are dualistic - there is one class for <code>Entity</code>, you don't have to change anything:</p>
<pre><code class="language-diff"> use Doctrine\ORM\Mapping\Entity;

-/**
- * @Entity
- */
+#[Entity]
class Post
{
}</code></pre>
<p>The annotation reader follows the logic. Maybe it has a different name, but that it:</p>
<pre><code class="language-diff">-Doctrine\Common\Annotations\AnnotationReader
+Doctrine\Common\Annotations\AnnotationAndAttributeReader</code></pre>
<p>Well, unless it isn't. After a few minutes of testing, I accepted that the AnnotationReader only reads annotations, not attributes. The <code>doctrine/annotations</code> packages do not support any custom reader for attributes. Why does <code>doctrine/orm</code> supports dualistic annotations in a single class and <code>doctrine/annotations</code> does not? Probably a result of missing Doctrine vendor monorepo.</p>
<p>This <a href="/blog/how-exception-to-the-convention-does-more-harm-than-good">logical exception caused me</a> <strong>lose my sanity</strong>. Almost, but instead, I've decided to look for some reader package that would understand both annotations. There is some advanced reader in <code>doctrine/orm</code>, but we don't use Doctrine and Symfony, so pulling so many new packages just to read simple attributes was not an option.</p>
<h2 id="A-Package-that-Reads-both-Annotations-and-Attributes">A Package that Reads both Annotations and Attributes</h2>
<p>After a bit of googling on packagist, I've found <a href="/blog/doctrine-annotations-and-attributes-living-together-in-peace">Koriym.Attributes</a> package. I hope the name is not as precise as `doctrine/annotations' This package can read annotations.</p>
<p><strong>My expectations are</strong> that I install this package to <code>apitte/core</code>, replace the reader with this one; it will work for both annotations and attributes. I love the naivety of my younger self, but we still got some time to get there.</p>
<p>I've replaced the package and run the tests. Nothing. What is going on? Is the <code>koriym/Koriym.Attributes</code> package broken? I check the tests of the package, and it looks fine. This use case should work. There is one more surprise lurking...</p>
<p>How do you think an annotation class looks like for this use case?</p>
<pre><code class="language-php">/**
 * @Route("some-path")
 */</code></pre>
<p>My expectation is:</p>
<pre><code class="language-php">/**
 * @annotation
 */
class Route
{
    public function __construct(string $path)
    {
    }
}</code></pre>
<p>In <a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Routing/Annotation/Route.php#L49-L50">reality</a>, it's closer to:</p>
<pre><code class="language-php">/**
 * @annotation
 */
class Route
{
    public function __construct(array $data)
    {
        if (...) {
            // ...
            $this-&gt;path = $data['path'];
        }
    }
}</code></pre>
<p>Hmm, so how can I make dualistic annotation/attribute in a single class? <strong>Attributes must use named arguments</strong> to make the most out of them:</p>
<pre><code class="language-php">/**
 * @annotation
 */
#[Attribute]
class Route
{
    public function __construct(string $path)
    {
        // ...
    }
}</code></pre>
<p>Do you know, there are <strong>3 ways to create an annotation class</strong>. But only one of them is compatible with attributes and only supported since the <code>doctrine/annotations</code> version was released this summer. Which one is it, and how to make it happen? You can find out in <a href="/blog/doctrine-annotations-and-attributes-living-together-in-peace">Doctrine Annotations and Attributes Living Together in Peace</a>.</p>
<h2 id="Refactor-Everything">Refactor Everything</h2>
<p>I realize how this used to be so simple in my head before I knew anything about this topic... I guess that's what stupidity is.</p>
<p>I have to refactor every single annotation class. Not just their constructor, but also the logic they use inside. We have 2 pull requests to <code>apitte/core</code> now:</p>
<ul>
<li>one that adds annotation + attribute reader - new feature with a possible change of behavior - <a href="https://github.com/apitte/core/pull/161">https://github.com/apitte/core/pull/161</a></li>
<li>one that makes annotation compatible with attributes - no new feature, but the extension of possible future use - <a href="https://github.com/apitte/core/pull/162">https://github.com/apitte/core/pull/162</a></li>
</ul>
<p><strong>The latter PR is pre-step</strong>, so using low-hanging fruit of least surprise, I've pushed it to be merged first. If you can, always use these pre-step PRs to make the feature PR much smaller and easier to review.</p>
<h2 id="How-to-Test-Pull-Request-Before-Merge">How to Test Pull-Request Before Merge?</h2>
<p>Now we have two pull-request with code changes. Tests are passing, PHPStan is passing, coding standards are passing... that should be enough, right? There is one more important test - in our actual project.</p>
<p>Usually, we have to wait for the feature to be merged and tagged before using it.</p>
<p>Are you highly impatient like me? Then you can require a merged dev version:</p>
<pre><code class="language-json">{
    "require": {
       "apitte/core": "dev-master"
    }
}</code></pre>
<p>But what if there are some bugs in the pull request? Can we wait till the PR is merged to the main branch? No. We want to try them right now. Luckily, there is an easter egg in the composer that makes this simpler. You probably know we can require a specific hash of `dev-master:</p>
<img src="https://user-images.githubusercontent.com/924196/125828158-e0efd58a-0243-4d3e-8e93-ff007db9fd48.png" class="img-thumbnail mb-5 mt-5">
<p>Then use this hash next as a version in <code>composer.lock</code>:</p>
<pre><code class="language-json">{
    "require": {
       "apitte/core": "dev-master#d38ga8gb"
    }
}</code></pre>
<p><strong>This versioning is much-preferred</strong> to dynamic <code>dev-master, that always take the latest version. The latest version can change in time, but the hash</code>dev-master#d38ga8gb` version always points to the exact commit. It's like a tag for poor people.</p>
<h2 id="Composer-Easter-Egg">Composer Easter Egg</h2>
<p>So how is using <code>dev-master</code> in specific hash useful? Now we'll find the easter egg:</p>
<img src="https://user-images.githubusercontent.com/924196/125828932-0792189c-3082-4b94-9568-a92e1eeff936.png" class="img-thumbnail mb-5 mt-5">
<p><strong>We can use hash in pull-request the same way with `dev-master</strong>:</p>
<pre><code class="language-json">{
    "require": {
       "apitte/core": "dev-master#1025287"
    }
}</code></pre>
<p>The composer will install the exact commit from the pull request!</p>
<p><br></p>
<p>This testing found at least five bugs that we would discover only after merging the pull request!</p>
<h2 id="One-Week-Later">One Week Later</h2>
<p>The <code>appetite/core</code> annotations and attributes now work in the <code>dev-master</code>. I hope Milan will tag the next version soon to remove <code>dev-main</code> from our composer.</p>
<p>Good, now we have the tools ready, <code>apitte/core</code> is up to date and ready. I can finally start the refactoring that seemed &quot;so easy&quot; a few days before. The <strong>safest refactoring is one class at a time</strong>, try it, test it and then merge it. If everything works, we can refactor 2 more classes and so on.</p>
<p>This way, the first pull request had a bunch of annotations and attributes above the same method:</p>
<pre><code class="language-php">/**
 * @ExternalAnnotation
 */
#[ExternalAttribute]
public function __invoke()
{
}</code></pre>
<p>Technically this should work, at least by <strong>my expectations</strong>. Too bad the CI disagreed with me.</p>
<h2 id="1-Package-1-Responsibility">1 Package = 1 Responsibility</h2>
<p>I debug the <code>apitte/core</code> and then <code>koriym/Koriym.Attributes</code> reader a bit. It seems the reader only returns attributes, no annotations. I assumed that it reads both annotations and attributes <strong>at the same time</strong> together. But the tool is a bit different.</p>
<ul>
<li>It read the attributes first - if found, it returned them.</li>
<li>If not, it read the annotations and returned them.</li>
</ul>
<p>I first fixed this by making a custom reader class in <code>apitte/core</code>. A few hours later, I realized this might be changed directly in <code>koriym/Koriym.Attributes</code>. I tried to avoid it, as it requires learning the practices and conventions of yet another package.</p>
<p><strong>But it is the right way to go</strong>, to keep one responsibility per package. <code>apitte/core</code> should not care about the reader. Its value is in connecting read annotations or attributes together to resolve API requests.</p>
<p>So I proposed a <a href="https://github.com/koriym/Koriym.Attributes/pull/11">pull-request there</a>. After 3 days of very active feedback from Koriym, the pull request was ready. <strong>Thank you, Koriym, for the attention and time you gave me.</strong></p>
<p>One risk of contributing to an open-source project is frustrating response times for both parties.</p>
<p>Usually, there is no timetable for getting a response from the maintainer. You don't know if they respond in 10 minutes, today, or in 2 weeks. Sometimes maintainer can respond in a matter of an hour, just to point out the CI is failing. You fix it, push it a matter of 10 minutes. But then you wait 5 more days for another reply. But that's part of the deal, and when it works out, <strong>it's a great unique feeling of compassion across time zones</strong>.</p>
<h2 id="Meeting-My-Expectations">Meeting My Expectations</h2>
<p>We're heading to the end. With two open-source packages, 5 pull-request later, my expectations are met. I'm happy. If I came to this problem today, I would only use the packages without any surprises. I hope this team effort will make this experience smooth for everyone else in the same situation. Thank you, Milan and Koriym, for your teamwork with a narrow focus on what is essential for the package's sake.</p>
<blockquote class="blockquote text-center">
"Contribute the changes to open-source<br>
you want to see in the world."
</blockquote>
<h2 id="Meet-New-Friends">Meet New Friends</h2>
<p>Apart from the new features in the 2 packages and our private project, I feel like I had a great time with 2 friends. We were talking about code, but also coding techniques and one's approach to life.</p>
<p>In a code, you can often see more than meets the eye. We can see if the package has clear naming, neat and easy-to-understand README, or a simple design. It's the door to the writer's mind.</p>
<p>So what is the conclusion for today? <strong>If you feel something or someone has failed you, you can always do something about it</strong>. Maybe you improve your life, and maybe you improve the world a little bit too.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/a-week-in-a-life-of-employed-open-source-developer</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 12 Jul 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/a-week-in-a-life-of-employed-open-source-developer#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Scope Your PHP Tool in 10 Steps ]]></title>
                <link>https://tomasvotruba.com/blog/how-to-scope-your-php-tool-in-10-steps</link>
                <description><![CDATA[ <p>Do you know PHPStan, ECS, <a href="https://github.com/symplify/monorepo-builder">Monorepo Builder</a>, PHPUnit, <a href="https://github.com/symplify/config-transformer">Config Transformer</a> or Rector?
<br><br>
In the previous post, we explored <a href="/blog/why-do-we-scope-php-tools">why are these tools scoped</a>, where scoping makes sense and where not so much.
<br><br>
<strong>Do you maintain a PHP tool that runs in the command line</strong>? Today we'll look at 10 steps on how you can scope it too.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="1-Add-php-scoper">1. Add php-scoper</h2>
<p><a href="https://github.com/humbug/php-scoper">php-scoper</a> is a tool that scans our project and its <code>/vendor</code>. Then it adds a unique random prefix to every class:</p>
<pre><code class="language-diff">-namespace Symfony\Component\Console\Command;
+namespace Scoper12345\Symfony\Component\Console\Command;

-use Symfony\Component\Console\Input\InputInterface;
+use Scoper12345\Symfony\Component\Console\Input\InputInterface;

 class Command
 {
     protected function execute(InputInterface $inputInterface,  ...)
     {
     }

     // ...
 }</code></pre>
<p>We can install php-scoper as composer dependency. But soon, we'll get into a situation when php-scoper scopes itself and becomes part of the project. We don't want that.</p>
<p><br></p>
<p>It's safer to <strong>get a php-scoper PHAR file</strong>, the similar way we use composer as a PHAR file:</p>
<pre><code class="language-bash">wget https://github.com/humbug/php-scoper/releases/download/0.14.0/php-scoper.phar -N --no-verbose

# then we have a file ready to run
php-scoper.phar ...</code></pre>
<h2 id="2-Configure-php-scoper">2. Configure php-scoper</h2>
<p>Php-scoper needs a configuration file, by convention, named <code>scoper.php</code>. It's a file that returns an array.</p>
<ul>
<li>the keys = configuration names</li>
<li>the values = settings value</li>
</ul>
<p>The simpler this file is the better - e.g. this is how this config look <a href="https://github.com/sebastianbergmann/phpunit/blob/master/build/config/php-scoper.php">like in PHPUnit</a>:</p>
<pre><code class="language-php"># scoper.php
return [
    'whitelist' =&gt; [
        'PHPUnit\*',
    ],
];</code></pre>
<p><br></p>
<p>How would such configuration look like for the<code>Symplify\MonorepoBuilder</code> tool? First, we need to <strong>whitelist namespace of our tool</strong>.</p>
<p>Why? For 2 reasons:</p>
<ul>
<li>to allow extension of core files, e.g., every test case extends from <code>PHPUnit\Framework\TestCase</code> and not from  <code>Scoper12HK32J2\PHPUnit\Framework\TestCase</code></li>
<li>it's safe because people only require our package once</li>
</ul>
<pre><code class="language-php"># scoper.php
return [
    'whitelist' =&gt; [
        'Symplify\MonorepoBuilder\*',
    ],
    'patchers' =&gt; [
        // callback to process files after the scoping; we'll use them soon
    ]
];</code></pre>
<h2 id="3-Add-Symfony-Specials-to-php-scoper-Config">3. Add Symfony Specials to php-scoper Config</h2>
<p>Now, the php-scoper does a lot of work for us. Yet, it does not understand some framework-specific situations. E.g. Symfony autodiscovery in <code>config/config.php</code>:</p>
<pre><code class="language-php">use Scoper12HK32J2\Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return static function (ContainerConfigurator $containerConfigurator): void
{
    $services = $containerConfigurator-&gt;services();
    $services-&gt;load('Scoper12HK32J2\\Symplify\MonorepoBuilder\\', __DIR__ . '/../src');
};</code></pre>
<p>What is wrong with this file? In config above, we've excluded <code>Symplify\MonorepoBuilder\</code> namespace from being scoped. Yet, here it is scoped:</p>
<pre><code class="language-php">$services-&gt;load('Scoper12HK32J2\\Symplify\MonorepoBuilder\\', __DIR__ . '/../src');</code></pre>
<p><br></p>
<p>That lead to a bug, when Symfony is loading services that do not exist. We need to fix it:</p>
<pre><code class="language-diff">-$services-&gt;load('Scoper12HK32J2\\Symplify\MonorepoBuilder\\', __DIR__ . '/../src');
+$services-&gt;load('Symplify\MonorepoBuilder\\', __DIR__ . '/../src');</code></pre>
<p>We could do it manually on every scoping, or we can teach <code>scoper.php</code> to do it for us via <code>"patchers"</code> configuration.</p>
<p>Now, this is the hardest part of the php-scoper configuration, so get ready for callables without types:</p>
<pre><code class="language-php"># scoper.php
use Nette\Utils\Strings;

return [
    // scope symfony configs
    'whitelist' =&gt; [
        'Symplify\MonorepoBuilder\*',
    ],
    'patchers' =&gt; [
        function (string $filePath, string $prefix, string $content): string {
            // $filePath is sometimes relative, sometimes absolute
            // so always compare the file path with file ends or a regex
            if (! str_ends_with($filePath, 'config/config.php')) {
                // we only care about config/config.php file here
                // if it's anything else, just keep the origin $content
                return $content;
            }

            // remove the prefix
            return Strings::replace(
                $content,
                '#load\(\'' . $prefix . '\\\\Symplify\\\\MonorepoBuilder#',
                'load(\'' . 'Symplify\\MonorepoBuilder',
            );
        },
    ]
];</code></pre>
<p>Callables in the <code>patchers</code> key have every scoped file on the input. The file is <strong>already scoped</strong> so that we can remove unwanted prefixes.</p>
<p>Our callable above has one job - it finds <code>config/config.php</code>, then it will remove the prefix on <code>load()</code> method:</p>
<pre><code class="language-diff">-$services-&gt;load('Scoper12HK32J2\\Symplify\MonorepoBuilder\\', __DIR__ . '/../src');
+$services-&gt;load('Symplify\MonorepoBuilder\\', __DIR__ . '/../src');</code></pre>
<p>That's it. Now the Symfony autodiscovery works again.</p>
<h2 id="4-Scope-other-Public-API-of-Your-Project">4. Scope other Public API of Your Project</h2>
<p>We've already unscoped the <code>Symplify\MonorepoBuilder\</code> namespace. The Monorepo Builder provides an interface that developers can implements, register in the <code>monorepo-builder.php</code> config, and the tool will collect it. It looks like this:</p>
<pre><code class="language-php">use Symplify\MonorepoBuilder\Release\Contract\ReleaseWorkerInterface;
use PharIo\Version\Version;

final class SomeReleaseWorker implements ReleaseWorkerInterface
{
    public function work(Version $version)
    {
        // ...
    }
}</code></pre>
<p>Can you see the problem?</p>
<p><br></p>
<p>The <code>PharIo\Version\Version</code> is scoped to <code>ScoperDF0239\PharIo\Version\Version</code> and does not exist. If we try to implement this interface, we will crash:</p>
<p><a href="https://github.com/symplify/symplify/issues/3388#issuecomment-875301853"></p>
<img src="https://user-images.githubusercontent.com/53906348/124706025-eb8adf00-def6-11eb-8f70-e596e759ae3f.png" class="img-thumbnail">
<p></a></p>
<p><strong>The <code>PharIo\Version\</code> namespace is part of our public API.</strong> Meaning people can use it because our interface encourages it.</p>
<p>There are 2 solutions to this problem. The first one is more cleaner, but also more work and BC break:</p>
<ul>
<li>wrap <code>PharIo\Version\Version</code> in our custom namespaced object, making it a private API</li>
</ul>
<pre><code class="language-diff"> use Symplify\MonorepoBuilder\Release\Contract\ReleaseWorkerInterface;
-use PharIo\Version\Version;
+use Symplify\MonorepoBuilder\Version\Version;

 final class SomeReleaseWorker implements ReleaseWorkerInterface
 {
     public function work(Version $version)
     {
         // ...
     }
 }</code></pre>
<ul>
<li>add <code>PharIo\Version\*</code> to unscoped namespace in <code>scoper.php</code></li>
</ul>
<pre><code class="language-diff"> # scoper.php

 return [
     // scope symfony configs
     'whitelist' =&gt; [
         'Symplify\MonorepoBuilder\*',
+        'PharIo\Version\*',
     ],
     // ...
 ];</code></pre>
<p>This way, the <code>PharIo\Version\*</code> classes will be skipped from scoping.</p>
<p>I've picked the latter to save trouble for myself and avoid BC break.</p>
<p><br></p>
<p>Do you have some public API namespace that developers using your package will try to use? Exclude it in the <code>'whitelist'</code> key. Mind the asterisk in the end <code>\*</code> - it covers all classes in the namespace.</p>
<h2 id="5-Run-php-scoper">5. Run php-scoper</h2>
<p>We have the config ready. Now it's time to run the scoper.</p>
<ul>
<li>Include directories with PHP code, bin directory, configs, YAML/NEON/XML files, and the <code>/vendor</code> directory.</li>
<li>Skip the tests and fixtures for tests.</li>
</ul>
<pre><code class="language-bash">$RESULT_DIRECTORY=monorepo-builder-scoped

php-scoper.phar add-prefix bin config src vendor composer.json --output-dir "../$RESULT_DIRECTORY" --config scoper.php --force --ansi</code></pre>
<p>Now we have scoped tool in the <code>monorepo-builder-scoped</code> directory, good job!</p>
<h2 id="6-Create-Release-Repository-separated-from-Develop-Repository">6. Create Release Repository separated from Develop Repository</h2>
<p>So how do we get the scoped version to our users? We have to set up repository architecture first.</p>
<p>The <code>symplify/monorepo-builder</code> package is developed in:</p>
<ul>
<li><a href="https://github.com/symplify/symplify">https://github.com/symplify/symplify</a></li>
</ul>
<p>The scoped version is published in:</p>
<ul>
<li><a href="https://github.com/symplify/monorepo-builder">https://github.com/symplify/monorepo-builder</a></li>
</ul>
<h2 id="7-Push-Scoped-Project-to-Release-Repository">7. Push Scoped Project to Release Repository</h2>
<p>The same way we push commits to our repository, we will push scoped code to the remote scoped repository:</p>
<pre><code class="language-bash">cd monorepo-builder-scoper

# add a remote repository
git init
git remote add origin git@github.com:symplify/monorepo-builder.git

# add content and push it
git add .
git push -f</code></pre>
<h2 id="8-Include-vendor-Directory">8. Include <code>/vendor</code> Directory</h2>
<p>The most common mistake I make is missing the <code>/vendor</code> directory. I scope the project, make it run locally. Everything is fine. Then I push the whole project without its vendor, and it breaks. So don't forget to allow pushing the scoped <code>/vendor</code> too:</p>
<pre><code class="language-diff"># .gitignore
-/vendor
 composer.lock</code></pre>
<h2 id="9-Automate-Scoping-Within-CI">9. Automate Scoping Within CI</h2>
<p>The whole process above is daunting and error-prone. It must be automated and running in CI, so we know the instant any of our commits break it.</p>
<p>We have it in Symplify GitHub Actions <a href="https://github.com/symplify/symplify/blob/main/.github/workflows/build_monorepo_builder_prefixed.yaml">up and running here</a>. The scoping process <a href="https://github.com/symplify/symplify/blob/9a8daa14615980b8e03c7970aeadf248b31c7c41/.github/workflows/build_monorepo_builder_prefixed.yaml#L60">starts in step 4</a>:</p>
<h2 id="10-Learn-by-Copying-from-Existing-Projects">10. Learn by Copying from Existing Projects</h2>
<p>The best way to learn is to copy already working processes. It's essential to have a safety net if you're doing something the first time, just before you have an a-ha moment and everything clicks together.</p>
<p>That's why you can learn of the full scoping in <code>symplify/monorepo-builder</code> that is spread across 3 files.</p>
<ul>
<li><a href="https://github.com/symplify/symplify/blob/main/.github/workflows/build_monorepo_builder_prefixed.yaml">Scoping GitHub Action Workflow</a></li>
<li><a href="https://github.com/symplify/symplify/blob/main/packages/monorepo-builder/build/build-monorepo-builder-scoped.sh">Bash for Scoping and local testing</a></li>
<li><a href="https://github.com/symplify/symplify/blob/main/packages/monorepo-builder/scoper.php"><code>scoper.php</code> configuration</a></li>
</ul>
<p><br></p>
<p>Keep it up, and I look forward to your first scopes!</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/how-to-scope-your-php-tool-in-10-steps</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 08 Jul 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/how-to-scope-your-php-tool-in-10-steps#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Why do we Scope PHP Tools ]]></title>
                <link>https://tomasvotruba.com/blog/why-do-we-scope-php-tools</link>
                <description><![CDATA[ <p>Do you know PHPStan, ECS, <a href="https://github.com/symplify/monorepo-builder">Monorepo Builder</a>, PHPUnit, <a href="https://github.com/symplify/config-transformer">Config Transformer</a> or Rector?
<br><br>
What do they have in common? They're PHP tools you install with composer and then run in your command line. Hm, what else? <strong>They're all scoped with help of <a href="https://github.com/humbug/php-scoper">php-scoper</a>.</strong>
<br><br>
Do you want to make your tool resistant to any conflict with any project dependencies? Today I'll show you how.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Let's say you want to install <code>symplify/monorepo-builder</code> to any of your projects with composer:</p>
<pre><code class="language-bash">composer require symplify/monorepo-builder --dev</code></pre>
<p>What can happen?</p>
<ul>
<li><em>[ERROR] conflicts with your PHP version</em></li>
<li><em>[ERROR] conflicts with your symfony/console, must be 5.2+, you have 4.4</em></li>
<li><em>[ERROR] conflicts with your another-dependency, must be X, you have Y</em></li>
</ul>
<p>Now you have to go to your <code>composer.json</code>, figure out what conflicts you can solve. You can also try to go to the project repository and ask for lowering the minimal required version of this or that package. This is typical for unscoped packages and natural results for semver strategy of PHP packages ecosystem.</p>
<p><br></p>
<p>But do we care about the dependencies of the tool we use? No, our goal is <strong>to run the tool</strong>:</p>
<pre><code class="language-bash">composer require symplify/monorepo-builder --dev
vendor/bin/monorepo-builder &lt;command&gt;</code></pre>
<h2 id="How-Can-We-Get-rid-of-Tool-s-Dependencies">How Can We Get rid of Tool's Dependencies?</h2>
<div class="row">
    <div class="col-12 col-sm-6">
        <em>Before scoping</em>
        <img src="https://user-images.githubusercontent.com/924196/124739507-35d18780-df1a-11eb-9ff8-6c91b6159e78.png" class="img-thumbnail mt-3">
    </div>
    <div class="col-12 col-sm-6">
        <em>After scoping</em>
        <img src="https://user-images.githubusercontent.com/924196/124739467-2eaa7980-df1a-11eb-90ce-e62b76292b95.png" class="img-thumbnail mt-3">
    </div>
</div>
<p><br></p>
<p>We'll scope the tool! Only then we're conflict-free! Our project can have <code>symfony/console</code> 3.4 or 5.4-dev. Nobody cares because the only requirement is of the tool is the PHP version.</p>
<h2 id="How-is-that-possible">How is that possible?</h2>
<p>Wait, how can we have 2 versions of <code>symfony/console</code>? Let's look at the file structure we'll find in <code>/vendor</code> if we install the following packages together:</p>
<pre><code class="language-bash">composer require symfony/console:^3.4
composer require symplify/monorepo-builder # new scoped one</code></pre>
<h2 id="1-Your-Command-class">1. Your <code>Command</code> class</h2>
<p>These steps will produce 2 different <code>symfony/console</code> directories with 2 different <code>Symfony\Component\Console\Command\Command</code> classes.</p>
<pre><code class="language-bash">/vendor
    /symfony
        /console # version 3.4, autoloaded by your project
            /Command
                Command.php</code></pre>
<p>That contains typical <code>Command</code> class as you know it</p>
<pre><code class="language-php">namespace Symfony\Component\Console\Command;

class Command
{
    // ...
}</code></pre>
<p>Pretty standard, right?</p>
<h2 id="2-Scoped-Command-class">2. Scoped <code>Command</code> class</h2>
<p>Here the scoping magic happens. The <code>symplify/monorepo-builder</code> package it's own Command in it's own scoped <code>/vendor</code>. Like this:</p>
<pre><code class="language-bash">/vendor
    /symplify
        /monorepo-builder
            /vendor # this vendor is scoped and loaded only by monorepo-builder
                /symfony
                    /console
                        /Command
                            Command.php</code></pre>
<p>Now, this <code>Command</code> class is a bit different. It's <em>scoped</em>. What does that mean exactly? It has its unique namespace prefix that makes class name unique to other <code>Command</code>:</p>
<pre><code class="language-php">namespace Scope1234\Symfony\Component\Console\Command;

class Command
{
    // ...
}</code></pre>
<p>So now in the whole project we now have 2 <code>Command</code> classes:</p>
<ul>
<li><code>Symfony\Component\Console\Command</code>
<ul>
<li>loaded by your project autoload</li>
<li>in a version defined in your projects <code>composer.json</code></li>
<li>you can use this class in your project, e.g. to create your own commands</li>
</ul></li>
</ul>
<p><br></p>
<ul>
<li><code>Scope1234\Symfony\Component\Console\Command</code>
<ul>
<li>loaded by monorepo-builder</li>
<li>in a version required by monorepo-builder</li>
<li>you will never see this class in your code</li>
</ul></li>
</ul>
<p>The second class was scoped by <code>php-scoper</code>, that makes all classes unique and accessible exclusively in the tool. This process removes dependency from <code>composer.json</code> and thus avoid conflicts on install.</p>
<h2 id="Scope-All-The-Things">Scope All The Things?</h2>
<p>Now, should we get crazy and scope everything that pops up a conflict on <code>composer require &lt;x&gt;</code>? No. This process is valid only for <strong>PHP tools</strong> in the command line. We should not scope classic dependencies that we use directly in our project, e.g. <code>nette/utils</code>.</p>
<p><br></p>
<h2 id="Where-is-Scoping-Useful">Where is Scoping Useful?</h2>
<ul>
<li>if we create an open-source PHP tool for the community</li>
<li>if our community uses composer</li>
<li>if we want to ease installation on both super modern and well-grown legacy projects</li>
</ul>
<p><br></p>
<p>Now that we know <em>why</em> and <em>what</em> we scope, we'll look at <a href="/blog/how-to-scope-your-php-tool-in-10-steps"><em>how</em> to do the scoping in the next post</a>.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/why-do-we-scope-php-tools</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 05 Jul 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/why-do-we-scope-php-tools#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Replace Single Node with Two Nodes in Abstract Syntax Tree ]]></title>
                <link>https://tomasvotruba.com/blog/how-to-replace-single-node-with-two-nodes-in-abstract-syntax-tree</link>
                <description><![CDATA[ <p>Already over 120 people bought <a href="/blog/rector-the-power-of-automated-refactoring-book-released">the Rector book</a> that we released just a month ago. The continuously growing interest in abstract syntax technology makes me very happy.
<br><br>
It leads to more developers <strong>who can write their own custom Rector rules to improve their specific projects</strong>. That leads to more &quot;how-to&quot; questions in the Rector repository. I've decided to answer one of the frequent ones today.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Standard rules usually replace one node with another, or change it. There are three operations you can make. Let's take them one by one, starting from the simplest.</p>
<p><br></p>
<h2 id="1-Change-one-Node">1. Change one Node</h2>
<p>E.g. when here it renames one class in a constructor to another:</p>
<pre><code class="language-diff"> public function __construct(
-    EntityManager $entityManager
+    EntityManagerInterface $entityManager
 ) {
 }</code></pre>
<p><br></p>
<p>In Rector rule AST syntax, it looks like this:</p>
<pre><code class="language-php">use PhpParser\Node\Param;
use Rector\Core\Rector\AbstractRector;

final class RenameEntityManagerRector extends AbstractRector
{
    /**
     * @param Param $node
     */
    public function refactor(Node $node)
    {
        // here we only change `type` property, everything else remains the same
        $node-&gt;type = new Name('EntityManagerInterface');

        // then we return original node
        return $node;
    }

    // ...
}</code></pre>
<p>We change a node and return the changed node. Let's move to level 2.</p>
<h2 id="2-Replacing-One-Node-by-Another">2. Replacing One Node by Another</h2>
<p>Let's say we want to upgrade to PHP 8 and use new <code>str_contains()</code> function:</p>
<pre><code class="language-diff">-Nette\Utils\Strings::contains($content, 'letter');
+str_contains($content, 'letter');</code></pre>
<p><br></p>
<p>Here we replace <code>StaticCall</code> node with <code>FuncCall</code>:</p>
<pre><code class="language-php">use PhpParser\Node\Expr\FuncCall;use PhpParser\Node\Expr\StaticCall;
use PhpParser\Node\Name;use Rector\Core\Rector\AbstractRector;

final class ReplaceStrContainsRector extends AbstractRector
{
    /**
     * @param StaticCall $node
     */
    public function refactor(Node $node)
    {
        // we'll use arguments from the original node
        $args = $node-&gt;args;

        // here we create a new func call node, with specific name and args
        $funcCallName = new Name('str_contains');

        return new FuncCall($funcCallName, $args);
    }

    // ...
}</code></pre>
<p>Are you still with me? Let's get to the most complex one.</p>
<p><br></p>
<h2 id="3-Replacing-Single-Node-by-Two-Nodes">3. Replacing Single Node by Two Nodes</h2>
<p>Let's say we have an extremely complex line where a lot of operations happens at once:</p>
<pre><code class="language-php">$result = 5 + 10;</code></pre>
<p>I'm a bit exaggerating here, but I believe <strong>any code should be easily readable</strong> even after 3 glasses of wine. How can we improve the code, so we understand the code even late in the night?</p>
<p>Let's separate one operation per line:</p>
<pre><code class="language-diff">-$result = 5 + 10;
+$input = 10;
+$result = 5 + $input;</code></pre>
<p>One line per one operation. Now we can easily see what is going on. How would such modification look like in a Rector rule?</p>
<pre><code class="language-php">use PhpParser\Node\Expr\Assign;
use PhpParser\Node\Expr\BinaryOp\Plus;
use PhpParser\Node\Expr\Variable;
use Rector\Core\Rector\AbstractRector;

final class RenameEntityManagerRector extends AbstractRector
{
    /**
     * @param Assign $node
     */
    public function refactor(Node $node)
    {
        /** @var Plus $plus */
        $plus = $node-&gt;expr;

        // stands for: 5
        $leftSideOfPlus = $plus-&gt;left;

        // stands for: 10
        $rightSideOfPlus = $plus-&gt;right;

        // stands for: "$result"
        $resultVariable = $node-&gt;var;

        // this will create "$input = 10;"
        $inputVariable = new Variable('input');
        $firstLine = new Assign($inputVariable, $rightSideOfPlus);

        // this will create "$result = 5 + $input;"
        $secondLine = new Assign($resultVariable, new Plus($leftSideOfPlus, $inputVariable));

        // magic happens here?
    }

    // ...
}</code></pre>
<p>What should we return in the <code>refactor()</code> method to change the original line and add one extra line?</p>
<p>I'll give you a hint: we always returned the content we wanted to change in previous examples.</p>
<p>So what do we return here? Again, the content we want to change:</p>
<pre><code class="language-php">use PhpParser\Node;

// ...

public function refactor(Node $node)
{
    // ...

    return [
        $firstLine,
        $secondLine
    ];
}</code></pre>
<p>Just instead of a single node, it's 2 nodes. How easy is that?</p>
<p>But in practice, this rule would not work. We need to respect the abstract syntax tree node traverser architecture of php-parser.
Don't worry. We're 2 steps away from success. But first, you need to understand one big difference...</p>
<h2 id="Statements-vs-Expressions">Statements vs. Expressions</h2>
<p>In php-parser, there are 2 kinds of nodes:</p>
<p><br></p>
<div class="row">
    <div class="col-md-6">
        <p>First extend <code>PhpParser\Node\Expr</code> class</p>
        <img src="/assets/images/posts/2021/replace_two_nodes_expr.png" class="img-thumbnail">
    </div>
    <div class="col-md-6">
        <p>Second extend <code>PhpParser\Node\Stmt</code> class</p>
        <img src="/assets/images/posts/2021/replace_two_nodes_stmt.png" class="img-thumbnail">
    </div>
</div>
<p><br></p>
<p>Look at the first picture and pick one node from there... e.g., <code>PhpParser\Node\Scalar\MagicConst\Dir</code>.
What is it?</p>
<pre><code class="language-php">__DIR__</code></pre>
<p>It's an expression that <strong>holds a value</strong>. <code>__DIR__</code> returns a <code>string</code> with an absolute path to the current directory.</p>
<p><br></p>
<p>Let's look at the second picture... what do we pick from there? E.g. <code>ClassMethod</code>. It's a method in a class, interface, or trait. It does not <strong>hold any value</strong>. It's part of a structure. A typical example is a constructor method:</p>
<pre><code class="language-php">public function __construct()
{
}</code></pre>
<p><br></p>
<h3 id="Expr"><strong><code>Expr</code></strong></h3>
<ul>
<li>holds a value</li>
<li>can be used as part of operation (<code>__DIR__ . '/Fixture'</code>)</li>
<li>can be nested in other expressions (<code>strlen(__DIR__ . '/Fixture') &gt; 10</code>)</li>
</ul>
<h3 id="Stmt"><strong><code>Stmt</code></strong></h3>
<ul>
<li>is part of code</li>
<li>it <em>just exists</em></li>
<li>is a structural element among other elements</li>
</ul>
<p>If you're still missing the difference, check other classes that implement <code>Expr</code> or <code>Stmt</code>. It will give you a better idea.</p>
<p><br></p>
<h2 id="The-Golden-Rule-of-Replacing-Nodes">The Golden Rule of Replacing Nodes</h2>
<p>Why do we even talk about this?
<strong>Because we can only replace one <code>Stmt</code> by multiple <code>Stmt</code></strong>.</p>
<p>Let's get back to our example:</p>
<pre><code class="language-diff">-$result = 5 + 10;
+$input = 10;
+$result = 5 + $input;</code></pre>
<p>We had an <code>Assign</code> on the input... what is this node extending?</p>
<pre><code class="language-php">namespace PhpParser\Node\Expr;

use PhpParser\Node\Expr;

class Assign extends Expr
{
    // ...
}</code></pre>
<p>It's an <code>Expr</code>, so we cannot replace it... we're screwed... or are we?</p>
<p>There is a neat trick to overcome this - every line that is not an <code>Stmt</code> is wrapped with an <code>Expression</code> node that is <code>Stmt</code>.</p>
<p>What does it mean?</p>
<pre><code class="language-php">// Assign (Expr)
$result = 5 + 10

// Expressions (Stmt)
$result = 5 + 10;</code></pre>
<p>Mind the missing <code>;</code> in the first line. With this trick, now we're able to update the original rule to make it work for us:</p>
<p><br></p>
<pre><code class="language-php">use PhpParser\Node\Stmt\Expression;
use PhpParser\Node\Expr\Assign;

/**
 * @param Expression $node
 */
public function refactor(Node $node)
{
    if (! $node-&gt;expr instanceof Assign) {
        return null;
    }

    $assign = $node-&gt;expr;

    // ... here the change is the same

    return [
        new Expression($firstLine),
        new Expression($secondLine)
    ];
}</code></pre>
<p>And that's it! Now we've replaced the <code>Assign</code> node with two different <code>Assing</code>s ✅ .</p>
<p><br></p>
<p><strong>Would you like to learn more about Rector internals like this and how to make it work for your project?</strong>
<a href="/trainings">Get a Rector training</a> where you'll learn practical tips and tricks in just 3 hours and save dozens of self-learning.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/how-to-replace-single-node-with-two-nodes-in-abstract-syntax-tree</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 28 Jun 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/how-to-replace-single-node-with-two-nodes-in-abstract-syntax-tree#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to make Upgrade Safe with Bridge Testing ]]></title>
                <link>https://tomasvotruba.com/blog/how-to-make-upgrade-safe-with-bridge-testing</link>
                <description><![CDATA[ <p>Upgrading can go smooth without no bugs and just work. We can make our customer happy, even though we don't have any tests.
<br>
<br>
<strong>The older I am, the more I care about safety</strong>. Not just for now, but for tomorrow and for my safety of my colleagues. Also for the developers, who will work on the project even though I'm long gone.
<br>
<br>
That's why before I start upgrading one approach to another, I want to prepare a safe environment. No razors, no matches, and a couple of tests. The bridge testing technique is one of the safety nets I use while refactoring to new technology.</p> ]]></description>
                <content:encoded><![CDATA[ <p>The idea is simple - in total, we should have 3 tests:</p>
<ul>
<li>test for current behavior - compare with exact output</li>
<li><em>add alternative feature</em></li>
<li>test new behavior - compare with exact output</li>
<li>test current and new behavior - compare both results together</li>
</ul>
<p><br></p>
<p>It will be more clear from an example. Let's say we use <code>@AttentionPrice</code> annotation to express the amount of attention we should spend while reading the code:</p>
<pre><code class="language-php">/**
 * @Annotation()
 */
class AttentionPrice
{
    private int $amount;

    public function __construct(array $values)
    {
        $this-&gt;amount = $values['amount'];
    }

    public function getAmount(): int
    {
        return $this-&gt;amount;
    }
}</code></pre>
<p>In our code, we'll use annotation to express required attention for specific elements:</p>
<pre><code class="language-php">final class DesignPattern
{
    /**
     * @AttentionPrice(1000)
     */
    public $publicProperty;

    /**
     * @AttentionPrice(100)
     */
    private $privateProperty;
}</code></pre>
<p>Here we can see that public property takes much more attention than private one. Public properties can be used in the class, outside the class, and changed anytime. On the other hand, private property can be used exclusively in this class.</p>
<h2 id="Bridge-Test">Bridge Test</h2>
<p>Let's add a bridge test so we are sure the refactoring works for both annotations and attributes. How would the bridge test look like for public property?</p>
<pre><code class="language-php">use PHPUnit\Framework\TestCase;

final class BridgeTest extends TestCase
{
    private Reader $reader;

    protected function setUp(): void
    {
        // create Reader instance or get it from container
        $this-&gt;reader = // ...;
    }

    public function testCurrent(): void
    {
        $resolvedValue = $this-&gt;reader-&gt;resolveAnnotationValue(
            'DesignPattern', 'publicProperty'
        );
        $this-&gt;assertSame($resolvedValue, 1000);
    }
}</code></pre>
<p>Let's run the test:</p>
<pre><code class="language-bash">vendor/bin/phpunit tests/BridgeTest.php</code></pre>
<p>It should pass - it only confirms already existing behavior.</p>
<p><br></p>
<p>Let's add a new method, <code>resolveAttributeValue()</code> that will be able to read PHP 8 attribute values too:</p>
<pre><code class="language-php">    // ...

    public function testNew(): void
    {
        $resolvedValue = $this-&gt;reader-&gt;resolveAttributeValue(
            'DesignPattern', 'publicProperty'
        );
        $this-&gt;assertSame($resolvedValue, 1000);
    }

    // ...</code></pre>
<p>Now the test should fail because we have yet to implement the <code>resolveAttributeValue()</code> method:</p>
<pre><code class="language-bash">vendor/bin/phpunit tests/BridgeTest.php</code></pre>
<p><br></p>
<p>Last but not least, the bridge test compares the results of both methods:</p>
<pre><code class="language-php">
    // ...

    public function testBridge(): void
    {
        $resolvedAnnotationValue = $this-&gt;reader-&gt;resolveAnnotationValue(
            'DesignPattern', 'publicProperty'
        );
        $resolvedAttributeValue = $this-&gt;reader-&gt;resolveAttributeValue(
            'DesignPattern', 'publicProperty'
        );

        $this-&gt;assertSame($resolvedAnnotationValue, $resolvedAttributeValue);
    }

    // ...</code></pre>
<h2 id="Why-Not-Just-The-Bridge-Test">Why Not Just The Bridge Test?</h2>
<p>Looking at the test, it seems the <code>testBridge()</code> already includes the test of their former two methods. Why not delete those two? ...
Wait, wouldn't that be like cutting our safety ropes?</p>
<img src="https://images.squarespace-cdn.com/content/v1/5a54afc2e9bfdf89573d7cf7/1551374451263-U7I7L1NLOJY6XWNL028T/ke17ZwdGBToddI8pDm48kJUlZr2Ql5GtSKWrQpjur5t7gQa3H78H3Y0txjaiv_0fDoOvxcdMmMKkDsyUqMSsMWxHk725yiiHCCLfrh8O1z5QPOohDIaIeljMHgDF5CVlOqpeNLcJ80NK65_fV7S1UfNdxJhjhuaNor070w_QAc94zjGLGXCa1tSmDVMXf8RUVhMJRmnnhuU1v2M8fLFyJw/Rope-Bridge-project-Salwa+Resort-Abu+Samra-Qatar-5.jpeg?format=500w" class="img-thumbnail">
<p><br></p>
<p>At first, the test passes, and both methods return <code>1000</code> and <code>assertSame()</code> works correctly.</p>
<pre><code class="language-php">$resolvedAnnotationValue = ...; // 1000
$resolvedAttributeValue = ...; // 1000
$this-&gt;assertSame($resolvedAnnotationValue, $resolvedAttributeValue);</code></pre>
<p><br></p>
<p>Later that day, we do a bit of refactoring. Let's run tests now:</p>
<pre><code class="language-bash">vendor/bin/phpunit tests/BridgeTest.php</code></pre>
<p>It still passes, yay!</p>
<p><br></p>
<p>A few weeks later, we find out the production annotations and attributes <strong>were ignored</strong>, your admin was publicly available, and the test passes with these values:</p>
<pre><code class="language-php">$this-&gt;assertSame(null, null);</code></pre>
<p>That's why it's essential to have two previous methods and compare exact values.
Now that we have safety rules defined let's start the dirty work!</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/how-to-make-upgrade-safe-with-bridge-testing</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 21 Jun 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/how-to-make-upgrade-safe-with-bridge-testing#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Doctrine Annotations and Attributes Living Together in Peace ]]></title>
                <link>https://tomasvotruba.com/blog/doctrine-annotations-and-attributes-living-together-in-peace</link>
                <description><![CDATA[ <p>In previous post <a href="/blog/how-to-refactor-custom-doctrine-annotations-to-attributes">How to Refactor Custom Doctrine Annotations to Attributes</a> we looked on how to make the <code>@annotation</code> to <code>#[Attribute]</code> transition.
<br><br>
Last week, we started refactoring in <a href="https://www.startupjobs.cz/startup/scrumworks-s-r-o">my favorite long-term project</a>, and we came to a challenging situation. When we started to move all annotations to attributes at once, we lost control over the results. It was also impossible because 3rd party annotations were not attributes ready.
<br><br>
We had to <strong>support annotations and attributes at the same time</strong>. Do you have plenty of custom annotations yourself? In this post, you'll learn to build a bridge with both annotations and attributes on board.</p> ]]></description>
                <content:encoded><![CDATA[ <blockquote class="blockquote text-center">
    "United we stand,<br>
    Divided we fall"
</blockquote>
<h2 id="Safety-First">Safety First</h2>
<p>Before we start, we'll make sure we have <a href="/blog/2020/01/13/why-is-first-instant-feedback-crucial-to-developers">instant feedback</a> about code. We'll prepare a special kind of test designed for refactoring, where we need 2 mechanism to work at once - <a href="/blog/how-to-make-upgrade-safe-with-bridge-testing">a bridge testing</a>. In linked post we'll build a test that we use here, so if you're coding with me, be sure to read it first.</p>
<h2 id="Teaching-Annotation-Attributes">Teaching Annotation Attributes</h2>
<p>We already know the first steps <a href="/blog/how-to-refactor-custom-doctrine-annotations-to-attributes">from previous post</a> - add <code>#[Attribute]</code>:</p>
<pre><code class="language-php">/**
 * @Annotation()
 */
#[Attribute]
class AttentionPrice
{
    // ...

    public function __construct(array $values)
    {
        $this-&gt;amount = $values['amount'];
    }

    // ...
}</code></pre>
<p>The problem is that annotation requires an array in the constructor - <code>array $values</code>.
But attributes accept specific value:</p>
<pre><code class="language-php">    /**
     * @AttentionPrice(1000) // array with int
     */
    #[AttentionPrice(1000)] // int
    public $publicProperty;</code></pre>
<p><br></p>
<p>What can we do about different construction needs?</p>
<h3 id="2-Different-Classes">2 Different Classes?</h3>
<p>An annotation class with <code>array</code> contract:</p>
<pre><code class="language-php">/**
 * @Annotation()
 */
class AttentionPrice
{
    public function __construct(array $values)
    {
        // ...
    }
}</code></pre>
<p>And an attribute class with <code>int</code> contract:</p>
<pre><code class="language-php">#[Attribute]
class AttentionPrice
{
    public function __construct(int $amount)
    {
        // ...
    }
}</code></pre>
<h3 id="2-Constructors">2 Constructors?</h3>
<pre><code class="language-php">    public function __construct($values)
    {
        // annotatoin
        if (is_array($values)) {
            $this-&gt;amount = $values['amount'];
        // attribute
        } elseif (is_int($values)) {
            $this-&gt;amount = $values;
        } else {
            // exception
        }
    }</code></pre>
<p><br></p>
<p>Try both options, and you'll soon see that <strong>they both smell</strong>:</p>
<ul>
<li>First is nice and clean but gives you extra work with duplicated classes ❌</li>
<li>Second is a headache to write and read. A that's only one value, imagine there are 2 or 3 values ❌</li>
</ul>
<p>Hmm, what can we do now?</p>
<p><br></p>
<h2 id="at-NamedArgumentConstructor-to-the-Rescue"><code>@NamedArgumentConstructor</code> to the Rescue</h2>
<p>We're lucky, <code>doctrine/annotations</code> got us covered since <code>1.12</code>. I've learned this trick from <a href="https://github.com/koriym/Koriym.Attributes">Koriym</a> - thanks!</p>
<pre><code class="language-diff">+use Doctrine\Common\Annotations\NamedArgumentConstructor;

 /**
  * @Annotation()
+ * @NamedArgumentConstructor()
  */
+#[Attribute]
 class AttentionPrice
 {
     private int $amount;

-    public function __construct(array $values)
+    public function __construct(int $amount)
     {
         $this-&gt;amount = $amount;
     }

     // ...
 }</code></pre>
<p>Thanks to the <code>@NamedArgumentConstructor</code>, the constructors are now the same for both annotation and attribute ✅</p>
<p><br></p>
<p>Big thanks to Alexander M. Turek, who <a href="https://github.com/doctrine/annotations/pull/391">contributed this feature</a> for <code>doctrine/annotations</code> and Vincent who added support for <a href="https://github.com/doctrine/annotations/pull/402">default value</a> unwrap.</p>
<p><br></p>
<p>Now we can use both annotation and attributes in our code with the same result:</p>
<pre><code class="language-php">    /**
     * @AttentionPrice(1000) // int
     */
    #[AttentionPrice(1000)] // int
    public $publicProperty;
</code></pre>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/doctrine-annotations-and-attributes-living-together-in-peace</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 14 Jun 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/doctrine-annotations-and-attributes-living-together-in-peace#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Why Should We Talk about Our Mistakes in PHP Community? ]]></title>
                <link>https://tomasvotruba.com/blog/why-should-we-talk-about-our-mitakes-in-php-community</link>
                <description><![CDATA[ <p>Sometimes we fell in love with technology or a tool. We see only the best in it, and we want everyone to know it. We're spreading the love on a wave of serotonin. We're spreading the knowledge and helping others.
<br><br>
As we grow and learn, we realize the path we took is not as epic as we thought. We change a direction and pick a better alternative. That's how we learn in everyday life, and it's only natural.
<br><br>
But what if we promote technology in a post, and that post is still out there? Readers learn from it and follow the path, even though we know it's two years old and a blind road to station frustration. What then?</p> ]]></description>
                <content:encoded><![CDATA[ <blockquote class="blockquote text-center">
    "Change a mind and you'll change a world."
</blockquote>
<h2 id="Long-Tail-Effect">Long Tail Effect</h2>
<p>You know this from everyday life. We google for an answer on a technical problem and find an answer on Stackoverflow. We go through it - yes, it's the same problem we have - deprecation notice in PHP 7.3 for a function that will be removed from PHP. The first answer is accepted and has 270 votes. The second one has only 20. Let's go for the first one.</p>
<p>Little do we know, the following answer is from 2021 and 1 week old. The first answer is from 2015. Which one do you think was right? It depends on <em>when</em> you read it.</p>
<p>This is a problem long-tail effect. <strong>We tend to repeat old solutions because we know them for a long time, and they must be correct</strong>. Voting algorithms also promote them (human-based in &quot;like&quot; systems or by inner rating, e.g., Google search).</p>
<p>But these sources <strong>might be misleading</strong>. I mean - what would you use to deliver a message to your loved one: a post office that's been 300 years in your city or that 3-years old app on your phone you know she uses?</p>
<h2 id="PHP-Influencers">PHP Influencers</h2>
<p>We've been writing a book with Matthias Noback (<a href="/blog/rector-the-power-of-automated-refactoring-book-released">it's here</a> if you're interested, but that's not what this post is about) for the past 7 months. It was an inventive way to chat with him weekly and have back and forth discussions about PHP and our role in it. Not in a way how to spread &quot;our wisdom&quot; to more places, but how we're responsible for shaping the PHP community.</p>
<p>In one topic we talked about how we're responsible for what we write about. If we say something is a best practise, many long-time readers might follow the rule without much critical thinking.</p>
<blockquote class="blockquote text-center">
    "Promote best practice when you believe in them,<br>
    but own your shit if you were wrong."
</blockquote>
<p>It's hard to say &quot;I'm sorry, I was wrong&quot; in personal life, even in the online world, where everyone is watching for your mistakes. Elon Musk is a very fitting example from recent weeks. He promoted using Bitcoin to use as a payment credit. Then he concluded that it's not the way he wants to go. Not just personally, but in a community around him.  You already know how people reacted to this statements and how strong such statement is.</p>
<h2 id="I-m-Right-Today-I-can-be-Wrong-Tomorrow">I'm Right Today, I can be Wrong Tomorrow</h2>
<p>As a part of the community, I used to follow <em>the-framework-I-was-using</em> as a primary source of the best practice. Its in-group effect was powerful, even for approaches that the community leaders didn't promote anymore.</p>
<p>You might not be Elon Musk, with two world-known companies and a vast community circle around you &ndash; I know I'm not &ndash; but your voice still matters to your close ones. To the users of your open-source package, to your post readers, to people who follow you on Twitter. It's not relevant if it's 1 person, 10, or a thousand. That's just a scale. <strong>What matters is the behavior we spread among the people around us</strong>.</p>
<p>If I wrote a book about static locators in 2010 and figured that the last few companies I used them in went bankrupt, I would feel terrible and not use them personally anymore. I might tell it to a friend in 2021 as a joke from my past.</p>
<h2 id="No-Response-No-Responsibility">No Response? No Responsibility</h2>
<p>What change would happen in the world? How would the book readers who are still using the pattern see it? They would probably still think static locators are great because they've read the book and saw so many great examples I proposed.</p>
<p>That is the coward in me hiding in the corner. I know I would have to act. I don't mean we have to write a book with an inverted title and opposite ideas. But some <strong>public response is needed</strong> - whether a talk, a post, or a public interview.</p>
<h2 id="How-do-I-Handle-Past-Mistakes-in-My-Posts">How do I Handle Past Mistakes in My Posts?</h2>
<p>When I realized I'm part of the problem, I wanted to act in way I would love to see in Google. <strong>Explain right in the article</strong> that this approach is wrong and should not be used.</p>
<p><br></p>
<p>That's why the mistaken post is cleared marked with red color:</p>
<p><a href="/blog/2018/11/05/do-you-autowire-services-in-symfony-you-can-autowire-parameters-too/"></p>
<img src="https://user-images.githubusercontent.com/924196/121019390-ac565a80-c79f-11eb-8b52-dd80fbd78c15.png" class="img-thumbnail mb-4">
<p></a></p>
<p>There is also &quot;why&quot; above the post:</p>
<p><a href="/blog/2018/11/05/do-you-autowire-services-in-symfony-you-can-autowire-parameters-too/"></p>
<img src="https://user-images.githubusercontent.com/924196/121019604-e1fb4380-c79f-11eb-95ec-3ca5a77b8598.png" class="img-thumbnail">
<p></a></p>
<h2 id="Learning-From-Mistakes">Learning From Mistakes</h2>
<p>If we write a website project and it works without any mistake, we didn't learn anything new. We only repeated the knowledge we already had to achieve a goal. A mistake is not doing something the wrong way and being ashamed. <strong>It's a delta between what we knew at the start and what we know now</strong>. &quot;Wow, that was a huge mistake&quot; = &quot;he learned a lot by doing that.&quot;</p>
<blockquote class="blockquote text-center">
"In order to succeed, you must fail,<br>
so that you know what not to do the next time."
</blockquote>
<p>That's why making mistakes is so important. Reading other people's mistakes is an excellent source of knowledge. I would love to travel around the world and the PHP community one day. Let's say I meet a woman who's traveled around the world in the past 6 months. She has an hour to have coffee with me. What is a better use of my time for my future trip?</p>
<ul>
<li>&quot;What were the best five cities you've visited?&quot;</li>
<li>&quot;What were the worst five events that happened to you?&quot;</li>
</ul>
<h2 id="From-Inspiration-to-Action">From Inspiration to Action</h2>
<p>Writing these lines, I recall a post from Martin Michalek - co-founder of Czech front-end community - <a href="https://www.vzhurudolu.cz/blog/100-2016-podelal">What I fucked up in 2016?</a>  It was a huge source of inspiration, Martin being honest about finances, writing a book, and personal risks. Hats off to him. In my next post, I'll write about a couple of mines.</p>
<p>Last but not least, have you heard of <a href="https://www.fuckupnights.cz/">Fuck Up Nights</a>? Every month 5 speakers share their worst in life. I've visited a couple of them, and they're a profound source of knowledge and laughter.</p>
<p><br></p>
<p>To sum up, it's important to share our success and happy days. We'll fail, we'll make mistakes, and that's ok. That's how we learn. Sharing these experiences with each other in an honest way is how we help each other grow and be stronger as a community.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/why-should-we-talk-about-our-mitakes-in-php-community</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 07 Jun 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/why-should-we-talk-about-our-mitakes-in-php-community#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How I Redesigned my Website the Way I Refactor Legacy Projects ]]></title>
                <link>https://tomasvotruba.com/blog/how-i-redesigned-my-website-the-way-i-refactor-legacy-projects</link>
                <description><![CDATA[ <p>I have wanted to redesign my website since Autumn 2020. I felt it's overly detailed with attention shotgun feeling. Because of intensive &amp;&amp; extensive work on Rector to make it better, I could not get to it on the book with Matthias and writing posts. With no deadline, there is no rush, right?
<br>
<br>
I had to hack around my brain to make it happen. It would be a shame to release Rector book on the old design, so I took <a href="/blog/rector-the-power-of-automated-refactoring-book-released/">the book release</a> as a co-task.
<br>
<br>
The first hour I struggled with the redesign approach, I realized I could use the skill I use daily - refactoring legacy.</p> ]]></description>
                <content:encoded><![CDATA[ <blockquote class="blockquote">
    "Perfection is achieved, not when there is nothing more to add,<br>
    but when there is nothing left to take away."
    <footer class="blockquote-footer text-right">Antoine de Saint-Exupery</footer>
</blockquote>
<p><em>This redesign was inspired by Little Prince, <a href="https://sensible.com/">Don't Make me Think</a>, <a href="/blog/2017/09/25/3-non-it-books-that-help-you-to-become-better-programmer/#steal-like-and-artist-by-austing-kleon">Steal Like an Artist</a> and <a href="https://austinkleon.com/show-your-work/">Show Your Work</a>.</em></p>
<p><br></p>
<p>What do designer and legacy cleaner have in common? The final product must work, be intuitive and bring value to the user. I realized the old design had many spaces to improve, and a lot of <del>code</del> text and &quot;cool features&quot; should be removed.</p>
<p>When we <a href="https://getrector.org/for-companies">get a project to refactor</a> in Rector company, the first 1-2 months we don't do any PHP or framework upgrades at all. We focus on preparing the environment, remove everything that is not needed for developers and business to grow. At first, it looks like we come to destroy the project by removing 30 % of it. But in the end, after solid and reliable code remains, we can move unbelievably fast with upgrades and pattern refactoring.</p>
<h2 id="Deprecating-Clusters-Use-Words-People-Understand">Deprecating Clusters - Use Words People Understand</h2>
<p>3 years ago I wanted to write a little book about a single topic. I was too scared, so I created a new work instead.
A word that is not for a book, not for a post. It's a collection of post on single topic - <a href="/blog/2018/07/02/cluster-more-interactive-than-book-deeper-than-post/">clusters</a>. There was a section &quot;Clusters&quot; in the menu for the last 3 years, and it contained eight groups of posts. The initial feedback was confusion. I was confused, too. It was time to <a href="/blog/2020/03/09/art-of-letting-go/">let go</a> old fears and remove this section. <strong>Either write a book or a post.</strong></p>
<h2 id="Occams-Razor">Occams' Razor</h2>
<p>I use this idea or rather technique during refactoring legacy projects a lot. If some external tool handles something better than our custom code, remove the custom code and delegate it to an external tool. We'll save ourselves from testing our code, maintaining it, and teaching it to every new programmer.</p>
<p>One example from a project I was mentoring just yesterday: a custom autoload that finds all <code>autoload.php</code> files across the root directory and manually includes them. It was around 200 lines of magic (at least at first sight). We remove this part and used composer instead. Now it's 5 lines and code is <a href="/blog/how-exception-to-the-convention-does-more-harm-than-good/">standardized</a>. We will never have to think about autoloading again.</p>
<h2 id="2600-Lines-Removed">2600 Lines Removed</h2>
<img src="/assets/images/posts/2021/redesign_simple.png" class="img-thumbnail mb-5">
<p>How did I apply Occams' razor to redesign my website?</p>
<ul>
<li>Google Search - there were two searches on the homepage, both with dummy website search - Could Google with &quot;last year&quot; filters beat this? Do people go to my website and only then google there? No, they just google instantly from the browser's URL field
<br>→ <strong>Remove Google search and let people use Google instead</strong></li>
</ul>
<p><br></p>
<ul>
<li>Cleaning Lady List - the <a href="/blog/2020/07/06/cleaning-lady-notes-from-class-mess-to-psr4-step-by-step-with-confidence/">cleaning lady list</a> was similar to <em>clusters</em>, just little side project with check-list of refactoring legacy. Thank you, <a href="https://github.com/Kerrialn">Kerrial</a>, for working on it and pushing it further. I didn't maintain it, nor used it myself, because every legacy project has its special problems
<br>→ <strong>Remove Cleaning Lady list and focus on content</strong></li>
</ul>
<p><br></p>
<ul>
<li>Blog, archive, clusters... - there were at least three places to find posts. Why?
<br>→ <strong>Keep it simple on a &quot;blog&quot; page.</strong></li>
</ul>
<p><br></p>
<ul>
<li>Tested posts - 2 years ago, I wrote a post about how <a href="/blog/2019/09/16/why-software-articles-must-be-ci-tested/">posts should be tested in CI</a>, so the content is easy to upgrade. In reality, this lead to 2 actions - first, I put a lot of work into making sure the content is tested, so the content itself was a bit neglected. Second, I was discouraged from creating tests for a new post because it was too much work. In the end, there were about 20 tested posts, so the coverage was inferior and not useful. Let's save this for a book
<br>→  <strong>Tests for articles are removed</strong></li>
</ul>
<p><br></p>
<p>In the end, there are now fewer sections, less nesting, and more focus on content. You can read posts or get training. Simple. What changed in design?</p>
<p><br></p>
<h2 id="Design-With-Focus-on-Content">Design With Focus on Content</h2>
<img src="https://user-images.githubusercontent.com/924196/120992700-23c9c100-c783-11eb-8d57-e20f898b21c0.jpg" class="img-thumbnail mt-2 mb-4" style="max-width: 20em">
<p>What if we apply the refactoring legacy approach to the website design itself?</p>
<ul>
<li>Do we need 1609 Font Awesome icons for the content? I've checked the content, and 95 % of them are ✅ and ❌ emojis
<br>→<strong>Drop Font Awesome</strong></li>
</ul>
<p><br></p>
<ul>
<li>Do we need a special menu for mobile and website with fluid, responsible design (that often breaks on various platforms)? We need links that work for people - click and work.
<br>→<strong>Remove ul/li/nav/navbar/navbar-content mobile/laptop menu matrix and use simple a links instead</strong>.</li>
</ul>
<p><br></p>
<ul>
<li>Do we need three font styles for titles? With bold, thin, size, margin, padding differences?
<br><strong>→Use one font and different by size.</strong></li>
</ul>
<p><br></p>
<ul>
<li>Do we need jQuery? No.
<br><strong>→Drop it.</strong></li>
</ul>
<p><br></p>
<h2 id="Website-is-Dead-Long-Live-the-Website">Website is Dead, Long Live the Website</h2>
<p>And the results? Simple, airy, with no clutter and content that is a joy to read on a laptop or in the tram.</p>
<p><br></p>
<div class="row text-center">
    <div class="col-12 col-sm-6">
        <img src="/assets/images/posts/2021/my_website_2020.png" class="img-thumbnail rounded">
        2016–2020
    </div>
    <div class="col-12 col-sm-6">
        <img src="/assets/images/posts/2021/my_website_2021.png" class="img-thumbnail rounded">
        2021–?
    </div>
</div>
<p><br></p>
<h2 id="Show-Updated-and-Deprecated-Posts">Show Updated and Deprecated Posts</h2>
<p>Did you know some posts get updated? Other posts are no longer valid and are deprecated to avoid spreading lousy practice as a way to go.</p>
<div class="row text-center">
    <div class="col-12 col-sm-6">
        <img src="/assets/images/posts/2021/post_updated.png" class="img-thumbnail rounded">
        Updated post
    </div>
    <div class="col-12 col-sm-6">
        <img src="/assets/images/posts/2021/post_removed.png" class="img-thumbnail rounded">
        Deprecated post
    </div>
</div>
<p><br></p>
<p>I'll write about reflection on past mistakes in one of my future posts.</p>
<p><br></p>
<h2 id="10-months-of-Preparation-2-Days-at-Coffee-House">10 months of Preparation, 2 Days at Coffee House</h2>
<p>Do you know the 80/20 rule? 20 % of a project takes 80 % of the time to finish. It's not true.</p>
<p>I'm not sure if the stars were right, if I accidentally took some deep-focus drugs or if that was the right thing to do. I went to a coffee house in Tenerife at 10 AM. I'm thinking... what should I do today? I worked on a work project refactoring yesterday; Rector is running and released, and I already published a post for the week. Mmm, maybe I'll check what I can do on the website design.</p>
<p>I turned off my phone, opened my laptop, got a cortado (it's like flat white for Spanish), and started working.</p>
<img src="https://user-images.githubusercontent.com/924196/120992704-24625780-c783-11eb-827e-c3f110c2af36.jpg" class="img-thumbnail mt-4 mb-4">
<p>Three hours later, I was tired, my battery was almost 0 %, and my table didn't have the electrical plug. The table next to me got it, but one family occupied it. Suddenly, when I was about to leave, they stood up and went to the counter. I thought... ok, I'll charge my laptop for 20 mins first. Suddenly it's 4 PM, and I'm leaving the coffee house with <strong>half of the website redesign done</strong>. Most importantly, with a clear vision of what to do next and how the website will look.</p>
<p>Don't you believe me? See <a href="https://github.com/TomasVotruba/tomasvotruba.com/pull/1200">the pull-request</a>.</p>
<p>Do you ever have moments like this? I guess it was the right time and right place to do the right thing :)</p>
<p>How do you like it? Let me know and stay safe.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/how-i-redesigned-my-website-the-way-i-refactor-legacy-projects</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 03 Jun 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/how-i-redesigned-my-website-the-way-i-refactor-legacy-projects#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Refactor Custom Doctrine Annotations to Attributes ]]></title>
                <link>https://tomasvotruba.com/blog/how-to-refactor-custom-doctrine-annotations-to-attributes</link>
                <description><![CDATA[ <p>PHP 8 came with <a href="https://php.watch/versions/8.0/attributes">attributes</a> 7 months ago. Symfony 5.2 now supports <code>#[Symfony\Component\Routing\Annotation\Route]</code> attribute, Nette 3.1 has <code>#[Nette\DI\Attributes\Inject]</code> attribute and Doctrine ORM 2.9 is now released with <code>#[Doctrine\ORM\Mapping\Entity]</code> attributes.
<br>
<br>
You're probably already using those <a href="https://github.com/rectorphp/rector/blob/main/docs/rector_rules_overview.md#annotationtoattributerector">thanks to Rector</a>. That was the easy part. The more challenging part is <strong>custom <code>@annotation</code> classes</strong>. Last weekend I refactored a couple of those, and this is what I found out.</p> ]]></description>
                <content:encoded><![CDATA[ <p><strong>tl;dr;</strong> Do you want to get the job done? Use <a href="https://github.com/rectorphp/rector/blob/main/docs/rector_rules_overview.md#doctrineannotationclasstoattributerector"><code>DoctrineAnnotationClassToAttributeRector</code></a>. Do you want to understand the step-by-step process of refactoring? Read on.</p>
<h2 id="Open-Source-vs-Private-Project">Open Source vs. Private Project</h2>
<p>Is your project open-source?</p>
<pre><code class="language-diff">-/**
- * @Annotation
- */
+#[Attribute]
 class SomeAnnotation
 {
 }</code></pre>
<p><code>composer update</code> downloads a new version of some package, and suddenly, <code>@annotations</code> are not working anymore. What the heck?</p>
<p>It's good to practice to <strong>keep a BC layer for open-source packages</strong> - only add new <code>#[Attribute]</code> metadata and keep the old annotations there too:</p>
<pre><code class="language-diff"> /**
  * @Annotation
  */
+#[Attribute]
 class SomeAnnotation
 {
 }</code></pre>
<p>Is your project private, and you're the only one using it? Remove the annotations without doubts.</p>
<h2 id="Update-Targets">Update Targets</h2>
<p>The Doctrine provides a <code>@Target</code> annotation that specifies where the annotation should be used. That avoids miss-use like this:</p>
<pre><code class="language-php">use Nette\DI\Attributes\Inject;

#[Inject]
class SomePresenter
{
}</code></pre>
<p>The alternative in PHP 8 attribute is <code>Attribute</code> argument:</p>
<pre><code class="language-diff">-use Doctrine\Common\Annotations\Annotation\Target;
+use Attribute;

-/**
- * @Annotation
- * @Target({"METHOD"})
- */
+#[Attribute(Attribute::TARGET_METHOD)]
 class SomeAnnotation
 {
 }</code></pre>
<p>Autocomplete will guide you to pick the right one.</p>
<h2 id="Define-Contract-in-Attribute-Constructor">Define Contract in Attribute Constructor</h2>
<p>In the past, the contract for annotation classes was very weak:</p>
<pre><code class="language-php">public function __construct($options = null)
{
}</code></pre>
<p>Could you guess what is the class above? The main abstract class for <a href="https://github.com/symfony/symfony/blob/9ccd0ad387f0aacf2a1f5673fdcf31dbbef22e35/src/Symfony/Component/Validator/Constraint.php#L108">Symfony Validation annotations</a>.</p>
<p>With refactoring attributes, we have a chance to rethink the weak contract of annotations:</p>
<pre><code class="language-php">/**
 * @Annotation
 */
final class Validation
{
    public function __construct(array $values)
    {
        if (isset($values['validatorClass'])) {
            // ..
        }
    }
}
</code></pre>
<p>Let's not think of a custom attribute as a wobbly docblock string, but as <strong>a strict value object</strong>. Required values must be provided:</p>
<pre><code class="language-php">#[Attribute]
final class Validation
{
    public function __construct(
        private string $validatorClass,
        private array $parameters = []
    ) {
    }
}</code></pre>
<p>You can see that each value is a separated argument instead of one enormous array. This will also help with the following step.</p>
<h2 id="Make-use-of-Named-Arguments">Make use of Named Arguments</h2>
<p>Ok, we already have upgraded all custom annotation classes to attribute ones. Now it's time to update the usage in our code:</p>
<pre><code class="language-diff">-/**
- * @Validation(RangeBoundariesValidator::class, ['key' =&gt; 'value'])
- */
+#[Validation(RangeBoundariesValidator::class)]</code></pre>
<p>As you can see, the syntax is very similar. In the first case, it's an <code>array</code> that can be anything. But in the second case, it's a value object. But what exactly is first and second value for? Without looking into the value object, we cannot know know... or can we?</p>
<pre><code class="language-php">#[Validation(validatorClass: RangeBoundariesValidator::class, parameters: ['key' =&gt; 'value'])]</code></pre>
<p>Thanks to <a href="https://php.watch/versions/8.0/named-parameters">named argument</a>, we can. There is also <a href="https://github.com/symplify/phpstan-rules/blob/main/docs/rules_overview.md#requireattributenamerule">a PHPStan rule</a> to help with this in code-reviews.</p>
<p>Another advantage of named arguments is that we can click on the name and right to the typed promoted property:</p>
<pre><code class="language-php">#[Validation(validatorClass: RangeBoundariesValidator::class)]</code></pre>
<h2 id="Refactor-Annotation-Reader-to-Native-Attributes">Refactor Annotation Reader to Native Attributes</h2>
<p>Last but not least, we have to upgrade our annotation reader that does not understand attributes yet. In the past, the only way to read custom annotations was to use a combination of reflection and Doctrine annotation reader:</p>
<pre><code class="language-php">use Doctrine\Common\Annotations\Reader;

class SomeClass
{
    public function __construct(
        private Reader $reader,
    ) {
    }

    public function resolve(ReflectionClass $reflectionClass): array
    {
        return $this-&gt;reader-&gt;getClassAnnotations($reflectionClass);
    }
}</code></pre>
<p>That requires pulling the <code>doctrine/annotations</code> package, proper configuration, and a deeper understanding of the package. With PHP 8 attributes, this technology becomes more accessible to the broader community.</p>
<p>We can use bare PHP reflection - and we can also add the <code>@return</code> type as a bonus:</p>
<pre><code class="language-diff">- use Doctrine\Common\Annotations\Reader;

 class SomeClass
 {
-    public function __construct(
-        private Reader $reader,
-    ) {
-    }

+    /**
+     * @return Validation[]
+     */
     public function resolve(ReflectionClass $reflectionClass): array
     {
-        return $this-&gt;reader-&gt;getClassAnnotations($reflectionClass);
+        return $reflectionClass-&gt;getAttributes(Validation::class, ReflectionAttribute::IS_INSTANCEOF);
     }
 }</code></pre>
<h2 id="Remove-Annotation-Dependency">Remove Annotation Dependency</h2>
<p>One last step, and we'll be running 100 % pure PHP 8 attributes:</p>
<pre><code class="language-bash">composer remove doctrine/annotation</code></pre>
<p>That's it!</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/how-to-refactor-custom-doctrine-annotations-to-attributes</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 31 May 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/how-to-refactor-custom-doctrine-annotations-to-attributes#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How Exception to the Convention Does More Harm than Good ]]></title>
                <link>https://tomasvotruba.com/blog/how-exception-to-the-convention-does-more-harm-than-good</link>
                <description><![CDATA[ <p>We have a project, and to make it easier, we use specific standards. E.g., we use spaces in every file.
<br><br>
But sometimes, we get to a situation when these standards are stressful. We don't understand them and just want them to bend over. How does our short-term need for pleasure affects <strong>long-term well-being</strong> of the project?</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Hit-by-a-Car-on-Zebra-Crossing">Hit by a Car on Zebra Crossing</h2>
<p>I will tell you a true story from 6 years ago. We went by a street, it was green light, and we were crossing. She holds my hand firmly. So intensely it hurts. It was an extreme force from a very soft girl who was 2/3 of my weight:</p>
<ul>
<li>&quot;Ouch. What's going on?&quot; I asked her.</li>
<li>&quot;I have this bad feeling around cars now.&quot;</li>
<li>&quot;Why? We're safe on the zebra crossing, and there is a green light. The cars are stopped and waiting for us.&quot;</li>
<li>&quot;That might be the case now, but I got hit by a car in the very exact situation. I flew 2 meters through the air.&quot;</li>
</ul>
<p>She had this reaction on every zebra crossing, crossing, or near any moving car for next 6 months.</p>
<p>That one exception to the rule didn't mean much for the driver. They probably didn't even notice. But it meant a lot for my girlfriend's life. So much, I felt real pain in the bones of my hand many months later after she had this experience.</p>
<h2 id="Zebra-Crossing-with-0-People-and-Green-Light-Safe">Zebra-Crossing with 0 People and Green Light... Safe?</h2>
<p><strong>Fast forward to yesterday</strong>. I'm thinking about this post, what should be the story to bridge the experience of real-life and coding.</p>
<p>I'm looking at a street with two roads. There is a zebra crossing with a green light on the left side of one road. It's pretty safe, just 4 meters long. Cars have a red light, and they can go only from one direction across this sidewalk. We would hardly look for a safer place to use to cross that street.</p>
<p>Well, unless we add a just minor exception. There was a car going ~40 km/h from one of the roads on the right side, opposite the direction that cars can go through the sidewalk. Wait for it. The car is turning left and crossing the sidewalk that has a green light on it. Very smoothly, with elegance and 40 km/h.</p>
<p>Car crossing a zebra crossing that has a green light is not that rare common. No people were crossing it anyway, right? Well, that can be the safe exception, but the car is <strong>going contra the one-direction road</strong>.  In a fraction of a second, the car is going through the zebra-crossing and riding further. There is another car in the one-direction road going against it.</p>
<p>This story might have some real-life consequences. Fortunately, The car in the right direction is going exceptionally slowly. It has time to slow down and avoid a front-to-front collision at ~60 km/h speed.</p>
<p>Single one exception.</p>
<h2 id="Exceptions-in-Coding">Exceptions in Coding</h2>
<p>We know people are dying on the streets because of &quot;just-one-time&quot; exceptions. How is that related to our coding?</p>
<p>In the whole project, we use PHPStan, ECS, and Rector to watch our standards. We have the same standard on <code>/tests</code> directory. We work on a new feature, and it's almost finished. Just PHPStan keeps failing... why? Why should we have standards on tests? It's bothering us for 10 minutes already. The stress level is so high...  how can we solve it? We decide to ignore them.</p>
<p>We get on a review and get a question about the ignored directory. We convince the reviewer &quot;it's just three files&quot; and &quot;it's not production code anyway&quot;.</p>
<h2 id="Two-Makes-a-Crowd">Two Makes a Crowd</h2>
<p>Soon the same colleague who made our code-review is contributing her PR. She comes to a similar situation when five files show some errors she does not understand. Using our trick, she ignores her files from ECS and Rector.</p>
<p>A few weeks later, this approach is spreading from PR to PR. Now almost half of the tests are excluded from standards, and our CTO looks at the project. He has an idea: &quot;It's a mess; we should standardize this. Why not ignore all the tests?&quot;</p>
<p>Now, all your tests and test fixtures have no requirements for standards at all. There is no need for autoloading, so we can finally drop the <code>psr-4</code> standard and move to <code>classmap</code> to autoload classes we need. So much freedom feels great. In case you're interested in psychology, this effect is called <a href="https://blog.codinghorror.com/the-broken-window-theory/">broken window theory</a> (written by Stackoverflow co-founder).</p>
<h2 id="Instant-Gratification">Instant Gratification</h2>
<p>We're happy now. We have a lot of freedom, and we can create code faster without arguing with some CI tools about it. But what about developers who will come to the project when we're long gone?</p>
<blockquote class="blockquote blockquote-smaller text-center">
If we make an exception in real life and nothing bad happens,<br>
life goes on, and nobody notices it.
<br>
<br>
If we make an exception in the code and nothing bad happens at the moment,<br>
it's forever encoded in the code. Lurking.
</blockquote>
<h2 id="2-and-quot-Standard-and-quot-Options-200-Cognitive-Load">2 &quot;Standard&quot; Options? 200 % Cognitive Load</h2>
<p>Every such exception to the standard is a major distraction for the person just learning the project. They don't know that the code their work on is the only exception to a well-designed standard. They see it as two equally strong options:</p>
<img src="https://user-images.githubusercontent.com/924196/120189092-338f5580-c217-11eb-86f4-2022102c3f7a.jpg" class="img-thumbnail">
<p>The project we looked at above is not a fiction I made up. It's typical project for <a href="/blog/2019/12/16/8-steps-you-can-make-before-huge-upgrade-to-make-it-faster-cheaper-and-more-stable/">legacy reconstruction</a>. It's not old PHP, not old Symfony, nor missing constructor injection. It's an infinite split of exceptions and edge cases.</p>
<p>We don't need senior developers, we need <a href="/blog/2020/03/02/we-do-not-need-senior-developers-we-need-senior-code-bases/">senior code bases</a>. Code bases that <strong>are easy to understand to junior developers who just got on board</strong>. These projects are sustainable, easy to modify, and cheap to maintain.</p>
<p>Next time you'll be frustrated and tempted to exclude just this one file. <strong>For a moment, take a pause and a deep breath.</strong></p>
<p>What future will you shape for your project? Safe and stable to walk or possibly hit by a car?</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/how-exception-to-the-convention-does-more-harm-than-good</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 24 May 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/how-exception-to-the-convention-does-more-harm-than-good#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Rector - The Power of Automated Refactoring Book Released ]]></title>
                <link>https://tomasvotruba.com/blog/rector-the-power-of-automated-refactoring-book-released</link>
                <description><![CDATA[ <p>In October 2020, we had a short call about Rector with <a href="https://matthiasnoback.nl/">Matthias Noback</a>. He asked insightful questions to the bone of the Rector workflow, and we also had great fun chatting. Soon we started to talk more and more and decided to write a book about Rector together. With 2&nbsp;points of view - <strong>the user and the maintainer</strong>.
<br><br>
It's been an adventurous journey for the past seven months, and today, we're proud to launch the first release of this book.</p> ]]></description>
                <content:encoded><![CDATA[ <div class="float-right text-center">
    <a href="https://leanpub.com/rector-the-power-of-automated-refactoring" target="blank">
        <img src="https://getrector.org/assets/images/logo/logo_bigger/rector_book.png" style="max-width: 15em; padding: .5em;margin:0 0 .5em 1em" class="shadow" alt="Rector book cover">
    </a>

    <br>

    <a href="https://leanpub.com/rector-the-power-of-automated-refactoring" target="blank" class="btn btn-success btn-lg mt-4 mb-2">
        Buy a copy
    </a>
</div>
<p>I thought of writing a book ever since I started blogging. I wanted to put knowledge into a concise source, where you could deep dive into one topic, have a space to think about it and reflect on it. Not just documentation and code samples, but also <strong>broader vision</strong> behind it, share challenging experiences about why do we choose A and not B and ideally, spark inspiration in the reader for their creative coding.</p>
<p>There was just one piece missing - <strong>the co-operation with real user, dialogue with somebody else than me</strong>. It's easy to give in to author blindness and drift away to irrelevant topics. I wanted to have a reflection, a colleague that would tell me, &quot;I have no idea what you're trying to say here&quot;. That's what fits with Matthias.</p>
<h2 id="How-Pair-Writing-Pushes-Book-to-Another-Level">How Pair Writing Pushes Book to Another Level?</h2>
<p>At the start, we had a lot of discussions about how the Rector works. He gave me a lot of WTFs surprises: &quot;Why do Rector tests load configs from the root <code>rector.php</code>? Why are there two forms to run a test case? How can I run Rector on PHP 7.1? Why do I need reflection to rename classes?&quot;</p>
<p>Suddenly, I could see all the weak spots with developer experience. GitHub issues provide some source of poor design, but not as much as <strong>7 months of writing a book together does</strong>. It was tremendous help for the Rector itself. We knew the Rector book would coin how you work with Rector in your project, so we worked hard to make the user experience as smooth as possible.</p>
<p>Along these lines, not only the Rector code improved, but the book also got its storyline - about how Rector was inevitable and only possible thanks to the work of dozens of PHP developers across a life span of 20 years... pst, not to spoil.</p>
<h2 id="Who-is-the-Book-For">Who is the Book For?</h2>
<p>Do you Rector daily, write your own custom Rector rules, and have tests for them? Have you migrated 3 legacy projects with Rector and use Rector in CI to work for you? <strong>Don't read it</strong>, it would not teach you any new technical skill (Sebastian! :)). On the other hand, the book goes beyond technical steps and shows a future vision for the PHP community, where Rector is just one of the building stones.</p>
<p><br></p>
<p>Do you use Rector in CI on your new projects and find it easy? Yet, do you struggle with your legacy project and don't believe Rector can help you? Are you lost in the terminology of AST, nodes, and traversing?</p>
<p><a href="https://leanpub.com/rector-the-power-of-automated-refactoring"><strong>Read this book</strong></a>. It will take you step by step, explain pitfalls you struggle with, and give you the confidence to migrate any legacy project with automated refactoring.</p>
<p><br></p>
<p>Would you like to get a job faster than your peers? Do you see yourself as an innovative person? Do you lack time to do changes you see as positive? Would you love to automated your code reviews and get more time for human interactions? Do you dream of a world without legacy code?</p>
<p><a href="https://leanpub.com/rector-the-power-of-automated-refactoring"><strong>Read this book</strong></a>. It will give you a broad picture of the PHP toolchain, the knowledge framework of using them together, and the power to make automated refactoring your daily bread with Rector. Who knows, maybe your next project will run Rector beneath and turn into disruptive innovation.</p>
<p><br></p>
<h2 id="Support-Rector-Development">Support Rector Development</h2>
<p>By buying this book, you also support the Rector ecosystem and help <a href="https://github.com/rectorphp/rector-src/graphs/contributors">developers around</a> to improve it.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/rector-the-power-of-automated-refactoring-book-released</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 17 May 2021 00:00:00 +0000</pubDate>
                                    <updated>2021-06-01UTC00:00:000</updated>
                    <atom:updated>Tue, 01 Jun 2021 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Tue, 01 Jun 2021 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/rector-the-power-of-automated-refactoring-book-released#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Introducing ECS Prefixed and Downgraded to PHP 7.1 ]]></title>
                <link>https://tomasvotruba.com/blog/introducing-ecs-prefixed-and-downgraded-to-php-71</link>
                <description><![CDATA[ <p>ECS is part of Symplify that requires PHP 7.3 version as minimal. That cuts down options for you as an end-user. And that's not the only problem. Do you require Symfony 2.8 or 3.4? You're blocked.
<br><br>
How can we <strong>improve your experience while keeping the latest features</strong>?</p> ]]></description>
                <content:encoded><![CDATA[ <p>When we try to install ECS with miss conflicting dependency...</p>
<pre><code class="language-bash">composer require symfony/console:2.8
composer require symplify/easy-coding-standard --dev</code></pre>
<p>❌</p>
<p>...we'll end up with composer &quot;ECS requires at least symfony 4.4 version, cannot install&quot; error.</p>
<p>Some of you might know there is a way around with ECS Prefixed version. This package is built on every ECS release into <a href="https://github.com/symplify/easy-coding-standard-prefixed">special standalone repository</a>. It has <strong>own dependency namespace prefixed</strong> so that you can install it with the same package of another version, like symfony/console:</p>
<pre><code class="language-bash">composer require symfony/console:2.8
composer require symplify/easy-coding-standard-prefixed --dev</code></pre>
<p>✅</p>
<p>Imagine you have keys from your car. They work like regular keys most of the week, but on weekends not. Unless, of course, you drop them 2x times before putting the key inside the lock.</p>
<p>Requiring a suffix to remember is not very intuitive and creates an awful developer experience.
So how can <strong>we improve this developer experience</strong>?</p>
<h2 id="Prefix-on-Release">Prefix on Release</h2>
<p>How would you expect ECS to install?</p>
<pre><code class="language-bash">composer require symfony/console:2.8
composer require symplify/easy-coding-standard --dev</code></pre>
<p>✅</p>
<p>Me too. So how can we do that? First, we need to understand the current project architecture.</p>
<p><br></p>
<p>Symplify is a like Symfony, Laravel or luminas <a href="/cluster/monorepo-from-zero-to-hero">a monorepo</a>.</p>
<p><strong>What does <em>monorepo</em> mean?</strong> That:</p>
<ul>
<li>PR is merged to `symplify/simplify ↓</li>
<li>then <code>symplify/easy-coding-standard</code> is split ↓</li>
<li>then build of <code>symplify/easy-coding-standard-prefixed</code> is published</li>
</ul>
<p><br></p>
<p>Now we need to merge the last 2 steps into 1.</p>
<p>If the process were a git diff, it would look like this:</p>
<pre><code class="language-diff"> - PR is merged to symplify/symplify ↓
-- then symplify/easy-coding-standard is split ↓
-- then build of symplify/easy-coding-standard-prefixed is published
+- then build of symplify/easy-coding-standard is published on split</code></pre>
<p>Thanks to monorepo, this is a piece of cake. We need to take the prefixing script and move it before the split itself:</p>
<ul>
<li>
<p>monorepo <code>symplify/symplify</code> has original PHP code</p>
</li>
<li>
<p><strong>CI build step #1: scope code</strong></p>
</li>
<li>
<p><strong>CI build step #2: publish split package</strong></p>
</li>
<li>
<p>split <code>symplify/easy-coding-standard</code> repository has scoped PHP code</p>
</li>
</ul>
<p>Now instead of splitting the original code, we split already prefixed code.</p>
<h2 id="Downgraded-by-Default">Downgraded by Default</h2>
<p>Do you know middlewares? They're like a layer of you lasagne that you can insert anywhere between request and response. Do you need to add an extra security layer? Just add security middleware.</p>
<p>Layer in CI can be stacked on each other in similar way. If we can handle scoping, why not add downgrading too?</p>
<ul>
<li>
<p>monorepo <code>symplify/symplify</code> has original PHP code</p>
</li>
<li>
<p><strong>CI build step: scope code</strong></p>
</li>
<li>
<p><strong>CI build step #2: downgrade code to PHP 7.1</strong></p>
</li>
<li>
<p><strong>CI build step #3: publish split &amp; downgraded package</strong></p>
</li>
<li>
<p>split <code>symplify/easy-coding-standard</code> repository has scoped and downgraded PHP code</p>
</li>
</ul>
<p><br></p>
<p>Before we had:</p>
<ul>
<li><code>symplify/easy-coding-standard</code> on PHP 7.3 without scoping</li>
<li><code>symplify/easy-coding-standard-prefixed</code> on PHP 7.3 scoped</li>
</ul>
<p>Now we have:</p>
<ul>
<li><code>symplify/easy-coding-standard</code> on <strong>PHP 7.1 with scoping</strong></li>
</ul>
<p>✅</p>
<h2 id="How-to-Upgrade">How to Upgrade?</h2>
<p>The ECS with PHP 7.1 and scoped code is available since version 9.3.10. You can run bare <code>composer update</code> or specify the exact version to be sure:</p>
<pre><code class="language-bash">composer remove squizlabs/php_codesniffer
composer remove friendsofphp/php-cs-fixer
composer update symplify/easy-coding-standard:^9.3.10</code></pre>
<p>Do you use <code>symplify/easy-coding-standard-prefixed</code>? Replace it with a new package:</p>
<pre><code class="language-bash">composer remove squizlabs/php_codesniffer
composer remove friendsofphp/php-cs-fixer
composer remove symplify/easy-coding-standard-prefixed
composer require symplify/easy-coding-standard:^9.3.10 --dev</code></pre>
<h2 id="What-has-Changed">What has Changed?</h2>
<p>There might be a BC break because we're scoping ECS dependencies from now on. That means php-cs-fixer 3.0+ and PHP_CodeSniffer 3.6+ code is now accessible only for <code>vendor/bin/ecs</code> run.</p>
<p><strong>Do you write your Fixer or Sniffs?</strong> Add required packages:
require</p>
<pre><code class="language-bash">composer require friendsofphp/php-cs-fixer --dev
composer require squizlabs/php_codesniffer --dev</code></pre>
<p>Apart from that, everything should be running correctly. If not, let us know in <a href="https://github.com/symplify/symplify/issues/new">GitHub issues</a>.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/introducing-ecs-prefixed-and-downgraded-to-php-71</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 13 May 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/introducing-ecs-prefixed-and-downgraded-to-php-71#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Write GitHub Actions for Gitlab Too ]]></title>
                <link>https://tomasvotruba.com/blog/write-github-actions-for-gitlab-too</link>
                <description><![CDATA[ <p>In a recent post <a href="/blog/how-can-we-use-github-actions-in-gitlab">How can We use GitHub Actions in Gitlab?</a>, we looked at the idea, how both services could <strong>the use same CI recipe</strong>. As a Gitlab CI user, you can use some GitHub Actions to do the work for you.
<br>
<br>
Today we look at <strong>how to write such action</strong> to provide an excellent developer experience for both.</p> ]]></description>
                <content:encoded><![CDATA[ <div class="text-center">
    <blockquote class="blockquote">
        "If you want to go fast, go alone.
        <br>
        If you want to go far, go together."
    </blockquote>
</div>
<h2 id="Let-s-Go-Together">Let's Go Together</h2>
<p>5 years ago <a href="https://www.youtube.com/watch?v=D827D5ILfh8">I gave a talk</a> [Czech only] about 2 frameworks. These 2 frameworks were two different groups that didn't like each other. Both frameworks were written in PHP, both MVC and both were used by PHP developers. I was wondering, why not go together?</p>
<p>My talk was about how to <strong>convert this aversion into a healthy competition, friendship, and mutual learning</strong>.</p>
<p><br></p>
<p>What movie does that resemble?</p>
<p><a href="https://www.slideshare.net/phplive/tom-votruba-jako-vinnetou-a-old-shatterhand-refaktoruj-nenvist-v-ptelstv"></p>
<img src="https://user-images.githubusercontent.com/924196/117082040-74439e00-ad41-11eb-9547-01a91a5dc6ad.jpg" class="img-thumbnail">
<p></a></p>
<p>I would love to see a similar story between &quot;Old Gitlabhand&quot; and &quot;GitHubtou&quot; :). While researching Gitlab and GitHub in this theme, I found a post from 2018 called <a href="https://blog.anoff.io/2018-03-30-gitlab-ci-for-github/">GitLab CI/CD for GitHub</a> by Andreas Offenhauser. The idea in the post is amazingly simple.</p>
<p>Back in 2018, GitHub didn't have a proper CI yet. We used more matured Travis, Circle CI, etc. Andreas suggests, <strong>we can use the best of both worlds</strong> - hook in GitHub to Gitlab CI pipelines and let GitHub collect Gitlab CI feedback.</p>
<img src="https://blog.anoff.io/assets/gitlab-ci/feature.png" class="img-thumbnail" style="max-width: 25em">
<p>The rest is history, but the underlying philosophy goes beyond time.</p>
<h2 id="How-they-Place-the-Input">How they Place the Input?</h2>
<p>We already know <a href="/blog/how-can-we-use-github-actions-in-gitlab#2-from-pseudo-syntax-to-gitlab-ci-syntax">how to write <code>.gitlab-ci.yml</code></a> so we can use GitHub Action. But how can we write GitHub Action without writing two scripts - one for GitHub and another for Gitlab?</p>
<p><br></p>
<p>First, we need to use the Docker approach. <strong>The GitHub docs suggest using Docker with arguments</strong>:</p>
<pre><code class="language-bash">docker run some-image $ARGUMENTS</code></pre>
<p>Then work with arguments <strong>by their order</strong> - $1, $2 etc. In practise the GitHub workflow might look like this:</p>
<pre><code class="language-yaml"># .github/workflows/monorepo_split.yaml
# ...
with:
    from-package: 'packages/easy-coding-standard'
    to-repository: 'https://github.com/symplify/easy-coding-standard'</code></pre>
<p><br></p>
<p>The philosophy of <strong>Gitlab is a bit different</strong>. They are closer to Docker ideology, so instead of argument order, they promote ENV variables.</p>
<pre><code class="language-yaml"># .gitlab-ci.yml
env:
    FROM_PACKAGE: "packages/easy-coding-standard"
    TO_REPOSITORY: "https://github.com/symplify/easy-coding-standard"</code></pre>
<p>You can find this approach in <a href="https://hub.docker.com/_/postgres">Postgres Docker</a>, <a href="https://hub.docker.com/_/mysql">Mysql Docker</a>, and many others.</p>
<p><br></p>
<p>So Github script works with arguments order and Gitlab with ENV variables. That's a pickle. What now? Do we have to write two scripts to make our GitHub Action work for both?</p>
<h2 id="What-is-the-Shared-Way">What is the Shared Way?</h2>
<p>When I spoke about Nette and Symfony to both communities, I <strong>focused on values they share</strong> - active community, simple controller architecture, creative solutions in small packages. This way, we could find understanding from each other.</p>
<p><br></p>
<p>What would be the <strong>shared</strong> path here?</p>
<p>The default way of doing things suggests there are also alternative ways. You can use magic facades in Laravel by default, or you can use <a href="/blog/2019/03/04/how-to-turn-laravel-from-static-to-dependency-injection-in-one-day/">constructor injection</a> alternative. I was looking for such an alternative for a while in GitHub and Gitlab, so they <strong>can bridge together</strong>.</p>
<h2 id="Research-Explore-Doubt">Research, Explore, Doubt</h2>
<p>After a couple of days of frustration, I came across <a href="https://www.philschmid.de/create-custom-github-action-in-4-steps">Create custom Github Action in 4 steps</a> post.</p>
<p>There was one <strong>very important sentence</strong>:</p>
<ul>
<li><code>inputs</code>: defines the input parameters you can pass into your bash script.
<ul>
<li>You can access them with <code>$INPUT_{Variable}</code> in our example <code>$INPUT_POKEMON_ID</code></li>
</ul></li>
</ul>
<p>So does that mean that this GitHub Action input:</p>
<pre><code class="language-yaml">with:
    from-package: 'packages/easy-coding-standard'
    to-repository: 'https://github.com/symplify/easy-coding-standard'</code></pre>
<p>is also:</p>
<pre><code class="language-yaml">env:
    INPUT_FROM_PACKAGE: 'packages/easy-coding-standard'
    INPUT_TO_REPOSITORY: 'https://github.com/symplify/easy-coding-standard'</code></pre>
<p>Can you see the shared pattern? GitHub is using ENV, Gitlab is using ENV...</p>
<p><br></p>
<p><strong>Heureka! We've found it!</strong></p>
<p>✅</p>
<h2 id="How-to-Write-it-Once">How to Write it Once?</h2>
<p>The final solution is straightforward:</p>
<ul>
<li>we name the input variables with the single name</li>
<li>on GitHub, we prefixed them with <code>INPUT_</code></li>
</ul>
<pre><code class="language-php">$env = getenv();

$ciPlatform = '...'; // detect via known ci-based ENV variables

$envPrefix = $ciPlatform === 'GITHUB' ? 'INPUT_' : '';

// shared input
$packageDirectory = $env[$envPrefix . 'FROM_DIRECTORY'];
$toRepository = $env[$envPrefix . 'TO_REPOSITORY'];</code></pre>
<p>In the end, the Docker image <a href="https://github.com/symplify/monorepo-split-github-action/pull/10">has one script for both</a>. You would not even notice what CI service it was written for originally.</p>
<p><br></p>
<p>So next time you'll be writing a GitHub Action, <strong>think of your friends in Gitlab and write a Docker image for them too</strong>. Thank you.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/write-github-actions-for-gitlab-too</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 10 May 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/write-github-actions-for-gitlab-too#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ PHPStan Generics for Dummies - With 2 Parents ]]></title>
                <link>https://tomasvotruba.com/blog/phpstan-generics-for-dummies-with-two-parents</link>
                <description><![CDATA[ <p>In previous post we talked about how to <a href="/blog/2021/01/04/phpstan-abstract-parent-generics-dummies/">promote generics to parent class</a>.
There we learned how to tell parent class what generic type we use (typically from <code>ProductRepository</code> and <code>AbstractRepository</code>).
<br>
<br>
Today we take the same use case and <strong>add one more parent class</strong>.
<br>
<br>
That must be easy, right?</p> ]]></description>
                <content:encoded><![CDATA[ <p>Let's start where we ended last time:</p>
<pre><code class="language-php">/**
 * @extends AbstractRepository&lt;Product&gt;
 */
final class ProductRepository extends AbstractRepository
{
}</code></pre>
<p>With an abstract parent:</p>
<pre><code class="language-php">/**
 * @template TEntity as object
 */
abstract class AbstractRepository
{
    /**
     * @return TEntity
     */
    public function get($id)
    {
        // ...
    }
}</code></pre>
<p>✅</p>
<p>PHPStan now knows exact returned type of all method annotated with <code>TEntity</code>:</p>
<pre><code class="language-php">/** @var ProductRepository $productRepository */
$product = $productRepository-&gt;get(1);</code></pre>
<p>Here we always have a <code>Product</code> type.</p>
<p><br></p>
<h2 id="Constraints-Have-Changed">Constraints Have Changed</h2>
<p>Everything works well, our project grows, and more and more users are visiting our website. Life is good.</p>
<p>Just the response time is lagging more and more. How could we improve it? One way is to <strong>cache the most visited entities</strong>.</p>
<p>Alright! We'll add a new repository class with cache:</p>
<pre><code class="language-php">abstract class AbstractCachedRepository extends AbstractRepository
{
    // cache everywhere
}</code></pre>
<p>And one parent switch:</p>
<pre><code class="language-diff"> /**
  * @extends AbstractRepository&lt;Product&gt;
  */
-final class ProductRepository extends AbstractRepository
+final class ProductRepository extends AbstractCachedRepository
 {
     // ...
 }</code></pre>
<p>Our class structure changes like this:</p>
<pre><code class="language-diff">- ProductRepository -&gt; AbstractRepository
+ ProductRepository -&gt; AbstractCachedRepository -&gt; AbstractRepository</code></pre>
<p>The cache is working, and lagging is gone... we run PHPStan, and... it crashes. <strong>Why?</strong> Because the class in <code>@extends class</code> is no longer there:</p>
<pre><code class="language-php">/**
 * @extends AbstractRepository&lt;Product&gt;
 */
final class ProductRepository extends AbstractCachedRepository
{
}</code></pre>
<p>The <code>ProductRepository</code> class does not see its grand-parent class <code>AbstractRepository</code>, only its direct parent.
<strong>We'll fix that:</strong></p>
<pre><code class="language-diff"> /**
- * @extends AbstractRepository&lt;Product&gt;
+ * @extends AbstractCachedRepository&lt;Product&gt;
  */
 final class ProductRepository extends AbstractCachedRepository
 {
 }</code></pre>
<p>Well done! Now we rerun PHPStan to see the result... and it crashes. <strong>Why?</strong></p>
<h2 id="2-Steps-to-Man-in-the-Middle-Class">2 Steps to Man in the Middle Class</h2>
<p><code>AbstractCachedRepository</code> is a middle man. <strong>Its job is to take type from the child class and send it to the parent class.</strong> But it's just a bare class with no annotations.</p>
<p><br></p>
<p>It has no idea what to do. We have to tell it to...</p>
<p><strong>1. pick the type from child class</strong></p>
<pre><code class="language-diff">+ /**
+  * @template TEntity of object
+  */
  abstract class AbstractCachedRepository extends AbstractRepository
  {
  }</code></pre>
<p><strong>2. send it to parent class via <code>@template-extends</code></strong></p>
<pre><code class="language-diff">  /**
   * @template TEntity of object
+  * @template-extends AbstractRepository&lt;TEntity&gt;
   */
  abstract class AbstractCachedRepository extends AbstractRepository
  {
  }</code></pre>
<p>We run PHPStan, and... it works!</p>
<p>✅</p>
<p><br></p>
<h2 id="Let-PHPStan-Watch-Your-Back">Let PHPStan Watch Your Back</h2>
<p>Is your PHPStan passing <strong>even without generic definition in child class</strong>? You need to enable it first.</p>
<p>There are 2 ways. One of them is level 6+:</p>
<pre><code class="language-yaml">parameters:
    level: 6</code></pre>
<p>Are you stuck on a lower level? There is <strong>single parameter</strong> you can enable instead:</p>
<pre><code class="language-yaml">parameters:
    level: 4
    checkGenericClassInNonGenericObjectType: true</code></pre>
<p>Then run PHPStan and <strong>complete generic types with confidence</strong>.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/phpstan-generics-for-dummies-with-two-parents</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 03 May 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/phpstan-generics-for-dummies-with-two-parents#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Dependency Juggling Code Smell ]]></title>
                <link>https://tomasvotruba.com/blog/dependency-juggling-code-smell</link>
                <description><![CDATA[ <p>The best way to pass dependencies is via constructor injection. Only in services, we need the dependency in. I've noticed that <strong>sometimes the dependency is passed way too early</strong>, just to be passed to another service as a method argument.
<br><br>
Why is it a code smell, and how can we avoid it?</p> ]]></description>
                <content:encoded><![CDATA[ <p>Because constructor injection has good karma, we automatically assume that everything in <code>__construct(...)</code> is correct. That's why we can easily miss it.</p>
<p>Imagine this code in your project:</p>
<pre><code class="language-php">final class TypeResolver
{
    public function __construct(
        // using PHP 8 property promotion here
        private StringTypeResolver $stringTypeResolver,
        private ConstantStringTypeResolver $constantStringTypeResolver,
    ) {
    }

    public function resolve(Expr $expr): Type
    {
        return $this-&gt;stringTypeResolver-&gt;resolveFromExpr(
            $expr,
            $this-&gt;constantStringTypeResolver,
        );
    }
}</code></pre>
<p>Can you see the smell in here? We have 2 services passed as a dependency in the constructor:</p>
<ul>
<li><code>StringTypeResolver</code></li>
<li><code>ConstantStringTypeResolver</code></li>
</ul>
<p>Constructor states what dependencies this class needs to work.</p>
<p><br></p>
<p>How many of them the <strong>class directly uses</strong>? Just the <code>StringTypeResolver</code> one.</p>
<p>The other one <code>ConstantStringTypeResolver</code> is juggled to <code>StringTypeResolver</code> as side dependency.</p>
<h2 id="2-Pair-of-Keys">2 Pair of Keys</h2>
<img src="https://user-images.githubusercontent.com/924196/116310231-03810c80-a7aa-11eb-8053-508de8ba8149.jpg" class="img-thumbnail">
<p>It's like your own keys from your home with one extra pair. You take them both with you everywhere. You use the first pair to unlock doors from your home. The extra pair you use exclusively when you open your door for your wife.</p>
<p>Why would you have these extra keys for your own? Instead, <strong>give them to your wife and let her handle it</strong>.</p>
<blockquote class="blockquote pt-3 pb-3 text-center">
Each service should take care only of its own dependencies.
<br>
not take responsibility for others.
</blockquote>
<p>If we apply this approach to our code, we can move the <code>ConstantStringTypeResolver</code> where it belongs:</p>
<pre><code class="language-diff"> final class TypeResolver
 {
     public function __construct(
        private StringTypeResolver $stringTypeResolver,
-       private ConstantStringTypeResolver $constantStringTypeResolver,
     ) {
     }

     public function resolve(Expr $expr): Type
     {
         return $this-&gt;stringTypeResolver-&gt;resolveFromExpr(
             $expr,
-            $this-&gt;constantStringTypeResolver,
         );
     }
 }</code></pre>
<p>The <code>StringTypeResolver</code> now handles its dependencies on its own:</p>
<pre><code class="language-diff"> final class StringTypeResolver
 {
+    public function __construct()
+    {
+        private ConstantStringTypeResolver $constantStringTypeResolver,
+    }

     public function resolveFromExpr(
        Expr $expr,
-       ConstantStringTypeResolver $constantStringTypeResolver,
     ) {
-        $constantStringTypeResolver-&gt;resolve(...);
+        $this-&gt;constantStringTypeResolver-&gt;resolve(...);
         // ...
     }
 }</code></pre>
<p>👍</p>
<p><br></p>
<h2 id="PHPStan-Got-Your-Back">PHPStan Got Your Back</h2>
<p>The tricky part is to watch for these cases not to get into your code. It's easy to take 2 key sets instead of 1 when you're in a rush to catch a tram or taxi.</p>
<p><a href="https://github.com/symplify/phpstan-rules">Symplify PHPStan Rules</a> got you covered. Just install it:</p>
<pre><code class="language-bash">composer require symplify/phpstan-rules --dev</code></pre>
<p>Then add the rule to your <code>phpstan.neon</code> config:</p>
<pre><code class="language-yaml">rules:
     - Symplify\PHPStanRules\Rules\NoDependencyJugglingRule</code></pre>
<p>The rule looks for constructor dependencies that are juggled to method calls. Don't worry about it, and let your CI handle it.
That's all for today.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/dependency-juggling-code-smell</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 26 Apr 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/dependency-juggling-code-smell#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How can We use GitHub Actions in Gitlab? ]]></title>
                <link>https://tomasvotruba.com/blog/how-can-we-use-github-actions-in-gitlab</link>
                <description><![CDATA[ <p>One of my customers is building a monorepo, so we prepared a prototype on GitHub to test it out. It uses <a href="/blog/monorepo-split-github-action-20-with-gitlab-split-is-out/">Monorepo Split GitHub Action</a> and works well.
<br><br>
You know <a href="/blog/best-time-to-switch-gitlab-to-github">I'm a big fan of GitHub</a>, so when client asked me: <strong>&quot;how can we do it in Gitlab?&quot;</strong>
<br>
I was like: &quot;that's not possible... you need to switch to GitHub&quot;.</p> ]]></description>
                <content:encoded><![CDATA[ <p>...or was I?</p>
<p>Critical thinking can be easily disabled by <a href="https://en.wikipedia.org/wiki/Confirmation_bias">confirmation bias</a>. When I stop thinking critically and actually realize that, I try to get back to reality. One way to do that is to <strong>describe the situation as it is in few simple words</strong>.</p>
<p><br></p>
<p><strong>What we have now?</strong></p>
<ul>
<li>GitHub mono repository ✅</li>
<li>working split on GitHub thanks to GitHub Action ✅</li>
<li>Gitlab repositories ✅</li>
</ul>
<p><strong>What we need?</strong></p>
<ul>
<li>Gitlab mono repository</li>
<li>Gitlab split</li>
<li>Gitlab repositories</li>
</ul>
<h2 id="Can-We-Get-There-How-Can-We-Get-There"><del>Can We Get There?</del> How Can We Get There?</h2>
<ol>
<li>From GitHub mono repository to Gitlab mono repository. Basically, we need to switch the <code>origin</code> reference in git:</li>
</ol>
<pre><code class="language-bash"># remove github
git remote remove origin

# add GitLab
git remote add origin git.gitlab.com/...
git push origin</code></pre>
<ol start="2">
<li>From GitHub Split Action to Gitlab?</li>
</ol>
<p>My first idea was: <em>&quot;I have no idea&quot;</em>. Let's be honest here. It's not a very good solution, not a solution at all, not working, but we always have to start somewhere.</p>
<p>What is the next idea? Let's describe <strong>world in simple words</strong>.</p>
<h2 id="What-is-a-GitHub-Action">What is a GitHub Action?</h2>
<p>&quot;GitHub Action is some script that you call, and it does some work for you. Mostly in CI regularly.&quot;</p>
<p>Good. GitHub Actions is a CI, and Gitlab CI is a CI. <strong>We have a mental bridge that we can use</strong>.</p>
<p>&quot;Yea, but GitHub Action is tailor-made for GitHub CI&quot;.</p>
<p><br></p>
<p>Ok, what exactly is GitHub CI doing when you run a GitHub Action in it?</p>
<p>&quot;Well, it gets input arguments that we set and runs a script with them.&quot;</p>
<p><br></p>
<p>What do you mean by <strong>a script</strong>?</p>
<p>&quot;There is Docker image that we download and run. The Docker image can call bash, PHP, or whatever other inner script and just pass the arguments in it.&quot;</p>
<p><br></p>
<p>Ok, so GitHub Action is <strong>basically a Docker image that accepts arguments and runs them</strong>?</p>
<pre><code class="language-bash">docker run some-image $ARGUMENTS</code></pre>
<p>&quot;Yes!&quot;</p>
<p><br></p>
<p><em>Note:</em> there is 2nd way to build GitHub Action <a href="https://docs.github.com/en/actions/creating-actions/about-actions#types-of-actions">via Javascript</a>. I didn't follow that path, as I know Docker better than Javascript.</p>
<h2 id="1-From-GitHub-Action-Syntax-to-Pseudo-Syntax">1. From GitHub Action Syntax to Pseudo Syntax</h2>
<p>Let's look at CI configuration. In GitHub, it's YAML files located in the <code>.github/workflows</code> directory, in Gitlab, it's <code>.gitlab-ci.yml</code>.</p>
<p><br></p>
<p>This is how looks real <strong>GitHub Action in normal syntax</strong>:</p>
<pre><code class="language-yaml"># .github/workflows/monorepo_split.yaml
jobs:
    monorepo_split:
        steps:
            # ...
            -
                uses: "symplify/monorepo-split-github-action@2.0"
                with:
                    package-directory: 'packages/easy-coding-standard'
                    split-repository-organization: 'symplify'
                    split-repository-name: 'easy-coding-standard'</code></pre>
<p>How would the same action look like <strong>in pseudo syntax</strong> without GitHub syntax sugar?</p>
<pre><code class="language-yaml"># use this docker image
image: "symplify/monorepo-split-github-action"

# setup input variables
env:
    FROM_PACKAGE: "packages/easy-coding-standard"
    TO_REPOSITORY: "https://github.com/symplify/easy-coding-standard"

# run docker image with input variables
script:
    - docker run symplify/monorepo-split-github-action $FROM_PACKAGE $TO_REPOSITORY</code></pre>
<p>This is great! Now we know the exact steps that have to be reproduced in the next CI.</p>
<h2 id="2-From-Pseudo-Syntax-to-GitLab-CI-Syntax">2. From Pseudo Syntax to GitLab CI Syntax</h2>
<p>Now we take the pseudo syntax and try to fit in Gitlab conventions:</p>
<pre><code class="language-yaml"># .gitlab-ci.yml
split_monorepo:
    # ...
    # set envs
    variables:
        FROM_PACKAGE: "packages/easy-coding-standard"
        TO_REPOSITORY: "https://github.com/symplify/easy-coding-standard"

    script:
        - docker run symplify/monorepo-split $FROM_PACKAGE $TO_REPOSITORY</code></pre>
<p>That's it! <strong>Now we're using GitHub Action in a Gitlab CI.</strong></p>
<p><br></p>
<h2 id="How-to-make-GitHub-Actions-that-GitLab-Developers-can-use">How to make GitHub Actions that GitLab Developers can use?</h2>
<p>Not every GitHub Action will work out of the box. There are steps we have to think about:</p>
<ol>
<li>build GitHub Action as a <strong>Docker image</strong> and not Javascript one</li>
<li><strong>publish the Docker image</strong> to <a href="https://hub.docker.com/">Docker Hub</a> (basically Packagist for Docker images), so anyone can use it</li>
<li>allow passing <strong>Gitlab Access Token</strong> for repository access</li>
<li>bonus: if you have many arguments, think of passing them as ENV variables to keep <code>.gitlab-ci.yaml</code> small</li>
</ol>
<p>That's all, folks. I could not believe how simple this is.</p>
<p>Can't wait to give it a try? <strong>Let me know what GitHub Actions you're using in Gitlab!</strong></p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/how-can-we-use-github-actions-in-gitlab</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 19 Apr 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/how-can-we-use-github-actions-in-gitlab#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 2 Ways to Write Big Numbers More Readable ]]></title>
                <link>https://tomasvotruba.com/blog/2ways-to-write-big-numbers-more-readable</link>
                <description><![CDATA[ <p>Have you seen a number in your code that does not make any sense? We don't talk about 1, 2, or 3. I mean big numbers like 965039008. How would you spell it when support asks you for your account ID?
<br><br>
<strong>There are two ways to make big numbers more readable</strong>. Instant and easy ways that I found mostly by accident. We use them both in one big project, and it makes our daily number work so much easier I want to share them with you.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="1-Context-Aware-Spaces">1. Context-Aware Spaces</h2>
<p>Thefirsttrickiscontextspacesforourbraincaneasilyseelogic. Like spaces in a sentence makes it easier to read it word by word.</p>
<p><br></p>
<p>Let's have a little real-life experience. Today we have less and less time to get through our day. We barely read section titles and <strong>text in bold</strong>.</p>
<p><br></p>
<p>To simulate that, read the next number in a blink of an eye (~200 ms):</p>
<pre><code class="language-php">$housePrice = 10000000;</code></pre>
<p><br></p>
<p>Now answer: <strong>how much does your new house costs?</strong></p>
<ul>
<li>a million</li>
<li>10 million</li>
<li>hundred thousands</li>
</ul>
<p><br></p>
<p>I can't answer that for sure, and I wrote that number just a few seconds ago.</p>
<p><br></p>
<p>Now let's see the same number with context spaces:</p>
<pre><code class="language-php">$housePrice = 10_000_000;</code></pre>
<p>The answer is obvious now - 10 million.</p>
<p><br></p>
<p>This <strong>little trick is called <a href="https://php.watch/versions/7.4/underscore_numeric_separator">the underscore separator</a></strong> and we can use it since PHP 7.4+.</p>
<h2 id="Use-Underscore-Separator-to-Save-The-Future">Use Underscore Separator to Save The Future</h2>
<p>Do you want to make your <strong>future code</strong> more readable?</p>
<p>Use <code>_</code> in numbers while you're writing them. It will save your from guessing in future months:</p>
<pre><code class="language-php">$creditCardNumber = 1234_1234_1234_1234;
$phoneNumber = 420_776_778_333;
$price = 99_99;</code></pre>
<p><br></p>
<p>Do you want to make your <strong>current code more readable</strong>?</p>
<p>Use <a href="https://github.com/rectorphp/rector/blob/main/docs/rector_rules_overview.md#addliteralseparatortonumberrector"><code>AddLiteralSeparatorToNumberRector</code></a> from Rector to upgrade your numbers:</p>
<pre><code class="language-diff">-$int = 500000;
+$int = 500_000;

-$float = 1000500.001;
+$float = 1_000_500.001;</code></pre>
<p><br></p>
<h2 id="2-Time-Constants">2. Time Constants</h2>
<p>What is the magic behind these numbers?</p>
<pre><code class="language-php">31104000
604800</code></pre>
<p>From the paragraph title, we know it's about time... <strong>but how much precisely</strong>? No calculators are allowed!</p>
<h2 id="Do-you-Use-Nette-Utils">Do you Use Nette\Utils?</h2>
<p>Some packages are very powerful, but only very few developers are aware of them. One of these packages is Nette\Utils. You don't use it for every project yet? Read <a href="/blog/2018/07/30/hidden-gems-of-php-packages-nette-utils/">hidden gem post</a> and look at 1 more reason <a href="https://www.reddit.com/r/PHP/comments/mya4gb/preg_last_error_and_json_last_error/">on Reddit from last week</a>.</p>
<p>It can help to make these numbers more readable:</p>
<pre><code class="language-php">const TIMEOUT = 86400;

const PING = 3600;</code></pre>
<p>What are these? One of them might be an hour in seconds. The second... maybe a day in seconds? &quot;Maybe&quot; is not for coders, it's for gamblers. <strong>We play it strictly!</strong></p>
<p><br></p>
<pre><code class="language-diff">+use Nette\Utils\DateTime;

-const TIMEOUT = 86400;
+const TIMEOUT = DateTime::DAY;

-const PING = 3600;
+const PING = DateTime::HOUR;</code></pre>
<p>Suddenly, random numbers will get a sense:</p>
<pre><code class="language-diff">+use Nette\Utils\DateTime;

-604800
+DateTime::WEEK

-31104000
+DateTime::DAY * 30 * 12</code></pre>
<h2 id="Use-HOUR-DAY-WEEK-MONTH-and-YEAR-Constants">Use <code>HOUR</code>, <code>DAY</code>, <code>WEEK</code>, <code>MONTH</code> and <code>YEAR</code> Constants</h2>
<p>Next time you'll write time in your code, give time to think about the time constants.</p>
<p>Would you like to <strong>upgrade your current numbers to constants instantly</strong>? Use <a href="https://github.com/rectorphp/rector-nette/blob/main/docs/rector_rules_overview.md#replacetimenumberwithdatetimeconstantrector"><code>ReplaceTimeNumberWithDateTimeConstantRector</code></a> from Rector to handle it.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2ways-to-write-big-numbers-more-readable</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 12 Apr 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2ways-to-write-big-numbers-more-readable#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Monorepo Split GitHub Action 2.0 with Gitlab split is Out! ]]></title>
                <link>https://tomasvotruba.com/blog/monorepo-split-github-action-20-with-gitlab-split-is-out</link>
                <description><![CDATA[ <p><a href="/blog/2020/11/09/new-in-symplify-9-monorepo-split-with-github-action">The version 1.0 was released 6 months ago</a>. Compared to its ancestors, it speed up the split from <strong>2 minutes to 10 seconds</strong>.
<br><br>
After 6 months of collecting feedback and adding new features, version 2.0 is here!
<br>
<br>
<strong>How to use it with GitLab split repositories and custom git hosting?</strong></p> ]]></description>
                <content:encoded><![CDATA[ <img src="/assets/images/posts/2021/split_news.png" class="img-thumbnail">
<p>I have 3 news today that make Monorepo Split more accessible to private packages.</p>
<p><br></p>
<h2 id="1-Private-Repositories-Support">1. Private Repositories Support</h2>
<p><a href="https://github.com/symplify/monorepo-split-github-action">Monorepo split</a> was built on open-source principles and thus used only for public repositories on GitHub. As time went by, this GitHub Action got into private repositories.</p>
<p>Do you have a private monorepo repository on GitHub? <strong>Monorepo Split 2.0 now supports it!</strong></p>
<h2 id="2-Split-to-Private-Gitlab-Repository">2. Split to Private Gitlab Repository</h2>
<p>GitHub Action can be used only on GitHub, obviously, but the target repository should not matter. Version 1.x had some troubles with splitting without the correct token. In version 2.0, we've <strong>added support for Gitlab as target repositories</strong>.</p>
<p>How to enable it? Just add the <code>GITLAB_TOKEN</code> env variable to your workflow YAML file:</p>
<pre><code class="language-yaml">env:
    GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}</code></pre>
<p>The token must include <code>read_repository</code> + <code>write_repository</code> rights. Where can you create such a token? Here <a href="https://gitlab.com/profile/personal_access_tokens">https://gitlab.com/profile/personal_access_tokens</a>.</p>
<p>Now you can build monorepo on GitHub and split it into repositories on Gitlab.</p>
<h2 id="3-Split-to-custom-Git-Hosting">3. Split to custom Git Hosting</h2>
<p>Do you use GitLab? If so, there is a big chance you host it on your server because the <a href="/blog/best-time-to-switch-gitlab-to-github/">saas is getting more and more expensive</a>.</p>
<p>That means your target hosting is not <code>github.com</code>, neither <code>gitlab.com</code>. That's why we've added a new parameter to set the host:</p>
<pre><code class="language-yaml">with:
    split-repository-host: git.private.com:1234</code></pre>
<h2 id="Upgrade-Today">Upgrade Today</h2>
<p>That's 3 news for today. Try it and upgrade your workflows:</p>
<pre><code class="language-diff">-                uses: symplify/github-action-monorepo-split@1.1
+                uses: symplify/github-action-monorepo-split@2.0</code></pre>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/monorepo-split-github-action-20-with-gitlab-split-is-out</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 05 Apr 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/monorepo-split-github-action-20-with-gitlab-split-is-out#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Traverse PHPDoc and Modify It ]]></title>
                <link>https://tomasvotruba.com/blog/how-to-traverse-phpdoc-and-modify-it</link>
                <description><![CDATA[ <p>Traversing and modifying PHP code is possible thanks to the amazing tool <a href="https://github.com/nikic/PHP-Parser">php-parser</a> written by Nikita Popov. Rector can work thanks to <strong>node traverser</strong>, which can get to any node abstract syntax tree. Do you want to replace all numbers with <code>1000</code>? I wrote about it in <a href="/blog/2017/11/06/how-to-change-php-code-with-abstract-syntax-tree/">How to change PHP code with Abstract Syntax Tree</a>.
<br>
<br>
But what about docblocks - how <strong>can we rename classes in <code>@var</code> annotation or replace <code>integer</code> with <code>int</code></strong>?
<br><br>
Is that even possible without using complex nested structures or regular expressions?</p> ]]></description>
                <content:encoded><![CDATA[ <p>Today we look at how to modify docblocks easily. But first, we must learn how <a href="https://github.com/phpstan/phpdoc-parser"><code>phpstan/phpdoc-parser</code></a> works under the hood.</p>
<p>Let's start with a simple docblock like this:</p>
<pre><code class="language-php">/**
 * @return int
 */</code></pre>
<p>If we parse it with <code>PhpDocParser</code>... you know what? Let's try this together:</p>
<pre><code class="language-bash">composer require symplify/astral</code></pre>
<p><br></p>
<pre><code class="language-php">use Symplify\Astral\PhpDocParser\StaticFactory\SimplePhpDocParserStaticFactory;

$values = &lt;&lt;&lt;'PHPDOC'
/**
 * @return int
 */
PHPDOC;

$simplePhpDocParser = SimplePhpDocParserStaticFactory::create();
$phpDocNode = $simplePhpDocParser-&gt;parse($values);</code></pre>
<p>If we dump the <code>var_dump($phpDocNode)</code>, we get roughly following node tree:</p>
<pre><code class="language-bash">PhpDocNode:
  |- children:
     |- PhpDocTagNode
        |- name: "@return"
        |- value: ReturnTagValueNode
            |- type: IdentifierTypeNode
                |- name: "int"</code></pre>
<p>This is classic PHP - object in an object in an object...</p>
<h2 id="How-can-we-Replace-int-with-string">How can we Replace <code>int</code> with <code>string</code>?</h2>
<p>First, we need to get to the <code>IdentifierTypeNode</code>. Then we check its value is <code>"int"</code>. If so, we change it to <code>"string"</code>. Seems pretty straightforward, right?</p>
<pre><code class="language-php">use PHPStan\PhpDocParser\Ast\PhpDoc\PhpDocNode;
use PHPStan\PhpDocParser\Ast\PhpDoc\PhpDocTagNode;
use PHPStan\PhpDocParser\Ast\PhpDoc\ReturnTagValueNode;
use PHPStan\PhpDocParser\Ast\Type\IdentifierTypeNode;

/** @var PhpDocNode $phpDocNode */
foreach ($phpDocNode-&gt;children as $phpDocChildNode) {
    if (! $phpDocChildNode instanceof PhpDocTagNode) {
        continue;
    }

    // is this node a @return?
    if (! $phpDocChildNode-&gt;value instanceof ReturnTagValueNode) {
        continue;
    }

    // does @return have simple type? here can be any TypeNode
    // e.g. UnionTypeNode, IntersectionTypeNode, CallableTypeNode etc.
    $returnTagValueNode = $phpDocChildNode-&gt;value;
    if (! $returnTagValueNode-&gt;type instanceof IdentifierTypeNode) {
        continue;
    }

    $identifierName = $returnTagValueNode-&gt;type-&gt;name;
    if (! $identifierName === 'int') {
        continue;
    }

    // phew... here we can finally change value
    $returnTagValueNode-&gt;type = new IdentifierTypeNode('string');
}</code></pre>
<p>If we run the code above, we manage to see this change:</p>
<pre><code class="language-diff"> /**
- * @return int
+ * @return string
  */</code></pre>
<h2 id="Next-Level-2-Nodes">Next Level: 2 Nodes</h2>
<p>In real life, the type is rarely used in a single location. Let's add <code>@param</code>:</p>
<pre><code class="language-php">/**
 * @param int $age
 * @return int
 */</code></pre>
<p>After parsing it, we get this node tree:</p>
<pre><code class="language-bash">PhpDocNode:
  |- children:
     |- PhpDocTagNode
        |- name: "@return"
        |- value: ReturnTagValueNode
            |- type: IdentifierTypeNode
                |- name: "int"
     |- PhpDocTagNode
        |- name: "@param"
        |- value: ParamTagValueNode
            |- type: IdentifierTypeNode
                |- name: "int"
</code></pre>
<p>How should we extend the logic above to cover the <code>@param</code> tag too?</p>
<pre><code class="language-diff"> if (
     ! $phpDocChildNode-&gt;value instanceof ReturnTagValueNode
+    &amp;&amp; ! $phpDocChildNode-&gt;value instanceof ParamTagValueNode
 ) {
      continue;
 }</code></pre>
<p>Easy pick, right?</p>
<p><br></p>
<img src="/assets/images/posts/2020/symplify_monorepo_split.jpg" class="img-thumbnail">
<h2 id="Next-Level-2-Nodes-with-Nested-Types">Next Level: 2 Nodes with Nested Types</h2>
<p>Types are can be also compound, here is <code>UnionTypeNode</code> with 2 <code>IdentifierTypeNode</code> nodes in it:</p>
<pre><code class="language-php">/**
 * @param int|null $age
 * @return int
 */</code></pre>
<p>Now we're getting into the loop of joy. I guess you can imagine how this can become hell coding.</p>
<p>But why should we want to change <code>int</code> to <code>string</code>? That was simple on purpose so that we can focus purely on example.</p>
<p>In reality, we want to rename the old class to a new one:</p>
<pre><code class="language-diff"> /**
- * @param OldClass|null $age
+ * @param NewClass|null $age
- * @return OldClass
+ * @return NewClass
  */</code></pre>
<h2 id="So-Much-Complexity">So Much Complexity!</h2>
<p>You're probably wondering, <strong>why is it so hard to change one node in a docblock?</strong> It is only hard if we try to hard-code solution for every single node.</p>
<p>In reality, there are ~40 classes that inherit from <code>PHPStan\PhpDocParser\Ast\Node</code>. We would have to add a check for every single of it, if it has a type, nested typed in some property, and so on.</p>
<h2 id="What-about-Node-Traverser">What about Node Traverser?</h2>
<p>Instead, we could use the same principle as php-parser - <strong>a node traverser</strong> with <strong>node visitors</strong>.</p>
<p>Do you hear about it the first time? Think of it as an analogy to event dispatcher:</p>
<ul>
<li><code>NodeTraverser</code> ~= <code>EventDisptacher</code></li>
<li><code>NodeVisitor</code> ~= <code>EventSubscriber</code></li>
</ul>
<p><br></p>
<ul>
<li>1 NodeTraverser has many NodeVisitors</li>
<li>1 EventDispatcher has many EventSubscribers</li>
</ul>
<p><br></p>
<ul>
<li>EventSubscribers is waiting for a specific event to happen</li>
<li>NodeVisitor is waiting for a specific node to come</li>
</ul>
<h2 id="The-Real-Code">The Real Code</h2>
<p>In reality, we should run the traverse on <code>PhpDocNode</code> to get the result:</p>
<pre><code class="language-php">use Symplify\Astral\PhpDocParser\PhpDocNodeTraverser;

$phpDocNodeTraverser = new PhpDocNodeTraverser();
$phpDocNodeTraverser-&gt;traverse($phpDocNode);

// that's it</code></pre>
<p>Oh, we forgot to add the <code>NodeVisitor</code>:</p>
<pre><code class="language-php">use PHPStan\PhpDocParser\Ast\Node;
use PHPStan\PhpDocParser\Ast\Type\IdentifierTypeNode;
use Symplify\Astral\PhpDocParser\PhpDocNodeVisitor\AbstractPhpDocNodeVisitor;

final class FirstNodeVisitor extends AbstractPhpDocNodeVisitor
{
    public function enterNode(Node $node) : ?Node
    {
        // here we make clear, what node we're looking for
        if (! $node instanceof IdentifierTypeNode) {
            // null = nothing happen, the original node remains untouched
            return null;
        }

        if ($node-&gt;name !== 'int') {
            return null;
        }

        // replace the "int" with "string"
        return new IdentifierTypeNode('string');
    }
}</code></pre>
<p>Now we only add <code>FirstNodeVisitor</code> to <code>PhpDocNodeTraverser</code> ↓</p>
<pre><code class="language-php">use Symplify\Astral\PhpDocParser\PhpDocNodeTraverser;

$firstNodeVisitor = new FirstNodeVisitor();

$phpDocNodeTraverser = new PhpDocNodeTraverser();
$phpDocNodeTraverser-&gt;addPhpDocNodeVisitor($firstNodeVisitor);
$phpDocNodeTraverser-&gt;traverse($phpDocNode);

// that's better</code></pre>
<p>That's it! <strong>Now every single &quot;int&quot; is turned into &quot;string&quot;</strong>, even in complex doblocks like these:</p>
<pre><code class="language-php">/**
 * @var array{string, Iterable&lt;int, int&gt;}
 */</code></pre>
<h2 id="How-Does-it-Work-Magic-Revealed">How Does it Work? Magic Revealed</h2>
<p>The logic is crazy simple - again, credit goes to Nikita Popov, who created the <a href="https://github.com/nikic/PHP-Parser/blob/master/lib/PhpParser/NodeTraverser.php">NodeTraverser</a> in php-parser.</p>
<p>The <code>PhpDocNodeTraverser</code> goes through <strong>every public property</strong> of that node (see <a href="https://github.com/symplify/symplify/blob/58ee4f76a7373b3ae44e4ad608aea5dae5c9b63c/packages/simple-php-doc-parser/src/PhpDocNodeTraverser.php#L52-L83">the responsible method</a> on Github).</p>
<p>That means if the <code>ReturnTagValueNode</code> enters, it will go through there:</p>
<pre><code class="language-php">$returnTagValueNode-&gt;type
$returnTagValueNode-&gt;description</code></pre>
<p>If <code>$returnTagValueNode-&gt;type</code> is node, it will go through all its public properties etc.</p>
<p><br></p>
<p>Making properties public is a convention in both phpdoc-parser and php-parser, so we can 100 % rely on it.</p>
<p><br></p>
<p>Now you know: <strong>how to rename the old class to the new class?</strong></p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/how-to-traverse-phpdoc-and-modify-it</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 29 Mar 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/how-to-traverse-phpdoc-and-modify-it#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Astral - The Best Kit for php-parser AST Developers ]]></title>
                <link>https://tomasvotruba.com/blog/astral-the-best-kit-for-php-parser-ast-developers</link>
                <description><![CDATA[ <p>Working with php-parser abstract syntax tree is fun. You can modify <a href="https://github.com/rectorphp/php-parser-nodes-docs">any node</a> in the tree, change class method names or add new arguments.
<br><br>
Such work requires <strong>abstract and <a href="/blog/2018/09/13/your-brain-is-your-garden/">deeply focused thinking</a></strong>. But sometimes, all we need is to get a method call name or constant value. That's completely different detailed nitpicking boring thinking...
<br><br>
That's where <strong>Astral package helps</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <blockquote class="blockquote text-center mb-5">
    Keeping simple changes in code,<br>
    simple in AST as well.
</blockquote>
<h2 id="Supports-native-php-Rector-and-PHPStan">Supports native php, Rector and PHPStan</h2>
<p>The <a href="https://github.com/symplify/astral">Astral package</a> works for your php-parser code, Rector rules, and PHPStan rules too.</p>
<pre><code class="language-bash">composer require symplify/astral</code></pre>
<p><strong>A. For PHPStan</strong>, include the config in <code>phpstan.neon</code>:</p>
<pre><code class="language-yaml">includes:
    - vendor/symplify/astral/config/services.neon</code></pre>
<p>We use this package in <a href="/blog/2020/12/14/new-in-symplify-9-more-than-110-phpstan-rules/">symplify/phpstan-rules</a> quite extensively.</p>
<p><br></p>
<p><strong>B. For your own php-parser code or Rector rule</strong>, add Symfony container with Bundle:</p>
<pre><code class="language-php">// config/bundles.php
return [
    Symplify\Astral\Bundle\AstralBundle::class =&gt; ['all' =&gt; true],
];</code></pre>
<p>Now we have the package installed, so how can we use it in real code?</p>
<h2 id="1-Get-Node-Name">1. Get Node Name</h2>
<p>Let's say we have this input code we want to process with AST:</p>
<pre><code class="language-php">$someMethod-&gt;someCall(100);</code></pre>
<p>We want to:</p>
<ul>
<li>get the name of the method call</li>
<li>and argument value</li>
<li>change the value if it is lower than 50</li>
</ul>
<p><br></p>
<p>How can we get a node name in native php-parser? Usually, we have an input method that already passes the node we work with:</p>
<pre><code class="language-php">use PhpParser\Node\Expr;
use PhpParser\Node\Expr\MethodCall;
use PhpParser\Node\Expr\Variable;

final class SomeRule
{
    public function resolveNames(MethodCall $methodCall): array
    {
        if ($methodCall-&gt;name instanceof Expr) {
            return [];
        }

        $methodName = $methodCall-&gt;name-&gt;toString();

        if ($methodCall-&gt;var instanceof Variable) {
            return [];
        }

        /** @var Variable $methodCallVariable */
        $methodCallVariable = $methodCall-&gt;var;
        if (! $methodCallVariable-&gt;name instanceof Expr) {
            return [];
        }

        $methodCallerVariableName = (string) $methodCallVariable-&gt;name;

        return [$methodName, $methodCallerVariableName];
    }
}</code></pre>
<p>Good, now we have names of variable and the method name:</p>
<ul>
<li><code>$methodName</code> → <code>"someCall"</code></li>
<li><code>$methodCallerVariableName</code> → <code>"someMethod"</code></li>
</ul>
<p>We haven't even started to write our AST logic, but the code is already pretty complicated. Could we do any better?</p>
<p><br></p>
<p><strong>How does the same logic look with Astral?</strong></p>
<pre><code class="language-php">use PhpParser\Node\Expr\MethodCall;
use Symplify\Astral\Naming\SimpleNameResolver;

final class SomeRule
{
    public function __construct(
        // PHP 8.0 promoted property syntax
        private SimpleNameResolver $simpleNameResolver
    ) {
    }

    public function resolveNames(MethodCall $methodCall): array
    {
        $methodName = $this-&gt;simpleNameResolver-&gt;getName($methodCall-&gt;name);
        $methodCallerVariableName = $this-&gt;simpleNameResolver-&gt;getName($methodCall-&gt;var);

        return [$methodName, $methodCallerVariableName];
    }
}</code></pre>
<p>No boiler plate code, overly safe check for <code>Expr</code> or node type. The <code>getName()</code> just gets the name or <code>null</code> if it's not possible, e.g. for magical naming:</p>
<pre><code class="language-php">$someMethod-&gt;{$someMethodName}(100);</code></pre>
<p>Make use of other method that save you some work:</p>
<pre><code class="language-php">$this-&gt;simpleNameResolver-&gt;isName($node, 'someExpectedName');
$this-&gt;simpleNameResolver-&gt;isNames($node, ['assertTrue', 'assertFalse']);

// useful for PHPStan class name
$this-&gt;simpleNameResolver-&gt;getClassNameFromScope($scope);</code></pre>
<p>And so on.</p>
<h2 id="2-Get-Node-Value">2. Get Node Value</h2>
<p>While writing rules for Rector or PHPStan, we need to know the exact values of the argument. E.g., here we want to get <code>100</code>.</p>
<pre><code class="language-php">$someMethod-&gt;someCall(100);</code></pre>
<p>How can we get the 1st argument value of our method call with plain php-parser?</p>
<pre><code class="language-php">use PhpParser\Node\Expr\MethodCall;
use PhpParser\Node\Scalar\LNumber;
use PhpParser\Node\Scalar\String_;
use PHPStan\Node\Constant\ClassConstantFetch;

final class SomeRule
{
    public function resolveFirstArgumentValue(MethodCall $methodCall)
    {
        if (count($methodCall-&gt;args) &lt; 1) {
            return null;
        }

        $firstArgValue = $methodCall-&gt;args[0]-&gt;value;
        if ($firstArgValue instanceof LNumber) {
            return $firstArgValue-&gt;value;
        }

        if ($firstArgValue instanceof String_) {
            return $firstArgValue-&gt;value;
        }

        if ($firstArgValue instanceof ClassConstantFetch) {
            // ..
        }

        // ...
    }
}</code></pre>
<p>You get the idea. We have to also account for non-direct known values like these:</p>
<pre><code class="language-php">private const LIMIT = 100;

$someMethod-&gt;someCall(self::LIMIT);</code></pre>
<p><strong>How does Astral help here?</strong></p>
<pre><code class="language-php">use PhpParser\Node\Expr\MethodCall;
use Symplify\Astral\NodeValue\NodeValueResolver;

final class SomeRule
{
    public function __construct(
        private NodeValueResolver $nodeValueResolver
    ) {

    }
    public function resolveFirstArgumentValue(MethodCall $methodCall)
    {
        if (count($methodCall-&gt;args) &lt; 1) {
            return null;
        }

        $firstArgValue = $methodCall-&gt;args[0]-&gt;value;
        // the 2nd argument is current file path, so Astral can resolve magical constants like __DIR__
        // it is available in both Rector/PHPStan via $scope-&gt;getFile()
        return $this-&gt;nodeValueResolver-&gt;resolve($firstArgValue, __FILE__);
    }
}</code></pre>
<p>Straightforward and simple. The <code>NodeValueResolver</code> can deal with constant references to another class, with magical <code>__DIR__</code> or with <code>SomeClass::class</code> references.</p>
<h2 id="3-Change-the-Node">3. Change the Node</h2>
<p>Now we put all three parts together to demonstrate the real power of Astral. <strong>We already know that simple operations in AST are very hard to write</strong>. AST is a low-level language that has to account for various errors.</p>
<p>How to change node in pure php-parser? It's a topic so extensive it would make a standalone post. Fortunately, there is one. I wrote <a href="/blog/2017/11/06/how-to-change-php-code-with-abstract-syntax-tree/">How to change PHP code with Abstract Syntax Tree</a> 3 years ago. Beware, it's a lot of code simple method rename.</p>
<p><br></p>
<p>Here we'll use the handy Astral service <code>SimpleCallableNodeTraverser</code>. It's typical to be used in Rector rules, where we need to traverse deeper into nodes.</p>
<p><strong>Enough theory, let the code talk:</strong></p>
<pre><code class="language-php">use PhpParser\Node;
use PhpParser\Node\Expr\MethodCall;
use PhpParser\Node\Scalar\LNumber;
use PhpParser\Node\Stmt\Class_;
use Symplify\Astral\Naming\SimpleNameResolver;
use Symplify\Astral\NodeTraverser\SimpleCallableNodeTraverser;
use Symplify\Astral\NodeValue\NodeValueResolver;

final class SomeRule
{
    public function __construct(
        private NodeValueResolver $nodeValueResolver,
        private SimpleNameResolver $simpleNameResolver,
        private SimpleCallableNodeTraverser $simpleCallableNodeTraverser,
    ) {
    }

    // here we traverse class, and we want to process method calls inside it
    public function process(Class_ $class)
    {
        $this-&gt;simpleCallableNodeTraverser-&gt;traverseNodesWithCallable($class, function (Node $node) {
            if (! $node instanceof MethodCall) {
                return null;
            }

            return $this-&gt;processMethodCall($node);
        });
    }

    private function processMethodCall(MethodCall $methodCall): ?Node
    {
        // with early return techinque, we skip all the nodes that does not match our needs
        if (! $this-&gt;simpleNameResolver-&gt;isName($methodCall-&gt;name, 'someCall')) {
            return null;
        }

        // we need at least 1 argument
        if (! count($methodCall-&gt;args) &lt; 1) {
            return null;
        }

        $argValue = $methodCall-&gt;args[0]-&gt;value;
        $value = $this-&gt;nodeValueResolver-&gt;resolve($argValue, __FILE__);
        if (! is_int($value)) {
            return null;
        }

        // is the value lower than 50? skip it
        if ($value &lt;= 50) {
            return null;
        }

        // replaced with 100
        $methodCall-&gt;args[0]-&gt;value = new LNumber(100);
        return $methodCall;
    }
}</code></pre>
<p>That's it!</p>
<p><br></p>
<h2 id="Rule-of-the-Thumb">Rule of the Thumb</h2>
<p>Too much to absorb? I agree. Let's keep it simple - the most useful service is <code>SimpleNameResolver</code>. Try it next time you'll be writing the Rector rule, PHPStan rule, or extension. You'll be surprised how much boilerplate code you can save. Your code will be cleaner and easier to read.</p>
<p>There is a couple of Astral features we haven't check yet. They're all in <a href="https://github.com/symplify/astral">README</a>.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/astral-the-best-kit-for-php-parser-ast-developers</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 22 Mar 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/astral-the-best-kit-for-php-parser-ast-developers#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Never Forget Symfony Config Options Again ]]></title>
                <link>https://tomasvotruba.com/blog/never-forget-symfony-config-options-again</link>
                <description><![CDATA[ <p>Have you switched your Symfony configs from <strong>stringy YAML to typed PHP</strong>? If not, <a href="/blog/2020/07/27/how-to-switch-from-yaml-xml-configs-to-php-today-with-migrify/">do it now</a>. Here is <a href="/blog/2020/07/16/10-cool-features-you-get-after-switching-from-yaml-to-php-configs/">at least 10 reasons why</a>.
Only then you'll start to notice a code smell that was there in every YAML configs.
<br><br>
Just now, the code smell is too smelly to ignore.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Let's look at the Symfony FrameworkBundle extension configuration. Where can we configure them? In <code>config/packages</code> directory.</p>
<h2 id="1-Poor-YAML">1. Poor YAML</h2>
<p>This is how it looks in YAML:</p>
<img src="https://user-images.githubusercontent.com/924196/110402064-ff265600-807a-11eb-98ab-d0b35dff0108.gif" class="img-thumbnail">
<p>What is the name of the key? Secret, secrets...? We don't know, and we only copy-paste from Symfony Documentation.</p>
<h2 id="2-Plain-PHP">2. Plain PHP</h2>
<p>So how does this <a href="/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock/">memory-lock</a> change with PHP?</p>
<img src="https://user-images.githubusercontent.com/924196/110402071-02214680-807b-11eb-894b-48830713fecf.gif" class="img-thumbnail">
<p>No, we can <strong>the code smell</strong> is banging us to our eyes:</p>
<ul>
<li>In YAML, we're used to be very active because we have to type everything manually and correctly. One extra space or indent, and the whole file will crash.</li>
<li>In PHP, we're used to IDE take care of us. When we start typing &quot;Ent...&quot;, we expect the IDE to autocomplete <code>EntityManagerInterface</code> and add use import at the top of the file.</li>
</ul>
<p>What is the code smell in a config? We don't have to autocomplete for the option name. <strong>The option names are always the same</strong>, one might say &quot;constant,&quot; and can be found in <a href="https://symfony.com/doc/current/reference/configuration/framework.html">Symfony documentation</a>:</p>
<img src="https://user-images.githubusercontent.com/924196/110402547-e0748f00-807b-11eb-9d4b-a7638a5cad52.png" class="img-thumbnail">
<p>But I don't want to memory 50 words per Symfony config. I want to code ambitious Rector rules that will remove &quot;legacy&quot; from our vocabulary. If only there was something like IDE but for Symfony configs...</p>
<h2 id="3-Smart-PHP-with-Amnesia">3. Smart PHP with Amnesia</h2>
<img src="https://user-images.githubusercontent.com/924196/110402065-00578300-807b-11eb-8811-7c87e2d134d6.gif" class="img-thumbnail">
<p>Instead of typing strings from the back of your memory, make use of <code>Symplify\Amnesia\ValueObject\Symfony\Extension\FrameworkExtension</code> constants.</p>
<p><br></p>
<p>There is constant class for <code>TwigExtension</code>:</p>
<img src="https://user-images.githubusercontent.com/924196/110403043-b96a8d00-807c-11eb-897d-52241af2f939.png" class="img-thumbnail">
<p><br></p>
<p>Also for Doctrine - <code>DoctrineExtension</code>, with <code>ORM</code> and <code>DBAL</code> classes:</p>
<img src="https://user-images.githubusercontent.com/924196/110403041-b8d1f680-807c-11eb-9767-ddf6a8631594.png" class="img-thumbnail">
<p>Pretty cool, right? We don't have to care about string and documentation reference because <strong>all configuration options are defined in the place we need them</strong>. <a href="https://blog.codinghorror.com/the-just-in-time-theory/">Just in time</a>.</p>
<p><br></p>
<p>Don't forget to add <a href="https://github.com/symplify/amnesia">Amnesia</a> to your project:</p>
<pre><code class="language-bash">composer require symplify/amnesia</code></pre>
<p>And that's it!</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/never-forget-symfony-config-options-again</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 15 Mar 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/never-forget-symfony-config-options-again#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ A Tool that helps you to Migrate to ECS ]]></title>
                <link>https://tomasvotruba.com/blog/tool-that-helps-you-to-migrate-to-ecs</link>
                <description><![CDATA[ <p>Do you want to use ECS but still stuck on an older coding standard tool? I wrote a post <a href="/blog/2018/06/04/how-to-migrate-from-php-code-sniffer-to-easy-coding-standard/">how to migrate from PHP_CodeSniffer</a> and <a href="/blog/2018/06/07/how-to-migrate-from-php-cs-fixer-to-easy-coding-standard/">from PHP-CS-Fixer</a>.
<br><br>
But who has time to read the step-by-step manual and do manual work? Nobody. That's why today, we'll look at a tool that <strong>will handle the migration to ECS for you</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>More and more projects I worked with wanted to try ECS, but they didn't want to look at every rule in XML and write them in PHP. I helped the first 3 to do manually and guide them on differences in configuration and rule naming. It was daunting work.</p>
<p>Are you interested <strong>in what way is ECS better</strong>? Check the mentioned posts:</p>
<ul>
<li><a href="/blog/2018/06/04/how-to-migrate-from-php-code-sniffer-to-easy-coding-standard">ECS vs PHP_CodeSniffer</a></li>
<li><a href="/blog/2018/06/07/how-to-migrate-from-php-cs-fixer-to-easy-coding-standard">ECS vs PHP-CS-Fixer</a></li>
</ul>
<p><br></p>
<p>When I was about to migrate 4th <code>phpcs.xml</code>, I didn't want to repeat copy-pasting, adding fully qualified names from dots, and so on. Some of you know from <a href="https://stars.github.com/profiles/tomasvotruba/">GitHub Stars profile</a>, that this physically hurts me more than most people.</p>
<p>Luckily, I had to <a href="https://twitter.com/VotrubaT/status/1368894569853648900">go the toilet</a>. Suddenly I realized:</p>
<blockquote class="blockquote text-center">
"If I can do it, so can PHP tool"
</blockquote>
<p>That's how <strong><a href="https://github.com/symplify/sniffer-fixer-to-ecs-converter">Sniffer/Fixer to ECS Converter</a></strong> was born. The tool does what its name says.</p>
<h2 id="2-Steps-to-Migrate-Your-Config">2 Steps to Migrate Your Config</h2>
<ol>
<li>Install the package</li>
</ol>
<pre><code class="language-bash">composer require symplify/sniffer-fixer-to-ecs-converter --dev</code></pre>
<ol start="2">
<li>Run the <code>convert</code> command</li>
</ol>
<p><strong>Migrate PHP_CodeSniffer config</strong></p>
<pre><code class="language-bash">vendor/bin/sniffer-fixer-to-ecs-converter convert phpcs.xml</code></pre>
<p><strong>Migrate PHP-CS-Fixer config</strong></p>
<pre><code class="language-bash">vendor/bin/sniffer-fixer-to-ecs-converter convert .php_cs.dist</code></pre>
<p>In both cases, a new config <code>converted-ecs.php</code> was created.</p>
<p><br></p>
<p>Now you can verify the config by running ECS.</p>
<pre><code class="language-bash">composer require symplify/easy-coding-standard --dev
vendor/bin/ecs check --config converted-ecs.php</code></pre>
<p>If all is good, rename this config to <code>ecs.php</code> and remove your old config + tool from <code>composer.json</code>. Then you're ready to go.</p>
<p>That's it!</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/tool-that-helps-you-to-migrate-to-ecs</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 08 Mar 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/tool-that-helps-you-to-migrate-to-ecs#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ The Best Time to Switch Gitlab to GitHub ]]></title>
                <link>https://tomasvotruba.com/blog/best-time-to-switch-gitlab-to-github</link>
                <description><![CDATA[ <p>I'm known for using GitHub, a true paradise for any open-source project. But I don't have much experience with private projects pricing for this and other services like GitLab or Bitbucket.
<br>
<br>
I assumed they all were at a similar price layer. After today's call with one of my clients, I've learned about one benefit of GitHub Actions for private projects I didn't consider before. <strong>So much it's worth the switch.</strong></p> ]]></description>
                <content:encoded><![CDATA[ <p>Let's take typical arguments why Gitlab CI is not better than GitHub, one by one.</p>
<h2 id="1-GitLab-has-Much-more-Features-than-GitHub">1. GitLab has Much more Features than GitHub</h2>
<p>When we compare CI services, this is one of the typical arguments for Gitlab. I find it as useful as this: &quot;This manual has 100x more pages. It must be better&quot;.</p>
<p>Honestly, I have trouble finding simple settings like total CI minutes, so I have to call Honza and get mentoring on navigation. That's not how a product should work. GitHub is growing on the features too. They also put effort into improving DX/UX, so these features are easy to use.</p>
<h2 id="2-GitLab-has-More-Advanced-CI">2. GitLab has More Advanced CI</h2>
<p>This statement used to be true when the only CI GitHub had was Travis - an external service that got popular mainly thanks to the free tier for open-source projects.</p>
<p>GitHub introduced a new CI service <a href="https://github.blog/changelog/2018-10-16-github-actions-limited-beta/">in late 2018</a>. I recall it did not seems useful to me because most of the configuration happened in Javascript. Can you imagine configuring your Symfony services config in Javascript? I don't.</p>
<p>But they switched to YAML as well and, as a bonus, added open-source storage for &quot;Workflows&quot;. Think of it <strong>as a composer package for your CI</strong>. Do you want to publish your project via SSH? No need to learn how it works in detail and risk security breaches by invalid configuration. Just use SSH Workflow and complete needed ENV variables.</p>
<p>That was a breaking point for me to give GitHub Actions a try and switch all my open-source projects <a href="/blog/2020/01/27/switch-travis-to-github-actions-to-reduce-stress/">from Travis to GitHub</a>.</p>
<h2 id="3-GitLab-has-Faster-CI">3. GitLab has Faster CI</h2>
<p>I'm not sure how about 2019 and before because I was not using GitHub.
Actions yet. We run GetRector.org on Gitlab in 2018 because Gitlab had better Docker support in CI... and it had a CI :)</p>
<p>Since the switch from Travis/Gitlab to GitHub Actions, we've experienced much faster CI reactions. When a new commit was pushed on the former, it took 20-40 seconds until the CI server noticed. But on GitHub Actions, it's a matter of 5-10 seconds. That's blazing fast.</p>
<p><a href="https://github.com/JanMikes">Honza Mikes</a> explained it to me: it might be related to Microsoft Azure. Since Azure and GitHub both belong to Microsoft, they probably have an internal bridge with priority speed. Corporation co-operation well done :)</p>
<h2 id="4-GitLab-is-Cheaper-than-GitHub">4. GitLab is Cheaper than GitHub</h2>
<p>This used to be true back in 2015 when GitLab allowed unlimited private repositories to an unlimited amount of users. That was a game changed, as GitHub had this as paid service. I recall that was a massive spike in developer interest on Twitter just because of this exclusive feature.</p>
<p>As time went by and both companies grew, GitHub introduced private repositories for free too.</p>
<p><a href="https://techcrunch.com/2021/01/26/gitlab-reshuffles-its-paid-subscription-plans/">In January 2021 <strong>Gitlab introduced new pricing</strong></a>. Before we get into that, I came across post about similar topic back from 2018 - <a href="https://mlaccetti.medium.com/how-gitlab-will-lose-business-bea8fb2f0fd4">How #GitLab Will Lose Business</a>. Quoting:</p>
<blockquote class="blockquote">
    When we got the license in 2017, it was roughly $3.25/user/mo (billed annually, works out to be $39) ... this year ... it would be $19/user/mo (billed annually, works out to be $228) — a 585% increase!
</blockquote>
<p>But today, pricing is about something different.</p>
<h2 id="5-2020-It-s-all-About-CI-Minutes-Baby">5. 2020: It's all About CI Minutes, Baby</h2>
<p>During consulting, I teach companies to switch positions with their CI. It's not rare that in smaller companies with up to 15 devs, the CI is set up once for a particular job, but no-one knows how to use it practically. Everyone is trying to make a build pass. That's it.</p>
<p>Instead, <strong>the CI should be a helpful buddy</strong>, that you can delegate any tedious works - from updated, from finding bugs... to checking that new pricing has been released, and next month it will cost you much more :).</p>
<p>We had few bugs with renamed classes and constant outside PHP in one project, usually too late or after a detailed code-review. Twig, Latte, NEON of YAML always had to be checked manually. That's such a waste of human attention and energy. Today, we don't know about these bugs because CI is taking care of them.</p>
<p><br></p>
<p>Saying that, <strong>the more we delegate to CI, the more minutes we spend</strong>. The more population Earth has, the more food we eat, even if we focus on optimizations like cached Container Builds. This reflects the pricing models of both services.</p>
<p>Do you recall how much time do you spend in your CI per pull-request run? How much is that a day... or a month?</p>
<p>From my personal experience, basic CI setup with two developers took around <strong>2000-5000 minutes a month</strong>. Both services have a limit of 3000 minutes/month for one-tier. If you cross it, you have to pay more or stop using it.</p>
<p>But that's <strong>just bare setup</strong>. Once we add:</p>
<ul>
<li>monorepo split</li>
<li>template checks</li>
<li>config checks</li>
<li>translation validation</li>
<li><a href="/blog/2020/12/14/new-in-symplify-9-more-than-110-phpstan-rules/">custom PHPStan rules</a></li>
<li>automated <a href="/blog/2020/12/28/why-coding-standards-should-not-be-part-of-ci/">coding standard merging</a></li>
<li>or Rector run...</li>
</ul>
<p>...we can easily get over 10 000-15 000 minutes month.</p>
<p><br></p>
<p>Now the interesting parts comes. Let's compare compare <a href="https://github.com/pricing">GitHub pricing</a> and <a href="https://about.gitlab.com/pricing/">GitLab pricing</a> from today:</p>
<img src="https://user-images.githubusercontent.com/924196/110146332-b9e3f900-7dda-11eb-99fd-9ffb500095fc.png" class="img-thumbnail mb-2">
<p><em>Gitlab pricing</em></p>
<p><br></p>
<img src="https://user-images.githubusercontent.com/924196/110146328-b94b6280-7dda-11eb-97a2-332bbc0fd8f0.png" class="img-thumbnail mb-2">
<p><em>GitHub pricing</em></p>
<p><br></p>
<p>If we take it by the best price per minute:</p>
<ul>
<li>3 000 minutes/4 $ from GitHub</li>
<li>10 000 minutes/19 $ from Gitlab</li>
<li><strong>50 000 minutes/21 $ from GitHub</strong></li>
<li>50 000 minutes/99 $ from Gitlab</li>
</ul>
<p>For only 2 $, you get 40 000 extra minutes. That's madness, and that's the last why you should switch.</p>
<p><br></p>
<p>I think GitHub might take advantage of this an go from <em>21 $</em> to <em>69 $</em> without loosing an advantage. But it seems their product does not focus on profit, but <strong>on us - customers</strong>:</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">In a world where rich companies take more and more, this is an amazing move by <a href="https://twitter.com/github?ref_src=twsrc%5Etfw">@github</a> <br><br>Thank you for taking whole open-source community to a brand new level for last 5 years ❤️️<br><br>I'm very happy to be one of your customers <a href="https://t.co/RbtpdA9s9W">pic.twitter.com/RbtpdA9s9W</a></p>— Tomas Votruba (@VotrubaT) <a href="https://twitter.com/VotrubaT/status/1360353684396380171?ref_src=twsrc%5Etfw">February 12, 2021</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p><br></p>
<h2 id="The-Best-of-Both-Worlds">The Best of Both Worlds</h2>
<p>These 2 services are back and forth in a fight over customers, and that's great. Healthy competition between 2 companies brings value to everyone - motivation for the company to grow, new features to the users, and innovations in the field.</p>
<p>I'm delighted to have experienced GitHub and Gitlab on both open-source and private projects and see their struggle for a better product.</p>
<p><br></p>
<p>Do you want to switch from GitLab/Travis/Bitbucket to GitHub? Are you afraid of too high learning costs? <a href="/contact/">Hire me</a> to get it done fast.</p>
<p>Are you standing behind Gitlab even with its pricing? Let me know in the comments why.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/best-time-to-switch-gitlab-to-github</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 01 Mar 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/best-time-to-switch-gitlab-to-github#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ It&#039;s not Null, it&#039;s Enum ]]></title>
                <link>https://tomasvotruba.com/blog/its-not-null-null-its-enum</link>
                <description><![CDATA[ <p>Last weekend I got into reading a good old post <a href="https://afilina.com/null-hell">Null Hell</a> by Afilina, a fellow legacy archeologist. Null parameters are evil, which turns code into &quot;maybe&quot; and &quot;just in case&quot; conditions with ifs everywhere.
<br><br>
I was wondering how difficult it is to get rid of nullable parameters in a project. I made myself a challenge: <strong>get rid of nullable params over the weekend</strong>. This is what happened.</p> ]]></description>
                <content:encoded><![CDATA[ <blockquote class="blockquote text-center">
    "Complain about the way other people make software
    <br>
    by making software."
</blockquote>
<p>This post will be a hands-on brain insight, how I practically code step by step. I'll share my inner thoughts as they come by.</p>
<h2 id="1-Set-a-Goal">1. Set a Goal</h2>
<p>Symplify is a monorepo of <a href="https://github.com/symplify/symplify">~40 split packages</a>. The goal is to remove as many nullable parameters as possible.</p>
<p>What is a nullable parameter? A params like these in any custom method or function:</p>
<pre><code class="language-php">function run(
    ?string $param,
    string $optionalParam = null,
    string|null $unionParam
) {
}</code></pre>
<p>That's for theory.</p>
<h2 id="2-Prepare-PHPStan-Rule">2. Prepare PHPStan Rule</h2>
<p>In Symplify, before we start to apply any &quot;just-made-up&quot; rule I've read or heard somewhere, we have to <strong>formalize it first</strong>. With PHP code, that means &quot;write a PHPStan rule for that&quot;.</p>
<p><br></p>
<p>Why is this step necessary for success? When you read a post about <a href="/blog/2019/01/24/how-to-kill-parents">&quot;every class should be final&quot;</a>, you might think that's a good idea. It's easy to get hyped in software, so you try to put <code>final</code> everywhere in your code right from Monday. Soon, your project has <code>final</code> in some classes that you worked with. Your colleagues are not hyped yet, and you also broke few Doctrine entities by making them <code>final</code>. Your argument is not very trustworthy now, and people don't like to keep the rule that doesn't have clear boundaries.</p>
<p><br></p>
<p>By writing a <strong>PHPStan rule first, we avoid this whole mess</strong>. Also, we realize the ideal statements like &quot;every <em>x</em> should be <em>y</em>&quot; have to be adapted into practical coding habits. While I was writing a <code>ForbiddenNullableParameterRule</code> I learned that:</p>
<ul>
<li>nullable <code>$param</code> required by <code>interface</code> from <code>/vendor</code> - we should skip these because refactoring the world is not a weekend goal</li>
<li>we need to forbid specific types first to keep refactoring gradually</li>
<li>we need to allow some types to keep refactoring gradually</li>
</ul>
<p>We integrated these criteria into the rule itself, and after a couple of hours of coding and testing, it was ready to become part of our CI.</p>
<h2 id="3-Make-PHPStan-rule-part-of-CI">3. Make PHPStan rule part of CI</h2>
<p>The PHPStan rule must run in CI. There is no excuse. I've seen a couple of projects where they used PHPStan, had their own PHPStan rules, but they were missing in <code>phpstan.neon</code>.</p>
<p>Let's avoid that mistake:</p>
<pre><code class="language-yaml">services:
    -
        class: Symplify\PHPStanRules\Rules\ForbiddenNullableParameterRule
        tags: [phpstan.rules.rule]
        arguments:
            forbiddenTypes:
                - ...
            allowedTypes:
                - ...</code></pre>
<p>We run PHPStan, and... it reported 130 cases. Yay! That's a doable number of PHPStan errors for a weekend job. If it would be 300+, we'd tune the <code>forbiddenTypes</code> and <code>allowedTypes</code> parameters until the number fits under a hundred.</p>
<p>There is no point in stressing yourself or ignoring everything. Refactoring should be fun!</p>
<h2 id="4-Remove-the-Null-Parameter">4. Remove the <code>Null</code> Parameter</h2>
<p>Let's look at one typical example that could be spot on many places:</p>
<img src="/assets/images/posts/2021/priority_enum.gif" class="img-thumbnail">
<p>First step would be to remove the <code>?</code>:</p>
<pre><code class="language-diff">-public function sort(array $changes, ?string $priority): array
+public function sort(array $changes, string $priority): array
 {
     // ...
 }</code></pre>
<p>We've removed the nullable parameter - mission complete! All we need to do now is to fix dozens of new PHPStan errors.</p>
<p>I realized that <code>?string</code> is a code smell for enum only in hindsight, but I started to be suspicious.</p>
<p>I looked into code and tests for the values that the <code>$priority</code> argument can take. To my surprise, they were the same values over and over again:</p>
<pre><code class="language-php">$this-&gt;sort($changes, 'packages');

$this-&gt;sort($changes, 'categories');

$this-&gt;sort($changes, null);</code></pre>
<p>It seems the priority was chosen or not. If we put this sentence in the code:</p>
<pre><code class="language-diff">-$this-&gt;sort($changes, null);
+$this-&gt;sort($changes, 'none');</code></pre>
<p>But should we use strings around the project without any boundaries?</p>
<h2 id="5-Extract-the-Enum">5. Extract the Enum</h2>
<p>No. There should be at least constants:</p>
<pre><code class="language-diff">-$this-&gt;sort($changes, 'packages');
+$this-&gt;sort($changes, PackageCategoryPriority::PACKAGES);

-$this-&gt;sort($changes, 'categories');
+$this-&gt;sort($changes, PackageCategoryPriority::CATEGORIES);

-$this-&gt;sort($changes, null);
+$this-&gt;sort($changes, PackageCategoryPriority::NONE);</code></pre>
<p>I've extracted three repeated values to a standalone class:</p>
<pre><code class="language-php">namespace Symplify\ChangelogLinker\ValueObject;

/**
 * @enum
 */
final class PackageCategoryPriority
{
    /**
     * @var string
     */
    public const CATEGORIES = 'categories';

    /**
     * @var string
     */
    public const PACKAGES = 'packages';

    /**
     * @var string
     */
    public const NONE = 'none';
}</code></pre>
<p>Note: the <code>@enum</code> docblock is a marker for PHP 8.1 Rector rule that will be able to refactor it to native <code>enum</code>.</p>
<p><br></p>
<p>In the end, a single detected enum helped us <strong>to remove nullable on ~30 places</strong> with a single refactoring.</p>
<pre><code class="language-diff">-public function sort(array $changes, ?string $priority): array
+public function sort(array $changes, string $priority): array
 {
-    if ($priority === null) {
+    if ($priority === PackageCategoryPriority::NONE) {
     }
     // ...
 }</code></pre>
<p>Now we can repeat a similar process for the other nullables. If you get stuck, you can find inspiration in <a href="https://github.com/symplify/symplify/pull/2977/files">Symplify PR, where we cleaned all 130 cases</a>.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/its-not-null-null-its-enum</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 22 Feb 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/its-not-null-null-its-enum#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How Dangerous is Your Nette Template Assign ]]></title>
                <link>https://tomasvotruba.com/blog/2021/02/15/how-dangerous-is-your-nette-template-assign</link>
                <description><![CDATA[ <p>Symfony documentation contains a few <a href="https://matthiasnoback.nl/2014/10/unnecessary-contrapositions-in-the-new-symfony-best-practices/">&quot;best practices&quot; that teach people to create bad code</a>. It's important to talk about them so the framework can improve and thus its community can improve. Do you remember GitHub discussions about autowiring before it became part of Symfony?
<br><br>
Nette documentation is no different. <strong>Today, we'll look at configuring templates and how to use them better and safer</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="What-is-the-Main-Purpose-of-Template">What is the Main Purpose of Template?</h2>
<p>What should a template engine do? Render some content to an end-user. Sometimes, it can be a static page; sometimes, there can be parameters. But fundamentally, that's it. Anything else is just fancy syntax sugar.</p>
<p>Let's look at a simple template example:</p>
<pre><code class="language-html">I'll give 10 Bitcoins to people in need</code></pre>
<p>Hmm, maybe the number will change. Let's make a parameter out of it:</p>
<pre><code class="language-php">$bitcoinCount = 10;</code></pre>
<pre><code class="language-html">&lt;!-- templates/giveaway.latte --&gt;
I'll give {$bitcoinCount} Bitcoins to people in need</code></pre>
<p>That was easy!</p>
<p><br></p>
<p>Are you curious about how other frameworks handle simple rendering? Me too!</p>
<p><br></p>
<p><a href="https://book.cakephp.org/4/en/controllers.html#rendering-a-view"><strong>CakePHP 4</strong></a></p>
<pre><code class="language-php">public function giveaway()
{
    $this-&gt;set('bitcoinCount', 100);
    return $this-&gt;render('templates/giveaway');
}</code></pre>
<p><br></p>
<p><a href="https://www.yiiframework.com/doc/guide/2.0/en/structure-views#rendering-views"><strong>Yii 2</strong></a></p>
<pre><code class="language-php">public function giveaway()
{
    return $this-&gt;render('giveaway', [
        'bitcoinCount' =&gt; 100,
    ]);
}</code></pre>
<p><br></p>
<p><a href="https://laravel.com/docs/8.x/controllers#basic-controllers"><strong>Laravel 8</strong></a></p>
<pre><code class="language-php">public function giveaway()
{
    return view('giveaway', [
        'bitcoinCount' =&gt; 100
    ]);
}</code></pre>
<p><br></p>
<p><a href="https://symfony.com/doc/current/templates.html#creating-templates"><strong>Symfony 5</strong></a></p>
<pre><code class="language-php">public function giveaway()
{
    return $this-&gt;render('templates/giveaway.twig', [
        'bitcoinCount' =&gt; 100
    ]);
}</code></pre>
<p><br></p>
<p>And <a href="https://doc.nette.org/en/3.1/components#toc-rendering"><strong>Nette 3.1</strong></a></p>
<pre><code class="language-php">public function render(): void
{
    $this-&gt;template-&gt;bitcoinCount = 100;
    $this-&gt;template-&gt;render(__DIR__ . '/templates/giveaway.latte');
}</code></pre>
<p><br></p>
<p>What do they have in common?</p>
<ul>
<li>every approach is using some name or absolute path as <strong>template identifier</strong></li>
<li>the template identifier is passed <strong>first argument of &quot;render&quot; method</strong></li>
</ul>
<p>But how are parameters handled? There are 2 groups:</p>
<ul>
<li>parameter can be set <strong>anywhere above</strong> the &quot;render&quot; method</li>
<li>parameters are passed <strong>exactly once</strong> into the &quot;render&quot; method</li>
</ul>
<p>The 2nd approach is far better than 1st one. Could you guess <strong>9 reasons why</strong>?</p>
<h2 id="1-Variable-Override-Bug">1. Variable Override Bug</h2>
<p>Why don't we use public properties? Because they can be overridden anywhere without us knowing:</p>
<pre><code class="language-php">final class Product
{
    public $price;
}</code></pre>
<p>We have at least setters that we can somehow monitor:</p>
<pre><code class="language-php">final class Product
{
    private $price;

    public function changePrice($price)
    {
        $this-&gt;price = $price;
    }
}</code></pre>
<p>You might be thinking - why would anyone make such a rookie mistake? I assure you, <strong>this is one the most hated bug in legacy code</strong>. Single variable change can take days or weeks to find out... if you have to go through 2 500 000 lines of code, you see for the first time.</p>
<p>Private property and change methods are still crappy though:</p>
<pre><code class="language-php">$product = new Product();

$product-&gt;changePrice(100);

// 1000 lines bellow

$product-&gt;changePrice(10);</code></pre>
<p>So after many years of tears we learned to <strong>use a constructor, where we require the values that cannot be changed</strong>:</p>
<pre><code class="language-php">final class Product
{
    public function __construct(
        private $price
    ) {
    }
}</code></pre>
<p>How is this related to <code>$this-&gt;template</code>? The same way we can break <code>Product</code> price, we can break <code>$this-&gt;template</code> parameters:</p>
<pre><code class="language-php">public function render(): void
{
    $this-&gt;template-&gt;bitcoinCount = 100;

    // 1000 lines bellow

    $this-&gt;template-&gt;bitcoinCount = 10;

    $this-&gt;template-&gt;render(__DIR__ . '/templates/giveaway.latte');
}</code></pre>
<p>Or more evil example:</p>
<pre><code class="language-php">public function render(): void
{
    $this-&gt;template-&gt;bitcoinCount = 100;

    $this-&gt;sendNotification();

    $this-&gt;template-&gt;render(__DIR__ . '/templates/giveaway.latte');
}

// 1000 lines bellow

private function sendNotification(): void
{
    // oh, someone needs to do little unrelated change here
    $this-&gt;template-&gt;bitcoinCount = 10;
}</code></pre>
<p>What is the <code>$bitcoinCount</code>? <code>10</code> or <code>100</code>? It depends on the <code>$this-&gt;template</code> override mechanism, I guess.</p>
<p>❌</p>
<h2 id="2-Call-Me-Maybe">2. Call Me... Maybe</h2>
<p>With property access like this, we can define parameters... just sometimes:</p>
<pre><code class="language-php">public function render(): void
{
    if ($this-&gt;inGoodMood) {
        $this-&gt;template-&gt;bitcoinCount = 100;
    }

    $this-&gt;template-&gt;render(__DIR__ . '/templates/giveaway.latte');
}</code></pre>
<p>Quick quiz: <strong>what is the <code>$bitcoinCount</code> value in the template?</strong></p>
<ul>
<li><code>false</code></li>
<li><code>null</code></li>
<li>nothing, use <code>isset()</code> to check if exists</li>
<li>nothing, use <code>empty()</code> to check if exists</li>
</ul>
<p>❌</p>
<h2 id="3-Unset-or-Nullable-Variable">3. Unset or Nullable Variable?</h2>
<p>This bug build on previous weakness. Let's say we have a <a href="https://afilina.com/null-hell">null-hell</a> nullable return:</p>
<pre><code class="language-php">private function getBitcoinCount(): ?int
{
    // ...
}</code></pre>
<p>How can we differentiate between variable set to <code>null</code>...</p>
<pre><code class="language-php">$this-&gt;template-&gt;bitcoinCount = $this-&gt;getBitcoinCount();</code></pre>
<p>...and variable that is missing?</p>
<pre><code class="language-php">if ($this-&gt;inGoodMood) {
    $this-&gt;template-&gt;bitcoinCount = $this-&gt;getBitcoinCount();
}</code></pre>
<p>❌</p>
<h2 id="4-Forgotten-Require-Variable">4. Forgotten Require Variable</h2>
<p>The example above would also fail, because the <code>{$bitcoinCount}</code> is required in template:</p>
<pre><code class="language-html">&lt;!-- templates/giveaway.latte --&gt;
I'll give {$bitcoinCount} Bitcoins to people in need</code></pre>
<p>How can you <strong>define what is required variable</strong>? In objects and services, we have <code>__construct()</code> for that, but here?</p>
<p>❌</p>
<h2 id="5-Two-Ways-to-do-One-Thing">5. Two Ways to do One Thing</h2>
<img src="/assets/images/posts/2021/two_thing_one.jpg" class="img-thumbnail mt-4 mb-2">
<p>Let's say we manage to set variable once in the template. Many months later, a new developer learns about 2nd <code>render()</code> parameters and uses them:</p>
<pre><code class="language-diff"> public function render(): void
 {
     $this-&gt;template-&gt;bitcoinCount = 100;

-    $this-&gt;template-&gt;render(__DIR__ . '/templates/giveaway.latte');
+    $this-&gt;template-&gt;render(__DIR__ . '/templates/giveaway.latte', [
+        'bitcoinCount' =&gt; 10
+    ]);
 }</code></pre>
<p>What is the final template we'll see?</p>
<ul>
<li>A. <code>I'll give 100 Bitcoins to people in need</code></li>
<li>B. <code>I'll give 10 Bitcoins to people in need</code></li>
</ul>
<p>❌</p>
<h2 id="6-Read-It">6. Read It!</h2>
<p>As with any other public property, we can read it and modify it:</p>
<pre><code class="language-php">public function render(): void
{
    $this-&gt;template-&gt;bitcoinCount = 100;

    if ($this-&gt;template-&gt;bitcoinCount &gt; 100) {
        $this-&gt;template-&gt;bitcoinCount += 10;
    }
}</code></pre>
<p>Soon we're using <code>$this-&gt;template</code> for any variable operation.</p>
<p>❌</p>
<h2 id="7-Killing-Known-Types">7. Killing Known Types</h2>
<p>We know that type of <code>100</code> is <code>int</code>, so do PHPStan, PHPStorm, and Rector. But once we set it to magical <code>$this-&gt;template</code>, everybody becomes blind:</p>
<pre><code class="language-php">public function render(): void
{
    $this-&gt;template-&gt;bitcoinCount = 100;

    // condition is always true... but who knows?
    if (is_int($this-&gt;template-&gt;bitcoinCount)) {
        // ...
    }
}</code></pre>
<p>❌</p>
<h2 id="8-Making-Magic-more-Magical">8. Making Magic more Magical</h2>
<p>With Nette 3.0, there has been an attempt to fix the magic with <a href="https://blog.nette.org/en/latte-how-to-use-type-system">typed template objects</a>. The intention to have a typed template is good, but it adds more magic to rendering.</p>
<p>The <code>$this-&gt;template</code> is not a service anymore, but a value object. That can hold parameters. And also render itself somehow. That's typical example of <strong><a href="https://en.wikipedia.org/wiki/Active_record_pattern">active record anti-pattern</a></strong>. Are you able to give birth yourself? <strong>Not a way to go.</strong></p>
<p>❌</p>
<p>There is a better way to have both <strong>typed template</strong> and <strong>pass parameters just once</strong>. I'll write about it soon - stay tuned.</p>
<h2 id="9-Typos-Everywhere">9. Typos Everywhere</h2>
<p>Could you guess, what will happen here?</p>
<pre><code class="language-php">public function render(): void
{
    $this-&gt;template-&gt;bitcoinCount = 100;

    if ($this-&gt;template-&gt;bitcointCount &gt; 10) {
        $this-&gt;template-&gt;bitcoinCount -= 10;
    }

    // ...
}</code></pre>
<p>The condition is obviously a <code>true</code>, right?</p>
<p>Well, the second variable <em>bitcoin<strong>t</strong>Count</em> does not exists, so we're now <code>-10</code> bitcoints.</p>
<p>❌</p>
<h2 id="Back-to-Basics">Back to Basics</h2>
<p>There is one more surprise. How does <a href="https://latte.nette.org/en/guide#toc-installation-and-usage">Latte documentation</a> look like? <strong>It promotes the clear approach!</strong></p>
<pre><code class="language-php">$latte = new Latte\Engine;

$latte-&gt;render('template.latte', [
    'items' =&gt; ['one', 'two', 'three']
]);</code></pre>
<p>So why is every presenter and component using it wrong? Because Occam's razor - people <strong>tend to pick the first solution they see and use it everywhere</strong>.</p>
<h2 id="The-Correct-Way-to-Render-Templates-With-Parameters">The Correct Way to Render Templates With Parameters</h2>
<p>What if there is a way to avoid all 7 possible bugs above? Like we don't have enough bug potential in our code-bases.</p>
<p>I know you've already guessed it, but just to Google can find it too. The correct way to render parameters is to <strong>pass them exactly once</strong> as 2nd parameter of <code>render()</code> method:</p>
<pre><code class="language-php">public function render(): void
{
    $this-&gt;template-&gt;render(__DIR__ . '/templates/giveaway.latte', [
        'bitcoinCount' =&gt; 10
    ]);
}</code></pre>
<p>Do we work with a value above the render? <strong>Use a variable</strong> to separate templating system from business logic:</p>
<pre><code class="language-php">public function render(): void
{
    $bitcoinCount = $this-&gt;getBitcoinCount();
    if ($bitcoinCount === null) {
        $bitcoinCount = self::MINIMUM_REQUIRED_AMOUNT;
    }

    $this-&gt;template-&gt;render(__DIR__ . '/templates/giveaway.latte', [
        'bitcoinCount' =&gt; $bitcoinCount,
    ]);
}</code></pre>
<p>Do we need an optional parameter? <strong>Such code smell</strong> suggests our template architecture is wrong:</p>
<ul>
<li>Maybe there should be an extra component?</li>
<li>Maybe the parameter should be required and have a value of <code>0</code>?</li>
</ul>
<p><br></p>
<p>Do you have more magical objects like this one? Please get rid of them before they get rid of your sanity. Now you have nine reasons why :)</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2021/02/15/how-dangerous-is-your-nette-template-assign</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 15 Feb 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2021/02/15/how-dangerous-is-your-nette-template-assign#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Tree Coding vs. Bush Coding ]]></title>
                <link>https://tomasvotruba.com/blog/2021/02/11/tree-coding-vs-bush-coding</link>
                <description><![CDATA[ <p>How does circular reference look like? It is a point where you wait for your doctor; they wait for a state to accept the vaccine, and the state waits on people like you to come to the doctor. <strong>Who has the responsibility?</strong> Who can change the state?
<br><br>
In the past, we used singletons and static calls to get anything anywhere instantly. But soon, we got into the circular references trap. Now <strong>we moved to dependency injection</strong> and this problem does not exist anymore... or does it?</p> ]]></description>
                <content:encoded><![CDATA[ <p>With dependency injection, dependencies grow naturally into the form of a tree:</p>
<pre><code class="language-php">final class VaccineRepository
{
    public function __construct(
        private Connection $connection
    ) {
    }

    public function get(int $id): Vaccine
    {
        return $this-&gt;connection-&gt;getFromTable('vaccine', $id);
    }
}</code></pre>
<p>Then we use the repository inside a controller:</p>
<pre><code class="language-php">final class DoctorController
{
    public function __construct(
        private VaccineRepository $vaccineRepository
    ) {
    }

    public function helpPerson(Person $person, int $vaccineId)
    {
        $vaccine = $this-&gt;vaccineRepository-&gt;get($vaccineId);
        $vaccine-&gt;injectInto($person);
        // ...
    }
}</code></pre>
<p>The dependency tree is clear and obvious:</p>
<ul>
<li><code>Controller</code> uses ↓
<ul>
<li><code>Repository</code> uses ↓
<ul>
<li><code>Connection</code> uses ↓
<ul>
<li>PostgreSQL database uses ↓
<ul>
<li>PostgreSQL Docker image</li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<p><br></p>
<h2 id="Why-Tree">Why Tree?</h2>
<p>The significant advantage of trees is that they grow strong and tall. They're robust and can produce a lot of branches and leaves to rise to the sun. The sun gives them more energy to grow even further. A typical example of tree coding is dependency injection.</p>
<div class="text-center">
    <img src="/assets/images/posts/2021/tree_vs_bush.jpg" class="img-thumbnail mt-4 mb-2">
    <br>
    <em>Tree Coding vs Bush Coding</em>
</div>
<h2 id="Why-Bush">Why Bush?</h2>
<p>At first sight, a bush grows much faster than a tree. Its goal is to grow as many leaves as possible in a short time. It does not care about the future as much as a tree.
A typical example of bush coding is static method calls and static classes.</p>
<p><br></p>
<h2 id="Power-of-Tree-Coding">Power of Tree Coding</h2>
<p>Tree coding is similar to <a href="/blog/2018/04/30/programming-climbing-a-huge-mountain/">climbing a huge mountain</a>. Let's focus on the basic idea:</p>
<h3 id="What-is-The-Goal-of-Tree-Coding">What is The Goal of Tree Coding?</h3>
<ul>
<li>It has a <strong>clear hierarchy</strong> from the bottom up, as you have guessed from dependency injection over static calls</li>
<li><strong>Single place for single responsibility</strong>
<ul>
<li>Need a new leaf? Put it on a branch with access to the Sun</li>
<li>Need a new branch? Put it next to another branch, where is enough space</li>
<li>Need a new tree trunk? Plant a new tree</li>
</ul></li>
<li><strong>It's intuitive</strong> - everybody knows putting a branch inside a leaf is a bad idea</li>
<li>It respects <strong><a href="https://softwareengineering.stackexchange.com/a/187462/148956">principle of least astonishment</a></strong></li>
</ul>
<p><a href="https://www.slideshare.net/GiovanniScerra/thoughtful-software-design"></p>
<img src="/assets/images/posts/2021/principal_of_least_astonishment.jpg" class="img-thumbnail mt-4 mb-2">
<p></a></p>
<p><br></p>
<p>But bushes tend to spread faster, so it's only natural to assume they're already in your code. <strong>Slowly growing and waiting for their time to slow you down</strong>.</p>
<img src="/assets/images/posts/2021/bushes_everywhere.jpg" class="img-thumbnail">
<p>I have come around some bushes in my code before:</p>
<ul>
<li><a href="/blog/2018/04/26/how-i-got-into-static-trap-and-made-fool-of-myself">How I Got into Static Trap and Made Fool of Myself</a></li>
<li><a href="/blog/2019/04/01/removing-static-there-and-back-again">Removing Static - There and Back Again</a></li>
</ul>
<p><br></p>
<p>Today we look on 3 more examples that can be easily missed while slowly poluting your code:</p>
<h2 id="1-Service-Inside-Value-Object">1. Service Inside Value Object</h2>
<p>By value object, we talk about any entity, value object, or data transfer object. Anything that can be created multiple times, like vaccines.</p>
<pre><code class="language-php">final class Vaccine
{
    public function __construct(
        private string $uuid,
        private float $volume
    ) {
    }

    public function getShotVolume(int $shotRank): float
    {
        // ...
    }
}</code></pre>
<p>How do we create a vaccine? Let's build a factory:</p>
<pre><code class="language-php">$vaccineFactory = new VaccineFactory();
$vaccine = $vaccineFactory-&gt;create();</code></pre>
<p>Pretty straight-forward, right?</p>
<p><br></p>
<p>Later that year, there is a big pressure on pharmaceutical companies, so programmers are under huge pressure to deliver. The vaccine object is now a bit more powerful:</p>
<pre><code class="language-php">$vaccine-&gt;orderNewOne();
$vaccine-&gt;vaccinateHuman($human);
$vaccine-&gt;vaccinateAnimal($animal);</code></pre>
<p>Our simple vaccine with a basic method is now <strong>powerful service locator</strong> that can vaccinate itself and order itself. It's like <strong>giving birth to yourself</strong>.</p>
<p>❌</p>
<p>What happened? In a factory, someone had an idea to put the services right into vaccine itself:</p>
<pre><code class="language-diff"> final class Vaccine
 {
     public function __construct(
         private string $uuid,
         private float $volume,
+        private VaccinatingService $vaccinatingService,
+        private OrderingService $orderingService,
    ) {
    }
 }</code></pre>
<p>That's not a way to go.</p>
<h3 id="How-to-Refactor">How to Refactor?</h3>
<p>It can happen to anyone. I'm aware of 3 such places in Rector itself that we plan to refactor. What can we do about it?</p>
<p>Let's refactor service from the object...</p>
<pre><code class="language-diff"> final class Vaccine
 {
     public function __construct(
         private string $uuid,
         private float $volume,
-        private VaccinatingService $vaccinatingService,
-        private OrderingService $orderingService,
    ) {
    }
 }</code></pre>
<p>...to service using the object:</p>
<pre><code class="language-diff">+$orderingService = new OrderingService();
+$vaccinatingService = new VaccinatingService();

-$vaccine-&gt;orderNewOne();
+$orderingService-&gt;order($vaccine, 100);

-$vaccine-&gt;vaccinateHuman($human);
+$vaccinatingService-&gt;vaccinate($human);

-$vaccine-&gt;vaccinateAnimal($animal);
+$vaccinatingService-&gt;vaccinate($animal);</code></pre>
<p>✅</p>
<h2 id="2-Trait-adding-Dependency">2. Trait adding Dependency</h2>
<p>Let's stay with a vaccine from previous example. We got into the same problem:</p>
<pre><code class="language-php">$vaccine-&gt;orderNewOne();
$vaccine-&gt;vaccinateHuman($human);
$vaccine-&gt;vaccinateAnimal($animal);</code></pre>
<p>But the constructor seems correct:</p>
<pre><code class="language-php">final class Vaccine
{
    public function __construct(
        private string $uuid,
        private float $volume
    ) {
    }
}</code></pre>
<p>What is going on?</p>
<pre><code class="language-php">final class Vaccine
{
    use SomeHelperTrait;
}</code></pre>
<p>Hm... what is that?</p>
<pre><code class="language-php">trait SomeHelperTrait
{
    /**
     * In Symfony
     * @required
     */
    public OrderingService $orderingService;

    /**
     * In Nette
     * @inject
     */
    public VaccinatingsService $vaccinatingsService;
}</code></pre>
<p>Oh, so it's using frameworks (Nette/Symfony) dependency injection to add dependencies... how <del>smart</del> bush coding!</p>
<p>❌</p>
<p>To be honest, I put similar crap code into Rector. Shame on me. It took <a href="https://github.com/rectorphp/rector/pull/5385">bunch</a> <a href="https://github.com/rectorphp/rector/pull/5466">of</a> <a href="https://github.com/rectorphp/rector/pull/5383">pull</a> <a href="https://github.com/rectorphp/rector/pull/5384">request</a> to get rid of completely.</p>
<h3 id="How-to-Refactor">How to Refactor?</h3>
<p>The same way as the example above. Get rid of traits...</p>
<pre><code class="language-diff"> final class Vaccine
 {
-    use SomeHelperTrait;
 }</code></pre>
<p>...and use services to handle the service work:</p>
<pre><code class="language-php">$orderingService = new OrderingService();
$vaccinatingService = new VaccinatingService();

$orderingService-&gt;order($vaccine, 100);
$vaccinatingService-&gt;vaccinate($human);
$vaccinatingService-&gt;vaccinate($animal);</code></pre>
<p>✅</p>
<p>After this incident, we <a href="https://github.com/symplify/phpstan-rules/blob/master/docs/rules_overview.md#notraitrule">forbid trait completely</a> with PHPStan.</p>
<h2 id="3-Using-Nette-Template-to-Transfer-Data">3. Using Nette Template to Transfer Data</h2>
<p>Last but not least, there are template objects. It about any object that magically <strong>sets its variables on the fly</strong>:</p>
<pre><code class="language-php">$someObject = new stdClass;
$someObject-&gt;name = 'Maybe' + 'Some';
$someObject-&gt;age = '100';</code></pre>
<p>It's common to use these on unknown JSON response, but here <strong>these variable names (&quot;name&quot;, &quot;age&quot;) and their values are known</strong>.</p>
<p><br></p>
<p>I don't think Symfony or Laravel have those, but it's a typical code from Nette controller:</p>
<pre><code class="language-php">use Nette\Application\UI\Presenter;

final class DoctorPresenter extends Presenter
{
    public function renderInstructions()
    {
        $this-&gt;template-&gt;welcomeHere = '...';
        $this-&gt;template-&gt;waitingRoom = '...';
    }
}</code></pre>
<p>The <code>$template</code> is a base template object that holds assigned variables magically. Instead of a service locator, we have <strong>a variable locator</strong> (not good).
This simple construction of 2 variables is ok, but it will grow to a dirty bug.</p>
<p><br></p>
<p>To give you a comparison, this is how Symfony handles the problem:</p>
<pre><code class="language-php">use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;

final class DoctorController extends AbstractController
{
    public function renderInstructions()
    {
        $this-&gt;render(__DIR__ . '/template/doctor/instructions.twig', [
            'welcomeHere' =&gt; '...',
            'waitingRoom' =&gt; '...',
        ]);
    }
}</code></pre>
<p>We pass parameters into template <strong>exactly once</strong>, at <strong>the time where it's needed</strong>. Not sooner, not later, <a href="https://blog.codinghorror.com/the-just-in-time-theory/">just in time</a>, also called JIT.</p>
<p>Not twice by accident:</p>
<pre><code class="language-php">$this-&gt;template-&gt;welcomeHere = '...';

// 100 lines bellow or in another method called
$this-&gt;template-&gt;welcomeHere = 'no';

// which is used?</code></pre>
<p>...and not maybe:</p>
<pre><code class="language-php">if ($this-&gt;isOpened) {
    $this-&gt;template-&gt;welcomeHere = '...';
}</code></pre>
<p><br></p>
<p>Still, so far, that is framework convention it works well when used correctly.</p>
<p><strong>But what is not forbidden is allowed.</strong> We can use the object for reading the data:</p>
<pre><code class="language-php">use Nette\Application\UI\Presenter;

final class DoctorPresenter extends Presenter
{
    public function renderInstructions()
    {
        $this-&gt;template-&gt;welcomeHere = '...';

        if ($this-&gt;template-&gt;welcomeHere === '...') {
            $this-&gt;template-&gt;welcomeHere .= PHP_EOL. 'Thank you!';
        }
    }
}</code></pre>
<p>This is very bad idea:</p>
<ul>
<li>
<p>we depend on <code>$this-&gt;template-&gt;welcomeHere</code> to <strong>be set somewhere above</strong> - how do you even check if magic property is set?</p>
<pre><code class="language-php">if (isset($this-&gt;template-&gt;welcomeHere) &amp;&amp; $this-&gt;template-&gt;welcomeHere !== null) {
$this-&gt;template-&gt;welcomeHere .= PHP_EOL . 'Thank you!';
}</code></pre>
</li>
<li>
<p>we knew we assigned type of <code>string</code>, but <strong>magic made the type disappear</strong></p>
</li>
<li>
<p>we have no idea what the type is, <strong>static analysis and Rector does not work</strong></p>
</li>
<li>
<p>we're promoting to use a magical object for anything in <code>render()</code> methods</p>
</li>
<li>
<p>we're saying it's ok <strong>to set a single variable twice in one method</strong></p>
</li>
</ul>
<p>❌</p>
<h3 id="How-to-Refactor">How to Refactor?</h3>
<p>How can we get out of this bush? It's simpler than the two examples before. What would you do?</p>
<p>Use a variable, of course.</p>
<pre><code class="language-diff">-$this-&gt;template-&gt;welcomeHere = '...';
+$welcomeHere = '...';

-if ($this-&gt;template-&gt;welcomeHere === '...') {
+if ($welcomeHere === '...') {
-    $this-&gt;template-&gt;welcomeHere .= PHP_EOL. 'Thank you!';
+    $welcomeHere .= PHP_EOL. 'Thank you!';
-}

+$this-&gt;template-&gt;welcomeHere = $welcomeHere;</code></pre>
<p>This way we:</p>
<ul>
<li>use a variable for a <em>variable</em> content (a content that might change and we expect it to change)</li>
<li><strong>we separate a templating system from the construction of parameters</strong></li>
<li>we have a type of <code>string</code>, so does PHPStan and Rector</li>
<li>and if we know the template parameters types... we can... wait, that's a topic for another post</li>
</ul>
<p>✅</p>
<p>We <a href="https://github.com/symplify/phpstan-rules/blob/master/docs/rules_overview.md#nonettetemplatevariablereadrule">made a rule for PHPStan</a> to keep an eye on us.</p>
<p><br></p>
<p>And that's it! Now we've refactored from <strong>3 ground floor bushes to high trees</strong>!</p>
<p><br></p>
<p>What was the hardest to spot bush coding you've met? How did you refactor it? Share in comments ↓</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2021/02/11/tree-coding-vs-bush-coding</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 11 Feb 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2021/02/11/tree-coding-vs-bush-coding#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Prepare your Neon Configs for PHP 8 and Make them More Readable ]]></title>
                <link>https://tomasvotruba.com/blog/2021/02/08/how-to-prepare-your-neon-config-for-php-8-and-make-them-more-readable</link>
                <description><![CDATA[ <p>Good coding habits share a single treat. <strong>They all are <del>resistant</del> fluid to future changes</strong>. You don't have to change them when new packages or PHP is released. One of them is explicit code.
<br>
<br>
Do you use explicit NEON config syntax? Then upgrade to PHP 8, including deprecations, will not touch you.
Do you use magic syntax sugar cream? Today we'll look at how to make it right.</p> ]]></description>
                <content:encoded><![CDATA[ <p>&quot;The OP neurons aligned in OD pattern suggest better space orientation empowered to MDS usage.&quot;</p>
<p>What is explicit text? A text that does not require Googling acronyms to understand it.</p>
<p><br></p>
<p>What is <strong>explicit code</strong>? A code that does not require documentation to understand.</p>
<h2 id="Have-you-Met-Magic">Have you Met... Magic?</h2>
<img src="https://imgs.xkcd.com/comics/tar.png" class="mt-4 mb-5">
<p>Could you guess what this line is? No Googling allowed! :)</p>
<pre><code class="language-yaml">services:
    - Aws\Client(['region'='western'])</code></pre>
<ul>
<li>A factory or a service?</li>
<li>Array of arguments or a single argument with an array?</li>
</ul>
<p><br></p>
<p>What about this one?</p>
<pre><code class="language-yaml">services:
    -
        factory: App\Some\Factory([KEY=%value%])</code></pre>
<ul>
<li>The array is an argument for the constructor of a factory?</li>
<li>Or parameters to the factory method?</li>
<li>The factory method... hm, probably <code>create()</code>?</li>
<li>Is the <code>KEY</code> an env variable?</li>
<li>Is <code>%value%</code> a parameter?</li>
</ul>
<p><br></p>
<p>Apart WTF readability and principle of highest surprise, there is a new problem since PHP 8.</p>
<h2 id="PHP-8-Named-Arguments-and-Optional-Parameter-Last">PHP 8 - Named Arguments and Optional Parameter Last</h2>
<p>This code used to be valid in PHP 7.4:</p>
<pre><code class="language-php">function foo($optional = null, $require)
{
}</code></pre>
<p>Since PHP 8, it is deprecated (see <a href="https://3v4l.org/PRo9Y">3v4l.org</a>).</p>
<p>The optional parameters <a href="https://php.watch/versions/8.0/deprecate-required-param-after-optional">must be <strong>after required</strong> parameters</a>, like this:</p>
<pre><code class="language-diff">-function foo($optional = null, $require)
+function foo($require, $optional = null)
 {
 }</code></pre>
<p>Don't worry about PHP code, Rector got <a href="https://github.com/rectorphp/rector/blob/master/docs/rector_rules_overview.md#optionalparametersafterrequiredrector">this case covered</a>. But what about all the NEON configs? If we <strong>change PHP code, the configs will break</strong> because they depend on the parameter order.</p>
<p>What about these &quot;named arguments&quot;? That might save us, but first, we have to untie this NEON spaghetti knot.</p>
<h2 id="1-Unwrap-Inlined-Services">1. Unwrap Inlined Services</h2>
<p>First, we need to untie these class + array single lines:</p>
<pre><code class="language-diff"> services:
-    - Aws\Client(['region'='western'])
+    -
+        class: Aws\Client
+        arguments:
+           - ['region'='western']</code></pre>
<h2 id="2-Use-Named-Arguments">2. Use Named Arguments</h2>
<p>Sometimes we have to look at the class constructor to be able to transform NEON correctly:</p>
<pre><code class="language-php">namespace Aws;

final class Client
{
    public function __construct(
        private array $configuration = [],
    ) {
        // ...
    }
}</code></pre>
<p>We see the argument is an <code>array</code> and is named <code>$configuration</code>. Let's use &quot;named argument&quot; in our NEON too:</p>
<pre><code class="language-diff"> services:
     -
         class: Aws\Client
         arguments:
-           - ['region'='western']
+           configuration: ['region'='western']</code></pre>
<p>Now, what happens if we add a new <strong>required argument</strong> to the constructor? But we can't add it after the optional argument in PHP 8. It will result in the argument order change!</p>
<pre><code class="language-diff"> namespace Aws;

 final class Client
 {
     public function __construct(
+        private SomeDependency $someDependency,
         private array $configuration = [],
     ) {
         // ...
     }
 }</code></pre>
<p>The code will still work thanks to named arguments ✅</p>
<h2 id="3-Unwrap-Inlined-Arrays">3. Unwrap Inlined Arrays</h2>
<p>Inlined arrays are confusing the same way the inlined services are. Let's get rid of them too while we're at it:</p>
<pre><code class="language-diff"> services:
     -
         class: Aws\Client
         arguments:
-            configuration: ['region'='western']
+            configuration:
+                region: 'western'</code></pre>
<p>There is also <code>{}</code> syntax for composed arrays. We can improve it too:</p>
<pre><code class="language-diff"> services:
     -
         class: App\SocialLogin
         arguments:
-            - { facebook: no, google: yes, twitter: no }
+            params:
+                facebook: no
+                google: yes
+                twitter: no</code></pre>
<h2 id="4-Remove-Implicit-Arguments">4. Remove Implicit Arguments</h2>
<p>Do you use a <code>...</code> syntax? That is a placeholder for &quot;complete autowired service here&quot;:</p>
<pre><code class="language-yaml">services:
    -
         class: App\Search
         arguments:
             - ...
             - ...
             - 'keys'</code></pre>
<p>With named arguments, this is no longer needed:</p>
<pre><code class="language-diff"> services:
     -
          class: App\Search
          arguments:
-             - ...
-             - ...
-             - 'keys'
+             type: 'keys'</code></pre>
<p>Also, the config became much more readable. Now we know that <code>'keys'</code> was used for a <code>type</code>.</p>
<p><br></p>
<p>Although named arguments were in NEON for a while, now our codebase is <strong>more consistent</strong>. The PHP with native named arguments and deprecated optional arguments first make the code base <strong>more robust</strong>.</p>
<p>The same rule that applies in NEON now applies in PHP. One <strong>less &quot;cool&quot; syntax sugar cream</strong> to learn and <strong>more space to focus on what matters to you</strong>.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2021/02/08/how-to-prepare-your-neon-config-for-php-8-and-make-them-more-readable</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 08 Feb 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2021/02/08/how-to-prepare-your-neon-config-for-php-8-and-make-them-more-readable#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Effective Debug Tricks: Narrow Scoping ]]></title>
                <link>https://tomasvotruba.com/blog/2021/02/01/effective-debug-tricks-narrow-scoping</link>
                <description><![CDATA[ <p>Writing code that only you work with is easy. Debugging such code is a bit harder. Writing code for someone else review is quite hard. The code must be understandable to the other reader to pass the code review.
<br><br>
How hard is reading code that someone else wrote three months ago?
<br>
<br>
But what about debugging code that someone wrote a year ago?</p> ]]></description>
                <content:encoded><![CDATA[ <p>Effective debugging is not about finding the responsible line, nor about fixing the bug.</p>
<p>Effective debugging is about <strong>getting to the minimal amount of code that is <em>probably</em> causing the error</strong> with the minimal energy invested.</p>
<h2 id="Why-it-s-important">Why it's important?</h2>
<p>When we report a bug in a project's issue tracker, we're usually interested in its fix. Why would we report if we don't care? <strong>The faster the bug gets fixed, the better for us</strong>, so we can continue with our original coding goal. We need <a href="/blog/2020/01/13/why-is-first-instant-feedback-crucial-to-developers">instant feedback</a> to stay in the flow.</p>
<p><br></p>
<p>Today we look at one technique that I use for open-source project reports and for teaching private projects to debug their legacy code with peace.</p>
<p>We also have it as a standard in Rector and Symplify projects. It saves us many hours wasted on issues tracker comment ping-pong and focuses on the cooperative solution.</p>
<p>You might notice it's similar to <em> the minimum common denominator</em> process that you probably know from 5th grade—what a powerful concept.</p>
<p><br></p>
<h2 id="Level-1-and-quot-There-is-a-bug-and-quot-report">Level 1: &quot;There is a bug&quot; report</h2>
<p>What will happen if we provide a report like this?</p>
<ul>
<li><em>The printing does not work. It ends with a fatal error.</em></li>
</ul>
<p><strong>What can the maintainer do?</strong> Can they fix the error and close the issue? Probably not, because there is no information about where to look first. So what will the maintainer do? They will ask us for more information:</p>
<ul>
<li><em>ask us about the exact fatal error message</em></li>
<li><em>ask us about stack trace with <code>--debug</code> or <code>-vvv</code> option in command line</em></li>
<li><em>ask us about the version we use, because maybe this bug got fixed on <code>master</code> 2 days ago already and the work would be duplicated</em></li>
</ul>
<hr />
<p>This interaction is a problem already because <strong>you've lost energy that you're willing to invest</strong> to report the bug and the <strong>maintainer lost energy that he/she is willing to put</strong> into narrow the scope of the bug.</p>
<p>It's like going to a mall, stopping right in front of the first door and shouting &quot;open the door&quot;. It will take a couple of minutes for security to get to you and figure out what you want. Why not just take the handle yourself? Good luck next time you'll report a robbery to them - the will to help will be a bit lowered, if not depleted.</p>
<hr />
<h2 id="Bugfix-Effectiveness">Bugfix Effectiveness</h2>
<p>Remember, the goal of reporting an issue is to invest as little energy from our side and maintainer's side and get the bug fixed at the same time.</p>
<p>The bugfix effectiveness formula states:</p>
<blockquote class="blockquote text-center">
    Bugfix Effectiveness = (Reporter Work + Maintainer Work) / 100
</blockquote>
<ul>
<li>
<p>If <em>BFE</em> &lt; 0.5, you have both more energy left to fix even more bugs ✅</p>
</li>
<li>
<p>If <em>BFE</em> &gt; 5, the issue will probably end up in stale of dozens of comments that never fix anything ❌</p>
</li>
</ul>
<p><br></p>
<p>So can we do it better for everyone?</p>
<h2 id="Level-2-and-quot-There-is-a-bug-with-this-full-message-and-quot-report">Level 2: &quot;There is a bug with this full message&quot; report</h2>
<p><em>The printing does not work, it ends with a fatal error.</em></p>
<p><em>Here is the output I got with <code>--debug</code>/<code>-vvv</code>:</em>
<em>...</em></p>
<p><em>I use Rector v0.9.4</em></p>
<p><br></p>
<p>Good job! We've just saved both ourselves and the maintainer a significant amount of energy. Now the maintainer knows <strong>what happens</strong> to use and how it looks like.</p>
<hr />
<p>Have you seen any detective movies lately? There is a murder, the detective arrives at the scene, and the first witness shows the body and location. That's what we just did in our issue report. &quot;Here is somebody dead, I saw him at 22:00&quot;. What happens next? The detective smiles, says thank you, and goes home... that would be weird, right? They always ask the same question:</p>
<ul>
<li>&quot;How did you get there?&quot;</li>
<li>&quot;Where were you before?&quot;</li>
<li>&quot;Do you know the person?&quot;</li>
<li>&quot;If so, what was the relationship to him/her?&quot;</li>
</ul>
<p>The detective is looking for prerequisites. They need this information about you to get a specific idea of how you fit the whole picture. Maybe you're innocent; maybe you're a murderer. They don't know, but they have to decide - so they ask.</p>
<hr />
<p>Could you figure out what the report is missing? Yes, <em>the prerequisites</em>.</p>
<p>We know what is wrong with your issue now. But the maintainer doesn't know, <strong>what did you do before that you got yourself into this state</strong>.</p>
<ul>
<li>What CLI command did you run?</li>
<li>What controller did you open in your browser?</li>
</ul>
<p><br></p>
<p>How can we do it better?</p>
<h2 id="Level-3-and-quot-I-did-this-then-this-happened-and-quot-report">Level 3: &quot;I did this, then this happened&quot; report</h2>
<p><em>I tried to run Rector on my project with this <code>rector.php</code></em></p>
<p><em>I used <code>vendor/bin/rector process p src</code></em></p>
<p><em>The printing does not work, it ends with a fatal error.</em>
<em>Here is the output I got with <code>--debug</code>/<code>-vvv</code>:</em></p>
<p><em>...</em></p>
<p><em>I use Rector v0.9.4</em></p>
<p><br></p>
<p><strong>Great job!</strong></p>
<p>Now both you and the maintainers know:</p>
<ul>
<li>what steps were made</li>
<li>what happened</li>
<li>what is the reported fatal error</li>
<li>where exactly the fatal error happened in the code</li>
</ul>
<p><br></p>
<p>Do you remember Bugfix Effectiveness Formula?</p>
<blockquote class="blockquote text-center">
    BFE = (Reporter Work + Maintainer Work) / 100
</blockquote>
<p>From level 1 to 3, we invested a lot of more energy on first issue reporting:</p>
<p>Level 1:</p>
<blockquote class="blockquote text-center">
<p>BFE = (20 + 380) / 100 = <strong>4.0</strong></p>
</blockquote>
<p>Level 3:</p>
<blockquote class="blockquote text-center">
<p>BFE = (40 + 160) / 100 = <strong>2.0</strong></p>
</blockquote>
<p>But because the maintainer doesn't have to ask us more questions and doesn't have to reply to them, we <strong>also increased the chance to get a bug fixed by ~100 %</strong>.</p>
<p><br></p>
<p>There is one more step that we found to be the most effective. <strong>It usually requires only one comment from the reporter and one reply from the maintainer</strong>. Well, if you count closing the issue with pull-request as a comment.</p>
<p>How can we do it better? Don't worry; it's not about learning project test conventions and sending a failing pull-request.</p>
<h2 id="Level-4-and-quot-I-did-exactly-this-then-this-happened-and-quot-report">Level 4: &quot;I did exactly this, then this happened&quot; report</h2>
<p>Let's look at the <strong>narrow scoping</strong>. What can we read from this report?</p>
<p><em>I tried to run Rector on my project with this <code>rector.php</code></em></p>
<p><em>I used <code>vendor/bin/rector process p src</code></em></p>
<ul>
<li>There are 1-INF rules and settings in <code>rector.php</code> and 1-INF files in the <code>/src</code> directory.</li>
<li>One of rule and one of file is causing a bug.</li>
</ul>
<p>The question is: <strong>what rule and what file is causing this bug?</strong></p>
<p>We need to narrow the scope of <code>INF * INF</code> to <code>1 * 1</code>. How can we do it?</p>
<h3 id="Half-Half-Cutting">Half-Half Cutting</h3>
<p>This technique can be applied to services, to PHPStan rules, to Rector rules, to a coding standard, to registered event subscribers... to anything. A similar algorithm is used to sort files in an array.</p>
<p>The idea is comment out half of the configuration, run the tool and see if the bug still remains:</p>
<pre><code class="language-diff"> use Rector\Config\RectorConfig;

 return function (RectorConfig $rectorConfig): void {
     $parameters = $containerConfigurator-&gt;parameters();
     $rectorConfig-&gt;importNames();

     $containerConfigurator-&gt;import(SetList::PHP_74);
     $containerConfigurator-&gt;import(SetList::PHP_80);
-    $containerConfigurator-&gt;import(SetList::CODE_QUALITY);
+//  $containerConfigurator-&gt;import(SetList::CODE_QUALITY);
-    $containerConfigurator-&gt;import(SetList::CODING_STYLE);
+//  $containerConfigurator-&gt;import(SetList::CODING_STYLE);
    ]);</code></pre>
<p>Is the bug still there? Remove the commended lines and repeated the half-commented/half-active process with the other half:</p>
<pre><code class="language-diff"> use Rector\Config\RectorConfig;

 return function (RectorConfig $rectorConfig): void {
     $rectorConfig-&gt;importNames();

     $rectorConfig-&gt;import(SetList::PHP_74);
-    $rectorConfig-&gt;import(SetList::PHP_80);
+//  $rectorConfig-&gt;import(SetList::PHP_80);
-    $rectorConfig-&gt;import(SetList::CODE_QUALITY);
-    $rectorConfig-&gt;import(SetList::CODING_STYLE);
 ]);</code></pre>
<p>Is the bug gone? It must be one of those commented sets, so comment out half of them and let the ofher half active:</p>
<pre><code class="language-diff"> use Rector\Config\RectorConfig;

 return function (RectorConfig $rectorConfig): void {
     $rectorConfig-&gt;importNames();

-    $rectorConfig-&gt;import(SetList::PHP_74);
-    $rectorConfig-&gt;import(SetList::PHP_80);
     $rectorConfig-&gt;import(SetList::CODE_QUALITY);
-    $rectorConfig-&gt;import(SetList::CODING_STYLE);
+//  $rectorConfig-&gt;import(SetList::CODING_STYLE);
 ]);</code></pre>
<p>This way, we discover quickly which exact set and which exact rule is causing the problem.</p>
<p><br></p>
<p>But, running <strong>the whole codebase to find out a single rule</strong> might take hours. How can we avoid it?
Let's apply narrow scoping on the filesystem first. Instead of running tool globally:</p>
<pre><code class="language-bash">vendor/bin/rector p src</code></pre>
<p>Let's run it only on one directory:</p>
<pre><code class="language-bash">vendor/bin/rector p src/Controllers</code></pre>
<p>Is it not there? Pick another directory:</p>
<pre><code class="language-bash">vendor/bin/rector p src/Repository</code></pre>
<p>Is it there? Bingo!</p>
<p><br></p>
<p>Then we can report all the information that the maintainer needs:</p>
<p><em>I tried to run Rector on my project with <code>rector.php</code></em></p>
<p><br></p>
<p><em>When I run <code>TypedPropertyRector</code> rule like this</em>:</p>
<p><em><code>vendor/bin/rector process p src/Repository/AbstractRepository.php</code></em></p>
<p><em>it fails with...</em></p>
<p>We just reached the most effective value:</p>
<blockquote class="blockquote text-center">
<p>BFE = (60 + 60) / 100 = <strong>1.2</strong></p>
</blockquote>
<p>Now we get <strong>4-times more bugs fixed</strong> then with level 1.
Thank you for reporting!</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2021/02/01/effective-debug-tricks-narrow-scoping</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 01 Feb 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2021/02/01/effective-debug-tricks-narrow-scoping#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 4 PHPStan Rules that Bring Order to Nette Injects ]]></title>
                <link>https://tomasvotruba.com/blog/2021/01/25/4-phpstan-rule-that-bring-order-to-nette-injects</link>
                <description><![CDATA[ <p>Do you have at least one <code>@inject</code> property or <code>inject*()</code> method in your Nette project? If no, stop reading and have fun with another post.
<br>
<br>
If you do, you probably have some internal rules where what and how to use them and where to avoid them. But how do you keep order?</p> ]]></description>
                <content:encoded><![CDATA[ <p>If you talk about your project's standards that everyone <em>should</em> follow, remember the old lazy programmer's saying:</p>
<blockquote class="blockquote text-center">
    "In CI,<br>
    or won't happen."
</blockquote>
<h2 id="Injection-Everywhere">Injection Everywhere?</h2>
<p>Using injection makes sense in some cases, like avoiding circular dependencies. Another use case is an abstract class with dozens of child classes, but mostly it's <a href="/blog/2020/06/01/inject-or-required-will-get-you-any-service-fast/">a killer for a healthy dependency tree</a>.</p>
<p>In a one <a href="https://nette.org/">Nette</a> project I worked on within the last five years, they had a very &quot;cool&quot; DI extension. A DI extension that enables <code>@inject</code> everywhere:</p>
<pre><code class="language-php">final class SomeClass
{
    /**
     * @var EventDispatcher
     * @inject
     */
    public $eventDispatcher;
}</code></pre>
<p>Why needs <code>__construct()</code>. right? Get PHP 8 promoted properties today.</p>
<blockquote class="blockquote text-center">
    "If it's not forbidden,<br>
    it's allowed."
</blockquote>
<p>Luckily, nowadays, we have a <a href="https://github.com/symplify/phpstan-rules">Symplify PHPStan rules</a> to help us.</p>
<h2 id="1-Do-Not-Combine-Nette-Inject-and-construct">1. Do Not Combine Nette Inject and <code>__construct()</code></h2>
<p>If there is a constructor already, there an exact working way to get dependencies:</p>
<pre><code class="language-php">class SomeClass
{
    private $someType;

    private $anotherType;

    public function __construct(AnotherType $anotherType)
    {
        $this-&gt;anotherType = $anotherType;
        // ...
    }

    public function injectSomeType(SomeType $someType)
    {
        $this-&gt;someType = $someType;
    }
}</code></pre>
<p>❌</p>
<p><br></p>
<p>It's better to use far cleaner <code>__construct()</code> inection:</p>
<pre><code class="language-php">class SomeClass
{
    private $someType;

    private $anotherType;

    public function __construct(AnotherType $anotherType, SomeType $someType)
    {
        $this-&gt;anotherType = $anotherType;
        $this-&gt;someType = $someType;
    }
}</code></pre>
<p>✅</p>
<p>Covered by <code>Symplify\PHPStanRules\Rules\NoNetteInjectAndConstructorRule</code> rule.</p>
<p><br></p>
<h2 id="2-Use-Single-Nette-inject-Method">2. Use Single Nette <code>inject*()</code> Method</h2>
<p>Using the <code>inject*()</code> method is an equal alternative to <code>@inject</code> property that does not require a property to be public.
It like an extra <code>__construct()</code> that is caller by the framework to set other dependencies.</p>
<p>Single <code>__construct()</code> has its meaning. Imagine this use case:</p>
<pre><code class="language-php">class SomeClass
{
    private $type;

    private $anotherType;

    public function injectOne(SameType $type)
    {
        $this-&gt;type = $type;
    }

    public function injectTwo(SameType $anotherType)
    {
        $this-&gt;anotherType = $anotherType;
    }
}</code></pre>
<p>❌</p>
<p>Having multiple <code>inject*()</code> methods allow us to <strong>accidentally put two dependencies</strong> in the same class. This has performance hit, maintenance hit, and duplicated parasitic code that needs our attention for no gain.</p>
<p><br></p>
<p>We can solve all this with a single <code>inject*()</code> method per class:</p>
<pre><code class="language-php">class SomeClass
{
    private $someType;

    public function injectSomeClass(SomeType $someType)
    {
        $this-&gt;someType = $someType;
    }
}</code></pre>
<p>✅</p>
<p>Covered by <code>Symplify\PHPStanRules\Rules\SingleNetteInjectMethodRule</code> rule.</p>
<p><br></p>
<h2 id="3-Validate-at-inject-Format">3. Validate <code>@inject</code> Format</h2>
<p>I'm proud to admit I made this bug last week. With IDE autocomplete, class annotations, and PHP 8 attributes, I'm removing my skill to type precisely the word:</p>
<pre><code class="language-php">class SomeClass
{
    /**
     * @injects
     * @var SomeDependency
     */
    public  $someDependency;
}</code></pre>
<p>...and the property was <code>null</code>.</p>
<p>❌</p>
<p><br></p>
<p>Let's not do that ever again and validate <strong>letter by letter</strong> of <code>@inject</code> annotation:</p>
<pre><code class="language-diff"> class SomeClass
 {
     /**
-     * @injects
+     * @inject
      * @var SomeDependency
      */
     public $someDependency;
}</code></pre>
<p>✅</p>
<p>Covered by <code>Symplify\PHPStanRules\Rules\ValidNetteInjectRule </code> rule.</p>
<h2 id="4-No-at-inject-on-final-Class">4. No <code>@inject</code> on <code>final</code> Class</h2>
<p>Last but not least, this rule finally put an order to our codebase.</p>
<p>A specific need for injects is an abstract class with a couple of children:</p>
<pre><code class="language-php">abstract class AbstractPresenter
{
}

final class ProductPresenter extends AbstractPresenter
{
}</code></pre>
<p><strong>Where would you allow injects?</strong></p>
<ul>
<li>in both classes</li>
<li>in children classes only</li>
<li>in abstract class only</li>
</ul>
<p><br></p>
<p>What would be the consequences:</p>
<ul>
<li><strong>In both classes?</strong> It's a mess that leads to injection hell. Would you get vaccinated against covid every week? No, so don't force your code to suffer either.</li>
<li><strong>In children classes only?</strong> Putting responsibility on every single child can be quite a challenge.</li>
<li><strong>In <code>abstract</code> class only?</strong> Well, a single parent with five children is quite a responsibility, but it's clear and one place to go in case of problems.</li>
</ul>
<p>The ideal options is 3). Using inject only abstract classes make children cleaner and less coupled to the framework. There are more children classes than abstract, so code base quality will be much higher if children classes are strict and clean.</p>
<pre><code class="language-php">final class ProductPresenter extends AbstractPresenter
{
    /**
     * @inject
     * @var AnotherDependency
     */
    public $anotherDependency;
}</code></pre>
<p>✅</p>
<p>Covered by <code>Symplify\PHPStanRules\Rules\NoInjectOnFinalRule</code> rule.</p>
<p><br></p>
<p>That's it for today. Try the rule one by one and run PHPStan to see how it helps your project:</p>
<pre><code class="language-bash">composer require symplify/phpstan-rules --dev</code></pre>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2021/01/25/4-phpstan-rule-that-bring-order-to-nette-injects</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 25 Jan 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2021/01/25/4-phpstan-rule-that-bring-order-to-nette-injects#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 4 Ways Symplify makes Working With Symfony More Fun ]]></title>
                <link>https://tomasvotruba.com/blog/2021/01/18/4-ways-symplify-makes-working-with-symfony-more-fun</link>
                <description><![CDATA[ <p>Are you new to Symplify? In short, it's a set of packages I wrote that focuses on improving daily PHP development. It brings joy to the code, so you can focus more on what you love.
<br>
<br>
Are you a Symplify power user? You still might find some new tricks you didn't know about.</p> ]]></description>
                <content:encoded><![CDATA[ <blockquote class="blockquote text-center">
    "If you're just safe about the choices you make,
    <br>
    you don't grow."
</blockquote>
<h2 id="1-Is-the-Annotation-available-as-the-Attribute">1. Is the Annotation available as the Attribute?</h2>
<p><a href="https://github.com/symplify/phpstan-rules" class="btn btn-dark btn-sm mb-1">
From phpstan-rules package
</a></p>
<p>Some Symfony annotations are already <a href="https://symfony.com/blog/new-in-symfony-5-2-php-8-attributes">available as attributes since Symfony 5.2</a>, e.g., route:</p>
<pre><code class="language-diff"> use Symfony\Component\Routing\Annotation\Route;

 class SomeController
 {
-    /**
-     * @Route("/path", name="action")
-     */
+    #[Route(path: '/path', name: 'action')]
     public function someAction()
     {
     }
 }</code></pre>
<p>But not everyone is aware of those. Let's try it. Do you know which 61 Validation annotations are available as attributes?
I have no idea, but we have PHPStan for that. Resp. <code>Symplify\PHPStanRules\Rules\PreferredAttributeOverAnnotationRule</code> class.</p>
<p><strong>It warns us to be about every annotation usage, where the attribute should be used instead.</strong></p>
<pre><code class="language-php">use Symfony\Component\Routing\Annotation\Route;

class SomeController
{
    /**
     * @Route("/path", name="action")
     */
    public function someAction()
    {
    }
}</code></pre>
<p>❌</p>
<pre><code class="language-php">use Symfony\Component\Routing\Annotation\Route;

class SomeController
{
    #[Route(path: "/path", name: "action")]
    public function someAction()
    {
    }
}</code></pre>
<p>✅</p>
<p><br></p>
<p>You can configure it yourself or use default setup:</p>
<pre><code class="language-yaml"># phpstan.neon
includes:
    - vendor/symplify/phpstan-rules/config/symfony-rules.neon
    - vendor/symplify/phpstan-rules/config/services/services.neon</code></pre>
<h2 id="2-Is-Parameter-in-Config-used-Just-Once">2. Is Parameter in Config used Just Once?</h2>
<p><a href="https://github.com/symplify/phpstan-rules" class="btn btn-dark btn-sm mb-1">
From phpstan-rules package
</a></p>
<p>Cyclic dependencies, nested package method calls on mixed types everywhere are the most annoying bugs that take hours to find. Well, until you make a typo or override something, you've defined two lines above.</p>
<p>One of these places is in Symfony PHP configs. If you haven't switched from YAML to PHP, <a href="/blog/2020/07/27/how-to-switch-from-yaml-xml-configs-to-php-today-with-migrify/">do it today</a>. Then you can have this bug too:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $parameters = $containerConfigurator-&gt;parameters();
    $parameters-&gt;set('secret_hash', 'ASDF1234');

    // this should never happen! it overrides the first param set
    $parameters-&gt;set('secret_hash', 'ASFD1234');
};</code></pre>
<p>The <code>secret_hash</code> should be <code>ASDF1234</code>, but it's not. Why?</p>
<p>There is more than just a new kind of bug in your project... well, to be honest, this bug can happen in YAML too, and there is no way to detect it.</p>
<p>In PHP we have a great team member that helps with details that matters - <strong>a PHPStan rule</strong>:</p>
<pre><code class="language-yaml">rules:
    - Symplify\PHPStanRules\Rules\PreventDoubleSetParameterRule</code></pre>
<p>Now you can type configs as you like, and PHPStan will warn you about every duplicated param in your config!</p>
<p>✅</p>
<h2 id="3-Autowire-List-of-Services">3. Autowire List of Services</h2>
<p><a href="https://packagist.org/packages/symplify/autowire-array-parameter" class="btn btn-dark btn-sm mb-1">
From autowire-array-parameter package
</a></p>
<p>Let's say you are writing a book, and apart from the text, you have all kinds of resources - images, tool output in txt, PHP code snippets, etc. There are single <code>BookProcessor</code> services that collect many <code>ResourceProcessorInterface</code>:</p>
<ul>
<li><code>ImageResourceProcessor</code></li>
<li><code>OutputResourceProcessor</code></li>
<li><code>PHPSnippetResourceProcessor</code></li>
</ul>
<p>How would you pass all of them to <code>BookProcessor</code>?</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use function Symfony\Component\DependencyInjection\Loader\Configurator\tagged_iterator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();

    $resourceProcessorTag = 'resource_processor';

    $services-&gt;instanceof(ResourceProcessorInterface::class)
        -&gt;tag($resourceProcessorTag);

    $services-&gt;set(BookProcessor::class)
        -&gt;bind('$resourceProcessors', tagged_iterator($resourceProcessorTag));
};</code></pre>
<p>That looks like a valid Symfony code. But what if you register a resource processor in another config or package? Boom, it's missed out. Three hours later, you want to kill yourself. And there <a href="/blog/2018/11/12/will-autowired-arrays-finally-deprecate-tags-in-symfony-and-nette/">is more problems on the way</a>.</p>
<p>We can reduce this boring code to:</p>
<pre><code class="language-diff"> use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
- use function Symfony\Component\DependencyInjection\Loader\Configurator\tagged_iterator;

 return function (ContainerConfigurator $containerConfigurator): void {
     $services = $containerConfigurator-&gt;services();
-
-    $resourceProcessorTag = 'resource_processor';
-
-    $services-&gt;instanceof(ResourceProcessorInterface::class)
-        -&gt;tag($resourceProcessorTag);
-
-    $services-&gt;set(BookProcessor::class)
-        -&gt;bind('$resourceProcessors', tagged_iterator($resourceProcessorTag));
};</code></pre>
<p>Much better. How did we do it? With <strong>autowired array</strong> compiler pass:</p>
<pre><code class="language-diff">+use Symplify\AutowireArrayParameter\DependencyInjection\CompilerPass\AutowireArrayParameterCompilerPass;
 use Symfony\Component\HttpKernel\Kernel;

 final class AppKernel extends Kernel
 {
     protected function build(ContainerBuilder $containerBuilder): void
     {
+         $containerBuilder-&gt;addCompilerPass(new AutowireArrayParameterCompilerPass());
     }
 }</code></pre>
<p>Everything else still looks the same. You've just made your configs more readable and code more robust.</p>
<p>✅</p>
<h2 id="4-What-is-the-Doctrine-Extension-key-name-in-the-config">4. What is the Doctrine Extension key name in the config?</h2>
<p><a href="https://github.com/symplify/amnesia" class="btn btn-dark btn-sm mb-1">
From amnesia package
</a></p>
<p>When you switch to PHP configs, you realize how many kinds of strings there are:</p>
<ul>
<li>configuration key</li>
<li>configuration value</li>
<li>env value</li>
</ul>
<p>The first one is always the same. It's defined in the documentation, e.g., for <a href="https://symfony.com/doc/current/reference/configuration/doctrine.html">Doctrine keys</a>. But would you go to documentation and google for a string, or would you use your IDE to help out?</p>
<p>I'm lazy, so I go with the latter one. A typical example is hostname, host... or was it host_name?</p>
<img src="/assets/images/posts/2021/doctrine_host.gif" class="img-thumbnail">
<p>There are few other classes you can use:</p>
<ul>
<li><code>Symplify\Amnesia\ValueObject\Symfony\Extension\DoctrineExtension</code></li>
<li><code>Symplify\Amnesia\ValueObject\Symfony\Extension\Doctrine\DBAL</code></li>
<li><code>Symplify\Amnesia\ValueObject\Symfony\Extension\Doctrine\ORM</code></li>
<li><code>Symplify\Amnesia\ValueObject\Symfony\Extension\Doctrine\Mapping</code></li>
</ul>
<p>and more.</p>
<p><br></p>
<p>This is how we use it on <a href="https://github.com/rectorphp/getrector.org/blob/master/config/packages/doctrine.php">getrector.org configs</a>:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use function Symplify\Amnesia\Functions\env;
use Symplify\Amnesia\ValueObject\Symfony\Extension\Doctrine\DBAL;
use Symplify\Amnesia\ValueObject\Symfony\Extension\Doctrine\Mapping;
use Symplify\Amnesia\ValueObject\Symfony\Extension\Doctrine\ORM;
use Symplify\Amnesia\ValueObject\Symfony\Extension\DoctrineExtension;

return function (ContainerConfigurator $containerConfigurator): void {
    $containerConfigurator-&gt;extension(DoctrineExtension::NAME, [
        DoctrineExtension::DBAL =&gt; [
            DBAL::DRIVER =&gt; 'pdo_mysql',
            DBAL::SERVER_VERSION =&gt; '5.7',
            DBAL::PASSWORD =&gt; env('DATABASE_PASSWORD'),
        ],
        DoctrineExtension::ORM =&gt; [
            ORM::MAPPINGS =&gt; [
                'demo' =&gt; [
                    Mapping::IS_BUNDLE =&gt; false,
                    Mapping::TYPE =&gt; Mapping::TYPE_ANNOTATION,
                    // ...
                ]
        // ...</code></pre>
<p>This way, we can easily see:</p>
<ul>
<li>what is a <strong>constant configuration</strong></li>
<li>and what is a <strong>manually defined value</strong></li>
</ul>
<p><br></p>
<p><strong>Little extras</strong>: have you ever made typo in <code>%env(...)</code>?</p>
<img src="/assets/images/posts/2021/doctrine_env.gif" class="img-thumbnail">
<p>Use <code>env()</code> function so save the hustle. Thanks enumag for the tip!</p>
<p>That's all for today. I hope you will use some of these tools to become a lazier and happier developer.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2021/01/18/4-ways-symplify-makes-working-with-symfony-more-fun</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 18 Jan 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2021/01/18/4-ways-symplify-makes-working-with-symfony-more-fun#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to detect Complex Duplicated Methods With PHPStan ]]></title>
                <link>https://tomasvotruba.com/blog/2021/01/11/how-to-detect-complex-duplicated-methods-with-phpstan</link>
                <description><![CDATA[ <p>Duplicated code is a code smell that hides the potential of better design.
How can we find it? Is it 100 % identical code token by token?
Are methods <code>getName()</code> and <code>getName()</code> on 2 entities duplicated?
<br>
<br>
Today we look at PHPStan and how to use it to find duplicated class methods.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Why-even-Care-about-Duplicated-Code">Why even Care about Duplicated Code?</h2>
<p>What is the practical approach to finding a duplicated code? You probably know about <a href="https://github.com/sebastianbergmann/phpcpd">phpcpd</a> tool. It goes through your code and dumps a list of duplicated lines:</p>
<pre><code class="language-bash">- .../sodium_compat/src/Core32/Curve25519.php:879-889 (10 lines)
  .../sodium_compat/src/Core32/Curve25519.php:1072-1082

1.82% duplicated lines out of 446676 total lines of code</code></pre>
<p>Is this number high? Is it low? How low should it be? The output is so generic. There is no clear answer to what to do with it. That's because <a href="/blog/2018/10/22/brief-history-of-tools-watching-and-changing-your-php-code/">phpcpd is using tokens</a>.</p>
<p>PHPStan changes an approach to duplicated code. It runs on php-parser and uses an abstract syntax tree. So why should we care?</p>
<h3 id="PHPStan-gives-Human-Output-so-we-Know-What-to-Do">PHPStan gives Human Output, so we Know What to Do</h3>
<p>Compare reports of 2 tools:</p>
<ul>
<li>phpcpd: &quot;10 lines of here and 10 lines of here are identical&quot;</li>
<li>PHPStan: &quot;Class methods <code>ProductSorter::sortResults()</code> and <code>PictureSorter::sortResults()</code> are identical</li>
</ul>
<p>In the first case, we'd have to look into the files, check if it's part of the method or couple of properties, how to extract it from both, and combine it in a class or method?</p>
<p>With PHPStan, we know it's class methods, so we can only <strong>extract them to external service</strong>.</p>
<h3 id="Improve-Architecture-Flaws-without-Effort">Improve Architecture Flaws without Effort</h3>
<p>Where in your code is duplicated code? We don't know. It's a tough question for the human to spot.</p>
<p>Do you look for all possible duplication during each code review? I don't think so. We go through added/modified code, and that's it.</p>
<p>PHPStan <strong>does this hard work on each commit</strong> and tells us precisely the duplicated code. 0 effort.</p>
<p>When we know where duplications are, we can do something about it. Our project code will be more consistent, logical, and each piece of code will fit into another.</p>
<p><br></p>
<p>Let's look at a practical example from the Rector code. We applied the PHPStan duplication rule a month ago, and this is what we found:</p>
<pre><code class="language-php">private function unwrapExpression(Node $node): Node
{
    if ($node instanceof Expression) {
        return $node-&gt;expr;
    }

    return $node;
}</code></pre>
<pre><code class="language-php">private function unwrapExpression(Node $node): Node
{
    return $node instanceof Expression ? $node-&gt;expr : $node;
}</code></pre>
<pre><code class="language-php">/**
 * @param Node|Expression $node
 */
private function unwrapExpression(Node $node): Node
{
    if ($node instanceof Expression) {
        return $node-&gt;expr;
    }

    return $node;
}</code></pre>
<p>Each method has a different count of nodes. There is short ternary in one and if condition in other 2. All three have the same logic. <strong>We extracted this method to shared service</strong> and used it in 3 places.</p>
<p>Now the method is always re-used because PHPStan reports all the future cases of duplication.</p>
<p>What are other benefits?</p>
<ul>
<li>1 place to fix it ✅</li>
<li>1 place to maintain it ✅</li>
<li>Code is much more robust and easier to change ✅</li>
<li>The service is doing exactly 1 thing ✅</li>
<li>Other services are not cluttered with &quot;util code&quot; ✅</li>
</ul>
<h2 id="What-is-Not-Duplicated-Method">What is Not Duplicated Method?</h2>
<p>These 2 methods are 100 % identical, including spaces. Would you consider them duplicated?</p>
<pre><code class="language-php">public function getName(): string
{
    return $this-&gt;name;
}</code></pre>
<pre><code class="language-php">public function getName(): string
{
    return $this-&gt;name;
}</code></pre>
<p>No. These are only getters. Imagine <strong>one parent object for all entities with all the getters</strong> that used at least twice. That's nonsense.</p>
<p>That's why the PHPStan rule skips:</p>
<ul>
<li>value objects,</li>
<li>entities</li>
<li>and methods with only 1 line of code.</li>
</ul>
<h2 id="How-can-we-spot-the-Duplicated-Method-with-X-Rays">How can we spot the Duplicated Method with X-Rays?</h2>
<p>Let's get back to our example above. What if we use different variables names, method names, and omit return type?</p>
<pre><code class="language-php">public function unwrapExpression(Node $node)
{
    if ($node instanceof Expression) {
        return $node-&gt;expr;
    }

    return $node;
}</code></pre>
<pre><code class="language-php">private function unwrap($stmt)
{
    if($stmt instanceof Expression){
        return $stmt-&gt;expr;
    }
    return $stmt;
}</code></pre>
<p>Is this method still duplicated? Yes, because <strong>the semantics remain the same</strong>. Method and variable names are subjective and can be anything without changing logic.</p>
<p>Here I borrow an example from <a href="https://ocramius.github.io/blog/eliminating-visual-debt/">Eliminating Visual Debt</a> by Ocramius. If you haven't read it, it's so much fun you're missing out.</p>
<p>Let's replace these irrelevant names with foo/bar:</p>
<pre><code class="language-php">function foo($bar)
{
    if ($bar instanceof Expression) {
        return $bar-&gt;expr;
    }
    return $bar;
}</code></pre>
<p>When we look at both methods with this approach, we see the logic is identical → let's extract it.</p>
<h2 id="How-to-Teach-it-PHPStan">How to Teach it PHPStan?</h2>
<p>Samsonasik contributed this <a href="https://github.com/symplify/symplify/pull/2666">rule to Symplify</a> about a month ago. We took a month to try it out, fixed repeated methods from trait, and class using it.</p>
<p>We tried various angles that we tested on 4 different projects.</p>
<p>In the end, the final rule works like this:</p>
<ul>
<li>look for a class method</li>
<li>normalized variable names</li>
<li>ignore parameters, method name, and return types</li>
<li>print method to string</li>
<li>compare it to previous methods</li>
</ul>
<p>You can see <a href="https://github.com/symplify/symplify/blob/master/packages/phpstan-rules/src/Rules/PreventDuplicateClassMethodRule.php">final rule here</a>.</p>
<p>This rule has been running on our code base and already reported over 50 duplicated methods. It's a bizarre feeling if you see that you put in the effort to write 20 lines long method in 2 different Rector rules. But <strong>the feeling after refactoring to cleaner design is priceless</strong>.</p>
<h2 id="3-Steps-to-Get-rid-of-Duplications-in-Your-Code-Today">3 Steps to Get rid of Duplications in Your Code Today</h2>
<p>Do you want to try it out? I must warn you. It will dig out the darkest secrets of your project that you never thought they exist. Be ready for critics. Critics that will help your code to be more fun work with.</p>
<h3 id="1-Get-symplify-phpstan-rules">1. Get <a href="https://github.com/symplify/phpstan-rules">symplify/phpstan-rules</a>:</h3>
<pre><code class="language-bash">composer require symplify/phpstan-rules --dev</code></pre>
<h3 id="2-Add-it-to-phpstan-neon">2. Add it to <code>phpstan.neon</code></h3>
<pre><code class="language-yaml">includes:
    # set services that are needed by PHPStan rules
    - vendor/symplify/phpstan-rules/config/services/services.neon

rules:
    -  Symplify\PHPStanRules\Rules\PreventDuplicateClassMethodRule</code></pre>
<h3 id="3-Run-PHPStan">3. Run PHPStan</h3>
<pre><code class="language-bash">vendor/bin/phpstan analyse</code></pre>
<p>Now you won't miss any single duplicated method in your code.</p>
<p><br>
<br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2021/01/11/how-to-detect-complex-duplicated-methods-with-phpstan</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 11 Jan 2021 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2021/01/11/how-to-detect-complex-duplicated-methods-with-phpstan#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ PHPStan Abstract Parent Generics for Dummies ]]></title>
                <link>https://tomasvotruba.com/blog/2021/01/04/phpstan-abstract-parent-generics-dummies</link>
                <description><![CDATA[ <p>I'm trying to write code that is independent of abstract classes. Type-juggling can create n-matrix complexity in both directions and remind me of stringy static code where everything is one type - <code>mixed</code>.
<br><br>
But we cannot always avoid it. Do you use repositories with one abstract repository? Projects <a href="https://getrector.org/">I upgrade</a> do.
<br><br>
So I tried to use <a href="https://phpstan.org/blog/generics-in-php-using-phpdocs">PHPStan generics</a> and failed hard.</p> ]]></description>
                <content:encoded><![CDATA[ <blockquote class="blockquote text-center">
    "If you can't explain it to a six-year-old,<br>
    you don't understand it yourself."
    <footer class="blockquote-footer">Albert Einstein</footer>
</blockquote>
<p>The documentation <a href="https://phpstan.org/blog/generics-in-php-using-phpdocs">barely scratches this topic</a> and examples are not very clear. Neither were responses on GitHub issues.</p>
<p><br></p>
<p>What is the use case? We have two classes - an abstract repository:</p>
<pre><code class="language-php">abstract class AbstractRepository
{
    public function get(int $id): object
    {
        // ...
    }
}</code></pre>
<p>and children classes that extend it:</p>
<pre><code class="language-php">final class ProductRepository extends AbstractRepository
{
}</code></pre>
<p><br></p>
<p>In the controller, we use <code>ProductRepository</code> to display product detail:</p>
<pre><code class="language-php">final class ProductDetailController
{
    public function __construct(
        private ProductRepository $productRepository
    ) {
    }

    public function __invoke(int $id)
    {
        $product = $this-&gt;productRepository-&gt;get($id);
    }
}</code></pre>
<p>Pretty straightforward, right?</p>
<p>Now we'll try to solve the hard question...</p>
<h2 id="What-Type-is-product">What Type is <code>$product</code>?</h2>
<pre><code class="language-php">$product = $this-&gt;productRepository-&gt;get($id);</code></pre>
<p>The class method <code>AbstractRepository-&gt;get()</code> returns and <code>object</code>, so for PHP, PHPStan, Rector and IDE it's an <code>object</code>. Nothing less, nothing more.</p>
<p>But what <strong>do you see</strong>? You probably assume it's a specific <code>object</code> with a specific type - <code>Product</code>. How can we get this knowledge to the code?</p>
<p><br></p>
<ol>
<li>We could add a method to <code>ProductRepository</code></li>
</ol>
<pre><code class="language-diff"> final class ProductRepository extends AbstractRepository
 {
+    public function get(int $id): Product
+    {
+        return parent::get($id);
+    }
 }</code></pre>
<ol start="2">
<li>We could add magic <code>@method</code> docblock</li>
</ol>
<pre><code class="language-diff">+/**
+ * @method Product get(int $id)
+ */
 final class ProductRepository extends AbstractRepository
 {
 }</code></pre>
<ol start="3">
<li>We could add <code>@var</code> annotation to every <code>$product</code> variable</li>
</ol>
<pre><code class="language-diff">+/** @var Product $product */
 $product = $this-&gt;productRepository-&gt;get($id);</code></pre>
<ol start="4">
<li>We could add <code>assert()</code> to <code>$product</code> variables</li>
</ol>
<pre><code class="language-diff"> $product = $this-&gt;productRepository-&gt;get($id);
+assert($product instanceof Product);</code></pre>
<ol start="5">
<li>We could add <code>instanceof</code> check</li>
</ol>
<pre><code class="language-diff"> $product = $this-&gt;productRepository-&gt;get($id);
+if (! $product instanceof Product) {
+    throw new ShouldNotHappenException('$product is not a ' . Product:class);
+}</code></pre>
<p>We can see these solutions out in the wild. All of them are valid. They verify an assumption - is object a <code>Product</code> type?</p>
<h2 id="Validation-Type-Declaration">Validation !== Type Declaration</h2>
<p>But <strong>validation is not designed for type specification</strong>. It's a layer to verify external input from QA when they walk in a bar order beer, <code>-5</code>, <code>$^@'ł</code>, an array of <code>T_INF</code>, and a bottomless glass of invisible water.</p>
<p>Here <strong>we know</strong> the <code>$product</code> is always the <code>Product</code> type unless some very nasty bug will get into Doctrine.
How can we teach our PHP code this knowledge?</p>
<h2 id="Generics">Generics!</h2>
<p>Adding generics to 2 classes is 2-steps</p>
<h3 id="1-Open-Parent">1. Open Parent</h3>
<p><strong>First</strong>, we need to tell the abstract class to be opened to type override from children. By convention, the generics are not defined with the <code>@generics</code> keyword but by <code>@template</code>. It has nothing to do with rendering templates.</p>
<p><br></p>
<p>With <code>@template</code> we define a keyword and a type. Same as <code>@param int $age</code> does.</p>
<pre><code class="language-diff">+/**
+ * @template TEntity as object
+ */
 abstract class AbstractRepository
 {
 }</code></pre>
<p>Now we use this <code>TEntity</code> keyword in places where we know the specific type will be used:</p>
<pre><code class="language-diff"> abstract class AbstractRepository
 {
+    /**
+     * @return TEntity
+     */
     public function get(int $id): object
     {
         // ...
     }
 }</code></pre>
<p>Good job, we're halfway through.</p>
<h3 id="2-Specify-Child">2. Specify Child</h3>
<p>So how do we tell <code>ProductRepository</code> to treat every object as <code>Product</code>?</p>
<pre><code class="language-diff">+/**
+ * @template TEntity as Product
+ */
 final class ProductRepository extends AbstractRepository
 {
 }</code></pre>
<p>That should be it, right? Let's run our controller and try it:</p>
<pre><code class="language-php">$product = $this-&gt;productRepository-&gt;get($id);
// "object"</code></pre>
<p>Damn, what's going on?</p>
<p>I stuck on this part and could not go on. We defined <code>TEntity</code> in both of our classes. We defined <code>TEntity</code> as <code>Product</code>. What is wrong?</p>
<h2 id="How-to-promote-the-TEntity-type-to-Parent-Class">How to promote the <code>TEntity</code> type to Parent Class?</h2>
<p>The problem is, PHPStan sees <strong>generic types only in the classes they're defined</strong> by default.
While <code>@return int</code> gets promoted to child methods, <code>@template</code> does not.</p>
<ul>
<li>So <code>TEntity</code> is <code>Product</code> only in class we defined it in - <code>ProductRepository</code></li>
<li>And <code>TEntity</code> is only an <code>object</code> in class we defined it in - <code>AbstractRepository</code></li>
</ul>
<p>So we need to tell <code>AbstractRepository</code> to use <code>TEntity</code> as <code>Product</code>, without modifying it.</p>
<p><br></p>
<p>In the documentation, there is mentioned <code>@extends</code> annotation. It is not related to extending a class, <strong>but promoting types to parent class</strong>.</p>
<p>Let's get back to our repository:</p>
<pre><code class="language-php"> /**
  * @template TEntity as Product
  */
 final class ProductRepository extends AbstractRepository
 {
 }</code></pre>
<p>The <code>@extends</code> annotation takes an argument of 1-n item names. These items will be pushed parent repository.</p>
<p>How do we tell the parent class to use <code>TEntity</code> as <code>Product</code>?</p>
<pre><code class="language-diff"> /**
  * @template TEntity as Product
+ * @extends AbstractRepository&lt;TEntity&gt;
  */
 final class ProductRepository extends AbstractRepository
 {
 }</code></pre>
<p>As we don't use <code>TEntity</code> in our child class, we can merge it to <code>@extends</code> (thanks Ondra for pointing that out in the comments):</p>
<pre><code class="language-diff"> /**
- * @template TEntity as Product
+ * @extends AbstractRepository&lt;Product&gt;
  */
 final class ProductRepository extends AbstractRepository
 {
 }</code></pre>
<p>Now the <code>TEntity</code> in <code>AbstractRepository</code> will be overridden by type defined here. So <code>TEntity</code> will be treated as <code>Product</code> ✅</p>
<p>Beware! Even though it looks like any <code>array&lt;shape&gt;</code>, it has nothing to do with arrays.</p>
<p><br></p>
<h2 id="How-to-Propagate-2-and-more-Types">How to Propagate 2 and more Types?</h2>
<p>Let's say you have 2 generics types in your abstract class:</p>
<pre><code class="language-php">/**
 * @template TEntity as object
 * @template TQuery as object
 */
abstract class AbstractRepository
{
}</code></pre>
<p>The <code>@extends</code> tag can take multiple arguments, separated by comma - in <strong>the same order the types are defined</strong> in abstract class:</p>
<pre><code class="language-php">/**
 * @extends AbstractRepository&lt;Product, ProductQuery&gt;
 */
final class ProductRepository extends AbstractRepository
{
}</code></pre>
<p>That's how you use generics with parent abstract class with PHPStan.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2021/01/04/phpstan-abstract-parent-generics-dummies</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 04 Jan 2021 00:00:00 +0000</pubDate>
                                    <updated>2021-05-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 May 2021 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 May 2021 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2021/01/04/phpstan-abstract-parent-generics-dummies#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Why Coding Standards Should Not Be Part of CI ]]></title>
                <link>https://tomasvotruba.com/blog/2020/12/28/why-coding-standards-should-not-be-part-of-ci</link>
                <description><![CDATA[ <p>Why do you use coding standards? To standardize the design of your code so that any contributor will produce somewhat similar PHP code.
<br><br>
Where do we use it? In CI pipelines on every pull-request, locally in a command line or within PHPStorm.
<strong>Now take these 3 places and drop coding standard from them.</strong></p> ]]></description>
                <content:encoded><![CDATA[ <p>&quot;What?&quot; Wait a sec. We'll get to that.</p>
<p>Do you use using PHPStorm plugins for coding standards? I <a href="/blog/2019/06/24/do-you-use-php-codesniffer-and-php-cs-fixer-phpstorm-plugin-you-are-slow-and-expensive/">argued it's a waste of time</a> and that you should move to CI. In recent months, I conclude <strong>that even coding standard in CI is rather limiting for daily work</strong>. We have to wait for CI feedback, process the feedback, and pay for CI work-minutes.</p>
<p>I believe we can get rid of this technical debt. Why even care? <a href="/blog/2020/01/13/why-is-first-instant-feedback-crucial-to-developers/">Because faster CI feedback is</a>, the addictive is coding against it. We'll get to that.</p>
<p><br></p>
<p>What do we talk about when we say &quot;coding standards&quot;?</p>
<h2 id="1-Coding-Standard-is-about-How-Code-Looks">1. Coding Standard is about How Code Looks</h2>
<p>If we run coding standard on our code, the only thing that should change is <strong>its design</strong>:</p>
<pre><code class="language-diff">-   class    SomeClass { }
+class SomeClass
+{
+}</code></pre>
<p>Their features and logic should remain the same.</p>
<ul>
<li>Does your coding standard handle refactoring or upgrades? It should be by <a href="https://github.com/rectorphp/rector">Rector</a>.</li>
<li>Does your coding standard tell you that <code>dump()</code> was left in the code? <a href="https://github.com/phpstan/phpstan">PHPStan</a> should handle that.</li>
</ul>
<h2 id="2-Coding-Standard-is-Deterministic">2. Coding Standard is Deterministic</h2>
<p><strong>Deterministic means that each input has exactly one output</strong>.</p>
<p>E.g., you have a car. If you turn its steering wheel to the left, the car will turn left. If you turn it right, the car will turn right.</p>
<img src="/assets/images/posts/2020/steering-wheel.jpg" class="img-thumbnail">
<p>If turning the steering wheel in one direction does not produce the same output in the same conditions, we know that car is broken, or we're too drunk. We should stop driving in both cases as it can have non-deterministic consequences.</p>
<p>The same applies to coding standards. If we say A → we must add B.</p>
<ul>
<li>We don't use composed constants → we use each on their standalone line.</li>
</ul>
<pre><code class="language-diff">-const ONE = 'two', TWO = 'one';
+const ONE = 'two';
+const TWO = 'one';</code></pre>
<ul>
<li>We don't use old arrays → we use new ones.</li>
</ul>
<pre><code class="language-diff">-$items = array(
+$items = [
     // ...
-);
+];</code></pre>
<p>We can't say: &quot;we don't use old arrays → we use anything else&quot;. That's not a coding standard but an unfinished opinion.</p>
<h2 id="3-Coding-Standard-Rules-must-be-Fixable">3. Coding Standard Rules must be Fixable</h2>
<p>Let's get back to the car. The steering wheel is deterministic. Turn it left →  car turns left, turn it right → car turns right. If we turn left and turns right, we know the car paradigm is broken and take it into the car repair shop. They already know how the car should behave without us telling them. They know <strong>how to fix it</strong>, no need to discuss car standards.</p>
<p>Same applies for coding standard:</p>
<pre><code class="language-diff">-$items = array(
+$items = [
     // ...
-);
+];</code></pre>
<p>That's why every coding standard rule <strong>should be fixable by default</strong>. Actually, <a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer">PHP CS Fixer</a> is built on this premise, and each rule is a fixer by default. Good job!</p>
<p>If it's impossible to come up with a fixable version, a PHPStan rule should handle this case.</p>
<p><br></p>
<p>What happens if we apply points 1, 2, and 3 to our coding standard set? It handles code design, it is deterministic, and it is fixable. That looks like work for robots...</p>
<h2 id="Why-do-we-put-Coding-Standards-into-CI">Why do we put Coding Standards into CI?</h2>
<p>Well, one reason is self-evident - <em>status quo</em>, we're used to that.</p>
<p>Also, we want the code to look the same on every merge. Apart from that, there is not much to say.</p>
<h2 id="How-Coding-Standard-in-CI-Wastes-Time">How Coding Standard in CI Wastes Time?</h2>
<p>If we have a project with 15 pull-request a day and coding standard run in CI for every pull-request, that's at least 15 runs a day.
One run can take 3 mins on average. That's 45 minutes. What happens when a coding standard fails? We have to check it manually, fix it, and push the commit into the branch.</p>
<p>The circle repeats. That's <strong>at least 90 minutes of waiting time wasted a day for your whole team</strong>. Also, now robots are controlling humans. Our CI is adding extra work to developers, and developers must silently obey to make CI robots happy. Dooms Day already?</p>
<p><br></p>
<p>Let's get back to the primary purpose of coding standards. Our PHP code should look the same.</p>
<p>Could you think of a better solution that does not waste 90 minutes a day and turn us into slaves but keeps our PHP code looks nice and pretty?</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/12/28/why-coding-standards-should-not-be-part-of-ci</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 28 Dec 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/12/28/why-coding-standards-should-not-be-part-of-ci#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 5 New Combos opened by Symfony 5.2 and PHP 8.0 ]]></title>
                <link>https://tomasvotruba.com/blog/2020/12/21/5-new-combos-opened-by-symfony-52-and-php-80</link>
                <description><![CDATA[ <p>Conjunction of 2 releases came in December 2020, Symfony 5.2 and <a href="https://getrector.org/blog/2020/11/30/smooth-upgrade-to-php-8-in-diffs">PHP 8.0</a>.
I wanted to give them a fresh try, so I've updated <code>composer.json</code> in 3 projects, run the Rector upgrade set, and this happened...</p> ]]></description>
                <content:encoded><![CDATA[ <p>For code-screeners who understand diffs better than words like me, here are direct links to pull-requests to get the real deal of migration porn:</p>
<ul>
<li><a href="https://github.com/TomasVotruba/tomasvotruba.com/pull/1107/files">tomasvotruba.com upgrade</a></li>
<li><a href="https://github.com/rectorphp/getrector.org/pull/190/files">getrector.org upgrade</a></li>
<li><a href="https://github.com/TomasVotruba/friendsofphp.org/pull/176/files">friendsofphp.org upgrade</a></li>
</ul>
<p>I haven't done such a smooth upgrade in years. The work started on December 1st and finished with the last merge on December 2nd. That's two days - <strong>that's only possible thanks to the amazing work of PHP contributors and Symfony team</strong>. Thank you! Do you want to upgrade too? <a href="https://getrector.org/blog/2020/11/30/smooth-upgrade-to-php-8-in-diffs">Do it with PHP 8 Rector set</a>.</p>
<h2 id="Open-the-Next-Door">Open the Next Door</h2>
<p>Now that we have this off the table, let's talk about the &quot;open the next door&quot; technique. An open door is one of the kaizen approaches to coding, life, and everything.</p>
<p><strong>We don't know what is behind the door until we open them and enter the room</strong>. There might be another door that we might open. Don't think about what is after 2nd potential door in a room we haven't seen yet. Just enter the room and see.</p>
<img src="/assets/images/posts/2020/combo-door.jpg" class="img-thumbnail">
<p>The same way PHP 5.3 helped with service vs. value object directory structure in times nobody think of it:</p>
<ul>
<li>PHP 5.3 opened the door to namespaces</li>
<li>then PSR-4 opened the door to unique file-class names</li>
<li>then Symfony autodiscovery opened the door to namespace-based service loading</li>
<li>then namespace-based service loading opened the door to services vs. value objects directory structure</li>
</ul>
<p><em>Kaizen</em> is a Japanese technique about daily continuous little improvements. Today <strong>we open the door to PHP 8, then another to Symfony 5.2</strong>. Only then can we see what is in the room we've never been to.</p>
<p><br></p>
<p>Here is what I saw:</p>
<h2 id="1-Switch-at-Route-Annotations-to-Route-Attributes">1. Switch <code>@Route</code> Annotations to <code>#[Route]</code> Attributes</h2>
<p>PHP 8 brings attributes and Symfony 5.2 brings <code>#[Route]</code> attribute. Now we can finally get rid of stringy annotations and get robust reliable native PHP attributes code:</p>
<pre><code class="language-diff">-/**
- * @Route(path="/archive", name="blog_archive")
- */
+#[Route(path: '/archive', name: 'blog_archive')]
 public function blogArchive(): Response
 {
     // ...
 }</code></pre>
<p>Named properties included.</p>
<h2 id="2-Route-Names-Can-be-Constants">2. Route Names Can be Constants</h2>
<p>Annotations have kind-of autocomplete support, but lack of docblock standard makes parsing problematic. One parser supports syntax with trailing <code>,</code>, the other does not.</p>
<p>With attributes, we can forget this bag of problems and welcome features we use in standard PHP code. E.g., <strong>using constants for repeated strings across many PHP files</strong>.</p>
<p><br></p>
<p>During refactoring, I used <code>"archive"</code> as route name, and the project crashed. Why? The correct value was <code>"blog_archive"</code>. What a dumb <a href="/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock/">memory locker</a>. We don't want to store and search strings in my brain. We want to code as safely as possible with IDE having our back.</p>
<p><br></p>
<p>Here is the deal. What if we have a <code>RouteName</code> object with constants of route names?</p>
<img src="/assets/images/posts/2020/combo-route-value-object.png" class="img-thumbnail">
<p>No we have <strong>one place</strong> to manage route names ✅</p>
<p><br></p>
<p>What else extra can we get out of this...</p>
<p><br></p>
<p><strong>Where is route used?</strong> Just click on it ✅</p>
<img src="/assets/images/posts/2020/combo-route-use-cases.png" class="img-thumbnail">
<p><br></p>
<p><strong>What routes can we use?</strong> Ask your IDE ✅</p>
<img src="/assets/images/posts/2020/combo-route-value-object.png" class="img-thumbnail">
<p>Attribute and redirect autocomplete ✅</p>
<pre><code class="language-php">return $this-&gt;redirectToRoute(RouteName::CONTACT);</code></pre>
<p>Twig autocomplete - kind of crappy now...</p>
<pre><code class="language-twig">&lt;a href="{{ path(constant('Rector\\Website\\ValueObject\\RouteName::CONTACT')) }}"&gt;Dare us&lt;/a&gt;</code></pre>
<p><br></p>
<p><strong>How can we rename a route?</strong> In 1 line ✅</p>
<p>Wait, why should we ever rename a route? That's a good question. But a better question is: why should we think about route names at all? We'll get into that.</p>
<h2 id="3-Property-Promotion-empowers-Invokable-Controllers">3. Property Promotion empowers Invokable Controllers</h2>
<p>What is property promotion? It's a PHP 8 feature that does this:</p>
<pre><code class="language-diff">-    private PostRepository $postRepository;

-    private ClusterRepository $clusterRepository;

     public function __construct(
-        PostRepository $postRepository,
+        private PostRepository $postRepository,
-        ClusterRepository $clusterRepository
+        private ClusterRepository $clusterRepository
    ) {
-        $this-&gt;postRepository = $postRepository;
-        $this-&gt;clusterRepository = $clusterRepository;
    }</code></pre>
<p>2/3 less lines, 100 % of duplicated code removed ✅</p>
<p>Note: Are you using action injection? Migrate to promoted properties and <a href="/blog/2018/04/23/how-to-slowly-turn-your-symfony-project-to-legacy-with-action-injection/">stop now</a>.</p>
<p><br></p>
<p>What is an invokable controller? It's a form of Symfony controller that is impossible to turn into a huge legacy controller with 50 actions.</p>
<p><strong>Invokable controller has exactly 1 action called <code>__invoke()</code></strong>. We only think about the controller name and what it should do. It's like CQRS on the controller level.</p>
<p><br></p>
<p>So we separate each controller action method into its controller class with a descriptive name:</p>
<pre><code class="language-diff">-final class HomepageController
+final class BlogArchiveController
 {
     public function __construct(
         private PostRepository $postRepository,
-        private ClusterRepository $clusterRepository
     ) {
     }

     #[Route(path: '/archive', name: RouteName::BLOG_ARCHIVE)]
-    public function blogArchive): Response
+    public function __invoke(): Response
     {
         // ...
     }

-    #[Route(path: '/clusters', name: RouteName::CLUSTERS)]
-    public function clusters(): Response
-    {
-        // ...
-    }
 }</code></pre>
<p>This opens another door... now, we'll get to the route naming...</p>
<h2 id="4-Door-for-New-PHPStan-Rules">4. Door for New PHPStan Rules</h2>
<p>What do you think about this controller?</p>
<pre><code class="language-php"> final class BlogArchiveController
 {
     public function __construct(private PostRepository $postRepository)
     {
     }

     #[Route(path: '/archive', name: RouteName::CONTACT)]
     public function __invoke(): Response
     {
        // ...
     }
 }</code></pre>
<p>What about this controller?</p>
<pre><code class="language-php"> final class ContactController
 {
     public function __construct(private PostRepository $postRepository)
     {
     }

     #[Route(path: '/post-detail', name: RouteName::POST_DETAIL)]
     public function __invoke(): Response
     {
        // ...
     }
 }</code></pre>
<p><br></p>
<p>If you have OCD or you're a programmer, you have noticed the names doesn't quite add up:</p>
<ul>
<li><code>BlogArchiveController</code> - route name: <code>CONTACT</code></li>
<li><code>ContactController</code> - route name: <code>POST_DETAIL</code></li>
</ul>
<p>This could have been spotted during code-review... or not.
<strong>Why bother yourself</strong>, when PHPStan can handle it?</p>
<p><br></p>
<p>Abdul is <a href="https://github.com/symplify/symplify/pull/2740">just now working on a PHPStan rule</a>, which makes sure <strong>the class name matches the route name</strong>.</p>
<ul>
<li><code>BlogArchiveController</code> - route name: <code>CONTACT</code> ❌</li>
<li><code>ContactController</code> - route name: <code>CONTACT</code> ✅</li>
</ul>
<h2 id="5-Move-from-YAML-to-PHP-to-get-REP">5. Move from YAML to PHP to get REP</h2>
<p>REP works best with pure PHP code. Not YAML, not TWIG, not NEON nor Latte. Pure PHP.
<br><strong>R</strong>ector, <strong>E</strong>CS and <strong>P</strong>HPStan.
If you're still on old YAML configs, switch now - <a href="/blog/2020/07/27/how-to-switch-from-yaml-xml-configs-to-php-today-with-migrify/">there is a tool for that</a>.</p>
<p><br></p>
<p>Then, you can add PHPStan rules, e.g. <a href="https://github.com/symplify/phpstan-rules/blob/master/docs/rules_overview.md#checkrequiredautowireautoconfigurepublicusedinconfigservicerule">one</a> that make sure you don't forget to add saint <code>defaults()</code> to your configs:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();

    $services-&gt;defaults()
        -&gt;public();
};</code></pre>
<p>❌ <code>autoconfigure()</code> and <code>autowire()</code> is missing</p>
<p><br></p>
<p>You can avoid <a href="https://github.com/symplify/phpstan-rules/blob/master/docs/rules_overview.md#preventdoublesetparameterrule">parameter override</a>:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $parameters = $containerConfigurator-&gt;parameters();

    $parameters-&gt;set('some_param', [1]);
    $parameters-&gt;set('some_param', [2]);
};</code></pre>
<p>❌ <code>"some_param"</code> is overridden</p>
<p><br></p>
<p>Or <a href="https://github.com/symplify/phpstan-rules/blob/master/docs/rules_overview.md#requireconstantinmethodcallpositionrule">require constant</a> to configure parameter name:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $parameters = $containerConfigurator-&gt;parameters();
    $parameters-&gt;set('some_param', [1]);
};</code></pre>
<p>❌ string <code>"some_param"</code> can create typoes, use constant instead</p>
<p><br></p>
<p>Another side effect is that you can finally drop <a href="https://symfony.com/blog/new-in-symfony-4-4-service-container-linter">YAML linting</a> from your CI:</p>
<pre><code class="language-diff">         steps:
-            - run: bin/console lint:YAML config</code></pre>
<p><br></p>
<p>That's it. We've just opened 5 doors to a new view on PHP programming in Symfony. That's just a start. I bet you can see the 6th door already...</p>
<p>I'm curious, <strong>What new way have you opened in your projects?</strong> Share with us in the comments. I'm eager to try it out.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/12/21/5-new-combos-opened-by-symfony-52-and-php-80</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 21 Dec 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/12/21/5-new-combos-opened-by-symfony-52-and-php-80#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ New in Symplify 9: More than 110 PHPStan Rules ]]></title>
                <link>https://tomasvotruba.com/blog/2020/12/14/new-in-symplify-9-more-than-110-phpstan-rules</link>
                <description><![CDATA[ <p>In Symplify 8, a bunch of PHP rules was part of the symplify/coding-standard package.
It was a mix of too many tools, so we decided to <strong>decouple a new package - symplify/phpstan-rules</strong>.
<br><br>
During summer 2020, our Rector team grew from 1 member to 4. To keep onboarding smooth, we started to use PHPStan <strong>to help with code-reviews in Rector</strong>. We got obsessed with <a href="/blog/2019/11/18/how-to-delegate-code-reviews-to-ci/">moving human code-reviews to CI</a>.
<br><br>
Was it worth it? Hell yea!</p> ]]></description>
                <content:encoded><![CDATA[ <p>That's how we grew from 20 rules to 110 PHPStan Rules in ~3 months. I'd say we are barely <strong>scratching the surface of what CI can handle</strong> for us in code-reviews, but 110 rules is a solid base to start from.</p>
<p><br></p>
<p>Since Symplify 9, released on December 9th, you can use them in your code. Give it a try:</p>
<pre><code class="language-bash">composer require symplify/phpstan-rules --dev</code></pre>
<p>This is not a typical PHPStan package you're used to. That you just install, add to <code>phpstan.neon</code> and forget.</p>
<p>symplify/phpstan-rules is more <strong>like a bucket of lego bricks</strong>. It has prepared parts that you can use, but it's up to you to configure them.</p>
<p><br></p>
<p>symplify/phpstan-rules has <strong>3 main areas</strong>:</p>
<ul>
<li>static rules</li>
<li>prepared sets</li>
<li>configurable rules</li>
</ul>
<p>We'll take them one by one, from the simplest to most powerful.
<br></p>
<h2 id="1-Static-Rules">1. Static Rules</h2>
<p>These rules are not configurable. You either use them or not. Dare to try them all and see what happens?</p>
<pre><code class="language-yaml">includes:
    - vendor/symplify/phpstan-rules/config/static-rules.neon</code></pre>
<p>Or do you want to <strong>cherry-pick rule by rule</strong>? Go through the <a href="https://github.com/symplify/phpstan-rules/blob/master/docs/rules_overview.md">rules overview with PHP code snippets</a> and copy-paste those you like:</p>
<pre><code class="language-yaml">rules:
    - Symplify\PHPStanRules\Rules\CheckRequiredInterfaceInContractNamespaceRule</code></pre>
<p><br></p>
<p>Some rules require extra services. To avoid service duplications, they're in the separate config that you can easily include:</p>
<pre><code class="language-yaml">includes:
    - vendor/symplify/phpstan-rules/config/services/services.neon</code></pre>
<p>That's it!</p>
<h2 id="2-Prepared-Sets">2. Prepared Sets</h2>
<p>Special group of static rules are <a href="https://github.com/symplify/phpstan-rules/tree/master/config/symplify-rules.neon">prepared sets</a>. Similar to ECS sets, each has one area it focuses on:</p>
<pre><code class="language-yaml">includes:
    - vendor/symplify/phpstan-rules/config/array-rules.neon
    - vendor/symplify/phpstan-rules/config/code-complexity-rules.neon
    - vendor/symplify/phpstan-rules/config/doctrine-rules.neon
    - vendor/symplify/phpstan-rules/config/naming-rules.neon
    - vendor/symplify/phpstan-rules/config/regex-rules.neon
    - vendor/symplify/phpstan-rules/config/services-rules.neon
    - vendor/symplify/phpstan-rules/config/size-rules.neon
    - vendor/symplify/phpstan-rules/config/forbid-static-rules.neon
    - vendor/symplify/phpstan-rules/config/string-to-constant-rules.neon
    - vendor/symplify/phpstan-rules/config/symfony-rules.neon
    - vendor/symplify/phpstan-rules/config/test-rules.neon</code></pre>
<p>Pick what you like and drop the rest.</p>
<h2 id="3-Configurable-Rules">3. Configurable Rules</h2>
<p>This is the powerful part that PHPStan advanced users will appreciate.</p>
<p><strong>You can tune configurable rules to your project context</strong>. Do you need more strict <a href="/blog/2018/05/21/is-your-code-readable-by-humans-cognitive-complexity-tells-you/">cognitive complexity</a>? No problem. Do you want to allow fewer dependencies in the constructor? Just set it.</p>
<p>Configurable rules are configured for Symplify by defaults. You can find them in:</p>
<pre><code class="language-yaml">includes:
    - vendor/symplify/phpstan-rules/config/configurable-rules.neon</code></pre>
<p>Symplify standards might not fit your standard, so it's better to use rules separately.</p>
<h3 id="Example-Configuring-ForbiddenNodeRule">Example: Configuring <code>ForbiddenNodeRule</code></h3>
<p>Let's look at <a href="https://github.com/symplify/phpstan-rules/blob/master/docs/rules_overview.md#forbiddennoderule"><code>ForbiddenNodeRule</code></a>. In this rule, you can say what <a href="https://github.com/rectorphp/php-parser-nodes-docs">nodes</a> are forbidden to use.</p>
<p>We don't like <code>switch()</code>, <code>empty()</code> and <code>@</code>, so we forbid them:</p>
<pre><code class="language-yaml">services:
    -
        class: Symplify\PHPStanRules\Rules\ForbiddenNodeRule
        tags: [phpstan.rules.rule]
        arguments:
            forbiddenNodes:
                - PhpParser\Node\Expr\Empty_
                - PhpParser\Node\Stmt\Switch_
                - PhpParser\Node\Expr\ErrorSuppress</code></pre>
<p>Now on each CI run, PHPStan makes sure our code is clean and with high standard :)</p>
<p><br></p>
<p>That's it!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/12/14/new-in-symplify-9-more-than-110-phpstan-rules</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 14 Dec 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/12/14/new-in-symplify-9-more-than-110-phpstan-rules#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ New in Symplify 9: Skipper - Skipping Files and Rules made Simple ]]></title>
                <link>https://tomasvotruba.com/blog/2020/12/10/new-in-symplify-9-skipper-skipping-files-and-rules-made-simple</link>
                <description><![CDATA[ <p>Symplify 9 brings another component <strong>to ease the life for package developers</strong>. In Rector and ECS, you can ignore specific absolute paths or dynamic paths by <code>fnmatch()</code>. You can also ignore specific Rector, Fixer, and Sniff classes.
<br><br>
Both packages use almost the same syntax, yet there are minor differences based and syntax tweaks.
<br><br>
New Skipper component prevents this and allows <strong>you to use standardized syntax in a single <code>skip</code> parameters</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>When I started writing this post, I remembered a TV series from my childhood about the hero kangaroo:</p>
<img src="/assets/images/posts/2020/skipper-kangaroo.jpg" class="img-thumbnail">
<p>It's like Batman, just kangaroo. Anyone? :) Ok, I'm old. Back to the software skipper.</p>
<p><br></p>
<h2 id="and-quot-How-Can-I-Skip-the-and-quot">&quot;How Can I Skip the ...?&quot;</h2>
<p>This is one of the most common questions in Rector or ECS issues. Skip feature is native to most of CLI tools:</p>
<ul>
<li><a href="https://phpstan.org/user-guide/ignoring-errors">PHPStan has <code>ignoreErrors</code> and <code>excludes_analyse</code> parameter</a></li>
<li><a href="https://github.com/squizlabs/PHP_CodeSniffer/wiki/Advanced-Usage#ignoring-files-and-folders">PHP_CodeSniffer has command line and annotation support</a></li>
<li><a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer/issues/3317">PHP CS Fixer</a> is thinking about it since 2017</li>
</ul>
<p>Most packages have at least 2 ways to skip a file or rule:</p>
<ul>
<li>exclude_files</li>
<li>excludedFiles</li>
<li>skip</li>
<li>ignored</li>
<li>ignorePaths</li>
<li>ignoreDirectories</li>
<li>notAllowedPaths</li>
<li>...</li>
</ul>
<p>It makes sense to have each information separated for the package developer. Then they know if you want to skip a path or a rule. But it's <strong>absolute hell for the user of the package</strong>.</p>
<ul>
<li>It's a common case, we need to ignore one file in all our CLI tools.</li>
<li>For each package, we have to learn new syntax.</li>
<li>Typos, hard to remember, you skip a class in paths parameters...</li>
</ul>
<p>We've all been there.</p>
<h2 id="Complexity-opens-Space-for-Bugs">Complexity opens Space for Bugs</h2>
<p>These complicated configuration options also allows to have duplicated skip. Try debugging this:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\Skipper\ValueObject\Option;

return function (ContainerConfigurator $containerConfigurator): void {
    $parameters = $containerConfigurator-&gt;parameters();

    $parameters-&gt;set(Option::SKIP, [
        SomeSniff::class =&gt; [
            __DIR__ . '/some-path',
        ]
    ]);

    $parameters-&gt;set(Option::EXCLUDE_RULES, [SomeSniff::class]);
};</code></pre>
<p>Why is the <code>SomeSniff</code> skipped in <code>__DIR__ . '/another-path'</code> too? It shouldn't be, only <code>__DIR__ . '/some-path'</code>.</p>
<h2 id="KISS-The-SKIP-Parameter">KISS: The <code>SKIP</code> Parameter</h2>
<p>Why not take users priority and make it simple for them? Let's use <a href="/blog/2020/03/09/art-of-letting-go/">Occam's razor</a> and provide intuitive choice:</p>
<p>Single <code>skip</code> parameter:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\Skipper\ValueObject\Option;

return function (ContainerConfigurator $containerConfigurator): void {
    $parameters = $containerConfigurator-&gt;parameters();

    $parameters-&gt;set(Option::SKIP, [
        // absolute directory
        __DIR__ . '/some-path',

        // absolute file
        __DIR__ . '/some-path/some-file.php',

        // with mask
        '*/Fixture/*',

        // specific class
        SomeClass::class,

        // specific class specific path
        NarrowedClass::class =&gt; [__DIR__ . '/src/OnlyHere'],

        // class code in paths
        AnotherSniff::class . '.SomeCode' =&gt; ['*Sniff.php', '*YamlFileLoader.php'],
    ]);
};</code></pre>
<p>That's it!</p>
<p><br></p>
<p>That's the main principle of <a href="https://github.com/symplify/skipper">Skipper</a>.
Rector 0.9 and ECS 9 build on Skipper, so be sure to use its syntax in <code>ecs.php</code> and <code>rector.php</code>. Instead of many <code>skip</code>/<code>exclude_paths</code>/<code>exclude_rules</code> params, there is just <code>skip</code> now.</p>
<h2 id="How-to-Upgrade-from-Symplify-8-to-9-and-Rector-0-8-to-0-9">How to Upgrade from Symplify 8 to 9 and Rector 0.8 to 0.9</h2>
<p>Just to be sure, this is how you upgrade your <code>ecs.php</code> and <code>rector.php</code> configs:</p>
<pre><code class="language-diff">-$parameters-&gt;set(Option::EXCLUDE_PATHS, [
+$parameters-&gt;set(Option::SKIP, [
     // paths to skip
     '*/Fixture/*',
     __DIR__ . '/packages/easy-hydrator/tests/Fixture',
-]);
-$parameters-&gt;set(Option::SKIP, [
-     ArrayDeclarationSniff::class =&gt; null,
+     ArrayDeclarationSniff::class,
 ]);</code></pre>
<p>After renaming of <code>EXCLUDE_PATHS</code> to <code>SKIP</code>, make sure there is just one <code>SKIP</code> option in your config. Symfony would pick just one of them without telling you.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/12/10/new-in-symplify-9-skipper-skipping-files-and-rules-made-simple</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 10 Dec 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/12/10/new-in-symplify-9-skipper-skipping-files-and-rules-made-simple#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ New in Symplify 9: Markdown Diff ]]></title>
                <link>https://tomasvotruba.com/blog/2020/12/07/new-in-symplify-9-markdown-diff</link>
                <description><![CDATA[ <p>When we maintain a package docs or generate documentation in Markdown, we write a code snippet from time to time.
The clearest way to show what you exactly mean is a diff. That's why diff is used in GitHub commit suggestions.</p> ]]></description>
                <content:encoded><![CDATA[ <blockquote class="blockquote text-center">
    "Diff is worth 100 code-review words."
</blockquote>
<p>But creating automated diff in Markdown is a pickle. We picked the pickle and turned it into a package - <strong><a href="https://github.com/symplify/markdown-diff">symplify/markdown-diff</a> package</strong>.</p>
<p>The package does exactly what it says and is mostly used in <a href="/blog/2020/11/30/new-in-symplify-9-documentation-generator-for-php-cs-fixer-code-sniffer-phpstan-rector-rules">symplify/rule-doc-generator</a>. I'd say this is the smallest package on Symplify.</p>
<h2 id="3-step-to-Markdown-Diff">3 step to  Markdown Diff</h2>
<ol>
<li>Install Package</li>
</ol>
<pre><code class="language-bash">composer require symplify/markdown-diff</code></pre>
<ol start="2">
<li>Register in <code>config/bundles.php</code></li>
</ol>
<pre><code class="language-php">use Symplify\MarkdownDiff\Bundle\MarkdownDiffBundle;

return [
    MarkdownDiffBundle::class =&gt; [
        'all' =&gt; true,
    ],
];</code></pre>
<ol start="3">
<li>Use it</li>
</ol>
<pre><code class="language-php">namespace App;

use Symplify\MarkdownDiff\Differ\MarkdownDiffer;

final class SomeClass
{
    /**
     * @var MarkdownDiffer
     */
    private $markdownDiffer;

    public function __construct(MarkdownDiffer $markdownDiffer)
    {
        $this-&gt;markdownDiffer = $markdownDiffer;
    }

    public function run(): void
    {
        $markdownDiff = $this-&gt;markdownDiffer-&gt;diff('oldContent', 'newContent');

        // ...

        file_put_contents(getcwd() . '/docs/diff.md', $markdownDiff);
    }
}</code></pre>
<p>↓</p>
<pre><code class="language-diff">-'oldContent'
+'newContent'</code></pre>
<p>Pretty simple, right?</p>
<h2 id="Smarter-than-Normal">Smarter than Normal</h2>
<p>Compared to <a href="https://packagist.org/packages/sebastian/diff">sebastian/diff</a> it builds on, this package does an extra cleaning job:</p>
<ul>
<li>removes line numbers</li>
<li>removes <code>---/+++ @@</code> spam</li>
<li>removes trailing white space</li>
<li>most important one: <strong>provides full diff, so you'll get full contents of compared files</strong></li>
</ul>
<p>That's all for today.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/12/07/new-in-symplify-9-markdown-diff</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 07 Dec 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/12/07/new-in-symplify-9-markdown-diff#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ New in Symplify 9: Documentation Generator for PHP CS Fixer, Code Sniffer, PHPStan and Rector Rules ]]></title>
                <link>https://tomasvotruba.com/blog/2020/11/30/new-in-symplify-9-documentation-generator-for-php-cs-fixer-code-sniffer-phpstan-rector-rules</link>
                <description><![CDATA[ <p>Rector is providing rules, so is PHPStan and PHP CS Fixer, and Code Sniffer. If you use only 5-10 rules and want to share them with the world, you create a README and describe them.
<br>
<br>
In Rector, we now have over 640 rules, in Symplify 110 rules for PHPStan and 15 rules for PHP CS Fixer. <strong>How can we handle documentation for this amount of rules without going crazy?</strong></p> ]]></description>
                <content:encoded><![CDATA[ <p>This post is for rules-based package maintainers.</p>
<ul>
<li>If we add one new rule, how do we document it?</li>
<li>What is some rule is configurable? It must be mentioned in the documentation.</li>
<li>If somebody sends a pull-request, we should tell them to do this.</li>
<li><a href="/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock/">But what if we forget?</a> What file should the documentation be placed?</li>
<li>What if the rule is configurable, but the example doesn't show how?</li>
</ul>
<p>But the critical question is:</p>
<ul>
<li><strong>How can users quickly see what the rule does?</strong></li>
</ul>
<h2 id="Status-Quo-Manual-Documentation">Status Quo: Manual Documentation</h2>
<p>Today, we create documentation manually. Add a new rule, new option, update the name or describe an example. Here are 4 examples from such documentations:</p>
<div class="row">
    <div class="col-3">
        <img src="/assets/images/posts/2020/rules-docs-second.png" class="img-thumbnail">
    </div>
    <div class="col-3">
        <img src="/assets/images/posts/2020/rules-docs-first.png" class="img-thumbnail">
    </div>
    <div class="col-3">
        <img src="/assets/images/posts/2020/rules-docs-third.png" class="img-thumbnail">
    </div>
    <div class="col-3">
        <img src="/assets/images/posts/2020/rules-docs-fourth.png" class="img-thumbnail">
    </div>
</div>
<p>There are roughly <strong>1500-2000 rules in the whole rules-ecosystem</strong> and growing every day. We don't have time to read about each rule. Nor deduct from the text how it will confront our code.</p>
<p>How do we adapt? <strong>We scan</strong>. We go quickly through README and look for something we like. <a href="https://www.amazon.com/Thinking-Fast-Slow-Daniel-Kahneman/dp/0374533555">When we scan</a>, we look for colors, <strong>bold</strong>, patterns or pictures.</p>
<p><br></p>
<p>Have a guess, what does this rule do?</p>
<img src="/assets/images/posts/2020/rules-example.png" class="img-thumbnail">
<p>You're right. It makes line-length fit <code>x</code>.</p>
<p><br></p>
<h2 id="Easy-for-Maintainers-and-Sexy-for-Users">Easy for Maintainers and Sexy for Users?</h2>
<p>The diff example above is beautiful, but it requires extra work with diff formatting, precise code indent, and don't even start about maintenance in case of change...</p>
<blockquote class="blockquote text-center">
    "Give me the tools to solve my problem, and I'll consider it.<br>
    Give me extra work, and I'll pass."
</blockquote>
<p>...but wait. There might be a way to less work.</p>
<p><br></p>
<p>In Rector, we have over 640 rules. That would be hell to maintain, so eventually, we came up with a documentation generator. One command line hit, and a whole file with examples, rule names is generated:</p>
<pre><code class="language-bash">bin/rector generate-rule-docs</code></pre>
<p>We already maintained <a href="https://github.com/symplify/coding-standard">Symplify\CodingStandard</a>
documentation with 40 rules <strong>manually</strong>. There was some itching on every new rule, but we always learned to ignore it. That was about to change.</p>
<p>During summer 2020 a new packaged started to grow - <a href="https://github.com/symplify/phpstan-rules">Symplify\PHPStanRules</a>. Just during summer, 50 rules were added, now growing over 110. Constant reminders in pull-request &quot;Could you add it to documentation?&quot; were <strong>the last nail in the coffin</strong>.</p>
<p>We had to automate it.</p>
<h2 id="Every-Rule-is-the-Documentation">Every Rule is the Documentation</h2>
<p>The first step to automation is to merge rule documentation and rule into a single place. There is no markdown file, just a PHP code rule.</p>
<p>We got inspired in <a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer/blob/ae6fceca37615fcd08183e9c3cfb8f296d2de8c2/src/Fixer/Phpdoc/PhpdocTypesFixer.php#L87">php-cs-fixer</a> where <code>RuleDefinition</code> is part of every rule.</p>
<p><br></p>
<p>Add an <code>DocumentedRuleInterface</code> interface and implement <code>getRuleDefinition()</code>:</p>
<pre><code class="language-php">namespace App\CodingStandard\Fixer;

use Symplify\RuleDocGenerator\ValueObject\RuleDefinition;
use Symplify\RuleDocGenerator\ValueObject\CodeSample\CodeSample;
use Symplify\RuleDocGenerator\Contract\DocumentedRuleInterface;

final class RemoveCommentedCodeFixer implements DocumentedRuleInterface
{
    public function getRuleDefinition(): RuleDefinition
    {
        return new RuleDefinition('Remove commented code', [
            new CodeSample(
                &lt;&lt;&lt;'CODE_SAMPLE'
// $one = 1;
// $two = 2;
// $three = 3;
CODE_SAMPLE
                ,
                &lt;&lt;&lt;'CODE_SAMPLE'
CODE_SAMPLE
            ),
        ]);
    }
}</code></pre>
<p>That's it!</p>
<h2 id="3-steps-to-Generated-Documentation">3 steps to Generated Documentation</h2>
<p>The <a href="https://github.com/symplify/rule-doc-generator">Symplify\RuleDocGenerator</a> packages take care of full documentation. There is just one interface to implement for Rector, PHP CS Fixer, CodeSniffer, and PHPStan rules.</p>
<ol>
<li>Install Package</li>
</ol>
<pre><code class="language-bash">composer require symplify/rule-doc-generator</code></pre>
<ol start="2">
<li>Implement <code>DocumentedRuleInterface</code> interface</li>
</ol>
<p>You can pick from more code sample classes:</p>
<ul>
<li><code>CodeSample</code></li>
<li><code>ConfiguredCodeSample</code></li>
</ul>
<p>For read-only rules, e.g. Sniff or PHPStan, the second argument of <code>CodeSample</code> is for correct code:</p>
<pre><code class="language-php">use Symplify\RuleDocGenerator\ValueObject\CodeSample\CodeSample;

// ...
return new CodeSample('bad code', 'good code');</code></pre>
<ol start="3">
<li>Generate Documentation in CLI</li>
</ol>
<pre><code class="language-bash">vendor/bin/rule-doc-generator generate &lt;directories-with-rules&gt;</code></pre>
<p>There is also implicit <code>--output-file docs/rules_overview.md</code> option.</p>
<pre><code class="language-bash">vendor/bin/rule-doc-generator generate src/Rules</code></pre>
<p>↓</p>
<p>You've just created smart documentation with <strong>nice and clear design</strong>:</p>
<img src="/assets/images/posts/2020/rules-nesting-full.png" class="img-thumbnail mt-4 mb-5">
<p><strong>Tired of screenshots? See the Real Documentation on GitHub</strong></p>
<p>See our 3 documentations re-generated everyday with GitHub Actions cron:</p>
<ul>
<li><a href="https://github.com/rectorphp/rector/blob/master/docs/rector_rules_overview.md">Rector with 640 rules</a></li>
<li><a href="https://github.com/symplify/phpstan-rules/blob/master/docs/rules_overview.md">Symplify\PHPStanRules with 110 rules</a></li>
<li><a href="https://github.com/symplify/coding-standard/blob/master/docs/rules_overview.md">Symplify\CodingStandard with 15 rules</a></li>
</ul>
<p><br></p>
<p>That's it!</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/11/30/new-in-symplify-9-documentation-generator-for-php-cs-fixer-code-sniffer-phpstan-rector-rules</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 30 Nov 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/11/30/new-in-symplify-9-documentation-generator-for-php-cs-fixer-code-sniffer-phpstan-rector-rules#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to get a Dynamic PHP Version Matrix in GitHub Actions ]]></title>
                <link>https://tomasvotruba.com/blog/2020/11/23/how-to-get-dynamic-php-version-matrix-in-github-actions</link>
                <description><![CDATA[ <p>Do you want to run your tests on each PHP version you support? PHP 7.3, 7.4 and 8.0?
Instead of 3 workflows with copy-paste steps, you can define <strong>just one with a matrix for PHP versions</strong>.
<br><br>
But PHP is released every year. The version constraints are already defined in <code>composer.json</code>.
Hmm, how could we use this knowledge to provide a list of PHP version for a dynamic matrix?</p> ]]></description>
                <content:encoded><![CDATA[ <p>Do you know <a href="/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock/">memory locks</a>? An &quot;if this then that&quot; code smell. E.g., you always have to put keys into your left pocket, after you lock your office door.</p>
<p>If we have tests, we want <strong>them run on all PHP versions</strong> we support. To be sure, no PHP 8 features are running on PHP 7.4.</p>
<p><br></p>
<p><strong>When</strong> new PHP version <a href="/blog/2017/10/30/what-can-you-learn-from-menstruation-and-symfony-releases/">once a year</a>, <strong>then</strong> we have to:</p>
<ul>
<li>
<p>update <code>composer.json</code></p>
<img src="/assets/images/posts/2020/php-json-composer.png" class="img-thumbnail">
</li>
<li>
<p>update test workflow</p>
<img src="/assets/images/posts/2020/php-json-useless.png" class="img-thumbnail">
</li>
</ul>
<p><strong>This is utterly useless operation</strong> = double the work and double the maintenance—no gain, except the fear of control.</p>
<h2 id="Memory-Lock-is-Expensive">Memory Lock is Expensive</h2>
<p>Could you guess how much time it took to send both commits? 2 minutes? 10 minutes?</p>
<img src="/assets/images/posts/2020/php-json-time.png" class="img-thumbnail">
<p>Almost <strong>2 hours</strong>. I had to send a new commit based on feedback in code-review. That's a hidden cost of memory lock code smell.
Hidden cost in attention, work and <a href="/blog/2020/01/13/why-is-first-instant-feedback-crucial-to-developers/">slow feedback loop</a>.</p>
<h2 id="Trust-composer-json">Trust <code>composer.json</code></h2>
<p>What PHP version should be tested? The information is already in <code>composer.json</code>:</p>
<pre><code class="language-json">{
    "require": {
        "php": "^7.2|^8.0"
    }
}</code></pre>
<p>You're right. It's this list:</p>
<ul>
<li>7.2</li>
<li>7.3</li>
<li>7.4</li>
<li>8.0</li>
</ul>
<p>So <strong>why should we duplicate</strong> this information in the GitHub Actions workflow config?</p>
<p>We can do better with <a href="/blog/2020/11/16/how-to-make-dynamic-matrix-in-github-actions/">dynamic matrix</a>.</p>
<h2 id="EasyCI-to-the-Rescue">EasyCI to the Rescue</h2>
<p>Symplify 9 is coming with a brand new package called <a href="https://github.com/symplify/easy-ci">EasyCI</a>. This package helps you with CI maintenance, like in our case above:</p>
<pre><code class="language-bash">composer require symplify/easy-ci --dev

vendor/bin/easy-ci php-json
# "[7.2, 7.3, 7.4, 8.0]"</code></pre>
<p>Now we have a problem, the command to provide JSON data and GitHub Actions. Let's put them together.</p>
<h2 id="Workflow-with-Dynamic-PHP-Versions">Workflow with Dynamic PHP Versions</h2>
<p>There are <strong>2 steps</strong> in our unit tests workflow:</p>
<ul>
<li>first provides the list of PHP version</li>
<li>the other creates a dynamic job run with each PHP version</li>
</ul>
<h3 id="The-First-Step">The First Step</h3>
<pre><code class="language-yaml">jobs:
    # first step
    provide_php_versions_json:
        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@v2

            -   uses: shivammathur/setup-php@v2
                with:
                    # this is the only place we have to use PHP to avoid the lock to bash scripting
                    php-version: 8.0

            -   run: composer install --no-progress --ansi

            # to see the provided output, just to be sure
            -   run: vendor/bin/easy-ci php-versions-json

            # here we create the json, we need the "id:" so we can use it in "outputs" bellow
            -
                id: output_data
                run: echo "::set-output name=matrix::$(vendor/bin/easy-ci php-versions-json)"

        # here, we save the result of this 1st phase to the "outputs"
        outputs:
            matrix: ${{ steps.output_data.outputs.matrix }}</code></pre>
<h3 id="The-Second-Step">The Second Step</h3>
<pre><code class="language-yaml">    # continue from above
    unit_tests:
        needs: provide_php_versions_json

        runs-on: ubuntu-latest

        strategy:
            fail-fast: false
            matrix:
                php: ${{ fromJson(needs.provide_php_versions_json.outputs.matrix) }}

        # continue with tests
        steps:
            # ...
            -   run: vendor/bin/phpunit</code></pre>
<p><br></p>
<p>This workflow is not just a theory. <strong>It's tested for last week on Symplify repository</strong> and it works :).</p>
<p>Here is full <a href="https://github.com/symplify/symplify/blob/aeb8e03dfb2948474f5a7d267ab05541ee00d90b/.github/workflows/unit_tests.yaml"><code>.github/workflows/unit_tests.yaml</code></a> worfklow to explore.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/11/23/how-to-get-dynamic-php-version-matrix-in-github-actions</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 23 Nov 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/11/23/how-to-get-dynamic-php-version-matrix-in-github-actions#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to make a Dynamic Matrix in GitHub Actions ]]></title>
                <link>https://tomasvotruba.com/blog/2020/11/16/how-to-make-dynamic-matrix-in-github-actions</link>
                <description><![CDATA[ <p>Do you want <a href="/blog/2020/11/09/new-in-symplify-9-monorepo-split-with-github-action">split monorepo</a> for each package?
Instead of 20 workflows with copy-paste steps, you can define <strong>just one with a static matrix for packages</strong>.
<br><br>
Yet, nothing in real life is static but rather dynamic. A new package can be added, old can be removed.
How could we automate this even more with a <strong>dynamic matrix?</strong></p> ]]></description>
                <content:encoded><![CDATA[ <p>In the last post we talked about <a href="/blog/2020/11/09/new-in-symplify-9-monorepo-split-with-github-action">monorepo split</a> with GitHub Actions.</p>
<p>Today we'll look on a rather general idea for any GitHub Action - <strong>dynamic matrix</strong>.</p>
<h2 id="Static-Matrix">Static Matrix</h2>
<p>We've already talked about the use case for the split of many packages into many repositories. Instead of repeating each workflow with a different package, we can use <strong>a static matrix</strong>.</p>
<p>A typical static matrix looks like this:</p>
<pre><code class="language-yaml">jobs:
    monorepo_split:
        runs-on: ubuntu-latest

        strategy:
            matrix:
                package:
                    # list your packages here
                    - coding-standard
                    - phpstan-rules</code></pre>
<p>After you define the <code>strategy</code>, add steps that use <code>${{ matrix.package }}</code>.</p>
<pre><code class="language-yaml">        # ...
        steps:
            -   uses: actions/checkout@v2

            -
                uses: symplify/github-action-monorepo-split@master
                env:
                    GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}
                with:
                    package-directory: 'packages/${{ matrix.package }}'
                    split-repository-organization: 'symplify'
                    split-repository-name: '${{ matrix.package }}'</code></pre>
<p>For each item in <code>package:</code> a new workflow run will be triggered. So, in this case - matrix <strong>triggers 3 parallel runs</strong>.</p>
<p><br></p>
<h2 id="Matrix-is-an-Array">Matrix is an Array</h2>
<p>The above could be written in PHP like:</p>
<pre><code class="language-php">$matrix = [
    'packages' =&gt; [
        'coding-standard',
        'phpstan-rules',
    ]
];

foreach ($matrix['packages'] as $package) {
    $packageDirectory = 'packages/' . $package;
    $splitRepositoryName = $package;
    // ... do the magic
}</code></pre>
<p>Is there new package? Add it to the matrix:</p>
<pre><code class="language-diff">            matrix:
                package:
                    # list your packages here
                    - coding-standard
                    - phpstan-rules
+                   - easy-coding-standard</code></pre>
<p>That's it!</p>
<p><br></p>
<p>Any static opens up the door to troubles... How easy do you think <strong>is to <a href="/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock/">forget to extend</a></strong> the workflow <strong>after</strong> adding a new package?</p>
<h2 id="From-Static-Array-to-JSON">From Static Array to JSON</h2>
<p>GitHub Actions are ready to make our life easier. Since April 2020, there is <a href="https://github.blog/changelog/2020-04-15-github-actions-new-workflow-features/#new-fromjson-method-in-expressions">a <code>fromJson()</code> function</a> to help us. What does it do?</p>
<p>It converts a json to an array, like this:</p>
<pre><code class="language-diff">            matrix:
-                 package:
-                   - coding-standard
-                   - phpstan-rules
+                 package: ${{ fromJson(["coding-standard", "phpstan-rules"]) }}</code></pre>
<p>You are probably thinking, <em>&quot;Well, that's just terrible, Tomas&quot;</em>. Thank you, and you're right.</p>
<ul>
<li>But where is JSON, there is... an endpoint.</li>
<li><strong>And where is an endpoint, there is a space for dynamic output</strong>.</li>
</ul>
<p>The <a href="https://github.com/symplify/monorepo-builder">Symplify\MonorepoBuilder</a> is using this trick to <strong>get all the packages from <code>/packages</code> directory in handy json format</strong>:</p>
<pre><code class="language-bash">vendor/bin/monorepo-builder packages-json</code></pre>
<p>↓</p>
<pre><code class="language-json">[
    "coding-standard",
    "phpstan-rules"
]</code></pre>
<p>This version is not final, but very roughly the command above would be written like this:</p>
<pre><code class="language-diff">-           matrix: ${{ fromJson(["coding-standard", "phpstan-rules"]) }}
+           matrix: ${{ fromJson(vendor/bin/monorepo-builder packages-json) }}</code></pre>
<h2 id="From-Json-to-Fully-Dynamic-Matrix">From Json to Fully Dynamic Matrix</h2>
<p>If we run the command above as it is, it would fail. Setting up a matrix is like the <code>setUp()</code> method in a PHPUnit test case - there is zero code executed before it.</p>
<ul>
<li><strong>That's why we use <code>setUp()</code> method</strong> to actually <em>set</em> what we need first.</li>
<li>Then run <code>test()</code> method.</li>
</ul>
<p><br></p>
<p>We have to do the same here:</p>
<ul>
<li>In the 1st step, we create the JSON with all packages</li>
<li>In the 2nd step, we use this JSON as input for the matrix, <strong>that will create a standalone run for each package</strong></li>
</ul>
<h3 id="How-does-the-Workflow-look-Like">How does the Workflow look Like?</h3>
<pre><code class="language-yaml">jobs:
    # phase 1
    provide_packages_json:
        runs-on: ubuntu-latest

        steps:
            # git clone + use PHP + composer install
            -   uses: actions/checkout@v2
            -   uses: shivammathur/setup-php@v2
                with:
                    php-version: 7.4
            -   run: composer install --no-progress --ansi

            # here we create the json, we need the "id:" so we can use it in "outputs" bellow
            -
                id: set-matrix
                run: echo "::set-output name=matrix::$(vendor/bin/monorepo-builder packages-json --names)"

        # here, we save the result of this 1st phase to the "outputs"
        outputs:
            matrix: ${{ steps.set-matrix.outputs.matrix }}

    # phase 2
    split_monorepo:
        # this means, wait for the "provide_packages_json" phase 1 to finish
        needs: provide_packages_json

        runs-on: ubuntu-latest
        strategy:
            # ↓ the real magic happens here - create dynamic matrix from the json
            matrix:
                package: ${{ fromJson(needs.provide_packages_json.outputs.matrix) }}

        steps:
            # ...</code></pre>
<p>That's it!</p>
<p>This way, we'll <strong>never forget</strong> to split nor test a new package. Never.</p>
<p><br></p>
<p>Check fully functional <a href="https://github.com/symplify/symplify/blob/master/.github/workflows/split_monorepo.yaml"><code>.github/workflows/split_monorepo.yaml</code></a> in Symplify monorepo for more details.</p>
<p>Is this something niche? Not really. This week, Kamil <a href="https://github.com/Sylius/Sylius/blob/3464e8d0ae6673d9ee1da3d538a6b399cfcb9852/.github/workflows/packages.yml#L48">has added this approach to Sylius too</a>.</p>
<h2 id="Use-for-Monorepo-Split-Anything-Dynamic">Use for <del>Monorepo Split</del> Anything Dynamic!</h2>
<p>This <code>fromJson()</code> trick is not something exclusive to monorepo package splitting. It's just one of the possible use cases.</p>
<p>The primary use case <strong>is already in your mind</strong>.</p>
<ul>
<li>What is repeated static in your CI?</li>
<li>What lists can be delegated to simple command that already knows the data?</li>
<li><strong>How could you use the dynamic matrix in your workflows today?</strong></li>
</ul>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/11/16/how-to-make-dynamic-matrix-in-github-actions</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 16 Nov 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/11/16/how-to-make-dynamic-matrix-in-github-actions#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ New in Symplify 9: Monorepo Split with GitHub Action ]]></title>
                <link>https://tomasvotruba.com/blog/2020/11/09/new-in-symplify-9-monorepo-split-with-github-action</link>
                <description><![CDATA[ <p>Until now, monorepo split in Symplify was <a href="/blog/2020/11/02/symplify-monorepo-builder-split-fractal-of-bad-design/">one big fractal of bad design</a>. In Symplify 9 and with technologies of 2020, we've decided to change that.
<br>
<br>
<strong>To simple setup in a single GitHub Action.</strong></p> ]]></description>
                <content:encoded><![CDATA[ <p>In past years, the <code>split</code> command was one of the poorest part of whole Symplify code base. <a href="/blog/2020/11/02/symplify-monorepo-builder-split-fractal-of-bad-design/">Here is why</a>.</p>
<p><br></p>
<p>In Symplify 9, <strong>we've finally fixed it</strong> - with a <a href="https://github.com/symplify/monorepo-split-github-action"><code>symplify/monorepo-split-github-action</code></a> ↓</p>
<div class="text-center mt-3 mb-5">
    <img src="/assets/images/posts/2020/split_monorepo.png" class="img-thumbnail">
    <br>
    <em>42 packages split under <strong>3,5 minutes</strong></em>
</div>
<h2 id="Battle-Tested">Battle Tested</h2>
<p>We've been testing it last 3 weeks on 3 different monorepos. Nathan, good friend of mine, was eager to test them too on <a href="https://github.com/eonx-com/easy-monorepo/blob/master/.github/workflows/split_packages.yml">eonx-com monorepo</a>.</p>
<p>This week, also <a href="https://github.com/ruudk">Ruud Kamphuis</a> <a href="https://github.com/symplify/github-actions/commits?author=ruudk">pushed</a> the package even further - thank you Ruud.</p>
<p>After dozens of successful GitHub Actions runs we're ready to go public - <strong>to you</strong>!</p>
<h2 id="GitHub-Actions-Composer-for-your-CI">GitHub Actions - Composer for your CI</h2>
<p>The idea of GitHub Actions is as simple as Composer or Dependency Injection: <strong>Do you need something? Ask for it.</strong></p>
<p>If you're not yet familiar with GitHub Actions, give them a try. <a href="/blog/2020/01/27/switch-travis-to-github-actions-to-reduce-stress/">I first tried them almost a year ago</a>, and every month I found something new to fell in love with.</p>
<h2 id="The-Simplest-GitHub-Action-for-1-Package-Split">The Simplest GitHub Action for 1 Package Split</h2>
<p>Do you need a monorepo split? Ask for it:</p>
<pre><code class="language-yaml"># .github/workflows_monorepo_split.yaml
name: 'Monorepo Split'

on:
    push:
        branches:
            - main

jobs:
    monorepo_split:
        runs-on: ubuntu-latest

        steps:
            -   uses: actions/checkout@v2

            -
                uses: "symplify/monorepo-split-github-action@master"
                env:
                    GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}
                with:
                    # ↓ split "packages/easy-coding-standard" directory
                    package-directory: 'packages/easy-coding-standard'

                    # ↓ into https://github.com/symplify/easy-coding-standard repository
                    split-repository-organization: 'symplify'
                    split-repository-name: 'easy-coding-standard'

                    # ↓ the user signed under the split commit
                    user-name: "kaizen-ci"
                    user-email: "info@kaizen-ci.org"</code></pre>
<p>The section <code>with:</code> is where you configure the output.</p>
<ul>
<li>
<p><code>package-directory</code> is a local path to your split package, e.g. 'packages/easy-coding-standard'</p>
</li>
<li>
<p><code>split-repository-organization</code> and <code>split-repository-name</code> is name of repository on GitHub - basically <code>symplify/easy-coding-standard</code></p>
</li>
</ul>
<h2 id="How-to-Split-with-Tags">How to Split with Tags?</h2>
<p>What is splitting good for without tags, right?</p>
<p>We need a tag, so we ask for it <a href="https://github.com/WyriHaximus/github-action-get-previous-tag">WyriHaximus/github-action-get-previous-tag</a>:</p>
<pre><code class="language-diff"> # .github/workflows_monorepo_split.yaml
 name: 'Monorepo Split'

 on:
     push:
         branches:
             - master

 jobs:
     monorepo_split:
         runs-on: ubuntu-latest

         steps:
             -
                 uses: actions/checkout@v2
+                # this is required for "WyriHaximus/github-action-get-previous-tag" workflow
+                # see https://github.com/actions/checkout#fetch-all-history-for-all-tags-and-branches
+                with:
+                    fetch-depth: 0

+            # get a tag see https://github.com/WyriHaximus/github-action-get-previous-tag
+            -
+                id: previous_tag
+                uses: "WyriHaximus/github-action-get-previous-tag@master"

            -
                uses: "symplify/monorepo-split-github-action@master"
                env:
                    GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}
                with:
                    package-directory: 'packages/easy-coding-standard'
                    split-repository-organization: 'symplify'
                    split-repository-name: 'easy-coding-standard'

+                   tag: ${{ steps.previous_tag.outputs.tag }}

                    # ↓ the user signed under the split commit
                    user-name: "kaizen-ci"
                    user-email: "info@kaizen-ci.org"</code></pre>
<h2 id="How-to-Split-Multiple-Packages">How to Split Multiple Packages?</h2>
<p>But wait, that's just one package. How can we do it for all 15 of them? Do we need 15 workflows files like this?</p>
<p>No, GitHub Actions are ready for this - add <code>strategy</code> section:</p>
<pre><code class="language-diff"> ...
 jobs:
     monorepo_split:
         runs-on: ubuntu-latest

+        strategy:
+           fail-fast: false
+           matrix:
+               package:
+                    # list your packages here
+                    - easy-coding-standard
+                    - phpstan-rules</code></pre>
<p>And update <code>with:</code> section with dynamic content:</p>
<pre><code class="language-diff">                with:
-                   package-directory: 'packages/easy-coding-standard'
+                   package-directory: 'packages/${{ matrix.package }}'
                    split-repository-organization: 'symplify'
-                   split-repository-name: 'easy-coding-standard'
+                   split-repository-name: '${{ matrix.package }}'</code></pre>
<p><strong>This is a vast performance improvement</strong>, just like a parallel run.</p>
<p>Now GitHub Actions will run a standalone build for each package provided.</p>
<p>That's it!</p>
<p><br></p>
<h2 id="How-to-migrate-Symplify-8-to-Symplify-9">How to migrate Symplify 8 to Symplify 9?</h2>
<p>The <code>split</code> command <a href="https://github.com/symplify/symplify/pull/2490/files#diff-f4265307118be2f5d2389968d183656ebf8a0e8a7e711ed42101bd1bb179034f">was dropped in Symplify 9</a>. Do you use it?</p>
<p><br></p>
<p>We've prepared a 3 step switch for you:</p>
<ol>
<li>Remove <code>directories_to_repositories</code> parameter <code>from monorepo-builder.(yaml|php)</code>:</li>
</ol>
<pre><code class="language-diff"> use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
 use Symplify\MonorepoBuilder\ValueObject\Option;

 return function (ContainerConfigurator $containerConfigurator): void {
     $parameters = $containerConfigurator-&gt;parameters();
-    $parameters-&gt;set(Option::DIRECTORIES_TO_REPOSITORIES, [
-        'packages/*' =&gt; 'git@github.com:symplify/*.git',
-    ]);
};</code></pre>
<ol start="2">
<li>Remove current <code>split</code> command from GitHub Action:</li>
</ol>
<pre><code class="language-bash">vendor/bin/monorepo-builder split</code></pre>
<ol start="3">
<li>Add GitHub Action with a list of your packages in a <code>matrix</code></li>
</ol>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/11/09/new-in-symplify-9-monorepo-split-with-github-action</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 09 Nov 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/11/09/new-in-symplify-9-monorepo-split-with-github-action#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Symplify Monorepo Builder Split - Fractal of Bad Design ]]></title>
                <link>https://tomasvotruba.com/blog/2020/11/02/symplify-monorepo-builder-split-fractal-of-bad-design</link>
                <description><![CDATA[ <p>Splitting monorepo is a trivial operation of getting some code to some repository. Unless your take into rocket science like Symplify does. It is slow, complicated, and doesn't work on GitHub, where the open-source lives.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="1-It-s-Super-Slow">1. It's Super Slow</h2>
<p><a href="https://github.com/symplify/monorepo-builder">Symplify/MonorepoBuilder</a> is easy to set up and easy to use:</p>
<pre><code class="language-bash">vendor/bin/monorepo split</code></pre>
<p>But the split operation itself is not really Usain Bolt among <a href="/blog/2020/01/13/why-is-first-instant-feedback-crucial-to-developers/">instant feedbacks</a>:</p>
<blockquote class="blockquote text-center">
<p>&quot;...symplify/monorepo-builder ... <strong>takes ~20 minutes</strong> to go through and roll out all packages, one by one&quot;</p>
<footer class="blockquote-footer">
        <cite><a href="https://github.com/zf1s/zf1/issues/33#issuecomment-732113017">Zend Framework split</a></cite>
    </footer>
</blockquote>
<p><br></p>
<p>As for Symplify, if we merge pull-request, <strong>it takes ~8 minutes to use the code</strong>.
It takes ~4&nbsp;minutes of waiting for Travis to notice, then 3 minutes to split ~15 packages, and 1 minute to trigger Packagist.</p>
<p>Found a typo in the return type? Commit and... wait 8 minutes. That is bad and breaks the flow and your productivity.</p>
<h2 id="2-It-s-so-Slow-Despite-having-Parallel-Run">2. It's so Slow, Despite having Parallel Run</h2>
<p>A typical solution for such performance issues is <a href="https://phpstan.org/blog/from-minutes-to-seconds-massive-performance-gains-in-phpstan">running it in parallel processes</a>. The speed gain is x-times, where <code>x</code> is the number of CPUs your machine has.</p>
<pre><code class="language-bash">vendor/bin/monorepo-builder split --max-processes 6</code></pre>
<p><a href="https://github.com/symplify/symplify/pull/620">Before we added parallel run</a>, it took <strong>over 7 minutes</strong> on just <strong>8 packages</strong>!</p>
<h2 id="3-It-s-Rocket-Science-at-it-s-Worst">3. It's Rocket Science at it's Worst</h2>
<p><strong>What is a monorepo split?</strong></p>
<ul>
<li>take some subdirectory</li>
<li>push it into some remote git repository</li>
</ul>
<p><br></p>
<p>That's it! Nothing fancy, nothing that needs an MIT degree. Still, the Symplify implementation includes these layers:</p>
<ul>
<li>git to do the split</li>
<li><a href="https://github.com/symplify/monorepo-builder/blob/db9a1aa840092a66234c166cbcc9d6d9196d81b1/packages/Split/bash/subsplit.sh">163-lines bash script to handle the git</a></li>
<li>PHP command to wrap the bash script</li>
<li>Travis bash script to run the PHP command in CLI</li>
<li>...</li>
</ul>
<img src="/assets/images/posts/2020/symplify_monorepo_split.jpg" class="img-thumbnail">
<p>Why keep it simple, right?</p>
<h2 id="4-It-has-The-Worst-Error-Message-Output">4. It has The Worst Error Message Output</h2>
<p>Thanks to previous Inception-complexity, the code can break in any of these layers. From git to invalid bash syntax to a tool that wraps the Git API in PHP or typo in the target directory.</p>
<p>In <a href="https://travis-ci.com/github/symplify/symplify/jobs/363743493">reality</a>, you get something like this:</p>
<img src="/assets/images/posts/2020/symplify_monorepo_fail.png" class="img-thumbnail">
<p>I do appreciate a good error message.</p>
<h2 id="5-It-Depends-on-both-Travis-and-GitHub">5. It Depends on both Travis and GitHub</h2>
<p>If you want to make it work on your monorepo, <a href="/blog/2018/07/19/how-to-make-github-and-travis-split-monorepo-to-multiple-git-repositories-for-you/">you have to follow these steps</a>:</p>
<ul>
<li>go to GitHub to get a token</li>
<li>go to Travis, set the token</li>
<li>add .travis.yml</li>
<li>add monorepo-builder.yml</li>
</ul>
<img src="/assets/images/posts/2020/symplify_monorepo_long.png" class="img-thumbnail">
<p>The <a href="/blog/2019/03/11/why-we-migrated-from-nette-to-symfony-in-3-weeks-part-3/">vendor-lock</a> on 2 services - GitHub and Travis - might be do-able for open-source maintainers. But if you just want to start with monorepo, learning <strong>2 services at once is a killer</strong>.</p>
<p><br></p>
<p>There is no need for that. And yes, there is a better way to handle automated monorepo split. I'll show you in the next post.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/11/02/symplify-monorepo-builder-split-fractal-of-bad-design</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 02 Nov 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/11/02/symplify-monorepo-builder-split-fractal-of-bad-design#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ New in Symplify 9: Composer Json Manipulator - In Object API ]]></title>
                <link>https://tomasvotruba.com/blog/2020/10/31/new-in-symplify-9-composer-json-manipulator-in-object-api</link>
                <description><![CDATA[ <p>Have you ever needed to modify <code>composer.json</code> with PHP code? Then you're familiar with <code>$json['require']['php'] ?? null</code> structures.
They're hell to work with as any other array - verify the value if it's null, how deeply nested it is, etc.
<br>
<br>
This is typical use case for <a href="/blog/2019/10/28/all-you-always-wanted-to-know-about-monorepo-but-were-afraid-to-ask">a monorepo</a>, where we need to <strong>merge many nested <code>composer.json</code> files</strong> into a root <code>composer.json</code>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>With an array, it's mission impossible. What about intuitive methods on simple value object? You'd expect such package to exist in PHP world - but there <a href="https://packagist.org/?query=composer-json">is none</a>. So we made <strong>an object wrapper that handles all your worries</strong>:</p>
<pre><code class="language-php">/** @var \Symplify\ComposerJsonManipulator\ValueObject\ComposerJson $composerJson */
$composerJson = ...;

// get directories that should exists
$composerJson-&gt;getAbsoluteAutoloadDirectories();

// get minimum stability
$composerJson-&gt;getMinimumStability();

// it's ready for print
$composerJson-&gt;getJsonArray();

// change value
$composerJson-&gt;setLicense('MIT');</code></pre>
<p>We've been testing <a href="https://github.com/symplify/composer-json-manipulator">the symplify/composer-json-manipulator package</a> for a couple of <del>weeks</del> months, just to be sure it works well in practise.</p>
<img src="/assets/images/posts/2020/composer-json-manipulator-tested.png" class="img-thumbnail">
<p>It has over <a href="https://packagist.org/packages/symplify/composer-json-manipulator/stats">240 000 downloads</a> now.</p>
<h2 id="3-Steps-to-Create-ComposerJson-object">3 Steps to Create <code>ComposerJson</code> object</h2>
<h3 id="1-Install-the-Package">1. Install the Package</h3>
<pre><code class="language-bash">composer require symplify/composer-json-manipulator --dev</code></pre>
<p>Register bundle:</p>
<pre><code class="language-php">// config/bundles.php

declare(strict_types=1);

return [
    Symplify\ComposerJsonManipulator\ComposerJsonManipulatorBundle::class =&gt; [
        'all' =&gt; true,
    ],
];</code></pre>
<h3 id="2-Create-ComposerJson-with-a-Factory">2. Create <code>ComposerJson</code> with a Factory</h3>
<pre><code class="language-php">declare(strict_types=1);

namespace App;

use Symplify\ComposerJsonManipulator\ComposerJsonFactory;
use Symplify\ComposerJsonManipulator\ValueObject\ComposerJson;
use Symplify\SmartFileSystem\SmartFileInfo;

final class SomeClass
{
    /**
     * @var ComposerJsonFactory
     */
    private $composerJsonFactory;

    public function __construct(ComposerJsonFactory $composerJsonFactory)
    {
        $this-&gt;composerJsonFactory = $composerJsonFactory;
    }

    public function createFromExisting(): ComposerJson
    {
        $fileInfo = new SmartFileInfo(getcwd() . '/composer.json');
        $composerJson = $this-&gt;composerJsonFactory-&gt;createFromFileInfo($fileInfo);

        // analyse/modify $composerJson

        return $composerJson;
    }

    public function createNew(): ComposerJson
    {
        $composerJson = $this-&gt;composerJsonFactory-&gt;createEmpty();
        $composerJson-&gt;setPreferStable(true);

        return $composerJson;
    }
}</code></pre>
<h3 id="3-Print-modified-ComposerJson">3. Print modified <code>ComposerJson</code></h3>
<pre><code class="language-php">namespace App;

use Symplify\ComposerJsonManipulator\Printer\ComposerJsonPrinter;

class SomeClass
{
    /**
     * @var ComposerJsonPrinter
     */
    private $composerJsonPrinter;

    public function __construct(ComposerJsonPrinter $composerJsonPrinter)
    {
        $this-&gt;composerJsonPrinter = $composerJsonPrinter;
    }

    public function printAndReport(ComposerJson $composerJson)
    {
        // the file is saved + printed content returned
        $printedContent = $this-&gt;composerJsonPrinter-&gt;print(
            $composerJson,
            getcwd() . '/composer.json'
        );

        // show it to user $printedContent, so they know what was printed
    }
}</code></pre>
<p>That's it! The <code>ComposerJson</code> is not 1:1 to full composer schema. That would be a mess full of methods and constants that are rarely used in practice. Instead, it has only the method we used.</p>
<p><strong>Do you miss some method?</strong> No problem, <a href="https://github.com/symplify/symplify">send a pull-request to add it</a>. That way, we'll know someone will use it and we'll be happy to merge it.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/10/31/new-in-symplify-9-composer-json-manipulator-in-object-api</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Sat, 31 Oct 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/10/31/new-in-symplify-9-composer-json-manipulator-in-object-api#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ The Bullet Proof Symfony Command Naming ]]></title>
                <link>https://tomasvotruba.com/blog/2020/10/26/the-bullet-proof-symfony-command-naming</link>
                <description><![CDATA[ <p>How do you name your Symfony commands? <code>&lt;Something&gt;Commands</code> for the class. What about its console name?
<br>
<br>
If you're like most people, you don't think about such details that at all.
But that makes <a href="/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock">you think twice every time you create a new command</a>.
<br>
<br>
If you're lazy like me, you have a convention and create one command after another, knowing the naming is based on... we'll get to it.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Today I was making a new package that handles 1-click scoping for monorepo packages. I created this command:</p>
<pre><code class="language-php">use Symfony\Component\Console\Command;

final class GenerateWorkflowCommand extends Command
{
}</code></pre>
<p>The hard question: how would you name it?</p>
<pre><code class="language-bash">bin/console ?
bin/console generate
bin/console generate-workflow
bin/console gen-wof
...</code></pre>
<h2 id="Principle-of-the-Least-Surprise">Principle of the Least Surprise</h2>
<p>Do you prefer to code with many rules and various principles across the whole codebase or with one clear way to do things? Let's look at existing principles in the Symfony ecosystem that prefer the latter:</p>
<p><br></p>
<p>How do you name action in <strong>Single Action Controller</strong>?</p>
<pre><code class="language-php">final class PostDetailController extends Controller
{
    public function __invoke(Request $request): Response
    {
    }
}</code></pre>
<p>You don't. It's always <code>__invoke()</code>, and the class is already named.</p>
<p><br></p>
<p>How do you name an event for <strong>Event classes</strong>?</p>
<pre><code class="language-php">$postAddedEvent = new PostAddedEvent($post);
$this-&gt;eventDispatcher-&gt;dispatch($postAddedEvent);</code></pre>
<p>You don't. It's based on <code>&lt;event-class&gt;::class</code>.</p>
<p><br></p>
<p>Seeing this, how would name a command?...</p>
<p><br></p>
<p>You wouldn't.</p>
<p><em>&quot;Wait, what?&quot;</em></p>
<p><br></p>
<p>For ages, the name is information <a href="/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock">coupled to a command class</a>. Imagine that's not the best practice. It's just a practice of habit. What other options we have?</p>
<h2 id="Where-do-we-Name-a-Command"><em>Where</em> do we Name a Command?</h2>
<pre><code class="language-php">use Symfony\Component\Console\Command;

final class GenerateWorkflowCommand extends Command
{
    // here
    protected static $defaultName = '...';

    // or

    // here
    public function configure(): void
    {
        $this-&gt;setName('...');
    }
}</code></pre>
<p>In pre-historic Symfony versions, you could also use manual name registration in a config file.</p>
<p><br></p>
<p>All of these options have one problem in common. <strong>When</strong> we create command → we <strong>have to</strong> think of its name. <strong>If this, then that</strong> (imagine startup for this, right?). Also, we have to add it in the right place - which of those three would you pick? We don't care. We don't want to think about that.</p>
<p>Why? <strong>Because we want to think about the contents of the <code>execute()</code> method.</strong> That's the fun part.</p>
<h2 id="What-about-Class-based-Naming">What about Class-based Naming?</h2>
<pre><code class="language-php">final class GenerateWorkflowCommand extends Command { ... }</code></pre>
<p>↓</p>
<pre><code class="language-bash">bin/console generate-workflow</code></pre>
<p><br></p>
<pre><code class="language-php">final class DumpStaticSiteCommand extends Command { ... }</code></pre>
<p>↓</p>
<pre><code class="language-bash">bin/console dump-static-site</code></pre>
<p>You get the idea. In PHP code, it would look like this:</p>
<pre><code class="language-php">use Symfony\Component\Console\Command;

final class GenerateWorkflowCommand extends Command
{
    public function configure(): void
    {
        $this-&gt;setName('generate-worfklow');
    }
}</code></pre>
<p>Pretty clear, right?</p>
<p><em>&quot;But wait, Tomas! You still need to think about the name. Also, you've just made a typo, lol.&quot;</em></p>
<pre><code class="language-diff">-       $this-&gt;setName('generate-worfklow');
+       $this-&gt;setName('generate-workflow');</code></pre>
<p>Well, that happens when you try to impress your readers.</p>
<p>How could we avoid such an awkward situation? If you contribute Symplify, you already know the answer... or if you get inspiration from <strong>the controller and event classes</strong> above.</p>
<p><br></p>
<p><em>&quot;Use the <code>&lt;command&gt;::class</code>!&quot;</em></p>
<p><br></p>
<p>That's right!</p>
<pre><code class="language-php">$this-&gt;setName(GenerateWorkflowCommand::class);</code></pre>
<p>Not like this. With some conversion method:</p>
<pre><code class="language-php">use Symplify\PackageBuilder\Console\Command\CommandNaming;

$this-&gt;setName(CommandNaming::classToName(GenerateWorkflowCommand::class));</code></pre>
<p>That's better!</p>
<p><em>&quot;Well, now we don't have to think about the name. But it's much more new code we have to use. Also, you said <a href="/blog/2020/08/31/how-static-methods-kills-you-like-corona">static will slowly kill  you</a>, right?&quot;</em></p>
<h2 id="Handle-Command-Naming-in-1-Place">Handle Command Naming in 1 Place</h2>
<p>I don't like it either. It's just another variation of crap code. What about handling the command names in 1 place only? Would that do?</p>
<p><em>&quot;Uhm, maybe... what do you mean?&quot;</em></p>
<pre><code class="language-php">use Symfony\Component\Console\Application;
use Symfony\Component\Console\Command;
use Symplify\PackageBuilder\Console\Command\CommandNaming;

final class PackageScoperApplication extends Application
{

    /**
     * Add names to all commands by class-name convention
     * @param Command[] $commands
     */
    public function addCommands(array $commands): void
    {
        // or pass in the constructor
        $commandNaming = new CommandNaming();

        foreach ($commands as $command) {
            $commandName = $commandNaming-&gt;resolveFromCommand($command);
            $command-&gt;setName($commandName);
        }

        parent::addCommands($commands);
    }
}</code></pre>
<p>That's it!</p>
<ul>
<li>1 place to handle command naming ✅</li>
<li>no more typos ✅</li>
<li>don't ever think about that ✅</li>
</ul>
<pre><code class="language-diff"> use Symfony\Component\Console\Command;

 final class GenerateWorkflowCommand extends Command
 {
     public function configure(): void
     {
-        $this-&gt;setName('generate-worfklow');
     }
 }</code></pre>
<p>There is one disadvantage, though. In case of command rename, the configs that use the command have to updated too ❌</p>
<p>Is it a good trade-off? I don't know.</p>
<p><br></p>
<p><strong>What is your way to not care about command naming?</strong> Let me know in the comments. I'm really curious. It seems like a small irrelevant issue, but if I could choose to have one less issue to worry about, I'd take it and focus on something that needs my attention.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/10/26/the-bullet-proof-symfony-command-naming</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 26 Oct 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/10/26/the-bullet-proof-symfony-command-naming#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Split Test Monorepo with Composer 2 ]]></title>
                <link>https://tomasvotruba.com/blog/2020/10/19/how-to-split-test-monorepo-with-composer-2</link>
                <description><![CDATA[ <p><a href="https://twitter.com/packagist/status/1319945203797708800">Composer 2 was released</a> this week. It brings <strong>massive <code>composer install/update</code> performance</strong> improvement of <a href="https://blog.packagist.com/composer-2-0-is-now-available">150-200 %</a>.
<br>
<br>
That means <a href="/blog/2020/01/13/why-is-first-instant-feedback-crucial-to-developers/">faster feedback</a> from CI and faster monorepo testing.
<br>
<br>
Today, we'll look on how to use Composer in Github Actions with monorepo split testing and what to avoid.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Monorepo split testing is made easier by <a href="https://github.com/symplify/monorepo-builder"><code>symplify/monorepo-builder</code> package</a>. This is how it <a href="/blog/2020/02/10/how-to-test-monorepo-after-split-before-actual-split/">&quot;works&quot; for Composer 1</a>. Why &quot;works&quot;? There are 2 problems, that we fix during upgrade to Composer 2.</p>
<p><br></p>
<p>Let's say we have a <code>symplify/symplify</code> monorepo, where we develop all <code>symplify</code> package. We need to test all packages together <strong>with their local version</strong>, even in pull-request.</p>
<h2 id="1-Installing-Packages-that-needs-Local-version-Package">1. Installing Packages that needs Local version Package</h2>
<p>We want to test <code>symplify/coding-standard</code> package:</p>
<ul>
<li>the <code>symplify/coding-standard</code> package needs <code>symplify/autowire-array-parameter</code> package
<ul>
<li>the <code>symplify/autowire-array-parameter</code> needs the <code>symplify/package-builder</code> package</li>
</ul></li>
</ul>
<p>In short:</p>
<ul>
<li>we're testing <em>a</em></li>
<li><em>a</em> needs <em>b</em>
<ul>
<li><em>b</em> needs <em>c</em></li>
</ul></li>
</ul>
<p><br></p>
<p>This the result of localized package <code>composer install</code> on GitHub Action with Composer 1:</p>
<ul>
<li>Package <em>a</em> and <em>b</em> and used in local version ✅</li>
<li>Package <em>c</em> is used from packagist ❌</li>
</ul>
<img src="/assets/images/posts/2020/test_split_composer_2_require_3rd_package_fail.png" class="img-thumbnail">
<p>What happens with changes of <code>symplify/package-builder</code> in this pull-request? <strong>They're ignored</strong>, and last stable version is used instead. ❌</p>
<p><br></p>
<p>This is the same process, with <strong>Composer 2</strong>:</p>
<ul>
<li>Package <em>a</em> and <em>b</em> and used in local version ✅</li>
<li>Package <em>c</em> is used in local version ✅</li>
</ul>
<img src="/assets/images/posts/2020/test_split_composer_2_require_3rd_package_fixed.png" class="img-thumbnail">
<h2 id="2-State-Local-packages-as-dev-master">2. State Local packages as <code>dev-master</code></h2>
<p>So we upgrade to Composer 2 with Symplify 9 and that's it? No.</p>
<p>Local and GitHub Action development are different. Locally, Composer can see them as <code>dev-master</code> branch, which works with using <code>branch-alias</code>. But on GitHub Actoin (or your any favorite CI, the pull-request branch is <code>dev-&lt;commit-hash&gt;</code>).</p>
<p><br></p>
<p>The <code>composer install</code> will lead to a conflict with these 2 version:</p>
<img src="/assets/images/posts/2020/test_split_composer_2_require_3rd_package_mess.png" class="img-thumbnail">
<p>What now?</p>
<p>I asked on Composer repository and after less than hour of work got <a href="https://github.com/composer/composer/issues/9368#issuecomment-718198161">a working solution with proper explanation</a>. Thank you Jordi!</p>
<p>Trick is using <code>COMPOSER_ROOT_VERSION=dev-master</code> env, that will explicitly make version <code>dev-master</code> for all environments.</p>
<p><br></p>
<p>This is the final working GitHub Action (here you can see <a href="https://github.com/symplify/symplify/blob/40dbc8005754254aee31316b9082826f30b51577/.github/workflows/split_tests.yaml">it the action</a>):</p>
<pre><code class="language-yaml">name: Split Tests

on:
    pull_request: null

jobs:
    split_testing:
        runs-on: ubuntu-latest

        strategy:
            fail-fast: false
            matrix:
                package_name:
                    - coding-standard
                    # and all the other packages...

        name: Split Tests of ${{ matrix.package_name }}

        steps:
            -   uses: actions/checkout@v2

            -   uses: shivammathur/setup-php@v1
                with:
                    php-version: 7.4
                    coverage: none
                    tools: composer:v2

            -   run: composer install --no-progress --ansi

            # tell composer to use local package version
            -   run: vendor/bin/monorepo-builder localize-composer-paths packages/${{ matrix.package_name }}/composer.json --ansi

            -
                working-directory: packages/${{ matrix.package_name }}
                run: composer update --no-progress --ansi
                env:
                    # see https://github.com/composer/composer/issues/9368#issuecomment-718112361
                    COMPOSER_ROOT_VERSION: "dev-master"

            -
                working-directory: packages/${{ matrix.package_name }}
                run: vendor/bin/phpunit</code></pre>
<p><br></p>
<p>Do you want to know more about this topic?</p>
<ul>
<li><a href="https://github.com/composer/composer/issues/9368">Issue on Composer</a></li>
<li><a href="https://getcomposer.org/doc/articles/repository-priorities.md#canonical-repositories">Canonical Repositories</a> and their <a href="https://getcomposer.org/doc/articles/repository-priorities.md#default-behavior">change in Composer 2</a></li>
</ul>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/10/19/how-to-split-test-monorepo-with-composer-2</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 19 Oct 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/10/19/how-to-split-test-monorepo-with-composer-2#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How We Stopped Merging Pull Requests ]]></title>
                <link>https://tomasvotruba.com/blog/2020/10/12/how-we-stopped-merging-pull-requests</link>
                <description><![CDATA[ <p>What comes before merging a pull request? Code-review, feedback from developers, and fixes to make the reviewer happy. After that, we only need the tests, coding standard, PHPStan, and Rector to pass in the CI.
<br><br>
Here is an idea - <strong>don't merge any pull-request from now on</strong>...</p> ]]></description>
                <content:encoded><![CDATA[ <p>...and let them opened for ages... no, just kidding.</p>
<h2 id="Don-t-forget-to-Merge">Don't forget to Merge</h2>
<p>But if you already accepted the pull-request, the issues are resolved, <strong>you still have to wait for CI to finish with green</strong>. If you're lucky, it's under 3 minutes, if you're open source 5-8 minutes and with private project 5-30 minutes.</p>
<p>How to kill the waiting time? Go for a coffee, toilet break, or a social leak (Facebook, Twitter, or your favorite PHP blog), get back, see the green checkbox, and click on the merge button. <strong>Or even worse</strong> - you jump to another issue, <a href="/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock/">remember to merge</a>, then switch your focus back and forth...</p>
<img src="/assets/images/posts/2020/kodiak/kodiak_focus.png" alt="" class="img-thumbnail mt-5">
<p><a href="/blog/2020/01/13/why-is-first-instant-feedback-crucial-to-developers/">The instant feedback</a> is killed, and so is the flow.</p>
<blockquote class="blockquote text-center mt-5 mb-5">
<p>&quot;<strong>Can you automate</strong> responsibility developers have to think about?
<br>
Just do it!
<br>
They will be able to focus more and produce better quality code.&quot;</p>
</blockquote>
<p><br></p>
<h2 id="Wait-for-240-pull-requests-a-Month-No-Thanks">Wait for 240 pull-requests a Month? No, Thanks!</h2>
<p>In <a href="https://github.com/rectorphp/rector/pulse/monthly">Rector</a> and <a href="https://github.com/symplify/symplify/pulse/monthly">Symplify</a> <a href="/cluster/monorepo-from-zero-to-hero">mono-repositories</a> we had 240 merge-request for just last month.</p>
<p>That's <strong>240 distractions with ~5 minutes upkeep</strong> = 20 hours wasted by brain-waiting and much more work ruined.</p>
<h2 id="Delegate-and-Automate-Merge-Request">Delegate and Automate Merge Request</h2>
<p>What if I told you just a few percent of these manually? The rest is done by GitHub Auto-merge.</p>
<p>How does <em>GitHub Auto-merge</em> work? You mark the pull-request with the &quot;automerge&quot; tag, then - if CI passes - the pull-request is merged. So instead of waiting 240 times for CI feedback, you'll <strong>add the tag when you finish the review</strong>. Then the pull-request is closed, and you can focus on the next work in the peace.</p>
<h2 id="4-Steps-to-Setup-Auto-Merge">4 Steps to Setup Auto-Merge</h2>
<h3 id="1-Go-to-Setting-of-your-GitHub-Repository">1. Go to Setting of your GitHub Repository</h3>
<img src="/assets/images/posts/2020/kodiak/kodiak_branches_1.png" alt="" class="img-thumbnail mt-3">
<h3 id="2-Add-Branch-Checks-for-master">2. Add Branch Checks for <code>master</code></h3>
<img src="/assets/images/posts/2020/kodiak/kodiak_branches_2.png" alt="" class="img-thumbnail mt-3">
<h3 id="3-Select-Jobs-that-are-Required-to-Pass">3. Select Jobs that are Required to Pass</h3>
<img src="/assets/images/posts/2020/kodiak/kodiak_require.png" alt="" class="img-thumbnail mt-3">
<h3 id="4-Enable-GitHub-Auto-merge">4. Enable GitHub Auto-merge</h3>
<p>Go to your project settings, e.g. <a href="https://github.com/symplify/symplify/settings">https://github.com/symplify/symplify/settings</a></p>
<img src="https://user-images.githubusercontent.com/924196/108640310-3270be80-7499-11eb-93e8-ceb380be00e0.png"  class="img-thumbnail mt-3">
<p><br></p>
<p>Now GitHub is enabled and waiting for your work!</p>
<h2 id="1-Step-to-Automerge-Pull-Request-with-GitHub">1 Step to Automerge Pull-Request with GitHub</h2>
<p>Is your PR ready? Go down and enable the automerge:</p>
<img src="https://user-images.githubusercontent.com/924196/108640368-8380b280-7499-11eb-9545-e9c96f6d4cb5.png" class="img-thumbnail">
<p>GitHub waits for the CI to pass and then merges and deletes branch:</p>
<img src="https://user-images.githubusercontent.com/924196/108640447-f0944800-7499-11eb-81ab-05870aa999f9.png" alt="" class="img-thumbnail">
<p>✅</p>
<p><br></p>
<p>Now you've one less to think about for the rest of your life.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/10/12/how-we-stopped-merging-pull-requests</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 12 Oct 2020 00:00:00 +0000</pubDate>
                                    <updated>2021-02-01UTC00:00:000</updated>
                    <atom:updated>Mon, 01 Feb 2021 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Mon, 01 Feb 2021 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/10/12/how-we-stopped-merging-pull-requests#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Reveal Static Call Relationships in Your Code ]]></title>
                <link>https://tomasvotruba.com/blog/2020/10/05/how-to-reveal-static-call-relationships-in-your-code</link>
                <description><![CDATA[ <p>Static methods are easy to use. Have a guess. How long would it take to make 700 static methods in your code? 2-3 years? Now imagine you need a <a href="/blog/2018/04/26/how-i-got-into-static-trap-and-made-fool-of-myself/">replace one with dependency injection</a>.
<br><br>
You're <a href="/blog/2020/08/31/how-static-methods-kills-you-like-corona/">dead</a>. Well, at first, it feels like it. Then you can start to <a href="/blog/2019/04/01/removing-static-there-and-back-again/">analyze the problem</a> and make a refactoring plan. <strong>To increase plan chances for success, we needed data.</strong>
<br><br>
How can we get more data about static in our code?
<br><br>
Meet <em>Static Detector</em>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>&quot;3 developers try to find one static method they can safely change.&quot;</p>
<img src="/assets/images/posts/2020/static_gordian_knot.jpg" class="img-thumbnail">
<p><br></p>
<p>Where is the end of it? Where to start?</p>
<p>Yay, <strong>we found one static method that seems independent on others</strong>. Let's send pull-requests for review.</p>
<p><br></p>
<p>Later that day, on code review...</p>
<ul>
<li>&quot;Well, it depends on one more method. Let's refactor it too...&quot;</li>
<li>&quot;Oh, now we need to change 2 methods in the template too... Hm, how do we get a service into that template?&quot;</li>
<li>&quot;Hm, this template is created in a static method as well. Let's register it as a service...&quot;</li>
<li>&quot;Ups, 3 more classes use this static service...&quot;</li>
</ul>
<p><br></p>
<p>Turmoil.</p>
<p><br></p>
<h2 id="Stop-and-amp-Relax">Stop &amp; Relax</h2>
<p>In a situation like this, let's take time to step back, breathe, and relax. There is a way to get out this, but brute force is not one of them.</p>
<blockquote class="blockquote text-center">
    "A journey of a thousand miles begins with a single step."
</blockquote>
<p><br></p>
<h2 id="Recipe-for-Static-Success">Recipe for Static Success</h2>
<p>If we refactor 100+ static methods manually, we'll probably end up in the stress and frustration like in the story above.</p>
<p>The goal is to take one method at a time. But not just any static method. The easiest possible. How do we find it?</p>
<h2 id="Take-Low-Hanging-Fruit">Take Low Hanging Fruit</h2>
<p>The easiest static method is the <strong>one with the least coupling</strong>, or with a coupling that is easiest to remove, e.g.</p>
<ul>
<li>static method that is never used → remove it</li>
<li>static method that is used only locally → remove <code>static</code></li>
<li>static method that is used only in local static method → make it <code>private</code></li>
<li>static method that is used only in template → refactor is to <a href="/blog/2020/08/17/how-to-get-rid-of-magic-static-and-chaos-from-latte-filters/">filter service</a></li>
</ul>
<p>But you already know that, right? Anyone can remove method that is never used.
What is the hard problem? How can we be sure the method is not really used?</p>
<h2 id="Static-Detector-to-the-Rescue">Static Detector to the Rescue</h2>
<p>To get these data, we use a handy tool <a href="https://github.com/symplify/easy-ci">symplify/easy-ci</a>.</p>
<p><br></p>
<p>Install it:</p>
<pre><code class="language-bash">composer require symplify/easy-ci --dev</code></pre>
<p>Run it on your directory:</p>
<pre><code class="language-bash">vendor/bin/easy-ci detect-static src</code></pre>
<p>We'll see the overview of all static methods, with all related static calls.</p>
<p>From the most spread one in the top, into <strong>the least coupled in the bottom</strong>.</p>
<p><br></p>
<p>For following file:</p>
<pre><code class="language-php">&lt;?php

// src/SomeStatic.php
final class SomeStatic
{
    public static function neverCalled()
    {
    }

    public function run()
    {
        self::calledJustOnce();
    }

    public static function calledJustOnce()
    {
    }
}</code></pre>
<p>We get this result:</p>
<img src="/assets/images/posts/2020/static_detector_result.png" class="img-thumbnail">
<p><br></p>
<p>Now even 700+ static methods do seem like such a big problem, right?</p>
<img src="/assets/images/posts/2020/static_gordian_knot_2.jpg" class="img-thumbnail">
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/10/05/how-to-reveal-static-call-relationships-in-your-code</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 05 Oct 2020 00:00:00 +0000</pubDate>
                                    <updated>2021-08-01UTC00:00:000</updated>
                    <atom:updated>Sun, 01 Aug 2021 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sun, 01 Aug 2021 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/10/05/how-to-reveal-static-call-relationships-in-your-code#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Add Colors to Continuous Integration Output ]]></title>
                <link>https://tomasvotruba.com/blog/2020/09/28/how-to-add-colors-to-continuious-integration-output</link>
                <description><![CDATA[ <p>Today I have a tip for your CI. I learned this tip from <a href="https://github.com/JanMikes">Jan Mikes</a>.
<br>
<br>
A small tip that made my everyday work with CI more colorful.</p> ]]></description>
                <content:encoded><![CDATA[ <ul>
<li>Do you use Travis, Github Actions, or Gitlab CI?</li>
<li>Do you use composer, PHPUnit, ECS, Rector, or PHPStan?</li>
<li>Do you have colors enabled in <code>phpunit.xml</code>?</li>
</ul>
<pre><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;phpunit colors="true"&gt;
    &lt;!-- ... --&gt;
&lt;/phpunit&gt;</code></pre>
<ul>
<li>Do you use <a href="https://blog.martinhujer.cz/have-you-tried-composer-scripts/">composer scripts</a> to prevent typos and re-use CI tool setup?</li>
</ul>
<p><br></p>
<p>...but still missing the <strong>colored output</strong>?</p>
<p><br></p>
<h2 id="Sad-Black-White-Continuous-Integration-World">Sad Black/White Continuous Integration World</h2>
<p>For many years I've run Travis, Gitlab, and <a href="/blog/2020/01/27/switch-travis-to-github-actions-to-reduce-stress/">now Github Actions</a>. I never knew the output could be readable for humans, so I always looked at the final checkmark for all the scripts.</p>
<p>It was ✅ or ❌.</p>
<p><br></p>
<p>When the CI runs the scripts:</p>
<pre><code class="language-yaml">scripts:
    - composer install
    - composer fix-cs</code></pre>
<p><br></p>
<p>This was usually the output:</p>
<img src="/assets/images/posts/2020/ansi_no_colors.png">
<img src="/assets/images/posts/2020/ansi_no_colors_2.png">
<p><br></p>
<h2 id="One-day-Something-Changed">One day, Something Changed</h2>
<p>The colors came to my life. I could read again, and the output was the same as in local environment!</p>
<img src="/assets/images/posts/2020/ansi_colors.png" class="shadow img-thumbnail">
<img src="/assets/images/posts/2020/ansi_colors_2.png" class="shadow img-thumbnail">
<p>What happened? Did they fix something on Github Actions? Or composer (and all the other tools were) was fixed?</p>
<p><br></p>
<p>No, <strong>just one new word</strong> appeared:</p>
<pre><code class="language-diff"> scripts:
-    - composer install
+    - composer install --ansi</code></pre>
<pre><code class="language-diff"> {
     "scripts": {
-        "fix-cs": "vendor/bin/ecs check --fix"
+        "fix-cs": "vendor/bin/ecs check --fix --ansi"
     }
 }</code></pre>
<p>Since then, I enjoy failed CI jobs more and find faster what went wrong.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/09/28/how-to-add-colors-to-continuious-integration-output</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 28 Sep 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/09/28/how-to-add-colors-to-continuious-integration-output#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Symfony AutoBind Parameter is Dead, Long live Constant Parameters ]]></title>
                <link>https://tomasvotruba.com/blog/2020/09/21/symfony-autobind-parameter-is-dead-long-live-constant-parameters</link>
                <description><![CDATA[ <p>I wrote the <a href="/blog/2018/11/05/do-you-autowire-services-in-symfony-you-can-autowire-parameters-too/">Do you Autowire Services in Symfony? You can Autowire Parameters Too</a> almost 2 years ago. It seemed like a good idea at that time, to save manual YAML config wiring.
<br><br>
Now, with <a href="/blog/2020/07/16/10-cool-features-you-get-after-switching-from-yaml-to-php-configs/">PHP configs</a> on the Symfony markets, auto bind parameters became obsolete.
<br><br>
Welcome <strong>constant parameters</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>In the past, we used YAML to define parameters for Symfony application:</p>
<pre><code class="language-yaml">parameters:
    location: Prague</code></pre>
<p>How do we get parameter in a service? Via name auto binding: <strong>the parameter name = the param name in <code>__construct</code></strong>:</p>
<pre><code class="language-php">final class SomeService
{
    private string $location;

    public function __construct(string $location)
    {
        $this-&gt;location = $location;

        dump($location); // "Prague"
    }
}</code></pre>
<p>This allows us to have a typed parameter right in the constructor. We know it's a <code>string</code>.</p>
<h2 id="YAML-Without-Knowledge">YAML Without Knowledge</h2>
<ul>
<li>But where is the <code>location</code> param defined?</li>
<li>Where are all the places the parameter is used in?</li>
<li>Is the <code>string $location</code> in the <code>__construct</code> really a constructor parameter? What if that's a value object?</li>
</ul>
<pre><code class="language-php">$valuesObjects = [
    new SomeService('Prague'),
    new SomeService('Berlin'),
    new SomeService('London'),
];</code></pre>
<p>We don't know. We can be either anxious about it or not care about this detail at all.</p>
<p><br></p>
<p>Or we could <strong>quickly know with 1 click in PHPStorm</strong>. How?</p>
<h2 id="Welcome-Constant-Parameters">Welcome Constant Parameters</h2>
<p>With <a href="/blog/2020/07/16/10-cool-features-you-get-after-switching-from-yaml-to-php-configs">Symfony configs in <code>*.php</code> format</a>, this is easypick:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $parameters = $containerConfigurator-&gt;parameters();
    $parameters-&gt;set('location', 'Prague');
};</code></pre>
<p>Wait, this was just a string. We want <strong>constant parameters</strong>:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use App\Configuration\Option;

return function (ContainerConfigurator $containerConfigurator): void {
    $parameters = $containerConfigurator-&gt;parameters();
    $parameters-&gt;set(Option::LOCATION, 'Prague');
};</code></pre>
<h2 id="When-Constant-Parameter-and-Service-Parameter-Meet">When Constant Parameter and Service Parameter Meet</h2>
<p>We still want to avoid service configuration... we have 2 options.</p>
<ul>
<li>A. Use Symfony <a href="https://symfony.com/blog/new-in-symfony-4-1-getting-container-parameters-as-a-service">parameter bag</a>:</li>
</ul>
<pre><code class="language-php">use App\Configuration\Option;
use Symfony\Component\DependencyInjection\ParameterBag\ParameterBagInterface;

final class SomeService
{
    private string $location;

    public function __construct(ParameterBagInterface $parameterBag)
    {
        // re-type to (string) is needed, because "get()" return mixed type
        $this-&gt;location = (string) $parameterBag-&gt;get(Option::LOCATION);
    }
}</code></pre>
<ul>
<li>B. Use Symplify <a href="https://github.com/symplify/package-builder#get-all-parameters-via-service">ParameterProvider</a>:</li>
</ul>
<pre><code class="language-php">use App\Configuration\Option;
use Symplify\PackageBuilder\Parameter\ParameterProvider;

final class SomeService
{
    private string $location;

    public function __construct(ParameterProvider $parameterProvider)
    {
        // no re-type needed + parameter type validation included inside the ParameterProvider service
        $this-&gt;location = $parameterProvider-&gt;provideStringParameter(Option::LOCATION);
    }
}</code></pre>
<p>Both services work to find first is out of the box, second is mutable and useful for testing or post-container configurations. Pick the one that suits your project better.</p>
<p><strong>Are you unsure?</strong> Use the Symfony <code>ParameterBagInterface</code>.</p>
<h2 id="One-More-Thing">One More Thing...</h2>
<p>We now have a clean design and constant parameters without any name &lt;=&gt; name hacking. That's nice.</p>
<p>But the best is yet to come. In the previous version, we were missing essential information about the parameter:</p>
<blockquote class="blockquote text-center mt-5 mb-5">
    Where are the places the parameter is used in?
</blockquote>
<p><br></p>
<p>Well, why not just <strong>click on the constant</strong> in your IDE?</p>
<p><br></p>
<img src="/assets/images/posts/2020/constant_parameter_locations.gif" class="img-thumbnail">
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/09/21/symfony-autobind-parameter-is-dead-long-live-constant-parameters</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 21 Sep 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/09/21/symfony-autobind-parameter-is-dead-long-live-constant-parameters#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Apply Coding Standard on PHP Snippets in Markdown Files? ]]></title>
                <link>https://tomasvotruba.com/blog/2020/09/14/how-to-apply-coding-standard-on-php-snippets-in-markdown-files</link>
                <description><![CDATA[ <p>Have you been asking this question since the inventions of coding standards? Do you write <code>README.md</code>?
If you maintain an open-source project, you do.
<br><br>
Coding standards are a matter of adding a few lines into <code>composer.json</code> and your favorite CI.
<strong>But what about <code>README.md</code> files?
<br>
<br>
Who will take care of them?</strong> Should we accept clean code in <code>/src</code>, but crap code in PHP snippets in Markdown? What if someone reading <code>README.md</code> will adopt its bad coding habits?
<br><br>
I say: &quot;We shall not!&quot;</p> ]]></description>
                <content:encoded><![CDATA[ <p><strong>This feature <a href="https://github.com/symplify/symplify/pull/2118">was contributed</a> to ECS 8.3 by <a href="https://github.com/samsonasik">samsonasik</a>. Thank you!</strong></p>
<p><br></p>
<p>We try to make new features <strong>as intuitive to use as possible</strong>, so you have to learn as less a possible to use them. Have more fun.</p>
<p>You already know ECS command <code>check</code>:</p>
<pre><code class="language-bash">vendor/bin/ecs check src

# to change the code
vendor/bin/ecs check src --fix</code></pre>
<h2 id="check-but-for-Markdown-Files"><code>check</code> but for Markdown Files</h2>
<p>How to apply the same coding standard to markdown files?</p>
<p>Just use <code>check-markdown</code> command instead of <code>check</code>:</p>
<pre><code class="language-bash">vendor/bin/ecs check-markdown README.md</code></pre>
<p>You can use multiple files or directories:</p>
<pre><code class="language-bash"># do you have multiple files?
vendor/bin/ecs check-markdown README.md packages

# or target names only?
vendor/bin/ecs check-markdown README.md packages/**/README.md</code></pre>
<p>How to <strong>fix the content</strong>? Just add <code>--fix</code>:</p>
<pre><code class="language-bash">vendor/bin/ecs check-markdown README.md --fix</code></pre>
<p>All the rules that you defined in <code>ecs.php</code> will be applied the same way they're applied to PHP code.</p>
<p><br></p>
<h2 id="How-does-it-Look-in-Practise">How does it Look in Practise?</h2>
<img src="/assets/images/posts/2020/check_markdown.gif" class="img-thumbnail">
<h2 id="Composer-Scripts-Tip">Composer Scripts Tip</h2>
<p>How to add all this to your workflow? Another command to run every time? Nah, that's too <a href="/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock/">memory locking</a> and tedious.</p>
<p>Instead, we can extend <a href="https://blog.martinhujer.cz/have-you-tried-composer-scripts/">composer scripts</a> in <code>composer.json</code>:</p>
<pre><code class="language-diff"> {
     "scripts": {
-        "check-cs": "vendor/bin/ecs check",
+        "check-cs": [
+           "vendor/bin/ecs check",
+           "vendor/bin/ecs check-markdown README.md",
+        ],
-        "fix-cs": "vendor/bin/ecs check --fix"
+        "fix-cs": [
+            "vendor/bin/ecs check --fix",
+            "vendor/bin/ecs check-markdown README.md --fix",
+        ]
     }
 }</code></pre>
<p>How does it change your workflow? Not at all! You can still use the same commands:</p>
<pre><code class="language-bash">composer checks-cs
composer fix-cs</code></pre>
<p>Just now they're much smarter ;)</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/09/14/how-to-apply-coding-standard-on-php-snippets-in-markdown-files</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 14 Sep 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/09/14/how-to-apply-coding-standard-on-php-snippets-in-markdown-files#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Introducing Object Calisthenics Rules for PHPStan ]]></title>
                <link>https://tomasvotruba.com/blog/2020/09/07/introducing-object-calisthenics-rules-for-phpstan</link>
                <description><![CDATA[ <p>For the last 2 years, I've maintained <a href="https://github.com/object-calisthenics/phpcs-calisthenics-rules">Object Calisthenics Rules for PHP_CodeSniffer</a>. In 2019 and 2020, there was a huge boom of custom PHPStan rulesets that make everyday development <a href="/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock/">easier and stronger</a> at the same time.
<br><br>
<strong>Have you been waiting to put these rules into your <code>phpstan.neon</code>?</strong>
<br>
<br>
Today you can!</p> ]]></description>
                <content:encoded><![CDATA[ <p>Object Calisthenics is about SOLID rules and code architecture more than spaces and bracket positions, maybe <a href="/blog/2018/10/25/why-ast-fixes-your-coding-standard-better-than-tokens/">PHPStan and AST</a> are better to handle it?</p>
<p><br></p>
<h2 id="What-is-Object-Calis">What is Object Calis...?</h2>
<p>Oh wait, it's the first time you hear <em>Object Calisthenics</em>?</p>
<img src="/assets/images/posts/object_calisthenics_phpstan.jpg" class="img-thumbnail">
<p>Don't worry. It's not a physical sport that is required to become a better developer. You read about all 9 rules or listen to 12-min audio in <a href="https://williamdurand.fr/2013/06/03/object-calisthenics">Object Calisthenics</a> post by William Durand or check <a href="https://www.slideshare.net/guilhermeblanco/object-calisthenics-applied-to-php">colorful slides</a> by Guilherme Blanco, the former maintainer PHP_CodeSniffer set package.</p>
<p>Some of the rules are rather theoretical to entertain the mind, but some can be measured. And <strong>what can be measured, can be automated</strong>. What rules can you check in your CI?</p>
<ul>
<li>Rule 1: Only X Level of Indentation per Method</li>
<li>Rule 2: No <code>else</code> And <code>elseif</code></li>
<li><strong>Rule 5: No Chain Method Call</strong></li>
<li><strong>Rule 6: No Names Shorter than 3 Chars</strong></li>
<li>Rule 7: Keep Your Classes Small</li>
<li>Rule 9: No Setter Methods</li>
</ul>
<h2 id="Introducing-PHPStan-Rules">Introducing PHPStan Rules</h2>
<p>You can add all of the rules above as <a href="https://github.com/symplify/phpstan-rules/blob/master/packages/object-calisthenics/config/object-calisthenics-rules.neon">a PHPStan ruleset</a>. I've ported these rules to <code>symplify/coding-standard</code> in the last 2 days.</p>
<pre><code class="language-bash">composer require symplify/coding-standard --dev</code></pre>
<p>And update <code>phpstan.neon</code>:</p>
<pre><code class="language-yaml"># phsptan.neon
includes:
    - vendor/symplify/coding-standard/packages/object-calisthenics/config/object-calisthenics-rules.neon</code></pre>
<p>As you can see, their rules are pretty strict, and in practice, that might be impossible to put on a real project. It's better to start slowly with low hanging fruit rules. Like these 2:</p>
<h3 id="Rule-5-No-Chain-Method-Call">Rule 5: No Chain Method Call</h3>
<pre><code class="language-yaml"># phpstan.neon
rules:
    - Symplify\CodingStandard\ObjectCalisthenics\Rules\NoChainMethodCallRule</code></pre>
<h3 id="Rule-6-No-Names-Shorter-than-3-Chars">Rule 6: No Names Shorter than 3 Chars</h3>
<pre><code class="language-yaml"># phpstan.neon
services:
    -
        class: Symplify\CodingStandard\ObjectCalisthenics\Rules\NoShortNameRule
        tags: [phpstan.rules.rule]
        arguments:
            minNameLength: 3
            allowedShortNames: ['id', 'to', 'up']</code></pre>
<p>And you're ready to go!</p>
<h2 id="How-to-Switch-from-PHP-CodeSniffer-to-PHPStan-rules">How to Switch from PHP_CodeSniffer to PHPStan rules?</h2>
<p>Most likely, you're not using all the rules at once, so we look at migrating particular rules.</p>
<ul>
<li>Look at the <a href="https://github.com/symplify/phpstan-rules/blob/master/docs/rules_overview.md">list of PHPStan rules</a></li>
<li>Look at the full set - <a href="https://github.com/symplify/phpstan-rules/blob/master/packages/object-calisthenics/config/object-calisthenics-rules.neon"><code>object-calisthenics-rules.neon</code></a></li>
<li>Pick the rules you need and copy-paste them to your <code>phpstan.neon</code></li>
<li>You can use parameters to configure them, or explicit values (like in 2 cases above)</li>
<li>Add only <strong>1 rule at a time</strong> and then try to run PHPStan (<code>vendor/bin/phpstan analyse</code>) to make sure, it works</li>
</ul>
<p>Good luck and have fun.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/09/07/introducing-object-calisthenics-rules-for-phpstan</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 07 Sep 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/09/07/introducing-object-calisthenics-rules-for-phpstan#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How Static Methods Kill You Like Corona ]]></title>
                <link>https://tomasvotruba.com/blog/2020/08/31/how-static-methods-kills-you-like-corona</link>
                <description><![CDATA[ <p>Do you know <a href="https://blog.codinghorror.com/the-broken-window-theory/">the Broken Window theory</a>? It's a social pattern in code, a great post written by a guy behind one small manual website - StackOverflow.
<br><br>
If you combine this theory and Static Methods in Your code, you'll get Corona. As we already know, it might or might not be deadly. How it spreads, what are ways to protect, can we cure it?</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Single-Child-in-Classroom-Problem">Single Child in Classroom Problem</h2>
<p>It's September here, and many of friends walked their children to the school. Some for the first time in their life. Everyone is very cautious because it takes precisely <strong>1 corona-infected</strong> child, parent, or teacher to spread to another person very effectively.</p>
<img src="/assets/images/posts/static_corona_child.jpg" class="img-thumbnail">
<p>Some of my friends are teachers, and their prognosis is that most schools get closed down till the end of September. Why? Because if you have 1 infected child in a classroom of 30 children, all their teachers and schoolmates can be infected too. The problem is, tests take too long. <strong>It's not instant feedback</strong>. So we have to wait, hope, make up rationalizations in the meantime.</p>
<p>Playing statistics with fear now, but I think you've already got used to it from the news for the last 9 months.</p>
<h2 id="Elderly-and-Weak-People-are-the-Corona-Goal">Elderly and Weak People are the Corona Goal</h2>
<p>&quot;Ok, so few schools get closed down, what's a big of a deal?&quot; you might think. And you might be right. There is not much health risk in not going to a place. Have you heard of a person that died from not going to the cinema?</p>
<p>The problem is when the corona spreads to fragile people - the elderly and those with other illnesses. What happens when a lot of young and strong people get infected? Let's say they have a temperature, but no-one dies. As everything is connected in today's world, this <strong>speeds up corona spread</strong> between <em>strong population</em> and <em>weak population</em> and puts enormous danger on the latter.</p>
<p>So much for corona.</p>
<h2 id="Corona-Infected-Child-in-a-Classroom-is-like-a-Static-Method">Corona Infected Child in a Classroom is like a Static Method</h2>
<p>If we only were as conscious and reacted fast with static methods as we react with a single corona infected person. <strong>But don't care, because it's <a href="/blog/2020/01/13/why-is-first-instant-feedback-crucial-to-developers/">not instant feedback</a></strong>.</p>
<ul>
<li>
<p>Imagine <em>static methods</em> is like a strong population infected by corona. They can go anywhere; they don't care; they will live.</p>
</li>
<li>
<p>Imagine <em>service methods</em> (non-static) are like a weak population; they were not infected yet. They're ok, for now.</p>
</li>
</ul>
<h2 id="and-quot-Show-me-Some-Code-and-quot">&quot;Show me Some Code!&quot;</h2>
<p>Do you want real meat? Let's look at code that can put down the company for many months:</p>
<h3 id="Strong-Population">Strong Population</h3>
<pre><code class="language-php">final class InfectedYoungChild
{
    public static function spreadInfection()
    {
        // ...
    }
}</code></pre>
<pre><code class="language-php">final class InfectedYoungParent
{
    public static function spreadInfection()
    {
        // ...
    }
}</code></pre>
<pre><code class="language-php">final class ClassRoom
{
    public static function spreadInfection()
    {
        InfectedYoungChild::spreadInfection();
        // ...
        InfectedYoungParent::spreadInfection();
        // ...
    }
}</code></pre>
<p>Imagine 100 more static methods in your code, so we save some paper.
To give your real-life example, one of the projects we migrate now has over 350 static methods in 110 000 lines of code.</p>
<h3 id="Weak-Population">Weak Population</h3>
<p>Let's say grandma feels lonely and <strong>wants to see their grandchildren</strong>, that gives her joy and purpose to live.</p>
<img src="/assets/images/posts/static_corona_grand_parents.jpg" class="img-thumbnail">
<p>At least once in a <em>while</em> (pun intended!):</p>
<pre><code class="language-php">final class HealthyGrandma
{
    public function seeGrandChildren(array $youngChildren)
    {
        foreach ($youngChildren as $youngChild) {
            if ($youngChild instanceof HuggableInterface) {
                $youngChild-&gt;hug($this);
            }
        }
    }
}</code></pre>
<p>But she's afraid, so she wants to be sure her grandchild won't kill her.</p>
<pre><code class="language-php">final class HealthyGrandma
{
    public function seeGrandChildren(array $youngChildren)
    {
        foreach ($youngChildren as $youngChild) {
            if ($youngChild instanceof InfectableInterface) {
                if ($youngChild-&gt;isInfected()) {
                    // the child is infected, can't happen, sorry :(
                    continue;
                }
            }

            if ($youngChild instanceof HuggableInterface) {
                $youngChild-&gt;hug($this);
            }
        }
    }
}</code></pre>
<h2 id="The-Italy-Mayhem-Problem">The Italy Mayhem Problem</h2>
<p>How can we detect <code>InfectableInterface</code> in a static class? How can we collect data about infections in static classes?</p>
<p>We can't. And that's what happened in Italy this spring. Little control over the strong and weak part of your code population.</p>
<p>What can we do about it? I know you won't like it, <a href="/blog/2019/04/01/removing-static-there-and-back-again/">it's a lot of work</a> that has no impact right now - refactor static to non-static:</p>
<pre><code class="language-diff">-final class InfectedYoungChild
+final class InfectedYoungChild implements InfectableInterface
 {
-    public static function spreadInfection()
+    public function spreadInfection()
     {
         // ...
     }
 }</code></pre>
<p>And also...</p>
<pre><code class="language-diff">-final class InfectedYoungParent
+final class InfectedYoungParent implements InfectableInterface
{
-    public static function spreadInfection()
+    public function spreadInfection()
     {
         // ...
     }
 }</code></pre>
<p><strong>And mostly, all their dependencies... and their dependencies...</strong></p>
<pre><code class="language-diff">-final class ClassRoom
+final class ClassRoom implements InfectableInterface
 {
+    private InfectedYoungChild $infectedYoungChild;
+
+    InfectedYoungParent $infectedYoungParent
+
+    public fuction __construct(
+        InfectedYoungChild $infectedYoungChild,
+        InfectedYoungParent $infectedYoungParent
+    ) {
+         $this-&gt;infectedYoungChild = $infectedYoungChild;
+         $this-&gt;infectedYoungParent = $infectedYoungParent;
+    }

-    public static function spreadInfection()
+    public function spreadInfection()
     {
-        InfectedYoungChild::spreadInfection();
+        $this-&gt;infectedYoungChild-&gt;spreadInfection();
         // ...
-        InfectedYoungParent::spreadInfection();
+        $this-&gt;infectedYoungParent-&gt;spreadInfection();
         // ...
     }
 }</code></pre>
<p>This is the only way to save <a href="/blog/2018/04/26/how-i-got-into-static-trap-and-made-fool-of-myself/">from fractal static spread</a>.</p>
<p><br>
<br></p>
<p><strong>It might take time, work, effort, sweat &amp; tears, but it's worth it for the future.</strong></p>
<p><br></p>
<img src="/assets/images/posts/static_corona_safe.jpg" class="img-thumbnail">
<p><br></p>
<blockquote class="blockquote text-center">
<p>Great programmers do not live for today's delivered features,<br>
they live for <a href="/blog/2018/04/30/programming-climbing-a-huge-mountain/">the top of the mountain</a> in years of work.</p>
</blockquote>
<p><br></p>
<h2 id="What-if-We-Find-the-Corona-Cure">What if We Find the Corona Cure?</h2>
<pre><code class="language-php">$coronaCure = new CoronaCure();

$infectables = $container-&gt;getByType(InfectableInteface::class);

foreach ($infectables as $infectable) {
    if (! $infectable-&gt;isInfected()) {
        continue;
    }

    $coronaCure-&gt;cure($infectable);
}</code></pre>
<p>Be sure to have all your services in your container, so they're available <strong>when you need them</strong>.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/08/31/how-static-methods-kills-you-like-corona</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 31 Aug 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/08/31/how-static-methods-kills-you-like-corona#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ What if We Remove Strings from Symfony Extension Configuration ]]></title>
                <link>https://tomasvotruba.com/blog/2020/08/24/what-if-we-remove-strings-from-symfony-extension-configuratoin</link>
                <description><![CDATA[ <p>You can tell I'm a <a href="/blog/2020/07/16/10-cool-features-you-get-after-switching-from-yaml-to-php-configs/">huge fan PHP configs</a>. To be honest, I don't care; I'm just extremely lazy.
<br><br>
Yet, my laziness got me itching when I see <strong>configuration of extensions</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>I like the service configuration provided by Symfony. Typo-proof, everything is autocompleted by IDE, hard to put the wrong argument or make a typo.</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();

    $services-&gt;defaults()
        -&gt;autowire()
        -&gt;autoconfigure()
        -&gt;public();

    $services-&gt;set(SomeService::class)
        -&gt;args(['some', 'value']);
};</code></pre>
<p>This config is a joy to use in IDE. Only the values that can change, like class name or arg value, are strings. <strong>Everything else is API of the modeling tool</strong>, here <code>ContainerConfigurator</code> from Symfony. This code is a state of Art.</p>
<p><br></p>
<p>But that's not everything we have in our configs. Let's look at a common extension you can found in <code>config/packages/doctrine.php</code> in your Symfony project:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $containerConfigurator-&gt;extension('break', [
        'dbal' =&gt; [
            'host' =&gt; '%env(DATABASE_HOST)%',
            'user' =&gt; '%env(DATABASE_USER)%',
            'password' =&gt; '%env(DATABASE_PASS)%',
        ],
    ]);
};</code></pre>
<p>How do you like this?</p>
<p>I'll share you secret deep from my traumatized mind - this is what I see:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $containerConfigurator-&gt;extension('error', [
        'bug' =&gt; [
            'typo' =&gt; ' _missing',
            ' problem ' =&gt; 'sorry_renamed',
            'forgotten' =&gt; 'FALSE POSITIVE',
        ],
    ]);
};</code></pre>
<blockquote class="blockquote text-center">
    "Anything that can go wrong, will go wrong.<br>
    In the worst possible order. When you least expect it."
</blockquote>
<p><br></p>
<h2 id="How-can-we-make-Extension-as-Good-as-Service-Registration">How can we make Extension as Good as Service Registration?</h2>
<p>If we look at <a href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/DependencyInjection/Loader/Configurator/ContainerConfigurator.php"><code>ContainerConfigurator</code></a>, it inherits from abstract class <a href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/DependencyInjection/Loader/Configurator/AbstractConfigurator.php"><code>AbstractConfigurator</code></a>.</p>
<p>What if we use per-extension Configurator... e.g. <code>DoctrineConfigurator</code>?</p>
<pre><code class="language-php">return static function (DoctrineConfigurator $doctrineConfigurator): void {
    $doctrineConfigurator-&gt;dbal()
        -&gt;user('%env(DATABASE_USER)%')
        -&gt;password('%env(DATABASE_PASS)%');
};</code></pre>
<p>Slightly less space fo bug... Still, I managed to split one there. It can cause a &quot;connection to database rejected&quot; error.</p>
<h2 id="Environment-Variables-for-Everyone">Environment Variables for Everyone</h2>
<p>Have you spotted it?</p>
<pre><code class="language-diff"> return static function (DoctrineConfigurator $doctrineConfigurator): void {
     $doctrineConfigurator-&gt;dbal()
         -&gt;user('%env(DATABASE_USER)%')
-        -&gt;password('%env(DATABASE_PASS)%');
+        -&gt;password('%env(DATABASE_PASSWORD)%');
};</code></pre>
<ul>
<li>How could we prevent this?</li>
<li>How can one know the conventions of database env values without studying them?</li>
<li>What are other ENV values for the database we can use?</li>
</ul>
<p><a href="https://github.com/JanMikes">Jan Mikes</a> shared with me an interesting idea that <strong>removes this problem</strong>:</p>
<pre><code class="language-php">use DoctrineEnvs;

return static function (DoctrineConfigurator $doctrineConfigurator): void {
    $doctrineConfigurator-&gt;dbal()
        -&gt;user('%env(' . DoctrineEnvs::DATABASE_PASSWORD . ')%')
        -&gt;password('%env(' . DoctrineEnvs::DATABASE_PASSWORD . ')%');
};</code></pre>
<p><br></p>
<p>That seems like too much clutter... can we make it simpler and safes?</p>
<pre><code class="language-php">use DoctrineEnvParams;

return static function (DoctrineConfigurator $doctrineConfigurator): void {
    $doctrineConfigurator-&gt;dbal()
        -&gt;user(DoctrineEnvParams::DATABASE_PASSWORD)
        -&gt;password(DoctrineEnvParams::DATABASE_PASSWORD);
};</code></pre>
<p><br></p>
<p>In what cases is this the most useful?</p>
<p><br></p>
<p>Common key for the &quot;database name&quot; is never the same across database platforms and language integration. Imagine the saved hours and lifes on Docker/Doctrine/CI typos:</p>
<pre><code class="language-php">return static function (DoctrineConfigurator $doctrineConfigurator): void {
    $doctrineConfigurator-&gt;dbal()
        -&gt;database('%env(DATABASE_NAME)%');
        // or...?
        -&gt;database('%env(DATABASE_DBNAME)%');
        // or...?
        -&gt;database('%env(DATABASE_DATABASE)%');
        // or...?
        -&gt;database('%env(DB_NAME)%');
};</code></pre>
<p>Just don't care and use IDE autocomplete:</p>
<pre><code class="language-php">use DoctrineEnvParams;

return static function (DoctrineConfigurator $doctrineConfigurator): void {
    $doctrineConfigurator-&gt;dbal()
        -&gt;database(DoctrineEnvParams::DATABASE_NAME);
};</code></pre>
<h2 id="What-are-Benefits-over-Array-configuration">What are Benefits over Array configuration?</h2>
<ul>
<li><strong>the parameter is validated by standard PHP</strong> - if you put database name with <code>int</code>, the PHP throws an exception right on that line</li>
</ul>
<h3 id="Focus-on-Config-without-Jumping-Elsewhere">Focus on Config without Jumping Elsewhere</h3>
<ul>
<li>the IDE autocompletes method names - <strong>no need to look into configuration</strong>, what can be used - you can stay focused on your code</li>
<li>the IDE autocompletes ENV names - <strong>no need to look into configs or extension on Github</strong> - you can stay focused on your code</li>
</ul>
<h3 id="Narrow-Context">Narrow Context</h3>
<ul>
<li>context-aware autocomplete - when you type <code>dbal()</code> or <code>orm()</code> you only get methods, that are relevant in that context</li>
</ul>
<pre><code class="language-php">return static function (DoctrineConfigurator $doctrineConfigurator): void {
    $doctrineConfigurator-&gt;dbal()
        -&gt;... // dbal specific methods

    $doctrineConfigurator-&gt;orm()
        -&gt;... // orm specific methods
};</code></pre>
<ul>
<li>we can also go to a more narrow scope, like single <code>connection()</code></li>
</ul>
<pre><code class="language-php">return static function (DoctrineConfigurator $doctrineConfigurator): void {
    $doctrineConfigurator-&gt;dbal()
        -&gt;conntection()
            -&gt;... // only connection specific methods
};</code></pre>
<p>The <code>DoctrineConfigurator</code> with specific <code>methods()</code> and <code>Constant::KEYS</code> is one way to get rid of all string possible.</p>
<h2 id="What-about-Value-Objects">What about Value Objects?</h2>
<p>With PHP 8.0 to be released in 11/2020 will come <a href="https://stitcher.io/blog/php-8-named-arguments">named arguments</a>. With them, the IDE autocomplete becomes more powerful. If we combine it along with <code>__construct</code> validation in value objects, we have another solid way to add parameters:</p>
<pre><code class="language-php">return static function (DoctrineConfigurator $doctrineConfigurator): void {
    $doctrineConfigurator-&gt;dbal()
        -&gt;connection(new DbalConnection(
            DoctrineEnvParams::DATABASE_USER,
            DoctrineEnvParams::DATABASE_PASSWORD,
            DoctrineEnvParams::DATABASE_NAME
        ));
};</code></pre>
<p>Compared to method() autocomplete, we can also see <strong>what arguments are required</strong> and which optional:</p>
<pre><code class="language-php">// using PHP 8.0 syntax with constructor promotion

final class DbalConnection
{
    public function __construct(
        private string $user,
        private string $password,
        private string $database,
        private ?string $version = null
    ) {
        // ...
    }
}</code></pre>
<h2 id="Instant-Feedback-Loop">Instant Feedback Loop</h2>
<p>If we get rid of strings that can go wrong, we've made a big shift <a href="/blog/2020/03/02/we-do-not-need-senior-developers-we-need-senior-code-bases/">to senior codebase</a>.</p>
<p>Another huge benefit for programmers <strong>is focus - along with <a href="/blog/2020/01/13/why-is-first-instant-feedback-crucial-to-developers/">instant feedback loop</a></strong>.</p>
<blockquote class="blockquote text-center">
    "If something goes wrong, I want to know it the moment it went wrong"
</blockquote>
<ul>
<li>
<p>If we put the wrong password to the database, the project works on the localhost server, the tests are passing, and CI is green, our feedback loop is slow, and we have to speed it up.</p>
</li>
<li>
<p>If the project crashes on the localhost server and tests are failing, our feedback look is fast.</p>
</li>
</ul>
<p><br></p>
<p><strong>How is instant feedback loop related to value objects and require arguments?</strong> Good question!</p>
<p>If we put user and password but forget the database name, the application will crash <strong>when</strong> it's connected:</p>
<pre><code class="language-php">use DoctrineEnvParams;

return static function (DoctrineConfigurator $doctrineConfigurator): void {
    $doctrineConfigurator-&gt;dbal()
        -&gt;user(DoctrineEnvParams::DATABASE_USER)
        -&gt;password(DoctrineEnvParams::DATABASE_PASSWORD);
};</code></pre>
<p>That's very late!</p>
<p>With value objects, we'll get the &quot;missing 3rd argument&quot; error:</p>
<pre><code class="language-php">return static function (DoctrineConfigurator $doctrineConfigurator): void {
    $doctrineConfigurator-&gt;dbal()
        -&gt;connection(new DbalConnection(
            DoctrineEnvParams::DATABASE_USER,
            DoctrineEnvParams::DATABASE_PASSWORD
            // boom :(
        ));
};</code></pre>
<p><strong>That's fast feedback loop!</strong></p>
<p><br></p>
<p>These were few ideas, how to <strong>get rid of strings</strong> in <code>/config</code> directory, so we can instead focus on something we love - algorithms, coding, and maybe a coffee cup!</p>
<p><br></p>
<p>I bet you can't come up with a better way to do this... share in comments to prove me wrong ;)</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/08/24/what-if-we-remove-strings-from-symfony-extension-configuratoin</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 24 Aug 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/08/24/what-if-we-remove-strings-from-symfony-extension-configuratoin#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Get Rid of Magic, Static and Chaos from Latte Filters ]]></title>
                <link>https://tomasvotruba.com/blog/2020/08/17/how-to-get-rid-of-magic-static-and-chaos-from-latte-filters</link>
                <description><![CDATA[ <p><a href="/blog/2020/08/10/4-ways-to-make-your-nette-project-more-readable/">In the previous post</a>, we looked at how to avoid array magic and duplicates of Latte in Presenter and Components.
<br>
<br>
Today we'll leverage those tips to make your code around Latte filters <strong>easy and smooth to work with</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Do you have your <code>LatteFactory</code> service ready? If not, <a href="/blog/2020/08/10/4-ways-to-make-your-nette-project-more-readable#4-move-latte-engine-tuning-from-presenter-control-to-lattefactory">create it first</a>, because we'll build on it.</p>
<p><br></p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Latte;

use Latte\Engine;
use Latte\Runtime\FilterInfo;

final class LatteFactory
{
    public function create(): Engine
    {
        $engine = new Engine();
        $engine-&gt;setStrictTypes(true);

        return $engine;
    }
}</code></pre>
<h2 id="How-to-register-a-new-Latte-Filter">How to register a new Latte Filter?</h2>
<p>This simple question can add easily add an anti-pattern to your code, that spreads like COVID and <a href="https://blog.codinghorror.com/the-broken-window-theory/">inspires developers to add more anti-patterns</a>. It's easy to <a href="/blog/2018/04/26/how-i-got-into-static-trap-and-made-fool-of-myself//">submit to static infinite loop</a>, I did it too.</p>
<p>But let's look at practice... <strong>how to add a filter</strong>?</p>
<p>Let's say we want to format money. The filter code is not relevant here, so we go with the simplest version possible:</p>
<pre><code class="language-php">class SomeFilter
{
    public function money(int $amount): string
    {
        return $amount . ' €';
    }
}</code></pre>
<p>We'll use it template like this:</p>
<pre><code class="language-html">You're total invoice amount:
&lt;strong&gt;{$amount|money}&lt;/strong&gt;

Thank you</code></pre>
<h2 id="1-Register-Static-Magic-Loader">1. Register Static Magic Loader</h2>
<p>This used to be the best practice in 2014. Just add a class and magically delegate called filter name:</p>
<pre><code class="language-diff"> namespace App\Latte;

 use Latte\Engine;
 use Latte\Runtime\FilterInfo;

 final class LatteFactory
 {
     public function create(): Engine
     {
         $engine = new Engine();
         $engine-&gt;setStrictTypes(true);
+        $engine-&gt;addFilter(null, SomeFilter::class . '::loader');

         return $engine;
    }
 }</code></pre>
<p>And add <code>loader()</code> method:</p>
<pre><code class="language-diff"> class SomeFilter
 {
-    public function money(int $amount): string
+    public static function money(int $amount): string
     {
         return $amount . ' €';
     }

+    public static function loader($arg)
+    {
+        $arg = \func_get_args();
+        $func = \array_shift($arg);
+        if (\method_exists(self::class, $func)) {
+            return \call_user_func_array([self::class, $func], $arg);
+        }
+
+         return null;
     }
 }</code></pre>
<p>This is my favorite magic part:</p>
<pre><code class="language-php">$engine-&gt;addFilter(null, SomeFilter::class . '::loader');</code></pre>
<p>Do you have any what is happening there? I don't.</p>
<p><br></p>
<h4 id="Pros-and-amp-Cons">Pros &amp; Cons</h4>
<ul>
<li>We have to use <code>static</code> ❌</li>
<li>We can't use any service in <code>SomeFilter</code>, we have to use static only ❌</li>
<li>We violate <code>addFilter()</code> method with magic and make it harder to read, maintain and refactor ❌</li>
<li>We have one place to add filters ✅</li>
</ul>
<p><br></p>
<p>Can we do better?</p>
<h2 id="2-Register-Function-manually-with-addFilter">2. Register Function manually with <code>addFilter()</code></h2>
<p>The <code>addFilter()</code> can be used in the way <a href="https://github.com/nette/latte/blob/82a85d31caeaf9a9d307e910a2d1476f5460cee0/src/Latte/Engine.php#L267">it's designed for</a>:</p>
<pre><code class="language-diff"> namespace App\Latte;

 use Latte\Engine;
 use Latte\Runtime\FilterInfo;

 final class LatteFactory
 {
     public function create(): Engine
     {
         $engine = new Engine();
         $engine-&gt;setStrictTypes(true);
+        $engine-&gt;addFilter('money', function (int $amount): string {
+             return $amount . ' €';
+        });

         return $engine;
    }
 }</code></pre>
<p>Straight forward, transparent, and a few lines of code.</p>
<h4 id="Pros-and-amp-Cons">Pros &amp; Cons</h4>
<ul>
<li>We have very little code ✅</li>
<li>The framework part (Latte) is now directly bounded to our application domain - this makes code hard to refactor, decopule from framework or re-use in another context ❌</li>
<li>We break dependency inversion principle - we have to edit <code>LatteFactory</code> to add a new filter ❌</li>
<li>We made a seed for God class antipattern - soon our <code>LatteFactory</code> will have over 100 of lines with various filters ❌</li>
<li>We think it's a good idea, because of short-code-is-the-best fallacy ❌</li>
</ul>
<p><br></p>
<p>Can we do better?</p>
<h2 id="3-Add-Filter-Provider-Service">3. Add Filter Provider Service?</h2>
<p>The previous solution looks fine, if only we could get rid of coupling between framework and our code.</p>
<pre><code class="language-diff"> namespace App\Latte;

 use Latte\Engine;
 use Latte\Runtime\FilterInfo;

 final class LatteFactory
 {
+    private FilterProvider $filterProvider;
+
+    public function __construct(FilterProvider $filterProvider)
+    {
+        $this-&gt;filterProvider = $filterProvider;
+    }

     public function create(): Engine
     {
         $engine = new Engine();
         $engine-&gt;setStrictTypes(true);

+        foreach ($this-&gt;filterProvider-&gt;provide() as $filterName =&gt; $filterCallback) {
+            $engine-&gt;addFilter($filterName, $filterCallback);
+        }

         return $engine;
    }
 }</code></pre>
<pre><code class="language-php">&lt;?php

final class FilterProvider
{
    /**
     * @return array&lt;string, callable&gt;
     */
    public function provide(): array
    {
        return [
            'money' =&gt; function (int $amount): string {
                return $amount . ' €';
            }
        ];
    }
}</code></pre>
<p>The filter class is decoupled - no more hard-coded filters!</p>
<h4 id="Pros-and-amp-Cons">Pros &amp; Cons</h4>
<ul>
<li>We can add a new filter without every touching <code>LatteFactory</code> ✅</li>
<li>We can use services in filters ✅</li>
<li>We <strong>only moved a seed for God class antipattern</strong> - soon our <code>FilterProvider</code> will have over 100 of lines with various filters ❌</li>
</ul>
<p><br></p>
<p>Can we do better?</p>
<h2 id="4-Filter-Provider-Contract">4. Filter Provider Contract</h2>
<p>The ultimate solution is almost perfect. We only need to get rid of the God class completely. How can we do that?</p>
<p>The goal is simple:</p>
<ul>
<li>each domain should have its filters, e.g., filters for text should have their class, filters for money should have their class, etc.</li>
<li>we can't touch the <code>LatteEngine</code> to add a new filter, nor a new filter service</li>
</ul>
<p><br></p>
<p>What if we use <a href="/blog/2018/11/12/will-autowired-arrays-finally-deprecate-tags-in-symfony-and-nette//">autowired arrays feature from Nette 3.0</a>?</p>
<p><br></p>
<pre><code class="language-diff"> namespace App\Latte;

+use App\Contract\FilterProviderInterface;
 use Latte\Engine;
 use Latte\Runtime\FilterInfo;

 final class LatteFactory
 {
+    private array $filterProvider;
+
+    /**
+     * @param FilterProviderInterface[] $filterProviders
+     */
+    public function __construct(array $filterProviders)
+    {
+        $this-&gt;filterProviders = $filterProviders;
+    }

     public function create(): Engine
     {
         $engine = new Engine();
         $engine-&gt;setStrictTypes(true);

+        foreach ($this-&gt;filterProviders as $filterProvider) {
+            foreach ($filterProvider-&gt;provide() as $filterName =&gt; $filterCallback) {
+                $engine-&gt;addFilter($filterName, $filterCallback);
+            }
+        }

         return $engine;
    }
 }</code></pre>
<pre><code class="language-php">namespace App\Contract;

interface FilterProviderInterface
{
    /**
     * @return array&lt;string, callable&gt;
     */
    public function provide();
}</code></pre>
<pre><code class="language-diff">+use App\Contract\FilterProviderInterface;

-final class FilterProvider
+final class MoneyFilterProvider implements FilterProviderInterface
 {
     /**
      * @return array&lt;string, callable&gt;
      */
     public function provide(): array
     {
         return [
             'money' =&gt; function (int $amount): string {
                 return $amount . ' €';
             }
         ];
     }
 }</code></pre>
<h4 id="Pros-and-amp-Cons">Pros &amp; Cons</h4>
<ul>
<li>We have decoupled framework and our domain-specific filter ✅</li>
<li>To add a new filters, we only need to create a new service ✅</li>
<li>We finally use dependency injection at its best - Nette handles registering filters and collecting service for us ✅</li>
<li>We <strong>add a seed for God method</strong> - soon <code>provide()</code> will be full of weird callbacks and long methods ❌</li>
</ul>
<p><br></p>
<p>Can we do better?</p>
<p><br></p>
<h2 id="5-From-Callbacks-to-Private-Methods">5. From Callbacks to Private Methods</h2>
<pre><code class="language-diff"> use App\Contract\FilterProviderInterface;

 final class MoneyFilterProvider implements FilterProviderInterface
 {
     /**
      * @return array&lt;string, callable&gt;
      */
     public function provide(): array
     {
         return [
             'money' =&gt; function (int $amount): string {
-                return $amount . ' €';
+                return $this-&gt;money($mount);
             }
         ];
     }

+    private function money(int $amount): string
+    {
+        return $amount . ' €';
+    }
 }</code></pre>
<p>This looks like a duplicated code, right?</p>
<p>But what if money filters grow, included timezones and logged in user country? Is <code>MoneyFilterProvider</code> the best place to handle all this logic?</p>
<pre><code class="language-diff"> use App\Contract\FilterProviderInterface;

 final class MoneyFilterProvider implements FilterProviderInterface
 {
+    private MoneyFormatResolver $moneyFormatResolver;
+
+    public function __construct(MoneyFormatResolver $moneyFormatResolver)
+    {
+       $this-&gt;moneyFormatResolver = $moneyFormatResolver;
+    }

     /**
      * @return array&lt;string, callable&gt;
      */
     public function provide(): array
     {
         return [
             'money' =&gt; function (int $amount): string {
-                return $this-&gt;money($mount);
+                return $this-&gt;moneyFormatResolver-&gt;resolve($amount);
             }
         ];
     }

-    private function money(int $amount): string
-    {
-        return $amount . ' €';
-    }
 }</code></pre>
<h4 id="Pros-and-amp-Cons">Pros &amp; Cons</h4>
<ul>
<li>We have decoupled domain logic from filters ✅</li>
<li>We can re-use the used-to-be filter logic with <code>MoneyFormatResolver</code> in other places of application ✅</li>
<li>We are motivated to use DI and decouple code clearly to new service, if it ever becomes too complex ✅</li>
<li>We are ready for any changes that come in the future ✅</li>
<li><del>We think this is the best way, just because it's last ❌</del> Not anymore ↓</li>
</ul>
<p><br></p>
<p>My question is: can we do better...?</p>
<hr />
<p><strong>Update 1 month later with new option:</strong></p>
<h2 id="6-Invokable-Filter-Providers">6. Invokable Filter Providers</h2>
<p>In fashion of <a href="https://symfony.com/doc/current/controller/service.html#invokable-controllers">single-action controller</a> a tip from <a href="https://twitter.com/FrantisekMasa">@FrantisekMasa</a> and <a href="https://twitter.com/dada_amater">@dada_amater</a> for similar approach in filters. It look weird, new... so I had to try it in practise to see for myself.</p>
<pre><code class="language-php">namespace App\Contract;

interface FilterProviderInterface
{
    public function getName(): string;
}</code></pre>
<p>The filter itself - 1 filter = 1 class:</p>
<pre><code class="language-php">use App\Contract\FilterProviderInterface;

final class MoneyFilterProvider implements FilterProviderInterface
{
    private MoneyFormatResolver $moneyFormatResolver;

    public function __construct(MoneyFormatResolver $moneyFormatResolver)
    {
       $this-&gt;moneyFormatResolver = $moneyFormatResolver;
    }

    public function __invoke(int $amount): string
    {
        return $this-&gt;moneyFormatResolver-&gt;resolve($amount);
    }
}</code></pre>
<p>The <code>LatteFactory</code> now acceps the whole filter as callable object:</p>
<pre><code class="language-php">namespace App\Latte;

use Latte\Engine;
use Latte\Runtime\FilterInfo;

final class LatteFactory
{
    /**
     * @var FilterProviders[]
     */
    private array $filterProviders = [];

    /**
     * @param FilterProvider[]
     */
    public function __construct(array $filterProviders)
    {
        $this-&gt;filterProviders = $filterProviders;
    }

    public function create(): Engine
    {
        $engine = new Engine();
        $engine-&gt;setStrictTypes(true);

        foreach ($this-&gt;filterProviders as $filterProvider) {
            $engine-&gt;addFilter($filterProvider-&gt;getName(), $filterProvider);
        }

        return $engine;
    }
}</code></pre>
<h4 id="Pros-and-amp-Cons">Pros &amp; Cons</h4>
<ul>
<li>All of the advantages of previous approaches ✅</li>
<li>1 class = 1 rule, this is really challenge to clutter ✅</li>
<li>It's very intuitive to use  ✅</li>
<li>We don't have to maintain duplicated <code>provideFilters()</code> callables with private methods ✅</li>
<li>The <code>__invoke()</code> method has no contract, so we can forget to implement it ❌</li>
</ul>
<p>We compensate this in <code>LatteFactory</code> itself:</p>
<pre><code class="language-php">public function create(): Engine
{
    $engine = new Engine();
    $engine-&gt;setStrictTypes(true);

    foreach ($this-&gt;filterProviders as $filterProvider) {
        if (! method_exists($filterProvider, '__invoke')) {
            $message = sprintf('Add "__invoke()" method to filter provider "%s"', get_class($filterProvider));
            throw new ShouldNotHappenException($message);
        }

        $engine-&gt;addFilter($filterProvider-&gt;getName(), $filterProvider);
    }

    return $engine;
}</code></pre>
<p>That's it!</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/08/17/how-to-get-rid-of-magic-static-and-chaos-from-latte-filters</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 17 Aug 2020 00:00:00 +0000</pubDate>
                                    <updated>2020-09-01UTC00:00:000</updated>
                    <atom:updated>Tue, 01 Sep 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Tue, 01 Sep 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/08/17/how-to-get-rid-of-magic-static-and-chaos-from-latte-filters#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 4 Ways to Make Your Nette Project More Readable ]]></title>
                <link>https://tomasvotruba.com/blog/2020/08/10/4-ways-to-make-your-nette-project-more-readable</link>
                <description><![CDATA[ <p>You can <a href="/blog/2019/08/26/how-we-migrated-54-357-lines-of-code-nette-to-symfony-in-2-people-under-80-hours/">switch PHP framework you use in a month</a>. Yet, <strong>80 % of work lays before the migration</strong> itself, is to take unreliable PHP code structures and <strong>make <a href="/blog/2020/03/02/we-do-not-need-senior-developers-we-need-senior-code-bases/">it readable</a> for developers</strong>.
<br><br>
What belongs to these 80 % when it comes to Nette-specific code?</p> ]]></description>
                <content:encoded><![CDATA[ <p>Each framework has its documentation. The developers take it and test it in practice, how good the examples stand in real life. Sometimes <strong>the practical experience goes against the documentation primary choice</strong>, like using <a href="/blog/2019/03/04/how-to-turn-laravel-from-static-to-dependency-injection-in-one-day/">dependency injection in Laravel</a>.</p>
<p>These practical tips are golden mine, <strong>because they save the company money and developer work time in the further future</strong>.
Do you use Nette? Today, we look at 10 such spots that will bring you code advantage and make changes more comfortable and stable.</p>
<h2 id="1-Avoid-Array-Access">1. Avoid Array Access</h2>
<p>Could you guess, what type is <code>$something</code>?</p>
<pre><code class="language-php">use Nette\Application\UI\Presenter;

final class SomePresenter extends Presenter
{
    public function renderDefault()
    {
        // ...
        $something = $this['user'];
        $something-&gt;...?
    }

    // another 300+ lines of code
}</code></pre>
<p>What do you think? I'd go with <code>int</code> or <code>User</code>. It can be a form, a control, a form input... because array access in <code>Control</code> or <code>Presenter</code> is delegated to...</p>
<img src="/assets/images/posts/2020/nette_readability_array_access.png" class="img-thumbnail">
<p>... <code>getComponent()</code>/<code>addComponent()</code> methods.</p>
<h3 id="How-to-Make-Such-Code-Readable">How to Make Such Code Readable?</h3>
<p>Add PHPStan that prevent array access on objects:</p>
<pre><code class="language-yaml"># phpstan.neon
rules:
    - Symplify\CodingStandard\Rules\NoArrayAccessOnObjectRule</code></pre>
<p>This little rule might help us to re-introduce an essential yet straightforward coding cue:</p>
<ul>
<li>arrays are always arrays and <strong>behave like arrays</strong></li>
<li>objects are always objects, and <strong>behave like objects</strong></li>
</ul>
<p>Okay, we probably have now over dozens of errors. But what should we do about them?</p>
<p>Use the explicit method, that is hidden in <code>offsetGet()</code>/<code>offsetSet()</code> methods, e.g:</p>
<pre><code class="language-diff">-$something = $this['user'];
+$something = $this-&gt;getComponent('user');</code></pre>
<pre><code class="language-diff">-$this['user'] = $something ;
+$this-&gt;addComponent($something, 'user');</code></pre>
<h3 id="">👍</h3>
<h2 id="2-Be-Honest-About-Components-You-Use">2. Be Honest About Components You Use</h2>
<p>Alright, now we know its <em>a</em> component.</p>
<pre><code class="language-php">$something = $this-&gt;getComponent('user');
$something-&gt;...</code></pre>
<p>It might look natural since we're used to this syntax. Let's try to forget this habit. How readable is this approach?</p>
<p>Let's look at an example from another well-known area, with a similar context. Would you be able to work with such entity objects?</p>
<pre><code class="language-php">$entity = $this-&gt;getEntity('user');
// here we have only "getId()" method, that is common to all entities
$entity-&gt;...

// forget IDE autocomplete for specific entities
$entity-&gt;getName();</code></pre>
<p>Honestly, <a href="/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock/">I don't memorize code</a>, my super-smart IDE does it for me.</p>
<h3 id="How-to-Make-Such-Code-Readable">How to Make Such Code Readable?</h3>
<p>Again, all we need is common sense. Nothing fancy.</p>
<p>How can we get an exact specific entity?</p>
<pre><code class="language-php">// 1. annotation
/** @var User $user */
$user = $this-&gt;getEntity('user');

// 2. add custom method with return type
$user = $this-&gt;getUser();

// another way or two you can think of</code></pre>
<img src="/assets/images/posts/2020/nette_readability_get_component.gif" class="img-thumbnail">
<h3 id="What-are-Benefits-of-Typed-Code">What are Benefits of Typed Code?</h3>
<ul>
<li>IDE automated refactoring works on specific components</li>
<li>IDE can provide autocomplete, that is unique per component</li>
<li>PHPStan knows the types and component methods and where they're called from</li>
<li>Rector can refactor components with ease</li>
<li>the most important: <strong>you know what's going on, even if you're the first day on the project</strong></li>
</ul>
<blockquote class="blockquote text-center">
"So many benefits, that sounds great!<br>
But it's a lot of work to get there."
</blockquote>
<p>I feel you, same here. If I were about to do it manually, I would not do it.</p>
<p>Luckily, we <strong>lazy people have tools to work for us</strong>. Let <a href="https://github.com/rectorphp/rector">Rector</a> handle it:</p>
<pre><code class="language-php">use Rector\NetteCodeQuality\Rector\Assign\ArrayAccessGetControlToGetComponentMethodCallRector;
use Rector\NetteCodeQuality\Rector\Assign\ArrayAccessSetControlToAddComponentMethodCallRector;
use Rector\NetteCodeQuality\Rector\Assign\MakeGetComponentAssignAnnotatedRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;rule(MakeGetComponentAssignAnnotatedRector::class);
    $rectorConfig-&gt;rule(ArrayAccessSetControlToAddComponentMethodCallRector::class);
    $rectorConfig-&gt;rule(ArrayAccessGetControlToGetComponentMethodCallRector::class);
};</code></pre>
<p>And run Rector:</p>
<pre><code class="language-bash">vendor/bin/rector process src</code></pre>
<h3 id="">👍</h3>
<h2 id="3-Remove-Array-Access-on-Form-Controls">3. Remove Array Access on Form Controls</h2>
<p>The #1 was about use in <code>Presenter</code> and <code>Control</code>, but what about <code>Form</code>?</p>
<pre><code class="language-php">use Nette\Application\UI\Form;

$form = new Form();
$form-&gt;addText('name', 'Name');</code></pre>
<p>Different class, same array access magic, same problem.</p>
<h3 id="How-to-Make-Such-Code-Readable">How to Make Such Code Readable?</h3>
<img src="/assets/images/posts/2020/nette_readability_get_form_control.gif" class="img-thumbnail">
<p>This makes code readable in the same points above - for IDE, PHPStan, and Rector.</p>
<p>&quot;So much work?&quot; Rector got you covered:</p>
<pre><code class="language-php">use Rector\NetteCodeQuality\Rector\ArrayDimFetch\ChangeControlArrayAccessToAnnotatedControlVariableRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;rule(ChangeControlArrayAccessToAnnotatedControlVariableRector::class);
};</code></pre>
<p><br></p>
<h3 id="Can-We-do-Better">Can We do Better?</h3>
<p>Imagine you create a form, and somewhere in your code, an input is removed, and select box added. Where? How? Magic!</p>
<p>So even better, <strong>modify forms only in the method they were created</strong>.</p>
<p>Do you need a form that is just slightly different from an already existing one? Don't mutate existing, but rather:</p>
<ul>
<li>create <strong>a new form factory</strong></li>
<li>decouple common <strong>abstract parent form factory</strong> class for re-use</li>
</ul>
<p>That way, you promote composition over inheritance in your code and respect SOLID principles.</p>
<h2 id="4-Move-Latte-Engine-tuning-from-Presenter-Control-to-LatteFactory">4. Move Latte Engine tuning from Presenter/Control to LatteFactory</h2>
<p>Latte modification in the wrong places is more common than you'd expect.</p>
<p><br></p>
<p>How would you add <code>setStrictTypes(true)</code> for all templates?</p>
<pre><code class="language-php">use Nette\Application\UI\Presenter;

abstract class AbstractPresenter extends Presenter
{
    public function beforeRender()
    {
        // is this the right place?
        // signals (handle*) are actually called after
        $this-&gt;template-&gt;getLatte()-&gt;setStrictTypes(true);
    }

    // or

    public function templatePrepareFilters()
    {
        // is this the right place?
        // or just for filters?
        $this-&gt;template-&gt;getLatte()-&gt;setStrictTypes(true);
    }
}</code></pre>
<p>Ou, don't forget the components. Every single component!</p>
<pre><code class="language-php">use Nette\Application\UI\Control;

abstract class AbstractControl extends Control
{
    // is this the right place?
    public function __construct()
    {
        // template can be null here
        $this-&gt;template-&gt;getLatte()-&gt;setStrictTypes(true);

        // or

        // isn't this lazy factory? what if the template object is different?
        $this-&gt;getTemplate()-&gt;getLatte()-&gt;setStrictTypes(true);
    }

    // or

    // is this the right place?
    public function render()
    {
        // so now we have to call parent::render() in every child component?
        $this-&gt;template-&gt;getLatte()-&gt;setStrictTypes(true);
    }
}</code></pre>
<p>Now we have to enforce this parent control in every other control we have, and we should be fine...</p>
<p>Until we <strong>use templates for mail</strong>. What a surprise when final invoice price was accidentally a string <code>''</code> that turned into <code>0</code>. Ups, we just got paid 0 € instead of 750 €.</p>
<h3 id="How-to-Make-Such-Code-Readable">How to Make Such Code Readable?</h3>
<p>Instead of trying to put down every fire our child makes in our home, we could... I don't know, take their matches?</p>
<p>It's also known as <em>single responsibility principle</em>. There is <strong>max. 1 place to make 1 change</strong> - meet <code>LatteFactory</code>:</p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Latte;

use Latte\Engine;
use Latte\Runtime\FilterInfo;

final class LatteFactory
{
    public function create(): Engine
    {
        $engine = new Engine();
        $engine-&gt;setStrictTypes(true);

        return $engine;
    }
}</code></pre>
<p>We have a <strong>1 place to modify</strong> <code>Latte\Engine</code>. Now we need to tell Nette to use it to create all the templates - with an extension:</p>
<pre><code class="language-php">&lt;?php

// src/DI/LatteFactoryExtension.php

declare(strict_types=1);

namespace App\DI;

use App\Latte\LatteFactory;
use Latte\Engine;
use Nette\DI\CompilerExtension;

final class LatteFactoryExtension extends CompilerExtension
{
    public function loadConfiguration(): void
    {
        $containerBuilder = $this-&gt;getContainerBuilder();

        $containerBuilder-&gt;addDefinition('app.latteFactory')
            -&gt;setType(LatteFactory::class);

        $latteFactoryDefinition = $containerBuilder-&gt;getDefinition('latte.latteFactory');
        $latteFactoryDefinition-&gt;setFactory(['@' . LatteFactory::class, 'create']);
        $latteFactoryDefinition-&gt;setType(Engine::class);
    }
}</code></pre>
<p>Register the extension to config, and you're ready to go:</p>
<pre><code class="language-yaml">extensions:
    - App\DI\LatteFactoryExtension</code></pre>
<h3 id="Change-is-the-Only-Constant">Change is the Only Constant</h3>
<p>Do we need to add <strong>translator to all templates</strong>?</p>
<p>No need to edit 3 places, just one:</p>
<pre><code class="language-diff"> &lt;?php

 declare(strict_types=1);

 namespace App\Latte;

 use Latte\Engine;
 use Latte\Runtime\FilterInfo;
+use Nette\Localization\ITranslator;

 final class LatteFactory
 {
+    private ITranslator $translator;
+
+    public function __construct(ITranslator $translator)
+    {
+        $this-&gt;translator = $translator;
+    }

     public function create(): Engine
     {
         $engine = new Engine();
         $engine-&gt;setStrictTypes(true);

+        $engine-&gt;addFilter('translate', function (FilterInfo $filterInfo, ...$args) {
+            return $this-&gt;translator-&gt;translate(...$args);
+        });

         return $engine;
     }
 }</code></pre>
<h3 id="">👍</h3>
<p><br></p>
<p>That's all for today.</p>
<h2 id="Removing-Magic-makes-us-Feel-Safe">Removing Magic makes us Feel Safe</h2>
<p>Just to repeat the basics. The goal of refactoring is to make code SOLID, unbreakable, and reliable source. When we have a code we understand, we feel safe.</p>
<blockquote class="blockquote text-center mt-5 mb-5">
When we feel safe, we are more productive and make huge changes faster.<br>
If we have to worry about every single line of code, we slowly freeze.
</blockquote>
<p>By 4 steps above, you've just added <strong>5 benefits to your codebase</strong>:</p>
<ul>
<li>IDE automated refactoring works on specific components</li>
<li>IDE can provide autocomplete, that is unique per component</li>
<li>PHPStan knows the types and component methods and where they're called from</li>
<li>Rector can refactor components with ease</li>
<li>the most important: <strong>you know what's going on, even if you're the first day on the project</strong></li>
</ul>
<p><br></p>
<p>Do you have a tip on how to make Nette code even better? Is there some shortcut I don't know about?</p>
<p>Let me know in the comments ↓. I'd love to learn a new skill that we could apply on Nette projects we upgrade.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/08/10/4-ways-to-make-your-nette-project-more-readable</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 10 Aug 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/08/10/4-ways-to-make-your-nette-project-more-readable#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Give Away 1500 € in 1 Tweet and Help 25 People Learn Something New ]]></title>
                <link>https://tomasvotruba.com/blog/2020/08/03/how-give-away-1500-eur--in-1-tweet-and-help-25-people-learn-something-new</link>
                <description><![CDATA[ <p>What makes one give?
<br><br>
For me, it's a combination of gratitude, abundance, and inspiration in the surrounding.</p> ]]></description>
                <content:encoded><![CDATA[ <p>I love helping others in a way that helps them grow. In a feedback loop, their growth helps me to grow... recursive. Yet, I rarely touched the financial part. Still, <strong>I wanted to share gratitude with the community, that helps me every day to get where I am now</strong>. I'm very grateful to be part of it.</p>
<h2 id="What-were-the-3-last-Nails-in-the-Coffin">What were the 3 last Nails in the Coffin?</h2>
<ul>
<li>corona stuff, it hit many people very hard, with less work, income, and option to live a decent life</li>
<li>I saw <a href="https://twitter.com/_braindev/status/1276483109165416449">Jamie</a> giving away in June - thank you, Jamie, for inspiration!</li>
<li>accidentally, I listed to an intense podcast with <a href="https://sive.rs">Derek Sivers</a>, that dropped a reference to - <a href="https://www.amazon.com/Give-and-Take-Adam-Grant-audiobook/dp/B07F7F8NL5">Give and Take</a> - from the title I assumed it was a book about business and financial matters, but in the end, it gave me more insight how easy and inspiring is to give</li>
</ul>
<p>It <strong>felt right</strong>, so I thought...</p>
<blockquote class="blockquote text-center mt-5 mb-5">
    ...what the hell, let's do it!
</blockquote>
<p>In 5 minutes, around midnight, the tweet was ready. I pushed the &quot;Tweet&quot; button and let message go out in the world and let it live its own story:</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">I'll pay for 5 people to receive an online course/subscription of their choice (each up to $249)<br><br>❤️️ Like this tweet &amp; I will pick 5 winners by Monday 6 PM CET 🚀<br><br>Appreciate a RT to spread the word<br>cc <a href="https://twitter.com/javiereguiluz?ref_src=twsrc%5Etfw">@javiereguiluz</a> <a href="https://twitter.com/Ocramius?ref_src=twsrc%5Etfw">@Ocramius</a><a href="https://twitter.com/matthiasnoback?ref_src=twsrc%5Etfw">@matthiasnoback</a> <a href="https://twitter.com/michellesanver?ref_src=twsrc%5Etfw">@michellesanver</a> <a href="https://twitter.com/enunomaduro?ref_src=twsrc%5Etfw">@enunomaduro</a></p>— Tomas Votruba (@VotrubaT) <a href="https://twitter.com/VotrubaT/status/1284616098202230787?ref_src=twsrc%5Etfw">July 18, 2020</a></blockquote>
<p><br></p>
<h2 id="Sunday-Morning-Surprise">Sunday Morning Surprise</h2>
<p><strong>I was excited how this evolves but scared of the feedback</strong>. So I just peeked at the notifications number on Tweetdeck. Only nine reactions? Oh, now, it's dead. I was sad and crushed. Maybe I put something wrong. Maybe I forgot to tweet it, I thought.</p>
<p>So I opened Twitter and looked for comments with feedback, what's wrong. 9 was a count of tweets with <em>some</em> notification, not the total number of notifications.</p>
<p><strong>There were over 50 retweets already</strong>. In a couple of hours, as people start to wake up on Sunday morning, the tweet had over 200 retweets and 600 likes! Oh many, this escalated quickly.</p>
<p>It was much faster and more than I ever imagined, but it was good.</p>
<h2 id="and-quot-I-want-to-Win-Not-for-myself-But-for-My-Friends-and-quot">&quot;I want to Win, Not for myself, But for My Friends&quot;</h2>
<p>I was surprised, how many people wanted to <strong>share their prize with others</strong>:</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">I’ll take the prize and split for 2 friends. Fortunanetly i’m able to purchase what i think i need. It wasnt always like that, and also love to do the same here and there!<br>Thank you Tomas ❤️❤️❤️</p>— João Patrício (@ijpatricio) <a href="https://twitter.com/ijpatricio/status/1284825490369523713?ref_src=twsrc%5Etfw">July 19, 2020</a></blockquote>
<p><br></p>
<p>I was so touched by reactions that I've decided to raise the limit of 5 to <a href="https://twitter.com/VotrubaT/status/1284616098202230787/retweets/with_comments">9 people</a>.</p>
<hr />
<blockquote class="blockquote">
"I'm mstrYoda_ from twitter. You picked me as one of the winners. As I
told you, I want to give it to another person who needs it."
</blockquote>
<p>I loved that!</p>
<blockquote class="blockquote">
Please go for it! That's so generous of you. Just send me emails + gift link to courses, and I'll handle it.
<br>
To support your generosity and help your circle, I'm raising the limit to 400 €.
</blockquote>
<p>After a few days and emails, we managed <strong>to give 16 more people a course</strong> on Udemy.</p>
<p><br></p>
<h2 id="If-You-Give-You-Get-More">If You Give, You Get More</h2>
<p><br></p>
<p>I've got so many grateful emails, that my serotonin reserves were empty soon:</p>
<blockquote class="blockquote">
"It is a big help indeed for me, especially in the time of the pandemic. Money matters all the time, and I have a pregnant wife also to sustain all of her needs, and your perks will help me to save money and time."
</blockquote>
<hr />
<blockquote class="blockquote">
Trust this finds you well. Thank you so much for the random act of kindness that you are doing to total strangers like me. I am so grateful.
</blockquote>
<hr />
<blockquote class="blockquote">
I don't know what to say! You do care, and that's a great gesture
</blockquote>
<div class="text-center">
<h2 id="">❤️️❤️️❤️️</h2>
</div>
<p><br>
<br></p>
<p>Last but not least, I'd like to <strong>thank everyone who retweeted only to spread the message to their circles and wanted to help others</strong>. In the end, we could help together to 25 people, who would not have this change otherwise. That's a good job done!</p>
<h2 id="What-can-I-do-better-Next-Time">What can I do better Next Time</h2>
<ul>
<li>
<p>Many courses <strong>don't allow buying a gift</strong>. You have to contact support and ask if they can configure it in the database to some other email than the one you paid it from. It can be a nightmare, which is not what you want if you want to give away.</p>
</li>
<li>
<p>Saying that, pick a <strong>set of courses that have an easy way to buy gifts</strong>: <a href="https://www.udemy.com">Udemy</a> and <a href="https://laracasts.com/gift-certificates">Laracasts</a> were very helpful. Also, you can configure the invoice easily.</p>
</li>
<li>
<p>The two days limit to retweet was too much. It spread too far, and it was pretty hard to pick five winners out of 1 000 people. I'd go with <a href="https://twitter.com/_braindev/status/1276483109165416449">Jamie's strategy with <strong>limit of couple of hours</strong></a></p>
</li>
</ul>
<p><br></p>
<h2 id="If-you-Can-Give-Now-it-s-the-Time">If you Can Give, Now it's the Time</h2>
<p>We all live in this world together. Whatever country, DNA, or social status. The world is not in crisis; our humanity is. Now it's the best time to act and do something about it. <strong>Help a neighbor get their food list, buy a friend a beer, buy stranger food, or give whatever you want</strong>. The further unexpected help out of your circles, the better.</p>
<p>I spent some money, but I got much more joy, a feeling of community, and fantastic feedback on this random act of kindness.</p>
<p><strong>Now, it's time to help each other. I thank you in advance!</strong></p>
<p><br></p>
<p>Happy giving!</p>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/08/03/how-give-away-1500-eur--in-1-tweet-and-help-25-people-learn-something-new</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 03 Aug 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/08/03/how-give-away-1500-eur--in-1-tweet-and-help-25-people-learn-something-new#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Switch from YAML/XML Configs to PHP Today with Symplify ]]></title>
                <link>https://tomasvotruba.com/blog/2020/07/27/how-to-switch-from-yaml-xml-configs-to-php-today-with-migrify</link>
                <description><![CDATA[ <p>In <a href="/blog/2020/07/16/10-cool-features-you-get-after-switching-from-yaml-to-php-configs/">previous post</a>, we looked 10 reasons to switch from YAML to PHP configs. Still asking <em>why</em>? I dare you to <a href="/blog/2020/07/16/10-cool-features-you-get-after-switching-from-yaml-to-php-configs/">disagree with 1 reason there</a>.
<br><br>
If you have 1 config file, you already are on PHP side now. Close this post and enjoy life.
<br><br>
But what if you have 10 or even 100 YAML/XML configs? Are you doing to close down for a weekend to switch your code base?
<br>
<br>
Or maybe... <strong>5 minute job</strong>?</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Break-Even-Automation">Break-Even Automation</h2>
<p>With legacy migrations, we have to handle a lot of processes that are automated. If you work on 1 project for many years, it's a matter of habit to handle it manually. But <strong>handling 3 projects a month makes you think, how to automated any repeated work</strong>. It's cheaper, faster, and more reliable. The same way the writing tests are.</p>
<p><br></p>
<p>We made <a href="https://github.com/symplify/config-transformer">symplify/config-transformer</a> to handle this work for us.</p>
<img src="/assets/images/posts/2020/yaml_to_php.png" class="img-thumbnail">
<p><br></p>
<p><strong>Credit</strong> for inspiration first reported bugs, feature feedback, and exceptional test cases <strong>goes to <em>archeoprog</em> and <a href="https://github.com/weaverryan">Ryan Weaver</a></strong>. Their input helped get the Symplify package to high quality and covered Symfony features I didn't even know. Thank you, guys!</p>
<p><br></p>
<h2 id="1-Install-symplify-config-transformer">1. Install symplify/config-transformer</h2>
<pre><code class="language-bash">composer require symplify/config-transformer --dev</code></pre>
<h2 id="2-Run-switch-format-Command">2. Run <code>switch-format</code> Command</h2>
<p>This command takes 1 argument - paths to files or directories to convert:</p>
<pre><code class="language-bash">vendor/bin/config-transformer switch-format app/config</code></pre>
<p><br></p>
<p>This is how my <strong>real workflow</strong> looks like: from low hanging fruit of 1 file to the main config, to all packages.
Each followed by a separated commit, so it's easier to review and fix in case of regression.</p>
<pre><code class="language-bash">vendor/bin/config-transformer switch-format ecs.yaml
# commit

vendor/bin/config-transformer switch-format rector.yaml
# commit

vendor/bin/config-transformer switch-format app/packages
# commit

vendor/bin/config-transformer switch-format app/config/config.yaml
# commit</code></pre>
<h2 id="3-Upgrade-paths-to-PHP-in-Extensions-and-Kernel">3. Upgrade paths to PHP in Extensions and Kernel</h2>
<p>The config format switch is one part; the next is to update loaders in PHP code.
Again, it's valid to handle it manually with search &amp; replace in PHPStorm.</p>
<pre><code class="language-diff"> use Symfony\Component\Config\FileLocator;
 use Symfony\Component\DependencyInjection\ContainerBuilder;
-use Symfony\Component\DependencyInjection\Loader\YamlFileLoader;
+use Symfony\Component\DependencyInjection\Loader\PhpFileLoader;
 use Symfony\Component\HttpKernel\DependencyInjection\Extension;

 final class SomeExtension extends Extension
 {
     public function load(array $configs, ContainerBuilder $container)
     {
-        $loader = new YamlFileLoader($container, new FileLocator());
+        $loader = new PhpFileLoader($container, new FileLocator());
-        $loader-&gt;load(__DIR__ . '/../Resources/config/controller.yaml');
+        $loader-&gt;load(__DIR__ . '/../Resources/config/controller.php');
-        $loader-&gt;load(__DIR__ . '/../Resources/config/events.yaml');
+        $loader-&gt;load(__DIR__ . '/../Resources/config/events.php');
     }
 }</code></pre>
<p>But in case your code is not standard and can't be bothered with correct regular expressions, Rector got you covered:</p>
<pre><code class="language-bash">composer require rector/rector --dev</code></pre>
<p>Setup <code>rector.php</code>:</p>
<pre><code class="language-php">use Rector\Symfony\Rector\Class_\ChangeFileLoaderInExtensionAndKernelRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;ruleWithConfiguration(ChangeFileLoaderInExtensionAndKernelRector::class, [
        ChangeFileLoaderInExtensionAndKernelRector::FROM =&gt; 'yaml',
        ChangeFileLoaderInExtensionAndKernelRector::TO =&gt; 'php',
    ]);
};</code></pre>
<p>And let Rector handle the boring work:</p>
<pre><code class="language-bash">vendor/bin/rector process app src</code></pre>
<p><br></p>
<p>That's it! One little tool for you, one big leap for a PHP programmer-kind.</p>
<h2 id="Supported-Features">Supported Features</h2>
<ul>
<li>imports</li>
<li>services</li>
<li>parameters</li>
<li>autodiscovery</li>
<li>instance of</li>
<li>extensions, e.g. <code>framework</code>, <code>doctrine</code> or <code>twig</code></li>
<li>routing</li>
</ul>
<h2 id="Let-Us-Know-Help-You-Grow">Let Us Know, Help You Grow</h2>
<p><strong>Is something broken? Have you found a space for improvement?</strong></p>
<p>Create <a href="https://github.com/symplify/symplify/issues/new">an issue</a> and let us know. We'd love to hear it.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/07/27/how-to-switch-from-yaml-xml-configs-to-php-today-with-migrify</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 27 Jul 2020 00:00:00 +0000</pubDate>
                                    <updated>2021-06-01UTC00:00:000</updated>
                    <atom:updated>Tue, 01 Jun 2021 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Tue, 01 Jun 2021 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/07/27/how-to-switch-from-yaml-xml-configs-to-php-today-with-migrify#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Update Hundreds of Test Fixtures with Single PHPUnit run ]]></title>
                <link>https://tomasvotruba.com/blog/2020/07/20/how-to-update-hundreds-of-test-fixtures-with-single-phpunit-run</link>
                <description><![CDATA[ <p>In <a href="/blog/2020/07/13/the-most-effetive-test-i-found-in-7-years-of-testing/">previous post</a>, we look at the benefits of visual snapshot testing for lazy people. How bare <em>input/output</em> code in a single file makes tests easy to read for new contributors.
<br><br>
Today, we look at <strong>how to maintain visual snapshot tests</strong>.
<br><br>
Let's say we need to add <code>declare(strict_types=1);</code> to output part of 100 test fixtures? Would you add it manually in every single file?</p> ]]></description>
                <content:encoded><![CDATA[ <p>Short quiz from last week: <strong>what is the visual snapshot test</strong>?</p>
<p>A test where the new test case is a single fixture file:</p>
<pre><code class="language-bash">before
-----
after</code></pre>
<p><br></p>
<p>Let's say we test a service that multiplies the input number by 5.</p>
<p>How would the fixture look like?</p>
<pre><code class="language-bash">10
-----
50</code></pre>
<p>Correct! Now let's learn something new.</p>
<blockquote class="blockquote text-center">
    "It's easy to write tests that are hard to maintain."
</blockquote>
<h2 id="Use-Case-Add-1-Line-to-100-Files">Use Case: Add 1 Line to 100 Files</h2>
<p>I'm currently working on a tool <a href="https://twitter.com/VotrubaT/status/1285190524627025925">that migrates YAML configs to PHP</a>. It's almost finished... but there is one thing missing in all those configs. <em>PHP</em> configs.</p>
<p><br></p>
<p>I forgot to add the <code>declare(strict_types=1);</code> line. So now, every time you generate a PHP config, you have to run coding standards too on these files. <strong>So much extra work you, end-developers</strong>.</p>
<p>When was my mission changed to <em>adding</em> developers extra tedious work? <strong>We need to handle it</strong>.</p>
<p><br></p>
<h3 id="What-Can-We-Do-Now">What Can We Do Now?</h3>
<ul>
<li>add it to the PHP script, that converts the file to PHP, so the line is there</li>
<li>now tests start failing because the line is missing in the expected output</li>
</ul>
<pre><code class="language-yaml">parameters:
    key: 'value'
-----
&lt;?php

use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $parameters = $containerConfigurator-&gt;parameters();

    $parameters-&gt;set('key', 'value');
};</code></pre>
<ul>
<li>go through test fixtures and <strong>manually add the line</strong></li>
</ul>
<p>If we are lucky and the pattern is unique, we can use PHPStorm find/replace or even regular expressions. This might work for this simple case, <strong>but soon fails for real-life cases</strong> like &quot;add extra method call under each $service-&gt;set()&quot;.</p>
<p>We can do better.</p>
<p><br></p>
<h2 id="Automated-Test-Fixture-Updates">Automated Test Fixture Updates</h2>
<ul>
<li>How can we automate the update <strong>under few seconds</strong>?</li>
<li>How can we do it <strong>without thinking</strong> about what needs to be changed and how?</li>
</ul>
<p><br></p>
<p>With visual snapshot tests this is piece of cake. All we need is <code>UPDATE_TESTS=1</code> env and normal PHPUnit run:</p>
<img src="/assets/images/posts/2020/update_tests_example.gif" class="img-thumbnail">
<p>Now, all the 100 files have completed <code>declare(strict_types=1);</code>:</p>
<pre><code class="language-yaml">parameters:
    key: 'value'
-----
&lt;?php

declare(strict_types=1);

use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $parameters = $containerConfigurator-&gt;parameters();

    $parameters-&gt;set('key', 'value');
};</code></pre>
<h2 id="How-did-that-Happened">How did that Happened?</h2>
<p>In the previous post, we looked on <a href="/blog/2020/07/13/the-most-effetive-test-i-found-in-7-years-of-testing/#code-time">how to split and test fixture files</a>.</p>
<p>We only update this code with a single method, that will handle the fixture updates:</p>
<pre><code class="language-diff"> &lt;?php

 use PHPUnit\Framework\TestCase;

 final class FirstTryTest extends TestCase
 {
     public function test(): void
     {
         $filePath = __DIR__ . '/fixture/first_try.php';

         $fixtureContent = file_get_contents($filePath);
         [$input, $expectedOutput] = explode("\n-----\n", $fixtureContent);

         // test your main domain service
         $output = $this-&gt;processInputInYourDomain($input);

+        $this-&gt;updateFixture($input, $output, $filePath);

         $this-&gt;assertSame($expectedOutput, $output);
     }
 }</code></pre>
<p>And add the <code>updateFixture()</code> method:</p>
<pre><code class="language-php">private function updateFixture(
    string $input,
    string $currentOutput,
    string $fixtureFilePath
): void {
    // only runs when UPDATE_TESTS=1 is put before PHPUnit run
    if (! getenv('UPDATE_TESTS')) {
        return;
    }

    // update changed output content part
    $newOriginalContent = $input . PHP_EOL .
        '-----' . PHP_EOL .
        $currentOutput . PHP_EOL;

    // update the fixture file
    file_put_contents($fixtureFilePath, $newOriginalContent);
}</code></pre>
<p>And that's it!</p>
<p>The best place to add <code>updateFixture()</code> is an abstract test case, e.g., <code>AbstractVisualSnapshotTestCase</code>. So we have one place to change.</p>
<p><br></p>
<p>Now you can do massive changes in your business logic, and even you rewrite the output completely, all you need to run is:</p>
<pre><code class="language-bash">UPDATE_TESTS=1 vendor/bin/phpunit</code></pre>
<p>Now we know the simplest way to maintain tests that are easy to read there is... or is it?</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/07/20/how-to-update-hundreds-of-test-fixtures-with-single-phpunit-run</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 20 Jul 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/07/20/how-to-update-hundreds-of-test-fixtures-with-single-phpunit-run#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 10 Cool Features You Get after switching from YAML to PHP Configs ]]></title>
                <link>https://tomasvotruba.com/blog/2020/07/16/10-cool-features-you-get-after-switching-from-yaml-to-php-configs</link>
                <description><![CDATA[ <p>You've probably noticed <a href="https://github.com/symfony/symfony/issues/37186">Symfony is moving towards PHP configuration</a>. If you're on XML or YAML, you'll most likely migrate to PHP with upcoming Symfony 6.
<br>
<br>
There are already tools that <a href="https://twitter.com/VotrubaT/status/1283003111074922497">can help you migrate today</a> - <strong>so it's not a matter of work, but a matter of choice</strong>.
<br>
<br>
Today we look at 10 cool features you get by switching to PHP configs that make you an even lazier programmer.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Do you <strong>care why</strong> this begun? Be sure to read <a href="https://github.com/symfony/symfony/issues/37186">Symfony issue</a>:</p>
<blockquote class="blockquote text-center mt-5 mb-5">
    The biggest advantage is IDE auto-completion out of the box,
    <br>
    and one XML/YAML language less to learn.
</blockquote>
<p><br></p>
<p>There are the cool features I've observed from migration of <strong>50+ YAML configs to PHP</strong>:</p>
<h2 id="1-Absolute-Paths-over-Random-Paths">1. Absolute Paths over Random Paths</h2>
<p>In configs, we often define paths to files or directories. Could you tell me what exact path this is?</p>
<pre><code class="language-yaml">parameters:
    paths:
        - 'src'</code></pre>
<ul>
<li>relative to the config location?</li>
<li>absolute to <code>%kernel.projectDir%</code>?</li>
<li>absolute to <code>%cwd%</code>?</li>
<li>what will warn us if we move the config?</li>
</ul>
<p><br></p>
<p><strong>We don't know</strong>. It depends on the internal tool implementation and luck.</p>
<p><br></p>
<p>Now the same config in PHP:</p>
<img src="/assets/images/posts/2020/yaml_php_absolute_click.gif" class="img-thumbnail">
<p>Pretty clear, right?</p>
<h2 id="2-We-Can-See-Deprecated-Classes-in-PHPStorm">2. We Can See <del>Deprecated Classes</del> in PHPStorm</h2>
<p>The YAML config <strong>will not show you</strong>, if class was deprecated:</p>
<img src="/assets/images/posts/2020/yaml_php_deprecated_class_yaml.png" class="img-thumbnail">
<p>PHPStorm will <del>cross the deprecated class</del> and prepare you better for the future:</p>
<img src="/assets/images/posts/2020/yaml_php_deprecated.png" class="img-thumbnail">
<h2 id="3-Missing-Classes-in-Parameters">3. Missing Classes in Parameters</h2>
<p>In YAML, everything is a string by default, so YAML doesn't know that you mean <em>a class</em>.</p>
<p>PHPStorm shows that pretty clearly:</p>
<img src="/assets/images/posts/2020/yaml_php_missing_class.png" class="img-thumbnail">
<h2 id="4-IDE-Autocomplete-Just-Works">4. IDE Autocomplete Just Works</h2>
<p>Do you recall YAML struggle, when you want to <strong>register a service</strong>?</p>
<img src="/assets/images/posts/2018/symfony-plugin/yaml-class.gif" class="img-thumbnail">
<p><br></p>
<p>In PHP config you can <a href="/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock/">forget it</a> and just type:</p>
<img src="/assets/images/posts/2020/yaml_php_class_autocomplete.gif" class="img-thumbnail">
<p>Even with typos like &quot;Appication&quot; ;)</p>
<h2 id="5-How-was-that-calls-Syntax">5. How was that <code>calls</code> Syntax?</h2>
<p>Do you remember how to set a call on the service setup?</p>
<pre><code class="language-yaml">services:
    SomeClass:
        calls:
            # what now?</code></pre>
<p>No, don't Google it! Try from the top of your head.</p>
<p><br></p>
<p>An intuitive way would be to use the same syntax as properties/arguments:</p>
<pre><code class="language-yaml">services:
    SomeClass:
        calls:
            'setValue': [1]</code></pre>
<p>No :( then we have to Google it...</p>
<p><br></p>
<p>In PHP we <strong>can use intuitive approach</strong> and see what IDE tells us:</p>
<img src="/assets/images/posts/2020/yaml_php_calls.gif" class="img-thumbnail">
<h2 id="6-No-More-Magic-YAML-syntax-for-Constants">6. No More Magic YAML syntax for Constants</h2>
<p>In YAML everything is a string:</p>
<pre><code class="language-yaml">parameters:
    line_ending: PHP_EOL</code></pre>
<p>Is that <code>PHP_EOL</code> constant as we know it? No, it's <code>"PHP_EOL"</code> string.</p>
<p><br></p>
<p>How can we specify a <strong>string that is a constant</strong>? (Feels weird for my brain just writing this sentence.)</p>
<p><a href="https://symfony.com/blog/new-in-symfony-3-2-php-constants-in-yaml-files">Symfony 3.2 introduced special prefix</a>: <code>!php/const</code></p>
<pre><code class="language-yaml">parameters:
    line_ending: !php/const PHP_EOL</code></pre>
<p>Pretty crazy, right?</p>
<p><br></p>
<p>How does PHP solve this?</p>
<pre><code class="language-php">use  Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $parameters = $containerConfigurator-&gt;parameters();

    $parameters-&gt;set('line_ending', PHP_EOL);
};</code></pre>
<p><strong>It just works</strong>, no headache!</p>
<p><br></p>
<h2 id="7-One-Way-to-Add-Arguments">7. One Way to Add Arguments</h2>
<p>These 2 files will produce the same configuration:</p>
<pre><code class="language-yaml">services:
    SomeService:
        # silent "arguments" key is omitted
        $key: value</code></pre>
<pre><code class="language-yaml">services:
    SomeService:
        arguments:
            $key: value
            # or was it this?
            # key: value</code></pre>
<p><br></p>
<p>In PHP this is <strong>just 1 clear way</strong>:</p>
<pre><code class="language-php">use Symfony\Component\Console\Application;
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();

    $services-&gt;set(Application::class)
        -&gt;arg('key', 'value');
};</code></pre>
<p><br></p>
<h2 id="8-No-More-Magic-Tags-Without-Name">8. No More Magic Tags Without Name</h2>
<p>For tags, these 2 files produce the same output:</p>
<pre><code class="language-yaml">services:
    SomeService:
        tags:
            - kernel.event_subscriber
            # how do we extend this later?</code></pre>
<pre><code class="language-yaml">services:
    SomeService:
        tags:
            - { name: 'kernel.event_subscriber' }</code></pre>
<p>In PHP, there is just 1 way for both:</p>
<img src="/assets/images/posts/2020/yaml_php_event_tag.gif" class="img-thumbnail">
<h2 id="9-ECS-Rector-and-amp-PHPStan-watches-your-Config-Now">9. ECS, Rector &amp; PHPStan watches your Config Now</h2>
<p>This feature is my favorite by far because it finally opens the door for next-level automation.</p>
<p>YAML doesn't have any static analyzer or instant upgrade tool. This makes the upgrade of Symfony projects double the work - in PHP,  in YAML.</p>
<p>Since <code>*.php</code> is PHP code, all the powerful CI tools have access to it.</p>
<p><br></p>
<p><strong>Fewer bugs, effortless changes, less upgrade work, new PHPStan rules, more fun coding.</strong></p>
<h2 id="10-Constants-over-Strings">10. Constants over Strings 🎉</h2>
<p>Last but not least. You've probably noticed I hete typoes. I'm so used to tool watching my back, that I type much faster than my fingers can. Then I run the tools and code works (usually).</p>
<p>If you give me a choice of <code>"string"</code> or <code>CONSTANT</code>, 10 of 10 <a href="/blog/2020/05/25/the-bulletproof-event-naming-for-symfony-event-dispatcher/">I pick the <code>CONSTANT</code></a> (unless the string is <code>"really sexy and smart, verified"</code>).</p>
<p><br></p>
<p><strong>We don't have such a solid choice in YAML</strong>. If we want to use a parameter used elsewhere, we need to trust name is somehow validated (it isn't, because exception will tell you anyway).</p>
<p><br></p>
<p>For example, how do you ignore files in ECS?</p>
<pre><code class="language-yaml">parameters:
    excluded_files:
    # or
    excluded_path:
    # or
    excluded_paths:</code></pre>
<p>None of them :(. It's <code>exclude_files</code>! <strong>It's painful to look for such bugs</strong> because you need to analyze the whole project every time the config is changed.</p>
<p><br></p>
<p><strong>In PHP, we can do this</strong>:</p>
<img src="/assets/images/posts/2020/yaml_php_constants.gif" class="img-thumbnail">
<ul>
<li>Does the constant name change in the future? Rector handles it</li>
<li>Is the constant missing? PHPStan reports it</li>
</ul>
<h2 id="">🚀🚀🚀</h2>
<p><br></p>
<h2 id="Start-Today-Time-passes-Anyway">Start Today, Time passes Anyway</h2>
<p>Do you need more real-life examples to try it yourself? Learn from merged pull-requests:</p>
<ul>
<li><a href="https://github.com/bolt/core/pull/1636"><code>bolt/core</code> migration of <code>ecs.yaml</code> to <code>ecs.php</code></a></li>
<li><a href="https://github.com/TomasVotruba/tomasvotruba.com/pull/1023/commits/b302ce25e751140a71017ea6b552101b1b1e226e">the smallest migration of 1 file</a></li>
<li><a href="https://github.com/symplify/symplify/pull/2012"><code>symlify/easy-coding-standard</code> of 20 sets</a></li>
<li><a href="https://github.com/symplify/symplify/issues/61">issue that lists finished YAML to PHP migrations</a></li>
</ul>
<p><br></p>
<p>And of course, don't do it manually. Use <strong>automated tool</strong> - <a href="https://github.com/symplify/config-transformer"><code>symplify/config-transformer</code></a> - handles YAML/XML to PHP/YAML.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/07/16/10-cool-features-you-get-after-switching-from-yaml-to-php-configs</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 16 Jul 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/07/16/10-cool-features-you-get-after-switching-from-yaml-to-php-configs#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ The most Effective Test I found in 7 years of Testing ]]></title>
                <link>https://tomasvotruba.com/blog/2020/07/13/the-most-effetive-test-i-found-in-7-years-of-testing</link>
                <description><![CDATA[ <p>Do you test your projects with automated tests? If not, would you like to start?
Do you work with application, integration, functional, unit, and Selenium layers and drive you crazy? Do you spend more time writing tests than the actual code behind them?
<br><br>
I want my <strong>tests to be simple, effective, and fun to write and maintain</strong>. Today, we look at one approach used by <a href="https://github.com/php/php-src">PHP itself</a>, <code>nikic/php-parser</code>. It's so good I'm surprised not everyone is using it.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="The-Bigger-the-Scope-the-Greater-the-Teacher">The Bigger the Scope, the Greater the Teacher</h2>
<p>You can spend a year building house of your dreams. You already live in a flat, so you have a place to sleep. <strong>There is no pressure</strong>. You go there every weekend, add a window here and there, add doors, prepare holes in walls for electric heating cables... good 2-4 years.</p>
<p>How would the situation change if you'd build houses as a developer (the building one)? Your job is to build 100 flats per year. You can't fool around with the color of the walls inside each room. <strong>You have to be effective.</strong></p>
<p><br></p>
<p>The first case of building one house for a year - you only work on 1 PHP project at once. It's only <strong>natural to try-out all the testing layers</strong> you can Google. There are a couple of tests that test the product checkout process, a couple of integration tests to check the component is rendered correctly, <a href="/blog/2018/06/11/how-to-turn-mocks-from-nightmare-to-solid-kiss-tests/">mocking</a> to &quot;decouple&quot; one part from another.</p>
<p>Every month I work with ~5 private projects, and I maintain <a href="https://packagist.org/profile/?page=3">35 open-sources packages</a>. I used to have very complicated tests for all possible application parts, but that turned out to take more time to maintain to develop, and it <strong>slowed down my productivity brutally the more tests I had</strong>.</p>
<p><br></p>
<h2 id="How-do-PHP-core-test-cases-Look-Like">How do PHP-core test cases Look Like?</h2>
<p>Let's look at the PHP test <a href="https://github.com/php/php-src/blob/master/tests/basic/001.phpt">with name 001</a>.
Give it 60 seconds:</p>
<pre><code class="language-bash">--TEST--
Trivial "Hello World" test
--FILE--
&lt;?php echo "Hello World"?&gt;
--EXPECT--
Hello World</code></pre>
<p>Do you need a PHP-core developer to explain the whole testing process? You don't; you get it.</p>
<p>When we call:</p>
<pre><code class="language-php">&lt;?php echo "Hello World"?&gt;</code></pre>
<p>We get the output:</p>
<pre><code class="language-bash">Hello World</code></pre>
<p>The 1st line is just a description, useful for a more complicated case.</p>
<h2 id="Testing-at-its-Best">Testing at its Best</h2>
<ul>
<li>you <strong>don't need a package maintainer to explain you what the test does</strong></li>
<li>you <strong>don't have to read a book about testing</strong> to be able to contribute</li>
<li>you can edit it, and you can extend it</li>
<li>you can learn with growing complexity by yourself</li>
</ul>
<p>It's like a smartphone or door handle in testing.</p>
<p>This kind of testing gives you confidence, and that's by far the most important feeling that <a href="/blog/2020/03/02/we-do-not-need-senior-developers-we-need-senior-code-bases/">builds senior code bases</a>.</p>
<h2 id="Domain-Driven-Testing">Domain Driven Testing</h2>
<p>You're probably thinking, &quot;but how do I apply this to my unique startup that does not compare strings&quot;? Of course, there is a place for the complex test that checks your checkout process work. The goal <strong>is not to narrow all your tests to 1 size</strong> to fit em all.</p>
<p>The goal is to find what startup is different from other projects. Is your specialty to build e-commerce websites, or is it a recommendation of the next best product? Is it an instant delivery of warm food or a reliable video conference for massive numbers of users?</p>
<h2 id="Find-Your-Domain">Find Your Domain</h2>
<p><strong>Find your domain</strong>, because in this domain will be placed 80 % of your tests. If you pick the right domain and make these tests simple, effective, and fun to write and maintain, your developers will enjoy writing them, and your code will naturally grow.</p>
<p><br></p>
<p>Let's look at the projects you know:</p>
<ul>
<li>PHP
<ul>
<li><strong>main domain</strong>: running PHP input code with correct output to the user</li>
<li>side domain: validation of input, syntax check, informative errors</li>
</ul></li>
<li>php-parser
<ul>
<li><strong>main domain</strong>: parsing PHP input code to desired node objects</li>
<li>side domain: printing nodes back, comments handling</li>
</ul></li>
<li>Rector
<ul>
<li><strong>main domain</strong>: refactoring input code to the desired change</li>
<li>side domain: working with docblocks and types, format-preserving</li>
</ul></li>
</ul>
<h2 id="Code-Time">Code Time</h2>
<p>Enough theory, let's do the practice.</p>
<p>We have a fixture file with your domain, <code>/fixture/first_try.php</code>:</p>
<pre><code class="language-bash">input
-----
expected output</code></pre>
<p>Then we need to run Test Case:</p>
<pre><code class="language-php">&lt;?php

use PHPUnit\Framework\TestCase;

final class FirstTryTest extends TestCase
{
    public function test(): void
    {
        $fixtureContent = file_get_contents(__DIR__ . '/fixture/first_try.php');
        [$input, $expectedOutput] = explode("\n-----\n", $fixtureContent);

        // test your main domain service
        $output = $this-&gt;processInputInYourDomain($input);

        $this-&gt;assertSame($expectedOutput, $output);
    }
}</code></pre>
<p>And that's it :) See <a href="https://3v4l.org/sEudR">3v4l.org code sample</a>.</p>
<p><br></p>
<h2 id="Few-Tips-before-Start">Few Tips before Start</h2>
<ul>
<li>it's all at one place - no file jumping and looking for the right file</li>
</ul>
<pre><code class="language-diff">-/tests/fixture/before/input_string.php
-/tests/fixture/after/some_string_print.php
+/tests/fixture/change_string.php</code></pre>
<ul>
<li>the file name is the description</li>
<li><strong>it scales</strong> - you can build a test that combines multiple problems at once, and still get the same input/output format</li>
<li>you can also <strong>combine formats</strong> in one fixture, e.g., for <a href="https://github.com/symplify/config-transformer/blob/a2a087d1ea759c394fe4e93c5d0d4828a46c5c26/tests/Converter/ConfigFormatConverter/YamlToPhp/Fixture/normal/services_default_private.yaml">migration of Symfony configs from YAML to PHP</a>.</li>
</ul>
<p><br></p>
<h2 id="What-If-Output-Changes">What If Output Changes?</h2>
<p>&quot;But what happens when we add a new property to the output? Do we have to change all the files manually? That's crazy.&quot;</p>
<p>It would be crazy. I tried to update 60 files in php-parser when I only added typed properties... oh, that was too much work. At file 50, I figured out there is an automated way exactly my case. We will look at how we can <strong>turn these tests into snapshot tests that update themselves</strong> <a href="/blog/2020/07/20/how-to-update-hundreds-of-test-fixtures-with-single-phpunit-run/">in the next post</a>.</p>
<p><br></p>
<p>PS.: Do you want to automate part with loading and splitting fixture? Checkout <a href="https://github.com/symplify/easy-testing">symplify/easy-testing</a> package.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/07/13/the-most-effetive-test-i-found-in-7-years-of-testing</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 13 Jul 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/07/13/the-most-effetive-test-i-found-in-7-years-of-testing#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Cleaning Lady Notes: From Class Mess to PSR-4 Step by Step With Confidence ]]></title>
                <link>https://tomasvotruba.com/blog/2020/07/06/cleaning-lady-notes-from-class-mess-to-psr4-step-by-step-with-confidence</link>
                <description><![CDATA[ <p>Today I'm starting a new post series - <em>Cleaning Notes</em>. These posts are for people who are <a href="/blog/2020/06/29/how-will-programming-look-like-in-2025/">aspiring legacy migrators</a> with a vision to improve private PHP ecosystem and bring joy to coding with gigantic applications again. The same vision we have in the Rector team.
<br><br>
In this series, you can learn about my experience, tricks, tips, and what fucked me up. So you <strong>save some frustration, where is not needed, discover hidden shortcuts and cool tools you never saw before</strong>.
<br><br>
We start with the most problematic topic in PHP legacy, that every project needs, but almost none has - <strong>transition to <a href="https://www.php-fig.org/psr/psr-4">PSR-4</a></strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p><em>Dedicated to <a href="https://github.com/Kerrialn">Kerrial</a>, my great friend who teaches me so much about not giving a f_ck and just do the stuff.<br>Thanks, dude!</em></p>
<p><br></p>
<h2 id="How-to-Approach-the-Migration-Itself">How to Approach the Migration Itself?</h2>
<h3 id="Know-Your-Enemy">Know Your Enemy</h3>
<p>There are many use cases that we have to handle to get to PSR-4. Honestly, I find it easier to <a href="/blog/2019/08/26/how-we-migrated-54-357-lines-of-code-nette-to-symfony-in-2-people-under-80-hours/">switch a framework</a>, where start is clear and goal is clear.</p>
<p>In PSR-4 migration, we have a clear goal:</p>
<ul>
<li>PSR-4: in 1 file, there is 1 class/trait/interface</li>
<li>the class/trait/interface has a unique fully qualified name, that reflects file location</li>
<li>nothing else exists</li>
</ul>
<h3 id="Start-has-Many-Ugly-Forms">Start has Many Ugly Forms</h3>
<ul>
<li><strong>in 1 file, there is a dozen classes</strong> - very popular for exceptions or test fixtures</li>
<li>some classes have <strong>identical name</strong> and custom class loader gives one or the other preference (e.g., Magento and Drupal use this in some version)</li>
<li>there are classes without any namespace</li>
<li>there are classes with <code>Fake_Namespace</code></li>
<li>file has a different name than the class, e.g. <code>random_file.php</code> with <code>class SomeClass {}</code> in it</li>
<li>in 1 file, there are classes and functions, so the file has to be manually included to &quot;autoload&quot; the functions</li>
<li>there are conditional classes, e.g.</li>
</ul>
<pre><code class="language-php">if (! class_exists('SomeClass')) {
    final class SomeClass
    {
        // ...
    }
}</code></pre>
<p>A lot to suck in, right? Don't worry; each of them has a guide to follow.</p>
<h3 id="Low-Hanging-Fruit">Low Hanging Fruit</h3>
<p>Each project is different, some of them has <a href="/blog/2020/04/13/how-to-migrate-spaghetti-to-304-symfony-5-controllers-over-weekend/">functions mixed with HTML</a>, some is missing composer completely, some needs to <a href="/blog/2020/06/08/drop-robot-loader-and-let-composer-deal-with-autoloading/">switch from custom-framework autoloading</a>.</p>
<p>But you should always apply basic rule:</p>
<blockquote class="blockquote text-center mt-5 mb-5">
    "Take the low hanging fruit first."
</blockquote>
<p>Always <strong>go for a simple target first</strong>. Don't be a hero. A hero falls from the sky after a massive battle over Atlantic, forgot to charge his smartphone... and dies alone.</p>
<p><strong>Be professional, close quickly, close early</strong>. Are there 3 files with 20 classes in them?</p>
<ul>
<li>split them to 20 classes</li>
<li>don't deal with namespaces, don't care about file naming</li>
<li>create pull-request</li>
<li>merge it</li>
</ul>
<p>✅</p>
<p>Done. You've just made a first small step. Cross one step of your list, 9/10 is left.
But all those 9 steps are now 10 % less complicated.</p>
<blockquote class="blockquote text-center mt-5 mb-5">
    "Even if you die, the code you wrote is merged."
    <footer class="blockquote-footer text-center">Bus Boy Scout Factor</footer>
</blockquote>
<p>I love this coding principle. Why? Because it takes minimalism and productivity to the practical world. It narrows our focus, so any developer becomes a 10x programmer effortlessly.</p>
<p><br></p>
<h2 id="What-Exactly-to-Do-Case-Study">What Exactly to Do? - Case Study</h2>
<p>Enough theory. <strong>Let's look at the project we've recently migrate to PSR-4 and how exactly we did it</strong>.</p>
<p>This is not paid promo, but <a href="https://www.startupjobs.cz/en/startup/scrumworks-s-r-o">Amateri are hiriging</a>. We're far enough with the migration, so I'm confident it would be fun to work with such codebase.</p>
<h2 id="1-Split-Multiple-Classes-in-1-File">1. Split Multiple Classes in 1 File</h2>
<p>How does it look?</p>
<pre><code class="language-diff"> // SomeFile.php
 class SomeClass
 {
 }

 class AnotherClass
 {
 }</code></pre>
<pre><code class="language-diff">+// AnotherClass.php
+class AnotherClass
+{
+}</code></pre>
<p><br></p>
<p>The <strong>1st cool tool</strong> we look at today is <a href="https://github.com/symplify/easy-ci">symplify/easy-ci</a>.
It doesn't need projects' autoloader so that it can be installed outside the project, e.g., in <code>/var/www/tools</code>, while your project is in <code>/var/www/old_project</code>.</p>
<p>Install it:</p>
<pre><code class="language-bash">composer require symplify/easy-ci --dev</code></pre>
<p>It would be great to have a list of all such multi-class files, right?</p>
<pre><code class="language-bash">vendor/bin/easy-ci find-multi-classes /src</code></pre>
<p>↓</p>
<pre><code class="language-bash">* SomeFile.php
    * SomeClass
    * AnotherClass</code></pre>
<p>Now we know how big a problem we're dealing with.</p>
<ul>
<li>Are there 3 files with 20 classes? <strong>Separate them manually</strong>.</li>
<li>Is that 50 files with 300 classes? Use <strong>Rector rule</strong> - <a href="https://github.com/rectorphp/rector/blob/main/docs/rector_rules_overview.md#multipleclassfiletopsr4classesrector"><code>MultipleClassFileToPsr4ClassesRector</code></a>.</li>
</ul>
<p>Now 1 file has exactly 1 class/interface/trait.</p>
<p>Send pull request, make sure your project's autoloader autoloads them, and tests are passing. Merge it, and you're done.</p>
<h2 id="2-Check-Class-Short-name-vs-Filename">2. Check Class Short name vs. Filename</h2>
<pre><code class="language-diff"> // Cucumber.php
-class Car
+class Cucumber
 {
 }</code></pre>
<p>If we only knew how many such files are there and where... back to Easy CI:</p>
<pre><code class="language-bash">vendor/bin/easy-ci check-file-class-name src</code></pre>
<p>You will get a list of files that don't match. Use PHPStorm refactoring to change the class name everywhere:</p>
<img src="/assets/images/posts/2020/psr4_rename_class.gif" class="img-thumbnail">
<p>Commit, PR, CI passes, merge.</p>
<p>✅</p>
<h2 id="3-Upper-case-Directories-First-Letter">3. Upper-case Directories First Letter</h2>
<p>In PSR-4, any non-root directory must start with the first big letter. Root is e.g. <code>/app</code>, <code>/src</code>.</p>
<pre><code class="language-diff">-/app/form/someForm
+/app/Form/SomeForm</code></pre>
<p>Go through directory in the left panel in PHPStorm and rename the directories there:</p>
<img src="/assets/images/posts/2020/psr4_rename_dirs.gif" class="img-thumbnail">
<p>Commit, PR, CI passes, merge.</p>
<p>✅</p>
<h2 id="4-Check-PSR-4-root">4. Check PSR-4 root</h2>
<p>We've done 3 steps so far. Now comes the biggest one, actually adding PSR-4 roots to <code>composer.json</code>.</p>
<p>It will not be as pretty as 1 root line, but that's not what we go here now. Our goal is <strong>to have all classes loaded with PSR-4, no matter how many lines</strong> in <code>composer.json</code> does it need.</p>
<pre><code class="language-json">{
    "autoload": {
        "psr-4": {
            "Amateri\\Payment\\": "src/somewhere-else/Payment",
            "Amateri\\Delivery\\": "src/another-dir/Delivery"
        }
    }
}</code></pre>
<p>We can guess what namespace roots (<code>"Amateri\\Payment\\"</code>) should be loaded from which directory (<code>"src/somewhere-else/Payment"</code>)... or we can use science!</p>
<pre><code class="language-bash">vendor/bin/easy-ci generate-psr4-paths project/src --composer-json project/composer.json</code></pre>
<p>The command will generate such paths for us, based on existing namespaces and file locations.
There may be over 10 or even 50 of those. <strong>Don't worry about it now</strong>.</p>
<ul>
<li>put generated output to <code>composer.json</code> instead of <code>classmap</code>,</li>
<li>run <code>composer dump-autoload</code> to let composer know about news paths</li>
<li>run PHPStan to see if all classes are loaded</li>
</ul>
<p>If everything passes... Commit, PR, CI passes, merge.</p>
<p>✅</p>
<h2 id="5-Narrow-the-Namespace-Root-and-Directories-in-composer-json">5. Narrow the Namespace Root and Directories in <code>composer.json</code></h2>
<p>Now comes my favorite part. Here we move all directories <strong>to use as little namespace root as possible</strong>.</p>
<p>It might be a little bit unclear, but give it time and it will fit in. Let's look at the example:</p>
<pre><code class="language-diff"> {
     "autoload": {
         "psr-4": {
-            "Amateri\\Payment\\": "src/somewhere-else/Payment",
-            "Amateri\\Delivery\\": "src/another-dir/Delivery",
+            "Amateri\\": "src"
        }
    }
}</code></pre>
<p>What happens with files?</p>
<pre><code class="language-diff">-src/somewhere-else/Payment
+src/Payment</code></pre>
<pre><code class="language-diff">-src/another-dir/Delivery
+src/Delivery</code></pre>
<p>Here use PHPStorm refactoring on the directory as in step 3.</p>
<ul>
<li>run <code>composer dump-autoload</code> to let composer know about news paths</li>
<li>run PHPStan to see if all classes are loaded</li>
</ul>
<p>If everything passes... Commit, PR, CI passes, merge.</p>
<p>✅</p>
<h2 id="6-What-if-there-are-No-Namespaces-or-Are-Very-Very-Bad">6. What if there are No Namespaces or Are Very Very Bad?</h2>
<p><div class="card ml-4 mt-4 border-warning float-right post-snippet" style="width: 14em">
    <div class="card-body">
        Would you like to <strong>learn more about Rector</strong>? Step by step, from zero to hero?
        <br>

        <div class="text-center">
            <a href="/book/the-power-of-automated-refactoring/">
                <img src="/assets/images/rector_book.png" class="mb-3 mt-3 shadow">
                Get our new book
            </a>
        </div>
    </div>
</div>
</p>
<p>In many code bases, there are just random files—no namespace, no fake namespace, etc.</p>
<p>For these, we have help of Rector with these 2 rules:</p>
<ul>
<li><a href="https://github.com/rectorphp/rector/blob/main/docs/rector_rules_overview.md#normalizenamespacebypsr4composerautoloadfilesystemrector"><code>NormalizeNamespaceByPSR4ComposerAutoloadRector</code></a></li>
<li><a href="https://github.com/rectorphp/rector/blob/main/docs/rector_rules_overview.md#normalizenamespacebypsr4composerautoloadrector"><code>NormalizeNamespaceByPSR4ComposerAutoloadFileSystemRector</code></a></li>
</ul>
<p><br></p>
<p>Register them in <code>rector.php</code>:</p>
<pre><code class="language-php">use Rector\PSR4\Rector\FileSystem\NormalizeNamespaceByPSR4ComposerAutoloadFileSystemRector;
use Rector\PSR4\Rector\Namespace_\NormalizeNamespaceByPSR4ComposerAutoloadRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;rule(NormalizeNamespaceByPSR4ComposerAutoloadRector::class);
    $rectorConfig-&gt;rule(NormalizeNamespaceByPSR4ComposerAutoloadFileSystemRector::class);
};</code></pre>
<p>And <strong>manually add the desired namespace</strong> to your <code>composer.json</code>:</p>
<pre><code class="language-diff"> {
+   "autoload": {
+        "psr-4": {
+            "Amateri\\": "src"
+        }
+    }
 }</code></pre>
<p>When you run the Rector, it will try to autocomplete all the namespaces to respect your <code>composer.json</code>:</p>
<pre><code class="language-bash">vendor/bin/rector p src</code></pre>
<p>This is one of <strong>the most significant changes in your application</strong>, so <strong>be sure to check it carefully</strong>. Not all cases are covered by Rector yet.</p>
<ul>
<li>run <code>composer dump-autoload</code> to let composer know about news paths</li>
<li>run PHPStan to see if all classes are loaded</li>
</ul>
<p>If everything passes... Commit, PR, CI passes, merge.</p>
<p>✅</p>
<p><br></p>
<p>Then we added few manual tweaks here and there, and we were PSR-4 compliant with ~7 lines in PSR-4 in <code>composer.json</code>.</p>
<p><br></p>
<p><strong>Have you found a case that is not covered or a better way to this</strong>? Let me know in the comments.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/07/06/cleaning-lady-notes-from-class-mess-to-psr4-step-by-step-with-confidence</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 06 Jul 2020 00:00:00 +0000</pubDate>
                                    <updated>2020-08-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Aug 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Aug 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/07/06/cleaning-lady-notes-from-class-mess-to-psr4-step-by-step-with-confidence#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Patch a Package in Vendor, Yet Allow its Updates ]]></title>
                <link>https://tomasvotruba.com/blog/2020/07/02/how-to-patch-package-in-vendor-yet-allow-its-updates</link>
                <description><![CDATA[ <p>While working with legacy code upgrades, we often need to fix a line or two in 3rd party package in <code>/vendor</code>.
<br>
<br>
You can fork it, but by that, you <strong>take manual responsibility</strong> for all the package updates.
You can copy a package locally, which is faster, but <strong>disables package updates</strong>.
<br><br>
Or... you can use &quot;composer patches&quot;?</p> ]]></description>
                <content:encoded><![CDATA[ <p>I'm currently working on one Nette project as <a href="/blog/2020/04/27/forget-complex-migrations-use-cleaning-lady-checklist/">a cleaning lady</a>. After making code nice &amp; shiny clean, we'll move from Nette 2.4 to Nette 3.0. During the cleaning process, we got into one delicate issue I'd love to share with you.</p>
<p><br></p>
<p>We used <a href="/blog/2020/06/01/inject-or-required-will-get-you-any-service-fast/">inject properties</a>:</p>
<pre><code class="language-php">&lt;?php

abstract class AbstactSomePresenter
{
    /**
     * @inject
     * @var SomeDependency
     */
    public $someDependency;
}</code></pre>
<p>But since PHP 7.4, we could drop the <code>@var</code> annotation:</p>
<pre><code class="language-php">&lt;?php

abstract class AbstactSomePresenter
{
    /**
     * @inject
     */
    public SomeDependency $someDependency;
}</code></pre>
<p>But... this doesn't work in Nette 2.4. Aww.</p>
<p><br></p>
<p>We tried to add this feature by replacing native <code>InjectExtension</code> with our own. But native extension <strong>is statically hardcoded</strong>, so there was no way to replace it.</p>
<p><strong>What else we can do?</strong> We looked at GitHub for a commit that added this feature somewhere between Nette 2.4 and 3.0 (with git blame GitHub feature and look at specific lines).</p>
<p><strong>We were lucky.</strong> It was <a href="https://github.com/nette/di/commit/24df5e6af0ecf18542dc6e721112598bc648082c#diff-e7f245a9be21411c36d839ed85a17457"><strong>just 2 lines</strong></a> that added this feature!</p>
<h2 id="How-to-Change-2-Lines-of-code-in-vendor">How to Change 2 Lines of code in <code>/vendor</code>?</h2>
<p>We needed the same commit in our codebase with Nette 2.4.</p>
<p><strong>How can we do that?</strong></p>
<ul>
<li>edit file in <code>/vendor/nette/di/*</code> manually</li>
<li>fork the package at version 2.4, edit it, release it, maintain it</li>
</ul>
<p>❌</p>
<p>These options are slow or will keep the code changed only on your local machine = your <code>composer install</code> would suck a long time.</p>
<p><br></p>
<p>Is there some automated way with all the benefits and almost zero maintenance?</p>
<ul>
<li><a href="https://github.com/cweagans/composer-patches">composer patches</a></li>
</ul>
<p>✅</p>
<h2 id="Patching-For-Dummies">Patching For Dummies</h2>
<p>Idea behind <a href="https://github.com/cweagans/composer-patches">composer patches</a> is great, but the user experience with making the patch not so much. It's classic pixel coding - you have to edit the patch file the one slash or dot char. If you do it wrong, or the whole process collides with &quot;fatal error&quot;. That's why there is <a href="https://pehapkari.cz/blog/2017/01/20/jak-snadno-a-rychle-upravovat-soubory-ve-vendoru">over 10 comments under Czech post by Tomas Pilar</a>, asking about the pixel coding.</p>
<p>I don't want developers to be frustrated over pixel coding. I want developers to play and explore their abilities to their limits.</p>
<p>We made a Symplify package that adds UX layer <strong>that handles the tedious maintenance for you</strong>.</p>
<h2 id="4-Steps-to-Generate-Your-First-Patch">4 Steps to Generate Your First Patch</h2>
<h3 id="1-Install-Packages">1. Install Packages</h3>
<pre><code class="language-bash">composer require cweagans/composer-patches symplify/vendor-patches --dev</code></pre>
<h3 id="2-Create-a-Copy-of-vendor-file-you-Want-To-Change-with-old-Suffix">2. Create a Copy of <code>/vendor</code> file you Want To Change with <code>*.old</code> Suffix</h3>
<p>For example, if you edit:</p>
<pre><code class="language-bash">vendor/nette/di/src/DI/Extensions/InjectExtension.php</code></pre>
<p>The copied file would be:</p>
<pre><code class="language-bash">vendor/nette/di/src/DI/Extensions/InjectExtension.php.old</code></pre>
<h3 id="3-Open-the-Original-file-and-Change-it">3. Open the Original file and Change it</h3>
<pre><code class="language-diff">         if (DI\Helpers::parseAnnotation($rp, 'inject') !== null) {
-           if ($type = DI\Helpers::parseAnnotation($rp, 'var')) {
+           if ($type = \Amateri\Reflection\Helper\StaticReflectionHelper::getPropertyType($rp)) {
+           } elseif ($type = DI\Helpers::parseAnnotation($rp, 'var')) {
               $type = Reflection::expandClassName($type, Reflection::getPropertyDeclaringClass($rp));</code></pre>
<p>Only <code>*.php</code> file is loaded, not the <code>*.php.old</code> one. This way, you can <strong>be sure the new code</strong> is working before you generate patches.</p>
<h3 id="4-Run-generate-command-to-Create-Patch-File-and-Register-it">4. Run <code>generate</code> command to Create Patch File and Register it</h3>
<pre><code class="language-bash">vendor/bin/vendor-patches generate</code></pre>
<p>The Symplify tool will generate patch files for all files created this way in <code>/patches</code> directory:</p>
<pre><code class="language-bash">/patches/nette-di-di-extensions-injectextension.php.patch</code></pre>
<p>The patch path is created from the original file path, so <strong>the patch name is always unique</strong>.</p>
<p>Also, the configuration for <code>cweagans/composer-patches</code> is added your <code>composer.json</code>:</p>
<pre><code class="language-json">{
    "extra": {
        "patches": {
            "nette/di": [
                "patches/nette_di_di_extensions_injectextension.patch"
            ]
        }
    }
}</code></pre>
<p>That's it!</p>
<p><br></p>
<p>Now all you need to do is run composer:</p>
<pre><code class="language-bash">composer install</code></pre>
<p>And your patches are applied to your code!</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/07/02/how-to-patch-package-in-vendor-yet-allow-its-updates</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 02 Jul 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/07/02/how-to-patch-package-in-vendor-yet-allow-its-updates#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How Will Programming look like in 2025? ]]></title>
                <link>https://tomasvotruba.com/blog/2020/06/29/how-will-programming-look-like-in-2025</link>
                <description><![CDATA[ <p>We often read about best practices in coding, what framework has new features, or what is new in PHP X. How one can change this to that, why is this technique good or bad, or what new package you can download to your project.
<br>
That's only past or present.
<br>
<br>
I'm just finishing the reading of <a href="https://www.amazon.com/The-Inevitable-Kevin-Kelly-audiobook/dp/B01EB3OR32">The Inevitable</a>, written by Wired magazine founder, that focuses solely on the future. Inspired by this book, today, <strong>we look at the future of programming</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Today we fight with technical debt, whatever that means, old legacy code that is hard to maintain, expensive to change, but also the biggest power that generates money. We should upgrade code, integrate DDD, write tests, upgrade PHP to secure it, update the server, and automate the deploy.</p>
<p>So much daunting work and we didn't even look at those other dozens of projects our company maintains... or at least stores on our servers, somewhere. We need to hire an expert that helps us to improve each piece just a little. Not because they're not good, just because there are too many technologies we can use and even more code we have to maintain.</p>
<p><strong>But what the future holds?</strong></p>
<h2 id="IDE-meets-AI">IDE meets AI</h2>
<p>In the future, the typing code will become easier. Our IDE will be super-powered by AI, which learns on anonymous data of other PHP projects and from all the open-source projects on Github and Gitlab.</p>
<p>Thanks to this AI, we'll start typing &quot;class HomepageC...&quot; It will know we're creating a controller. It will know we're using Symfony from <code>composer.json</code>, what version do we use and will suggest to autocomplete the rest of the code with <code>final</code> and strict types based on used PHP version also from <code>composer.json</code>. It will generate a template with the templating system we use and mimic the bare content found on other templates our project already has.</p>
<p>Thanks to the massive amount of anonymous data and data from public repositories, the AI will know the best practice about testing the controller to generate the controller test.</p>
<h2 id="Best-Verified-Practise"><del>Best</del> Verified Practise</h2>
<p>When we say &quot;best practice&quot;, we don't mean what I or somebody else wrote in a post or book based on a few personal experiences. These opinions are often based only on coupled of projects and the single opinionated human mind with feelings.</p>
<p>Best Practise will shift to Verified Practise, based on real data related to 2 hard metrics - <em>technical debt</em> and <em>coding effectivity</em>. <strong>Technical debt</strong> will be financial that shows how much each line of code will cost in the future. Do you write fluent static code without classes with types? The line might show 10 $. Do you write final classes with types and one public method? The line might show 2 $.</p>
<p>These numbers will not be random, but based on the continual colossal amount of big data analysis - still anonymous - from all the private projects that want to use this feature. The code will be compared to money expenses that were needed to maintain and improve the code. Thanks to this feedback, the AI will also know what version is cheaper for your specific project.</p>
<p>It will know about the context of your project and compare the data accordingly. Do you have a CLI project? It will be compared to the code of other CLI projects in the field. Do you write a website? It will be compared rather to website projects.</p>
<p><strong>Coding effectivity</strong> will be metric for the maintainability of the project. It will be measured from 0 to 100, as in 0 - code, that takes many hours to understand, even maybe days or weeks to change. A code with a score of 100 will be easy to understand to junior, and he or she can change the code almost instantly.</p>
<h2 id="IDE-Verified-Auto-Suggest">IDE Verified Auto Suggest</h2>
<p>The IDE will be aware of these metrics and will follow patterns in your code. When you start writing a piece of code that has coding effectivity 40-50, it will pop-up with the suggestion of code with the same result of effectivity 80-90. It will do the same job as Rector or PHPStan does today.</p>
<p>The performance will also be included, along with coding effectivity. The code performance will be automatically measured on every change in the background Docker container, and you'll be informed about any memory or time leaks. <strong>It will be so precise that it will mark a specific line and character that caused the leak</strong> and suggest fixing that you may accept.</p>
<h2 id="AST-Refactoring">AST Refactoring</h2>
<p>Refactoring will also be more powerful than today. It will be based on abstract-syntax-tree and will suggest the best refactoring you do right now based on anonymous data from all the public and private projects available.</p>
<p>Instead of &quot;best practice&quot; subjective claims, you will know that:</p>
<ul>
<li>solution A will cost you 3 $ per line in technical debt, will be 95 in effectiveness and 45 in performance</li>
<li>solution B will cost you 1 $ per line of technical debt, and the effectiveness will be 70 and performance 50</li>
</ul>
<p>Do you build a startup and want to verify your idea? You'll pick A. Is your company stable, and does it need to be robust in the future? Go for slower-growing yet more stable B.</p>
<p><strong>You'll not have to argue with your colleague</strong> or with your boss why you should use this or this solution. You <strong>compare the numbers</strong> and then decide based on your priorities at that moment.</p>
<h2 id="Context-Aware-Architecture">Context-Aware Architecture</h2>
<p>Your code will have context architecture. The AI will know when is the best to transit between contexts, based on data from other projects and their final costs of the transition. Do you bootstrap in WordPress? That's ok. Does your project become more popular, and you need to transition to another PHP framework that will handle your needs better? <strong>IDE will suggest you migrate to Laravel. One-click, and it's done.</strong></p>
<p>Three years later, your project is growing, and you have a lot of manual integration of 3rd party services that are already native in the Symfony framework. IDE will suggest you migrate... click... and boom, you're on Symfony 9. Do you find out there are <strong>not enough Symfony developers in the market</strong> to keep up with development? 1-click and IDE will migrate to a framework that has enough developers at a reasonable price.</p>
<h2 id="Versioned-StackOverflow-Answers">Versioned StackOverflow Answers</h2>
<p>IDE will look over your code and follow your coding habits. Do you usually write your feature in 15 minutes, but this one takes almost 2 hours now? In the following years, it will be that good that notices even a slight decrease in typing speed in a matter of seconds.</p>
<p>The IDE will then check your code, scan through StackOverflow answers, <strong>matches the answer that has the same version as your <code>composer.lock</code></strong> and suggest to use this piece of code as the most valued answer.</p>
<p>Do you worry this piece of code is just copy-pasted random code and <strong>will break your project</strong>? The answer rank is not based on human voting anymore, but on actually click-rate when it was successfully used and merged into the project code.</p>
<h3 id="Tested-Code-Snippets">Tested Code Snippets</h3>
<p>Also, the code snippets are tested by StackOverflow daily and also before copy-pasting to your project. With exactly your version of your local environment, so you can be sure the code works. Humans do not version these answers as in the past. <strong>Code in the answer is upgraded on every release of the technology it uses</strong>. Is there an answer for Symfony 5, and then the Symfony 6 will be released? The old code is upgraded with the AST recipe that was released with Symfony 6 and published as a new answer. That way, both human and IDE can work with it.</p>
<h2 id="Open-Source-Funding-by-Activity">Open-Source Funding by Activity</h2>
<p>A new project that will connect companies and open-source contributors will be created. The open-source project will be funded by companies that use it. The developers who contribute will be funded by a unified system, based on incoming finances, without fee to cover the system expenses.</p>
<p><strong>Developers will be funded by their contribution that will be measured by AI-fined metrics</strong> that will include the impact of the feature, amount of work, invested time, code effectiveness, etc. This way, the code will be developed much more consistently than on the free time of individual contributors.</p>
<p><strong>An open-source developer will become a new full-time position</strong> funded by this project.</p>
<p>What do these companies get in reward? Promotion in the particular community, pre-release automated upgrade sets, and on-demand access to expert consultants who wrote the open-source projects they use.</p>
<h2 id="Framework-Consolidation">Framework Consolidation</h2>
<p>~10 PHP frameworks we have now will be consolidated by the market to lower numbers. PHP communities will learn how to co-operate more, instead of working almost identical MVC copies.</p>
<p><strong>Thanks to AST-migrations it will be possible to switch from any to any other PHP framework</strong>. This will allow us to <strong>narrow the market to 3-4 frameworks</strong>. If the framework migration is a matter of 1 click in your IDE, then there will be no competition based on history and long tail effect of dinosaurs, <strong>but only on quality</strong>.</p>
<p>Reduction of frameworks will lead to <strong>framework profiling</strong> - one framework will excel in API, the other in CLI, another in UX websites.</p>
<p>When the whole PHP community focuses on a lower number of frameworks, it will <strong>allow us to invest the saved energy to developing new technologies and new features</strong>.</p>
<h2 id="No-Legacy-PHP-just-1-Version">No Legacy PHP, just 1 Version</h2>
<p>Thanks to automated AST migrations, there will be <strong>only two versions of the PHP</strong> - stable and dev. As the upgrade of any package or project will become as fast and cheap as one click, there is no reason not to upgrade to the latest version. It might take PHP community a year or two to synchronize on this. But when it does, <strong>the new PHP will be released at the end of November</strong>, and at the end of December whole PHP open-source ecosystem <strong>will be using it as minimal version.</strong></p>
<h2 id="Fully-Automated-Instant-Upgrades">Fully Automated Instant Upgrades</h2>
<p>The PHP code won't have to be upgraded manually. Each PHP version will have fully upgrade AST-based recipe that anyone can use to upgrade the code automatically. GitHub will handle these recipes, so when a new PHP version is released, GitHub will automatically send a pull-request to your repository. <strong>Automated upgrades will not be just for PHP, but for any framework or package. Like Dependabot, we know now, but upgrading the code and solving all the BC breaks for you</strong>.</p>
<h3 id="GitHub-Upgrader">GitHub-Upgrader</h3>
<p>If you don't want to click on all the merges yourself, <strong>you can enroll in <em>automated upgrades</em> program so that GitHub will handle it for you</strong>. It will also handle the releases and handle semver the proper way.</p>
<h3 id="Semver-Automated">Semver Automated</h3>
<p><strong>There will be no arguments about if this is BC break of just a patch</strong>, as it will be handled by AI that will analyze the code before and after and decide based on that. It will be that smart, that it will detect how significant impact the BC break has. <strong>If it would not affect any code, it will be released as a patch.</strong></p>
<h2 id="Experience-based-PHP-RFC">Experience-based PHP RFC</h2>
<p>The same BC break analysis will be possible for any RFC in PHP core code. Do you want to suggest typed constants? The AI will tell you how many projects from the top 10 000 on Github would break in decimal percent. Something similar is now done manually in a couple of RFCs.</p>
<h3 id="and-quot-BC-Break-and-quot-Redefined">&quot;BC Break&quot; Redefined</h3>
<p>The AI will also help you to generate migration AST recipes, so the instant upgrade can entirely handle the BC break. That would lead to a redefinition of &quot;BC break&quot; as we know it today. The BC break would only occur when automated upgrade cannot happen, and a human is needed to change the code.</p>
<h3 id="Try-RFC-Locally">Try RFC Locally</h3>
<p>Also, anyone can try the RFC feature locally right when the GitHub pull-request is created. How? The Github will automatically create a temporary release with a special dev-tag and push the PHP version to the package registry. You create a pull-request to add typed constants, send it on GitHub, and in 1 minute, you can run <code>sudo apt-get install php-dev-typed-constant</code> to get the PHP to your local machine.</p>
<p>This way, people will be able to try the feature before the merge and even before RFC voting. That way, even voting on features will be <strong>based on real data and experience</strong>, instead of emotions, opinions, and arguments.</p>
<p><br></p>
<h2 id="What-the-Future-Holds">What the Future Holds?</h2>
<p>In the future, our options will not be limited by our history, past choices, or fast-evolving technology that makes our code deprecated. Our options will be state of the art on the market on that specific day - just one click away.</p>
<p>This allows us to experiment more, verify our assumptions, and have real-life feedback.  It will lead to even more automated coding processes and inventions in language, patterns, or application architecture we can't even imagine today.</p>
<p><br></p>
<blockquote class="blockquote text-center">
"The best way to predict the future<br>is to create it."
</blockquote>
<p><br></p>
<p>Happy creating!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/06/29/how-will-programming-look-like-in-2025</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 29 Jun 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/06/29/how-will-programming-look-like-in-2025#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Why Class Constants Should be Typed ]]></title>
                <link>https://tomasvotruba.com/blog/2020/06/22/why-class-constants-should-be-typed</link>
                <description><![CDATA[ <p>Do you use PHP 7.4 <a href="/blog/2018/11/15/how-to-get-php-74-typed-properties-to-your-code-in-few-seconds/">typed properties</a>? Do you know why?
<br>
<br>
I use them, so <strong>I don't have to think and validate the property type</strong> every time. We just know its type or PHP would crash otherwise.
<br>
<br>
Until PHP 7.4 this was not possible and code was kinda crappy.
Where are we now with constant type? Do you trust your class constants type?</p> ]]></description>
                <content:encoded><![CDATA[ <p>With typed properties, the incorrect type-bug was completely removed:</p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

final class Person
{
    public string $name;

    public function __construct(string $name)
    {
        $this-&gt;name = $name;
    }
}</code></pre>
<pre><code class="language-php">$name = new Person(20_20);</code></pre>
<p>You would not use the <code>Name</code> object like this, right?</p>
<p><br></p>
<h2 id="What-About-Constants">What About Constants?</h2>
<p><strong>What</strong> are constants? They hold value, like properties, but <strong>the value doesn't change</strong>. We can change the value in the code, but not during runtime.</p>
<p><em>Pro-tip: Do you think all your properties have values that can change? <a href="https://github.com/rectorphp/rector/blob/master/docs/rector_rules_overview.md#changereadonlypropertywithdefaultvaluetoconstantrector">Dare Rector to find them</a>.</em></p>
<p>How do you define a class constant?</p>
<pre><code class="language-php">&lt;?php

final class SomeClass
{
    private const ORDER = 'first';

    // ...
}</code></pre>
<p>How is this dangerous? Sometimes, in 2 years future from today, there will be pull-request that changes it like this:</p>
<pre><code class="language-php">&lt;?php

final class SomeClass
{
    private const ORDER = 1;
}</code></pre>
<p>Because if you're first, you're 1, right? I had the pleasure to debug such cases only to figure out the constant type was changed. Why? Because it could.</p>
<p><strong>Constants value can be changed manually - so their type.</strong> It's rarely desired behavior, moreover, when using these constants in 3rd party code or from one.</p>
<h2 id="How-Can-We-Prevent-Constant-Re-type">How Can We Prevent Constant Re-type?</h2>
<pre><code class="language-php">&lt;?php

final class SomeClass
{
    /**
     * Should be a string
     */
    private const ORDER = 'first';
}</code></pre>
<p>We read comments, READMEs, or manuals... only when something goes wrong.</p>
<pre><code class="language-php">&lt;?php

final class SomeClass
{
    /**
     * @var string
     */
    private const ORDER = 'first';
}</code></pre>
<p>Slightly better, but still no way to enforce it.</p>
<pre><code class="language-php">&lt;?php

final class SomeClass
{
    private string const ORDER = 'first';
}</code></pre>
<p>Great! But maybe in 2025?</p>
<h2 id="Future-Scoping">Future Scoping</h2>
<p>The <a href="https://stitcher.io/blog/new-in-php-8">PHP 8.0 release will be a blast</a>. It's already ~30 merged features, and feature freeze is still <a href="https://thephp.website/en/issue/php8-release-schedule">23 days ahead of us</a>.</p>
<p>If we look at selected features in PHP 8:</p>
<ul>
<li><a href="https://wiki.php.net/rfc/constructor_promotion">Constructor Property Promotion</a></li>
<li><a href="https://wiki.php.net/rfc/union_types_v2">Union Types 2.0</a></li>
<li><a href="https://wiki.php.net/rfc/mixed_type_v2">Mixed Type v2</a></li>
<li><a href="https://wiki.php.net/rfc/static_return_type">Static return type</a></li>
<li><a href="https://wiki.php.net/rfc/magic-methods-signature">Ensure correct signatures of magic methods</a></li>
<li><a href="https://wiki.php.net/rfc/make_ctor_ret_void">Make constructors and destructors return void</a> (WIP)</li>
</ul>
<p>We can see there is a handful of changes <strong>towards more strict and reliable types</strong>. We are moving from docblocks to in-code types.</p>
<p><strong>We can expect</strong> similar future for constants. Maybe even sooner before <code>TypedArrays[]</code> will be added.</p>
<p><strong>In 2015, we wished for typed properties, and in 2020 we have union strictly typed properties</strong>. We can go for typed constants now.</p>
<blockquote class="blockquote text-center mt-5 mb-5">
Check trends to predict code syntax,<br>
and write future compatible code your children will thank you for.
</blockquote>
<p><br></p>
<h2 id="Let-Computer-work-For-You">Let Computer work For You</h2>
<p><a href="/blog/2020/01/13/why-is-first-instant-feedback-crucial-to-developers/">The sooner you discover the error</a>, the better.</p>
<p>Do you use continuous integration (Github Actions, Gitlab CI, Travis CI...) and PHPStan? Add <a href="https://github.com/symplify/coding-standard#constant-type-must-match-its-value">PHPStan rule that checks <code>@var</code> definition vs the real value</a>.</p>
<pre><code class="language-diff"> &lt;?php

 final class SomeClass
 {
     /**
      * @var string
      */
-    private const ORDER = 'first';
+    private const ORDER = 1;
 }</code></pre>
<p>If this change occurs in pull-request, the CI will tell you it's not consistent with the <code>@var</code> type.</p>
<p>This way, you'll be <strong>aware of the type change right before the merge</strong>, which is much better than 2 years later after 4 hours of debugging. Trust me.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/06/22/why-class-constants-should-be-typed</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 22 Jun 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/06/22/why-class-constants-should-be-typed#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to create a Monorepo from Existing Repositories in 7 Steps ]]></title>
                <link>https://tomasvotruba.com/blog/2020/06/15/how-to-create-monorepo-from-existing-repositories-in-7-steps</link>
                <description><![CDATA[ <p>It seems like PHP companies are opening to <strong>the most comfortable way to manage multiple projects and packages at once</strong>.
<br>
<br>
I've heard questions like &quot;how do we make monorepo if have like 15 repositories?&quot; <strong>3 times just last month</strong> - from the Czech Republic, Croatia, and the Netherlands.
<br>
<br>
I'm so happy to see this because lazy dev = happy dev, happy dev = easy code to read.
<br>
So how to start a monorepo if you already have existing repositories?</p> ]]></description>
                <content:encoded><![CDATA[ <p><strong>Disclaimer</strong>: are you're into git history? Read <a href="https://www.shopsys.com/how-to-merge-15-repositories-to-1-monorepo-keep-their-git-history-and-add-project-base-as-well-6e124f3a0ab3">How to Merge 15 Repositories to 1 Monorepo, Keep their Git History and add Project-Base as Well?</a>.</p>
<p>In practice, keeping git history before merging <strong>is not worth the invested time</strong>. Why?</p>
<ul>
<li>A) It takes you 4-6 weeks to figure out how <code>git</code> works in merging to different paths</li>
<li>B) Then it takes you 1-2 weeks to balance all packages together code-wise - pull-request, that change paths anyway, move code, refactor it, merge classes, etc.</li>
</ul>
<p>If you want to bump your company about a massive pile of money for low gain and want it, go for A + B.</p>
<p>I'm an honest and pragmatic developer, and my customers want to deliver features, not to play around technology sandbox, so we <strong>always take path B</strong>.</p>
<p><br></p>
<p>Now that's clear, let's <strong>dive in to merge practice</strong>.</p>
<p><br>
<br></p>
<h2 id="What-Repositories-do-you-Have">What Repositories do you Have?</h2>
<p>The right time to think about monorepo is usually around 5 repositories. The longer you wait, the more you'll add to your future developers - exponentially. Companies typically get the idea around 15 repositories - we'll work with only 2, but apply the same for whatever count.</p>
<p>First repository: <code>lazy-company/ecoin-payments</code></p>
<p>With following code:</p>
<pre><code class="language-bash">/src
/test
composer.json
ecs.php
phpstan.neon
phpunit.xml
rector.php</code></pre>
<p>Second repository: <code>lazy-company/drone-delivery</code></p>
<p>With following code:</p>
<pre><code class="language-bash">/src
/test
composer.json
ecs.php
phpstan.neon
phpunit.xml
rector.php</code></pre>
<h2 id="1-Create-a-Monorepo-repository">1. Create a Monorepo repository</h2>
<p>Go to your Gitlab or Github and create a new repository. Name it <code>lazy-company/lazy-company</code> (by convention) or <code>lazy-company/lazy-company-monorepo</code> (in case the previous is taken).</p>
<p>Clone it locally.</p>
<h2 id="2-Copy-Repositories-to-packages">2. Copy Repositories to <code>/packages</code></h2>
<p>Don't worry, no git harakiri. Just copy paste your other repositories to <code>/packages</code> directory:</p>
<pre><code class="language-bash">/packages
    /ecoin-payments
        /src
        /test
        composer.json
        ecs.php
        phpstan.neon
        phpunit.xml
        rector.php
    /drone-delivery
        /src
        /test
        composer.json
        ecs.php
        phpstan.neon
        phpunit.xml
        rector.php</code></pre>
<p>Not bad, right?</p>
<h2 id="3-Merge-all-composer-json-to-Root-One">3. Merge all <code>composer.json</code> to Root One</h2>
<p>In the root directory, we only have the directory with all packages:</p>
<pre><code class="language-bash">/packages</code></pre>
<p>But where is <code>composer.json</code>? We can <del>create it manually</del> use a CLI tool that does it for us - <a href="https://github.com/symplify/monorepo-builder">MonorepoBuilder</a>.</p>
<p>Use <a href="/blog/2019/12/02/how-to-box-symfony-app-to-phar-without-killing-yourself/">prefixed version</a> to avoid dependency conflicts with your packages.</p>
<pre><code class="language-bash">composer require symplify/monorepo-builder-prefixed --dev</code></pre>
<p>Now that we have <a href="/blog/2018/10/08/new-in-symplify-5-create-merge-and-split-monorepo-with-1-command/">this power-tool for working</a> with monorepo, we can do:</p>
<pre><code class="language-bash">vendor/bin/monorepo-builder merge</code></pre>
<p>And...</p>
<img src="/assets/images/posts/2020/monorepo_builder_merge.png" class="img-thumbnail">
<p>Damn, what is this?</p>
<h2 id="4-Balance-External-Dependencies">4. Balance External Dependencies</h2>
<p>We have to look into <code>composer.json</code> files to find out what happened:</p>
<pre><code class="language-json">{
    "name": "lazy-company/ecoin-payments",
    "require": {
        "symfony/http-kernel": "^4.4|^5.0"
    }
}</code></pre>
<p>and</p>
<pre><code class="language-json">{
    "name": "lazy-company/drone-delivery",
    "require": {
        "symfony/http-kernel": "^3.4|^4.4"
    }
}</code></pre>
<p>We have 2 packages that require <strong>different versions of the same dependency</strong>. One allows Symfony 3; the other does not, but can run on Symfony 5.</p>
<p>What version do they share?</p>
<ul>
<li><code>^4.4</code></li>
</ul>
<p>The number <strong>must be identical for all packages</strong>. One package cannot have <code>^4.3</code>, and the other <code>^4.4</code>.</p>
<pre><code class="language-diff"> {
     "name": "lazy-company/ecoin-payments",
     "require": {
-        "symfony/http-kernel": "^4.4|^5.0"
+        "symfony/http-kernel": "^4.4"
     }
 }</code></pre>
<p>and:</p>
<pre><code class="language-diff"> {
     "name": "lazy-company/drone-delivery",
     "require": {
-        "symfony/http-kernel": "^3.4|^4.4"
+        "symfony/http-kernel": "^4.4"
     }
 }</code></pre>
<h3 id="The-Easiest-Common-Version-Problem">The Easiest, Common Version Problem</h3>
<p>We have to figure out <strong>the package version that would be easier to use</strong>. Sometimes the new version requires some refactoring.</p>
<p>In current project I migrate 15 packages, that have these requirements:</p>
<ul>
<li>A: &quot;symfony/http-kernel&quot;: &quot;^5.0&quot;</li>
<li>B: &quot;symfony/http-kernel&quot;: &quot;^3.4&quot;</li>
<li>C: &quot;symfony/http-kernel&quot;: &quot;^2.8&quot;</li>
</ul>
<p>If we pick <code>^3.4</code>, we have to make sure the code of A and C packages will be updated or downgraded to that version. You get the idea.</p>
<p><br></p>
<p>When we have all versions synced, we can run the merge command:</p>
<pre><code class="language-bash">vendor/bin/monorepo-builder merge</code></pre>
<p>Tadá!</p>
<p>We should see something like this:</p>
<pre><code class="language-json">{
    "require": {
        "symfony/http-kernel": "^4.4"
    },
    "require-dev": {
        "symplify/monorepo-builder-prefixed": "^8.0"
    },
    "replace": {
        "lazy-company/drone-delivery": "self.version",
        "lazy-company/ecoin-payments": "self.version"
    }
}</code></pre>
<p>Do you? Good!</p>
<p><br></p>
<p>What is the <code>replace</code> section? We'll use it in step 5 ↓</p>
<h2 id="5-Balance-Mutual-Dependencies">5. Balance Mutual Dependencies</h2>
<p>It's standard that packages depend on each other. Drone delivery is a service a customer pays for - with bitcoins. So we need it here:</p>
<pre><code class="language-json">{
    "name": "lazy-company/drone-delivery",
    "require": {
        "symfony/http-kernel": "^4.4",
        "lazy-company/ecoin-payments": "^2.0"
    }
}</code></pre>
<p>What if 2 packages require a different version of the same package?</p>
<ul>
<li>A. &quot;lazy-company/ecoin-payments&quot;: &quot;^2.0&quot;</li>
<li>B. &quot;lazy-company/ecoin-payments&quot;: &quot;^3.0&quot;</li>
</ul>
<p>Do we apply the same approach as in step 4? <strong>No</strong>. Instead of the most accessible common version, we'll go with <strong>the latest version</strong> - <code>^3.0</code>.</p>
<p>These numbers also tell us what the first monorepo release version will be. It has to be a <a href="https://semver.org">major version</a> because there will be BC breaks: so ^4.0.</p>
<p><br></p>
<h3 id="What-about-that-replace">What about that <code>replace?</code></h3>
<p>Here we also use the <a href="https://getcomposer.org/doc/04-schema.md#replace"><code>replace</code> composer feature</a>.</p>
<p>If we run <code>composer install</code> in monorepo, it will install all dependencies of <code>lazy-company/drone-delivery</code>. This package needs <code>lazy-company/ecoin-payments</code> (the other package). Normally, the composer would go to Packagist and download the package to <code>/vendor</code>. But that might end-up in collision:</p>
<pre><code class="language-bash">/packages/ecoin-payments/src # some code
/vendor/lazy-company/ecoin-payments/src # same code?</code></pre>
<p>The <code>replace</code> option tells the composer not to download anything because the <code>lazy-company/ecoin-payments</code> is already in <code>/packages/ecoin-payments/src</code>.</p>
<pre><code class="language-diff"> /packages/ecoin-payments/src
-/vendor/lazy-company/ecoin-payments/src</code></pre>
<h2 id="6-Merge-Static-Analysis-tools-to-Run-on-Root-Only">6. Merge Static Analysis tools to Run on Root Only</h2>
<p>All right, we have working <code>composer.json</code> with united versions. That was the most challenging part, so great job!</p>
<p>No, we need to clean configs of tools that help us with daily development:</p>
<ul>
<li>ECS</li>
<li>PHPStan</li>
<li>Rector</li>
<li>...</li>
</ul>
<p>Instead of many configs, paths, setups, and rules, there is only 1 source of Truth - root configs.</p>
<pre><code class="language-diff"> /packages
     /ecoin-payments
         /src
         /test
         composer.json
-        ecs.php
-        phpstan.neon
         phpunit.xml
-        rector.php
     /drone-delivery
         /src
         /test
         composer.json
-        ecs.php
-        phpstan.neon
         phpunit.xml
-        rector.php
+ecs.php
+phpstan.neon
+rector.php</code></pre>
<p>This step is pretty easy... well, it depends.</p>
<p><strong>What is the thing that can happen?</strong> One of your packages has PHPStan level 1, but all others have PHPStan 8.</p>
<p>We can either take time and update the PHPStan level 1 to 8 or lower all to 1. I'd go with <em> drop all to 1</em> options now, and do this after creating the monorepo. If we mix too many tasks at once, we can prolong <em>build a monorepo</em> tasks for weeks.</p>
<p><br></p>
<p>Pro-tip: do you want to make sure all versions of all dependencies of all <code>composer.json</code> files have united version?</p>
<pre><code class="language-bash">vendor/bin/monorepo-builder validate</code></pre>
<h2 id="7-Merge-tests-to-root-phpunit-xml">7. Merge tests to root <code>phpunit.xml</code></h2>
<p>Very similar to step 6, just with unit tests.</p>
<pre><code class="language-diff"> /packages
     /ecoin-payments
         /src
         /test
         composer.json
-        phpunit.xml
     /drone-delivery
         /src
         /test
         composer.json
-        phpunit.xml
 ecs.php
 phpstan.neon
 rector.php
+phpunit.xml</code></pre>
<p>Update paths in <code>phpunit.xml</code> and prepare a common environment for all tests.</p>
<p><br></p>
<p>In the end, we have to be able to run:</p>
<pre><code class="language-bash">vendor/bin/phpunit</code></pre>
<p>And see the result of all tests.</p>
<p>Everything else will be more complicated than it has to, will annoy us, and demotivate us from actually writing the tests. <strong>So make it easy and simple</strong>.</p>
<p><br></p>
<p>If you're serious about monorepo testing, read <a href="/blog/2018/11/22/how-to-test-monorepo-in-3-layers/">How to Test Monorepo in 3 Layers</a>.</p>
<h2 id="Final-Touches">Final Touches</h2>
<p>Don't forget to add <code>.gitignore</code> with <code>/vendor</code>. Then <code>git push</code> and we're finished.</p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/06/15/how-to-create-monorepo-from-existing-repositories-in-7-steps</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 15 Jun 2020 00:00:00 +0000</pubDate>
                                    <updated>2020-08-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Aug 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Aug 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/06/15/how-to-create-monorepo-from-existing-repositories-in-7-steps#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Drop RobotLoader and let Composer Deal with Autoloading ]]></title>
                <link>https://tomasvotruba.com/blog/2020/06/08/drop-robot-loader-and-let-composer-deal-with-autoloading</link>
                <description><![CDATA[ <p>Using 2 tools for one thing, in this case 2 packages to autoload classes, are sign of an architecture smell. Many applications I see contain RobotLoader for historical reasons. I will borrow this from psychology: pathological behavioral patterns tear us down in the present, but were useful in past.
<br><br>
The best way to deal with them is acknowledge their purpose and then, let them go and enjoy the gift of present.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Where-is-RobotLoader-Useful">Where is RobotLoader Useful</h2>
<p><a href="https://doc.nette.org/en/auto-loading#toc-nette-loaders-robotloader">RobotLoader</a> is a Nette Component that is used to autoload classes. Its killer feature is simple: <strong>in whatever file it is and whatever the class name is, I will load it</strong>. You can have 20 classes in 1 file or classes located in various locations, they won't hide.</p>
<h2 id="Before-Composer-appeared-it-was-The-Best">Before Composer appeared, it was The Best</h2>
<p>RobotLoader was a very useful tool in times before Composer, because <strong>there were not so many efficient tools for loading classes</strong>.</p>
<p>Also, when people could not agree upon where to put their classes, how to name them, whether use or don't use namespace and how many classes to put in one file, we can say <strong>this tool saved a lot of argument-hours</strong>.</p>
<p>After many discussions, followed by the first standard, <a href="http://www.php-fig.org/psr/psr-0">PSR-0</a>, people agreed upon <a href="http://www.php-fig.org/psr/psr-4">PSR-4</a>, a more mature replacement of PSR-0.</p>
<h2 id="Why-it-s-not-Anymore">Why it's not Anymore</h2>
<p>Have your heard about PSR-4? It is a <em>PHP Standard Recommendation</em> about naming and location of the classes. This says you completely nothing, but in the simplest form it means:</p>
<p><strong>1 class</strong> (or interface/trait) = <strong>1 file</strong></p>
<p><strong>class name</strong> = <strong>file name</strong>.php</p>
<p><strong>namespace\class name</strong> = <strong>directory/file name</strong>.php</p>
<pre><code class="language-bash"># class =&gt; file
MyClass =&gt; MyClass.php
App\MyClass =&gt; App/MyClass.php
App\Presenter\MyClass =&gt; App/Presenter/MyClass.php</code></pre>
<p>I know I can rely on this in 99% of places when <code>composer.json</code> is used.</p>
<p>When I see <code>App\Presenter\MyClass</code> I  it's located in <code>App/Presenter/MyClass.php</code> file.</p>
<p>And this is the place where <strong>RobotLoader</strong> (or any custom ultimate loader) <strong>fails</strong>. I came around many applications where classes are located at random. And I had to use my brain to find them. But I don't want to focus my mental activity on thinking about their location, <strong>I want to develop my application</strong>.</p>
<h2 id="How-to-move-to-Composer-in-a-Nette-application">How to move to Composer in a Nette application?</h2>
<p>There are 2 levels of how to achieve this.</p>
<h3 id="Level-1-Change-your-Composer">Level 1: Change your Composer</h3>
<p>The first level requires 3 small steps.</p>
<h4 id="1-Tune-composer-json-Autoloading">1. Tune <code>composer.json</code> Autoloading</h4>
<pre><code class="language-json">{
    "require": {
        "..."
    },
    "autoload": {
        "psr-4": {
            "App\\Forms\\": "app/forms",
            "App\\Model\\": "app/model",
            "App\\Presenters\\": "app/presenters",
            "App\\Router\\": "app/router"
        }
    }
}</code></pre>
<p>This means, all classes residing in <code>App\\Forms</code> namespace have to be located in <code>app/forms</code> directory.</p>
<p>One important rule - it works in <strong>case-sensitive</strong> manner.</p>
<p>So this will work:</p>
<pre><code class="language-bash">App\Presenters\HomepagePresenter =&gt; app/presenters/HomepagePresenter.php</code></pre>
<p>But this will not:</p>
<pre><code class="language-bash">App\Presenters\HomepagePresenter =&gt; app/presenters/homepagePresenter.php</code></pre>
<h4 id="2-Disable-RobotLoader">2. Disable RobotLoader</h4>
<p>Now you can clean up your <code>app/bootstrap.php</code>:</p>
<pre><code class="language-php">// $configurator-&gt;createRobotLoader()
//      -&gt;addDirectory(__DIR__)
//      -&gt;register();</code></pre>
<p>But RobotLoader is still silently enabled for presenters. We don't want that either now:</p>
<pre><code class="language-yaml"># app/config/config.neon
application:
    scanDirs: false</code></pre>
<h4 id="3-Refresh-Composer-Autoloading">3. Refresh Composer Autoloading</h4>
<p>And tell Composer, to regenerate its autoloader:</p>
<pre><code class="language-bash">composer dump-autoload</code></pre>
<p>Note: This command is run by default after <code>composer update</code>, <code>composer require ...</code> and similar commands. Since we'd manually changed our <code>autoload</code> section, we had to run it manually.</p>
<p>Now try our application and it should run.</p>
<p><strong>You are finished and all your classes are loaded by Composer.</strong> Congratulations!</p>
<h3 id="Level-2-Rename-Directories-to-capital-case-to-Respect-PSR-4">Level 2: Rename Directories to capital case, to Respect PSR-4</h3>
<p>There is one more level I do with my applications, so my <code>composer.json</code> is nice and clear. But this is optional. Do it only if you'd like to write better code with lower WTF factor!</p>
<p>Turn this:</p>
<pre><code class="language-bash">/app
    /forms
    /model
    /presenters
    /routing
    /...</code></pre>
<p>Into this:</p>
<pre><code class="language-bash">/app
    /Forms
    /Model
    /Presenters
    /Routing
    /...</code></pre>
<p>After these steps, you can simplify your <code>autoload</code> section as such:</p>
<pre><code class="language-json">{
    "autoload": {
        "psr-4": {
            "App\\": "app"
        }
    }
}</code></pre>
<p>Don't forget to run:</p>
<pre><code class="language-bash">composer dump-autoload</code></pre>
<p>And you've unlocked Level 2.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/06/08/drop-robot-loader-and-let-composer-deal-with-autoloading</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 08 Jun 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/06/08/drop-robot-loader-and-let-composer-deal-with-autoloading#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ @inject or @required will Get You Any Services Fast ]]></title>
                <link>https://tomasvotruba.com/blog/2020/06/01/inject-or-required-will-get-you-any-service-fast</link>
                <description><![CDATA[ <p>It is official. Symfony 5.1 <a href="https://symfony.com/blog/new-in-symfony-5-1-autowire-public-typed-properties">adds property injection to public properties</a>.
Now, <code>@inject</code> or <code>@required</code> annotation above property or setter method is the fastest way to get any dependency on any service in your Symfony or Nette project.
<br><br>
Use it everywhere you can... or not?</p> ]]></description>
                <content:encoded><![CDATA[ <p>This post is about one of the practices that give me work as a legacy cleaning lady. Read carefully - you can decide if your project will be the next client or you'll build reliable code that is fun to work with.</p>
<p><br></p>
<p>Do you <strong>like long repeated code with the same meaning over and over again</strong>?</p>
<p><br></p>
<p>Why write long and tedious constructors in 25 lines...</p>
<pre><code class="language-php">&lt;?php

use Twig\Environment;
use Latte\Engine;

final class TemplateFactory
{
    /**
     * Symfony way
     * @var Environment
     */
    private $environment;

    /**
     * Nette way
     * @var Engine
     */
    private $engine;

    public function __construct(Environment $environment, Engine $engine)
    {
        $this-&gt;environment = $environment;
        $this-&gt;engine = $engine;
    }
}</code></pre>
<p>...when you can do property injection with only <strong>17 lines</strong> and same effect:</p>
<pre><code class="language-php">&lt;?php

use Twig\Environment;
use Latte\Engine;

final class TemplateFactory
{
    /**
     * @required
     */
    public Environment $environment;

    /**
     * @var Engine
     * @inject
     */
    public $engine;
}</code></pre>
<p>Let me show you what you are inviting to your code by the second choice.</p>
<h2 id="1-Public-Property-Service-Override">1. Public Property - Service Override?</h2>
<p>At the start of the project, it's very easy to see what is right and what is wrong. But as time goes by, <strong>people will start to use everything they can to add a feature or fix the bug as fast possible</strong>. I do that all the time.</p>
<pre><code class="language-php">&lt;?php

use Twig\Environment;

final class EmailSender
{
    /**
     * @var TemplateFactory
     */
    private $templateFactory;

    /**
     * @var Environment
     */
    private $emailOnlyEnvironment;

    public function __construct(TemplateFactory $templateFactory, Environment $emailOnlyEnvironment)
    {
        $this-&gt;templateFactory = $templateFactory;
        $this-&gt;emailOnlyEnvironment;
    }

    public function sendInvoiceEmail(string $emailTo)
    {
        // hm... we need that custom Twig service here because it has extra macros/filters that are used only in emails

        // how can we do that?

        // ah, this will do
        $this-&gt;templateFactory-&gt;engine = $this-&gt;emailOnlyEnvironment;

        $template = $this-&gt;templateFactory-&gt;create();
        // ...
    }
}</code></pre>
<h3 id="Would-You-Accept-this-Code-in-Code-Review">Would You Accept this Code in Code-Review?</h3>
<ul>
<li>What service is in the <code>$this-&gt;templateFactory-&gt;engine</code> property?</li>
<li>How many weeks will it take to forget this <del>trick</del> hack?</li>
<li>How many will be the <code>TemplateFactory</code> used for emails, and how many for web templates?</li>
</ul>
<h3 id="Practise-Makes-Perfect">Practise Makes Perfect</h3>
<p>Do you think this is a good practice? If so, I dare you: add such <strong>service override feature</strong> to your code and code as nothing happened. After 30 days, get back here and let me know in the comments how did your colleagues liked it.</p>
<h2 id="2-Circular-Reference-for-Blind-People">2. Circular Reference for Blind People?</h2>
<p>Let's have a simple contest. Who will be first?</p>
<p>This example is oversimplified - 2 classes are easy to debug. Recent projects I work with have 1000-2000 classes... so for real-life use case imagine this is 1000x longer example.</p>
<pre><code class="language-php">&lt;?php

use Twig\Environment;

final class EmailSender
{
    /**
     * @inject
     * @var TemplateFactory
     */
    public $templateFactory;
}</code></pre>
<p>We need to send an email to admin if template engine rendering fails.</p>
<pre><code class="language-php">&lt;?php

use Twig\Environment;

final class CustomEnvironment extends Environment
{
    /**
     * @inject
     * @var EmailSender
     */
    public $emailSender;

    public function renderTemplate(string $template)
    {
        try {
            // ...
        } catch (Throwable) { // new PHP 8.0 syntax ^^
            $this-&gt;emailSender-&gt;sendRenderFailedMessageToAdmin();
        }
    }
}</code></pre>
<h3 id="Would-You-Accept-this-Code-in-Code-Review">Would You Accept this Code in Code-Review?</h3>
<ul>
<li>How do you know what service is where when?</li>
<li>What could happen in the case of race-condition?</li>
<li>What stops you from using <code>StaticMethods::everywhere()</code>?</li>
<li>How does the dependency tree look like now?</li>
</ul>
<p>Some frameworks container will tell you there is circular dependency and fail with an exception. Some would let it silently slip.</p>
<p>Either way, your code is now opened to issue, when at <strong>2 different times, there are 2 different values in one property</strong>. Similar issue to previous one, just more <em>fun</em> to debug.</p>
<h2 id="Why-we-Have-at-inject-at-required-anyway-and-When-to-Use-it">Why we Have <code>@inject/@required</code> anyway and When to Use it?</h2>
<p>Nette is trying to limit this by suggestion, that <code>@inject</code> should be <a href="https://doc.nette.org/en/3.0/di-usage#toc-which-way-should-i-choose"><strong>used only in presenters</strong></a>. No surprise, that project I work with now have it in almost every dependency of every presenter.</p>
<p>Also, it takes about 20 lines of PHP code to enable this in every service. It might still be in one of the top 5 e-commerce projects in The Czech Republic.</p>
<p><a href="https://symfony.com/doc/current/service_container/injection_types.html#immutable-setter-injection">Symfony has similar feature</a>, but without any scope limitation, as far as I know</p>
<p><br></p>
<p>What can you do about it?</p>
<p>Well, in complicated times of circular dependencies, public property override and service juggling, it helps to get back to the basics: <strong>what is the best use case for <code>@required</code>/<code>@inject</code>?</strong></p>
<ul>
<li>Getting a dependency? <strong>No</strong></li>
<li><a href="https://ocramius.github.io/blog/eliminating-visual-debt">Eliminating visual dept</a>? <strong>No</strong></li>
<li>Using the <em>my-favorite</em> framework the fullest? <strong>No</strong></li>
</ul>
<p>Why add such a feature, if there is no reason to use it?</p>
<p><br></p>
<p>The main reason for this feature is to prevent <strong>constructor injection hell</strong>.</p>
<p>David Grudl <a href="https://phpfashion.com/di-a-predavani-zavislosti">wrote about it 8 years ago</a> (in Czech):</p>
<pre><code class="language-php">&lt;?php

class Barbar extends Foobar
{
   private $logger;

   function __construct(HttpRequest $httpRequest, Router $router, Session $session, Logger $logger)
   {
      parent::__construct($httpRequest, $router, $session);
      $this-&gt;logger = $logger;
   }
}</code></pre>
<p>You can also find other <a href="https://www.rhyous.com/2016/09/27/constructor-injection-hell">sources in English</a>.</p>
<p>But programmers don't know about constructor injection hell. Why? Simply because there <a href="https://blog.codinghorror.com/the-just-in-time-theory">was no exception in the code, when they used <code>@inject</code></a>. We just use features that were given to us by the framework.</p>
<blockquote class="blockquote text-center">
    "Everything which is not forbidden,
     <br>
     is allowed"
</blockquote>
<p><br></p>
<h2 id="Rule-of-Thumb-Abstract-Parent-Only">Rule of Thumb: Abstract Parent Only</h2>
<p>Saying that the place <code>@inject</code>/<code>@required</code> is designed for is dependency in <code>abstract</code> class. But not every <code>abstract</code> class! Just those that have children with more dependencies, that would require to put <code>parent::__construct()</code> repeated in every child.</p>
<pre><code class="language-php">&lt;?php

abstract class AbstractRepository
{
    protected EventDispatcherInterface $eventDispatcher;

    /**
     * @required
     */
    public function injectEventDispatcher(EventDispatcherInterface $eventDispatcher)
    {
        $this-&gt;eventDispatcher = $eventDispatcher;
    }
}</code></pre>
<pre><code class="language-php">&lt;?php

final class ProductRepository extends AbstractRepository
{
    protected ProductEntityFactory $productEntityFactory;

    public function __construct(ProductEntityFactory $productEntityFactory)
    {
        $this-&gt;productEntityFactory = $productEntityFactory;
        // no parent::__construct() in every repository - yay!
    }
}</code></pre>
<p>✅</p>
<p><em>Note: prefer &quot;inject&quot; method over public property to lower risk of 2 bugs mentioned in the start of the post.</em></p>
<p>That's it! And soon, hopefully, I'll be out of work.</p>
<p><br></p>
<p>Now, all we need is <strong>to create a PHPStan rule</strong>, that allows <code>@inject</code>/<code>@required</code> (and setter method alternatives) in <code>abstract</code> classes. Then you can forget this post and be safe for eternity.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/06/01/inject-or-required-will-get-you-any-service-fast</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 01 Jun 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/06/01/inject-or-required-will-get-you-any-service-fast#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ The Bulletproof Event Naming For Symfony Event Dispatcher ]]></title>
                <link>https://tomasvotruba.com/blog/2020/05/25/the-bulletproof-event-naming-for-symfony-event-dispatcher</link>
                <description><![CDATA[ <p>I wrote <a href="/blog/2019/08/05/standalone-symfony-event-dispatcher-from-the-scratch/">intro to Symfony\EventDispatcher</a> and how to use it with simple event.
<br><br>
But when it comes to dispatching events, you can choose from 4 different ways. Which one to choose and why? Today I will show you pros and cons of them to make it easier for you.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="1-Start-with-Stringly">1. Start with <em>Stringly</em></h2>
<p>You can start with simple <em>string named event</em>:</p>
<pre><code class="language-php">$postEvent = new PostEvent($post);
$this-&gt;eventDispatcher-&gt;dispatch('post_added', $postEvent);</code></pre>
<p>Simple for start and easy to use for one place and one event.</p>
<p>One day I started to use in more places:</p>
<pre><code class="language-php">$postEvent = new PostEvent($post);
$this-&gt;eventDispatcher-&gt;dispatch('post_add', $postEvent);</code></pre>
<p>All looked good, but <strong>the subscriber didn't work</strong>. Fun time with event subscribers debugging was about to come.</p>
<p>Hour has passed. Event subscriber was registered as a service, tagged, collected by dispatcher... but I still couldn't find the issue. So I showed it to my colleague:</p>
<p><em>Oh, you've got &quot;post_add&quot; there, but there should be &quot;post_added&quot;.</em></p>
<p>YAY! I copied the previous subscriber with &quot;post_added&quot; but <strong>I made a typo</strong> while dispatching event.</p>
<p>There must be a cure for this, I wished.</p>
<h2 id="2-Group-File-with-Events-Names-as-Constants">2. Group File with Events Names as Constants</h2>
<p>Then I got inspired by Symfony <a href="https://github.com/symfony/symfony/blob/d203ee33954f4e0c5b39cdc6224fe4fb96cac0c3/src/Symfony/Component/Console/ConsoleEvents.php"><code>ConsoleEvents</code> class</a> that collects all events from one domain in constants.</p>
<pre><code class="language-php">final class PostEvents
{
    /**
     * This event is invoked when post is added.
     * It is called here @see \App\Post\PostService::add().
     * And @see \App\Events\PostAddedEvent class is passed.
     *
     * @var string
     */
    public const ON_POST_ADDED = 'post_added';

    /**
     * This event is invoked when post is published.
     * It is called here @see \App\Post\PostService::published().
     * And @see \App\Events\PostPublishedEvent class is passed.
     *
     * @var string
     */
    public const ON_POST_PUBLISHED = 'post_published';
}</code></pre>
<p>Our first example will change from <em>stringly</em> to <em>strongly</em> typed:</p>
<pre><code class="language-php">$postAddedEvent = new PostAddedEvent($post);
$this-&gt;eventDispatcher(PostEvents::ON_POST_ADDED, $postAddedEvent)</code></pre>
<p>Also subscriber becomes typo-proof:</p>
<pre><code class="language-php">final class TagPostSubscriber implements SubscriberInterface
{
    public static function getSubscribedEvents(): array
    {
        return [PostEvents::ON_POST_ADDED =&gt; 'tagPost'];
    }

    public function tagPost(PostAddedEvent $postAddedEvent): void
    {
        // ...
    }
}</code></pre>
<h3 id="Pros">Pros</h3>
<ul>
<li>All events are in one place.</li>
<li>Easy to orientate for new programmer what events he or she can use.</li>
<li>IDE helps you with constant autocompletion.</li>
</ul>
<h3 id="Cons">Cons</h3>
<ul>
<li>One class to store all events <strong>breaks <a href="https://github.com/wataridori/solid-php-example/blob/master/2-open-closed-principle.php">open-closed principle</a></strong>.
<ul>
<li>To add new event I have to put it here as well - human memory vulnerable.</li>
</ul></li>
<li>Your have to come up with <strong>long annotation description above constant</strong>:
<ul>
<li>where is used (one place or all),</li>
<li>link the event class with IDE-compatible notation, e.g. <code>EventClass</code> doesn't work in PHPStorm, but <code>@see EventClass</code> does</li>
</ul></li>
</ul>
<p>The more events you have the harder is this to maintain properly. With 5th event you might end up like this:</p>
<pre><code class="language-php">final class PostEvents
{
    /**
     * This event is invoked when post is published.
     * It is called here @see \App\Post\PostService::published().
     * And @see \App\Events\PostPublishedEvent class is passed.
     *
     * @var string
     */
    public const ON_POST_PUBLISHED = 'post_published';

    // 3 more nicely annotated events...

    public const ON_POST_CHANGED = 'changed';
}</code></pre>
<p>I wanted to respect open-closed principle, so global class was a no-go.</p>
<p>Maybe, I could put those...</p>
<h2 id="3-Constant-Names-in-Particular-Event-Classes">3. Constant Names in Particular Event Classes</h2>
<p>Like this:</p>
<pre><code class="language-php">final class PostAddedEvent
{
    /**
     * @var string
     */
    public const NAME = 'post_added';

    /**
     * @var Post
     */
    private $post;

    public function __construct(Post $post)
    {
        $this-&gt;post = $post;
    }
}</code></pre>
<p>Our example is now <em>strongly</em> typed and <strong>respects open-closed principle</strong>:</p>
<pre><code class="language-php">$postAddedEvent = new PostAddedEvent($post);
$this-&gt;eventDispatcher(PostAddedEvent::NAME, $postAddedEvent)</code></pre>
<p>Like this!</p>
<h3 id="Pros">Pros</h3>
<p><strong>All the above +</strong></p>
<ul>
<li>Easy to refactor event name.</li>
<li>No more human error in event name typos.</li>
</ul>
<h3 id="Cons">Cons</h3>
<ul>
<li>You still need a human brain computation to keep <code>constant NAME = '...'</code> unique per-class.</li>
<li>Beautiful place for error and long nights of debugging.</li>
</ul>
<p><strong>Take a step back</strong>: what is my goal?</p>
<p>I look for an identifier that is:</p>
<ul>
<li><strong>unique per class</strong></li>
<li><strong>constant</strong> (in both meanings if possible)</li>
<li><strong>IDE friendly</strong></li>
<li><strong>coupled to Event class</strong> in any way</li>
<li>doesn't allow me to make naming errors and typos</li>
</ul>
<p>Can you see it? I think you do :)</p>
<h2 id="4-Class-based-Event-Naming">4. Class-based Event Naming</h2>
<pre><code class="language-php">$postAddedEvent = new PostAddedEvent($post);
$this-&gt;eventDispatcher(PostAddedEvent::class, $postAddedEvent)</code></pre>
<p>It could not be simpler and meets all the conditions!</p>
<h3 id="Pros">Pros</h3>
<p>All 4 reasons above +</p>
<ul>
<li><strong>It's typo-proof</strong></li>
<li>It uses PHP <strong>native <code>::class</code> support</strong>.</li>
<li>It's addictively easy.</li>
</ul>
<h2 id="Which-Type-Do-You-Like">Which Type Do You Like?</h2>
<p>This is my story for event naming evolution. But what is yours - <strong>which event naming system do you use</strong>? I'm curious and ready to be wrong, so please let me know in the comments if you like it or do it any different way.</p>
<h3 id="Taking-it-Step-Further">Taking it Step Further</h3>
<p><a href="http://enumag.cz">Enumag</a> suggested such different way by removing first argument:</p>
<pre><code class="language-php">public function dispatch(Event $event): void
{
    $this-&gt;eventDispatcher-&gt;dispatch(get_class($event), $event);
}</code></pre>
<p><strong>And exactly this is <a href="https://symfony.com/blog/new-in-symfony-4-3-simpler-event-dispatching">possible since Symfony 4.3</a></strong> (2019):</p>
<pre><code class="language-php">$postAddedEvent = new PostAddedEvent($post);
$this-&gt;eventDispatcher($postAddedEvent);

// or in case we don't need to get changed content from the event

$this-&gt;eventDispatcher-&gt;dispatch(new PostAddedEvent($post));</code></pre>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/05/25/the-bulletproof-event-naming-for-symfony-event-dispatcher</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 25 May 2020 00:00:00 +0000</pubDate>
                                    <updated>2020-05-01UTC00:00:000</updated>
                    <atom:updated>Fri, 01 May 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Fri, 01 May 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/05/25/the-bulletproof-event-naming-for-symfony-event-dispatcher#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ The Future of Pehapkari Meetups and Training - You ]]></title>
                <link>https://tomasvotruba.com/blog/2020/05/18/the-future-of-pehapkari-meetups-and-trainings-you</link>
                <description><![CDATA[ <p>Last 2 months gave lot of time to reflect my activities, work and hobbies. One of the topic I think about a lot is our Czech PHP Community - <a href="https://pehapkari.cz">Pehapkari</a>. I felt like last year I'm not giving it as much energy as before. But why?</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Why-were-Pehapkari-born">Why were Pehapkari born?</h2>
<p>In 2014, the only place to talk about PHP in the Czech Republic, was Nette forum. A place to bring all people of PHP, regardless their framework choice was missing. That's why Pehapkari (first year <em>Symfonisti</em>) were born.</p>
<p>Today, <strong>in 2020</strong> we have <a href="http://pehapkari.slack.com">Pehapkari Slack with 1600+ members</a>, where <strong>you can ask about anything you want. Instantly. Now. In Czech.</strong></p>
<p>Online works on itself, that's great. It took a <a href="https://pehapkari.cz/blog/2016/03/03/kolik-lidi-je-potreba-k-vytvoreni-jedne-komunity">huge effort of 25 people  to get there</a>. But <strong>what about offline</strong>? In 2019 we've organized ~10 meetups and 14 trainings, both in Prague. The rest of meetups is handled by companies themselves, e.g. PeckaDesign and Oxyshop in Brno by or DigitalSolutions in Pardubice.</p>
<p><br></p>
<p>Thank you all for your participation in our meetings over the past 5 years.</p>
<p>&quot;<em>That looks good. The most IT communities could dream of such activity. So what happened?</em></p>
<h2 id="My-Priorities-Have-changed-in-Last-3-years">My Priorities Have changed in Last 3 years</h2>
<p>When I started community in 2015, I worked as part-time programmer to fund it. I got few open-source projects, mostly Czech Republic-related.</p>
<p>Now, 5 years later, I got a bit more on my plate.</p>
<ul>
<li>last 3 years I work on <a href="https://github.com/rectorphp/rector">Rector</a> - PHP community likes and uses it more and more (recently <a href="https://www.drupal.org/blog/accelerating-drupal-9-module-and-theme-readiness-with-automated-patches">Drupal officially announced</a> - it a upgrade tool for 8 → 9) - it takes almost part-time to maintain project on GitHub</li>
<li>contributing to open-source and writing posts takes more time to make it beneficial to world PHP community</li>
<li>I travel abroad to conferences and meetups, that bites off another piece of time and energy cake</li>
<li>also, my main language switched from Czech to English</li>
</ul>
<p>Saying that, I don't have as much time and energy to keep community running, as it needs. I won't be organizing more meetups or trainings, except those pre-contracted.</p>
<h2 id="Do-you-want-Meetups-and-Training-to-Continue">Do you want Meetups and Training to Continue?</h2>
<p><strong>I do, that's why I'm writing this post.</strong></p>
<p>I could continue in <em>stand-by</em> state for another year or two, make meetups now and then. I could say it's due to Corona. But I don't think that's <strong>responsible to the PHP Community, that <a href="https://pehapkari.cz/blog/2016/03/03/kolik-lidi-je-potreba-k-vytvoreni-jedne-komunity">you helped me to build</a></strong> - to you. I've seen few communities to slowly vanish in history, because founders were focused somewhere else, but didn't offer community member to take over.</p>
<p>So I'm offering you to take over my place and continue to grow, where I can't.</p>
<p><br></p>
<p><strong>Do you want to take over meetups?</strong></p>
<ul>
<li>Let me know. I'll try to pass you my know-how and give access to website, Twitter and Facebook.</li>
</ul>
<p><strong>Do you want to take over training from me?</strong></p>
<ul>
<li>Same thing, contact me and if we match, it's your direction.</li>
</ul>
<p><br></p>
<p><strong>I hope Czech PHP community strives in online or offline, and we continue to meet each other, find friends and help each other grow, as we did till now.</strong> I really wish that.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/05/18/the-future-of-pehapkari-meetups-and-trainings-you</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 18 May 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/05/18/the-future-of-pehapkari-meetups-and-trainings-you#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Upgrade to Symplify 8 - From Fixers to Rector Rules ]]></title>
                <link>https://tomasvotruba.com/blog/2020/05/11/how-to-upgrade-to-symplify-8-from-fixers-to-rector-rules</link>
                <description><![CDATA[ <p>Symplify 8 is going to be released in the 2nd half of May. But as in Symfony, you can get ready for future version today.
<br><br>
<a href="/blog/2020/05/04/how-to-upgrade-to-symplify-8-from-sniffs-to-phpstan-rules/">In the previous post we upgraded Coding Standard from Sniffs to PHPStan</a>. Today we finish with 2nd half - <strong>from Fixers to Rector rules</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>When you run <a href="https://github.com/symplify/easy-coding-standard">ECS</a> with version 7.3+:</p>
<pre><code class="language-bash">vendor/bin/ecs check</code></pre>
<p>You might see such notices right before your code gets checked:</p>
<pre><code class="language-bash">PHP Notice:  Fixer "..." is deprecated. Use "..." instead</code></pre>
<h2 id="Why-were-These-Fixers-Dropped">Why were These Fixers Dropped?</h2>
<p>You'll find answer to this question <a href="/blog/2020/05/04/how-to-upgrade-to-symplify-8-from-sniffs-to-phpstan-rules/">in previous post</a>. To extend answer specifically for this post: Fixer and Rector do the same job - <strong>they change code based on specific recipe</strong>.</p>
<p><div class="card ml-4 mt-4 border-warning float-right post-snippet" style="width: 14em">
    <div class="card-body">
        Would you like to <strong>learn more about Rector</strong>? Step by step, from zero to hero?
        <br>

        <div class="text-center">
            <a href="/book/the-power-of-automated-refactoring/">
                <img src="/assets/images/rector_book.png" class="mb-3 mt-3 shadow">
                Get our new book
            </a>
        </div>
    </div>
</div>
</p>
<h3 id="What-is-the-Difference">What is the Difference?</h3>
<ul>
<li>Fixer works with <a href="https://www.php.net/manual/en/function.token-get-all.php">tokens</a> → which is <strong>great for spaces and <code>{}()</code> positions</strong> etc.,</li>
<li>Rector works with abstract syntax tree → <strong>great for refactoring, method/property position changes</strong>, rename across the code base, etc.</li>
</ul>
<p>Now we know <em>why</em>. Let's look <em>how</em> to deal with that.</p>
<h2 id="What-to-do-With-These-Deprecations">What to do With These Deprecations?</h2>
<p>So what does it mean? Remove all the rules from <code>ecs.php</code> and let go?</p>
<p>No, <strong>all you need to do is switch to Rector rules</strong>. It's better working and more reliable since it works with context and not token positions. So at first, you might see new changes in your code.</p>
<h2 id="How-to-Handle-Upgrade-in-30-minutes">How to Handle Upgrade in 30 minutes?</h2>
<p>There are dozen deprecated fixers in total. Let's take it one by one.</p>
<p>First - if you don't have Rector, install it:</p>
<pre><code class="language-bash">composer require rector/rector --dev</code></pre>
<h2 id="1-No-Empty-Doc-Block">1. No Empty Doc Block</h2>
<p>The <code>RemoveEmptyDocBlockFixer</code> rule basically copied behavior of native <code>NoEmptyPhpdocFixer</code>, so just it instead:</p>
<pre><code class="language-diff"> &lt;?php

 // ecs.php

 declare(strict_types=1);

 use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

 return function (ContainerConfigurator $containerConfigurator): void {
     $services = $containerConfigurator-&gt;services();
-    $services-&gt;set(Symplify\CodingStandard\Fixer\Commenting\RemoveEmptyDocBlockFixer::class);
+    $services-&gt;set(PhpCsFixer\Fixer\Phpdoc\NoEmptyPhpdocFixer::class);
 };</code></pre>
<h2 id="2-Preg-Delimiter-Character">2. Preg Delimiter Character</h2>
<p>The <code>PregDelimiterFixer</code> was checking consistent preg delimiter, in this case <code>#</code>:</p>
<pre><code class="language-diff"> class SomeClass
 {
     public function run()
     {
-        preg_match('~value~', $value);
+        preg_match('#value#', $value);
     }
 }</code></pre>
<p>Instead of <del><code>PhpCsFixer\Fixer\ControlStructure\PregDelimiterFixer</code></del> fixer:</p>
<p>↓</p>
<p>use Rector rule:</p>
<pre><code class="language-php">use Rector\CodingStyle\Rector\FuncCall\ConsistentPregDelimiterRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;set(ConsistentPregDelimiterRector::class)
        // default
        -&gt;arg('delimiter', '#');
};</code></pre>
<h2 id="3-Required-Must-be-followed-by-Absolute-Path">3. Required Must be followed by Absolute Path</h2>
<pre><code class="language-diff"> class SomeClass
 {
     public function run()
     {
-        require 'autoload.php';
+        require __DIR__ . '/autoload.php';
     }
 }</code></pre>
<p>Instead of <del><code>PhpCsFixer\Fixer\ControlStructure\RequireFollowedByAbsolutePathFixer</code></del> fixer,</p>
<p>↓</p>
<p>use Rector rule:</p>
<pre><code class="language-php">use Rector\CodingStyle\Rector\Include_\FollowRequireByDirRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;rule(FollowRequireByDirRector::class);
};</code></pre>
<h2 id="4-Match-Exception-variable-name-to-its-Type">4. Match Exception variable name to its Type</h2>
<pre><code class="language-diff"> class SomeClass
 {
     public function run()
     {
         try {
             // ...
-        } catch (SomeException $typoException) {
-            $typoException-&gt;getMessage();
+        } catch (SomeException $someException) {
+            $someException-&gt;getMessage();
         }
     }
 }</code></pre>
<p>Instead of <del><code>PhpCsFixer\Fixer\Naming\CatchExceptionNameMatchingTypeFixer</code></del> Fixer:</p>
<p>↓</p>
<p>use Rector rule:</p>
<pre><code class="language-php">use Rector\CodingStyle\Rector\Catch_\CatchExceptionNameMatchingTypeRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;rule(CatchExceptionNameMatchingTypeRector::class);
};</code></pre>
<h2 id="5-Match-Property-and-Variable-to-its-Type">5. Match Property and Variable to its Type</h2>
<pre><code class="language-diff"> class SomeClass
 {
     /**
      * @var EntityManager
      */
-    private $eventManager;
+    private $entityManager;
-    public function __construct(EntityManager $eventManager)
+    public function __construct(EntityManager $entityManager)
     {
-        $this-&gt;eventManager = $eventManager;
+        $this-&gt;entityManager = $entityManager;
     }
 }</code></pre>
<p>Instead of <del><code>Symplify\CodingStandard\Fixer\Naming\PropertyNameMatchingTypeFixer</code></del> Fixer</p>
<p>↓</p>
<p>use Rector rule:</p>
<pre><code class="language-php">use Rector\Naming\Rector\Class_\RenamePropertyToMatchTypeRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;set(RenamePropertyToMatchTypeRector::class);
};</code></pre>
<h2 id="6-Set-Default-Values-to-bool-and-array-Type-to-Prevent-Undefined-Value">6. Set Default Values to bool and array Type to Prevent Undefined Value</h2>
<pre><code class="language-diff"> class SomeClass
 {
     /**
      * @var bool
      */
-    private $isDisabled;
+    private $isDisabled = false;

     /**
      * @var int[]
      */
-    private $values;
+    private $values = [];

     public function isEmpty()
     {
         return $this-&gt;values === [];
     }
 }</code></pre>
<p>Instead of:</p>
<ul>
<li><del><code>Symplify\CodingStandard\Fixer\Property\BoolPropertyDefaultValueFixer</code></del></li>
<li><del><code>Symplify\CodingStandard\Fixer\Property\ArrayPropertyDefaultValueFixer</code></del></li>
</ul>
<p>↓</p>
<p>use Rector rules:</p>
<pre><code class="language-php">use Rector\CodingStyle\Rector\Class_\AddArrayDefaultToArrayPropertyRector;
use Rector\SOLID\Rector\Property\AddFalseDefaultToBoolPropertyRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;rule(AddFalseDefaultToBoolPropertyRector::class);
    $rectorConfig-&gt;rule(AddArrayDefaultToArrayPropertyRector::class);
};</code></pre>
<h2 id="7-Use-class-over-Strings-Names">7. Use <code>::class</code> over Strings Names</h2>
<p>This feature is here since PHP 5.5, and it's a massive help for static analysis and instant migrations.</p>
<pre><code class="language-diff"> class AnotherClass
 {
 }

 class SomeClass
 {
     public function run()
     {
-        return 'AnotherClass';
+        return \AnotherClass::class;
     }
 }</code></pre>
<p>Instead of <del><code>Symplify\CodingStandard\Fixer\Php\ClassStringToClassConstantFixer</code></del> Fixer:</p>
<p>↓</p>
<p>use Rector rule:</p>
<pre><code class="language-php">use Rector\Php55\Rector\String_\StringClassNameToClassConstantRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;rule(StringClassNameToClassConstantRector::class);
};</code></pre>
<h2 id="8-Order-Property-by-Complexity-Private-Methods-by-Use">8. Order Property by Complexity, Private Methods by Use</h2>
<p>How do you order your methods? Random?</p>
<p><strong>Be sure to read <a href="/blog/2018/11/01/how-teach-your-team-private-method-sorting-in-3-mins/">How to Teach Your Team Private Method Sorting in 3 mins</a>.</strong></p>
<p>Instead of:</p>
<ul>
<li><del><code>Symplify\CodingStandard\Fixer\Order\PrivateMethodOrderByUseFixer</code></del></li>
<li><del><code>Symplify\CodingStandard\Fixer\Order\PropertyOrderByComplexityFixer</code></del></li>
</ul>
<p>↓</p>
<p>use Rector rules:</p>
<pre><code class="language-php">use Rector\Order\Rector\Class_\OrderPrivateMethodsByUseRector;
use Rector\Order\Rector\Class_\OrderPropertyByComplexityRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;set(OrderPrivateMethodsByUseRector::class);
    $rectorConfig-&gt;set(OrderPropertyByComplexityRector::class);
};</code></pre>
<h2 id="9-Specific-Order-By-Parent-Contract">9. Specific Order By Parent Contract</h2>
<p>*Update: this rule was removed since Rector 0.9+ as not very useful in everyday coding.</p>
<h2 id="10-Make-Classes-final-if-You-Can">10. Make Classes <code>final</code>, if You Can</h2>
<p>This will be the biggest added value, as tokens have no idea if your class is extended by another class.</p>
<p>Rector knows that, so be ready for more solid code after you run it.</p>
<p>Instead of <del><code>Symplify\CodingStandard\Fixer\Solid\FinalInterfaceFixer</code></del> Fixer:</p>
<p>↓</p>
<p>use Rector rule:</p>
<pre><code class="language-php">use Rector\SOLID\Rector\Class_\FinalizeClassesWithoutChildrenRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;rule(FinalizeClassesWithoutChildrenRector::class);
};</code></pre>
<p><br></p>
<p>And that's it. Now you're ready!</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/05/11/how-to-upgrade-to-symplify-8-from-fixers-to-rector-rules</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 11 May 2020 00:00:00 +0000</pubDate>
                                    <updated>2021-12-01UTC00:00:000</updated>
                    <atom:updated>Wed, 01 Dec 2021 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Wed, 01 Dec 2021 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/05/11/how-to-upgrade-to-symplify-8-from-fixers-to-rector-rules#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Upgrade to Symplify 8 - From Sniffs to PHPStan Rules ]]></title>
                <link>https://tomasvotruba.com/blog/2020/05/04/how-to-upgrade-to-symplify-8-from-sniffs-to-phpstan-rules</link>
                <description><![CDATA[ <p>Since Symplify 7.3, you might notice a few deprecation notices in your coding standards. As Symplify 8 release is <a href="/blog/2017/10/30/what-can-you-learn-from-menstruation-and-symfony-releases/">synced with Symfony cycle</a>, both will be released at the end of May.
<br>
<br>
What to do with these deprecations? Why were these sniffs dropped? How to handle upgrades in 1 hour?</p> ]]></description>
                <content:encoded><![CDATA[ <p>When you run <a href="https://github.com/symplify/easy-coding-standard">ECS</a> with version 7.3+:</p>
<pre><code class="language-bash">vendor/bin/ecs check</code></pre>
<p>You might see such notices right before your code gets checked:</p>
<pre><code class="language-bash">PHP Notice:  Sniff "..." is deprecated. Use "..." instead</code></pre>
<h2 id="Why-were-These-Sniffs-Dropped">Why were These Sniffs Dropped?</h2>
<p>Symplify 7 used lots of sniffs based on coding standard <a href="https://www.php.net/manual/en/function.token-get-all.php">tokens</a>. In time they were made, they were as good. <a href="/blog/2018/10/25/why-ast-fixes-your-coding-standard-better-than-tokens/#shifting-the-scope">Tokens are best at spaces, abstract syntax tree is best at logical code structure</a>.</p>
<p>E.g. <code>TraitNameSniff</code> check name of traits and makes sure the name ends with &quot;Trait&quot;:</p>
<pre><code class="language-php">&lt;?php

// hey, this should be "ProductTrait"
trait Product
{
}</code></pre>
<p>Do you see any spaces or token positions? No, it's just:</p>
<ul>
<li>find a trait</li>
<li>check its name</li>
</ul>
<p>So writing this rule in tokens is the wrong tool chosen. Why? With tokens, you need to make sure:</p>
<ul>
<li>trait token is found</li>
<li>there are no spaces after trait token</li>
<li>detect the name</li>
<li>for other rules, resolve its fully qualified name based on the namespace and use imports (real hell with tokens)</li>
</ul>
<p>But <strong>why waste time on re-inventing the wheel</strong>, when we can use a tool that handles tedious work for us?
It's better to use <em>abstract syntax tree</em> technology, in this case <a href="https://phpstan.org">PHPStan</a>.</p>
<p><br></p>
<p><strong>That's why</strong> all the &quot;AST&quot; sniffs were migrated to PHPStan rules.</p>
<h2 id="What-to-do-With-These-Deprecations">What to do With These Deprecations?</h2>
<p>So what does it mean? Remove all the rules from <code>ecs.php</code> and let go?</p>
<p>No, <strong>all you need to do is switch to PHPStan rules</strong>. It's better working and more reliable since it works with context and not token positions. So at first, you might discover a few new reported errors here and there.</p>
<h2 id="How-to-Handle-Upgrade-in-1-hour">How to Handle Upgrade in 1 hour?</h2>
<p>There are 14 deprecated sniffs in total. Don't worry, while it might seem like a considerable number, the replacement is a matter of an hour.</p>
<p>Have you used a full Symplify set?</p>
<pre><code class="language-php">
// ecs.php
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\EasyCodingStandard\ValueObject\Set\SetList;

return function (ContainerConfigurator $containerConfigurator): void {
    $containerConfigurator-&gt;import(SetList::SYMPLIFY);
};</code></pre>
<p>Then you won't see any deprecations, because rules were removed from the config for you.
Still, I recommend adding these rules to <code>phpstan.neon</code>.</p>
<h2 id="1-Abstract-Trait-and-Interface-Naming-Sniffs">1. Abstract, Trait and Interface Naming Sniffs</h2>
<p>These rules were removed:</p>
<ul>
<li><del><code>Symplify\CodingStandard\Sniffs\Naming\AbstractClassNameSniff</code></del></li>
<li><del><code>Symplify\CodingStandard\Sniffs\Naming\TraitNameSniff</code></del></li>
<li><del><code>Symplify\CodingStandard\Sniffs\Naming\InterfaceNameSniff</code></del></li>
</ul>
<p>and replaced by:</p>
<p>↓</p>
<pre><code class="language-bash">composer require --dev slam/phpstan-extensions</code></pre>
<pre><code class="language-yaml"># phpstan.neon
rules:
    - SlamPhpStan\ClassNotationRule</code></pre>
<h2 id="2-Cognitive-Complexity">2. Cognitive Complexity</h2>
<p>The <a href="/blog/2018/05/21/is-your-code-readable-by-humans-cognitive-complexity-tells-you/">only <del>sniff</del> rule your coding standard should have</a>... just got better.</p>
<p>The orifinal sniffs were removed:</p>
<ul>
<li><del><code>Symplify\CodingStandard\Sniffs\CleanCode\CognitiveComplexitySniff</code></del></li>
<li><del><code>Symplify\CodingStandard\Sniffs\CleanCode\ClassCognitiveComplexitySniff</code></del></li>
</ul>
<p>and replaced by more avanced AST in form of PHPStan rules:</p>
<p>↓</p>
<pre><code class="language-yaml"># phpstan.neon
includes:
    - vendor/symplify/coding-standard/packages/cognitive-complexity/config/cognitive-complexity-rules.neon

# if you use default value, you can skip this section
parameters:
    symplify:
        max_cognitive_complexity: 10
        max_class_cognitive_complexity: 60</code></pre>
<h2 id="3-Make-sure-Classes-used-in-at-param-at-var-and-at-return-Exists">3. Make sure Classes used in @param, @var and @return Exists</h2>
<ul>
<li><del><code>Symplify\CodingStandard\Sniffs\Commenting\AnnotationTypeExistsSniff</code></del></li>
</ul>
<p>Just drop it. PHPStan level 0 handles this.</p>
<h2 id="4-Forbidden-Static-Explicit-Static">4. Forbidden Static → Explicit Static</h2>
<p>Static functions <a href="/blog/2019/04/01/removing-static-there-and-back-again/">are best way to slowly create technical dept</a>. But sometimes it's tough to code without them.</p>
<p>So instead of forbidding them:</p>
<ul>
<li><del><code>Symplify\CodingStandard\Sniffs\CleanCode\ForbiddenStaticFunctionSniff</code></del></li>
</ul>
<p>↓</p>
<p>Just be honest about them:</p>
<pre><code class="language-yaml"># phpstan.neon
rules:
    - Symplify\CodingStandard\Rules\NoClassWithStaticMethodWithoutStaticNameRule</code></pre>
<p>The same way you see a &quot;trait&quot; in a file name and know it's a trait,
this rule makes sure that classes with static methods have &quot;static&quot; in its name.</p>
<p>I've been using it for 4 days, and oh, what a shame I feel when I want to use a &quot;Static&quot; &quot;service&quot;. It <strong>makes me think twice both about the design and consequences</strong>.</p>
<h2 id="5-Forbidden-Parent-Class">5. Forbidden Parent Class</h2>
<p>Even though it's repeated over, again and again, that composition beats inheritance, the PHP code I see is full of it.</p>
<p>Sometimes the only way to <a href="/blog/2017/10/16/how-to-use-repository-with-doctrine-as-service-in-symfony/">promote so-far-the-best practise</a>, is to enforce it.</p>
<ul>
<li><del><code>Symplify\CodingStandard\Sniffs\CleanCode\ForbiddenParentClassSniff</code></del></li>
</ul>
<p>↓</p>
<pre><code class="language-yaml"># phpstan.neon
rules:
    - Symplify\CodingStandard\Rules\ForbiddenParentClassRule

parameters:
    symplify:
        forbidden_parent_classes:
            - 'Doctrine\ORM\EntityRepository'</code></pre>
<h2 id="6-Use-Custom-Exceptions-over-Basic-Ones">6. Use Custom Exceptions over Basic Ones</h2>
<ul>
<li><del><code>Symplify\CodingStandard\Sniffs\Architecture\ExplicitExceptionSniff</code></del></li>
</ul>
<p>↓</p>
<pre><code class="language-yaml"># phpstan.neon
rules:
    - Symplify\CodingStandard\Rules\NoDefaultExceptionRule</code></pre>
<h2 id="7-Prefer-One-Class-over-Another">7. Prefer One Class over Another</h2>
<ul>
<li><del><code>Symplify\CodingStandard\Sniffs\Architecture\PreferredClassSniff</code></del></li>
</ul>
<p>↓</p>
<pre><code class="language-yaml"># phpstan.neon
parameters:
    symplify:
        old_to_preffered_classes:
            DateTime: 'Nette\Utils\DateTime'

rules:
    - Symplify\CodingStandard\Rules\PreferredClassRule</code></pre>
<h2 id="8-No-Duplicated-Short-Classes">8. No Duplicated Short Classes</h2>
<ul>
<li><del><code>Symplify\CodingStandard\Sniffs\Architecture\DuplicatedClassShortNameSniff</code></del></li>
</ul>
<p>↓</p>
<pre><code class="language-yaml"># phpstan.neon
rules:
    - Symplify\CodingStandard\Rules\NoDuplicatedShortClassNameRule</code></pre>
<h2 id="9-Use-explicit-Return-over-and-amp-Reference">9. Use explicit Return over <code>&amp;</code> Reference</h2>
<ul>
<li><del><code>Symplify\CodingStandard\Sniffs\CleanCode\ForbiddenReferenceSniff</code></del></li>
</ul>
<p>↓</p>
<pre><code class="language-yaml"># phpstan.neon
rules:
    - Symplify\CodingStandard\Rules\NoReferenceRule</code></pre>
<h2 id="10-Don-t-leave-dump-Function-in-the-Code">10. Don't leave <code>dump()</code> Function in the Code</h2>
<ul>
<li><del><code>Symplify\CodingStandard\Sniffs\Debug\DebugFunctionCallSniff</code></del></li>
</ul>
<p>↓</p>
<pre><code class="language-yaml"># phpstan.neon
rules:
    - Symplify\CodingStandard\Rules\NoDebugFuncCallRule</code></pre>
<h2 id="11-Respect-Naming-of-Your-Parents">11. Respect Naming of Your Parents</h2>
<ul>
<li><del><code>Symplify\CodingStandard\Sniffs\Naming\ClassNameSuffixByParentSniff</code></del></li>
</ul>
<p>↓</p>
<pre><code class="language-yaml"># phpstan.neon
rules:
    - Symplify\CodingStandard\Rules\ClassNameRespectsParentSuffixRule

parameters:
    symplify:
        parent_classes:
            - Rector</code></pre>
<p>And that's it! You've just migrated all deprecated sniffs to PHPStan rules. Upgrade to Symplify 8 will be a piece of cake for you.</p>
<p><br></p>
<p><a href="/blog/2020/05/11/how-to-upgrade-to-symplify-8-from-fixers-to-rector-rules/">In the next post, we'll look on the 2nd half</a> - <strong>how to migrate fixers into Rector rules</strong>.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/05/04/how-to-upgrade-to-symplify-8-from-sniffs-to-phpstan-rules</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 04 May 2020 00:00:00 +0000</pubDate>
                                    <updated>2020-08-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Aug 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Aug 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/05/04/how-to-upgrade-to-symplify-8-from-sniffs-to-phpstan-rules#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Forget Complex Migrations, Use Cleaning Lady Checklist ]]></title>
                <link>https://tomasvotruba.com/blog/2020/04/27/forget-complex-migrations-use-cleaning-lady-checklist</link>
                <description><![CDATA[ <p>Migration of legacy code base is a complex process. If we <a href="/blog/2020/04/13/how-to-migrate-spaghetti-to-304-symfony-5-controllers-over-weekend/">migrate spaghetti</a>, <a href="/blog/2019/08/26/how-we-migrated-54-357-lines-of-code-nette-to-symfony-in-2-people-under-80-hours/">one framework to another</a> or <a href="/blog/2019/12/09/how-to-get-rid-of-technical-debt-or-what-we-would-have-done-differently-2-years-ago/">remove dead-code from 120 k-lines project</a>.
<br>
<br>
<em>It's long, it's hard, it takes an expert to do it...</em> that's bullshit. <strong>It should be simple, easy to understand and clear.</strong> Like the code we strive to write.
<br>
<br>
How <strong>could any programmer start migration today</strong> without any daunting studying?</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Simplicity-beats-Unread-Knowledge">Simplicity beats Unread Knowledge</h2>
<p>I wrote few sum-up posts about migrations in general:</p>
<ul>
<li><a href="/blog/2019/12/16/8-steps-you-can-make-before-huge-upgrade-to-make-it-faster-cheaper-and-more-stable/">8 Steps You Can Make Before Huge Upgrade to Make it Faster, Cheaper and More Stable</a></li>
<li><a href="/blog/2019/12/23/5-things-i-improve-when-i-get-to-new-repository/">5 Things I Improve when I Get to new Repository</a></li>
</ul>
<p>If you have 6 and 4 minutes to read them, read them. They sum up the experience that you can apply to most PHP projects.
But most people don't have 10 minutes to spare.</p>
<p><br></p>
<p>I don't. <strong>I have 30 seconds to solve my problem</strong>.</p>
<p><br></p>
<blockquote class="blockquote text-center">
    "If you can't explain it simply,<br>
    you don't understand it well enough."

    <footer class="blockquote-footer">Albert Einstein</footer>
</blockquote>
<p><br></p>
<h2 id="Look-for-a-Pattern">Look for a Pattern</h2>
<p>When there is a new project to migrate or upgrade, I cooperate with the in-house team to perform the migration together.</p>
<p>After 15-20 such projects, I've noticed a pattern:</p>
<ul>
<li>same steps <strong>repeat</strong> over and over again</li>
<li>those steps can be <strong>split into smaller steps</strong></li>
<li>these steps can be <strong>done me or by the team</strong> (usually 50:50)</li>
<li>they're <strong>must have before Rector migration</strong> I have to handle</li>
<li>somebody wrote a great post about <em>Why</em> or <em>How</em> to do these steps, so even <a href="/blog/2020/03/02/we-do-not-need-senior-developers-we-need-senior-code-bases/">a junior</a> can handle them</li>
<li>I mention these steps in 1st step - project feedback over and over again</li>
</ul>
<p><br></p>
<p>I was running towards sunset this Saturday, and a simple idea came to me. It felt great and made sense, so I sprint back to my home to scratch it down and <a href="https://twitter.com/VotrubaT/status/1254188338581471232">shared it with you</a>.</p>
<p><br></p>
<p>2 hours later... voilá 🎉</p>
<img src="/assets/images/posts/2020/checklist_overview.png" alt="" class="img-thumbnail">
<h2 id="How-to-use-it">How to use it?</h2>
<ul>
<li>Fill in your project and <strong>activate it</strong></li>
<li><strong>Check what you've done</strong> (or what you don't need)</li>
<li>The name of project ~= namespace for cache storage, so items are stored per project</li>
<li>It uses local storage of your browser, so no-one will steal your data</li>
</ul>
<img src="/assets/images/posts/2020/checklist_howto.gif" alt="" class="img-thumbnail">
<p><br></p>
<p>KISS!</p>
<p><br></p>
<p>The checklist is my first non-PHP application in years, and I need your feedback to make it better.</p>
<p><strong>Let me know how you use it or what steps you miss</strong>.
Keep in mind these steps should generally be relevant to most PHP projects.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/04/27/forget-complex-migrations-use-cleaning-lady-checklist</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 27 Apr 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/04/27/forget-complex-migrations-use-cleaning-lady-checklist#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Hydrate Arrays to Objects via Constructor ]]></title>
                <link>https://tomasvotruba.com/blog/2020/04/20/how-to-hydrate-arrays-to-objects-via-constructor</link>
                <description><![CDATA[ <p>One technology evolution sparks naturally another one. When electricity became accessible to masses, a huge industry of home-electric tools became possible. Like this tool, I currently write on.
<br><br>
The same thing happens in software, just exponentially faster. Like tokens and AST sparked <a href="/blog/2018/10/22/brief-history-of-tools-watching-and-changing-your-php-code/">tools that change your code</a>.
<br><br>
Recently, I introduced <a href="/blog/2020/03/16/statie-is-dead-long-live-symfony-static-dumper/">Symfony Static Dumper</a> that uses YAML to store data in your Symfony application. You where this goes... how can <strong>we turn this YAML into objects</strong>?</p> ]]></description>
                <content:encoded><![CDATA[ <p><em>Disclaimer: this post is not about array vs. object performance. If you still prefer arrays, check this <a href="https://www.slideshare.net/nikita_ppv/php-performance-trivia/31">talk by Nikita Popov</a> that changed my mind.</em></p>
<p><br></p>
<p>This post is about the luxury of <strong>object IDE autocompletion</strong> everywhere in your code. And how to make it happen, <strong>when all you have in the start are arrays</strong> (JSON, YAML...).</p>
<p><br></p>
<p>Do you work with Doctrine entities? Then you're probably used to <a href="/blog/2017/10/16/how-to-use-repository-with-doctrine-as-service-in-symfony/">use Repository service</a> and Entity object:</p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace Pehapkari\Blog\Repository;

use App\Entity\Post;
use Doctrine\Persistence\ObjectRepository;
use Doctrine\ORM\EntityManagerInterface;

final class PostRepository
{
    private ObjectRepository $repository;

    public function __construct(EntityManagerInterface $entityManager)
    {
        $this-&gt;repository = $entityManager-&gt;getRepository(Post::class);
    }

    /**
     * @return Post[]
     */
    public function fetchAll(): array
    {
        return $this-&gt;repository-&gt;fetchAll();
    }
}</code></pre>
<p>Then we can <strong>use reliable objects</strong> everywhere in application, like controllers:</p>
<pre><code class="language-php">final class BlogController
{
    // ...

    public function __invoke(): Response
    {
        return $this-&gt;render('blog/post.twig', [
            'posts' =&gt; $this-&gt;postRepository-&gt;fetchAll(),
        ]);
    }
}</code></pre>
<p>And we also have <strong>autocomplete in TWIG templates</strong> (thanks to <a href="/blog/2018/08/23/9-features-of-symfony-plugin-you-should-not-miss-in-gifs/">amazing</a> <a href="/blog/2019/01/28/2-files-that-your-symfony-application-misses">Symfony plugin</a>/):</p>
<img src="/assets/images/posts/2020/easy_hydrator_twig.png" class="img-thumbnail">
<h2 id="What-now-with-all-the-Arrays">What now with all the Arrays?</h2>
<p>Each local PHP community produces videos, livestreams, or talk recordings. We make such videos too, and we store them in YAML format. How can we get objects from that?</p>
<p>Let's use the most straightforward example possible.</p>
<h3 id="1-The-Data">1. The Data</h3>
<pre><code class="language-yaml">parameters:
    videos:
        -
            title: 'How to Hydrate objects to Arrays'
            created_at: '2020-04-20'</code></pre>
<h3 id="2-The-Value-Object">2. The Value Object</h3>
<p>In the application, we want to use an object:</p>
<ul>
<li>with strict and reliable types,</li>
<li>autocompletion of methods</li>
<li>and clear API (e.g., values of this object should no be changed).</li>
</ul>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\ValueObject;

use DateTimeInterface;

final class Video
{
    private string $name;

    private DateTimeInterface $createdAt;

    public function __construct(string $name, DateTimeInterface $createdAt)
    {
        $this-&gt;name = $name;
        $this-&gt;createdAt = $createdAt;
    }

    public function getName(): string
    {
        return $this-&gt;name;
    }

    public function getCreatedAt(): DateTimeInterface
    {
        return $this-&gt;createdAt;
    }
}</code></pre>
<h3 id="3-The-Goal">3. The Goal</h3>
<p>We want our application to be:</p>
<ul>
<li>open <strong>to future database switch</strong></li>
<li><strong>and have readable code</strong> for new developers - <a href="/blog/2020/03/09/art-of-letting-go/">less patterns is better</a></li>
</ul>
<p>Saying that, the code should look like <strong>1:1 to repositories</strong> we know from Doctrine:</p>
<pre><code class="language-php">final class VideoController
{
    // ...

    public function __invoke(): Response
    {
        return $this-&gt;render('video/videos.twig', [
            'videos' =&gt; $this-&gt;videoRepository-&gt;fetchAll(),
        ]);
    }
}</code></pre>
<h2 id="YAML-JSON-an-array">YAML, JSON... an array?</h2>
<p>You can hydrate input of guzzle, arrays from YAML <em>database</em>, or just local data in your PHP code.</p>
<p>This is how we solved our use case:</p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Repository;

use App\ValueObject\Video;
use Symplify\EasyHydrator\ArrayToValueObjectHydrator;

final class VideoRepository
{

    /**
     * @var Video[]
     */
    private $videos = [];

    public function __construct(
        array $videos,
        ArrayToValueObjectHydrator $arrayToValueObjectHydrator
    ) {
        $this-&gt;videos = $arrayToValueObjectHydrator-&gt;hydrateArrays($videos, Video::class);
    }

    /**
     * @return Video[]
     */
    public function fetchAll(): array
    {
        return $this-&gt;videos;
    }
}</code></pre>
<p>What is <code>Symplify\EasyHydrator\ArrayToValueObjectHydrator</code>? Its from new package <a href="https://github.com/symplify/easy-hydrator">symplify/easy-hydrator</a> that hydrates arrays to object. Easy.</p>
<p><br></p>
<h2 id="1-Step-to-Use-Easy-Hydrator">1 Step to Use Easy Hydrator</h2>
<pre><code class="language-bash">composer require symplify/easy-hydrator</code></pre>
<p>With Symfony Flex and <a href="https://github.com/symplify/symplify/blob/b41034f21c52105d9bb27160fdc189eaac140b98/packages/easy-hydrator/composer.json#L5">type in <code>composer.json</code></a>, this section became boring.</p>
<p>Then require <code>Symplify\EasyHydrator\ArrayToValueObjectHydrator</code> in the constructor and use it anywhere.</p>
<h2 id="4-Features-of-Easy-Hydrator">4 Features of Easy Hydrator</h2>
<h3 id="1-Handles-DateTime-and-int-retypes">1. Handles <code>DateTime</code> and <code>int</code> retypes</h3>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

final class Person
{
    // ...
    public function __construct(string $name, int $age, DateTimeInterface $metAt)
    {
        // ...
    }
}

$person = $this-&gt;arrayToValueObjectHydrator-&gt;hydrateArray([
    'name' =&gt; 'Tom',
    // will be retyped to int
    'age' =&gt; '30',
    // will be retyped to DateTimeInterface
    'metAt' =&gt; '2020-02-02',
], Person::class);</code></pre>
<h3 id="2-PHP-7-4-support">2. PHP 7.4 support</h3>
<p>Typed properties + initialized are must-have. PHP 7.4 is around for ~6 months now, and people use this feature.</p>
<p>I also looked at <a href="https://github.com/Ocramius/GeneratedHydrator">Ocramius/GeneratedHydrator</a> and tried to use it, but it doesn't work with PHP 7.4 objects correctly.</p>
<h3 id="3-Constructor-Injection-Only">3. Constructor Injection Only</h3>
<p>This package tries to be 1:1 with the rest of the clean code, so <strong>hydrated object must use constructor injection</strong>. Private property reflection magic won't work here.</p>
<h3 id="4-Easy">4. Easy</h3>
<p>This package hydrates arrays to object via constructor. Nothing more, nothing less.
It's for easy and clear use.</p>
<p>I use it in 3 PHP projects now and works great. Also we could get rid of <em>fake object</em> that only autocomplete twig and stopped relying on <code>$video['title']</code> or <code>$video['name']</code> guessing all over the code. Win win :)</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/04/20/how-to-hydrate-arrays-to-objects-via-constructor</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 20 Apr 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/04/20/how-to-hydrate-arrays-to-objects-via-constructor#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Migrate Spaghetti to 304 Symfony 5 Controllers Over Weekend ]]></title>
                <link>https://tomasvotruba.com/blog/2020/04/13/how-to-migrate-spaghetti-to-304-symfony-5-controllers-over-weekend</link>
                <description><![CDATA[ <p>During Easter weekend, usually, people take a break and have a rest. Instead, we used these 4 days of <em>holiday</em> to migrate the 304-controller application. At least that was the goal on Friday.
<br><br>
Me in my colleague in the migrated project accepted the challenge. We got into many minds and code-traps. We'd like to share this experience with you and <strong>inspire those who are still stuck on non-MVC code</strong> and think it might take weeks or even months to switch to a framework.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="What-is-the-Goal">What is the Goal?</h2>
<p>❌ <strong>We didn't want a  hybrid</strong> with static dependency injection container, legacy controller, request separation for new website and for old website. It only creates more legacy code than in the beginning.</p>
<p>❌✅ <strong>We were ok with</strong> keeping original business logic code untouched. We will handle spaghetti decoupling to Controller and Twig in the next phase. This was just a 1st step of many.</p>
<p>✅ <strong>We wanted</strong> to be able to use Symfony dependency injection, Twig templates, Controller rendering, Symfony Security, Events, Repository, connection to database, <code>.env</code>, Flex, Bundles, YAML configs, <a href="/blog/2020/02/17/local-packages-3-years-later/">local packages</a>.</p>
<p>✅ <strong>We wanted automate</strong> everything that is possible to automate.</p>
<p>✅ <strong>We wanted to run</strong> on Symfony 5.0 and PHP 7.4.</p>
<p>✅ <strong>We wanted to write</strong> any future code as if in any other Symfony application without going back.</p>
<p><br></p>
<p>Well, we wanted a full-stack framework, as you can find in <a href="https://github.com/symfony/demo">symfony/demo</a>.</p>
<p>Isn't that too much for one weekend? 😂</p>
<blockquote class="blockquote text-center">
"Only those who attempt the absurd can achieve the impossible."

<footer class="blockquote-footer">Albert Einstein</footer>
</blockquote>
<p>Honestly, I'm just <strong><a href="https://blog.codinghorror.com/how-to-be-lazy-dumb-and-successful">freaking lazy</a></strong> to do work for a longer time than a few days (in a row).</p>
<h2 id="The-Application-in-The-Start">The Application in The Start</h2>
<p>So how does the application look like?</p>
<p><a href="https://symfony.com/doc/current/controller.html">Symfony documentation describes</a> <strong>a controller</strong> as <em>a PHP function you create that reads information from the Request object and creates and returns a Response object</em>. In our case, the &quot;Request object&quot; was an entry URL, &quot;Response object&quot; was spaghetti rendered as <code>echo "string";</code>.</p>
<p>Saying that the application had:</p>
<ul>
<li>304 &quot;controllers&quot;</li>
<li>templating done directly in the file with inlined PHP in HTML</li>
<li>base <em>layout</em> done with <code>include "header.php";</code></li>
<li>2 good old HTML frames, one for the menu - the other for the rest of application</li>
</ul>
<p><br></p>
<p>Typical <em>controller</em> looked like this:</p>
<pre><code class="language-php">&lt;?php
// contact.php

include 'header.php';

$content = get_data_from_database();

// 500 lines of spaghetti code

echo $content;</code></pre>
<h2 id="First-Make-a-Plan">First: Make a Plan</h2>
<p>The migration pull-request itself is just <strong>half of the work</strong>. First, we had to have <a href="/blog/2019/12/16/8-steps-you-can-make-before-huge-upgrade-to-make-it-faster-cheaper-and-more-stable/">coding standards, PSR-4 autoloading, PHPStan on level 8</a> etc. When I say PHPStan on level 8, we skipped those errors with 50+ cases.</p>
<p>The next half is <a href="/blog/2019/08/26/how-we-migrated-54-357-lines-of-code-nette-to-symfony-in-2-people-under-80-hours/">to have a full team on board</a> and have <strong>a clear plan</strong>.</p>
<h2 id="PHP-Template-in-Symfony-5">PHP Template in Symfony 5?</h2>
<p>We had a goal, so what's the plan? First, we wanted to switch PHP + HTML to controllers. Maybe we could use something like <a href="https://symfony.com/doc/4.4/templating/PHP.html">PHP templates</a> + render them with a controller?</p>
<p>The idea is great, except <strong>PHP templates were deprecated</strong> in Symfony 4 and <strong>removed</strong> in Symfony 5:</p>
<img src="/assets/images/posts/2020/symfonize_php_template_nope.png" class="img-thumbnail mt-3 mb-3">
<h2 id="Raw-Symfony-Application">Raw Symfony Application</h2>
<p>Hm, so what now? If it too huge, take something smaller. First, we need to actually have a Symfony project:</p>
<ul>
<li>
<p>remove <code>vendor</code></p>
</li>
<li>
<p>remove <code>composer.lock</code></p>
</li>
<li>
<p>install Symfony dependencies:</p>
</li>
</ul>
<pre><code class="language-bash">composer require symfony/asset symfony/cache symfony/console symfony/dotenv \
    symfony/flex symfony/framework-bundle symfony/http-foundation symfony/http-kernel \
    symfony/twig-bridge symfony/twig-bundle \
    symplify/autowire-array-parameter \
    symplify/package-builder twig/twig doctrine/cache symfony/security-core \
    symfony/security-bundle symfony/security-csrf doctrine/orm doctrine/doctrine-bundle \
    doctrine/annotations doctrine/common doctrine/dbal symfony/error-handler symfony/form</code></pre>
<ul>
<li>don't forget <code>dev</code> too:</li>
</ul>
<pre><code class="language-bash">composer require --dev symfony/maker-bundle symfony/web-profiler-bundle</code></pre>
<p>Few fixes of bundles installation that Flex missed, adding database credential to <code>.env.local</code> file to login into the database, and we're ready to continue <strong>with an uplifted spirit of success</strong>.</p>
<img src="/assets/images/posts/2020/symfonize_raw_run.png" class="img-thumbnail mt-3 mb-3">
<p>Soon to be <strong>demolished again by new problems</strong> we never faced before... Let's look at the controllers.</p>
<p><br></p>
<p>We wanted to use <a href="https://github.com/rectorphp/rector">Rector</a> to convert all the files to classic Symfony controllers.</p>
<p>The simple rule is: <code>&lt;filename&gt;.php</code></p>
<ul>
<li>route name: <code>filename</code></li>
<li>route path: <code>filename</code></li>
</ul>
<h2 id="What-Will-Be-Inside-Controller">What Will Be Inside Controller?</h2>
<p>Just simply copy-paste the spaghetti code first, maybe that will be enough:</p>
<pre><code class="language-php">&lt;?php

namespace App\Controller;

use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\Routing\Annotation\Route;
use Symfony\Component\HttpFoundation\Response;

final class ContactController extends AbstractController
{
    /**
     * @Route(path="contact", name="contact")
     */
    public function __invoke(): Response
    {
        $content = get_data_from_database();
        // 500 lines of spaghetti code

        // this won't work, we need to return Response object :/
        echo $content;
    }
}</code></pre>
<p>If the content would be echoed <strong>just once</strong>, we could use:</p>
<pre><code class="language-php">$content = get_data_from_database();
// 500 lines of spaghetti code

return new \Symfony\Component\HttpFoundation\Response($content);</code></pre>
<p>But there is <code>echo</code> all over the place - like <strong>50 times in those 500 lines of spaghetti code</strong>.</p>
<p><br></p>
<p>Then we remembered, there are <code>ob_*</code> functions <strong>that collect echoed content, but don't show it</strong>. If we wrap the spaghetti and get content with <code>ob_get_contents()</code> in the end, it might work.</p>
<pre><code class="language-php">ob_start();

// 500 lines of spaghetti code

$content = (string) ob_get_contents();
ob_end_clean();
return new \Symfony\Component\HttpFoundation\Response($content);</code></pre>
<p><br></p>
<p>4 hours of writing a Rector rule for the migration and voilá - we had <strong>304 new Symfony controllers</strong>:</p>
<pre><code class="language-php">&lt;?php

namespace App\Controller;

use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\Routing\Annotation\Route;
use Symfony\Component\HttpFoundation\Response;

final class ContactController extends AbstractController
{
    /**
     * @Route(path="contact", name="contact")
     */
    public function __invoke(): Response
    {
        ob_start();

        $content = get_data_from_database();
        // 500 lines of spaghetti code

        $content = (string) ob_get_contents();
        ob_end_clean();
        return new Response($content);
    }
}</code></pre>
<p>That wasn't that hard. Let's run the website to enjoy the fruits of Eden:</p>
<img src="/assets/images/posts/2020/symfonize_first_crash.png" class="img-thumbnail mt-3 mb-3">
<p>Hm, maybe we should <strong>update all the links from <code>contact.php</code> to <code>contact</code> routes</strong> in every PHP file too. Also, all 304 links to all controller we just converted.</p>
<h2 id="How-to-get-Base-Template-into-Templates">How to get Base Template into Templates?</h2>
<p>Now when you entered <code>https://localhost:8000/contact</code>, you saw the raw page. From cool Symfony controller, but still a raw page. <strong>We wanted to use Twig templates</strong>, so we could enjoy filters, helpers, global variables, assets, etc.</p>
<p><br></p>
<p>This was our goal:</p>
<pre><code class="language-php">&lt;?php

namespace App\Controller;

use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\Routing\Annotation\Route;
use Symfony\Component\HttpFoundation\Response;

final class ContactController extends AbstractController
{
    /**
     * @Route(path="contact", name="contact")
     */
    public function __invoke(): Response
    {
        return $this-&gt;render('controller/contact.twig');
    }
}</code></pre>
<p>In the end, that <code>__invoke</code> method is actually in every controller <strong>in this exact format</strong>. But we still <strong>miss one piece of the puzzle</strong>.</p>
<p>We also wanted to use normal <code>base.twig</code>, as we're used to in every MVC project:</p>
<pre><code class="language-twig">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
      {# some assets #}
   &lt;/head&gt;
   &lt;body&gt;
      &lt;div class="row"&gt;
         &lt;div class="col-4"&gt;
            {% include "_snippet/menu.twig" %}
         &lt;/div&gt;
         &lt;div class="col-8"&gt;
              {% block main %}
              {% endblock %}
           &lt;/div&gt;
       &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>What's inside the <code>controller/contact.twig</code>?</p>
<pre><code class="language-twig">{% extends "base.twig" %}

{% block main %}
    PHP? Spaghetti? Magic?
{% endblock %}</code></pre>
<p>How would <strong>you solve it</strong>? If you find a better way, let us know in the comments.</p>
<p><strong>Remember</strong>: no PHP in Twig templates and no going back to Symfony 4.</p>
<p><br>
<br>
<br></p>
<p>We came up with this trick:</p>
<pre><code class="language-twig">{% extends "base.twig" %}

{% block main %}
    {{ render(controller('App\\Controller\\ContractController::content')) }}
{% endblock %}</code></pre>
<p>In each controller there will be not only the <code>__invoke()</code> method, but also the <code>content</code> method:</p>
<pre><code class="language-php">&lt;?php

namespace App\Controller;

use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\Routing\Annotation\Route;
use Symfony\Component\HttpFoundation\Response;

final class ContactController extends AbstractController
{
    /**
     * @Route(path="contact", name="contact")
     */
    public function __invoke(): Response
    {
        return $this-&gt;render('controller/contact.twig');
    }

    /**
     * @Route(path="contact_content", name="contact_content")
     */
    public function content(): Response
    {
        ob_start();

        $content = get_data_from_database();
        // 500 lines of spaghetti code

        $content = (string) ob_get_contents();
        ob_end_clean();
        return new Response($content);
    }
}</code></pre>
<p>With this approach, we have all we wanted:</p>
<p>✅ <strong>We can</strong> use Symfony dependency injection, Twig templates, Controller rendering, Symfony Security, Events, Repository, connection to database, <code>.env</code>, Flex, Bundles, YAML configs, <a href="/blog/2020/02/17/local-packages-3-years-later/">local packages</a>.</p>
<p>✅ <strong>We can to write</strong> any future code as if in any other Symfony application without going back.</p>
<p><br></p>
<p>To add chery on top, we added Symfony login:</p>
<img src="/assets/images/posts/2020/symfonize_logged_in.png" class="img-thumbnail mt-3 mb-3">
<p>And that's it!</p>
<h3 id="Blind-Paths-to-Avoid">Blind Paths to Avoid</h3>
<ul>
<li>don't go to Symfony 5.1-dev, stay with <strong>stable Symfony 5.0</strong> - the install of dev packages is very slow both on CI and locally</li>
<li>don't go to Symfony 4 just to use PHP templates; it's just postponing the problem + adding more legacy code</li>
<li>don't rush to PHP 7.4 before migration is finished, for the migration start <strong>PHP 7.2</strong> is good enough (ECS and Rector need it as minimal version)</li>
</ul>
<h3 id="Caveats">Caveats</h3>
<ul>
<li>do <a href="/blog/2019/12/16/8-steps-you-can-make-before-huge-upgrade-to-make-it-faster-cheaper-and-more-stable/">8 Steps You Can Make Before Huge Upgrade to Make it Faster, Cheaper and More Stable</a> first</li>
<li><strong>have a strict deadline</strong> - our original plan was the end of May, but when Easter came, we couldn't resist</li>
<li><strong>don't fall in the bait of manual refactoring</strong> of that one thing in the code you don't like - <strong>stay focused on the migration</strong> and improve code when the 1st step is finished and merged</li>
<li><strong>have a buddy</strong>, that helps you psychically when you're stuck - without a friend, this might turn into a nightmare of being stuck in circles; even only talking about the problem helps - it's better if it's somebody outside your normal work (consultant, old collegaue), so they're not stuck in your legacy project mindset</li>
<li><strong>be ok with broken code</strong> for a while, it's normal even with small changes</li>
<li>don't deploy code to the production, merge the PR as soon as possible, but test the application on a separate server at least for a week</li>
</ul>
<p><div class="card ml-4 mt-4 border-warning float-right post-snippet" style="width: 14em">
    <div class="card-body">
        Would you like to <strong>learn more about Rector</strong>? Step by step, from zero to hero?
        <br>

        <div class="text-center">
            <a href="/book/the-power-of-automated-refactoring/">
                <img src="/assets/images/rector_book.png" class="mb-3 mt-3 shadow">
                Get our new book
            </a>
        </div>
    </div>
</div>
</p>
<h2 id="The-Final-Plan">The Final Plan</h2>
<ul>
<li>install Symfony dependencies</li>
<li>add <code>bin/console</code>, <code>src/AppKernel.php</code> and <code>public/index.php</code> files</li>
<li>run base Symfony homepage</li>
<li>add credentials to <code>.env.local</code> and login to database</li>
<li>prepare migration rule to Symfony controllers and let Rector
<ul>
<li>migrate controllers</li>
<li>create <code>*</code> templates</li>
<li>create <code>*_content.twig</code> templates</li>
</ul></li>
<li>let Rector dump changed files into <code>old_controller_files.json</code></li>
<li>load data from <code>old_controller_files.json</code> and
<ul>
<li>use <code>preg_replace</code> in all files to replace <code>contact.php</code> to <code>contact</code>, files names to routes</li>
<li>delete old files</li>
</ul></li>
<li>delete <code>old_controller_files.json</code></li>
</ul>
<p><br></p>
<p>We made many mistakes, took many blind paths, so you don't have to (you can take new blind paths), but in the end, we made it from Friday till Monday - <strong>in 4 days</strong>:</p>
<img src="/assets/images/posts/2020/symfonize_merged.png" class="img-thumbnail mt-3 mb-3">
<p><strong>Are you still on a legacy project?</strong> What's your excuse that prevents your change for better?</p>
<p>If you have more questions, e.g., technical ones about the automated parts, let us know in the comments. We'll try to answer as best as we can.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/04/13/how-to-migrate-spaghetti-to-304-symfony-5-controllers-over-weekend</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 13 Apr 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/04/13/how-to-migrate-spaghetti-to-304-symfony-5-controllers-over-weekend#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Find Dead Symfony Routes ]]></title>
                <link>https://tomasvotruba.com/blog/2020/04/06/how-to-find-dead-symfony-routes</link>
                <description><![CDATA[ <p>Almost half a year ago, I spotted a post called <a href="https://laravel-news.com/route-usage-package-for-laravel">Route Usage Package for Laravel</a>. It's nice to have to see what routes are used and how often.
<br>
<br>
But when dealing with legacy code, knowing <strong>dead routes will save you dozens of hours in refactoring</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Why-are-Dead-Routes-Important-for-Your-Code">Why are Dead Routes Important for Your Code?</h2>
<p>If you know that 20 % is never used, you can <strong>drop it and ease your maintenance</strong>. Also, it's a must-have pre-step <a href="/blog/2019/12/16/8-steps-you-can-make-before-huge-upgrade-to-make-it-faster-cheaper-and-more-stable/">to code migrations</a>.</p>
<p><strong>Static analysis</strong> can help you with <a href="/blog/2019/03/18/how-to-detect-dead-php-code-in-code-review-in-7-snippets/">dead code that is never used</a> and with <a href="/blog/2019/03/14/remove-dead-public-methdos-from-your-code/">public methods that are never called</a>, e.g.:</p>
<pre><code class="language-diff">-$discount = $this-&gt;getDiscount();
 $productCategory = $this-&gt;categoryRepository-&gt;findCategoriesByProduct(
     $product-&gt;getCategory()
 );
 $discount = $this-&gt;getDiscount();</code></pre>
<p><br></p>
<blockquote class="blockquote text-center">
    10-20 % of code in most PHP code bases<br>
    is dead and can be deleted.
</blockquote>
<p>In this <a href="/blog/2019/12/09/how-to-get-rid-of-technical-debt-or-what-we-would-have-done-differently-2-years-ago/">case study from Spaceflow</a> project we worked in summer 2019, <strong>we removed ~20 % of the code... and nobody noticed</strong>.</p>
<img src="/assets/images/posts/2019/spaceflow_10_points/13.png" class="img-thumbnail">
<h2 id="Static-Analysis-of-Dead-Code-is-Not-Enough">Static Analysis of Dead Code is Not Enough</h2>
<p>It's quite easy to find dead calls, but when it comes to controller and API endpoints, it's a different game. Controller methods are public and are called by a framework.</p>
<p><strong>Static analysis won't tell us, which controller is used and which not.</strong> Also, the controller might call 2-3 other services... and they might call other services... and those could be dead too... <strong>welcome fractal of dead code we have to maintain.</strong> What now?</p>
<p>We'll have to use similar approach we used for <a href="/blog/2019/11/11/from-0-doc-types-to-full-type-declaration-with-dynamic-analysis/">From 0 Doc Types to Full Type Declaration</a>.</p>
<img src="/assets/images/posts/2020/dead_routes_branch.jpg" class="img-thumbnail mt-4 mb-2">
<p><em>Such branch is in your code... somewhere. Would you still water it for next couple years?</em></p>
<h2 id="Coffee-Shop-Static-vs-Dynamic-Analysis">Coffee Shop - Static vs. Dynamic Analysis</h2>
<p>Imagine you're a coffee franchise owner. Not just 1, but 30 coffee houses. Suddenly, there comes corona, and shops have to be locked down.
Luckily, you have an emergency fund to keep them running... well, just 15 of them. <strong>Which one you choose to close?</strong></p>
<p>Coffee shop with a property of specific size, location, number of chairs, and toilets - that's static analysis. It won't help us here. What if the shop with the smallest area is making more money than the biggest one?</p>
<p>Let's use <strong>dynamic analysis</strong> here - you <strong>measure data in time</strong> and decide based on it. E.g., income for last year from all of them compared to expenses to run them.</p>
<h2 id="2-Steps-to-add-Route-Usage-to-Your-Symfony-App">2 Steps to add Route Usage to Your Symfony App</h2>
<p>Inspired by the Laravel package, I've made a <a href="https://github.com/symplify/symfony-route-usage">Symfony Route Usage</a>.</p>
<h3 id="1-Install-it">1. Install it</h3>
<pre><code class="language-bash">composer require symplify/symfony-route-usage</code></pre>
<h3 id="2-Enable-Bundle">2. Enable Bundle</h3>
<pre><code class="language-php">// config/bundles.php
return [
    Symplify\SymfonyRouteUsage\SymfonyRouteUsageBundle::class =&gt; ['all' =&gt; true],
];</code></pre>
<p><br></p>
<p>Collect data for a couple of weeks (depends on the size of your site) and see for yourself, <strong>what routes have been used</strong>:</p>
<pre><code class="language-bash">bin/console show-route-usage</code></pre>
<p>↓</p>
<img src="/assets/images/posts/2020/dead_routes_used_routes.png" class="img-thumbnail mt-4 mb-2">
<p><br></p>
<h2 id="What-Routes-Have-Never-Been-Used">What Routes Have Never Been Used?</h2>
<p>Just run:</p>
<pre><code class="language-bash">bin/console show-dead-routes</code></pre>
<p>↓</p>
<img src="/assets/images/posts/2020/dead_routes_dead_routes.png" class="img-thumbnail mt-4 mb-2">
<p><br></p>
<p><strong>What about the performance?</strong> Pehapkari website takes 72 ms to load, of which 10 ms (13 %) is Symfony Route Visit. If that would be too much for your website, add partial logging by overloading <a href="https://github.com/symplify/symfony-route-usage/blob/master/src/EventSubscriber/LogRouteUsageEventSubscriber.php">the subscriber</a> - e.g., every 100th or 1000th request.</p>
<p><br></p>
<p>This package is freshly baked. Do you have some ideas how to make it better? Let me know ↓</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/04/06/how-to-find-dead-symfony-routes</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 06 Apr 2020 00:00:00 +0000</pubDate>
                                    <updated>2020-04-01UTC00:00:000</updated>
                    <atom:updated>Wed, 01 Apr 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Wed, 01 Apr 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/04/06/how-to-find-dead-symfony-routes#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Don&#039;t Show Your Privates to Public ]]></title>
                <link>https://tomasvotruba.com/blog/2020/03/30/dont-show-your-privates-to-public</link>
                <description><![CDATA[ <p>With typed properties in PHP 7.4, there comes <strong>a natural tendency for using properties as public</strong>. The type check is already there, right? It's a dangerous path that opens the door to static code with public properties everywhere, that is asking for a change in any place.
<br>
<br></p>
<p>But is that ok to show privates to the public?</p> ]]></description>
                <content:encoded><![CDATA[ <p>Last week you probably spotted <strong><a href="https://wiki.php.net/rfc/constructor_promotion">RFC: Constructor Promotion</a></strong> proposed by my favorite mentor <a href="https://github.com/nikic">Nikita Popov</a>. This RFC counters <em>public property by default</em> approach and <strong>reduces the redundant code at the same time</strong>.</p>
<p><br></p>
<p>Another counter point for public properties or methods nailed <a href="https://thephp.cc/company/consultants/stefan-priebsch">Stefan Priebsch</a>:</p>
<img src="/assets/images/posts/2020/privates_meme.jpg" class="img-thumbnail">
<h2 id="How-Many-Public-Methods-Has-Your-Project">How Many Public Methods Has Your Project?</h2>
<p>That meme had just 1 public method. But what about real projects?</p>
<p>To get <strong>real numbers from a real project</strong>, I run <a href="https://matthiasnoback.nl/2019/09/using-phploc-for-quick-code-quality-estimation-part-1">phploc</a> to measure size of <a href="https://github.com/rectorphp/rector">Rector's code</a>.</p>
<pre><code class="language-bash">phploc src packages rules --exclude tests</code></pre>
<p>These are <strong>the results</strong>:</p>
<pre><code class="language-bash">Size
  Non-Comment Lines of Code (NCLOC)              99033 (85.46%)

Structure
  Methods                                         5185
    Visibility
      Public Methods                              3516 (67.81%)</code></pre>
<p><br></p>
<p>Let's put 100 children in one square:</p>
<img src="/assets/images/posts/2020/privates_100_children.jpg" class="img-thumbnail">
<p>This <strong>is 3 500 children</strong>:</p>
<img src="/assets/images/posts/2020/privates_3500_children.jpg" class="img-thumbnail">
<p>There is <a href="https://github.com/rectorphp/rector/blob/master/docs/rector_rules_overview.md">~480 Rector rules</a>, each has 3 public methods required by interface contract. That's 1 500 public contract methods. Even if we remove thos, 3 500 - 1 500, we still have <strong>over 2 000 public methods</strong>:</p>
<img src="/assets/images/posts/2020/privates_2000_children.jpg" class="img-thumbnail">
<p>Good luck with getting all your 2 000 children to university... or bed ... or make them breakfast for them... for one day. No pressure, right?</p>
<h2 id="How-to-Take-Care-for-as-Few-Children-as-Possible">How to Take Care for as Few Children as Possible?</h2>
<p>We want to reduce the number of public methods to a minimum. How?</p>
<h3 id="1-A-Method-by-Method-Human-Refactoring">1. A Method by Method Human Refactoring</h3>
<p>We can go for a method by method refactoring with careful analysis if the method should be public or private and how we can change it to private. <strong>It takes time, patience, attention, human performance and doesn't scale on massive projects.</strong> That's way too expensive.</p>
<p>❌</p>
<p>What simpler way can we apply today on an any-sized project? What low hanging fruit can we focus on?</p>
<h3 id="2-Fake-Public-Method-Detection">2. Fake Public Method Detection</h3>
<p>What is <em>fake public</em> method, property, or constant?</p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

final class SomeController
{
    /**
     * @Route(path="/")
     */
    public function homepage()
    {
        return $this-&gt;prepareData();
    }

    public function prepareData(): array
    {
        return ['status' =&gt; 'quarantine'];
    }
}</code></pre>
<p>Can you see it?</p>
<pre><code class="language-diff">+public function prepareData(): array
-private function prepareData(): array</code></pre>
<p>✅</p>
<p><br></p>
<p>Same applies for constants and properties, that is <strong>used only locally in the class they're defined in</strong>:</p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

final class AirCleaner
{
    public const NAME = 'cleaner';

    public function getName()
    {
        return self::NAME;
    }
}</code></pre>
<pre><code class="language-diff">-public const NAME = 'cleaner';
+private const NAME = 'cleaner';</code></pre>
<p>✅</p>
<p>The most common <em>false publics</em> are constants because they're <a href="https://wiki.php.net/rfc/class_const_visibility">last that got visibility in PHP 7.1</a>.</p>
<h2 id="Why-Should-We-Care-about-Privatization">Why Should We Care about Privatization?</h2>
<p>&quot;Nice intellectual exercise, Tom, but nothing more,&quot; you may think, and close this post and go back to your quarantine work.</p>
<p>But remember our children:</p>
<blockquote class="blockquote text-center">
    A public method is like a child: Once you've written it,<br>
    you are going to maintain it for the rest of its life.
</blockquote>
<p>What happens if we don't care about it? Well, <strong><code>public</code> element is designed to be used somewhere else.</strong></p>
<p>Same way <code>static</code> method is a method to be used everywhere (and <a href="/blog/2018/04/26/how-i-got-into-static-trap-and-made-fool-of-myself">then slowly kill you</a>/).</p>
<p><br></p>
<p>It's easy to spot now because we focus on ten lines of code, we knew that's a controller method only, and that's a clear miss-use. But in the real world, <strong>we don't have so much time to think about 10 lines of code</strong>.</p>
<p><br></p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">10 lines of code = 10 issues.<br><br>500 lines of code = "looks fine."<br><br>Code reviews.</p>— I Am Devloper (@iamdevloper) <a href="https://twitter.com/iamdevloper/status/397664295875805184?ref_src=twsrc%5Etfw">November 5, 2013</a></blockquote>
<p><br></p>
<p>Limited attention span is one of the reasons. We had plenty of such potential <em>legacy back doors</em> in Rector:</p>
<img src="/assets/images/posts/2020/privates_sample.png" class="img-thumbnail">
<h2 id="Unused-Method">Unused Method</h2>
<p>Another reason is that <strong>the method is completely unused</strong>, but PHPStorm won't tell you because it is <code>public</code>. When we turned this method into <code>private</code>, we saw it's unused, and we got rid of it:</p>
<img src="/assets/images/posts/2020/privates_sample_2.png" class="img-thumbnail">
<h2 id="Not-Used-Method">Not-Used Method</h2>
<p>The effect of privatization is surprising. Take this case:</p>
<img src="/assets/images/posts/2020/privates_sample_3.png" class="img-thumbnail">
<p>How can the privatization of methods lead to more code? Easily. The method was <code>public</code>, but never used. After Rector run it was <code>private</code>, but never used and then removed... and that could work.</p>
<p>Actually, that was not a feature, it was a bug. <strong>This method should have been used many months ago.</strong> So we used it in the right place, the feature was complete, and potential future bug.</p>
<p><br></p>
<p>Do you want to know all the possible code changes?</p>
<p><a href="https://github.com/rectorphp/rector/pull/3084/commits/626287ec76ed16d15136115e1510b2154c2712a9" class="btn btn-dark btn-sm">
See pull-request
</a></p>
<h2 id="In-CI-pipeline-or-Won-t-Happen">In CI pipeline, or Won't Happen</h2>
<p>What now? Go to your code and check method one by one clicking on them in PHPStorm to <em>Find Usages</em>, if they're used somewhere else or <em>false public</em> and should be private. It will make your code much more robust and senior...</p>
<p><em>Just kidding</em>. Let Rector handle it with <code>PRIVATIZATION</code> set:</p>
<pre><code class="language-php">use Rector\Set\ValueObject\SetList;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;import(SetList::PRIVATIZATION);
};</code></pre>
<pre><code class="language-bash">vendor/bin/rector process src</code></pre>
<p>It has now 4 rules:</p>
<ul>
<li><strong>privatize local-only constant</strong></li>
<li><strong>privatize local-only property</strong></li>
<li><strong>privatize local-only method</strong></li>
<li><strong>privatize local getter to local property</strong></li>
</ul>
<p>Do you have an idea for another privatization rule? <a href="https://github.com/rectorphp/rector/issues/new?template=2_Feature_request.md">Let us know on GitHub</a>.</p>
<p>Stay lazy and alive!</p>
<p><br></p>
<p>Happy coding!</p>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/03/30/dont-show-your-privates-to-public</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 30 Mar 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/03/30/dont-show-your-privates-to-public#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Doctrine Entity Typed Properties With PHP 7.4 ]]></title>
                <link>https://tomasvotruba.com/blog/2020/03/23/doctrine-entity-typed-properties-with-php74</link>
                <description><![CDATA[ <p>Recently we've upgraded our <a href="https://pehapkari.cz">Czech PHP community website</a> to PHP 7.4. As a side effect, it broke most of our entities.
Do you love how making language more strict reveals weak points in your code just by using it?
<br>
<br>
Today we'll look at <strong>the impact of typed properties on weak points of Doctrine entities and how to solve them</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="The-Collections">The Collections</h2>
<p>In the Czech PHP community, we have skilled trainers that share their knowledge with others on training. We help them to share the knowledge by handling the tedious organization processes for them and let them enjoy the training day itself.</p>
<p>Each trainer has many trainings, so the <code>Trainer</code> entity looks like this in PHP 7.3-:</p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Entity;

use Doctrine\Common\Collections\Collection;
use Doctrine\ORM\Mapping as ORM;

/**
 * @ORM\Entity
 */
class Trainer
{
    /**
     * @ORM\OneToMany(targetEntity=Training::class, mappedBy="trainer")
     * @var Collection|Trainer[]
     */
    private $trainings = [];

    /**
     * @param Collection&lt;int, Training&gt;|Training[] $collection
     */
    public function setTrainings(array $collection): void
    {
        $this-&gt;trainings = $collection;
    }

    /**
     * @return Collection&lt;int, Training&gt;|Training[]
     */
    public function getTrainings(): iterable
    {
        return $this-&gt;trainings;
    }
}</code></pre>
<p>What can we say about this code?</p>
<ul>
<li>works in PHP 7.4</li>
<li>provides IDE enough information about types for autocomplete</li>
<li>makes PHPStan happy with types</li>
<li>...broke with PHP 7.4 typed properties :)</li>
</ul>
<p>How do we <strong>add property types without breaking everything</strong>?</p>
<h2 id="1-The-Property">1. The Property</h2>
<p>In PHP 7.4, <strong>the property is the king</strong> - the rest of the code has to respect the type, and it's the default value. Let's start with that.</p>
<pre><code class="language-diff"> /**
  * @ORM\OneToMany(targetEntity=Training::class, mappedBy="trainer")
  * @var Collection|Trainer[]
  */
-private $trainings = [];
+private array $trainings = [];
+private iterable $trainings = [];
+private Collection $trainings = [];</code></pre>
<p>What is the type here?</p>
<ul>
<li>1) <code>array $trainings = [];</code></li>
<li>2) <code>iterable $trainings = [];</code></li>
<li>3) <code>Collection $trainings = [];</code></li>
</ul>
<p>Pick one...</p>
<p><br>
<br>
<br></p>
<pre><code class="language-diff"> /**
  * @ORM\OneToMany(targetEntity=Training::class, mappedBy="trainer")
  * @var Collection&lt;int, Trainer&gt;|Trainer[]
  */
-private $trainings = [];
+private Collection $trainings = [];</code></pre>
<p>This one worked the best (= code worked).</p>
<p>But PHP 7.4 now complains that the <code>Collection</code> object cannot be <code>[]</code> by default.</p>
<pre><code class="language-diff"> /**
  * @ORM\OneToMany(targetEntity=Training::class, mappedBy="trainer")
  * @var Collection&lt;int, Trainer&gt;|Trainer[]
  */
-private Collection $trainings = [];
+private Collection $trainings;</code></pre>
<p>But PHP 7.4 now complains that it's <code>null</code> by default, so it has to nullable.</p>
<blockquote class="blockquote text-center">
If it's not enforced, nobody cares.
</blockquote>
<p>Here is where <em>best practices</em> become defaults. Do you know the &quot;<a href="https://www.doctrine-project.org/projects/doctrine-orm/en/2.7/reference/best-practices.html#initialize-collections-in-the-constructor">initialize collections in the constructor</a>&quot; best practice?</p>
<img src="/assets/images/posts/2020/typed_doctrine_properties_best_practise.png" class="img-thumbnail">
<p>This was an optional improvement to help Doctrine work in a more realiable way. Well, it <em>was</em>.
Now we <strong>have to use it</strong> to make our code work:</p>
<pre><code class="language-diff"> &lt;?php

 declare(strict_types=1);

 namespace App\Entity;

 use Doctrine\Common\Collections\ArrayCollection;
+use Doctrine\Common\Collections\Collection;
 use Doctrine\ORM\Mapping as ORM;

 /**
  * @ORM\Entity
  */
 class Trainer
 {
     // ...

+    public function __construct()
+    {
+        $this-&gt;trainings = new ArrayCollection();
+    }

     // ...
 }</code></pre>
<p>All right, we have the correct type, it's initialized in the constructor.</p>
<p>Our property is ready!</p>
<p><br></p>
<h2 id="2-Getter-Method">2. Getter Method?</h2>
<pre><code class="language-php">&lt;?php

// ...

/**
 * @return Collection&lt;int, Training&gt;|Training[]
 */
public function getTrainings(): iterable
{
    return $this-&gt;trainings;
}</code></pre>
<p>What about the return type? Look at the property type:</p>
<pre><code class="language-diff"> &lt;?php

 /**
  * @return Collection&lt;int, Training&gt;|Training[]
  */
-public function getTrainings(): iterable
+public function getTrainings(): Collection
 {
     return $this-&gt;trainings;
 }</code></pre>
<p>And we're ready to go!</p>
<h2 id="3-Setter-Method">3. Setter Method?</h2>
<p>I bet you handled this already from the top of your head, so let's compare:</p>
<pre><code class="language-diff"> &lt;?php

 /**
  * @param Collection&lt;int, Training&gt;|Training[] $trainings
  */
-public function setTrainings(array $trainings): void
+public function setTrainings(Collection $trainings): void
 {
     $this-&gt;trainings = $trainings;
 }</code></pre>
<p><br></p>
<p>Do you want to see real code? Look at the full pull request:</p>
<p><a href="https://github.com/pehapkari/pehapkari.cz/pull/297/files"></p>
<img src="/assets/images/posts/2020/typed_doctrine_properties_collection.png" class="img-thumbnail">
<p></a></p>
<h2 id="EasyAdminBundle">EasyAdminBundle?</h2>
<p>Have you tried <a href="https://github.com/EasyCorp/EasyAdminBundle">EasyAdminBundle</a> to delegate your full administration? If not, give it go.</p>
<p><strong>It creates data grids, forms, edit/update/add/delete controllers. All this with simple and beautiful UX. All you need to do is define your entities and register them in YAML config.</strong> I love it!</p>
<p><br></p>
<p>Huge thanks to <a href="https://github.com/javiereguiluz">Javier Eguiluz</a>, creator and maintainer of this bundle, who's also behind amazing <strong>690&nbsp;issues</strong> of <a href="https://symfony.com/blog/category/a-week-of-symfony">Weeks of Symfony</a>.</p>
<p><br></p>
<p>To make this all happen, the design choice is to allow every property to be nullable. Some people disagree and try to make EasyAdminBundle work with value objects. But they fail by killing the simplicity and re-inventing admin again.</p>
<blockquote class="blockquote text-center">
There are no best solutions, there are just trade offs.
</blockquote>
<p>So what does <em>every property is nullable</em> mean for PHP 7.4 typed properties?</p>
<pre><code class="language-diff">&lt;?php

declare(strict_types=1);

namespace App\Entity;

use Doctrine\ORM\Mapping as ORM;

/**
 * @ORM\Entity
 */
class Training
{
    /**
     * @ORM\Id()
     * @ORM\GeneratedValue()
     * @ORM\Column(type="integer")
-    * @var int
     */
-   private $id;
+   private ?int $id = null;

    // ...
}</code></pre>
<p>Do you prefer code over text? <a href="https://github.com/pehapkari/pehapkari.cz/pull/297/files">Here is the PHP 7.4 upgrade pull-request</a>.</p>
<h2 id="Upgrade-Instantly-with-Rector">Upgrade Instantly with Rector</h2>
<p>I did not do the upgrade pull-request myself (I'm way too lazy for that), <a href="https://getrector.org">Rector</a> did. Thanks to testing out Rector on Doctrine entities, its PHP 7.4 set got much more precise.</p>
<p><strong>Do you want to see how Rector can upgrade your code?</strong></p>
<ol>
<li>
<p>Install Rector</p>
<pre><code class="language-bash">composer require rector/rector --dev</code></pre>
</li>
<li>
<p>Create <code>rector.php</code> config</p>
</li>
</ol>
<pre><code class="language-php">use Rector\Doctrine\Set\DoctrineSetList;
use Rector\Set\ValueObject\SetList;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;import(SetList::PHP_74);

    // Protip: Do you want to update your `Collection` syntax for PHPStorm and PHPStan friendly?
    $rectorConfig-&gt;import(DoctrineSetList::DOCTRINE_CODE_QUALITY);
};</code></pre>
<p>If you got any troubles, <a href="https://github.com/rectorphp/rector/issues/new/choose">let us know on GitHub</a>. That's all, folks.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/03/23/doctrine-entity-typed-properties-with-php74</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 23 Mar 2020 00:00:00 +0000</pubDate>
                                    <updated>2020-11-01UTC00:00:000</updated>
                    <atom:updated>Sun, 01 Nov 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sun, 01 Nov 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/03/23/doctrine-entity-typed-properties-with-php74#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Statie is Dead, Long live Symfony Static Dumper ]]></title>
                <link>https://tomasvotruba.com/blog/2020/03/16/statie-is-dead-long-live-symfony-static-dumper</link>
                <description><![CDATA[ <p>Last week <a href="/blog/2020/03/09/art-of-letting-go/">I wrote about how Statie turned from a feature to a burden</a> and why we had to let it go.
<br>
<strong>What will replace it? How do you migrate?</strong></p> ]]></description>
                <content:encoded><![CDATA[ <p>Deprecations without replacements are like nails in the coffin of your forehead while reciting a poem about the beauty of life.</p>
<p>The <a href="https://github.com/tomasvotruba/friendsofphp.org">friendsofphp.org</a> and this blog <strong>still uses PHP and is deployed to GitHub pages</strong>. How is that possible without Statie?</p>
<p>From Statie, we <strong>fluently switch to brand new package - <a href="https://github.com/symplify/symfony-static-dumper">Symfony Static Dumper</a></strong>. A single command that <strong>generates HTML and CSS from your Symfony application.</strong></p>
<p><br></p>
<p>In short, it looks like this:</p>
<img src="/assets/images/posts/2020/dump_static_site_demo.gif" class="img-thumbnail">
<p><br></p>
<h2 id="Killer-Features">Killer Features?</h2>
<p>What I love the most about it, that the Symfony Static Dumper <strong>only handles the missing part - generate HTML and CSS</strong>. All the rest is up to you, your imagination. You code standard Symfony application, nothing special, nothing weird.</p>
<p>Do you want more advantages?</p>
<ul>
<li>no more Javascript to run the website ✅</li>
<li>we can use most of the Symfony Ecosystem ✅</li>
<li>we can use database, even Doctrine ✅</li>
<li>develop normal Symfony application, then dump the HTML + CSS on deploy ✅</li>
<li>standard Symfony app structure ✅</li>
<li>use <code>{{ path('contact') }}</code> in templates ✅</li>
<li>use Symfony plugin ✅</li>
<li>single command use ✅</li>
</ul>
<h2 id="How-to-Migrate-from-Statie-to-Symfony-Static-Site-Dumper">How to Migrate from Statie to Symfony Static Site Dumper?</h2>
<p>Do you still use Statie? Don't worry; we have a migration path for you.</p>
<h3 id="Add-Symfony-Packages">Add Symfony Packages</h3>
<p>First, you need to install Symfony packages:</p>
<pre><code class="language-bash">composer require symfony/http-foundation symfony/asset symfony/twig-bridge symfony/twig-bundle symfony/flex symfony/framework-bundle symfony/dotenv doctrine/cache erusev/parsedown-extra</code></pre>
<p>And replace the static generator:</p>
<pre><code class="language-bash">composer remove symplify/statie
composer require symplify/symfony-static-dumper</code></pre>
<h3 id="Setup-Basic-Symfony-App">Setup Basic Symfony App</h3>
<ul>
<li>add <a href="https://github.com/symfony/demo/blob/main/bin/console"><code>bin/console</code></a></li>
<li>add <a href="https://github.com/TomasVotruba/friendsofphp.org/blob/master/src/HttpKernel/FopKernel.php"><code>src/HttpKernel/YourAppKernel.php</code></a></li>
</ul>
<h3 id="Move-source">Move <code>/source</code></h3>
<ul>
<li>Templates to <code>/templates</code></li>
<li>Public content, e.g. <code>robots.txt</code> or <code>CNAME</code> to <code>/public</code></li>
</ul>
<h3 id="Update-CI">Update CI</h3>
<pre><code class="language-diff">-vendor/bin/statie generate source
+bin/console dump-static-site</code></pre>
<h3 id="Pages-to-Controller-Templates">Pages to Controller Templates</h3>
<p><strong>Before:</strong></p>
<pre><code class="language-twig">---
layout: "_layouts/default.twig"
title: "Thank You"
id: thank_you
commit_limit: 5
---

&lt;div class="container" id="contact"&gt;
    &lt;h1&gt;{{ title }}&lt;/h1&gt;

    &lt;p class="text-center bigger"&gt;&lt;/p&gt;
&lt;/div&gt;</code></pre>
<p><strong>After:</strong></p>
<pre><code class="language-twig">{# templates/thanky_you.twig #}
{% extends "default.twig" %}

{% block content %}
    &lt;div class="container" id="contact"&gt;
        &lt;h1&gt;{{ title }}&lt;/h1&gt;

        &lt;p class="text-center bigger"&gt;&lt;/p&gt;
    &lt;/div&gt;
{% endblock %}</code></pre>
<pre><code class="language-php">// src/Controller/ThankYouController.php
namespace YourWebsite\Controller;

use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Routing\Annotation\Route;

final class ThankYouController extends AbstractController
{
    /**
     * @Route(path="thank-you", name="thank_you")
     */
    public function __invoke(): Response
    {
        return $this-&gt;render('thank_you.twig', [
            'title' =&gt; 'Thank You',
            'id' =&gt; 'thank_you',
            'commit_limit' =&gt; 5,
        ]);
    }
}</code></pre>
<p>If you need more inspiration, look at these pull-requests:</p>
<ul>
<li><a href="https://github.com/TomasVotruba/tomasvotruba.com/pull/940">migration of TomasVotruba.com</a></li>
<li><a href="https://github.com/TomasVotruba/friendsofphp.org/pull/162">migration of FriendsOfPhp.org</a> - <a href="https://github.com/TomasVotruba/friendsofphp.org/pull/169">part #2</a></li>
</ul>
<h2 id="How-to-Set-it-Up">How to Set it Up?</h2>
<p>All the essential information is in <a href="https://github.com/symplify/symfony-static-dumper">README</a>.</p>
<p>Install the package via composer:</p>
<pre><code class="language-bash">composer require symplify/symfony-static-dumper</code></pre>
<p>Register services - no Flex, no bundles, just simple config:</p>
<pre><code class="language-yaml"># config/services.yaml
imports:
    - { resource: '../vendor/symplify/symfony-static-dumper/config/config.yaml' }</code></pre>
<p>And dump static website to <code>/output</code> directory:</p>
<pre><code class="language-bash">bin/console dump-static-website</code></pre>
<p>To see the website, just run the local server:</p>
<pre><code class="language-bash">php -S localhost:8001 -t output</code></pre>
<p>That's it!</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/03/16/statie-is-dead-long-live-symfony-static-dumper</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 16 Mar 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/03/16/statie-is-dead-long-live-symfony-static-dumper#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Art of Letting Go ]]></title>
                <link>https://tomasvotruba.com/blog/2020/03/09/art-of-letting-go</link>
                <description><![CDATA[ <p>Recently I come to a dead end with one of my projects. I felt it doesn't bring value to me, to people that use it, and to neither to the open-source community. I felt sour about it for the last 3 months, confused about what to do next.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="It-Works-For-a-Time">It Works... For a Time</h2>
<p>When I created this project in 2016, it worked well. It worked well, and it brought me value. I enjoyed it, and it was exactly what I needed.
I was also frustrated by the previous tool I used - <a href="https://github.com/sculpin/sculpin">Sculpin</a> - that didn't work for PHP 7. <a href="https://github.com/symplify/statie">Statie</a> was a pet project for me, to <strong>code website in Markdown and PHP and publish it on the Internet</strong> via GitHub Pages for free.</p>
<p>The 0 $ was partial motivation, but <strong>I was astonished much more by the miracle of deploying the PHP app into HTML and CSS</strong>. In times of MVC frameworks build on Request and Response, it took me many days to shift my mind.</p>
<p>I had my first talk about Statie abroad, in Berlin I think, and I enjoyed it. Why? It was my first talk in English, and <a href="/blog/2018/07/23/5-signs-should-never-have-a-talk-abroad/">I was so scared</a> about the feedback and people will understand my poor English (at least what I thought about it).</p>
<p>I wrote a few posts about it and also used it for our community website <a href="https://pehapkari.cz">Pehapkari.cz</a> - proudly of a piece of art at that time. I mean, <strong>anyone could edit the website on GitHub</strong>, and it was <strong>deployed to production after merging the pull-request</strong> in a matter of 5 minutes. How long does it take to projects, you know?</p>
<p>Also, it didn't got much popularity:</p>
<p><a href="https://packagist.org/packages/symplify/statie/stats"></p>
<img src="/assets/images/posts/2020/letting_go_bad_stats.png" class="img-thumbnail">
<p></a></p>
<h2 id="Change-is-Knocking-on-The-Door-One-Step-at-a-Time">Change is Knocking on The Door One Step at a Time</h2>
<p>The first signs are very subtle. Few of my PHP friends used Jekyll or Sculpin around 2017, then switched to projects not written in PHP - like <a href="https://gohugo.io">Hugo</a> or <a href="https://www.gatsbyjs.org">Gatsby</a>. I didn't think much of it.</p>
<p><br></p>
<p>Statie generated code from PHP. When you change the code, <strong>it runs full PHP command and regenerates the whole website</strong>, even if you change only one post. To make this fast, we used Javascript. Write code in PHP and use Javascript to run PHP to generated HTML and CSS... it started like scratching behind the ear with middle toes of both of your legs.</p>
<p><br></p>
<p>Our Pehapkari.cz community grew further than we first imagined. In Spring 2019, we started to need more than just a static website. We needed forms, cron jobs, and emails.</p>
<p>How can we make it happen? Symfony, DigitalOcean, and Docker came as a way to go. We <a href="https://github.com/pehapkari/pehapkari.cz/pull/47">switched from Statie to Symfony</a>. <strong>I was surprised how easy it was</strong>. It might seem right, but it was a bad sign for Statie.</p>
<img src="/assets/images/posts/2020/letting_go_pehapkari_switch.png" class="img-thumbnail">
<p><br></p>
<p>The next sign came in the Autumn of 2019. <a href="https://github.com/symplify/symplify/pull/1641">Statie dropped Latte support</a>, as it was buggy and didn't work well with JavaScript rebuild. What was Statie? A Symfony Kernel? Static Site Generator?</p>
<p><strong>A few months later, I felt like I'm running in circles</strong>. Something was wrong, but I didn't know what it was.</p>
<blockquote class="blockquote text-center mb-5 mt-5">
    What you know you can't explain, but you feel it. You've felt it your entire life,<br>
    that there's something wrong with the world.
    <br>
    <br>
    You don't know what it is, but it's there,<br>
    like a splinter in your mind, driving you mad
</blockquote>
<h2 id="Time-for-Self-Reflection">Time for Self-Reflection</h2>
<p>What now? One of the few things that help me in complicated situations with coding is Occam's razor.</p>
<img src="/assets/images/posts/2020/letting_go_occams_razor.jpg" class="img-thumbnail">
<p>I paused and asked myself a few questions.</p>
<p><br></p>
<p>What main purpose of Statie?</p>
<ul>
<li><em>To generate HTML and CSS web from Twig and some PHP.</em></li>
</ul>
<p><br></p>
<p>How do I use it?</p>
<ul>
<li><em>In a command line.</em></li>
</ul>
<p><br></p>
<p>Why was it so easy to switch to Symfony?</p>
<ul>
<li><em>Because they both run on Symfony Kernel, configs, Twig, DependencyInjection, and other Symfony components</em></li>
</ul>
<p><br></p>
<p>What is it similar too?</p>
<ul>
<li><em>Symfony application</em></li>
</ul>
<p><br></p>
<p>How is it unique to anything else on the market?</p>
<ul>
<li>...</li>
</ul>
<p><br></p>
<h3 id="Unique-Selling-Point">Unique Selling Point</h3>
<p>A <em>unique selling point</em> is a term from a business. If investors want to get an idea about startup value, they ask CEOs what their product exceptional compared to the competition is. <strong>It can be convenient in coding as well</strong>. e.g., how does your private MVC differ from Symfony MVC? In only 5 %? Then it's obvious it would save you huge costs to switch to Symfony.
Occam's razor in practice.</p>
<p><br></p>
<p>Saying that the last question bugged me the most: <strong>How is it unique to anything else on the market?</strong></p>
<p><em>Well, it's like Symfony, but it generates static website. So I made a Symfony application that generates a static website? Isn't that what Symfony does anyway? When we visit a controller, it shows HTML and CSS after all, right? It's just not cached... but is it though?</em></p>
<p>I tried a simple demo a week ago. When I render Symfony controller to string... I got a bitter-sweet surprise: <strong>it's HTML</strong>.</p>
<blockquote class="blockquote text-center">
    Then I realized a simple truth: I wrote a Symfony clone all along.
</blockquote>
<img src="/assets/images/posts/2020/letting_go_double.jpg" class="img-thumbnail">
<h2 id="Why-Let-Go">Why Let Go?</h2>
<p>You would say, &quot;why change something that works&quot;?</p>
<p>Sometimes, a <strong>new opportunity is waiting behind the corner</strong>. But to allow an opportunity to come, <strong>we have to make space for it first</strong>. If we'd stick with old phones or GSM, we block ourselves from using smartphones with an instant internet connection.</p>
<p><br></p>
<p>Remember not to have high expectations. The next thing doesn't have to be as impressive as it often seems. It's like with relationships with man or woman, a new friend, a new job or a new country you move in. If we let go of something that doesn't work for us, we can't expect the next thing to solve all our problems.</p>
<blockquote class="blockquote text-center">
    There are no solutions. There are only trade-offs.
</blockquote>
<p>It will be only better and <strong>that's good enough because that how we learn and grow</strong> &ndash; 1 % at a time.</p>
<img src="/assets/images/posts/2020/letting_go_better.png" class="img-thumbnail">
<h2 id="Spread-The-Code-you-Want-to-See-in-The-World">Spread The Code you Want to See in The World</h2>
<p>I realized I made the project that worked before, <strong>but doesn't anymore</strong>. And that's the lesson for open-source I want to see in the world.
<strong>I don't want to spread bad habits amongst programmers who read my code</strong> when I already know it's wrong. I feel it's my personal responsibility to correct mistakes of past, moreover when <a href="/blog/2020/02/24/how-many-days-of-technical-debt-has-your-php-project/">the code teaches programmers</a>.</p>
<blockquote class="blockquote text-center">
    If something doesn't work and we feel there might be a better way,<br>
    we should pursue it, even though we don't know the outcome yet.
</blockquote>
<p><strong>What works today doesn't have to work in the future</strong>. And probably won't. New PHP framework may appear in 2020, and it will be so good that we'll all migrate to it in 2022. It would not be the first time.</p>
<h2 id="Verify-Your-Feelings-with-Experiment">Verify Your Feelings with Experiment</h2>
<p>Before all this really happened and I made sense to it, we have to <strong>test the assumption</strong>:</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Talking about Occam's razor... this is how Statie 20-lines implementation looks like in normal Symfony app 😱<br><br>Time to let go? <a href="https://t.co/1Fxk31wWaf">pic.twitter.com/1Fxk31wWaf</a></p>— Tomas Votruba (@VotrubaT) <a href="https://twitter.com/VotrubaT/status/1237437559254417408?ref_src=twsrc%5Etfw">March 10, 2020</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p><br></p>
<p><strong>If you don't know, test it, try it.</strong> Your feelings might be right, your feelings might be wrong, but only real test in real life will tell.</p>
<ul>
<li><a href="https://github.com/TomasVotruba/friendsofphp.org/pull/169/files">PR on friendsofphp.org</a></li>
</ul>
<p>In a few hours, I got a working generator and deploy on <a href="https://friendsofphp.org">friendsofphp.org</a>. It worked!</p>
<p><br></p>
<p>So I made a slightly bigger experiment on my blog website with over 230 posts.</p>
<ul>
<li><a href="https://github.com/TomasVotruba/tomasvotruba.com/pull/940">PR on tomasvotruba.com</a></li>
</ul>
<p>I got stuck with a route with an argument - a blog post detail - but after a few fixes, it worked too!</p>
<h2 id="The-Letting-Go-in-Practise">The Letting Go in Practise</h2>
<p>Since that moment, I knew, Statie needs to be deprecated. To spread the miss-information, I had to <a href="https://github.com/TomasVotruba/tomasvotruba.com/pull/944">deprecate 8 posts</a> about Statie on my blog.</p>
<p>Also, before we burn bridges, <strong>there should be a path to follow</strong>. And that is <a href="https://github.com/symplify/symfony-static-dumper">Symfony Static Dumper</a> with only 550 lines of code (compared to Statie with over 4500 lines). A package that you plugin in Symfony app and works the same way Statie does.
I'll write about in the next post, which will focus only on migration.</p>
<p><a href="https://www.youtube.com/watch?v=moSFlvxnbgk"></p>
<img src="/assets/images/posts/2020/letting_go_frozen.jpg" class="img-thumbnail">
<p></a></p>
<p>If you haven't heard, the song is a blast!</p>
<p><br></p>
<p>Happy coding and stay healthy!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/03/09/art-of-letting-go</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 09 Mar 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/03/09/art-of-letting-go#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ We Do Not Need Senior Developers, We Need Senior Codebases ]]></title>
                <link>https://tomasvotruba.com/blog/2020/03/02/we-do-not-need-senior-developers-we-need-senior-code-bases</link>
                <description><![CDATA[ <p>&quot;We're looking for a Senior PHP Developer.&quot;</p>
<p>&quot;Are you a senior or a junior?&quot;</p>
<p>&quot;How many senior developers does your company have?&quot;
<br>
<br>
These and similar questions come to appear when you're looking for a job. The IT market says it needs more senior developers.
<br><br>
I think there is more than enough. What we need are <strong>senior codebases</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Let's say we have 2 companies.</p>
<p><br></p>
<p><strong>Company A</strong> has:</p>
<ul>
<li>3 years old project</li>
<li>3 junior developers</li>
<li>1 senior developer</li>
</ul>
<p><br></p>
<p><strong>Company B</strong> has:</p>
<ul>
<li>1 year old project</li>
<li>1 junior developer</li>
<li>3 senior developers</li>
</ul>
<p><br></p>
<p>Which company would you pick as a better place for your next full-time work?</p>
<p><br></p>
<h2 id="Does-Level-and-Amount-Matter">Does Level and Amount Matter?</h2>
<p>I have no idea. Fortunately, <em>Bruce Lee</em> is here to help us:</p>
<blockquote class="blockquote text-center">
    "It's like a finger pointing away to the moon.<br>
    Don't concentrate on the finger or you will miss all that heavenly glory."

    <footer class="blockquote-footer">Bruce Lee</footer>
</blockquote>
<p>The number of developers is not <em>that</em> relevant, neither is the number of developers by their skill.</p>
<p>It's <strong>better to have 2 developers instead of 1</strong>, so that they give each other feedback and grow more robust codebase. It's not such a difference if it's 3+.</p>
<p><br></p>
<h2 id="Reality-of-Hiring-Process">Reality of Hiring Process</h2>
<p>The <em>junior/senior</em> game is an essential part of the manipulative process during hiring in companies around me. I'll describe a model hiring situation, that was shared by my friends who were looking for a job, and that I can relate to also from my personal experience.</p>
<p>John is looking for a job. He found both companies A and B. <strong>After 5 years in the same environment, where he has became an expert, he's looking for somebody to learn from</strong> - a skilled senior developer who's gonna be willing to share their experience.</p>
<p>John says that he's more attracted to company B, which has 3 senior developers, compared to a company with just 1. For him, it's a clear choice. He signs a full-time contract with a three-month trial period.</p>
<p><br></p>
<p>Now let's pause. <strong>What misconceptions have you spotted?</strong> Here are 3:</p>
<ul>
<li>senior developer === senior teacher</li>
<li>senior developer === experienced developer</li>
<li>3 senior developers have more experience than 1 senior developer</li>
<li>you can learn only from people</li>
</ul>
<p>All 4 of those are <code>false</code>.</p>
<p><br></p>
<p>The story continues. During the first week John only learns to run the application and to work with it. It takes some time, but he thinks it's healthy because it's a huge project.</p>
<p>The second week he realizes the senior developers don't have time to teach him or share any of their experience because they're busy fixing bugs happening in the codebase. All 3 of them!</p>
<p>Third week he thinks about the meaning of the word <em>senior</em> in this company. It's not as much about experience or teaching, but rather <strong>about being in the company for many years and understanding the codebase</strong> better than anybody else.</p>
<p>It's not about teaching, experience, nor programming skills. John's expectations have not been met. <strong>John is disappointed</strong>. But who's to blame? Should he blame himself for his bad decision?</p>
<p><br></p>
<p>The company also had expectations. John told them he's a senior developer, but his work during the 1st and 2nd week was very slow. Company owners feel like John is lying to them just to get more money. Their expectations have not been met. <strong>They're disappointed</strong> too... But who's to blame? Should they blame themselves for hiring him?</p>
<h2 id="We-Forget-What-s-the-Most-Important">We Forget What's the Most Important</h2>
<p>We talked about junior, senior developers, teaching, experience, expectations, humans...
Everything was so lovely and shiny at the start. We had a great team of great developers that were joined by another great developer.</p>
<p><strong>Where did it go wrong? What have we missed?</strong></p>
<h2 id="Maturity-of-The-Codebase">Maturity of The Codebase</h2>
<p>People can make you feel better, and coffee might be good, the office might be on the highest floor with a beautiful and sunny view, your salary can be the highest you've ever seen. *<em>But how does it relate to your everyday work?</em></p>
<p>You're not going to enjoy a coffee while watching over your city from the glass-floor view all day, you're going to work with the codebase.</p>
<p>That's why before I say I'll cooperate with any company, <strong>I need to see the codebase first</strong>.</p>
<p><br></p>
<p>Instead of asking 3 questions at the top of this post, we should focus on:</p>
<ul>
<li>&quot;How mature is your codebase?&quot;</li>
<li>&quot;From <em>junior</em> = spaghetti code with no rules to <em>senior</em> = DI, finalized classes with CI that checks everything that can be checked and <a href="/blog/2019/11/18/how-to-delegate-code-reviews-to-ci/">handles code-review</a>, the newest PHP and version of your favorite framework... where does the codebase stand?&quot;</li>
<li>&quot;How do I fit into that level with my level of expertise?&quot;</li>
</ul>
<p><br></p>
<h2 id="ITinder-Miss-Match">ITinder Miss Match</h2>
<p>The most companies I met <strong>have junior codebases, but they look for senior developers</strong>. That's wrong and will lead mostly to John's story with its unhappy ending.</p>
<p><strong>Junior developers can work with junior codebase</strong> because they're not being slowed down by codebase that is lower than their skill.</p>
<p>When senior developers are hired to orientate in a terrible codebase, they can't apply their experience with clean code, and they can't build a robust application with their high standards. They have to dig through the legacy code and try to fix leaking pipes.</p>
<h2 id="Senior-Codebase-is-the-Best-Teacher">Senior Codebase is the Best Teacher</h2>
<blockquote class="blockquote text-center">
    Monkey see, monkey doo.
</blockquote>
<p>That's how our brain works; we're just like monkeys. We come to a new project, and we instinctively copy patterns we see. If there are <a href="https://blog.codinghorror.com/the-broken-window-theory">broken windows all over the code</a>, we make more broken windows.</p>
<p>Some people join your team, some people stay for a long time enough to be called <em>seniors</em>, and some will leave. <strong>The codebase remains</strong> as long as your company exists. That's why it deserves the best treatment.</p>
<p>People learn from your codebase, it's their best teacher.</p>
<p><br></p>
<p>Let's say you have 2 teachers in your life.</p>
<p><strong>Teacher A</strong>:</p>
<ul>
<li>is teaching children for 5 years</li>
<li>always worked in the same school</li>
<li>went to university</li>
<li>wears a suit</li>
<li>makes a great coffee</li>
</ul>
<p><br></p>
<p><strong>Teacher B</strong>:</p>
<ul>
<li>doesn't belong to any school</li>
<li>wears a jumper and dirty trousers</li>
<li>has 80% test coverage</li>
<li>sleeps well, because CI works for them</li>
<li>tries to be better every day</li>
<li>exercises and eats healthy food, so their insides look good</li>
<li>you learn just by looking at how they do things</li>
</ul>
<p><br></p>
<p><strong>What teacher would you pick?</strong></p>
<p><br></p>
<blockquote class="blockquote text-center">
Take care of your codebase, and your codebase will take care of you when you're older.
</blockquote>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/03/02/we-do-not-need-senior-developers-we-need-senior-code-bases</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 02 Mar 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/03/02/we-do-not-need-senior-developers-we-need-senior-code-bases#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How Many Days of Technical Debt Has your PHP Project ]]></title>
                <link>https://tomasvotruba.com/blog/2020/02/24/how-many-days-of-technical-debt-has-your-php-project</link>
                <description><![CDATA[ <p>Every project has technical dept. But how would you measure it? With <a href="/blog/2018/05/21/is-your-code-readable-by-humans-cognitive-complexity-tells-you/">cognitive complexity</a>? The age of the framework? Any other guess?
<br>
<br>
This year I've started to use CI service, which tells you the number in days. And it works pretty well... how many days Rector has? Keep on learning.</p> ]]></description>
                <content:encoded><![CDATA[ <p><a href="https://sonarcloud.io/dashboard?id=rectorphp_rector"></p>
<img src="/assets/images/posts/2020/sonar_rector.png" class="img-thumbnail">
<p></a></p>
<h2 id="How-Reliable-is-Technical-Dept-Metric">How Reliable is Technical Dept Metric?</h2>
<p>When I first analyzed Rector, <strong>top 5 worst classes had these in common</strong>:</p>
<ul>
<li>&quot;instanceof programming&quot;, e.g., 10-15 cases of <code>instanceof</code>, then do return some logic</li>
<li>30-50 lines long methods within 1 class</li>
<li>classes of length 200-500 lines</li>
<li>pain points I knew were there, but I was afraid to do something about it</li>
</ul>
<p>As the first experiment, I picked a class that had <strong>5 hours and 40 minutes</strong> of technical debt, and I gradually converted it to <a href="/blog/2018/06/14/collector-pattern-for-dummies/">collector pattern</a>.</p>
<p>Do you want to see <strong>real code</strong>? Look at <a href="https://github.com/rectorphp/rector/pull/2767/files#diff-23d92ff042a5c83870af8b8d30bbdd8d">this PR with <code>NodeTypeResolver</code> decoupling to 10 new classes</a>.</p>
<h2 id="I-Thought-Removing-Legacy-Would-be-Fun">I Thought Removing Legacy Would be Fun...</h2>
<p>...but removing my legacy code was rather painful. I had to <a href="/blog/2018/05/21/is-your-code-readable-by-humans-cognitive-complexity-tells-you/">load huge methods</a> to my working memory, think about relations of huge monolithic class and try to split into the smallest standalone pieces.</p>
<p><strong>After 3 hours of work, I was exhausted</strong>, but CI was passing, and the god class was gone. I pushed my work, merged the PR to the <code>master</code>, and waited for SonarCloud analysis... <strong>from 5:40 I got into 2:40</strong>. What?</p>
<p>After all this work, only such a small improvement? Don't take me wrong; the code was much improved, I'm just used to work more effectively with Rector-wave refactoring approach... no more <a href="https://freek.dev/1518-automatically-convert-your-code-to-php-74-syntax-using-rector">from months to days</a>?</p>
<p>This process taught me a lesson:</p>
<blockquote class="blockquote mt-5 mb-5 text-center">
    The legacy code will always be there. Observe it, measure it and remove it.
    <br>
    The later you start, the more it hurts. No matter what.
</blockquote>
<p>Since then, <strong>I'm adding SonarCube on every project I work on</strong>, so I know (not just <em>feel</em>):</p>
<ul>
<li>what is the pain point,</li>
<li>and where should we put the effort...</li>
</ul>
<p>...<strong>to keep code base fit for years</strong></p>
<p><br></p>
<p>Do you wonder <strong>how many days you have on your back</strong>? 10, 50 or over 100? Add your first SonarCube check into the CI and share with us in comments ↓</p>
<h2 id="How-to-add-SonarCube-to-your-Github-Project-in-6-Steps">How to add SonarCube to your Github Project in 6 Steps?</h2>
<p>SonarCube is free for open-source and has a 1-week trial for private projects. I tried the 1-week trial on one private project, and then I saw the debt... <strong>365</strong>, <del>hours</del> days... you have to love it :D.</p>
<h2 id="1-Add-Project-on-SonarCloud">1. Add Project on SonarCloud</h2>
<ul>
<li><a href="https://sonarcloud.io/projects/create">Create new project</a></li>
</ul>
<img src="/assets/images/posts/2020/sonar_step_1.png" class="img-thumbnail">
<h2 id="2-Authorize-Your-Github-Project">2. Authorize Your Github Project</h2>
<img src="/assets/images/posts/2020/sonar_step_2.png" class="img-thumbnail">
<p>Add the file and commit to <code>master</code>.</p>
<h2 id="3-Add-Github-Action">3. Add Github Action</h2>
<p>We need to have a way to tell the Sonar that new code was pushed. That's what Github Actions are for.</p>
<p>Add new workflow:</p>
<pre><code class="language-yaml"># .github/workflows/sonarcube.yaml
name: Sonar

on: push

jobs:
    sonar_cloud:
        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@master
                with:
                    # sonar needs non-shallow clone
                    fetch-depth: 10000

            -   uses: sonarsource/sonarcloud-github-action@master
                env:
                    ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
                    SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}</code></pre>
<p>As you can see, there are 2 tokens to authorize.</p>
<h3 id="How-to-get-Tokens">How to get Tokens?</h3>
<ul>
<li><a href="https://github.com/settings/tokens">https://github.com/settings/tokens</a> → <code>ACCESS_TOKEN</code></li>
<li><a href="https://sonarcloud.io/account/security">https://sonarcloud.io/account/security</a> → <code>SONAR_TOKEN</code></li>
</ul>
<h3 id="Where-to-place-Them">Where to place Them?</h3>
<p>Add both tokens to your <em>secrets</em> sections in your repository: <a href="https://github.com/TomasVotruba/tomasvotruba.com/settings/secrets">https://github.com/TomasVotruba/tomasvotruba.com/settings/secrets</a></p>
<h2 id="4-Add-Badge-for-Quick-Link-to-SonarCloud-Analysis">4. Add Badge for Quick Link to SonarCloud Analysis</h2>
<p>What is analysis good for if you can't reach it from your <code>README</code>? Be sure to add it there, so you can enter it quickly and share your excellent results with others.</p>
<ul>
<li>You can use the standard link: <a href="https://sonarcloud.io/dashboard?id=TomasVotruba_tomasvotruba.com">SonarCube</a></li>
<li>But I went for <strong>fancier custom badge</strong> (where you can add your technical dept <strong>days</strong> number):</li>
</ul>
<pre><code class="language-markdown">[![SonarCube](https://img.shields.io/badge/SonarCube_Debt-%3C2-brightgreen.svg?style=flat-square)](https://sonarcloud.io/dashboard?id=TomasVotruba_tomasvotruba.com)</code></pre>
<p><a href="https://sonarcloud.io/dashboard?id=TomasVotruba_tomasvotruba.com"><img src="https://img.shields.io/badge/SonarCube_Debt-%3C2-brightgreen.svg?style=flat-square" alt="SonarCube" /></a></p>
<p>Almost done...</p>
<h2 id="5-Where-is-the-Code">5. Where is the Code?</h2>
<p>We still have to tell SonarCube where to look for the <code>src</code> code. To do this, we need to add <code>sonar-project.properties</code>.</p>
<pre><code class="language-bash"># sonar-project.properties
# see https://sonarcloud.io/documentation/project-administration/narrowing-the-focus/
sonar.organization=TomasVotruba
sonar.projectKey=tomasvotruba.com

# relative paths to the source, wildcards don't work
sonar.sources=src</code></pre>
<p>To get <code>organization</code> and and <code>projectKey</code>, just split the key (<code>TomasVotruba_tomasvotruba.com</code>) by <code>_</code>.</p>
<h2 id="6-Remove-Spam-Bot">6. Remove Spam Bot</h2>
<p><strong>Do this AFTER the first analysis of <code>master</code> branch is completed.</strong> If you do it earlier, the Github Action will not work.</p>
<p><br></p>
<p>There is a price for all the excellent features... you need to tolerate SonarCube <strong>spam bot on every commit</strong>.</p>
<img src="/assets/images/posts/2020/sonar_spam.png" class="img-thumbnail">
<p><strong>I hated it</strong> and wanted to delete all this Sonar-spam from my repositories, but there is one solution out of it.</p>
<p>Go to <a href="https://github.com/settings/installations">Github installations</a>:</p>
<img src="/assets/images/posts/2020/sonar_step_3.png" class="img-thumbnail">
<p>And remove it:</p>
<img src="/assets/images/posts/2020/sonar_step_4.png" class="img-thumbnail">
<p>We only need it for the first contact. Instead of it, <strong>you can authorize with Github Actions</strong>.</p>
<p><br></p>
<p>And that should be it! (If not, let me know in comments.)</p>
<p><a href="https://sonarcloud.io/dashboard?id=TomasVotruba_tomasvotruba.com"></p>
<img src="/assets/images/posts/2020/sonar_final.png" class="img-thumbnail">
<p></a></p>
<p><br></p>
<h2 id="Trouble-Shooting">Trouble Shooting</h2>
<h3 id="and-quot-Please-add-the-secret-GITHUB-TOKEN-to-the-GitHub-action-for-SonarCloud-and-quot">&quot;Please add the secret GITHUB_TOKEN to the GitHub action for SonarCloud&quot;</h3>
<p>If you see this message, don'T try to add <code>GITHUB_TOKEN</code> to your Secrets in GitHub repository. It won't let you.
Instead, re-use already existing secret in your <code>.github/workflows/sonarcube.yaml</code>:</p>
<pre><code class="language-diff"># .github/workflows/sonarcube.yaml
# ...
             -   uses: sonarsource/sonarcloud-github-action@master
                 env:
                     ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
                     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
+                    GITHUB_TOKEN: ${{ secrets.SONAR_TOKEN }}</code></pre>
<p><br></p>
<h3 id="Dual-Analysis">Dual Analysis?</h3>
<p>When CI fails for having both automatic and Github Action analysis, go to your project on SonarCube and disable it:</p>
<img src="/assets/images/posts/2020/sonar_one_method.png" class="img-thumbnail">
<p><br></p>
<h3 id="and-quot-Project-was-never-analyzed-A-regular-analysis-is-required-before-a-branch-analysis-and-quot">&quot;Project was never analyzed. A regular analysis is required before a branch analysis.&quot;</h3>
<p>I tried many paths, but I'm not aware of any specific solution for this. <strong>Delete</strong> project on Sonarcloud, <strong>hide</strong> local GitHub Action workflow and <strong>star over</strong>.</p>
<p><br></p>
<p><strong>Now you see your weakest points and <a href="https://joshkaufman.net/how-to-fight-a-hydra">Fight the Hydra</a> with courage!</strong></p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/02/24/how-many-days-of-technical-debt-has-your-php-project</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 24 Feb 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/02/24/how-many-days-of-technical-debt-has-your-php-project#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Local Packages 3 Years Later ]]></title>
                <link>https://tomasvotruba.com/blog/2020/02/17/local-packages-3-years-later</link>
                <description><![CDATA[ <p>The first public idea about local packages was <a href="/blog/2017/12/25/composer-local-packages-for-dummies/">published over 3 years ago</a> after 1 year of internal testing.
<br><br>
<strong>How do they stand in 2020? How people use it wrong?</strong> Are they still the best option to keep low complexity in huge projects?</p> ]]></description>
                <content:encoded><![CDATA[ <p>Just a reminder: <em>what are local packages</em>?</p>
<p>Local packages are decoupled parts of code, located in own <code>packages/&lt;package-name&gt;</code> directory:</p>
<pre><code class="language-bash">/app
/packages
    /file-system
        /src
            FileSystem.php
        /tests
            FileSystemTest.php
/vendor
composer.json</code></pre>
<p>And loaded in <code>composer.json</code> with its PSR-4 namespace:</p>
<pre><code class="language-json">{
    "require": {
        "favorite/framework": "^5.0"
    },
    "autoload": {
        "psr-4": {
            "App\\FileSystem\\": "packages/file-system/src"
        }
    },
    "autoload-dev": {
        "psr-4": {
            "App\\FileSystem\\Tests\\": "packages/file-system/tests"
        }
    }
}</code></pre>
<p>Simple.</p>
<p><br></p>
<p>Do you want to <strong>know more</strong>? Look at <a href="/blog/2017/12/25/composer-local-packages-for-dummies/">Composer Local Packages for Dummies</a>.</p>
<h2 id="How-People-Use-it-Wrong">How People Use it Wrong?</h2>
<h3 id="1-Forgetting-src-Directory">1. Forgetting <code>/src</code> Directory</h3>
<pre><code class="language-bash">/packages
    /file-system
        FileSystem.php</code></pre>
<p>❌</p>
<p><br></p>
<pre><code class="language-bash">/packages
    /file-system
        /src
            FileSystem.php</code></pre>
<p>✅</p>
<p><br></p>
<h3 id="2-Single-Autoload">2. Single Autoload</h3>
<pre><code class="language-json">{
    "autoload": {
        "psr-4": {
            "Packages\\": "packages"
        }
    }
}</code></pre>
<p>❌</p>
<p><br></p>
<pre><code class="language-json">{
    "autoload": {
        "psr-4": {
            "Packages\\SpecificPackage\\": "packages/specific-package/src"
        }
    }
}</code></pre>
<p>✅</p>
<p><br></p>
<h3 id="3-A-mix-of-Paths-and-Namespace">3. A mix of Paths and Namespace</h3>
<pre><code class="language-bash">/packages
    /FileSystem
        /src
            FileSystem.php</code></pre>
<p>❌</p>
<p><br></p>
<pre><code class="language-bash">/packages
    /file-system
        /src
            FileSystem.php</code></pre>
<p>✅</p>
<h3 id="4-composer-json-in-Packages">4. <code>composer.json</code> in Packages</h3>
<pre><code class="language-bash">/packages
    /file-system
        /src
            FileSystem.php
        composer.json</code></pre>
<p>❌</p>
<p><br></p>
<pre><code class="language-bash">/packages
    /file-system
        /src
            FileSystem.php</code></pre>
<p>This is only useful in case of <a href="/blog/2018/10/08/new-in-symplify-5-create-merge-and-split-monorepo-with-1-command/">monorepo that splits packages</a>, e.g. Symfony, Symplify. Not for local packages.</p>
<p>✅</p>
<h2 id="How-to-Do-it-Right">How to Do it Right?</h2>
<ul>
<li>Register each package as a standalone line in <code>composer.json</code>:</li>
</ul>
<pre><code class="language-json">{
    "autoload": {
        "psr-4": {
            "App\\FileSystem\\": "packages/file-system/src",
            "App\\Auth\\": "packages/auth/src"
        }
    }
}</code></pre>
<ul>
<li>Keep <code>/app</code> separated.</li>
<li>Use <code>dash-format</code> for directory paths.</li>
<li>Use <code>CamelCase</code> for namespaces.</li>
<li>Use <code>packages/&lt;package-name&gt;/src</code> and <code>packages/&lt;package-name&gt;/tests</code> directory convention.</li>
<li>Use single root <code>composer.json</code> to autoload them all.</li>
<li>Use single root <code>phpunit.xml</code> to run test on them all.</li>
</ul>
<pre><code class="language-xml">&lt;phpunit
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="vendor/phpunit/phpunit/phpunit.xsd"
    bootstrap="vendor/autoload.php"
&gt;
    &lt;testsuites&gt;
        &lt;testsuite name="main"&gt;
            &lt;directory&gt;tests&lt;/directory&gt;
            &lt;directory&gt;packages/*/tests&lt;/directory&gt;
        &lt;/testsuite&gt;
    &lt;/testsuites&gt;

    &lt;filter&gt;
        &lt;whitelist addUncoveredFilesFromWhitelist="false"&gt;
            &lt;directory&gt;src&lt;/directory&gt;
            &lt;directory suffix=".php"&gt;packages/*/src&lt;/directory&gt;
        &lt;/whitelist&gt;
    &lt;/filter&gt;
&lt;/phpunit&gt;</code></pre>
<h2 id="Feedback-After-3-Years-of-Usage-in-Companies">Feedback After 3 Years of Usage in Companies</h2>
<p>I've started to test this in Lekarna.cz, 6 years old project, where they still use it.
<a href="https://www.elasticr.cz">Elasticr</a> and <a href="https://recruitis.io">Recruit.is</a> adopted local packages in ~2018, still using it.</p>
<p>The code is much cleaner, comfortable to dive in, and refactor.</p>
<p><strong>If you're careful about all the issues above, there is nothing to stop you from making it work!</strong> Give it a try, your future team will thank you.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/02/17/local-packages-3-years-later</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 17 Feb 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/02/17/local-packages-3-years-later#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Test Monorepo After Split Before Actual Split ]]></title>
                <link>https://tomasvotruba.com/blog/2020/02/10/how-to-test-monorepo-after-split-before-actual-split</link>
                <description><![CDATA[ <p>In 14 months old post <a href="/blog/2018/11/22/how-to-test-monorepo-in-3-layers/#3-after-split-testing">How to Test Monorepo in 3 Layers</a> we talked about testing monorepo in 3 layers. So you can be sure every package works as it should.
<br>
<br>
3 layers are testing in a monorepo, testing package directory, and testing after a split.
<strong>The latter takes a huge amount of time</strong>. The time we don't have to spare in 2020.
<br>
<br>
<strong>How can we make it faster while keeping the test quality high?</strong></p> ]]></description>
                <content:encoded><![CDATA[ <p>Do you use Github Actions on your Github projects? Well, if you do, <strong><a href="/blog/2020/01/27/switch-travis-to-github-actions-to-reduce-stress/">it might cut your commit feedback loop</a> from 17 minutes to just 3</strong> and make you super productive by accident.</p>
<p>We now use Github Actions on Symplify and Rector for over a month, and in January 2020, it helped us <a href="https://twitter.com/VotrubaT/status/1220126675436032005">to merge amazing 177 pull-requests</a>.</p>
<h2 id="Warning-Cleaning-Up-Might-Cause-you-to-Spot-more-Bottle-Necks">Warning: Cleaning Up Might Cause you to Spot more Bottle Necks</h2>
<p>That's why so few developers like to tidy up. It usually only shows worse and worse mess in the code.</p>
<p>The worse mess in our code was the 3rd layer of monorepo testing - <strong>after split tests</strong>.</p>
<p>We had to wait till the full monorepo is split (+ 5 minutes), and CI runs on each split package (+ 2 minutes). So instead of 3 minutes, we're now back on 10 minutes. Also, the split testing can <strong>only happen after the PR is merged into the <code>master</code> branch</strong>.</p>
<p>Do your 1st and 2nd layer pass? All good? <strong>You have to wait till the split to find out it's not all good</strong>. Doh.</p>
<h2 id="Short-Reminder-What-is-the-3rd-layer-of-Monorepo-Testing">Short Reminder: What is the 3rd layer of Monorepo Testing?</h2>
<p>Let's say you run:</p>
<pre><code class="language-bash">git clone git@github.com:symfony/console.git

composer install
# all needed dependencies are installed, symfony/* and all external in /vendor directory

vendor/bin/phpunit</code></pre>
<p>And that's all! The standard way of testing packages.</p>
<p><strong>But</strong> with monorepo, the symfony/console is just one of directories in <a href="https://github.com/symfony/symfony">big monorepo symfony/symfony repository</a>:</p>
<pre><code class="language-bash">symfony/src/Symfony/Component/Console
symfony/src/Symfony/Component/EventDispatcher
symfony/src/Symfony/Component/HttpKernel
...</code></pre>
<p>To run unit tests on symfony/console only, we'd have to call PHPUnit on the directory:</p>
<pre><code class="language-bash">vendor/bin/phpunit -d symfony/src/Symfony/Component/Console</code></pre>
<p>But there is no:</p>
<pre><code class="language-bash">symfony/src/Symfony/Component/Console/vendor/*</code></pre>
<p><strong>So we can't test it</strong>. That's why we have to <strong>wait after the split is done</strong> and trigger tests in a split repository - <code>symfony/console</code> the way we did at first:</p>
<pre><code class="language-bash">git clone git@github.com:symfony/console.git

# all needed dependencies are installed, symfony/* and all external
composer install

vendor/bin/phpunit</code></pre>
<p>You can read more about it <a href="/blog/2020/02/10/how-to-test-monorepo-after-split-before-actual-split/">in original post</a>.</p>
<p><br></p>
<h2 id="Status-Quo-It-Sucks-but-it-s-the-Best-Testing">Status Quo: It Sucks, but it's the Best Testing</h2>
<p>3rd layer of monorepo testing sucks</p>
<ul>
<li>it takes + 10 minutes</li>
<li>it doesn't test pull-requests - it's like tests without CI basically</li>
<li>it confusing to have few tests in one repository and one repository</li>
</ul>
<p>It's so bad that <strong>the most monorepo projects don't have this 3rd layer</strong> - Symfony nor Laravel. And I don't blame them. I was about to drop it too because having feedback about one line of code from 2 sides with entirely different settings hurts my brain.</p>
<p>The problem is, <strong>this 3rd layer testing is the closest to the reality of how these packages are used</strong>. So missing it will cause you headaches with bugs, so simple to find by users of your packages that you won't believe them.</p>
<h2 id="Could-it-be-possible-with-GitHub-Actions">Could it be possible with GitHub Actions?</h2>
<p>This bottleneck got me thinking... what do we need to simulate?</p>
<pre><code class="language-bash">git clone git@github.com:symfony/console.git

# all needed dependencies are installed, symfony/* and all external
composer install

vendor/bin/phpunit</code></pre>
<p>Just locally for every package.</p>
<blockquote class="blockquote text-center mt-5 mb-5">
    Albert Einstein always taught me:
    <br>
    "think in patterns, my young padawan",
    <br>
    so I knew there must be a way.
</blockquote>
<p><del>Then I suddenly knew what to do!</del></p>
<p><br></p>
<p>I won't lie, it took me 3-4 hours of trial and error and many toilet <em>eureka</em> visits to figure out the working model. What went wrong at first?</p>
<ul>
<li><strong>Symlink cannot be used</strong>, because real/relative paths are different from standard package testing</li>
<li><strong>All packages can't run in one workflow</strong>, because it's super slow</li>
<li><strong>We cannot use shared vendor</strong>, the dependencies are conflicting</li>
</ul>
<h3 id="So-What-Worked">So What Worked?</h3>
<ul>
<li>Every package <code>composer.json</code> had to require mutually dependencies (e.g <code>symplify/easy-coding-standard</code> requires <code>symplify/package-builder</code>) with <code>*</code></li>
<li>Every other package had to require other packages via <a href="https://getcomposer.org/doc/05-repositories.md#path">composer <em>path</em> repository</a>:</li>
</ul>
<img src="/assets/images/posts/split_before_split.png" class="img-thumbnail">
<p><br></p>
<p>There was <strong>one more pit to fall into</strong>. How many repositories we have to add here?</p>
<pre><code class="language-diff"> {
     "require": {
-         "symplify/package-builder": "^7.3"
+         "symplify/package-builder": "*"
     }
 }</code></pre>
<p>Just this one, right?</p>
<pre><code class="language-diff">+"repositories": [
+        {
+            "type": "path",
+            "url": "../../packages/package-builder",
+            "options": {
+                "symlink": false
+            }
+        }
+}</code></pre>
<p>Well, I assumed so, but this would eventually download <code>symplify/package-builder</code> with local version, *<em>but all the rest of `symplify/</em>` packages from packagist**. In the end we'll have a mess like:</p>
<ul>
<li><code>symplify/package-builder</code> - local ✅</li>
<li><code>symplify/autowire-array-parameter</code> - from packagist before split !== different code that we use ❌</li>
</ul>
<p>We have to <strong>add all the possible local repositories</strong>, so the package always has the local version of the code.</p>
<h2 id="Showcase-Symplify-Workflow">Showcase: Symplify Workflow</h2>
<p>It makes sense, but it sounds like a lot of manual work, right? Not for long!</p>
<p><br></p>
<p>You know me too well, me and <em>manual work</em> don't get on very well with each other.</p>
<p><strong>I made a command for MonorepoBuilder that does all the work above for us</strong>:</p>
<pre><code class="language-bash">vendor/bin/monorepo-builder localize-composer-paths</code></pre>
<p>All we need to do is run it before <code>composer update</code>.</p>
<p><br></p>
<p>This simple idea is running split tests in 14 Symplify packages. How?</p>
<ul>
<li>switch to the package directory</li>
<li>modify paths to use local path packages <strong>without</strong> symlink to prevent path false positives</li>
<li>install dependencies</li>
<li>run <code>vendor/bin/phpunit</code> there</li>
</ul>
<pre><code class="language-yaml"># .github/workflows/after_split_testing.yaml
name: After Split Testing

jobs:
    after_split_testing:
        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@v2
            -   uses: shivammathur/setup-php@v1
                with:
                    php-version: 7.4
                    coverage: none

            -   run: |
                    composer install --no-progress

                    # this is the magic
                    packages/monorepo-builder/bin/monorepo-builder localize-composer-paths

                    # testing one package
                    cd packages/easy-coding-standard

                    # download dependencies
                    composer update --no-progress

                    # run tests
                    vendor/bin/phpunit</code></pre>
<p>And that's it! <strong>1 extra new line in workflow</strong> is a worth hour of human-hours a week on one project.</p>
<p><br></p>
<p>See <a href="https://raw.githubusercontent.com/symplify/symplify/151b7a6be28a26fcb94252d91e4c3d061eec7617/.github/workflows/after_split_testing.yaml">full workflow</a> prevent repeating code.</p>
<p><strong><a href="https://github.com/symplify/symplify/pull/1755">See full pull-request</a></strong>.</p>
<p>A reminder: <strong>this all is possible thanks to super-fast Github Actions</strong> with 20 concurrent workers. On Travis with only 3 workers, this might take extra 15-25 minutes, which is utterly annoying.</p>
<p><br></p>
<p>Happy speed coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/02/10/how-to-test-monorepo-after-split-before-actual-split</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 10 Feb 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/02/10/how-to-test-monorepo-after-split-before-actual-split#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to run Rector and PHPStan on Huge Project in 3 Seconds with PHPStorm ]]></title>
                <link>https://tomasvotruba.com/blog/2020/02/03/how-to-run-rector-and-phpstan-on-huge-project-in-3-seconds-with-phpstorm</link>
                <description><![CDATA[ <p>Today we'll look at the command line and run performance heavy dev tools like Rector or PHPStan on our projects. I'm guessing that it takes more than 10 seconds to run whatever project you use.
<br>
<br>
How would you like it be <strong>less than 3 seconds with just one click</strong> in PHPStorm?</p> ]]></description>
                <content:encoded><![CDATA[ <p>Let's say we have a reasonably big codebase, like Rector, with over 70 000 lines of code. Projects I consult lately usually fit into 200-600 000 lines of code, though. But let's take Rector as the baseline, as that's the project we have data for.</p>
<p>We add a new feature, change test, fix a bug, 300 added lines, 200 removed.</p>
<p>Now, <strong>we want to run Rector and PHPStan to make sure the code is clean and working</strong>. So we run PHPStan:</p>
<img src="/assets/images/posts/2020/external_tools_normal_phpstan.gif" class="img-thumbnail">
<p>And wait...</p>
<p><br>
<br>
<br></p>
<p>...<strong>40 seconds</strong>!</p>
<p><br></p>
<h2 id="How-do-we-Hack-It">How do we Hack It?</h2>
<p>It takes so long. We might adapt and <strong>push it into the remote repository and let the CI server handle it</strong>. After all, it's often much faster than our local laptop. I used this approach at big codebases so far.</p>
<p>Another way is to copy the directory path and run tool only on it:</p>
<pre><code class="language-bash">vendor/bin/phpstan analyse src/SomeDirectory
vendor/bin/rector process src/SomeDirectory</code></pre>
<p>But we have to:</p>
<ul>
<li>copy directory path or type it</li>
<li>open command line</li>
<li>type whole command we usually use</li>
<li>remove argument we typically use</li>
<li>add our directory argument</li>
<li>click to run it</li>
</ul>
<p>Instant flow killer :(</p>
<h2 id="Too-Slow-Go-Home">Too Slow? Go Home!</h2>
<p>When I talk with developers, this is one of the main reasons they don't use such tools. It takes too long to get feedback from them. It destroys their focus on the features.</p>
<blockquote class="blockquote text-center mt-5 mb-5">
Frustration is always the sign we should ask this question:
<br>
How can we do better?
</blockquote>
<p><br></p>
<h2 id="Narrow-Scope-Increase-Focus">Narrow Scope → Increase Focus</h2>
<p>Last week <a href="https://twitter.com/mikes_honza">Honza</a> showed me PHPStorm tip that fits <a href="/blog/2020/01/27/switch-travis-to-github-actions-to-reduce-stress/">into instant feedback loop flow</a> I discovered recently.</p>
<p><a href="https://twitter.com/mikes_honza/status/1222557580507127811"></p>
<img src="/assets/images/posts/2020/external_tools_tweet.png" class="img-thumbnail">
<p></a></p>
<p><strong>It might trim off some more frustration</strong> in your daily work and turn you into a flow developer as a result. The bigger your codebase, the more it might help you get under 3 seconds.</p>
<p><br></p>
<h2 id="How-does-it-Work">How does it Work?</h2>
<p>You run <strong>the tool only on a selected directory in the left tree</strong>.</p>
<ul>
<li>Without the command line.</li>
<li>Without changing paths.</li>
<li>Without copy-pasting.</li>
</ul>
<h3 id="Domain-Directory-Separation">Domain Directory Separation</h3>
<p>This approach requires us to keep a decoupled structure, e.g., with to <a href="/blog/2017/12/25/composer-local-packages-for-dummies/">local packages</a> or domain-driven design.</p>
<p>What does it mean? That our code that handles security is not all over the place in <code>/src</code> directory but in standalone <code>packages/Security</code> directory. So if we work with security, we <del>only</del> mostly work in that directory.</p>
<h2 id="How-to-Configure-External-Tool-in-PHPStorm">How to Configure External Tool in PHPStorm?</h2>
<p>In PHPStorm open:</p>
<ul>
<li>Settings →</li>
<li>Tools →</li>
<li>External Tools</li>
</ul>
<p><br></p>
<p>Click on <em>+</em>:</p>
<img src="/assets/images/posts/2020/external_tool_add.png" class="img-thumbnail">
<p><br></p>
<p><strong>Name the tool and configure parameters</strong></p>
<ul>
<li>Program: <code>$ProjectFileDir$/vendor/bin/rector</code></li>
<li>Arguments: <code>process $FilePathRelativeToProjectRoot$</code></li>
<li>Working directory: <code>$ProjectFileDir$</code></li>
</ul>
<img src="/assets/images/posts/2020/external_tools_one.png" class="img-thumbnail">
<p><br></p>
<p>Save.</p>
<h2 id="How-to-Use-It">How to Use It?</h2>
<p>Pick the directory you want to process in the file tree.</p>
<p>Run action.</p>
<p>Type &quot;Rector&quot; or &quot;PHPStan&quot; and hit enter:</p>
<img src="/assets/images/posts/2020/external_tools_rector.gif" class="img-thumbnail">
<p><br></p>
<p>Kaboom :) That's it!</p>
<p><br></p>
<p>Happy flow coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/02/03/how-to-run-rector-and-phpstan-on-huge-project-in-3-seconds-with-phpstorm</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 03 Feb 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/02/03/how-to-run-rector-and-phpstan-on-huge-project-in-3-seconds-with-phpstorm#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Switch Travis to GitHub Actions to Reduce Stress ]]></title>
                <link>https://tomasvotruba.com/blog/2020/01/27/switch-travis-to-github-actions-to-reduce-stress</link>
                <description><![CDATA[ <p>In the previous post, we looked at <a href="/blog/2020/01/13/why-is-first-instant-feedback-crucial-to-developers/">Why is First Instant Feedback Crucial to Developers?</a>.
<br><br>
We know why now we look at <em>how</em>. How exactly migrate all jobs from Travis to GitHub Actions, <strong>reduce stress from long feedback loops</strong> and live a more healthy life as a programmer.
<br><br>
Yes, in code samples :)</p> ]]></description>
                <content:encoded><![CDATA[ <p>In this post, we'll look at examples of migration. I'll share my good and bad times with GitHub Action for my last 3 weeks using it on 5 open-source repositories with over 25 packages.</p>
<h2 id="The-Speed">The Speed</h2>
<blockquote class="blockquote text-center">
    From ~15 minutes to just 3 minutes.
</blockquote>
<p>I mean, that's a crazy improvement of 80 %. You can read about in <a href="/blog/2020/01/13/why-is-first-instant-feedback-crucial-to-developers/">the previous post</a>, so let's move on.</p>
<h2 id="The-Developer-s-Joy">The Developer's Joy</h2>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Github Actions just make everything so easy... <br><br>We merged 177 PR in <a href="https://twitter.com/rectorphp?ref_src=twsrc%5Etfw">@rectorphp</a> in the last month.<br><br>Instant feedback is killer feature for you devs. Don't let them wait...<a href="https://t.co/hP9Epe2CZW">https://t.co/hP9Epe2CZW</a> <a href="https://t.co/0Md9iIisXm">pic.twitter.com/0Md9iIisXm</a></p>— Tomas Votruba (@VotrubaT) <a href="https://twitter.com/VotrubaT/status/1220126675436032005?ref_src=twsrc%5Etfw">January 22, 2020</a></blockquote>
<p>Cocaine, Facebook, Twitter, and Instagram work the same way. A short feedback loop of dopamine.</p>
<p>The significant advantage of GitHub is that at the end of your addiction is not an endless loop in the brain, but <strong>higher productivity of your project</strong>.</p>
<h2 id="Simple-Unit-Test-in-Multiple-PHP-Versions">Simple Unit Test in Multiple PHP Versions</h2>
<p>We'll jump right into the most common case - unit tests.</p>
<p>In <strong>Travis CI</strong>, we had to:</p>
<ul>
<li>install dependencies,</li>
<li>set PHP versions</li>
<li>and run unit tests.</li>
</ul>
<pre><code class="language-yaml"># .travis.yml
os: linux

language: php

php:
    - '7.2'
    - '7.3'
    - '7.4'

before_install:
    # turn off XDebug
    - phpenv config-rm xdebug.ini

install:
    - composer install --no-progress

jobs:
    include:
        -
            stage: test
            name: "Unit Tests"
            script:
                - vendor/bin/phpunit --testsuite main</code></pre>
<p>In <strong>GitHub Action</strong> the same process look like this:</p>
<pre><code class="language-yaml"># .github/workflows/code_checks.yaml
name: Code_Checks

on:
    pull_request: null
    push:
        branches:
            - main

jobs:
    tests:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                php: ['7.2', '7.3', '7.4']

        name: PHP ${{ matrix.php }} tests
        steps:
            # basically git clone
            -   uses: actions/checkout@v2

            # use PHP of specific version
            -   uses: shivammathur/setup-php@v1
                with:
                    php-version: ${{ matrix.php }}
                    coverage: none # disable xdebug, pcov

            # if we 2 steps like this, we can better see if composer failed or tests
            -   run: composer install --no-progress

            -   run: vendor/bin/phpunit</code></pre>
<p>That's pretty huge for single and confusing to read at the same time, right?</p>
<p>All that clutter just for <code>vendor/bin/phpunit</code> to pass.</p>
<h2 id="Re-Use-Code-in-Github-Actions-Hell-No">Re-Use Code in Github Actions? Hell No!</h2>
<p>What is this?</p>
<pre><code class="language-yaml">-   uses: actions/checkout@v2</code></pre>
<p>Github Actions allow references to external <em>recipes</em>. It's usually just a set of actions, packages into a couple of lines in our workflow. You can see it on Github, e.g. <a href="https://github.com/actions/checkout">actions/checkout</a>. It's the recommended way to re-use code because there is no other way.</p>
<p>In reality: &quot;Do you want to re-use 5 lines of install and setup YAML code? Create a repository on Github, write 100 lines in JavaScript, and you're ready to go!&quot;</p>
<h3 id="No-DRY">No DRY</h3>
<p>Saying that we'll either have to create custom workflow repository or get used to these lines being repeated over and over:</p>
<pre><code class="language-yaml">-   uses: actions/checkout@v2

-   uses: shivammathur/setup-php@v1
    with:
        php-version: '7.3'
        coverage: none # xdebug is used by default

-   run: composer install --no-progress</code></pre>
<p>After a bit of experimenting, I got used to it for now. Also, Github Actions don't have anything close to <strong>YAML Anchors</strong> or re-use of previous job configuration like we have in Travis, e.g., share <code>install</code> for every job:</p>
<pre><code class="language-yaml"># .travis.yml
install:
    - composer install --no-progress</code></pre>
<p>Do you want YAML Anchors in Github Actions? <a href="https://github.community/t5/GitHub-Actions/Support-for-YAML-anchors/td-p/30336">Let them know</a>.</p>
<p><br></p>
<p>Now that we have the worst feature of Github Actions behind us, <strong>let's look at the excellent stuff</strong>.</p>
<h2 id="Power-of-External-Workflows">Power of External Workflows</h2>
<p>On the other hand, external workflows can solve a lot for us. Mainly for us, who don't want to dev-ops experts forever CI there is.</p>
<p>How do you enable code coverage by PHPUnit? <strong>Change single line</strong>:</p>
<pre><code class="language-diff">jobs:
    test_coverage:
        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@v2

            -   uses: shivammathur/setup-php@v1
                with:
                    php-version: '7.3'
-                   coverage: none
+                   coverage: pcov

            - run: vendor/bin/phpunit --coverage-clover coverage.xml build/logs/clover.xml</code></pre>
<h2 id="Coding-Standards">Coding Standards</h2>
<p>What is the most common use case for CI? Run <em>single line</em> in this <em>specific PHP version</em> → e.g., run coding standards on PHP 7.2.</p>
<p>In <strong>Travis CI</strong>:</p>
<pre><code class="language-yaml">language: php

install:
    - composer install --no-progress

jobs:
    include:
        -
            name: ECS
            php: 7.2
            script:
                - composer check-cs</code></pre>
<p>In <strong>Github Actions</strong>:</p>
<pre><code class="language-yaml"># .github/workflows/code_checks.yaml
jobs:
    ecs:
        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@v2
            -   uses: shivammathur/setup-php@v1
                with:
                    php-version: 7.2
                    coverage: none # disable xdebug, pcov
            -   run: composer install --no-progress
            -   run: composer check-cs</code></pre>
<h2 id="Learn-from-Working-Examples">Learn from Working Examples</h2>
<ul>
<li><a href="https://github.com/symplify/symplify/blob/373bbc80d73fd8c2777fdb5fb48386b456857b57/.github/workflows/code_checks.yaml"><code>code_checks.yaml</code> in symplify/symplify</a></li>
<li><a href="https://github.com/rectorphp/rector/blob/1f4b36dfedb1b07d8425093474fc5951358b0590/.github/workflows/code_checks.yml"><code>code_checks.yaml</code> in rectorphp/rector</a></li>
</ul>
<h2 id="Bad-Luck-Organization-with-Some-Private-Repositories">Bad Luck Organization with Some Private Repositories</h2>
<p>Some organizations don't have access to Github Actions because of some open-sources/private accounts.
This sucks a lot. I tried to have GitHub Actions on <a href="https://github.com/KnpLabs/DoctrineBehaviors/pull/494#issue-360222690">KnpLabs/DoctrineBehaviors</a>, but it's not possible unless the whole <em>KnpLabs</em> switches to some paid accounts. I spoke with support over a dozen emails, and it's wont fix.</p>
<p>How to work around this? If we create a new organization that is <strong>open-source only</strong>, it will work. Or we can just move the repository to an existing <strong>open-source only</strong> one.</p>
<h2 id="Add-Badge">Add Badge?</h2>
<p><strong>In Travis</strong>, you could add a badge for the whole build on a specific branch. It was nice that it skipped allowed failure.</p>
<p><strong>In GitHub Actions</strong>, it's different. <del>The badge covers <strong>1 specific workflow</strong>. This workflow should contain all the relevant jobs</del>.</p>
<p>Actually, on GitHub repository, there is only one badge for all:</p>
<img src="/assets/images/posts/github_actions_badge.png" class="img-thumbnail">
<h2 id="Concurrent-Jobs">Concurrent Jobs</h2>
<p><strong>Travis CI</strong> allow only <a href="https://travis-ci.com/plans">3 concurrent jobs</a>. This forces us to group similar checks like coding standard, static analysis, and Rector to one big job. If it failed, we had to look inside to find out which of these 3 areas is it.</p>
<p><strong>GitHub Actions</strong> allows you to run... wait for it <a href="https://help.github.com/en/actions/automating-your-workflow-with-github-actions/about-github-actions#usage-limits"><strong>20 jobs</strong></a>.</p>
<p>Thanks to that, we can have one job for each of:</p>
<ul>
<li><code>bin/console lint:yaml</code></li>
<li><code>bin/console lint:twig</code></li>
<li><code>bin/console lint:container</code></li>
</ul>
<p>When <code>bin/console lint:twig</code> fails, we know right in the pull-request it's something in our templates. That's good quality, precise feedback.</p>
<h2 id="Where-Should-We-Stay-with-Travis-CI">Where Should We Stay with Travis CI</h2>
<h3 id="Local-Git">Local Git</h3>
<p>GitHub Actions are tough to work with local git. I migrated Symplify/MonorepoBuilder and Symplfiy/ChangelogLinker to Github Actions, and it's only troubling.</p>
<h3 id="Building-of-PHAR-and-Push-to-Another-Repository">Building of PHAR and Push to Another Repository</h3>
<p>Another weakness is the inability to get the current tag. That's right. Getting something as simple as an existing tag is rocket science.</p>
<p>That's why we had to <a href="https://github.com/rectorphp/rector/blob/1f4b36dfedb1b07d8425093474fc5951358b0590/.travis.yml">revert <code>rector.phar</code> build and publish to Travis CI</a>.</p>
<h3 id="Monorepo-Split">Monorepo Split</h3>
<p>The monorepo split is the most massive performance operation on the whole CI. Also, GitHub actions have different git settings that break it — saying that it makes sense to have 20 parallel jobs on GitHub Actions and the heaviest on Travis. <strong>We kept <a href="https://github.com/symplify/symplify/blob/716eef260fcdf21362361cc9a3dab51a5a0408eb/.travis.yml#L9-L16">monorepo split</a> on Travis as the only job</strong> and it's now faster than ever.</p>
<p><br></p>
<p>I think that's due to the service being pretty new to the market. I hope these issues will be seen as primitive soon. For the rest of the features, <strong>I love GitHub Action</strong> and think you'll too after having feedback under 3 minutes after the last commit :).</p>
<p><br></p>
<p>Happy coding!</p>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/01/27/switch-travis-to-github-actions-to-reduce-stress</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 27 Jan 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/01/27/switch-travis-to-github-actions-to-reduce-stress#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Introducing PHAR for Easy Coding Standard ]]></title>
                <link>https://tomasvotruba.com/blog/2020/01/20/introducing-phar-for-easy-coding-standard</link>
                <description><![CDATA[ <p>Recently months there was huge jump in using ECS, <a href="https://packagist.org/packages/symplify/easy-coding-standard/stats">almost 4 000 downloads daily now</a>!
<br>
<br>
With this downloads growth, there is also growing demand for using it on older and older PHP projects. <strong>ECS brings huge value there, as it helps with migration of code and cleaning it up</strong>.
<br>
<br>
The problem is that ECS uses modern packages and it <strong>makes installation on old projects impossible</strong>.
<br>
<br>
Does it though in 2020?</p> ]]></description>
                <content:encoded><![CDATA[ <p><br></p>
<p>This is how installation on old project makes us angry:</p>
<img src="/assets/images/posts/ecs_prefixed.gif" class="img-thumbnail">
<p><strong>I don't like it when developers are frustrated by the limits of the system they use</strong>. My mission is quite the opposite - make a complex system simple and easy to use by anyone.</p>
<p>So I took a few-days effort and made a prefixed PHAR Easy Coding Standard version for legacy projects. You can see <a href="https://github.com/symplify/symplify/pull/1734">Pull Request on Github</a>.</p>
<p>The first release of the prefixed version is v7.2.2, so you can enjoy all the cool features like <a href="https://github.com/symplify/symplify/pull/1537"><code>only</code></a> and <a href="https://github.com/symplify/symplify/pull/1735"><code>paths</code> parameters</a>.</p>
<h2 id="Add-prefixed-and-It-Works">Add <code>-prefixed</code> and It Works</h2>
<p>Really. So instead of normal package installation:</p>
<pre><code class="language-bash">composer require symplify/easy-coding-standard --dev</code></pre>
<p>Use the <code>-prefixed</code> version:</p>
<pre><code class="language-bash">composer require symplify/easy-coding-standard-prefixed --dev</code></pre>
<p><strong>And you're ready to go!</strong></p>
<pre><code class="language-bash">vendor/bin/ecs</code></pre>
<h2 id="">✅</h2>
<p><br></p>
<h2 id="What-are-Prefixed-PHARs-and-How-They-Work">What are Prefixed PHARs and How They Work?</h2>
<p>I will not bother you with technical details, but if you're working on PHP CLI app and you want to <strong>make it accessible to the majority of PHP developers</strong>, you can learn more here:</p>
<ul>
<li><a href="/blog/2019/12/02/how-to-box-symfony-app-to-phar-without-killing-yourself/">How to Box Symfony App to PHAR without Killing Yourself</a></li>
<li><a href="https://getrector.org/blog/2020/01/20/how-to-install-rector-despite-composer-conflicts">How to install Rector despite Composer Conflicts</a></li>
</ul>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/01/20/introducing-phar-for-easy-coding-standard</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 20 Jan 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/01/20/introducing-phar-for-easy-coding-standard#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Why is First Instant Feedback Crucial to Developers? ]]></title>
                <link>https://tomasvotruba.com/blog/2020/01/13/why-is-first-instant-feedback-crucial-to-developers</link>
                <description><![CDATA[ <p>Do you <em>open-source</em>? Then you know that instant feedback is crucial to your contributors. The same applies to private companies.
<br>
<br>
There are <strong>2 types of feedback</strong>: from human and machine.
<br>
<br>
Which and how can we improve?</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="and-lt-Faster-Slow-and-gt-Reaction-Result">&lt;Faster|Slow&gt; Reaction → <T>Result</h2>
<p>When they send PR to your project, and you let them wait for a week, they won't be so excited to process your code-review.</p>
<p>But when you react <strong>the same day or same hour</strong>, there is a significant change the PR will be updated and merged on the same day.</p>
<p>Honestly, <strong>maintainers are not human routers for Github notifications</strong>, and you have to be lucky to hit them at the same time you're online.</p>
<p><strong>How can we make feedback instant anyway?</strong></p>
<h2 id="More-than-5-minutes-We-ve-Lost-a-Contributor">More than 5 minutes? We've Lost a Contributor</h2>
<p>Do you know <a href="https://en.wikipedia.org/wiki/Time_to_first_byte">TTFB</a> - <em>time to first byte</em> - from front-end world?</p>
<p>There could be <strong>TTFF</strong> for pull-request: <em>time to first feedback</em>.</p>
<p>In my experience, when someone creates a PR to an open-source, <strong>they have carefully made time for it</strong>. In today's <a href="https://www.calnewport.com/blog/2017/11/30/on-the-complicated-economics-of-attention-capital">attention economy</a>, its the most expensive resource people have.</p>
<h2 id="Example-How-an-Hour-for-Open-Source-is-used">Example: How an Hour for Open-Source is used?</h2>
<p>Let's say you have started your dedicated hour to open-source a week.</p>
<p><strong>You send PR</strong> with your feature, the maintainer is not online, so you wait:</p>
<ul>
<li>5 minutes...</li>
<li>10 minutes...</li>
<li>13 minutes...</li>
<li>...and CI failed on test case</li>
</ul>
<p><br></p>
<p><strong>You fix the test</strong>, send new commit to the PR branch and wait:</p>
<ul>
<li>5 minutes...</li>
<li>10 minutes...</li>
<li>13 minutes...</li>
<li>...and CI fails on invalid coding standards</li>
</ul>
<p>Now you've spend <strong>40 minutes</strong> of your 60 minutes by:</p>
<ul>
<li>10 minutes making feature</li>
<li>4 fixing one test case</li>
<li><strong>26 minutes by waiting</strong></li>
</ul>
<p>That's <strong>65 % percent time wasted</strong>.</p>
<p><br></p>
<p>This makes me wanna throw the computer out of the window, procrastinate, check my messages or another shallow work that ruins all my focus.</p>
<p><strong>True story</strong>, this was the situation for CI in Rector in 2019. It was soo frustrating. And I don't talk about <a href="/blog/2019/09/02/how-to-speedup-test-coverage-on-travis-by-95-percent/">code coverage with Xdebug that took us 33 minutes</a>.</p>
<p><br></p>
<h2 id="Have-you-Met-Github-Actions">Have you Met... Github Actions?</h2>
<p>A miracle came to my life. Exactly week ago <a href="https://github.com/staabm">Markus Staab</a> talked about the idea of trying Github Actions in Rector repository to ease work to Travis CI.</p>
<h2 id="What-are-Github-Actions">What are Github Actions?</h2>
<p>I've heard about Github Actions, but I didn't get the idea. Is it for deploy or a bot?</p>
<p>Now I know it's basically <em>Github CI</em> (honestly, they should rename it).</p>
<p>How does it work? Like in any other CI (Travis CI, Gitlab CI, Bitbucket CI, Circle CI, Jenkins...), we basically:</p>
<ul>
<li>configure some YAML file</li>
<li>push some code change to your git</li>
<li>and wait for a green or red light</li>
</ul>
<p>That's it! I used obvious choice for open-source - Travis CI - for the last 8 years, but <strong>the speed was bugging me</strong>.</p>
<p>When I saw <a href="https://github.com/rectorphp/rector/pull/2589/files">first pull-request by Markus</a>, I had no idea where this will end.</p>
<h2 id="Travis-CI-and-Github-Actions-in-Numbers">Travis CI and Github Actions in Numbers</h2>
<p>From all the metrics out there, these tell the main story:</p>
<p><strong>Travis CI</strong></p>
<ul>
<li><a href="https://travis-ci.com/plans">3 concurrent jobs</a></li>
<li>waits 1-4 minutes after commit, before it even starts</li>
</ul>
<p><strong>Github Actions</strong></p>
<ul>
<li><a href="https://help.github.com/en/actions/automating-your-workflow-with-github-actions/about-github-actions#usage-limits">20 concurrent jobs</a></li>
<li>starts all jobs in 20-30 seconds after the commit</li>
</ul>
<p><br></p>
<p>And how does the switch affected the Rector repository?</p>
<img src="/assets/images/posts/instant_feedback_travis_ci.jpg" class="img-thumbnail" style="max-width: 40em">
<p>↓</p>
<img src="/assets/images/posts/instant_feedback_github_actions.jpg" class="img-thumbnail" style="max-width: 40em">
<blockquote class="blockquote text-center">
    From ~15 minutes to just 3 minutes.
</blockquote>
<p><strong>I was amazed! Thank you, Mark, for making this happen.</strong></p>
<p><br></p>
<p>In the next post, we'll look at <strong>practical migration</strong> of common and less-common open-source features. We'll look at Github Actions' weaknesses and migrate a massive pipeline with 15 jobs.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/01/13/why-is-first-instant-feedback-crucial-to-developers</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 13 Jan 2020 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/01/13/why-is-first-instant-feedback-crucial-to-developers#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Migrate Gedmo to KnpLabs ]]></title>
                <link>https://tomasvotruba.com/blog/2020/01/06/migrate-gedmo-to-knplabs</link>
                <description><![CDATA[ <p>With <a href="/blog/2019/09/09/how-we-upgraded-pehapkari-cz-from-symfony-4-to-5-in-25-days/">Symfony 5 upgrade</a>, we need any <em>working</em> Doctrine behaviors.
<br>
Month later, we have <a href="/blog/2019/12/30/doctrine-behaviors-2-0-reloaded/#how-do-you-migrate-from-gedmo-stof-to-knplabs-doctrinebehaviors">KnpLabs\DoctrineBehaviors 2.0</a> with full Symfony 5 support.
<br>
<br>
If you used older Doctrine Behaviors, you're covered with Rector migration path.
<br>
But what if you're using old broken Gedmo?
<br>
<br>
<strong>I'll show you how you can migrate Gedmo to KnpLabs</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Pick behavior your want to migrate from Gedmo to KnpLabs:</p>
<ul>
<li><a href="#1-migrate-timestampable">1. Timestampable</a></li>
<li><a href="#2-migrate-sluggable">2. Sluggable</a></li>
<li><a href="#3-migrate-tree">3. Tree</a></li>
<li><a href="#4-migrate-translatable">4. Translatable</a></li>
<li><a href="#5-migrate-blameable">5. Blameable</a></li>
<li><a href="#6-migrate-loggable">6. Loggable</a></li>
<li><a href="#7-migrate-softdeletable">7. SoftDeletable</a></li>
</ul>
<p><br></p>
<p>If you <strong>use other Gedmo behavior that is not listed here</strong>, you might request or better add it to <a href="https://github.com/KnpLabs/DoctrineBehaviors">KnpLabs</a> repository via pull-request. I assure you I'll provide <a href="/blog/2019/12/30/doctrine-behaviors-2-0-reloaded/">stable maintenance support</a> for KnpLabs package. It's not that hard with CI on steroids it has now.</p>
<p><br></p>
<h2 id="1-Migrate-Timestampable">1. Migrate Timestampable</h2>
<h3 id="Gedmo">Gedmo</h3>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Entity;

use Doctrine\ORM\Mapping as ORM;
use Gedmo\Timestampable\Traits\TimestampableEntity;

/**
 * @ORM\Entity
 */
class Meetup
{
    use TimestampableEntity;
}</code></pre>
<p>↓</p>
<h3 id="KnpLabs">KnpLabs</h3>
<ul>
<li>Replace trait with <code>Knp\DoctrineBehaviors\Model\Timestampable\TimestampableTrait</code></li>
<li>Add <code>Knp\DoctrineBehaviors\Contract\Entity\TimestampableInterface</code> interface</li>
</ul>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Entity;

use Doctrine\ORM\Mapping as ORM;
use Knp\DoctrineBehaviors\Model\Timestampable\TimestampableTrait;
use Knp\DoctrineBehaviors\Contract\Entity\TimestampableInterface;

/**
 * @ORM\Entity
 */
class Meetup implements TimestampableInterface
{
    use TimestampableTrait;
}</code></pre>
<h2 id="2-Migrate-Sluggable">2. Migrate Sluggable</h2>
<h3 id="Gedmo">Gedmo</h3>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Entity;

use Doctrine\ORM\Mapping as ORM;
use Gedmo\Mapping\Annotation as Gedmo;

/**
 * @ORM\Entity
 */
class Meetup
{
    /**
     * @Gedmo\Slug(fields={"name"})
     */
    private $slug;

    public function getSlug(): ?string
    {
        return $this-&gt;slug;
    }

    public function setSlug(?string $slug): void
    {
        $this-&gt;slug = $slug;
    }
}</code></pre>
<p>↓</p>
<h3 id="KnpLabs">KnpLabs</h3>
<ul>
<li>
<p>Add <code>Knp\DoctrineBehaviors\Model\Sluggable\SluggableTrait</code> trait</p>
</li>
<li>
<p>Add <code>Knp\DoctrineBehaviors\Contract\Entity\SluggableInterface</code> interface</p>
</li>
<li>
<p>Remove <code>getSlug()</code>/<code>setSlug()</code> method that is already in trait</p>
</li>
<li>
<p>Replace <code>* @Gedmo\Slug(fields={"name"})</code> with <code>getSluggableFields()</code> method that contains fields</p>
<p>E.g., from:</p>
</li>
</ul>
<pre><code class="language-php">use Gedmo\Mapping\Annotation as Gedmo;

// ...

/**
 * @Gedmo\Slug(fields={"name", "surname"})
 */
private $slug;</code></pre>
<p>to</p>
<pre><code class="language-php">
/**
 * @return string[]
 */
public function getSluggableFields(): array
{
    return ['name', 'surname'];
}</code></pre>
<p><br></p>
<p>In full code:</p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Entity;

use Doctrine\ORM\Mapping as ORM;
use Knp\DoctrineBehaviors\Model\Sluggable\SluggableTrait;
use Knp\DoctrineBehaviors\Contract\Entity\SluggableInterface;

/**
 * @ORM\Entity
 */
class Category implements SluggableInterface
{
    use SluggableTrait;

    /**
     * @return string[]
     */
    public function getSluggableFields(): array
    {
        return ['name'];
    }
}</code></pre>
<h2 id="3-Migrate-Tree">3. Migrate Tree</h2>
<p>This one will be tricky, because:</p>
<ul>
<li>Gedmo supports <em>nested-set</em>, <em>closure-table</em> and <em>materialized-path</em>.</li>
<li>KnpLabs currently supports <a href="https://knplabs.com/en/blog/knp-doctrine-orm-behaviors">materialized path</a></li>
</ul>
<p>So if you're using anything but materialized path in Gedmo, you'll have to migrate PHP code (see below) + <strong>migrate your database data to materialized path</strong> (write your migration or Google one).</p>
<p><br></p>
<p>The PHP migration looks like this:</p>
<h3 id="Gedmo">Gedmo</h3>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Entity;

use Doctrine\ORM\Mapping as ORM;
use Doctrine\Common\Collections\Collection;
use Gedmo\Mapping\Annotation as Gedmo;

/**
 * @ORM\Entity
 * @Gedmo\Tree(type="nested")
 */
class Category
{
    /**
     * @Gedmo\TreeLeft
     * @ORM\Column(name="lft", type="integer")
     * @var int
     */
    private $lft;

    /**
     * @Gedmo\TreeRight
     * @ORM\Column(name="rgt", type="integer")
     * @var int
     */
    private $rgt;

    /**
     * @Gedmo\TreeLevel
     * @ORM\Column(name="lvl", type="integer")
     * @var int
     */
    private $lvl;

    /**
     * @Gedmo\TreeRoot
     * @ORM\ManyToOne(targetEntity="Category")
     * @ORM\JoinColumn(name="tree_root", referencedColumnName="id", onDelete="CASCADE")
     * @var Category
     */
    private $root;

    /**
     * @Gedmo\TreeParent
     * @ORM\ManyToOne(targetEntity="Category", inversedBy="children")
     * @ORM\JoinColumn(name="parent_id", referencedColumnName="id", onDelete="CASCADE")
     * @var Category
     */
    private $parent;

    /**
     * @ORM\OneToMany(targetEntity="Category", mappedBy="parent")
     * @var Category[]|Collection
     */
    private $children;

    public function getRoot(): self
    {
        return $this-&gt;root;
    }

    public function setParent(self $category): void
    {
        $this-&gt;parent = $category;
    }

    public function getParent(): self
    {
        return $this-&gt;parent;
    }
}</code></pre>
<p>↓</p>
<h3 id="KnpLabs">KnpLabs</h3>
<ul>
<li>Add <code>Knp\DoctrineBehaviors\Model\Tree\TreeNodeTrait</code> trait</li>
<li>Add <code>Knp\DoctrineBehaviors\Contract\Entity\TreeNodeInterface</code> interface</li>
<li>Remove all tree related properties and methods, since they're in trait now</li>
<li>Remove Gedmo annotations</li>
</ul>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Entity;

use Doctrine\ORM\Mapping as ORM;
use Doctrine\Common\Collections\Collection;
use Knp\DoctrineBehaviors\Contract\Entity\TreeNodeInterface;
use Knp\DoctrineBehaviors\Model\Tree\TreeNodeTrait;

/**
 * @ORM\Entity
 */
class Category implements TreeNodeInterface
{
    use TreeNodeTrait;
}</code></pre>
<h2 id="4-Migrate-Translatable">4. Migrate Translatable</h2>
<h3 id="What-about-Performance">What about Performance?</h3>
<p>I recall picking the behavior package for new Lekarna.cz 6 years ago. I was young, and a quantity was more than quality to me, so I was leaning towards Gedmo since it had more downloads.</p>
<p>But it's performance surprised me. Why? The translated item had 1:many dependency on translation table, so for every single item, it <strong>joined an X extra lines forever single translated column</strong>.</p>
<p>So even if you use Symfony 4 and <strong>everything works well</strong> for you, <strong>consider comparing performance with KnpLabs translations</strong>. Who knows, it might get your multi-lingual application <strong>10x faster</strong>.</p>
<p><br></p>
<h3 id="Gedmo">Gedmo</h3>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Entity;

use Gedmo\Mapping\Annotation as Gedmo;
use Doctrine\ORM\Mapping as ORM;
use Gedmo\Translatable\Translatable;

/**
 * @ORM\Entity
 */
class Category implements Translatable
{
    /**
     * @Gedmo\Translatable
     * @ORM\Column(length=128)
     */
    private $title;

    /**
     * @Gedmo\Locale
     */
    private $locale;

    public function setTitle($title)
    {
        $this-&gt;title = $title;
    }

    public function getTitle()
    {
        return $this-&gt;title;
    }

    public function setTranslatableLocale($locale)
    {
        $this-&gt;locale = $locale;
    }
}</code></pre>
<p>↓</p>
<h3 id="KnpLabs">KnpLabs</h3>
<ul>
<li>Replace interface with <code>Knp\DoctrineBehaviors\Contract\Entity\TranslatableInterface</code></li>
<li>Add <code>Knp\DoctrineBehaviors\Model\Translatable\TranslatableTrait</code></li>
<li>Remove all translated fields and locale methods from main entity</li>
<li>Remove Gedmo annotations</li>
</ul>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Entity;

use Knp\DoctrineBehaviors\Model\Translatable\TranslatableTrait;
use Knp\DoctrineBehaviors\Contract\Entity\TranslatableInterface;

class Category implements TranslatableInterface
{
    use TranslatableTrait;
}</code></pre>
<p>So, where is the <em>title</em> property we need to translate? Every translated property is in the new <code>&lt;entity&gt;Translation</code> class.
This <strong>approach makes sure that the complexity of 1 item with dozens of translation stays 1:1</strong> = it's super fast!</p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Entity;

use Knp\DoctrineBehaviors\Contract\Entity\TranslationInterface;
use Knp\DoctrineBehaviors\Model\Translatable\TranslationTrait;

class CategoryTranslation implements TranslationInterface
{
    use TranslationTrait;

    /**
     * @ORM\Column(length=128)
     */
    private $title;
}</code></pre>
<p>In short:</p>
<ul>
<li><em>Translatable</em> - the primary entity you use in your code</li>
<li><em>Translation</em> - the helper entity with translated items</li>
</ul>
<p>Usage stays the same:</p>
<pre><code class="language-php">$category-&gt;getTitle();</code></pre>
<p>That's all for the migration. Oh, you're still reading? Are you waiting for some easy solution to cover it all?</p>
<h2 id="5-Migrate-Blameable">5. Migrate Blameable</h2>
<h3 id="Gedmo">Gedmo</h3>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Entity;

use Gedmo\Mapping\Annotation as Gedmo;
use Doctrine\ORM\Mapping as ORM;

/**
 * @ORM\Entity
 */
class Category
{
    /**
     * @Gedmo\Blameable(on="create")
     */
    private $createdBy;

    /**
     * @Gedmo\Blameable(on="update")
     */
    private $updatedBy;

    public function getCreatedBy()
    {
        return $this-&gt;createdBy;
    }

    public function getUpdatedBy()
    {
        return $this-&gt;updatedBy;
    }
}</code></pre>
<p>↓</p>
<h3 id="KnpLabs">KnpLabs</h3>
<ul>
<li>Add <code>Knp\DoctrineBehaviors\Contract\Entity\BlameableInterface</code> interface</li>
<li>Add <code>Knp\DoctrineBehaviors\Model\Blameable\BlameableTrait</code> trait</li>
<li>Remove Gedmo annotations</li>
</ul>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Entity;

use Doctrine\ORM\Mapping as ORM;
use Knp\DoctrineBehaviors\Contract\Entity\BlameableInterface;
use Knp\DoctrineBehaviors\Model\Blameable\BlameableTrait;

/**
 * @ORM\Entity
 */
class Category implements BlameableInterface
{
    use BlameableTrait;
}</code></pre>
<h2 id="6-Migrate-Loggable">6. Migrate Loggable</h2>
<h3 id="Gedmo">Gedmo</h3>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Entity;

use Gedmo\Mapping\Annotation as Gedmo;
use Doctrine\ORM\Mapping as ORM;

/**
 * @ORM\Entity
 * @Gedmo\Loggable
 */
class Category
{
    /**
     * @Gedmo\Versioned
     * @ORM\Column(name="title", type="string", length=8)
     */
    private $title;
}</code></pre>
<p>↓</p>
<h3 id="KnpLabs">KnpLabs</h3>
<ul>
<li>Add <code>Knp\DoctrineBehaviors\Model\Loggable\LoggableTrait</code> trait</li>
<li>Add <code>Knp\DoctrineBehaviors\Contract\Entity\LoggableInterface</code> interface</li>
<li>Remove Gedmo annotations</li>
</ul>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Entity;

use Doctrine\ORM\Mapping as ORM;
use Knp\DoctrineBehaviors\Model\Loggable\LoggableTrait;
use Knp\DoctrineBehaviors\Contract\Entity\LoggableInterface;

/**
 * @ORM\Entity
 */
class Category implements LoggableInterface
{
    use LoggableTrait;

    /**
     * @ORM\Column(name="title", type="string", length=8)
     */
    private $title;
}</code></pre>
<h2 id="7-Migrate-SoftDeletable">7. Migrate SoftDeletable</h2>
<h3 id="Gedmo">Gedmo</h3>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Entity;

use Doctrine\ORM\Mapping as ORM;
use Gedmo\Mapping\Annotation as Gedmo;

/**
 * @Gedmo\SoftDeleteable(fieldName="deletedAt", timeAware=false, hardDelete=true)
 * @ORM\Entity
 */
class Category
{
    /**
     * @ORM\Column(name="deletedAt", type="datetime", nullable=true)
     */
    private $deletedAt;

    public function getDeletedAt()
    {
        return $this-&gt;deletedAt;
    }

    public function setDeletedAt($deletedAt)
    {
        $this-&gt;deletedAt = $deletedAt;
    }
}</code></pre>
<p>↓</p>
<h3 id="KnpLabs">KnpLabs</h3>
<ul>
<li>Add <code>Knp\DoctrineBehaviors\Contract\Entity\SoftDeletableInterface</code> interface</li>
<li>Add <code>Knp\DoctrineBehaviors\Model\SoftDeletable\SoftDeletableTrait</code> trait</li>
<li>Remove Gedmo annotations</li>
</ul>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Entity;

use Knp\DoctrineBehaviors\Contract\Entity\SoftDeletableInterface;
use Knp\DoctrineBehaviors\Model\SoftDeletable\SoftDeletableTrait;

class Category implements SoftDeletableInterface
{
    use SoftDeletableTrait;
}</code></pre>
<p>Would you like to avoid doing this manually? Rector has a set just for you:</p>
<h2 id="3-Step-to-Migrate-Gedmo-to-KnpLabs-with-Rector">3 Step to Migrate Gedmo to KnpLabs with Rector</h2>
<ol>
<li>Install Rector</li>
</ol>
<pre><code class="language-bash">composer require rector/rector --dev</code></pre>
<p><div class="card ml-4 mt-4 border-warning float-right post-snippet" style="width: 14em">
    <div class="card-body">
        Would you like to <strong>learn more about Rector</strong>? Step by step, from zero to hero?
        <br>

        <div class="text-center">
            <a href="/book/the-power-of-automated-refactoring/">
                <img src="/assets/images/rector_book.png" class="mb-3 mt-3 shadow">
                Get our new book
            </a>
        </div>
    </div>
</div>
</p>
<ol start="2">
<li>Add <code>rector.php</code> config</li>
</ol>
<pre><code class="language-php">use Rector\Doctrine\Set\DoctrineSetList;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;import(DoctrineSetList::DOCTRINE_GEDMO_TO_KNPLABS);
};</code></pre>
<ol start="3">
<li>Run Rector</li>
</ol>
<pre><code class="language-bash">vendor/bin/rector process src</code></pre>
<p>That's it!</p>
<p><br></p>
<p>Instant upgrades never cover the whole migration path - e.g., they lack database migrations - but they're are always <strong>saving you 80 % of boring work</strong>. If anything breaks, <a href="https://github.com/rectorphp/rector/issues/new?template=1_Bug_report.md">create and issue on Github</a> so you can enjoy fixed version soon.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2020/01/06/migrate-gedmo-to-knplabs</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 06 Jan 2020 00:00:00 +0000</pubDate>
                                    <updated>2020-11-01UTC00:00:000</updated>
                    <atom:updated>Sun, 01 Nov 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sun, 01 Nov 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2020/01/06/migrate-gedmo-to-knplabs#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Doctrine Behaviors 2.0 - Reloaded ]]></title>
                <link>https://tomasvotruba.com/blog/2019/12/30/doctrine-behaviors-2-0-reloaded</link>
                <description><![CDATA[ <p>In <a href="/blog/2019/09/09/how-we-upgraded-pehapkari-cz-from-symfony-4-to-5-in-25-days//">How we Upgraded Pehapkari.cz from Symfony 4 to 5 in 25 days</a> post, there is a section about Doctrine Behaviors in Symfony 5.
<br><br>
<strong>None of stof, gedmo, nor KnpLabs is working with Symfony 5</strong>. There are many issues in each of those projects asking for maintainers to merge PRs and tag it. One of those issues was heard, and the owner gave me maintainer access.
<br><br>
How does it look 3 weeks later?</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="From-First-Excitement-Rush-to-Heavy-Burden-of-Responsibility">From First Excitement Rush to Heavy Burden of Responsibility</h2>
<p><a href="https://github.com/KnpLabs/DoctrineBehaviors">KnpLabs/DoctrineBehaviors</a> development was stuck since 2015. There were 10+ opened PRs to use interfaces over traits (to give classes clear contract), bug-fix PRs, and design improvements.</p>
<p>When I got a message from KnpLabs with an offer to maintain, I was super happy to say <a href="https://sivers.org/hellyeah">&quot;hell, yeah&quot;</a>. An excitement rush went through my veins. I could saw all the huge refactoring for better and how it helps the whole PHP community to move another step forward.</p>
<p>A moment later, when I realized what happened and how quickly, I started to be scared. The repository looked like a massive chunk of code that will need many design changes,  back compatibility breaks, etc. <strong>All the responsibility started to fall on my shoulders, and it was heavy</strong>.</p>
<p>I took it as challenge and started to <a href="/blog/2018/04/30/programming-climbing-a-huge-mountain/">climb mountain</a>, without knowing if or how this will end-up.</p>
<blockquote class="blockquote text-center">
    There were only 2 options:<br>finished tagged version 2 or burn-out in the process.
</blockquote>
<p>I took the risk.</p>
<h2 id="What-Can-We-Do-in-3-Weeks">What Can We Do in 3 Weeks?</h2>
<ul>
<li><strong>39 merged pull-requests</strong></li>
<li><strong>93 closed issues</strong></li>
<li><strong>5 alpha/beta tag releases</strong></li>
<li>full support of Symfony 4.4 and 5</li>
</ul>
<p><br></p>
<img src="/assets/images/posts/doc_beha_pulse.png" class="img-thumbnail">
<p><br></p>
<p><strong>Added/removed lines per week:</strong></p>
<img src="/assets/images/posts/doc_beha_stats.png" class="img-thumbnail">
<h2 id="What-is-new-in-Doctrine-Behaviors-2-0">What is new in Doctrine Behaviors 2.0?</h2>
<p>All right, you get it. There were lots changes, but what exactly?</p>
<p>Let's start with the <em>sad part</em>.</p>
<h3 id="3-Removed-Behaviors">3 Removed Behaviors</h3>
<p>Tests did not cover some behaviors, nor described in README. When you look at them closely and write a test for them, you'll see <strong>they never worked</strong> or worked accidentally. I've cross-references these features with <a href="https://packagist.org/packages/gedmo/doctrine-extensions">gedmo/doctrine-extensions</a> and saw DoctrineBehaviors is the only package that has them, resp. pretend to have them.</p>
<p><br></p>
<p><strong>Saying that these 3 behaviors were dropped:</strong></p>
<p><a href="https://github.com/KnpLabs/DoctrineBehaviors/pull/473">Sortable</a></p>
<ul>
<li>it only updated all values to <code>1</code>, completely broken</li>
</ul>
<p><a href="https://github.com/KnpLabs/DoctrineBehaviors/pull/467">Geocodable</a></p>
<ul>
<li>it only worked on PostgreSQL with a specific function</li>
<li>has a conflict with km/miles</li>
<li>method API was very limited to a few narrow cases</li>
</ul>
<p><a href="https://github.com/KnpLabs/DoctrineBehaviors/pull/463">Filterable</a></p>
<ul>
<li>overcomplicated API 4 required methods for single simple filter</li>
<li>basically <code>findBy*()</code> magic on steroids, better use explicit non-magic methods with clear naming</li>
</ul>
<p><strong>It is recommended to implement them yourself that suite your specific needs</strong>.</p>
<p><br></p>
<p>Now that the sad part is behind us let's look at new features.</p>
<h3 id="From-Trait-to-Interface">From Trait to Interface</h3>
<p>This work was initiated <strong>by <a href="https://github.com/bocharsky-bw">bocharsky-bw</a> and <a href="https://github.com/lemoinem">@lemoinem</a></strong> back in 2016. Thank you both for clear PRs, it was quite easy for me to see changes and apply them to new and drastically different code <a href="https://github.com/KnpLabs/DoctrineBehaviors/pull/442">in this single PR</a>.</p>
<p><strong>The idea is simple</strong>: instead of traits that are problematic to detect by <code>instanceof</code> or <code>is_a()</code>, use interface for method and class contract.</p>
<p><br></p>
<p>What does it mean? This is <em>trait-first</em> approach:</p>
<pre><code class="language-php">&lt;?php

namespace App\Entity;

use Doctrine\ORM\Mapping as ORM;
use Knp\DoctrineBehaviors\Model\Timestampable\TimestampableTrait;

/**
 * @ORM\Entity
 */
class Product
{
    use TimestampableTrait;
}</code></pre>
<p>You use traits, so you don't have to create properties (<code>$createdBy</code> and <code>$updatedBy</code> in this case) manually. There are also 2 split traits for methods and properties, so the code above equals:</p>
<pre><code class="language-php">&lt;?php

namespace App\Entity;

use Doctrine\ORM\Mapping as ORM;
use Knp\DoctrineBehaviors\Model\Timestampable\TimestampablePropertiesTrait;
use Knp\DoctrineBehaviors\Model\Timestampable\TimestampableMethodsTrait;

/**
 * @ORM\Entity
 */
class Product
{
    use TimestampablePropertiesTrait;
    use TimestampableMethodsTrait;
}</code></pre>
<p>But what happens if you remove trait and want to override methods?</p>
<pre><code class="language-php">&lt;?php

namespace App\Entity;

use Doctrine\ORM\Mapping as ORM;

/**
 * @ORM\Entity
 */
class Product
{
}</code></pre>
<p>Well, there is no contract by an interface, so we have no idea to fix this, we introduced interfaces:</p>
<pre><code class="language-php">&lt;?php

namespace App\Entity;

use Doctrine\ORM\Mapping as ORM;
use Knp\DoctrineBehaviors\Contract\Entity\TimestampableInterface;

/**
 * @ORM\Entity
 */
class Product implements TimestampableInterface
{
}</code></pre>
<p>Now PHPStorm tells you what methods it needs. You can use your code or a trait to cover them.</p>
<p>It also easy to detect an object that uses this behavior, which significantly improved performance and architecture at the same time:</p>
<pre><code class="language-php">use Knp\DoctrineBehaviors\Contract\Entity\TimestampableInterface;

// object
$isTimestampableEntity = $entity instanceof TimestampableInterface;

// string class name
$isTimestampableEntity = is_a($entityClass, TimestampableInterface::class, true);</code></pre>
<h3 id="Translation-now-needs-Id">Translation now needs Id</h3>
<p>All the behaviors didn't add any id properties. Except for translation, where the id was added with this ugly magic method (mind the <code>@deprecated</code> note):</p>
<img src="/assets/images/posts/doc_beha_id_magic.png" class="img-thumbnail">
<p>The <a href="https://github.com/KnpLabs/DoctrineBehaviors/issues/154">inconsistency</a> <a href="https://github.com/KnpLabs/DoctrineBehaviors/issues/415">was</a> <a href="https://github.com/KnpLabs/DoctrineBehaviors/pull/158">problematic</a>. In short: it was buggy and hard to use your id property because DoctrineBehaviors tried to <em>guess</em> what id you probably want.</p>
<p>The fix was suggested <a href="https://github.com/KnpLabs/DoctrineBehaviors/pull/421">early 2019</a>, but the final fix was <a href="https://github.com/KnpLabs/DoctrineBehaviors/pull/480/files">merged in 2020</a>.</p>
<p>What does it mean for your entities? <strong>You need to add their own id</strong>:</p>
<pre><code class="language-diff"> &lt;?php

 namespace App\Entity;

 use Knp\DoctrineBehaviors\Contract\Entity\TranslatableInterface;
 use Knp\DoctrineBehaviors\Model\Translatable\TranslatableTrait;

 /**
  * @ORM\Entity
  */
 class TranslatableEntityTranslation implements TranslationInterface
 {
     use TranslationTrait;

+    /**
+     * @ORM\Id
+     * @ORM\Column(type="integer")
+     * @ORM\GeneratedValue(strategy="AUTO")
+     * @var int
+     */
+    private $id;</code></pre>
<h3 id="Scalar-Types">Scalar Types</h3>
<p>Scalar types make bugs more comfortable to discover, e.g., when a subscriber is broken, and it does not add value, return null will result in a fatal error.</p>
<p>That's why all the traits have scalar param and return types:</p>
<pre><code class="language-diff"> trait TimestampableMethodsTrait
 {
-    /**
-     * @return DateTimeInterface
-     */
-    public function getCreatedAt()
+    public function getCreatedAt(): DateTimeInterface
     {
         return $this-&gt;createdAt;
     }
 }</code></pre>
<p>Migration path for these types will be provided based on feedback, so <strong>in case you override these methods manually, you won't have to complete the types</strong>.</p>
<h3 id="Code-Quality-Changes">Code Quality Changes</h3>
<p>Feature improvements are essential. But to make them fast and stable, the <a href="/blog/2019/12/23/5-things-i-improve-when-i-get-to-new-repository/"><strong>code quality has the same importance</strong></a>.</p>
<blockquote class="blockquote text-center">
    Energy saved on manual maintenance<br>
    can be used to improve features.
</blockquote>
<p>How has been code quality improved?</p>
<ul>
<li><a href="https://github.com/KnpLabs/DoctrineBehaviors/pull/435/files">ECS was added with PSR-12 coding standard check</a></li>
<li><a href="https://github.com/KnpLabs/DoctrineBehaviors/pull/470"><code>CHANGELOG.md</code> is fully generated</a></li>
<li><a href="https://github.com/KnpLabs/DoctrineBehaviors/commit/3b17cdf656b5f904c4222c559d78bbd17217881a">tests now respect PSR-4</a></li>
<li><a href="https://github.com/KnpLabs/DoctrineBehaviors/pull/445">Rector CI now checks dead code, code quality and Nette\Utils</a></li>
<li><a href="https://github.com/KnpLabs/DoctrineBehaviors/pull/436">PHPStan now checks the static analysis</a></li>
</ul>
<h2 id="Community-Driven">Community Driven</h2>
<p>Without the PHP community, packages are just chunks of code. Community around the package, city, or a meetup group is what makes it specials, gives it power and motivation to grow.</p>
<p><strong>I'd love to thank <a href="https://github.com/laurentHCM">@laurentHCM</a> and <a href="https://github.com/nicolashachet">@nicolashachet</a></strong> for the testing process of version 2 and instant migration with Rector. For their patience to report issues, test new Rector rules, and trying to solve all the packages conflicts desperately.</p>
<p>You gave me <strong>the motivation</strong> that helped me to overcome difficult moments when I got lost in the code.</p>
<h2 id="How-to-Migrate-From-version-1-to-2">How to Migrate From version 1 to 2?</h2>
<p>What is the biggest problem of any significant refactoring? The backward compatibility (<em>BC</em>) breaks:</p>
<ul>
<li>Class rename?</li>
<li>Trait renamed?</li>
<li>Return type added?</li>
<li>Param type added?</li>
</ul>
<p><strong>Roughly over 80-120 BC breaking changes</strong> were performed between versions 1 and 2.</p>
<p>Imagine you have 20 such entities in your code, using 4 behavior traits, and now you have to:</p>
<ul>
<li>complete interfaces</li>
<li>complete param types</li>
<li>complete return types</li>
<li>rename traits</li>
<li>add an id to every translation entity</li>
</ul>
<p><strong> I'd be angry at any project, who would do such change, without providing one-click upgrade path</strong>.</p>
<p><br></p>
<p>That's why during such BC breaking changes <strong>I've prepared <a href="https://github.com/KnpLabs/DoctrineBehaviors/blob/master/upgrade/rector/doctrine-behaviors-20.yaml">instant upgrade Rector set</a> you can run on your code</strong>:</p>
<pre><code class="language-yaml">composer require rector/rector --dev
vendor/bin/rector process src --config vendor/rector/rector/config/set/doctrine-behaviors-20.php</code></pre>
<p>Single command turns to upgrade from 1 to 2 from days to few dozens of minutes.</p>
<h2 id="How-does-it-Compare-to-Gedmo-Stof">How does it Compare to Gedmo/Stof?</h2>
<p>Are you a stof/gedmo user? Then you're familiar <a href="https://github.com/stof/StofDoctrineExtensionsBundle/issues">with Symfony 5 issues</a> around it. Don't worry. The KnpLabs\DoctrineBehaviors 2 was developed bearing you in mind.</p>
<p>KnpLabs\DoctrineBehaviors don't support softdeletable and non-materialized tree path <em>yet</em>, but the rest of the features are covered.</p>
<h3 id="How-do-you-Migrate-from-Gedmo-Stof-to-KnpLabs-DoctrineBehaviors">How do you Migrate from Gedmo/Stof to KnpLabs\DoctrineBehaviors?</h3>
<p>Read <a href="/blog/2020/01/06/migrate-gedmo-to-knplabs/">Migrate Gedmo to KnpLabs</a> post to find the answer.</p>
<p><br></p>
<p>That's all for me. Use it, bend it, break it, and report issues or pull-request so that we can make migration path together even smoother.</p>
<p><br></p>
<p><strong>I wish you happy new year 2020 full of huge adventures not only in code!</strong></p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/12/30/doctrine-behaviors-2-0-reloaded</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 30 Dec 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/12/30/doctrine-behaviors-2-0-reloaded#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 5 Things I Improve when I Get  to new Repository ]]></title>
                <link>https://tomasvotruba.com/blog/2019/12/23/5-things-i-improve-when-i-get-to-new-repository</link>
                <description><![CDATA[ <p>I started to write this post as follow up for <a href="/blog/2019/12/16/8-steps-you-can-make-before-huge-upgrade-to-make-it-faster-cheaper-and-more-stable/">clean and sustainable code</a> post. In the middle of writing, I've realized I have this approach to ever repository I meet.
<br>
<br>
Imagine it like a working desk. But not your usual stable place where you work every day. <strong>Instead, you are assigned to a new desk of a former employee, who worked in the company for 5 years and as a bonus - it was the CTO</strong>. For you, it's a mess.
<br>
<br>
What is the first thing we do? We'll <strong>prepare it for hard work</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>I get to 2-3 new projects/week and during the last couple of years I've noticed <strong>I repeat the same preparing process before work itself</strong>. It makes me much more effective and creates a very intuitive environment to work in.</p>
<h2 id="1-Set-1-Spacing-Rule">1. Set 1 Spacing Rule</h2>
<p>Without this file, every file has a different number of spaces, tabs, line-endings... and everything else we can't see.</p>
<p>Well, until you have errors like:</p>
<ul>
<li><em>YAML syntax error</em></li>
<li><em>Mix of tabs and spaces</em></li>
</ul>
<p>Or <em>creatively</em> structured code like:</p>
<pre><code class="language-php">&lt;?php

class SomeClass
{
public function someMethod()
{
}
}</code></pre>
<p>We don't need these problems, it's the computers' job.</p>
<p><strong>This takes 1 minute to set up and commit</strong>:</p>
<pre><code class="language-yaml"># .editorconfig
root = true

[*]
charset = utf-8
end_of_line = lf
insert_final_newline = true
trim_trailing_whitespace = true
indent_style = space
indent_size = 4</code></pre>
<p>✅</p>
<p><br></p>
<h2 id="2-Make-Sure-vendor-is-in-vendor">2. Make Sure vendor is in <code>vendor</code></h2>
<p>The easier miss-location, that works as default on some operation systems, is this:</p>
<pre><code class="language-json">{
    "config": {
        "vendor-dir": "Vendor"
    }
}</code></pre>
<p>It might be a great feeling to be creative for various reasons, but <strong>most PHP tools are not ready for this</strong>, e.g. PHPStan and Rector fail here.</p>
<p>Unless there is some supercritical issue, I always make it a standard way:</p>
<pre><code class="language-diff">-{
-    "config": {
-        "vendor-dir": "Vendor"
-    }
-}</code></pre>
<p>✅</p>
<p><br></p>
<h2 id="3-Move-Code-to-src">3. Move Code to <code>/src</code></h2>
<p>In times old so I can't remember, code was located randomly. Then PSR-0 came, then PSR-4. <a href="/blog/2019/12/16/8-steps-you-can-make-before-huge-upgrade-to-make-it-faster-cheaper-and-more-stable/#1-psr-4-standard">Many tools depend on PSR-4</a>, so another standard naturally came to my toolset.</p>
<blockquote class="blockquote text-center mt-5 mb-3">
    Keep source code in <code>/src</code>.
</blockquote>
<p>That means only source code needed for production, so:</p>
<ul>
<li><strong>no migrations</strong></li>
<li><strong>no fixtures</strong></li>
<li><strong>no test helpers</strong></li>
<li><strong>no coding standard utils</strong></li>
<li><strong>no Rector utils</strong></li>
<li><strong>no templates</strong></li>
<li><strong>no translations</strong></li>
<li><strong>no configs</strong></li>
<li><strong>no bin files</strong></li>
<li><strong>no helpers bash scripts</strong></li>
<li><strong>no cool git repository tricks</strong></li>
</ul>
<p>Once we rule in place know that every command, that works with PHP code will get only one argument: <code>src</code></p>
<pre><code class="language-bash">vendor/bin/ecs c src
vendor/bin/phpstan a src
vendor/bin/rector p src</code></pre>
<p>✅</p>
<p><br></p>
<h2 id="4-Directory-Name-Directory-Content">4. Directory Name = Directory Content</h2>
<p>Saying the one above, I apply the same for other content:</p>
<ul>
<li>binary files? → <code>bin</code></li>
<li>files used in continues integration? → <code>ci</code></li>
<li>configs? → <code>configs</code></li>
<li>templates? → <code>templates</code></li>
<li>translations? → <code>translations</code></li>
<li>database migrations? → <code>migration</code></li>
</ul>
<p>...and so on.</p>
<p>You may know it as:</p>
<blockquote class="blockquote text-center mt-5 mb-3">
    1 level architecture.
</blockquote>
<p>It's very intuitive to use, based on UX, DX and well... <strong>human brain. We tend to choose simpler solutions over complex ones</strong>. Often it leads to crappy application design.</p>
<p>I have a special case for Rector, coding standards, PHPStan rules, utils that helps in development, but aren't part of the project itself → <code>utils/&lt;project&gt;/src</code></p>
<p>✅</p>
<p><br></p>
<h2 id="5-fs-ps-pu-2-Chars-Shortcuts-for-Tools-that-Help-Me">5. <code>fs</code>, <code>ps</code>, <code>pu</code>... 2 Chars Shortcuts for Tools that Help Me</h2>
<pre><code class="language-bash">fs
ps
pu</code></pre>
<p>6 characters, even &quot;characters&quot; has 10 characters.</p>
<p>I can't imagine to code without them. What are they?</p>
<pre><code class="language-bash">vendor/bin/ecs check src tests --fix
vendor/bin/phpstan analyse src tests
vendor/bin/phpunit</code></pre>
<p>Well, now you know <a href="/blog/2019/11/25/the-single-best-skill-to-master-command-line/">I use aliases in my bash</a>. It's <strong>the ultimate <em>skill</em></strong>, because your brain gets much more space to think.</p>
<blockquote class="blockquote text-center mt-5 mb-5">
    "But every project has different directories.<br>
    Do you use some uber hack alias for every single project?"
</blockquote>
<p>That's right, in one project it is:</p>
<pre><code class="language-bash">vendor/bin/ecs check src tests --fix</code></pre>
<p>in another it is:</p>
<pre><code class="language-bash">vendor/bin/ecs check src packages tests --fix</code></pre>
<p>Well, this how my bash aliases look like:</p>
<pre><code class="language-bash">alias fs="composer fix-cs"
alias ps="composer phpstan"
alias pu="vendor/bin/phpunit"</code></pre>
<p><strong>I never change them</strong>. So where is the dynamic part?</p>
<p>Have you heard of <a href="https://blog.martinhujer.cz/have-you-tried-composer-scripts">composer scripts</a>?</p>
<p>In every project I came to, I set up dev dependencies and scripts first:</p>
<pre><code class="language-json">{
    "require-dev": {
        "symplify/easy-coding-standard": "^7.1",
        "phpstan/phpstan": "^0.12",
        "phpunit/phpunit": "^8.5"
    },
    "scripts": {
        "fix-cs": "vendor/bin/ecs check bin src tests --fix --ansi",
        "phpstan": "vendor/bin/phpstan analyse bin src tests --ansi --error-format symplify"
    }
}</code></pre>
<p>That way I can modify directories right in <code>composer.json</code>.</p>
<p>So <strong>when I do any change in the code</strong>:</p>
<ul>
<li>I open 3 terminals in PHPStorm console</li>
<li>I run 3 scripts in parallel = <strong>it's faster and I can focus better on 1 tool</strong></li>
<li>I know what came wrong and re-run only the broken part</li>
</ul>
<pre><code class="language-bash">fs
ps
pu</code></pre>
<p>As a side benefit, continuous integration is easier to set up and maintain:</p>
<pre><code class="language-yaml"># travis.yml
jobs:
    include:
        -
            stage: test
            name: ECS
            script:
                - composer check-cs

        -
            name: PHPStan
            script:
                - composer phpstan</code></pre>
<p>Is there one new directory <code>utils</code> to check? Just update <code>composer.json</code>:</p>
<pre><code class="language-diff"> {
     "require-dev": {
         "symplify/easy-coding-standard": "^7.1",
         "phpstan/phpstan": "^0.12",
         "phpunit/phpunit": "^8.5"
     },
     "scripts": {
-        "fix-cs": "vendor/bin/ecs check bin src tests --fix --ansi",
+        "fix-cs": "vendor/bin/ecs check bin src tests utils --fix --ansi",
-        "phpstan": "vendor/bin/phpstan analyse bin src tests --ansi --error-format symplify"
+        "phpstan": "vendor/bin/phpstan analyse bin src tests utils --ansi --error-format symplify"
    }
}</code></pre>
<p>This way I also see, <strong>what directories contain PHP code, that needs to be checked</strong>.</p>
<p>✅</p>
<p><br></p>
<blockquote class="blockquote text-center mt-5 mb-3">
    "If you want to go quickly, go alone.<br>
    If you want to go far, go together."
</blockquote>
<p><br></p>
<p>Happy Xmass Coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/12/23/5-things-i-improve-when-i-get-to-new-repository</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 23 Dec 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/12/23/5-things-i-improve-when-i-get-to-new-repository#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 8 Steps You Can Make Before Huge Upgrade to Make it Faster, Cheaper and More Stable ]]></title>
                <link>https://tomasvotruba.com/blog/2019/12/16/8-steps-you-can-make-before-huge-upgrade-to-make-it-faster-cheaper-and-more-stable</link>
                <description><![CDATA[ <p>&quot;How much will cost upgrade from Symfony 3 to Symfony 4 with Rector?&quot;
<br><br>
Similar questions fill my personal and <a href="https://getrector.org/contact">Rector email</a> in the last 3 months. It's hard to give a reasonable answer without actually seeing the repository, so I reply with follow-up questions to get get more details.
<br><br>
Yet, I've discovered there are few repeated patterns, that make the upgrade easier and that <strong>most projects can do by themselves</strong> before migration starts.</p> ]]></description>
                <content:encoded><![CDATA[ <p>These points make any code migration faster and easier. It also <strong>decreases the time required to understand the code</strong> by a person who sees the code for the very first time.</p>
<p>Based on my experience with 10+ legacy projects of size 100 k-800 k lines, these points can be applied generally.</p>
<h2 id="1-PSR-4-Standard">1. PSR-4 Standard</h2>
<p>What are the benefits of using <a href="https://www.php-fig.org/psr/psr-4">PSR-4</a> standard? If you use it, all classes are <strong>unique</strong>, <strong>autoloaded</strong> and <strong>easy to relate to file path</strong>. We need that for effective coding - so we don't have to care about it - and thus also for effective migrations.</p>
<p>If you have PSR-4 standard applied, your <code>composer.json</code> looks like this:</p>
<pre><code class="language-json">{
    "autoload": {
        "psr-4": {
            "App\\": "src"
        }
    },
    "autoload-dev": {
        "psr-4": {
            "App\\Tests\\": "tests"
        }
    }
}</code></pre>
<ul>
<li>No <code>classmap</code>, no <code>files</code></li>
<li>No <a href="/blog/2020/06/08/drop-robot-loader-and-let-composer-deal-with-autoloading/">Nette\RobotLoader</a> magic autoloading</li>
<li>No <a href="https://stackoverflow.com/a/31847204/1348344">extra autoloading</a> for PHPUnit</li>
<li>No <a href="https://github.com/sebastianbergmann/phpunit/blob/c27ac794f809a73bb04bcd4cdd0c33f3265921a4/src/Runner/StandardTestSuiteLoader.php#L39">PHPUnit magic autoloading</a></li>
</ul>
<p>If you meet all these conditions... wait, you need to make sure, there is also no code like:</p>
<pre><code class="language-php">class Some_Fake_Namespace_Class
{
}</code></pre>
<p>...nor manual file requirements...</p>
<pre><code class="language-php">require __DIR__ . '/libs/SomeFramework/File.php';</code></pre>
<p>...nor <a href="https://github.com/rectorphp/rector/blob/master/docs/rector_rules_overview.md#multipleclassfiletopsr4classesrector">multiple classes in one file</a>...</p>
<pre><code class="language-php">class SomeException extends Exception
{
}

class SomeOtherException extends Exception
{
}</code></pre>
<p>...nor incorrect namespace/class case...</p>
<pre><code class="language-php"># app/lowercased/SomeController.php
namespace App\Lowercased;

class Somecontroller
{
}</code></pre>
<p>Should be:</p>
<pre><code class="language-diff">-app/lowercased/SomeController.php
+app/Lowercased/SomeController.php</code></pre>
<pre><code class="language-diff">-class Somecontroller
+class SomeController</code></pre>
<blockquote class="blockquote text-center mt-5 mb-3">
    If you meet all this conditions,<br>
    the migration is <strong>~20 % cheaper</strong>.
</blockquote>
<p>✅</p>
<h2 id="2-Explicit-PHP-Version">2. Explicit PHP Version</h2>
<p>What? Every project has a PHP version... that's obvious for many projects, but there is still that can go wrong. How?</p>
<pre><code class="language-json">{
    "require": {
        "php": "^7.1"
    },
    "config": {
        "platform": {
            "php": "7.2"
        }
    }
}</code></pre>
<p>So... which is it?</p>
<pre><code class="language-json">{
    "require": {
        "php": "7.1"
    }
}</code></pre>
<p>Is that locked for PHP 7.1 for some reason... is it though?</p>
<pre><code class="language-json">{
    "require": {
        "php": "^5.6|^7.2"
    }
}</code></pre>
<p>2 major versions... is that an open-source? Btw, you should not be at PHP 5.6 at all, <a href="https://www.php.net/supported-versions.php">it's dead</a>.</p>
<pre><code class="language-json">{
    "require": {
    }
}</code></pre>
<p>Ups! Make some up your mind. It's gonna be so weird to read this: it's the most common situation.</p>
<p>Is it in the Docker? No way! Docker is not version control. It only runs what you allow it to. Are you sure it handles PHP 4?</p>
<blockquote class="blockquote text-center mt-5 mb-3">
    If you meet one major PHP version,<br>
    the migration is <strong>~5 % cheaper</strong>.
</blockquote>
<p>✅</p>
<h2 id="3-EasyCoding-Standard-with-Basic-Sets">3. EasyCoding Standard with Basic Sets</h2>
<p>Why are coding standards needed for the migration? The AST libraries that Rector uses aren't well-suited to make code look nice and consistent, so it's better to let coding standard tools do that.</p>
<p>The basic <a href="https://github.com/symplify/easy-coding-standard">ECS</a> setup we use looks like:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\EasyCodingStandard\ValueObject\Option;
use Symplify\EasyCodingStandard\ValueObject\Set\SetList;

return function (ContainerConfigurator $containerConfigurator): void {
    $containerConfigurator-&gt;import(SetList::PSR_12);
    $containerConfigurator-&gt;import(SetList::CLEAN_CODE);
    $containerConfigurator-&gt;import(SetList::COMMENTS);

    // very nice to have ↓
    $containerConfigurator-&gt;import(SetList::SYMPLIFY);
};</code></pre>
<p>Run it:</p>
<pre><code class="language-bash">composer require symplify/easy-coding-standard --dev
vendor/bin/ecs check src --fix</code></pre>
<blockquote class="blockquote text-center mt-5 mb-3">
    If you meet all the basic coding standard sets,<br>
    the migration is <strong>~5 % cheaper</strong>.
</blockquote>
<p>✅</p>
<h2 id="4-PHPStan-on-Level-8">4. PHPStan on Level 8</h2>
<p>Coding style is one of <em>smoke testing</em> layers. It means it runs all over your code, without being explicitly told to. From that, the static analysis is just one step away.</p>
<pre><code class="language-bash">composer require phpstan/phpstan
vendor/bin/phpstan analyse src --level 0</code></pre>
<p>It's better to start small, then go high (like with any other drugs):</p>
<pre><code class="language-bash">vendor/bin/phpstan analyse src --level 1
vendor/bin/phpstan analyse src --level 2
...
vendor/bin/phpstan analyse src --level 8</code></pre>
<p>There are many Rector rules, <a href="https://github.com/rectorphp/rector/blob/master/docs/rector_rules_overview.md#addclosurereturntyperector">that help you with rules jumping</a>.</p>
<blockquote class="blockquote text-center mt-5 mb-3">
    If you make PHPStan to level 8 and passing,<br>
    the migration is <strong>~15 % cheaper</strong>.
</blockquote>
<p>✅</p>
<h2 id="5-Newbie-Composer-Install-Under-2-Hours">5. Newbie Composer Install Under 2 Hours</h2>
<p>This is how we usually run a good-quality project:</p>
<pre><code class="language-bash">git clone your-project.git

# install backend dependencies
composer install

# install frontend dependencies
npm install</code></pre>
<ul>
<li>create local database</li>
<li>create <code>.env.local</code> with local database credentials</li>
</ul>
<pre><code class="language-bash"># run database migration
bin/console doctrine:migrations:migrate

# run Symfony 5 project
php -S localhost:8000 -t public</code></pre>
<p>That's it. It takes 15-30 minutes to run <a href="https://github.com/pehapkari/pehapkari.cz">pehapkari.cz</a> project locally, if you see it first.</p>
<p><br></p>
<p>The projects we meet are often hosted on Bitbucket, Github or Gitlab. Someone needs to add your SSH key there.</p>
<p><strong>If it takes more than a day, something is wrong</strong>:</p>
<ul>
<li>
<p>Sometimes there is <a href="https://getcomposer.org/doc/articles/handling-private-packages-with-satis.md">Satis</a> for handling private packages.</p>
</li>
<li>
<p>Sometimes there is an SVN.</p>
</li>
</ul>
<p>One project took me 2 weeks to ask for SSH keys 3 different people by 7 mails, 4 callings, one VPN... I still can't run <code>composer install</code>.</p>
<p><strong>Flawless install under 2 hours is a luxury.</strong></p>
<blockquote class="blockquote text-center mt-5 mb-3">
    If you make <code>composer install</code> under 2 hours,<br>
    the migration is <strong>~5 % cheaper</strong>.
</blockquote>
<p>✅</p>
<h2 id="6-70-Code-Coverage">6. 70 % Code Coverage</h2>
<p>When we come to a completely new project, <strong>we need instant feedback, if we break something</strong>. It would be nice to have 100 % code coverage, but even my open-source project rates as high as 75 %.</p>
<p><strong>It's like having CTO who rose the project constantly at your side for any change you make.</strong></p>
<p>We don't care if it's functional, integration or unit tests - we just need the coverage to be sure nothing is wrong with the code. Without tests, <strong>any change in the code is like shooting blindfolded in the dark without hands at a target that is both invisible, moving and Shrodinger's cat</strong>.</p>
<p>On the other hand, if you have a code coverage over 80 % percent, even change of <a href="/blog/2019/08/26/how-we-migrated-54-357-lines-of-code-nette-to-symfony-in-2-people-under-80-hours/">the framework can be as fast as 80 hours</a>.</p>
<blockquote class="blockquote text-center mt-5 mb-3">
    If you make it pass ~70 % code coverage,<br>
    the migration is <strong>~50 % cheaper</strong>.
</blockquote>
<p>✅</p>
<h2 id="7-Not-Versioned-Vendor">7. Not Versioned Vendor</h2>
<p>I know it sounds crazy again, but it's not. Many projects we get have 2 <code>vendor</code> directories. One is versioned by <code>composer.json</code> and the other is versioned... <em>somehow</em>.</p>
<p>Why use <a href="https://github.com/cweagans/composer-patches">composer patches</a> or custom forks, if you can version packages locally. It's fast, it's healthy, it's all you wish for.</p>
<p>But getting packages out of <em>local vendor</em> is the real adventure. We need to compare every file in both directories, <del>discover</del> guess the version, <del>test</del> hope it's the right one, prevent from duplications with <em>real vendor</em> and so on.</p>
<blockquote class="blockquote text-center mt-5 mb-3">
    If you don't version your <code>vendor</code>,<br>
    the migration is <strong>~10 % cheaper</strong>.
</blockquote>
<p>✅</p>
<h2 id="8-Solid-Gitlab-CI">8. Solid Gitlab CI</h2>
<p>What if you have all the items above? When is the last time you've checked them? You don't know?</p>
<p>If the answer is not &quot;at every commit&quot;, it's not good enough. You need to have CI. And I don't mean Bitbucket CI.</p>
<p>Why? It's not that Bitbucket CI is worse than Gitlab CI or GitHub actions. It's the ecosystem support. <strong>The Gitlab CI has the longest support for CI of a private project there is.</strong></p>
<p><div class="card ml-4 mt-4 border-warning float-right post-snippet" style="width: 14em">
    <div class="card-body">
        Would you like to <strong>learn more about Rector</strong>? Step by step, from zero to hero?
        <br>

        <div class="text-center">
            <a href="/book/the-power-of-automated-refactoring/">
                <img src="/assets/images/rector_book.png" class="mb-3 mt-3 shadow">
                Get our new book
            </a>
        </div>
    </div>
</div>
</p>
<p>That means:</p>
<ul>
<li>a lot of tutorials</li>
<li>a lot of people who know how to configure it</li>
<li>a lot of custom Docker tutorials</li>
<li>community support in case of troubles</li>
</ul>
<p>As a side bonus, <strong>it's free for private projects with unlimited users</strong> and 2 000 build minutes per month (I've never reached that).</p>
<blockquote class="blockquote text-center mt-5 mb-3">
    If you use Gitlab CI on every commit,<br>
    the migration is <strong>~10 % cheaper</strong>.
</blockquote>
<p>✅</p>
<h2 id="Worth-It">Worth It?</h2>
<img src="/assets/images/posts/2019/before/time.png" class="img-thumbnail">
<p>Let's say your goal is to migrate the whole framework or switch a legacy framework for a modern one. If you had skills, time and money to do that, you'd probably be there. <strong>It takes the experience with many legacy migrations to there effectively without years of time and full-rewrite.</strong></p>
<p>But... these steps above don't depend on such experience. You can implement in your in-house team. <strong>Such work will reduce work on our side and make your code solid on your side with not such a big overhead</strong>.</p>
<p>Just pick one and start slowly.</p>
<p><br></p>
<p>Happy coding!</p>
<p><br></p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/12/16/8-steps-you-can-make-before-huge-upgrade-to-make-it-faster-cheaper-and-more-stable</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 16 Dec 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/12/16/8-steps-you-can-make-before-huge-upgrade-to-make-it-faster-cheaper-and-more-stable#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Get Rid of Technical Debt or What We Would Have Done Differently 2 Years ago ]]></title>
                <link>https://tomasvotruba.com/blog/2019/12/09/how-to-get-rid-of-technical-debt-or-what-we-would-have-done-differently-2-years-ago</link>
                <description><![CDATA[ <p>We talked about cleaning legacy code with Rector 2 months ago on 40th meetup of PHP friends in Prague.
<br>
Who is <em>we</em>? Me and CTO of the <a href="https://spaceflow.io/en">company I worked for</a>, a great leader and technical expert who taught me a lot, <a href="https://www.linkedin.com/in/milanmimra">Milan Mimra</a>.
<br>
<br>
The talk was not full of shallow tips, nor <a href="/blog/2019/08/26/how-we-migrated-54-357-lines-of-code-nette-to-symfony-in-2-people-under-80-hours/">about framework migration</a>. Instead, <strong>we talked about small decisions that were made 2 years. Decisions, which took 3 months to get rid of</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p><strong>Do you speak Czech?</strong> Go check <a href="https://docs.google.com/presentation/d/1QSpTVqmtXpE8RvB73cYDBrDYpuChjp_Uz3sLJhLnLXo/edit?usp=sharing">64 slides</a> and <a href="https://www.facebook.com/pehapkari/videos/vl.404478763568491/399224180756304/?type=1">watch the talk video recording on Facebook</a> (it is 60 minutes long and the picture is broken from ~27th minute, but the audio is good).</p>
<p><a href="https://www.facebook.com/pehapkari/videos/vl.404478763568491/399224180756304/?type=1"></p>
<img src="/assets/images/posts/2019/spaceflow_10_points/main.png" class="img-thumbnail col-12 col-md-8">
<p></a></p>
<p><br></p>
<p><strong>For all the rest of you who speak English better or don't want to copy-paste code instead of watching the video, I'm writing this post.</strong> So you can learn from our pain and make your brand new mistakes :)</p>
<h2 id="The-Size-Does-Doesn-t-Matter">The Size <del>Does</del> Doesn't Matter</h2>
<p>This talk was about my work as <em>cleaning lady</em> in a project, that <strong>wanted to improve their PHP codebase across the whole application</strong>. Any PHP projects I recently consulted would benefit from these changes, so keep reading even if you already run on the latest version of your favorite framework.</p>
<p>Instant upgrades effectivity doesn't depend on project size, but people still want size numbers, so there you go:</p>
<ul>
<li>Symfony 4.* backend for mobile application</li>
<li>253 endpoints = routes</li>
<li>105 000 lines of code (bigger than <a href="https://medium.com/@javiereguiluz/30-of-laravel-code-is-symfony-a49dcf30e809">Symfony with ~90 000 lines</a>)</li>
</ul>
<p><br></p>
<p>From all the work we've done, <strong>we've picked 10 most important changes that brought code quality to another level</strong>.</p>
<h2 id="1-Advance-Your-Coding-Standard">1. Advance Your Coding Standard</h2>
<img src="/assets/images/posts/2019/spaceflow_10_points/01.png" class="img-thumbnail col-12 col-md-8">
<p>When people say &quot;we use coding standard&quot;, it usually means &quot;we use only PSR-2 but nothing more&quot;.</p>
<p>That's like saying &quot;we use Symfony&quot; when you're using only controllers.</p>
<h3 id="Why-You-Should-use-It">Why You Should use It?</h3>
<ul>
<li>the best code improvements in exchange for massively improved code - for 10 minutes, life-time code check</li>
<li>it's very easy to start using it if you don't use it yet</li>
<li>further refactoring with Rector or analysis with PHPStorm or PHPStan is more robust</li>
</ul>
<img src="/assets/images/posts/2019/spaceflow_10_points/02.png" class="img-thumbnail col-12 col-md-8">
<p>It's better to start slow, so the first things we did was:</p>
<ul>
<li>moving from string <code>"SomeClass"</code> to <code>SomeClass::class</code></li>
<li>coding standard enforced line-ending - not just sniff, but a fixer</li>
<li><a href="/blog/2019/01/24/how-to-kill-parents/">finalized (almost) everything</a></li>
<li>accidental fatal error check of an empty array</li>
</ul>
<img src="/assets/images/posts/2019/spaceflow_10_points/04.png" class="img-thumbnail col-12 col-md-8">
<h3 id="How-to-Apply">How to Apply?</h3>
<p>Just run <a href="https://github.com/symplify/easy-coding-standard">ECS</a> with following set:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\CodingStandard\Fixer\LineLength\LineLengthFixer;
use PhpCsFixer\Fixer\ClassNotation\FinalClassFixer;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();

    // keep line-length max. 120 chars long
    $services-&gt;set(LineLengthFixer::class)
        -&gt;call('configure', [[
            'lineLength' =&gt; 120
        ]]);

    // every non-Entity non-abstract class must be final - you have to skip those that are used + have children, like this ↓
    $services-&gt;set(FinalClassFixer::class);
};</code></pre>
<p>And the result?</p>
<img src="/assets/images/posts/2019/spaceflow_10_points/03.png" class="img-thumbnail col-12 col-md-8">
<h2 id="2-Single-Class-Single-Place">2. Single Class = Single Place</h2>
<img src="/assets/images/posts/2019/spaceflow_10_points/05.png" class="img-thumbnail col-12 col-md-8">
<p>Have you heard about PSR-4? Well, so did many people before you, but it's very to forget it thanks to:</p>
<ul>
<li>PHPUnit magic autoload - you can place your tests anywhere, PHPUnit will find them</li>
<li><a href="/blog/2020/06/08/drop-robot-loader-and-let-composer-deal-with-autoloading/">Nette\RobotLoader</a> - load anything from anywhere, for free</li>
<li>composer &quot;classmap&quot; - just load the directory, who cares</li>
<li>DDD - Domain Driven Design - apparently, one of the most favorite principles is to put all files in one directory, templates, configs, services, objects... just put it there</li>
</ul>
<img src="/assets/images/posts/2019/spaceflow_10_points/06.png" class="img-thumbnail col-12 col-md-8">
<p>This all helps a lot to messy applications. As basic as this rule seems, I must sadly say that <strong>lack of PSR-4 is one of the biggest problems of legacy applications</strong>.</p>
<h3 id="Forget-Service-Autodiscovery-Use-Ze-Handz">Forget Service Autodiscovery, Use Ze Handz!</h3>
<p>To add more salt into the wound, now imagine <strong>you want to use some sort of services autoregistration</strong> (and you should, unless you want to kill your project slowly). That means you tell your dependency injection container &quot;load these services from this directory&quot;.</p>
<p>One of such <a href="/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3/">implementaions is PSR-4 autodiscovery in Symfony</a>:</p>
<p><a href="/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3/"></p>
<img src="/assets/images/posts/2019/spaceflow_10_points/08.png" class="img-thumbnail col-12 col-md-8">
<p></a></p>
<p>Such a simple yet powerful idea... which all the Symfony applications I've seen so far struggle. There Symfony 4 and 5 projects, where programmers still have to write each service manually.</p>
<img src="/assets/images/posts/2019/spaceflow_10_points/07.png" class="img-thumbnail col-12 col-md-8">
<p>I wonder, isn't there something better to do? Like <strong>writing unique PHP code</strong> that cannot be automated?</p>
<p>So that's what we did:</p>
<img src="/assets/images/posts/2019/spaceflow_10_points/09.png" class="img-thumbnail col-12 col-md-8">
<p><div class="card ml-4 mt-4 border-warning float-right post-snippet" style="width: 14em">
    <div class="card-body">
        Would you like to <strong>learn more about Rector</strong>? Step by step, from zero to hero?
        <br>

        <div class="text-center">
            <a href="/book/the-power-of-automated-refactoring/">
                <img src="/assets/images/rector_book.png" class="mb-3 mt-3 shadow">
                Get our new book
            </a>
        </div>
    </div>
</div>
</p>
<h3 id="How-to-Apply">How to Apply?</h3>
<p>This one requires lof ot manual configuration tweaking of <a href="https://github.com/rectorphp/rector">Rector</a> rules, but you can run basic migration with following set:</p>
<pre><code class="language-php">use Rector\Autodiscovery\Rector\FileSystem\MoveServicesBySuffixToDirectoryRector;
use Rector\PSR4\Rector\Namespace_\NormalizeNamespaceByPSR4ComposerAutoloadRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;rule(MoveServicesBySuffixToDirectoryRector::class);

    // configure `composer.json` to desired way
    $rectorConfig-&gt;rule(NormalizeNamespaceByPSR4ComposerAutoloadRector::class);
};</code></pre>
<h2 id="3-Make-Your-CI-Fast-or-Die-Trying">3. Make Your CI Fast or Die Trying</h2>
<img src="/assets/images/posts/2019/spaceflow_10_points/10.png" class="img-thumbnail col-12 col-md-8">
<p>This is rather a general tip than a specific migration.</p>
<p><strong>In the beginning we had</strong>:</p>
<ul>
<li>slow database test</li>
<li>Doctrine fixtures that were added on every integration test</li>
</ul>
<p>Not only CI but also local testing was slow. That leads to <strong>frustration</strong> due to <strong>loooooooooong feedback loop</strong>. In reality, it means check test = having a coffee or go smoking. And you don't want to hurt your team intentionally like that, do you?</p>
<p><br></p>
<p>So after a lot of work <strong>we had super fast CI that</strong>:</p>
<ul>
<li>loaded database just once</li>
<li>reference fixtures via IDs in constants instead of in-Database references</li>
<li>checked coding standards in standalone job</li>
<li>checked static analysis in standalone job</li>
<li>checked Rector in standalone job</li>
</ul>
<img src="/assets/images/posts/2019/spaceflow_10_points/11.png" class="img-thumbnail col-12 col-md-8">
<h2 id="4-Remove-What-You-Don-t-Use">4. Remove What You Don't Use</h2>
<img src="/assets/images/posts/2019/spaceflow_10_points/12.png" class="img-thumbnail col-12 col-md-8">
<p>I see you now thinking &quot;we don't have any dead code, or PHPStorm would tell us&quot;. No, it wouldn't, at least no in level the static analysis can.</p>
<p>How do we know? Well, we were you in the start... &quot;no, we don't have any dead code&quot;:</p>
<img src="/assets/images/posts/2019/spaceflow_10_points/13.png" class="img-thumbnail col-12 col-md-8">
<p>The moment you realize:</p>
<ul>
<li>the code is broken</li>
<li>you have to fix it</li>
<li>you have to maintain it</li>
<li>oh, it's used in tests</li>
<li>good</li>
<li>wait...</li>
<li><strong>it's used only in the test but nowhere else!</strong></li>
</ul>
<img src="/assets/images/posts/2019/spaceflow_10_points/14.png" class="img-thumbnail col-12 col-md-8">
<p>God, don't do this manually! Automate ↓</p>
<pre><code class="language-php">use Rector\DeadCode\Rector\Class_\RemoveUnusedDoctrineEntityMethodAndPropertyRector;
use Rector\Set\ValueObject\SetList;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;import(SetList::DEAD_CODE);

    $rectorConfig-&gt;rule(RemoveUnusedDoctrineEntityMethodAndPropertyRector::class);
    // + some extra private rules :)
};</code></pre>
<p><strong>Soon, you'll be 10-20 % slimmer and you'll fit into your favorite bathing suite :)</strong></p>
<p>Also, you'll avoid skipping code-reviews:</p>
<img src="/assets/images/posts/2019/spaceflow_10_points/15.png" class="img-thumbnail col-12 col-md-8">
<h2 id="5-Make-Your-Ground-Base-Rock-Diamond-SOLID">5. Make Your Ground Base <del>Rock</del> Diamond SOLID</h2>
<img src="/assets/images/posts/2019/spaceflow_10_points/16.png" class="img-thumbnail col-12 col-md-8">
<p>Have you ever seen code like this?</p>
<img src="/assets/images/posts/2019/spaceflow_10_points/17.png" class="img-thumbnail col-12 col-md-8">
<p>I'd never expect <code>string</code> turn into <code>null</code>, but it happened anyway. <strong>Silently</strong>. And not just from this function.</p>
<p><strong>We wanted this code to throw an exception and tell us what's wrong</strong>. Right in the place where it happened, not just &quot;string expect, null given&quot; later.</p>
<p>There is a <a href="https://github.com/thecodingmachine/safe">Safe package</a> that can partially protect you, but it's rather general and with a generic exception.</p>
<h3 id="Nette-SOLID">Nette SOLID</h3>
<p>But there is even better one - <a href="https://github.com/nette/utils">Nette\Utils</a>:</p>
<img src="/assets/images/posts/2019/spaceflow_10_points/18.png" class="img-thumbnail col-12 col-md-8">
<p>How to get it into your code? Easy:</p>
<pre><code class="language-php">use Rector\Nette\Set\NetteSetList;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;import(NetteSetList::NETTE_UTILS_CODE_QUALITY);
};</code></pre>
<h2 id="6-Config-SPAM">6. Config SPAM</h2>
<img src="/assets/images/posts/2019/spaceflow_10_points/19.png" class="img-thumbnail col-12 col-md-8">
<p>We already wrote that config suffers from manual services registration spam. But there is more...</p>
<img src="/assets/images/posts/2019/spaceflow_10_points/20.png" class="img-thumbnail col-12 col-md-8">
<img src="/assets/images/posts/2019/spaceflow_10_points/21.png" class="img-thumbnail col-12 col-md-8">
<p>This is <strong><a href="/blog/2018/11/12/will-autowired-arrays-finally-deprecate-tags-in-symfony-and-nette/">famous Symfony tag spam</a></strong>.</p>
<ul>
<li>not needed</li>
<li>overly promoted in documentation</li>
<li>thus at the end used by everybody</li>
<li>making application stupidly complex and hard to maintain and extend in the end</li>
</ul>
<p>Another typical issues is <strong><a href="/blog/2018/11/05/do-you-autowire-services-in-symfony-you-can-autowire-parameters-too/">manual parameter spam</a></strong>.</p>
<h3 id="Add-Spam-Filter">Add Spam Filter</h3>
<p>We don't like spam, do you? So we dropped all this crap and used 2 compiler passes to make it KISS:</p>
<ul>
<li><a href="https://github.com/symplify/package-builder#autowire-array-parameters"><code>AutowireArrayParameterCompilerPass</code></a></li>
<li><a href="https://github.com/symplify/package-builder#autobind-parameters"><code>AutoBindParametersCompilerPass</code></a></li>
</ul>
<p>↓</p>
<img src="/assets/images/posts/2019/spaceflow_10_points/22.png" class="img-thumbnail col-12 col-md-8">
<h2 id="7-Remove-All-the-Copy-Paste-Legacy">7. Remove All the Copy-Paste Legacy</h2>
<img src="/assets/images/posts/2019/spaceflow_10_points/23.png" class="img-thumbnail col-12 col-md-8">
<p>We all know how the story goes:</p>
<ul>
<li>&quot;They did it&quot;</li>
<li>&quot;I just maintain it&quot;</li>
<li>&quot;It's faster to copy-paste it...&quot;</li>
<li><strong>&quot;I don't have time to fix it now...&quot;</strong></li>
<li>3 years later...</li>
<li>&quot;Oh my, what's this? How do we get out of it? <strong>Rewrite?</strong>&quot;</li>
</ul>
<p>In our case, it was json, written as a string:</p>
<img src="/assets/images/posts/2019/spaceflow_10_points/24.png" class="img-thumbnail col-12 col-md-8">
<p>It was hard to maintain, even read or change a value in that mess. We had many bugs just because of invalid quote concat, missed closing quote or new-line issues. <strong>We needed to use a normal array like most people do</strong>, but it was spread in over 70 use cases, some of them nesting array into 5 levels.</p>
<p>What now?</p>
<p>Easy, we made a Rector rule for that:</p>
<pre><code class="language-php">use Rector\CodingStyle\Rector\String_\ManualJsonStringToJsonEncodeArrayRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;rule(ManualJsonStringToJsonEncodeArrayRector::class);
};</code></pre>
<img src="/assets/images/posts/2019/spaceflow_10_points/25.png" class="img-thumbnail col-12 col-md-8">
<h2 id="8-Know-ALL-Your-Properties">8. Know ALL Your Properties</h2>
<img src="/assets/images/posts/2019/spaceflow_10_points/26.png" class="img-thumbnail col-12 col-md-8">
<p>I already wrote about this here: <a href="/blog/2019/07/29/how-we-completed-thousands-of-missing-var-annotations-in-a-day/">How we Completed Thousands of Missing @var Annotations in a Day</a></p>
<p><strong>This is super important to make instant refactoring reliable!</strong></p>
<h2 id="9-Enter-Anywhere">9. Enter Anywhere?</h2>
<img src="/assets/images/posts/2019/spaceflow_10_points/27.png" class="img-thumbnail col-12 col-md-8">
<p>I already wrote about it... twice:</p>
<ul>
<li><a href="/blog/2019/05/16/don-t-ever-use-listeners/">Don't Ever use Symfony Listeners</a></li>
<li><a href="/blog/2019/07/22/how-to-convert-listeners-to-subscribers-and-reduce-your-configs/">How to Convert Listeners to Subscribers and Reduce your Configs</a></li>
</ul>
<img src="/assets/images/posts/2019/spaceflow_10_points/28.png" class="img-thumbnail col-12 col-md-8 mt-5">
<p><strong>Clean, simple, PHP without config magic!</strong></p>
<h2 id="10-Switch-ID-to-UUID">10. Switch ID to UUID?</h2>
<p>This was the biggest problem in the whole project. First, it used classic <code>int</code> ids. Then uuid was about to be used (for whatever good reasons), but for the lack of refactoring time only, new entities used it. So part of the old approach, part of the new approach. Sometimes one class uses one of those and another of those.</p>
<p><strong>Total mess, maintanece of 2 huge layers and negative effective on input/output layer</strong>, because it had to be consistent. There cannot be a situation where user sees urls like:</p>
<pre><code class="language-bash">/building/edit/1
/building/edit/b9a33908-56c8-431f-a159-e4bec344e56c</code></pre>
<p>And not only the user but also external API, mobile applications, invoice systems, etc.</p>
<p>This was a real challenge for the whole team - it included database, Doctrine refactoring rules, external service unification refactoring and also changing PHP types all over the application.</p>
<p><br></p>
<h2 id="Benefits">Benefits?</h2>
<p>And that's all folks, all we made happen in 3 months work of... 1 person.
We wanted to show you, that all big changes don't have to be &quot;whole-team-2-years-refactoring-super-expensive-no-features&quot;.</p>
<p>It can be <strong>smooth, step by step, closed incremental iterations, done by one full-time person</strong>.</p>
<p>Now the code is:</p>
<ul>
<li>200 % more readable</li>
<li>instead of 3 locations, the class now only has 1 location</li>
<li>the database has 1 way to use ids instead of 2</li>
<li>configs are 95 % smaller</li>
<li>is 40 % safer thanks to exceptions of <code>null</code>/<code>false</code></li>
<li>most of the time the developer doesn't visit configs at all and can focus on PHP code of the feature instead</li>
</ul>
<p>And moreover:</p>
<ul>
<li><strong>it has 80 % fewer anti-patterns, so any new developer will produce high-quality code by default, just by reading the already written code</strong></li>
</ul>
<p><br></p>
<blockquote class="blockquote text-center mt-5 mb-5">
    This is Inspiration and Proof, it Can Be Done. Now Yours is Choice to Make:
    <br>
    What Are You Going to Clean Tomorrow in Your Code Base?
</blockquote> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/12/09/how-to-get-rid-of-technical-debt-or-what-we-would-have-done-differently-2-years-ago</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 09 Dec 2019 00:00:00 +0000</pubDate>
                                    <updated>2020-08-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Aug 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Aug 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/12/09/how-to-get-rid-of-technical-debt-or-what-we-would-have-done-differently-2-years-ago#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Box Symfony App to PHAR without Killing Yourself ]]></title>
                <link>https://tomasvotruba.com/blog/2019/12/02/how-to-box-symfony-app-to-phar-without-killing-yourself</link>
                <description><![CDATA[ <p>Do you have a Symfony Application like Composer and you want to ship it as a PHAR?
Composer is actually pretty simple - just see the <a href="https://github.com/composer/composer/blob/master/src/Composer/Compiler.php"><code>Compiler</code></a> class.
<br><br>
<strong>But what if</strong> you use Symfony Dependency Injection with PSR-4 <strong>autodiscovery</strong> like <a href="https://github.com/rectorphp/rector">Rector</a> does? Well, better be ready for <strong>nasty traps</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p><em>Note: all these tips take 5 minutes to apply (in total), but took us ~6 hours to discover. I'd like to thank Jan Linhart from Mautic, Kerrial Becket Newham and Ivan Kvasnica for cooperation that made <a href="https://github.com/rectorphp/rector/pull/2373">this happen</a>.</em></p>
<p>Rector <a href="https://github.com/rectorphp/rector/issues/177">needs prefixed PHAR</a> for the same reasons PHPStan does.</p>
<p>Let's say your <code>composer.json</code> looks like this:</p>
<pre><code class="language-json">{
    "require": {
        "symfony/console": "2.8"
    }
}</code></pre>
<p>If you want to install Rector:</p>
<pre><code class="language-bash">composer require rector/rector --dev</code></pre>
<p>You'll end up with an error:</p>
<pre><code class="language-bash">rector/rector cannot be installed, because it requires symfony/* ^3.4|^4.4... but you have 2.8</code></pre>
<p>This leads to many issues reported on Github, mostly <a href="https://github.com/rectorphp/rector/issues/177">grouped around this one</a>.</p>
<h2 id="PHP-Version-Conflicts">PHP Version Conflicts</h2>
<p>If you have PHP 5.6, you'll get a different error:</p>
<pre><code class="language-bash">rector/rector needs at least PHP 7.2, you have PHP 5.6</code></pre>
<p>That's where Docker becomes useful. Yet, it still <strong>doesn't solve the Symfony 2.8 in your project vs Symfony 4.4 in Rector project issue</strong>.</p>
<p>That's why <strong>prefixed <code>rector.phar</code> is needed</strong>. With such a file, you don't care about Rector's dependencies, you just use it.</p>
<h2 id="How-Does-and-quot-Scoping-and-quot-Work">How Does &quot;Scoping&quot; Work?</h2>
<p>Basically any <code>Symfony\Component\Console\Command</code> becomes <code>UniquePrefix\Symfony\Component\Console\Command</code>. That way there will never be conflicts between your code without prefix and unique Rector code.</p>
<h2 id="Box-Scope-Industry-Standard">Box + Scope Industry Standard</h2>
<p>To make it happen, we <strong>don't need to re-invent the wheel</strong>. There are 2 amazing tools maintained and developed by <a href="https://github.com/theofidry">Théo Fidry</a> (thank you!):</p>
<ul>
<li><a href="https://github.com/humbug/box">box</a> - a tool that creates PHAR (~= PHP zip) from an input directory</li>
<li><a href="https://github.com/humbug/php-scoper">php-scoper</a> - box <em>plugin</em> that adds namespace prefix to all the files</li>
</ul>
<p>It takes around 10 seconds to scope + wraps 5 000 files of Rector to <code>rector.phar</code>. <strong>This speed is amazing.</strong></p>
<h3 id="Nobody-Ever-used-Symfony-in-PHAR-Before">Nobody Ever used Symfony in PHAR Before</h3>
<p>These 2 tools work very well for PHP-based <em>manual</em> containers like PHPStan has. But fails for Symfony autodiscovery that uses globs. It's not the fault of these tools, but rather Symfony, because nobody ever tested it to compiled PHAR :).</p>
<p><strong>Where and how to overcome it?</strong> There are 4 steps you need to watch out for:</p>
<h2 id="1-From-excluded-files-to-Globs">1. From <code>excluded</code> files to Globs</h2>
<p>If you have following config:</p>
<pre><code class="language-yaml">services:
    Rector\TypeDeclaration\:
        resource: '../src'
        exclude:
            - '../src/ValueObject/SpecificFile.php'</code></pre>
<p>You'll end up with an error:</p>
<pre><code class="language-bash">Directory "../src/ValueObject/SpecificFile.php" was not found.</code></pre>
<p>Where does it come from? It's an error from <a href="https://github.com/symfony/symfony/blob/c62bb82e27974ef4e389da523f0de451b6632266/src/Symfony/Component/Finder/Finder.php#L589">Symfony/Finder</a>.</p>
<p>But how did Symfony got there? Well, the Symfony takes missing files from <a href="https://github.com/symfony/symfony/blob/c62bb82e27974ef4e389da523f0de451b6632266/src/Symfony/Component/DependencyInjection/Loader/FileLoader.php#L162">&quot;excluded&quot; as directory</a> and the rest is history.</p>
<p>My super random guess is for missing local <code>phar://</code> prefix.</p>
<h3 id="How-to-Fix-it">How to Fix it?</h3>
<p>Just change the relative path to each file to glob (<code>*</code>) and move your files there:</p>
<pre><code class="language-diff"> services:
     Rector\TypeDeclaration\:
         resource: '../src'
         exclude:
-          - '../src/ValueObject/SpecificFile.php'
+          - '../src/ValueObject/*'</code></pre>
<h3 id="Positive-Side-Effect">Positive Side-Effect</h3>
<p>In the end, it was architecture improvement, as we had to move files to a generic directory, that clearly states it's not a service - here <code>ValueObject</code>.</p>
<h2 id="2-Symfony-Autodiscovery-Slash-Fail">2. Symfony Autodiscovery Slash Fail</h2>
<p>This one give me an headache, but is simple to fix:</p>
<pre><code class="language-diff"> services:
     Rector\TypeDeclaration\:
-        resource: '../src/'
+        resource: '../src'</code></pre>
<h2 id="3-SHA1-cannot-be-Verified">3. SHA1 cannot be Verified...</h2>
<p>This one is not strictly related to Symfony, but it happened while we shipped <code>box.phar</code>:</p>
<pre><code class="language-bash">Error: Fatal error: Uncaught PharException: phar "compiler/build/box.phar" SHA1
the signature could not be verified: broken signature in ...</code></pre>
<p>What the <code>box.phar</code> worked locally but doesn't work on Travis?</p>
<p>I re-downloaded files many times and it worked in other CI. WTF?</p>
<p>Is that corrupted version of <code>box.phar</code>? I tried version before/after, still the same error.</p>
<p><br></p>
<p>2 hours later...</p>
<p><br></p>
<p>Damn. Spaces? Line-ending? <strong>Yes!</strong></p>
<p>The solution is to remove this from <code>.gitattributes</code>:</p>
<pre><code class="language-diff">-# Set default behavior, in case of users, don't have core.autocrlf set.
-* text=auto
-* text eol=lf</code></pre>
<p>Because <a href="https://stackoverflow.com/questions/24763948/git-warning-lf-will-be-replaced-by-crlf">it changed line-endings</a> in the <code>box.phar</code> on commit and thus made it valid locally, but broken remotely on Travis CI.</p>
<h2 id="4-Don-t-do-Multiple-bin-Files">4. Don't do Multiple <code>bin</code> Files</h2>
<p>Rector had multiple bin files, just to split the complexity:</p>
<ul>
<li><code>bin/rector</code> that included
<ul>
<li><code>bin/autoload.php</code></li>
<li><code>bin/container.php</code></li>
</ul></li>
</ul>
<p>The Box takes only the file in <code>compser.json</code> &gt; <code>bin</code> section, so the latter 2 were missed. I tried to change configuration many times, but it mostly failed on malformed paths.</p>
<h3 id="How-to-solve-it">How to solve it?</h3>
<p>Now we have just <strong>single file</strong>:</p>
<ul>
<li><code>bin/rector</code></li>
</ul>
<p>With use strict typed classes written on the bottom of the file and use them in the same file. Also, nice side effects as we moved from many-functions to few classes.</p>
<p><br></p>
<p>Do you want to know more about Box + Scoper automated Travis CI deploy in practice?</p>
<p><a href="https://github.com/rectorphp/rector/pull/2373" class="btn btn-dark mt-3 mb-3">
Check this PR on Rector
</a></p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/12/02/how-to-box-symfony-app-to-phar-without-killing-yourself</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 02 Dec 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/12/02/how-to-box-symfony-app-to-phar-without-killing-yourself#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ The Single Best Skill to Master Command Line ]]></title>
                <link>https://tomasvotruba.com/blog/2019/11/25/the-single-best-skill-to-master-command-line</link>
                <description><![CDATA[ <p>I have a confession to make. I'm very poor with memory stuff. My brain is using neurons to mostly process data, instead of keeping them.
<br><br>
I'm very poor with memory stuff. So I use shortcuts, both in brain and code, that make me look smart. I don't like remember stuff, <strong>I won't enjoy them and use them</strong>.
<br><br>
Accidentally, <strong>my poor memory makes me the most productive programmer in the room</strong>. And you can be too. How?</p> ]]></description>
                <content:encoded><![CDATA[ <p>I had the Symfony &amp; Git training last Friday. We were using a single <code>master</code> branch on Gitlab and multiple programmers send their pull-requests into. We needed to pull and rebase after the feature was merged into the <code>master</code>.</p>
<p>How did they do it? It was similar to:</p>
<pre><code class="language-bash">- git checkout -b new-branch

# oh, there is some code in this branch
- git checkout .
- git checkout -b new-branch

# working and making some file changes
- git add .
- git commit -m Some message

# damn I forgot quotes
- git commit -m "Some message"
- git checkout master

# damn I forgot to push
- git push
# what branch? oh damn, this one of course
- git push new-branch

# now I can merge it and I can get new master version
- git checkout master
- git pull

# oh, I made accidentally some change
- git add .
- git commit -m "add master changes"
- git pull

# oh, I've heard this is better with some lease or what
- git pull --with-lease

# oh finally I have local code here
- git branch

# damn that branch is still here :/
- git branch -d new-branch

# damn, why is this the only big letter here?
- git branch -D new-branch</code></pre>
<p>...30 minutes later they're done. But <strong>does it have to take so long</strong>?</p>
<p><br></p>
<p>I keep getting the same feedback from most of my trainings:</p>
<blockquote class="blockquote">
"Wow you're fast at coding".
</blockquote>
<p>And I keep replying:</p>
<blockquote class="blockquote">
"I'm not, I'm just much lazier than you."
</blockquote>
<p><br></p>
<p>What does that mean? If you'd recorded my keyboard for the process above, it would look more like this:</p>
<pre><code class="language-bash">nb new-branch
gc "Some Message"
p
cmp
db new-branch
rema
gc
p
pul
gc
...</code></pre>
<p>You get the idea. For you, it looks like a cat is walking my keyboard, or I'm having a party at home with way too much wine. <em>For you.</em></p>
<p><strong><em>For me</em> it's a path of 2-3 neurons, that invoke some operation I want to achieve.</strong></p>
<h2 id="The-Alias-File">The Alias File</h2>
<p>Secret is in <code>~/.aliases</code> file (<code>~</code> = user home directory), that looks like this:</p>
<pre><code class="language-bash"># ~/.aliases
alias a="sudo subl .aliases"

alias gc="git commit -m $1"
alias db="git branch -D $1"
alias pul="git fetch -p &amp;&amp; git pull --rebase"</code></pre>
<p>That's it! This single hack makes me so productive.</p>
<h2 id="What-do-I-use-for-CLI">What do I use for CLI?</h2>
<h3 id="Oh-My-Zen-shell">Oh My Zen shell</h3>
<p>I've used this on Ubuntu for the last 8 years (thanks to Michal Svec for helping me with it). It's a smart shell you can install from here - <a href="https://github.com/ohmyzsh/ohmyzsh">oh-my-zsh</a>.</p>
<h2 id="How-to-Add-Aliases">How to Add Aliases?</h2>
<p>Load your aliases in the main file:</p>
<pre><code class="language-bash"># ~/.zshrc
source $HOME/.aliases</code></pre>
<p>There are various shells, so specific file names might differ.</p>
<p>Now type &quot;a&quot; and voilá - <strong>the file with aliases is open</strong>!</p>
<h2 id="Restart-Console-After-Adding-a-New-Alias">Restart Console After Adding a New Alias</h2>
<p>Let's say we type new alias:</p>
<pre><code class="language-bash"># ~/.aliases
alias gf="git push --force"</code></pre>
<p>And save the file. Now we get back to our and type:</p>
<pre><code class="language-bash">gf
# zsh: command not found: gf</code></pre>
<p>What?</p>
<p>Well, the file <code>~/.aliases</code> has to reloaded to make it work.
The best way to do it is to close and open the console window.</p>
<h2 id="Honor-One-Woman-Tip">Honor One Woman Tip</h2>
<p>You honor one woman, you honor one console. I've noticed some programmer use multiple consoles at the same time:</p>
<ul>
<li>PHPStorm console</li>
<li>Windows console</li>
<li>bash console</li>
</ul>
<p>When I work, I always go for <strong>PHPStorm console</strong>. In rare moments like performance heavy operations outside the project scope, I got with the terminal. But I still keep preferring having opened just one.</p>
<p>That way I can:</p>
<ul>
<li><strong>focus on one project</strong></li>
<li><strong>have a single image in my head</strong> - compared to various console design of IDE and your OS</li>
<li><strong>have one shortcut to open it</strong></li>
</ul>
<p>One, one, one.</p>
<blockquote class="blockquote">
If it's two, it's too long.
</blockquote>
<h2 id="Memory-Overflow-Tip-Don-t-Be-Greedy-with-ShortCuts">Memory Overflow Tip: Don't Be Greedy with ShortCuts</h2>
<p><strong>Shortcuts are like cocaine</strong>. They can make you ultimately faster in small doses, but if you take too much of them, your brain will fall apart.</p>
<p>Pick around 10-20 shortcuts. Then every <del>now and then</del> 3 months look at and validate <strong>if they still suit you</strong>.</p>
<p><strong>Always alias your shortcuts you use everyday</strong>. The one above are just examples, but maybe you don't commit that much, or you don't use git at all. Maybe you work with the server.</p>
<p>So instead of</p>
<pre><code class="language-bash">ssh my-username@theserveryouuse.com</code></pre>
<p>you 'll get with <code>sms</code> (ssh, my, server)</p>
<p><br></p>
<p>That's what helped me, to always pick the first letter of the work.</p>
<ul>
<li>git pull? → <strong>gp</strong></li>
<li>git commit? → <strong>gc</strong></li>
<li>composer update? → <strong>cu</strong></li>
<li>rebase on <code>main</code> → <strong>rema</strong></li>
</ul>
<p>Keep it simple and your brain gets it :)</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/11/25/the-single-best-skill-to-master-command-line</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 25 Nov 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/11/25/the-single-best-skill-to-master-command-line#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Delegate Code Reviews to CI ]]></title>
                <link>https://tomasvotruba.com/blog/2019/11/18/how-to-delegate-code-reviews-to-ci</link>
                <description><![CDATA[ <p>Are you doing code reviews? No? Yes?
<br>
<br>
<strong>In both cases, you won't have too</strong>. Just add a couple of YAML lines to your CI.</p> ]]></description>
                <content:encoded><![CDATA[ <p>I'm very grateful that Rector is getting traction lately. More and more PHP developers save dozens of hours by running simple CLI commands on their codebases.</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Just upgraded <a href="https://twitter.com/phpunit?ref_src=twsrc%5Etfw">@phpunit</a> from 4.0 to 8.4 with <a href="https://twitter.com/rectorphp?ref_src=twsrc%5Etfw">@rectorphp</a> in 3 seconds with one command. It's worth knowing this tool. Thanks <a href="https://twitter.com/VotrubaT?ref_src=twsrc%5Etfw">@VotrubaT</a> 👏 <a href="https://t.co/o3ESvJRsJ7">pic.twitter.com/o3ESvJRsJ7</a></p>— Arkadiusz Kondas (@ArkadiuszKondas) <a href="https://twitter.com/ArkadiuszKondas/status/1196349896690950144?ref_src=twsrc%5Etfw">November 18, 2019</a></blockquote>
<p><br></p>
<p>It's a lot. But you want more laziness, right?</p>
<p><br></p>
<p><strong>Rector can do much more without you even running it</strong>.</p>
<p><div class="card ml-4 mt-4 border-warning float-right post-snippet" style="width: 14em">
    <div class="card-body">
        Would you like to <strong>learn more about Rector</strong>? Step by step, from zero to hero?
        <br>

        <div class="text-center">
            <a href="/book/the-power-of-automated-refactoring/">
                <img src="/assets/images/rector_book.png" class="mb-3 mt-3 shadow">
                Get our new book
            </a>
        </div>
    </div>
</div>
</p>
<h2 id="What-do-you-Review-in-Code">What do you Review in Code?</h2>
<p>If you do code-review, what do you mostly do?</p>
<ol>
<li>
<p><strong>Look for patterns</strong>, explain them, report them everywhere or just somewhere and hope the other person will fix them all.</p>
</li>
<li>
<p><strong>Discuss the design</strong> and why and what should be done about it.</p>
</li>
</ol>
<p>Well, the 2nd cannot be automated, unless you're able to put it in clear step-by-step, e.g SOLID laws in procedural code. So you still have to do that, sorry.</p>
<h2 id="Dead-Fat-Code">Dead Fat Code</h2>
<p>But 1st step can be easily automated. How? Well, let's take a dead code for example.
In the last <a href="/blog/2019/07/29/how-we-completed-thousands-of-missing-var-annotations-in-a-day/">project I've helped to improve with Rector</a>, there were 2 years of dead-code piled up. A dead that you have to:</p>
<ul>
<li>test</li>
<li>maintain</li>
<li>debug if broken</li>
<li>review if changed anything related to it</li>
</ul>
<p><strong>So many human-hours wasted</strong>. In the end, we <strong>removed over 12 % of &quot;dead fat code&quot;</strong>. Wouldn't it be better if that fat would never be got it?</p>
<h2 id="Add-Rector-in-CI-in-3-Steps">Add Rector in CI in 3 Steps</h2>
<ol>
<li>Install Rector</li>
</ol>
<pre><code class="language-bash">composer require rector/rector --dev</code></pre>
<ol start="2">
<li>Create <code>rector.php</code> config just for code-reviews</li>
</ol>
<pre><code class="language-php">use Rector\Set\ValueObject\SetList;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;import(SetList::DEAD_CODE);
};</code></pre>
<ol start="3">
<li>And add to your CI bash</li>
</ol>
<pre><code class="language-bash">vendor/bin/rector process src --dry-run</code></pre>
<h2 id="How-to-add-Rector-CI-to-your-Favorite-CI">How to add Rector CI to your Favorite CI?</h2>
<p>I've prepared a demo with PHP code and a testing pipeline for all widely used CI services.</p>
<ul>
<li><a href="#1-github-actions">GitHub Actions</a></li>
<li><a href="#2-gitlab-ci">Gitlab CI</a></li>
</ul>
<p><br></p>
<p>There you'll find all the configuration you need to <strong>let your CI do code-reviews</strong>.</p>
<h3 id="1-GitHub-Actions">1. GitHub Actions</h3>
<p><br></p>
<p><a href="https://github.com/tomasvotruba/rector-ci-demo" class="btn btn-info">Repository</a></p>
<pre><code class="language-yaml"># .github/workflows/php.yml
name: Rector Code Review

on: [push]

jobs:

    build:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v1

            -
                name: Validate composer.json and composer.lock
                run: composer validate

            -
                name: Install dependencies
                run: composer install --no-progress --no-suggest

            -
                name: Code Review
                run: ./vendor/bin/rector process --dry-run</code></pre>
<h3 id="2-Gitlab-CI">2. Gitlab CI</h3>
<pre><code class="language-yaml"># .gitlab-ci.yml
# inspired from https://docs.gitlab.com/ee/ci/examples/php.html

# see https://github.com/RobBrazier/docker-php-composer
image: robbrazier/php:7.2

before_script:
    # install composer dependencies for all stages
    - composer install --prefer-dist --no-ansi --no-interaction --no-progress

stages:
    - test

tests:
    stage: test
    script:
        - vendor/bin/phpunit

code-review:
    stage: test
    script:
        - vendor/bin/rector process --dry-run</code></pre>
<h2 id="What-sets-to-Start-With">What sets to Start With?</h2>
<p>Here are my favorite sets I apply first:</p>
<pre><code class="language-php">use Rector\Nette\Set\NetteSetList;
use Rector\Set\ValueObject\SetList;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;import(SetList::CODING_STYLE);
    $rectorConfig-&gt;import(SetList::CODE_QUALITY);
    $rectorConfig-&gt;import(SetList::DEAD_CODE);
    $rectorConfig-&gt;import(NetteSetList::NETTE_UTILS_CODE_QUALITY);
};</code></pre>
<p>But you don't have to stop there. Pick <strong>any of <a href="https://github.com/rectorphp/rector/tree/main/config/set">100+ sets</a></strong> that Rector provides.</p>
<p><br>
<br></p>
<p>That's it!</p>
<p>Oh... one more thing. You don't have to resolve all the Rector reported flaws manually, <strong>just remove the <code>--dry-run</code> option</strong> and run it locally before pushing:</p>
<pre><code class="language-bash">vendor/bin/rector process src</code></pre>
<p><br></p>
<p>Enjoy your coffee!</p>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/11/18/how-to-delegate-code-reviews-to-ci</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 18 Nov 2019 00:00:00 +0000</pubDate>
                                    <updated>2020-12-01UTC00:00:000</updated>
                    <atom:updated>Tue, 01 Dec 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Tue, 01 Dec 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/11/18/how-to-delegate-code-reviews-to-ci#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ From 0 Doc Types to Full Type Declaration with Dynamic Analysis ]]></title>
                <link>https://tomasvotruba.com/blog/2019/11/11/from-0-doc-types-to-full-type-declaration-with-dynamic-analysis</link>
                <description><![CDATA[ <p>I wrote <a href="/blog/2019/07/29/how-we-completed-thousands-of-missing-var-annotations-in-a-day/">How we Completed Thousands of Missing @var Annotations in a Day</a>. If you have at least some annotations, you can use Rector to do the dirty work.
<br>
<br>
To be honest, open-source is the top 1 % code there is, but out <strong>in the wild of <del>legacy</del> established PHP companies, it's a miracle to see just one <code>string</code> type declaration</strong>.
<br>
<br>
Are these projects lost? Do you have to quit them? And what if the annotations are lying?</p> ]]></description>
                <content:encoded><![CDATA[ <p>I had a great trip with a friend of mine <a href="https://github.com/DaveLiddament">Dave Liddament</a> after <a href="https://2019.phpday.it">PHP Day 2019 in Verona</a>. During Venice sightseeing in beautiful wild rain, we had a short coffee break to talk about Rector. Dave was amazed by what Rector can do for the developer, with such a few lines of YAML config.</p>
<p>As a proper curious developer, <strong>he challenged me with series</strong> of &quot;Can it do...?&quot; or &quot;How can it...?&quot; questions.</p>
<p><br></p>
<p>The one we spent almost an hour on one was:</p>
<p><strong>&quot;How can Rector help with type declarations, if there are no docblocks and no type hints?&quot;</strong></p>
<pre><code class="language-php">&lt;?php

class SomeClass
{
    public function run($value)
    {
        return $value;
    }
}</code></pre>
<p>First I was cold stone and said: &quot;That's far beyond static analysis. That's a job for a human, Rector can't help here&quot;.</p>
<p>I vividly recall I was sure was <em>this is impossible</em> (← now this line my motto pick project that is interesting enough, lol).</p>
<p><br></p>
<p>But David sticks with it questioning:</p>
<ul>
<li>&quot;If we know there is <strong>always a string coming inside and nothing else</strong>, we could do this:&quot;</li>
</ul>
<pre><code class="language-diff"> &lt;?php

 class SomeClass
 {
-    public function run($value)
+    public function run(string $value): string
     {
         return $value;
     }
 }</code></pre>
<ul>
<li>&quot;Well... yes, you're right.&quot;</li>
</ul>
<h2 id="Detect-Every-Argument-Type">Detect Every Argument Type</h2>
<p>I started to see a very small candle at the end of the tunnel and said:</p>
<ul>
<li>&quot;We could do some kind of logging types that come to the method. Collect enough data and decide based on that.&quot;</li>
</ul>
<p>There is a similar technique for dead-code analysis - <a href="https://github.com/krakjoe/tombs">tombs</a>. But the problem is, <strong>it's not written in PHP</strong>. And if it's not written in the language we use, we are not able to extend it or fix it. That's why PHPStorm plugins written Java take so long to catch up with framework releases.</p>
<p>We wanted to have the code just once in the whole application. If possible in the end and collect all the method calls and their arguments. We tried to use <code>register_shutdown_function</code> and <code>debug_trace</code> for it. But after some time spends hacking them, we gave up.</p>
<p>So it will have to be good old <strong>static call under each class method</strong>, something like:</p>
<pre><code class="language-diff"> &lt;?php

 class SomeClass
 {
    public function run($value)
    {
+       TypeCollector::collect($value, __METHOD__, 0);
        return $value;
    }
 }</code></pre>
<h2 id="What-about-Performance">What about Performance?</h2>
<p><code>file_put_contents()</code> takes <a href="https://www.php.net/manual/en/function.file-put-contents.php#105421">~10 ms for 10 000 writes</a> writes, so writing in filesystem might work.</p>
<p>Still, it's safer to use <strong>feature toggles</strong> or direct <strong>small fraction of traffic</strong> to a standalone server with these static methods.</p>
<h2 id="How-Long-Should-we-Collect-Data">How Long Should we Collect Data?</h2>
<p>This needs to be tested in the wild. It depends on many factors, for a blogging platform, it can be a week of data.
For a payment system, a month would be better, maybe more to be sure.</p>
<p>Also, the same way we collect data first <strong>with feature toggle/traffic fraction</strong>, we can test added types after they're added to the code.</p>
<h2 id="The-Simple-Idea">The Simple Idea</h2>
<p>To make the idea more solid, we looked for the edge cases:</p>
<ul>
<li>&quot;Wait, so we just collect types and then analyze them?&quot;</li>
<li>&quot;Yes, if there are 10 000 calls for the method and it gets a string in 100 % cases, it's a <code>string</code>.&quot;</li>
<li>&quot;But, if 5 % of them is null... it will be nullable <code>?string</code>&quot;</li>
<li>&quot;Exactly, and if it's 5 different types, there is nothing we can do.&quot;</li>
<li>&quot;I see, but the point is to complete everything that can be completed, based on data and experience instead of docblock that can contain anything.&quot;</li>
</ul>
<p>The idea is pretty clear, right?</p>
<h2 id="How-can-we-bring-it-to-all-PHP-developers-in-Need">How can we bring it to all PHP developers in Need?</h2>
<p>It all seemed like a nice brain exercise for our brains... but we looked for <strong>practical appliance that would help every PHP developer in the world</strong>.</p>
<p>To automate this process fully, we came with 4 automated steps:</p>
<ul>
<li>
<ol>
<li>Add type collector to all public class and trait methods</li>
</ol>
<pre><code class="language-diff"> &lt;?php

 class SomeClass
 {
    public function run($value)
    {
+       TypeCollector::collect($value, __METHOD__, 0);
        return $value;
    }
 }</code></pre>
</li>
<li>
<ol start="2">
<li>Collect data for a 1-4 weeks</li>
</ol>
</li>
<li>
<ol start="3">
<li>Complete collected types that can be added</li>
</ol>
<pre><code class="language-diff"> &lt;?php

 class SomeClass
 {
-    public function run($value)
+    public function run(string $value)
     {
         TypeCollector::collect($value, __METHOD__, 0);
         return $value;
     }
 }</code></pre>
</li>
<li>
<ol start="4">
<li>Remove type collector</li>
</ol>
<pre><code class="language-diff"> &lt;?php

 class SomeClass
 {
     public function run(string $value)
     {
-        TypeCollector::collect($value, __METHOD__, 0);
         return $value;
     }
 }</code></pre>
</li>
</ul>
<p>This was May 2019 and it was just an idea. Now, 6 months later, I'm proud to say this <strong>4-step process is now possible</strong>.
I've  <a href="https://github.com/rectorphp/rector/pull/2264/files">merged the PR into Rector</a> just a few minutes ago.</p>
<p>↓</p>
<h3 id="Step-1-Add-Type-Collector">Step 1 - Add Type Collector</h3>
<pre><code class="language-php">use Rector\DynamicTypeAnalysis\Rector\ClassMethod\DecorateMethodWithArgumentTypeProbeRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;rule(DecorateMethodWithArgumentTypeProbeRector::class);
};</code></pre>
<pre><code class="language-bash">vendor/bin/rector process src</code></pre>
<h3 id="Step-2-Wait-for-it">Step 2 - Wait for it...</h3>
<h3 id="Step-3-Complete-Collected-Types">Step 3 - Complete Collected Types</h3>
<pre><code class="language-php">use Rector\DynamicTypeAnalysis\Rector\ClassMethod\AddArgumentTypeWithProbeDataRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;rule(AddArgumentTypeWithProbeDataRector::class);
};</code></pre>
<pre><code class="language-bash">vendor/bin/rector process src</code></pre>
<h3 id="Step-4-Remove-Type-Collector">Step 4 - Remove Type Collector</h3>
<pre><code class="language-php">use Rector\DynamicTypeAnalysis\Rector\StaticCall\RemoveArgumentTypeProbeRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;rule(RemoveArgumentTypeProbeRector::class);
};</code></pre>
<pre><code class="language-bash">vendor/bin/rector process src</code></pre>
<p><br></p>
<h2 id="It-s-not-Perfect-But-Done">It's not Perfect, But Done</h2>
<p>In all means, it's not perfect. There is still missing support for arrays, nested arrays, type co/ntra/variance, return types, union types, etc. <strong>But it's ready to be tested and prototype works</strong> (at least that's what unit tests say).</p>
<p>Now it's up to you. Make your code-base filled with real data it already uses. No guessing, no hoping, <strong>just science fully-automated</strong>.</p>
<p><br></p>
<p>Last but not least, thank you <a href="https://github.com/DaveLiddament">Dave</a> for a great afternoon and sorry it took me so long to publish this.</p>
<p><br></p>
<p>Happy lazy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/11/11/from-0-doc-types-to-full-type-declaration-with-dynamic-analysis</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 11 Nov 2019 00:00:00 +0000</pubDate>
                                    <updated>2020-08-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Aug 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Aug 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/11/11/from-0-doc-types-to-full-type-declaration-with-dynamic-analysis#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Still on PHPUnit 4? Come to PHPUnit 8 Together in a Day ]]></title>
                <link>https://tomasvotruba.com/blog/2019/11/04/still-on-phpunit-4-come-to-phpunit-8-together-in-a-day</link>
                <description><![CDATA[ <p>Last month I was on <a href="https://twitter.com/akrabat/status/1181998973588037632">PHPSW meetup</a> in Bristol UK with Rector talk. To be honest, <a href="/blog/2019/08/26/how-we-migrated-54-357-lines-of-code-nette-to-symfony-in-2-people-under-80-hours/">Nette to Symfony migration under 80 hours</a> was not a big deal there.
<br><br>
To my surprise, <strong>upgrading PHPUnit tests was</strong>. So I was thinking, let's take it from the floor in one go, from PHPUnit 4 to the latest PHPUnit 8.</p> ]]></description>
                <content:encoded><![CDATA[ <img src="/assets/images/posts/2019/phpunit/tweet.png" class="mt-4 mb-4">
<h2 id="1-Planning">1. Planning</h2>
<p>Before we dive into the upgrading of our tests, we need to <strong>look at minimal PHP version</strong> required by each PHPUnit.
The <a href="https://github.com/sebastianbergmann/phpunit/wiki/Development-and-Release-Process">PHPUnit release process</a> states, <strong>that each new PHPUnit major version requires a newer minor PHP version</strong>.</p>
<p>What does that mean?</p>
<table class="table table-bordered table-responsive">
    <thead class="thead-inverse">
        <tr>
            <th>PHPUnit</th>
            <th>Required PHP version</th>
            <th>Relase Year</th>
        </tr>
    </thead>
    <tr>
        <td>PHPUnit 4</td>
        <td>PHP 5.3-5.6</td>
        <td>2015</td>
    </tr>
    <tr>
        <td>PHPUnit 5</td>
        <td>PHP 5.6-7.4</td>
        <td>2016</td>
    </tr>
    <tr>
        <td>PHPUnit 6</td>
        <td>PHP 7.0-7.4</td>
        <td>2017</td>
    </tr>
    <tr>
        <td>PHPUnit 7</td>
        <td>PHP 7.1-7.4</td>
        <td>2018</td>
    </tr>
    <tr>
        <td>PHPUnit 8</td>
        <td>PHP 7.2-7.4</td>
        <td>2019</td>
    </tr>
</table>
<p>We need to plan and combine the PHP upgrade.</p>
<p>This is <strong>the full path</strong> we'll go through:</p>
<ul>
<li>upgrade PHP 5.3 → 5.6</li>
<li>upgrade PHPUnit 4 → 5</li>
<li>upgrade PHP 5.6 → 7.0</li>
<li>upgrade PHPUnit 5 → 6</li>
<li>upgrade PHP 7.0 → 7.1</li>
<li>upgrade PHPUnit 6 → 7</li>
<li>upgrade PHP 7.1 → 7.2</li>
<li>upgrade PHPUnit 7 → 8</li>
</ul>
<p><em>Note: To keep this post simple, we'll focus on PHPUnit upgrade only here. But it's possible you'll need to use Rector for PHP upgrades between PHPUnit upgrade steps too.</em></p>
<h2 id="2-Single-Version-Upgrade-1-pull-request">2. Single Version Upgrade = 1 pull-request</h2>
<p>Do you enjoy <em>the rush</em> of changing a thousand files at once? It drives to do even more and more changes.</p>
<p>The same thing happens with upgrading code - we upgrade PHP and tests passes, great! Let's do upgrade PHPUnit. Oh, maybe we could refactor this method so it's more readable. Oh, now this other method looks silly, let's clean that up too...</p>
<img src="/assets/images/posts/2019/phpunit/explode.jpg" class="img-thumbnail">
<p><span class="text-danger">
<strong>STOP!</strong>
</span></p>
<p>This is the easiest way <strong>to get stuck</strong> in broken tests, with dug up pieces of code all over the project, overheat our brain in <a href="/blog/2018/05/21/is-your-code-readable-by-humans-cognitive-complexity-tells-you/">huge cognitive complexity</a> and <del>give up</del> rage quit the upgrade saying &quot;it's hard as they say&quot;.</p>
<p><div class="card ml-4 mt-4 border-warning float-right post-snippet" style="width: 14em">
    <div class="card-body">
        Would you like to <strong>learn more about Rector</strong>? Step by step, from zero to hero?
        <br>

        <div class="text-center">
            <a href="/book/the-power-of-automated-refactoring/">
                <img src="/assets/images/rector_book.png" class="mb-3 mt-3 shadow">
                Get our new book
            </a>
        </div>
    </div>
</div>
</p>
<h3 id="The-Golden-Rule-of-Successful-Upgrade">The Golden Rule of Successful Upgrade</h3>
<ul>
<li>one minor version at a time</li>
<li>one pull-request at a time</li>
<li>tested, our CI passes</li>
<li><strong>only after the PR is merged, we go to next minor version</strong></li>
</ul>
<p>Unless you're upgrading 10 test files, of course. But in the rest of the case, this approach would save me many failed attempts in the paths. That's why <strong>planning is the most important step of all</strong> for huge upgrade operations.</p>
<h2 id="3-PHPUnit-4-to-5">3. PHPUnit 4 to 5</h2>
<h3 id="From-getMock-to-getMockBuilder">From <code>getMock()</code> to <code>getMockBuilder()</code></h3>
<pre><code class="language-diff"> final class MyTest extends PHPUnit_Framework_TestCase
 {
     public function test()
     {
-        $someClassMock = $this-&gt;getMock('SomeClass');
+        $someClassMock = $this-&gt;getMockBuilder('SomeClass')-&gt;getMock();
     }
 }</code></pre>
<p><br></p>
<p>These changes can be delegated to Rector:</p>
<pre><code class="language-bash">composer require phpunit/phpunit "^5.0" --dev</code></pre>
<p>Update set in <code>rector.php</code></p>
<pre><code class="language-php">use Rector\PHPUnit\Set\PHPUnitSetList;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;import(PHPUnitSetList::PHPUNIT_50);
};</code></pre>
<p>Run Rector</p>
<pre><code class="language-bash">vendor/bin/rector process tests</code></pre>
<h2 id="4-PHPUnit-5-to-6">4. PHPUnit 5 to 6</h2>
<p>This is the release where <strong>PHPUnit got namespaces</strong>, yay! Well, yay for the project, nay for the upgrades.</p>
<h3 id="From-Underscore-to-Slash">From Underscore to Slash</h3>
<p>Although there is a lot of underscore &lt;=&gt; slash aliases for a smoother upgrade, it will be removed in the future PHPUnit version, so we better deal with it right now.</p>
<p>First, we need to replace all:</p>
<pre><code class="language-diff">-PHPUnit_Framework_TestCase
+\PHPUnit\Framework\TestCase # mind the pre-slash "\"</code></pre>
<p>Without pre-slash, your code might fail.</p>
<p><a class="btn btn-primary" href="https://3v4l.org/5Sjjh">
See 3v4l.org to understand why
</a></p>
<p><br></p>
<p>Second, replace the rest of the <code>PHPUnit_*</code> classes with a namespace. Listeners, test suites, exceptions... etc.
This is hell for us human, luckily easy-pick for Rector.</p>
<h3 id="Add-doesNotPerformAssertions-to-test-With-no-Assertion">Add <code>doesNotPerformAssertions</code> to test With no Assertion</h3>
<pre><code class="language-diff">+    /**
+     * @doesNotPerformAssertions
+     */
     public function testNoError()
     {
         new SomeObject(25);
     }</code></pre>
<h3 id="setExpectedException-to-expectException"><code>setExpectedException()</code> to <code>expectException()</code></h3>
<p>And not only that! Also, split arguments to own method:</p>
<pre><code class="language-diff"> &lt;?php

 class MyTest extends \PHPUnit\Framework\TestCase
 {
     public function test()
     {
-        $this-&gt;setExpectedException('SomeException', $message, 101);
+        $this-&gt;expectException('SomeException');
+        $this-&gt;expectExceptionMessage($message);
+        $this-&gt;expectExceptionCode(101);
     }
 }</code></pre>
<p>Also <code>setExpectedExceptionRegExp()</code> was removed.</p>
<h3 id="at-expectedException-to-expectException"><code>@expectedException</code> to <code>expectException()</code></h3>
<p>These changes are a real challenge for simple human attention:</p>
<pre><code class="language-diff">-expectedException
+expectException</code></pre>
<p>Mind the missing &quot;ed&quot;.</p>
<pre><code class="language-diff"> &lt;?php

 class MyTest extends \PHPUnit\Framework\TestCase
 {
-    /**
-     * @expectedException SomeException
-     */
     public function test()
     {
+        $this-&gt;expectException('SomeException');
     }
 }</code></pre>
<p><br></p>
<p>These changes can be delegated to Rector:</p>
<pre><code class="language-bash">composer require phpunit/phpunit "^6.0" --dev</code></pre>
<p>Update set in <code>rector.php</code></p>
<pre><code class="language-php">use Rector\PHPUnit\Set\PHPUnitSetList;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;import(PHPUnitSetList::PHPUNIT_60);
};</code></pre>
<p>Run Rector</p>
<pre><code class="language-bash">vendor/bin/rector process tests</code></pre>
<h2 id="5-PHPUnit-6-to-7">5. PHPUnit 6 to 7</h2>
<h3 id="Remove-and-quot-test-and-quot-prefix-on-Data-Providers">Remove &quot;test&quot; prefix on Data Providers</h3>
<p>I have no idea how tests and data provider methods were detected before this:</p>
<pre><code class="language-diff"> class WithTestAnnotation extends \PHPUnit\Framework\TestCase
 {
     /**
-     * @dataProvider testProvideDataForWithATestAnnotation()
+     * @dataProvider provideDataForWithATestAnnotation()
      */
     public function test()
     {
         // ...
     }

-    public function testProvideDataForWithATestAnnotation()
+    public function provideDataForWithATestAnnotation()
     {
         return ['123'];
     }
 }</code></pre>
<h3 id="Rename-at-scenario-annotation-to-at-test">Rename <code>@scenario</code> annotation to <code>@test</code></h3>
<pre><code class="language-diff"> class WithTestAnnotation extends \PHPUnit\Framework\TestCase
 {
     /**
-     * @scenario
+     * @test
      */
     public function test()
     {
         // ...
     }
 }</code></pre>
<h3 id="Change-withConsecutive-Arguments-to-Iterable">Change <code>withConsecutive()</code> Arguments to Iterable</h3>
<p>This rather small change can cause a huge headache. It's <a href="https://github.com/sebastianbergmann/phpunit/commit/72098d80f0cfc06c7e0652d331602685ce5b4b51">a fix of silent false positive</a>.</p>
<p>How would you fix the following code, if you know that the argument of <code>withConsecutive()</code> must be iterable (array, iterator...)?</p>
<pre><code class="language-php">class SomeClass
{
    public function run($one, $two)
    {
    }
}

class SomeTestCase extends \PHPUnit\Framework\TestCase
{
    public function test()
    {
        $someClassMock = $this-&gt;createMock(SomeClass::class);
        $someClassMock
            -&gt;expects($this-&gt;exactly(2))
            -&gt;method('run')
            -&gt;withConsecutive(1, 2, 3, 5);
    }
}</code></pre>
<p>Like this?</p>
<pre><code class="language-diff">--&gt;withConsecutive(1, 2, 3, 5);
+-&gt;withConsecutive([1, 2, 3, 5]);</code></pre>
<p>Well, the tests would pass it, but it would be another silent positive. Look at <code>SomeClass::run()</code> method. How many arguments does it have?</p>
<p>Two. So we need to create array chunks of size 2.</p>
<pre><code class="language-diff">--&gt;withConsecutive(1, 2, 3, 5);
+-&gt;withConsecutive([1, 2], [3, 5]);</code></pre>
<p><br></p>
<p>These changes can be delegated to Rector:</p>
<pre><code class="language-bash">composer require phpunit/phpunit "^7.0" --dev</code></pre>
<p>Update set in <code>rector.php</code></p>
<pre><code class="language-php">use Rector\PHPUnit\Set\PHPUnitSetList;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;import(PHPUnitSetList::PHPUNIT_70);
    $rectorConfig-&gt;import(PHPUnitSetList::PHPUNIT_75);
};</code></pre>
<p>Run Rector</p>
<pre><code class="language-bash">vendor/bin/rector process tests</code></pre>
<h2 id="6-PHPUnit-7-to-8">6. PHPUnit 7 to 8</h2>
<h3 id="Ignore-Cache-File">Ignore Cache File</h3>
<p>The <a href="https://github.com/sebastianbergmann/phpunit/pull/3147">optional caching of test results</a> added in PHPUnit 7.3 is not enabled by default. We need to add the cache file to <code>.gitignore</code>:</p>
<pre><code class="language-txt"># .gitignore
.phpunit.result.cache</code></pre>
<h3 id="Remove-type-dataName-in-PHPUnit-Framework-TestCase-Constructor-Override">Remove type <code>$dataName</code> in <code>PHPUnit\Framework\TestCase</code> Constructor Override</h3>
<pre><code class="language-diff"> &lt;?php

 abstract class MyAbstractTestCase extends \PHPUnit\Framework\TestCase
 {
-    public function __construct(?string $name = null, array $data = [], string $dataName = '')
+    public function __construct(?string $name = null, array $data = [], $dataName = '')
     {
     }
 }</code></pre>
<h3 id="Replace-assertContains-with-Specific-assertStringContainsString-Method">Replace <code>assertContains()</code> with Specific <code>assertStringContainsString()</code> Method</h3>
<pre><code class="language-diff"> &lt;?php

 final class SomeTest extends \PHPUnit\Framework\TestCase
 {
     public function test()
     {
-        $this-&gt;assertContains('foo', 'foo bar');
+        $this-&gt;assertStringContainsString('foo', 'foo bar');

-        $this-&gt;assertNotContains('foo', 'foo bar');
+        $this-&gt;assertStringNotContainsString('foo', 'foo bar');
     }
 }</code></pre>
<h3 id="Replace-assertInternalType-with-Specific-Methods">Replace <code>assertInternalType()</code> with Specific Methods</h3>
<p>This change <a href="https://github.com/sebastianbergmann/phpunit/commit/a406c85c51edd76ace29119179d8c21f590c939e">is huge</a>.</p>
<p><strong>2 methods were removed, 22 methods are added.</strong></p>
<pre><code class="language-diff"> &lt;?php

 final class SomeTest extends \PHPUnit\Framework\TestCase
 {
     public function test()
     {
-        $this-&gt;assertInternalType('string', $value);
+        $this-&gt;assertIsString($value);
     }
 }</code></pre>
<h3 id="Change-assertEquals-method-Parameters-to-new-Specific-Methods">Change <code>assertEquals()</code> method Parameters to new Specific Methods</h3>
<pre><code class="language-diff"> final class SomeTest extends \PHPUnit\Framework\TestCase
 {
     public function test()
     {
         $value = 'value';
-        $this-&gt;assertEquals('string', $value, 'message', 5.0);
+        $this-&gt;assertEqualsWithDelta('string', $value, 5.0, 'message');

-        $this-&gt;assertEquals('string', $value, 'message', 0.0, 20);
+        $this-&gt;assertEquals('string', $value, 'message', 0.0);

-        $this-&gt;assertEquals('string', $value, 'message', 0.0, 10, true);
+        $this-&gt;assertEqualsCanonicalizing('string', $value, 'message');

-        $this-&gt;assertEquals('string', $value, 'message', 0.0, 10, false, true);
+        $this-&gt;assertEqualsIgnoringCase('string', $value, 'message');
     }
 }</code></pre>
<h3 id="Last-is-now-Namespaced">Last <code>_</code> is now Namespaced</h3>
<p>This removes the last piece of back-compatible underscore class:</p>
<pre><code class="language-diff">-PHPUnit_Framework_MockObject_MockObject
+PHPUnit\Framework\MockObject\MockObject</code></pre>
<h3 id="Replace-assertArraySubset-with">Replace <code>assertArraySubset()</code> with</h3>
<p>This method was removed <a href="https://github.com/sebastianbergmann/phpunit/issues/3494">because of its vague behavior</a>.
The proposed solution is <a href="https://github.com/rdohms/phpunit-arraysubset-asserts">rdohms/phpunit-arraysubset-asserts</a> polyfill.</p>
<pre><code class="language-diff"> namespace Acme\Tests;

+use DMS\PHPUnitExtensions\ArraySubset\Assert;

 final class AssertTest extends \PHPUnit\Framework\TestCase
 {
     public function testPreviouslyStaticCall(): void
     {
-        $this-&gt;assertArraySubset(['bar' =&gt; 0], ['bar' =&gt; '0'], true);
+        Assert::assertArraySubset(['bar' =&gt; 0], ['bar' =&gt; '0'], true);
     }
 }</code></pre>
<p>To use this package and upgrade to it, run:</p>
<pre><code class="language-bash">composer require --dev dms/phpunit-arraysubset-asserts</code></pre>
<p>Update set in <code>rector.php</code></p>
<pre><code class="language-php">use Rector\PHPUnit\Set\PHPUnitSetList;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;import(PHPUnitSetList::PHPUNIT80_DMS);
};</code></pre>
<p>Run Rector</p>
<pre><code class="language-bash">vendor/bin/rector process tests</code></pre>
<h3 id="Add-void-to-PHPUnit-Framework-TestCase-Methods">Add <code>void</code> to <code>PHPUnit\Framework\TestCase</code> Methods</h3>
<p>This one hits 2 common methods we often use:</p>
<pre><code class="language-diff">-setUp()
+setUp(): void</code></pre>
<pre><code class="language-diff">-tearDown()
+tearDown(): void</code></pre>
<p>Also less common ones:</p>
<ul>
<li><code>setUpBeforeClass()</code></li>
<li><code>assertPreConditions()</code></li>
<li><code>assertPostConditions()</code></li>
<li><code>tearDownAfterClass()</code></li>
<li><code>onNotSuccessfulTest()</code></li>
</ul>
<p>For this one, we'll use little help from Symplify:</p>
<pre><code class="language-bash">composer require symplify/phpunit-upgrader --dev
vendor/bin/phpunit-upgrader voids /tests</code></pre>
<p>That's it!</p>
<p><br></p>
<p>Then back to Rector - Update set in <code>rector.php</code></p>
<pre><code class="language-php">use Rector\PHPUnit\Set\PHPUnitSetList;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;import(PHPUnitSetList::PHPUNIT_80);
};</code></pre>
<p>Then:</p>
<pre><code class="language-bash">composer require phpunit/phpunit "^8.0" --dev</code></pre>
<p><br></p>
<p>In the end, you should see at least PHPUnit 8.5+:</p>
<pre><code class="language-bash">vendor/bin/phpunit --version
$ PHPUnit 8.5.15 by Sebastian Bergmann and contributors.</code></pre>
<p>That's it! Congrats!</p>
<p><br></p>
<p><strong>Did you find a change that we missed here?</strong> Share it in comments, so we can make this upgrade path complete and smooth for all future readers. Thank you for the whole PHP community!</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/11/04/still-on-phpunit-4-come-to-phpunit-8-together-in-a-day</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 04 Nov 2019 00:00:00 +0000</pubDate>
                                    <updated>2020-11-01UTC00:00:000</updated>
                    <atom:updated>Sun, 01 Nov 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sun, 01 Nov 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/11/04/still-on-phpunit-4-come-to-phpunit-8-together-in-a-day#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ All You Always Wanted to Know About Monorepo But Were Afraid To Ask ]]></title>
                <link>https://tomasvotruba.com/blog/2019/10/28/all-you-always-wanted-to-know-about-monorepo-but-were-afraid-to-ask</link>
                <description><![CDATA[ <p>Do you want to know what is monorepo and why/when you should use it?
Do you look for brief source that will answer your questions in simple and understandable manner?
<br>
This is it.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="What-is-Monorepo">What is Monorepo?</h2>
<p>A repository <strong>that contains multiple packages</strong> or projects. Those projects can, but <strong>don't have to be related</strong>. Most famous monorepo pioneers are Google, Facebook and Twitter.</p>
<p>The most famous monorepos in PHP are Symfony, Laravel, Symplify, Sylius, Yii2 or Shopsys.</p>
<hr>
<h2 id="Monorepo-vs-Multirepo">Monorepo vs. Multirepo</h2>
<h3 id="Single-repo-or-split-repo">Single-repo or split-repo?</h3>
<p>Monorepo is split into many single-repos, e.g. <a href="https://github.com/symfony/symfony">Symfony/Symfony</a> is split into <a href="https://github.com/symfony/console">Symfony/Console</a>, <a href="https://github.com/symfony/validator">Symfony/Validator</a> etc. Each single-repo repository is read-only. You can change its code via pull-request to the monorepo.</p>
<h3 id="Many-repo">Many-repo</h3>
<p>The other approach to manage multiple repositories. 1 package = 1 own repository. Each package has it's own development, tagging and even maintainers. E.g. <a href="https://github.com/doctrine">Doctrine 2</a> or <a href="https://github.com/nette">Nette 2</a>.</p>
<h3 id="Monolith">Monolith</h3>
<p>Monolith ≠ monorepo. Monolith is huge amount of coupled code of 1 application that is hell to maintain.</p>
<hr>
<h2 id="Why-is-Monorepo-so-Awesome">Why is Monorepo so Awesome?</h2>
<ul>
<li>
<p>Simplified organization</p>
</li>
<li>
<p>Easy to coordinate changes across modules.</p>
</li>
<li>
<p>Simplified dependencies</p>
</li>
<li>
<p>Single lint, build, test and release process</p>
</li>
<li>
<p>Tooling</p>
</li>
<li>
<p>Single place to report issues</p>
</li>
<li>
<p>Cross-project changes</p>
</li>
<li>
<p>Tests across modules are run together → finds bugs that touch multiple modules easier</p>
</li>
</ul>
<p><em>These are cherry-picked reasons from legendary <a href="https://danluu.com/monorepo">Advantages of Monolithic Version Control</a>. Read it to get deeper insight.</em></p>
<hr />
<h2 id="Tools-that-make-using-Monorepo-Easy">Tools that make using Monorepo Easy</h2>
<ul>
<li>
<p><a href="https://github.com/symplify/monorepobuilder">Symplify/MonorepoBuilder</a> - simpler, written in PHP</p>
<ul>
<li>init, setup and auto-split monorepo in minutes - great for start from scratch</li>
</ul>
</li>
<li>
<p><a href="https://github.com/shopsys/monorepo-tools">shopsys/monorepo-tools</a> - advanced, shell scripts</p>
<ul>
<li>init, setup and auto-split monorepo in minutes - great for start from scratch</li>
<li>merges history of multiple repos to one and more - great for start for code with many repositories with long history</li>
</ul>
</li>
</ul>
<h2 id="What-to-Read-Next">What to Read Next?</h2>
<ul>
<li><a href="https://dl.acm.org/citation.cfm?id=2854146">Why Google stores billions of lines of code in a single repository (2016)</a></li>
<li><a href="https://developer.atlassian.com/blog/2015/10/monorepos-in-git">Monorepos in Git (2015)</a></li>
<li><a href="https://github.com/korfuri/awesome-monorepo">korfuri/awesome-monorepo</a></li>
</ul> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/10/28/all-you-always-wanted-to-know-about-monorepo-but-were-afraid-to-ask</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 28 Oct 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/10/28/all-you-always-wanted-to-know-about-monorepo-but-were-afraid-to-ask#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Why Software Articles Must be CI Tested ]]></title>
                <link>https://tomasvotruba.com/blog/2019/09/16/why-software-articles-must-be-ci-tested</link>
                <description><![CDATA[ <p>I know many great articles that go right to the point. I use their code examples and they work. But when I recommend these articles to people I mentor, I realize the articles are already 2 years old and their code samples probably do not work any more.</p>
<p><br>
From hero to zero. Today I will show you how to <strong>keep content alive lot longer with a minimal effort.</strong></p> ]]></description>
                <content:encoded><![CDATA[ <p>Do you know <a href="https://github.com/sindresorhus/awesome">Awesome lists</a>? If not, go to check them. They collect best sources about a certain topic. When I try to learn something new, I usually start on Github looking for &quot;awesome <technology>&quot;. I recommend at least briefly to check them.</p>
<p>The idea behind Awesome list is to have resources that:</p>
<ul>
<li><strong>are up-to-date with modern technologies</strong></li>
<li><strong>are the best in the field</strong></li>
<li><strong>are easy to learn by beginners</strong></li>
</ul>
<h2 id="How-and-quot-Awesome-Doctrine-and-quot-was-Born">How &quot;Awesome Doctrine&quot; was Born</h2>
<p>When I was working with Nette, I met <strong>Doctrine ORM</strong> thanks to <a href="https://filip-prochazka.com">Filip Procházka</a> and his great <a href="https://github.com/Kdyby">Kdyby</a> open-source boom.</p>
<p>One day I decided to learn more about Doctrine. Documentation looked like a manual for experts rather than something I could learn from. I was also curious <strong>how people use Doctrine in real applications, how to overcome performance issues, some cool features and pro tips</strong>.</p>
<p>I was already familiar with <a href="https://github.com/ziadoz/awesome-php">Awesome PHP</a> by <a href="https://github.com/ziadoz">ziadoz</a>, so I looked for &quot;Awesome Doctrine&quot;.</p>
<p>0 results. Really? Why nobody made this? It's so obvious this would be useful.</p>
<p>Ah, it's my job then. And the joyful hell started.</p>
<h3 id="Many-Sources-on-Many-Versions">Many Sources on Many Versions</h3>
<p>I was lucky to find many articles about Doctrine. One about Filters, others about Events or Criteria. But when I tried to use the code, it often didn't work. After digging I found out there was version 1.0, which was completely different.</p>
<blockquote>
<p>Tip: When you write a post about software, mention the version you're referring to – even if it only has one at the moment.</p>
</blockquote>
<p>So I liked the concept in article and wanted to use it, but I didn't know what is different in version 2.4. I closed it.</p>
<p>I also read <a href="https://www.zdrojak.cz/clanky/doctrine-2-uvod-do-systemu">Czech series on Zdroják</a> written by <a href="https://www.jantichy.cz">Jan Tichy</a>. It could give me great insights, but it was about Doctrine 2-beta. I closed it.</p>
<h3 id="What-to-put-in-the-list">What to put in the list?</h3>
<p>I've decided to focus on sources released in that year. When articles and Doctrine version are the same - Doctrine 2.4 - it will be great source to learn from.</p>
<p>Idea was good, <a href="https://github.com/biberlabs/awesome-doctrine">List</a> was done. I was happy until...</p>
<h3 id="Doctrine-2-5-was-out">...Doctrine 2.5 was out!</h3>
<p>So now each of the 20 sources on the list got a bit deprecated.</p>
<p>Oh, so that's why nobody made it in the first place :).</p>
<p>Now I also understand why many programmers hate new versions of software and want to stick with version they already know. It makes sense in such conditions.</p>
<h2 id="and-quot-Awesome-Symfony-and-quot">&quot;Awesome Symfony&quot;</h2>
<p>Before I realized it makes no sense to make a list of sources, because next year I could drop most of them, I make <a href="https://github.com/Pehapkari/awesome-symfony-education">Awesome list for Symfony</a>.</p>
<p>New Symfony version is released every single year, so the list is even more outdated than Doctrine.</p>
<p><strong>So what this leads to?</strong></p>
<h2 id="Running-in-Circles">Running in Circles</h2>
<p>If I get back to the <strong>useful source</strong> idea from the beginning.</p>
<ul>
<li><strong>are up-to-date with modern technology</strong></li>
<li><strong>are the best in the field</strong></li>
<li><strong>are easy to learn by beginners</strong></li>
</ul>
<p>To make this happen, I would have to create &quot;Awesome * List&quot; every year.
To make that happen, each article would have to be checked for compatibility with each new version and updated if needed.</p>
<p>That would mean around 50 articles on Doctrine every year. <strong>And all this work just to keep status quo</strong>. In big communities like Symfony and Laravel, this happens, but I still consider it too much wasted work (constructive ideas coming bellow).</p>
<p>So sources are useful upon their release but become more and more outdated every year. Writing article in such environment would be as useless as writing 100% test coverage for Christmas campaign microsite.</p>
<p>Thus, motivation to write software article is getting low, even when software is being released. - I call this <em>Know How Sharing Lag</em>.</p>
<h2 id="This-Sounds-like-Legacy-Code">This Sounds like Legacy Code</h2>
<p>Let's say we have application with legacy code. It brings me money and I want to keep it alive and growing as long as possible.</p>
<p>...</p>
<p>Mm, I should write tests and start refactoring?</p>
<p>Could this be possible to integrate into a blog or website?</p>
<h3 id="Dream-Big">Dream Big</h3>
<p>It would have to be:</p>
<ul>
<li><strong>integrated in blog</strong>, because another external source would deprecate - thanks Statie</li>
<li><strong>composer supported</strong> - thanks Github Pages and Travis</li>
<li><strong>open-source hosted</strong>, so the author won't burn out on yearly fixes - thanks Github Pages</li>
<li><strong>CI supported</strong> - thanks Travis</li>
<li><strong>tested daily</strong> - thanks Travis Cron Jobs (Beta)</li>
</ul>
<p>This idea was created in late 2015 with no solution ahead. I want to thank <a href="https://twitter.com/enumag">Jáchym Toušek</a> for consulting this idea and making <a href="https://github.com/enumag/enumag.cz/commit/3efc82717b9965bb19a2609e4caddc0c5467552d">the first prototype</a>.</p>
<p>And that's why and how <em>tested articles</em> were born.</p>
<p><br></p>
<p><strong>How does tested article look like?</strong> <a href="https://github.com/TomasVotruba/tomasvotruba.com/blob/8c68d0fcb64a73fb71f157452288711219501763/packages/blog/tests/Posts/Year2019/SymfonyConsole/HashPasswordCommandTest.php">See <code>HashPasswordCommandTest.php</code></a>. It will last for years, will work on Symfony 4, 5, 6... 42.</p>
<p><strong>Feel free to send one.</strong> We'll make sure it will make it into 2018 and beyond.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/09/16/why-software-articles-must-be-ci-tested</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 16 Sep 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/09/16/why-software-articles-must-be-ci-tested#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How we Upgraded Pehapkari.cz from Symfony 4 to 5 in 25 days ]]></title>
                <link>https://tomasvotruba.com/blog/2019/09/09/how-we-upgraded-pehapkari-cz-from-symfony-4-to-5-in-25-days</link>
                <description><![CDATA[ <p>A month ago, Symfony 5 has been released. Upgrading of such a small web as our community website <strong>must be easy</strong>, right?
<br>
<br>
Well, that's what we thought. <strong>Were we right or wrong?</strong></p> ]]></description>
                <content:encoded><![CDATA[ <p>This post is based on the real problems we faced when we upgraded our website. <strong>It is full of experience</strong> with pieces of explanation, real code snippets in diffs, painful frustration of Symfony ecosystem and bright light at the end of the tunnel.</p>
<p><br></p>
<p>Are you ready? Let's dive in ↓</p>
<p><br></p>
<h2 id="1-Easy-picks">1. Easy picks</h2>
<h3 id="Twig-2-3">Twig 2 → 3</h3>
<p>Before, you could connect <code>for</code> with <code>if</code> like this:</p>
<pre><code class="language-twig">{% for post in posts if post.isPublic() %}
    {{ post.title }}
{% endfor %}</code></pre>
<p>Now <a href="https://twig.symfony.com/doc/3.x/filters/filter.html">the <code>filter</code></a> has to be used:</p>
<pre><code class="language-twig">{% for post in posts|filter(post =&gt; post.isPublic()) %}
    {{ post.title }}
{% endfor %}</code></pre>
<p><em>Thanks <a href="https://www.reddit.com/r/PHP/comments/ef2nit/how_we_upgraded_pehapkaricz_from_symfony_4_to_5/fbzyhsl">Patrik for the tip</a></em></p>
<h2 id="2-Rector-Helps-You-with-PHP">2. Rector Helps You with PHP</h2>
<p>Do you want to know, what is needed for the upgrade to Symfony 5? <a href="https://github.com/symfony/symfony/blob/5.0/UPGRADE-5.0.md">Just read upgrade notes</a> in Symfony repository.</p>
<ol>
<li>For PHP stuff, use <a href="https://github.com/rectorphp/rector">Rector</a>:</li>
</ol>
<pre><code class="language-bash"># install Rector
composer require rector/rector --dev

# or in case of conflicts
composer require rector/rector-prefixed --dev</code></pre>
<p>Rector has minimal sets, meaning each minor version is standalone and independent.
What does that mean? For upgrading from Symfony 4 to 5, you need to <strong>run all the minor version sets</strong>, one by one.</p>
<ol start="2">
<li>Update <code>rector.php</code> config</li>
</ol>
<pre><code class="language-php">use Rector\Symfony\Set\SymfonySetList;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;import(SymfonySetList::SYMFONY_41);

    // take it 1 set at a time, so next set works with output of the previous set; I do 1 set per pull-request
    // $rectorConfig-&gt;import(SymfonySetList::SYMFONY_42);
    // $rectorConfig-&gt;import(SymfonySetList::SYMFONY_43);
    // $rectorConfig-&gt;import(SymfonySetList::SYMFONY_44);
    // $rectorConfig-&gt;import(SymfonySetList::SYMFONY_50);
};</code></pre>
<ol start="3">
<li>Run Rector</li>
</ol>
<pre><code class="language-bash">vendor/bin/rector process app src tests</code></pre>
<p>Verify, check that CI passes and then continue with next Symfony minor version.</p>
<h2 id="3-Update-composer-json-before-composer-update">3. Update <code>composer.json</code> before <code>composer update</code></h2>
<h3 id="Easy-Admin-Bundle">Easy Admin Bundle</h3>
<pre><code class="language-diff"> {
     "require": {
-        "alterphp/easyadmin-extension-bundle": "^2.1",
+        "alterphp/easyadmin-extension-bundle": "^3.0",
    }
}</code></pre>
<h3 id="Doctrine">Doctrine</h3>
<pre><code class="language-diff"> {
     "require": {
-        "doctrine/cache": "^1.8",
+        "doctrine/cache": "^1.10",
-        "doctrine/doctrine-bundle": "^1.11",
+        "doctrine/doctrine-bundle": "^2.0",
-        "doctrine/orm": "^2.6",
+        "doctrine/orm": "^2.7",
     }
 }</code></pre>
<h3 id="Doctrine-Behaviors">Doctrine Behaviors</h3>
<pre><code class="language-diff"> {
     "require": {
-        "stof/doctrine-extensions-bundle": "^1.3",
-        "knplabs/doctrine-behaviors": "^1.6"
+        "knplabs/doctrine-behaviors": "^2.0"
     }
 }</code></pre>
<h3 id="Sentry">Sentry</h3>
<pre><code class="language-diff"> {
     "require": {
-        "sentry/sentry-symfony": "^3.2",
+        "sentry/sentry-symfony": "^3.4",
     }
 }</code></pre>
<h3 id="Twig-Extensions-were-Removed">Twig Extensions were Removed</h3>
<pre><code class="language-diff"> {
     "require": {
-        "twig/extensions": "^1.5"
     }
 }</code></pre>
<p>This might be scary at first, depends on how many of those functions have you used.</p>
<p>Look at the <a href="https://github.com/twigphp/Twig-extensions">README on Github</a> to find out more:</p>
<div class="text-center">
    <img src="/assets/images/posts/2019/symfony5_twig_extension_readme.png" class="img-thumbnail">
</div>
<h2 id="4-Symfony-Packages-in-composer-json">4. Symfony Packages in <code>composer.json</code></h2>
<p>Do you use Flex and config <code>*</code> version?</p>
<pre><code class="language-json">{
    "require": {
        "symfony/console": "*",
        "symfony/event-disptacher": "*"
    },
    "extra": {
        "symfony": {
            "require": "^4.4"
        }
    }
}</code></pre>
<p>Not sure why, but in some cases, it failed and <strong>blocked from the upgrading</strong>. <strong>I had to switch to explicit version per package, to resolve it:</strong></p>
<pre><code class="language-diff"> {
     "require": {
-        "symfony/console": "*",
+        "symfony/console": "^4.4",
-        "symfony/event-disptacher": "*"
+        "symfony/event-disptacher": "^4.4"
-    },
+    }
-    "extra": {
-        "symfony": {
-            "require": "^4.4"
-        }
-    }
 }</code></pre>
<p>Then switch to Symfony 5:</p>
<pre><code class="language-diff">-"symfony/asset": "^4.4",
+"symfony/asset": "^5.0",
-"symfony/console": "^4.4",
+"symfony/console": "^5.0",

// etc.</code></pre>
<p>But some packages are released out of <a href="/blog/2019/10/28/all-you-always-wanted-to-know-about-monorepo-but-were-afraid-to-ask/">monorepo cycle</a>:</p>
<pre><code class="language-diff">-"symfony/maker-bundle": "^1.14",
+"symfony/maker-bundle": "^1.13",</code></pre>
<p>All right, now you run...</p>
<pre><code class="language-bash">composer update</code></pre>
<p>...and get new packages with Symfony 5... or probably a lot of composer version conflicts.</p>
<h3 id="Symfony-Packages-WTFs-in">Symfony Packages WTFs in</h3>
<p>In Symfony 5, some packages were <strong>removed</strong>:</p>
<pre><code class="language-diff">-"symfony/error-renderer": "^4.4",</code></pre>
<pre><code class="language-diff">-"symfony/web-server-bundle": "^4.4",</code></pre>
<p><br></p>
<p>Some packages were <strong>replaced by new ones</strong>:</p>
<pre><code class="language-diff">-"symfony/error-debug": "^4.4",
+"symfony/error-handler": "^5.0",</code></pre>
<p><br></p>
<p>And some package <strong>were split into more smaller ones</strong>:</p>
<pre><code class="language-diff">-"symfony/security": "^4.4",
+"symfony/security-core": "^5.0",
+"symfony/security-http": "^5.0",
+"symfony/security-csrf": "^5.0",
+"symfony/security-guard": "^5.0",</code></pre>
<h2 id="5-Rector-ECS-and-PHPStan">5. Rector, ECS, and PHPStan</h2>
<p>These were production dependencies, but what about dev ones?
Both have the same rules - they need to allow Symfony 5 installation.</p>
<p>The safest way is to use <a href="https://github.com/rectorphp/rector/issues/177">prefixed versions</a>, which don't care about a Symfony version:</p>
<pre><code class="language-diff">-"phpstan/phpstan": "^0.11",
+"phpstan/phpstan": "^0.12",
-"rector/rector": "^0.5",
+"rector/rector-prefixed": "^0.6",</code></pre>
<p><a href="https://github.com/symplify/easy-coding-standard">Easy Coding Standard</a>:</p>
<pre><code class="language-diff">-"symplify/easy-coding-standard": "^0.11",
+"symplify/easy-coding-standard": "^0.12",</code></pre>
<p><br></p>
<p>Update your <code>composer.json</code> to include a package that you need.</p>
<p>Then run:</p>
<pre><code class="language-bash">composer update</code></pre>
<p>Still conflicts?</p>
<h2 id="6-And-The-Biggest-Symfony-Upgrade-Blocker-is">6. And The Biggest Symfony Upgrade Blocker is...</h2>
<p>If you don't do open-source, you probably don't use the <code>git tag</code> feature. It seems that the tagging of a package is a very difficult process. Even packages with million downloads/month had the latest 15 months ago.</p>
<h3 id="What-are-Tags-For">What are Tags For?</h3>
<p>Let's say you want to use <code>symplify/easy-coding-standard</code> that supports Symfony 5. Here is the deal:</p>
<ul>
<li>the latest <code>symplify/easy-coding-standard</code> version 6 doesn't support it</li>
<li><code>symplify/easy-coding-standard</code> dev-master (~= what you see on GitHub) supports it</li>
<li>but it's not tagged yet and composer forbids to install dev version; e.g. <a href="https://github.com/getsentry/sentry-symfony">sentry-symfony</a> at time of writing this post</li>
<li>so you'd have to require its dev version and force composer to install it</li>
</ul>
<pre><code class="language-json">{
    "require-dev": {
        "symplify/easy-coding-standard": "dev-master"
    },
    "prefer-stable": true,
    "minimum-stability": "dev"
}</code></pre>
<ul>
<li>it's a hackish solution, but it <em>somehow</em> works</li>
</ul>
<p>Now imagine one of your package you require requires some other package, that requires another package, that doesn't allow Symfony 5 in tagged version, but in <code>master</code>. Well, you've just finished.</p>
<p>That's why it's very important to know to tag a package regularly:</p>
<pre><code class="language-bash">git tag v2.0.0
git push --tags</code></pre>
<p>That's all! Still, many packages support Symfony 5 in the master but are not tagged yet... to be true, not once for the last 2 years. Why? <strong>The human factor</strong>, maintainers are afraid of negative feedback, of back-compatibility breaks, lack of test coverage takes their confidence, etc.</p>
<h2 id="Tagging-Cancer-of-PHP-Ecosystem">Tagging Cancer of PHP Ecosystem</h2>
<p>These packages block Symfony 5 upgrade for months:</p>
<ul>
<li><a href="https://github.com/stof/StofDoctrineExtensionsBundle/releases">stof/gedmo extension</a> (last release in 2017)</li>
<li><a href="https://github.com/KnpLabs/DoctrineBehaviors/releases">knplabs/doctrine-behaviors</a> (last stable release in 2018)</li>
<li><a href="https://github.com/Behat/Transliterator/releases">behat/transliterator</a> (last release in 2017) - this <a href="https://github.com/Behat/Transliterator/pull/29#issuecomment-567873541">comment sums it up very nicely</a></li>
</ul>
<div class="text-center">
    <img src="/assets/images/posts/2019/symfony5_nice_comment.png">
</div>
<h3 id="United-We-Stand">United We Stand</h3>
<p>This will be resolved in the future by an open-source monorepo approach, but we're not there yet.</p>
<p>In the meantime, please <strong>complain at issues</strong>, ask for help and <strong>offer to become maintainer</strong> until it changes (or until somebody forks it and tags the fork).</p>
<p>One good example for all - I complained and offered help at <code>knplabs/doctrine-behaviors</code>, got maintainer rights in 3 hours and <a href="https://github.com/KnpLabs/DoctrineBehaviors/pulse/monthly">made + merged 30 pull-request in the last month</a>.</p>
<p>You see, it works :)</p>
<h2 id="7-Still-Conflicts">7. Still Conflicts?</h2>
<p>Ok, so you have the right version of packages, everything is stable and allows Symfony 5. Yet still, the composer says &quot;conflicts, cannot install x/y&quot;.</p>
<p>To my surprise, the composer is very bad at solving complex conflicts. Composer <strong>reports false positive and blocks your install</strong>, because of installing packages in <code>/vendor</code> or overly strict <code>composer.lock</code>. I spent 30-60 minutes trying to figure out what the heck is conflicting on every Symfony training I had in the last 2 months. Now I'm able to do it in 3 minutes.</p>
<p><strong>How?</strong></p>
<ul>
<li>remove <code>/vendor</code></li>
<li>remove <code>composer.lock</code></li>
<li>run <code>composer update</code></li>
</ul>
<p>It works so well I do it more often than resolving conflicts manually.</p>
<h2 id="8-Cleanup-bundles-php">8. Cleanup <code>bundles.php</code></h2>
<ul>
<li>Doctrine Cache was only <a href="https://github.com/doctrine/DoctrineCacheBundle/releases/tag/1.4.0">released for Symfony 4.4 and is not supported for any further version</a>.</li>
</ul>
<pre><code class="language-diff"> return [
-    Doctrine\Bundle\DoctrineCacheBundle\DoctrineCacheBundle::class =&gt; ['all' =&gt; true],
 ];</code></pre>
<p>Switch the dead gedmo/stof doctrine extensions for the maintained <a href="https://github.com/KnpLabs/DoctrineBehaviors">KnpLabs/DoctrineBehaviors</a>. I'll write a standalone post about this migration, once a stable version is out (check me, pls :)).</p>
<pre><code class="language-diff"> return [
-    Stof\DoctrineExtensionsBundle\StofDoctrineExtensionsBundle::class =&gt; ['all' =&gt; true],
 ];</code></pre>
<p>We also had some troubles with Switfmailer Bundle:</p>
<pre><code class="language-diff"> return [
-    Symfony\Bundle\SwiftmailerBundle\SwiftmailerBundle::class =&gt; ['all' =&gt; true],
 ]</code></pre>
<p>The <a href="https://symfony.com/blog/new-in-symfony-4-3-mailer-component">Mailer component</a> will take over Swiftmailer in the future, so this is just a start.</p>
<h2 id="9-Clear-config-packages">9. Clear <code>config/packages</code></h2>
<pre><code class="language-diff"> # config/packages/framework.yaml
 framework:
     ...
-    templating:
-        engines: ["twig"]</code></pre>
<p>Don't forget to remove all extension configs. In our case it was:</p>
<pre><code class="language-diff">-config/packages/stof_doctrine_extensions.yaml
-config/packages/swiftmailer.yaml
-config/packages/dev/swiftmailer.yaml
-config/packages/test/swiftmailer.yaml
-config/packages/twig_extensions.yaml
-config/routes/dev/twig.yaml</code></pre>
<p>Small update of the EasyAdmin bundle:</p>
<pre><code class="language-diff"> # config/routes/easy_admin.yaml
 easy_admin_bundle:
-    resource: '@EasyAdminBundle/Controller/AdminController.php'
+    resource: '@EasyAdminBundle/Controller/EasyAdminController.php'</code></pre>
<blockquote class="blockquote text-center">
    And that's all folks!<br>
    Got any questions?
</blockquote>
<div class="text-center">
    All the know-how is taken from practical pull-request, that was under strict Travis control:

    <br>
    <img src="/assets/images/posts/2019/symfony5_pr.png" class="img-thumbnail">
    <br>

    Feel free to explore it, ask, read comments or share your problems.
    <br>

    <a href="https://github.com/pehapkari/pehapkari.cz/pull/243/files" class="btn btn-dark mb-5 mt-3">
        Check the PR on Github
    </a>
</div>
<p><br></p>
<h2 id="Have-we-Missed-Something">Have we Missed Something?</h2>
<p>Of course, we did! Every application has a different set of <em>blocking</em> dependencies and different sets of used Symfony features that might have changed.</p>
<p>Share your issues in comments or edit this post on Github to make list complete!</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/09/09/how-we-upgraded-pehapkari-cz-from-symfony-4-to-5-in-25-days</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 09 Sep 2019 00:00:00 +0000</pubDate>
                                    <updated>2020-11-01UTC00:00:000</updated>
                    <atom:updated>Sun, 01 Nov 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sun, 01 Nov 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/09/09/how-we-upgraded-pehapkari-cz-from-symfony-4-to-5-in-25-days#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Speedup Test Coverage on Travis by 95 % ]]></title>
                <link>https://tomasvotruba.com/blog/2019/09/02/how-to-speedup-test-coverage-on-travis-by-95-percent</link>
                <description><![CDATA[ <p>It was late in the night. He was looking at CI builds to make sure everything is ready for a morning presentation.
<br>
<br>
<strong>The build took over 45 minutes</strong>. What was wrong? He was scared, took a deep breath, and looked at Travis build detail anyway.
<br>
<br>
&quot;What? Code coverage? All the stress for this?&quot;
<br>
<strong>&quot;We should remove it,&quot;</strong> he thought, &quot;CI should give fast feedback... or is there another way?&quot;</p> ]]></description>
                <content:encoded><![CDATA[ <p>Do you find this story resembling your daily job? We had the same problem. We tolerated for 2 years, but in 2020 we looked for a better way.</p>
<img src="/assets/images/posts/2019/faster-coverage/coverage_slow.png">
<h2 id="Status-Quo-Xdebug">Status Quo: Xdebug</h2>
<p>The most common way in the open-source nowadays is Xdebug with Coveralls. <a href="http://coveralls.io">Coveralls.io</a> is an open-source, free service, that consumes your PHPUnit coverage data, and turns them into one significant number.</p>
<p>That's how can have sexy coverage badge in your repository:</p>
<img src="https://img.shields.io/coveralls/symplify/symplify/master.svg?style=flat-square">
<p>How do we make it happen on Travis?</p>
<pre><code class="language-yaml">script:
    - vendor/bin/phpunit --coverage-clover coverage.xml</code></pre>
<p>In the job context:</p>
<pre><code class="language-yaml"># .travis.yml
jobs:
    include:
        -
            stage: coverage
            php: 7.3
            name: Test Coverage
            script:
                - vendor/bin/phpunit --coverage-clover coverage.xml
                # Coveralls.io
                - wget https://github.com/php-coveralls/php-coveralls/releases/download/v2.1.0/php-coveralls.phar
                - php php-coveralls.phar --verbose</code></pre>
<h2 id="2-Faster-with-phpdbg">2. Faster with phpdbg</h2>
<p>I've learned about phpdbg from this <a href="https://kizu514.com/blog/phpdbg-is-much-faster-than-xdebug-for-code-coverage">short and clear post by KIZU 514</a>.</p>
<p>One-line, no-install setup:</p>
<pre><code class="language-yaml">script:
    - phpdbg -qrr -d memory_limit=-1 vendor/bin/phpunit --coverage-clover coverage.xml</code></pre>
<p>In full job:</p>
<pre><code class="language-yaml"># .travis.yml
jobs:
    include:
        -
            stage: coverage
            php: 7.3
            name: Test Coverage
            script:
                - phpdbg -qrr -d memory_limit=-1 vendor/bin/phpunit --coverage-clover coverage.xml
                # Coveralls.io
                - wget https://github.com/php-coveralls/php-coveralls/releases/download/v2.1.0/php-coveralls.phar
                - php php-coveralls.phar --verbose</code></pre>
<p><strong>Mind the <code>-d memory_limit=-1</code>.</strong> The memory was exhausted very soon. We would care if this was a production code. But CI is build, run and throw away container, so allowing unlimited memory is ok.</p>
<h2 id="3-Even-Faster-with-PCOV">3. Even Faster with PCOV</h2>
<p>It's better to have PHPUnit 8+, but what if <a href="/blog/2019/11/04/still-on-phpunit-4-come-to-phpunit-8-together-in-a-day/">don't have it yet</a>? You can <a href="https://kizu514.com/blog/pcov-is-better-than-phpdbg-and-xdebug-for-code-coverage">read about PCOV here</a>, we'll get right to the business.</p>
<p>2-lines run with setup:</p>
<pre><code class="language-yaml">script:
    - pecl install pcov
    - vendor/bin/phpunit --coverage-clover coverage.xml</code></pre>
<p>In jobs context:</p>
<pre><code class="language-yaml"># .travis.yml
jobs:
    include:
        -
            stage: coverage
            php: 7.3
            name: Test Coverage
            script:
                - pecl install pcov
                - vendor/bin/phpunit --coverage-clover coverage.xml
                # Coveralls.io
                - wget https://github.com/php-coveralls/php-coveralls/releases/download/v2.1.0/php-coveralls.phar
                - php php-coveralls.phar --verbose</code></pre>
<p><strong>PCOV took only 1,5 minutes</strong>, that's great!</p>
<p>The coverage number changed from 77 % to 73 %. However, <a href="https://github.com/krakjoe/pcov#differences-in-reporting">PCOV provides the higher accuracy than phpdbg</a> which cannot correctly detect implicit return paths.</p>
<h2 id="Final-Results">Final Results</h2>
<ul>
<li>Xdebug - 37 minutes, 77,5 % code coverage</li>
<li>phpdbg - 3 minutes, 77,1 % code coverage</li>
<li>pcov - 1,5 minutes, 73 % code coverage</li>
</ul>
<p>...and the winner is:</p>
<p><br></p>
<p><strong>PCOV</strong> 🎉</p>
<p><br></p>
<p>It was the fastest one, while also providing code analysis similar to the mainstream Xdebug.</p>
<p><br></p>
<p>But that was <em>our specific</em> codebase. Be sure to try option 2. and 3. on your code, in one PR, to see <strong>what suits you</strong>.</p>
<h2 id="The-Future">The Future?</h2>
<p>Derrick, the Xdebug author, <a href="https://derickrethans.nl/crafty-code-coverage.html">wrote about Xdebug 2.9</a> that should speed up 22 mins build into <strong>1.2 min</strong>.</p>
<p>It <a href="https://travis-ci.community/t/new-faster-xdebug-2-9-is-out/6372">might take some time to get it on Travis</a>, which has nov Xdebug 2.7.</p>
<p>We'll see :)</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/09/02/how-to-speedup-test-coverage-on-travis-by-95-percent</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 02 Sep 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/09/02/how-to-speedup-test-coverage-on-travis-by-95-percent#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How we Migrated 54 357-lines Application from Nette to Symfony in 2 People under 80 Hours ]]></title>
                <link>https://tomasvotruba.com/blog/2019/08/26/how-we-migrated-54-357-lines-of-code-nette-to-symfony-in-2-people-under-80-hours</link>
                <description><![CDATA[ <p>It would take us <strong>3 full-time months</strong> to rewrite this code in 2017. In February 2019, we did it <strong>in less than 3 weeks</strong> with the help of automated tools. Why and how?</p> ]]></description>
                <content:encoded><![CDATA[ <p><em>Similar post was originally published <a href="https://www.zdrojak.cz/clanky/50k-radku-z-nette-do-symfony">in Czech on Zdrojak.cz</a>, where it got colossal attention of the PHP community and hit a record of 56 comments. But when I talk about this migration with my English speaking PHP friends, it seems crazy to them, and they want to hear details - who, how, when, what exactly?</em></p>
<p><em>This post is for you (and for you of course, if you haven't read it on Zdroják).</em></p>
<div class="text-center">
<img src="/assets/images/posts/2019/fw-migration/nette-to-symfony.png">
</div>
<h2 id="What-Have-We-Migrated">What Have We Migrated?</h2>
<p>Backend of <a href="https://entry.do">Entry.do</a> project - API application built on controllers, routing, Kdyby integrations of Symfony, Doctrine, and a few Latte templates. The application has been running in production for the last 4 years. We migrated from Nette 2.4 to Symfony&nbsp;4.2.</p>
<p>How big is it? If we don't count tests, migration, fixtures, etc., the application has <strong>270 PHP files</strong> in the length of <strong>54 357 lines</strong> (using <a href="https://github.com/sebastianbergmann/phploc">phploc</a>).</p>
<p>How many unique routes does it have? 20...? 50...? <strong>151!</strong>
Just to have an idea, the pehapkari.cz website has 35 routes.</p>
<h2 id="Why">Why?</h2>
<p>The application used framework Nette, which worked and met the technical requirements. The primary motivation for the transcription was the dying ecosystem and the over-integration of Symfony. What does the &quot;dying ecosystem&quot; mean? Nette released just 1 minor version since July 2016, while Symfony had 6 releases during the same period.</p>
<div class="text-center mb-4">
    <img src="/assets/images/posts/2019/fw-migration/extensions.png">
    <br>
    80% of the extensions are just glue integrations of Symfony and Doctrine
</div>
<div class="text-center mb-4">
    <img src="/assets/images/posts/2019/fw-migration/nette-symfony.png">
    <br>
    Nette was just Controllers, Routing and Dependency-Injection
</div>
<p>Why use unmaintained integrations of <a href="https://github.com/kdyby">Kdyby</a> and <a href="https://github.com/zenify">Zenify</a>, that only integrate Symfony to Nette\DI, if Symfony is already there? The last new minor version of Nette was published 3 years ago. Symfony releases a new minor version every 6 months with new features that will make your work easier.</p>
<h2 id="How">How?</h2>
<p>I offered <a href="https://janmikes.cz">Honza Mikes</a> deal he couldn't refuse:</p>
<blockquote class="blockquote text-center">
"We will give it a week, and if we get stuck, we'll give up".
</blockquote>
<p>On January 27th, we met with his Nette application, and on February 13th, the Symfony application went to the staging server. <strong>In less than 17 days, we finished migration</strong>, and on February 14th, we celebrated a new production application in addition to Valentine's Day.</p>
<div class="text-center mb-4">
<img src="/assets/images/posts/2019/fw-migration/pull-request.png" class="img-thumbnail">
<p>The final size of migration pull-request</p>
</div>
<p>We talked about migration at the beginning of 2017 because the Nette ecosystem wasn't developing, and Symfony was technologically skipping it. At that time, however, the transition would last at least 80-90 days for full-time, which is insane, so we didn't go into it.</p>
<p><div class="card ml-4 mt-4 border-warning float-right post-snippet" style="width: 14em">
    <div class="card-body">
        Would you like to <strong>learn more about Rector</strong>? Step by step, from zero to hero?
        <br>

        <div class="text-center">
            <a href="/book/the-power-of-automated-refactoring/">
                <img src="/assets/images/rector_book.png" class="mb-3 mt-3 shadow">
                Get our new book
            </a>
        </div>
    </div>
</div>
</p>
<h2 id="Tool-Set">Tool Set</h2>
<p>In 2019 we already had a <strong>lot of tools to do the work for you</strong>:</p>
<ul>
<li>
<p>The first is <a href="https://github.com/rectorphp/rector">Rector</a>, a tool I made that can change any code that runs at least on PHP 5.3 from pattern A to pattern B. It can instantly update the code from PHP 5.3, 5.4, 5.5, 5.6... to 7.4, Symfony from 2.8 to 4.2, Laravel from static code to constructor injection, and more. You can add your own rules tailored to migrate your specific code, that can handle anything that PHP programmer can do (A → B) in a fraction of the time.</p>
</li>
<li>
<p>The second is <a href="https://github.com/symplify/neon-to-yaml-converter">NeonToYamlConverter</a> - as you can guess, it converts NEON syntax to YAML</p>
</li>
<li>
<p>The third assistant is <a href="https://github.com/symplify/latte-to-twig-converter">LatteToTwigConverter</a> - it migrates Latte files to TWIG syntax</p>
</li>
</ul>
<p>During those <strong>17 days, we put in 80 hours of work</strong> for both of us together (= 40 hours each).</p>
<h2 id="20-of-Good-Old-Manual-Work">20 % of Good Old Manual Work</h2>
<p>Although we do not like it, we had to do 20 % of the migration manually.</p>
<p>One of the first steps was to move from <a href="/blog/2019/02/14/why-config-coding-sucks/">config programming to PHP programming</a>. Both frameworks try to promote their sugar syntax for Neon or YAML. It sounds cool to new programmers to write less code. Still, it's confusing, framework-specific, can be done in plain PHP anyway, and most importantly, static analysis and instant refactoring won't deal with it.</p>
<p>How does &quot;config programming&quot; look like?</p>
<pre><code class="language-yaml">services:
    - FirstService(@secondService::someMethod())</code></pre>
<p>Or also:</p>
<pre><code class="language-yaml">services:
    -
        class: 'Entrydo\Infrastructure\Payment\GoPay\NotifyUrlFactory'
        arguments:
            - '@http.request::getUrl()::getHostUrl()'</code></pre>
<p>What typical PHP pattern, that is framework-agnostic and almost everyone knows, can we use?</p>
<p>Factory!</p>
<pre><code class="language-php">&lt;?php

final class FirstServiceFactory
{
    /**
     * @var SecondService
     */
    private $secondService;

    public function __construct(SecondService $secondService)
    {
        $this-&gt;secondService = $secondService;
    }

    public function create()
    {
        return new SomeService($this-&gt;secondService);
    }
}</code></pre>
<h3 id="What-did-we-Gained-with-This-Refactoring">What did we Gained with This Refactoring?</h3>
<ul>
<li>Constructor injection!</li>
<li>Framework independence - when we migrate to another framework or pattern in 3 years, we don't have to deal with this file anymore.</li>
<li>Static analysis works</li>
<li>More testable code, thanks to PHP code instead of config</li>
<li>PHPStorm refactoring works</li>
<li>Rector works</li>
<li>It's a clear PHP code</li>
</ul>
<p><br></p>
<p>In Nette and Symfony, several things were different:</p>
<ul>
<li>ErrorPresenter → <a href="https://symfony.com/doc/current/event_dispatcher.html%23creating-an-event-subscriber">ExceptionSubscriber</a></li>
<li>Use <a href="https://symfony.com/doc/current/testing.html">SymfonyTestBundle</a> for tests</li>
<li>Moving Files to <a href="http://fabien.potencier.org/symfony4-directory-structure.html">Symfony 4 Single-Level Structure</a></li>
<li>Exchange of services in mock tests</li>
<li>In Nette, there is a Request/Response service, but in Symfony, it's an object</li>
<li>Rewrite extension configs to Flex configs</li>
</ul>
<h2 id="80-of-Work-Automated">80 % of Work Automated</h2>
<p>Automatic tools did another 80% of the pull-request you saw above. The first one was enough to write, the other one to set it up.</p>
<h2 id="Neon-to-YAML">Neon to YAML</h2>
<p>Neon and YAML are de facto fields <a href="/blog/2018/03/12/neon-vs-yaml-and-how-to-migrate-between-them/">with minor differences in syntax</a>, but when it comes to services, each framework writes a little differently. Config with services had 316 lines in the services section. You don't want to migrate it manually, the Neon entities. Besides, just one error in related migration, and you can do it all over again.</p>
<p>I took few hours and wrote <a href="https://github.com/symplify/neon-to-yaml-converter">Symplify/NeonToYamlConverter</a>. Just pass the path to the <code>*.neon</code> file, and it will convert into a beautiful <code>*.yaml</code> file.</p>
<h2 id="PHP-Migration">PHP Migration</h2>
<p>Again to the factory pattern - there were several custom Response classes in the code that inherited from Nette Response and added extra logic. We could edit them manually, but it was easier to extract them into the factory method:</p>
<pre><code class="language-diff"> &lt;?php

 class SomePresenter
 {
+    /**
+     * @var ResponseFactory
+     */
+    private $responseFactory;
+
+    public function __construct(ResponseFactory $responseFactory)
+    {
+        $this-&gt;responseFactory = $responseFactory;
+    }
+
     public function someAction()
     {
-        return new OKResponse($response);
+        return $this-&gt;responseFactory-&gt;createJsonResponse($response);
     }
 }</code></pre>
<p><a href="https://janmikes.cz">Honza</a> created new <code>NewObjectToFactoryCreateRector</code> rule that handled this.</p>
<h2 id="What-else-was-left">What else was left?</h2>
<ul>
<li>Move the routing from <code>RouterFactory</code> to particular Controller actions</li>
<li>Rename <code>Request</code> and <code>Response</code> classes + including their codes (<code>POST</code>, <code>GET</code>, <code>200</code>...)</li>
<li>Rename classes and methods on <code>Nette\DI\Container</code>, <code>Nette\Configurator</code>, <code>Nette\Application\IPresenter</code> etc,</li>
<li>Changing parent classes on Controllers,</li>
<li>Renaming Controllers to <code>*Controller</code> (they use &quot;Presenter&quot; naming in Nette)</li>
<li>Move namespaces from <code>App\Presenter</code> to <code>App\Controller</code></li>
</ul>
<p>The most changes were in controllers:</p>
<pre><code class="language-diff"> &lt;?php declare (strict_types = 1);

-namespace App\Presenter;
+namespace App\Controller;

-use Nette\Application\AI\Presenter;
+use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
-use Nette\Http\Request;
+use Symfony\Component\HttpFoundation\Request;

-final class SomePresenter extends Presenter
+final class SomeController extends AbstractController
 {
-    public static function someAction()
+    public static function someAction(Request $request)
     {
-        $header = $this-&gt; httpRequest-&gt; getHeader('x');
+        $header = $request-&gt; headers-&gt; get('x');

-        $method = Request::POST;
+        $method = Request::METHOD_HPOST
     }
 }</code></pre>
<h2 id="Syntax-Sugar-Syntax-Hell">Syntax Sugar? Syntax Hell</h2>
<p>For a while, Kdyby\Translation screwed us with &quot;syntax sugar&quot;. In the Nette application, the listing of variables (Tom) worked for us:</p>
<ul>
<li>&quot;Hi, my name is Tom&quot;</li>
</ul>
<p>But in Symfony magically added <code>%%</code>:</p>
<ul>
<li>&quot;Hi, my name is% Tom%&quot;</li>
</ul>
<p>WTF? After 15 minutes we figured it out - Kdyby\Translation wrapped the variable name in &quot;%%&quot; for you - and fixed it:</p>
<pre><code class="language-diff"> &lt;?php

 class SomePresenter
 {
     public function someAction()
     {
         // Kdyby/Translation differnce to native Symfony/Translation
         $this-&gt;translations-&gt;translate('Hi, my name is %name%', [
-            'name' =&gt; 'Tom',
+            '%name%' =&gt; 'Tom'
         ]);
     }
 }</code></pre>
<p>Pretty cool, huh?</p>
<h2 id="Rename-Event-Names">Rename Event Names</h2>
<p>We also cannot forget the rename of events from Contribute\Events to Symfony <a href="https://symfony.com/doc/current/reference/events.html%23kernel-events">KernelEvents</a>:</p>
<div class="text-center">
    <img src="/assets/images/posts/2019/fw-migration/event-rename.png">
</div>
<h2 id="From-RouterFactory-to-Controller-at-Route-annotation">From <code>RouterFactory</code> to Controller <code>@Route</code> annotation</h2>
<p>RouteFactory is <a href="https://github.com/nette/sandbox/blob/06a92123fb6a1d82de38037436ca06484afec8dc/app/Router/RouterFactory.php">single class</a> in Nette to define all routes for all controllers and their actions. In Symfony, this is quite the opposite. You define the routes directly at the Controller action. And to make matters worse, it <a href="https://symfony.com/doc/current/routing.html%23creating-routes">uses annotation</a>.</p>
<p>What with this? Well, one option is to move one route at a time - <strong>all 151</strong>. To make it even more challenging, we had our own <code>RestRoute</code> and our own <code>RouteList</code>, including POST/GET/..., which Nette doesn't have.</p>
<p>How does one change look like?</p>
<pre><code class="language-diff"> &lt;?php

 namespace App;

 use Entrydo\RestRouteList;
 use Entrydo\Restart;

 final class RouterFactory
 {
-    private const PAYMENT_RESPONSE_ROUTE = '/ payment / process';
     // 150 more!

     public function create()
     {
         $router = new RestRouteList();
-        $router[] = RestRoute::get(self::PAYMENT_RESPONSE_ROUTE, ProcessGPWebPayResponsePresenter::class);
          // 150 more!

          return $router;
      }
 }</code></pre>
<pre><code class="language-diff"> namespace App Presenter;

+use Symfony\Component\Routing\Annotation\Route;

 final class ProcessGPWebPayResponsePresenter
 {
+    /**
+     * @Route(path = "/payments/gpwebpay/process-response", methods="GET"})
+     */
     public function __invoke()
     {
         // ...
     }
 }</code></pre>
<p>Now do this 151 times... and make rebase-proof. When we first talked about the migration in 2017, we would make all these changes manually. <strong>Too lazy to work.</strong></p>
<p>And in 2019? For a few days, we were preparing the <code>nette-to-symfony</code> Rector set and then run it on the entire code base:</p>
<pre><code class="language-bash">composer require rector/rector -dev
vendor/bin/rector process app src --level nette-to-symfony</code></pre>
<p>And it is done  :)</p>
<p>Everything we've learned during the 17-day migration is in this set and this post. Just download Rector, and you can use the set straight away.</p>
<p>From Valentine's Day to the nette-to-symfony set, a complete migration from Nette Tester to PHPUnit and the migration of Nette Forms to Symfony Forms and Component to Controllers have been added.</p>
<h2 id="Final-Touches">Final Touches</h2>
<p>After a lot of static content changes, the code worked, and the tests went through, but it looked messy. Spaces were missing, fully qualified class names were not imported, etc.</p>
<p>You can use your own PHP_CodeSniffer and PHP-CS-Fixer set. We used the [Rector-prepared set] with <a href="https://github.com/symplify/easy-coding-standard">ECS</a>:</p>
<pre><code class="language-bash">vendor/bin/ecs check app src --config vendor/rector/rector/ecs-after-rector.php</code></pre>
<h2 id="It-s-not-about-the-Work-It-s-about-the-Knowledge">It's not about the Work, It's about the Knowledge</h2>
<p>And so we migrated a 4-years old Nette application of 54 357 lines under 80 hours to Symfony and put it into production. Most of the time took us debugging events and writing migration rules and tools. Now <strong>the same application would take us (or you) 10 hours top to migrate</strong>.</p>
<p><br></p>
<p>As you can see, any application can be migrated from one framework to another under a month. Dare us!</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/08/26/how-we-migrated-54-357-lines-of-code-nette-to-symfony-in-2-people-under-80-hours</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 26 Aug 2019 00:00:00 +0000</pubDate>
                                    <updated>2020-06-01UTC00:00:000</updated>
                    <atom:updated>Mon, 01 Jun 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Mon, 01 Jun 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/08/26/how-we-migrated-54-357-lines-of-code-nette-to-symfony-in-2-people-under-80-hours#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Do We Have More than 1024 PHP Groups in The World? ]]></title>
                <link>https://tomasvotruba.com/blog/2019/08/19/do-we-have-more-than-1024-php-groups-in-the-world</link>
                <description><![CDATA[ <p>In April 2018, I started a side project to list meetups in Europe near Prague. <strong>PHP meetups are so much fun</strong>, and I didn't find any single-page with a map that would list them. At the start, this site had a small table, with 10 meetups a month, very <em>modern</em> black/white Times New Roman design, and <em>advanced</em> human-manual updating.
<br><br>
Since then, I got feedback from dozens of friends and users with these WTFs and ideas - they helped me add a feature now and then, polish design with emoji and Bootstrap, <strong>automate everything and even crawl over 150 URLs</strong>. I bought <a href="https://friendsofphp.org">friendsofphp.org</a> domain, and the project became a single standalone page.
<br><br>
Today, it's a much bigger project with over...</p> ]]></description>
                <content:encoded><![CDATA[ <p>...well, see for yourself:</p>
<div class="text-center">
    <a href="https://friendsofphp.org/">
        <img src="/assets/images/posts/2019/friends/preview.png">
    </a>
</div>
<blockquote class="blockquote text-center">
    1, 2, 3... <strong>1023 groups</strong>
</blockquote>
<p>I bet there is one group out there that isn't listed yet. It might have a local non-PHP name like &quot;AFUP&quot; community in France.</p>
<p>Whoever finds this group wins🍺!</p>
<h2 id="The-Most-Active-Region">The Most Active Region</h2>
<p>I assumed the Czech Republic or Germany is the most active in Europe. I was wrong! Look at Benelux with <strong>over 20 meetups in a month</strong>!</p>
<p>It would be easy to get lost among all these pins, so we put 2 more colors in.</p>
<div class="text-center">
    <img src="/assets/images/posts/2019/friends/colors-before-after.png" class="img-thumbnail">
    <p>Before → After</p>
    <p>
        Traffic lights to save your eyes:
        <strong>
            <span class="text-success">next 7 days</span>
            | <span class="text-warning">next 14 days</span>
            | <span class="text-danger">next 30 days</span>
        </strong>
    </p>
</div>
<h2 id="6-More-Cool-Features">6 More Cool Features</h2>
<ul>
<li>
<p><strong>Local Storage</strong> - Isn't it annoying to open a map and always see the same location in Europe? What if you're from <em>complete your country</em> and you want to see your local meetups only? We got you covered - your last selected location is stored in your browser ✅</p>
</li>
<li>
<p><strong>Share Your map</strong></p>
<ul>
<li>&quot;Hey John, check these meetups in Berlin...&quot;</li>
<li>&quot;How?&quot;</li>
<li>&quot;You have to zoom to this city and...&quot;</li>
<li>&quot;Where in Germany is it?&quot;</li>
<li>&quot;Oh wait, there is a share button, I'll send you a link.&quot;</li>
<li>&quot;Awesome&quot; ✅</li>
</ul>
</li>
<li>
<p><strong>Locate Yourself</strong> - No need to zoom your country - use your geo-location ✅. Works great on both laptops and smartphones.</p>
</li>
<li>
<p><strong>Mobile Ready</strong> - While you're traveling, you're (on your) mobile, and you need the meetup fast. The site runs on Bootstrap 4.1 and has hours of testing in different continents and poor connections ✅</p>
</li>
<li>
<p><strong>Single Site</strong> - No clicking, no menu. Just map and table ✅</p>
</li>
<li>
<p><strong>Move the Map → Table Filters</strong> - See what you need. As you move to the map, the table will transform - it shows you only meetups visible on the map ✅ . Try F5 - local storage still works.</p>
</li>
</ul>
<p>Any tips? <a href="https://github.com/TomasVotruba/friendsofphp.org/issues">Add new issue</a></p>
<h2 id="How-Does-the-Website-Work">How Does the Website Work?</h2>
<p>Meetups are downloaded every day by Travis CRON job from Meetup.com for each group. You'll find them manually added in <a href="https://github.com/TomasVotruba/friendsofphp.org/blob/master/config/_data/groups.yaml">this YAML file in repository</a>. No surprise <strong>it runs on <a href="https://github.com/symplify/symfony-static-dumper">Symfony Static Dumper</a> and is fully <a href="https://github.com/tomasvotruba/friendsofphp.org">open-sourced on Github</a></strong>.</p>
<p>Although there <a href="https://www.meetup.com/meetup_api">Meetup API</a> often works as documented, it's impossible to find all PHP groups with it. There is an issue <strong>when you search for groups in a specific location, it ignores the area and sets back to your origin city</strong>. Pity, that exactly what we need here.</p>
<h3 id="What-now">What now?</h3>
<p>Maybe instead of API... a <strong>crawler could help</strong> - <a href="https://github.com/meetup/api/issues/249#issuecomment-427548572">and it did</a>:</p>
<pre><code class="language-php">&lt;?php

require __DIR__ . '/vendor/autoload.php';

use Symfony\Component\DomCrawler\Crawler;

// crawling Slovenia here: 'https://www.meetup.com/topics/php/si/'
$code = 'si';

$crawlUrl = 'https://www.meetup.com/topics/php/' . $code;
$crawler = new Crawler(file_get_contents($crawlUrl));

$meetupNames = [];
// headlines of found groups
foreach ($crawler-&gt;filterXPath('//span[@class="text--bold display--block"]') as $node) {
    $meetupNames[] = $node-&gt;textContent;
}

var_dump($meetupNames);</code></pre>
<p>After 4 hours of debugging broken API, I got this solution working in roughly 60 minutes.
Provide a list of codes for all countries in the world, and in a few minutes you have with <strong>800 new PHP groups</strong> ↓</p>
<div class="text-center">
    <img src="/assets/images/posts/2019/friends/groups-before-after.png" class="img-thumbnail">
    <p>Before → After</p>
</div>
<blockquote class="blockquote text-center">
   Lesson learned: use what works.
</blockquote>
<p>Events are stored with their location and rendered to Open Street Maps with fantastic <a href="https://leafletjs.com">Leaflet framework</a>. You don't have to know any Javascript. Documentation is that good.</p>
<h2 id="How-much-Does-it-Cost-to-Travel-abroad-Meetup">How much Does it Cost to Travel abroad Meetup?</h2>
<p>There is <a href="/blog/2018/07/23/5-signs-should-never-have-a-talk-abroad/">plenty of reasons not-to-go</a> visit PHP meetup abroad, but the one I hear the most <strong>are money</strong>.</p>
<p>To give you an idea, here <strong>are costs of my trips from Prague</strong> to cities nearby:</p>
<table class="table table-bordered">
    <thead class="table-inverse">
        <tr>
            <th class="text-center">City</th>
            <th class="text-center">Travel Time</th>
            <th class="text-center">Travel $</th>
            <th class="text-center">Stay $</th>
            <th class="text-center">Total $</th>
        </tr>
    </thead>
    <tr>
        <td><a href="https://www.meetup.com/PHP-USERGROUP-DRESDEN/">Dresden</a></td>
        <td>2 hours</td>
        <td>20 € </td>
        <td>~ <span class="text-muted">(go home the same day)</span></td>
        <td class="text-right"><strong>20 €</strong></td>
    </tr>
    <tr>
        <td><a href="https://www.meetup.com/viennaphp/">Vienna</a></td>
        <td>5 hours</td>
        <td>30 € </td>
        <td>30 € AirBnb / 0 $ friend from meetup</td>
        <td class="text-right"><strong>30-60 €</strong></td>
    </tr>
    <tr>
        <td><a href="https://www.meetup.com/Berlin-PHP-Usergroup/">Berlin</a></td>
        <td>5 hours</td>
        <td>50 €</td>
        <td>40 € AirBnb / 0 $ friend from meetup</td>
        <td class="text-right"><strong>40-90 €</strong></td>
    </tr>
</table>
<p>At the start, I had to pay Airbnb. But when you go to meetups more than once, you'll remember people; they'll remember you, and they're beneficial with your subsequent visits. <strong> ask to stay over for one night on the floor</strong>.</p>
<h3 id="Do-You-Need-Help-With-or-Ask-Where-to-Start">Do You Need Help With $ or Ask Where to Start?</h3>
<p>Let <a href="/contact">me know</a> - I might know a way to help you.</p>
<p><br></p>
<p>That's all, folks. Enjoy your offline PHP friends - <a href="https://friendsofphp.org">friendsofphp.org</a> and have fun!</p>
<p><br></p>
<p>Happy traveling!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/08/19/do-we-have-more-than-1024-php-groups-in-the-world</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 19 Aug 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/08/19/do-we-have-more-than-1024-php-groups-in-the-world#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Standalone Symfony Console from the Scratch ]]></title>
                <link>https://tomasvotruba.com/blog/2019/08/12/standalone-symfony-console-from-scratch</link>
                <description><![CDATA[ <p>Symfony Console is <em>the one</em> package you will use to build a PHP CLI app. It's one of the easiest Symfony components.
<br><br>
Why? You <strong>only create Application class, add 1 Command class, and you are ready to go</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="When-and-amp-Why-use-Symfony-Console">When &amp; Why use Symfony Console?</h2>
<p>This package helps you to create applications like <a href="https://github.com/composer/composer">Composer</a>, <a href="https://github.com/symplify/easy-coding-standard">ECS</a>, <a href="https://github.com/rectorphp/rector">Rector</a> or <a href="https://github.com/symplify/symfony-static-dumper">Symfony Static Dumper</a> that generates this website.</p>
<p>So in general, to build applications where you:</p>
<ul>
<li>need to <strong>access CLI</strong>,</li>
<li>need to <strong>be fast</strong> - imports, CRON jobs, feeds or asynchronous operations</li>
<li>and don't need any browser rendering.</li>
</ul>
<h2 id="2-Classes-to-Learn">2 Classes to Learn</h2>
<ul>
<li><strong>Application</strong> - This is the entry point. It contains all commands and routes arguments to them. Something like Application is in Nette or HttpKernel is in Symfony.</li>
<li><strong> Command</strong> - Handles input data, processes them, and returns the result to the output as the Presenter or Controller does.</li>
</ul>
<p>1 application can have many commands.</p>
<h2 id="What-Belongs-to-Command">What Belongs to Command?</h2>
<p>Before diving into our first Command, there is an essential rule that I want to share with you. In many tutorials, you find business logic inside Commands. That is convenient in the begging, but challenging to unlearn later, building more commands.</p>
<p>When I wrote <em>commands is something like Presenter or Controller</em>, I talked about <a href="/blog/2018/01/08/clean-and-decoupled-controllers-commands-and-event-subscribers-once-and-for-all-with-delegator-pattern/">Delegator Pattern</a>. Like Controller, <strong>it should only delegate arguments to other services and return the result to the output</strong>.</p>
<p>This rule will help you to <strong>avoid</strong>:</p>
<ul>
<li>using Command to run another command</li>
<li>using Command in the Controller</li>
<li>using Controller in Command</li>
</ul>
<p>Very common, very coupled. You would never use the Controller inside another controller, right?</p>
<p><em>Ok, now you know this. So let's create your first Command!</em></p>
<h2 id="Create-First-Command-in-3-Steps">Create First Command in 3 Steps</h2>
<h3 id="1-Install-via-Composer">1. Install via Composer</h3>
<pre><code class="language-bash">composer require symfony/console</code></pre>
<h3 id="2-Create-Console-Application">2. Create Console Application</h3>
<p>Conventional location is <code>bin/console</code> (having <code>.php</code> suffix is also fine):</p>
<pre><code class="language-php">#!/usr/bin/env php
&lt;?php

require_once __DIR__ . '/../vendor/autoload.php';

// Create the Application
$application = new Symfony\Component\Console\Application;

// Run it
$application-&gt;run();</code></pre>
<p>Now we can run the app and see that it's ready:</p>
<pre><code class="language-bash">php bin/console</code></pre>
<p>All good? Good!</p>
<h3 id="3-Create-and-Register-Command">3. Create and Register Command</h3>
<p>Let's create Command that will safely hash any password you enter.</p>
<pre><code class="language-bash">composer require nette/security</code></pre>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

// src/Command/HashPasswordCommand.php

namespace App\Command;

use Nette\Security\Passwords;
use Symfony\Component\Console\Command\Command;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Output\OutputInterface;

final class HashPasswordCommand extends Command
{
    /**
     * In this method setup command, description, and its parameters
     */
    protected function configure()
    {
        $this-&gt;setName('hash-password');
        $this-&gt;setDescription('Hashes provided password with BCRYPT and prints to output.');
        $this-&gt;addArgument('password', InputArgument::REQUIRED, 'Password to be hashed.');
    }

    /**
     * Here all logic happens
     */
    protected function execute(InputInterface $input, OutputInterface $output)
    {
        $password = $input-&gt;getArgument('password');

        $hashedPassword = Passwords::hash($password);

        $output-&gt;writeln(sprintf(
            'Your hashed password is: %s', $hashedPassword
        ));

        // return value is important when using CI, to fail the build when the command fails
        // in case of fail: "return self::FAILURE;"
        return self::SUCCESS;
    }
}</code></pre>
<p>Configure autoloading, add the following to the <code>composer.json</code> file:</p>
<pre><code class="language-json">{
    "autoload": {
        "psr-4": {
            "App\\": "src"
        }
    }
}</code></pre>
<p>Dump the autoloader</p>
<pre><code class="language-bash">composer dump-autoload</code></pre>
<p>And update our <code>bin/console</code> file:</p>
<pre><code class="language-php">#!/usr/bin/env php
&lt;?php

require_once __DIR__ . '/../vendor/autoload.php';

// Create the Application
$application = new Symfony\Component\Console\Application();

// Register all Commands
$application-&gt;add(new App\Command\HashPasswordCommand());

// Run it
$application-&gt;run();</code></pre>
<p>Now you can run it from CLI with your password as an argument:</p>
<pre><code class="language-bash">php bin/console hash-password heslo123
Your hashed password is: $2y$10$NZVuDpvFbqhsBhR1AZZzX.xUHKhr5qtP1qGKjqRM4S9Xakxn1Xgy2</code></pre>
<h2 id="You-Are-One-Step-Further">You Are One Step Further</h2>
<p>Now you should:</p>
<ul>
<li>understand that you need <strong>only 1 class to create simple Command</strong></li>
<li>see <strong>Command like a Controller</strong> and should only delegate business logic, not contain it</li>
<li>know how to <strong>pass argument</strong>, process it and <strong>return result to the output</strong></li>
</ul>
<h3 id="Where-to-go-next">Where to go next?</h3>
<p>Still hungry for knowledge? Check <a href="http://symfony.com/doc/current/components/console.html#learn-more">Symfony documentation</a> then.</p>
<ul>
<li>Do you need to <strong>pass more than 1 value</strong>? E.g. <code>bin/console hash-password mummy123 --cost=14</code>? Go check <a href="http://symfony.com/doc/current/console/input.html#using-command-options">Command Options</a>.</li>
<li>Do you want to <strong>inform users about the progress of slow process</strong>? You are looking for <a href="http://symfony.com/doc/current/components/console/helpers/progressbar.html">Progress Bar Helper</a>.</li>
<li>Do you want to use a popular and pretty Symfony output style (like PHP-CS-Fixer does)? Look at <a href="https://symfony.com/blog/new-in-symfony-2-8-console-style-guide">Console Style Guide</a>.</li>
</ul>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/08/12/standalone-symfony-console-from-scratch</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 12 Aug 2019 00:00:00 +0000</pubDate>
                                    <updated>2020-06-01UTC00:00:000</updated>
                    <atom:updated>Mon, 01 Jun 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Mon, 01 Jun 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/08/12/standalone-symfony-console-from-scratch#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Standalone Symfony Event Dispatcher from the Scratch ]]></title>
                <link>https://tomasvotruba.com/blog/2019/08/05/standalone-symfony-event-dispatcher-from-the-scratch</link>
                <description><![CDATA[ <p>Have you ever used Symfony Event Dispatcher? No?
<br>
<br>
This post is an introduction to Event Dispatcher, how to use it, and in the end, you'll be able to cover 90 % use cases you'll ever need.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="What-is-the-Main-Purpose-of-Event-Dispatcher">What is the Main Purpose of Event Dispatcher?</h2>
<ul>
<li><strong>Extend an application</strong> in a certain place <strong>without putting any code right there</strong>.</li>
</ul>
<p><br></p>
<p>This way, you can extend 3rd party packages without rewriting them. And also allow other users to reach your code without even touching it.</p>
<p>Not sure how that looks? You will - at the end of this article.</p>
<h3 id="Event-Dispatcher">Event Dispatcher</h3>
<p><strong>This is the brain</strong>. It stores all subscribers and calls events when you need to.</p>
<h3 id="Event">Event</h3>
<p><strong>This is the name of a place</strong>. When something has happened in the application: <em>order is sent</em>, or <em>user is deleted</em>.</p>
<h3 id="Event-Subscriber">Event Subscriber</h3>
<p>This is <strong>the action that happens when</strong> we come to a specific event. When an order is sent (= Event), <em>send me a confirmation SMS</em> (= Event Subscriber). And <em>check that all the ordered products are on stock</em>.</p>
<p><strong>1 event can invoke MORE Event Subscribers</strong>.</p>
<h2 id="Create-First-Subscriber-in-3-Steps">Create First Subscriber in 3 Steps</h2>
<h3 id="1-Install-via-Composer">1. Install via Composer</h3>
<pre><code class="language-bash">composer require symfony/event-dispatcher</code></pre>
<h3 id="2-Create-Event-Dispatcher">2. Create Event Dispatcher</h3>
<pre><code class="language-php">// index.php
require_once __DIR__ . '/vendor/autoload.php';

// 1. create the Dispatcher
$eventDispatcher = new Symfony\Component\EventDispatcher\EventDispatcher;

// 2. some event happend, we dispatch it
$eventDispatcher-&gt;dispatch('youtube.newVideoPublished'); // oh: event is just a string</code></pre>
<p>Try it:</p>
<pre><code class="language-bash">php index.php</code></pre>
<p>Wow! Nothing happened...</p>
<p>That's ok because there is no Subscriber. So let's...</p>
<h3 id="3-Create-and-Register-Subscriber">3. Create and Register Subscriber</h3>
<pre><code class="language-php">use Symfony\Component\EventDispatcher\EventSubscriberInterface;

final class NotifyMeOnVideoPublishedEventSubscriber implements EventSubscriberInterface
{
    public bool $isUserNotified = false;

    public static function getSubscribedEvents(): array
    {
        // in format ['event name' =&gt; 'public function name that will be called']
        return ['youtube.newVideoPublished' =&gt; 'notifyUserAboutVideo'];
    }

    public function notifyUserAboutVideo()
    {
        // some logic to send notification
        $this-&gt;isUserNotified = true;
    }
}</code></pre>
<p>Let the Dispatcher know about the Subscriber.</p>
<pre><code class="language-php">$eventDispatcher = new Symfony\Component\EventDispatcher\EventDispatcher;

$eventSubscriber = new NotifyMeOnVideoPublishedEventSubscriber;
$eventDispatcher-&gt;addSubscriber($eventSubscriber);

// nothing happened, default value
var_dump($eventSubscriber-&gt;isUserNotified);
// false

// this calls our Subscriber
$eventDispatcher-&gt;dispatch('youtube.newVideoPublished');

// now it's changed
var_dump($eventSubscriber-&gt;isUserNotified);
// true</code></pre>
<p>Run the code again from command line:</p>
<pre><code class="language-bash">$ php index.php
int(0)
int(1)</code></pre>
<p>And now you understand EventDispatcher. At least in 90 % use cases.</p>
<hr />
<p>Still on? Let's get advanced.</p>
<p>What if we need to get the name of the Youtuber into the Subscriber?</p>
<h2 id="Event-Objects-to-the-Rescue">Event Objects to the Rescue!</h2>
<p>The Event objects are basically <a href="http://richardmiller.co.uk/2014/11/06/value-objects">Value Objects</a>. Pass a value in the constructor and get it with getter.</p>
<h3 id="1-Create-an-Event-Object">1. Create an Event Object</h3>
<pre><code class="language-php">use Symfony\Component\EventDispatcher\Event;

final class YoutuberNameEvent extends Event
{
    private string $youtuberName;

    public function __construct(string $youtuberName)
    {
        $this-&gt;youtuberName = $youtuberName;
    }

    public function getYoutuberName(): string
    {
        return $this-&gt;youtuberName;
    }
}</code></pre>
<h3 id="2-Use-Event-Object-in-Event-Subscriber">2. Use Event Object in Event Subscriber</h3>
<pre><code class="language-php">use Symfony\Component\EventDispatcher\EventSubscriberInterface;

final class NotifyMeOnVideoPublishedEventSubscriber implements EventSubscriberInterface
{
    public static function getSubscribedEvents(): array
    {
        return ['youtube.newVideoPublished' =&gt; 'notifyUserAboutVideo'];
    }

    // Event Object is passed as method argument
    public function notifyUserAboutVideo(YoutuberNameEvent $youtuberNameEvent)
    {
        var_dump($youtuberNameEvent-&gt;getYoutuberName());
    }
}</code></pre>
<h3 id="3-Create-an-Object-and-Dispatch-It">3. Create an Object and Dispatch It</h3>
<pre><code class="language-php">$youtuberNameEvent = new YoutuberNameEvent('Jirka Král');

$eventDispatcher-&gt;dispatch($youtuberNameEvent);</code></pre>
<p>And here is the result:</p>
<pre><code class="language-bash">$ php index.php
string('Jirka Král')</code></pre>
<h2 id="We-Are-1-Step-Further-Now">We Are 1 Step Further Now</h2>
<p>You can now:</p>
<ul>
<li>understand basic Event workflow</li>
<li>know what EventDispatcher and EventSubscriber are for</li>
<li>and know-how to pass parameters via the Event object</li>
</ul>
<h3 id="Where-to-go-next">Where to go next?</h3>
<p>Still hungry for knowledge? Check <a href="http://symfony.com/doc/current/components/event_dispatcher.html">Symfony documentation</a> then.</p>
<p>But remember: <strong>practice is the best teacher</strong>.</p>
<p><br><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/08/05/standalone-symfony-event-dispatcher-from-the-scratch</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 05 Aug 2019 00:00:00 +0000</pubDate>
                                    <updated>2020-06-01UTC00:00:000</updated>
                    <atom:updated>Mon, 01 Jun 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Mon, 01 Jun 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/08/05/standalone-symfony-event-dispatcher-from-the-scratch#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How we Completed Thousands of Missing @var Annotations in a Day ]]></title>
                <link>https://tomasvotruba.com/blog/2019/07/29/how-we-completed-thousands-of-missing-var-annotations-in-a-day</link>
                <description><![CDATA[ <p>I'm currently working as Rector consultant for <a href="https://spaceflow.io/en">Spaceflow</a>, Prague-based rising startup with very nice codebase. One of the pre-requisites for Rector is to have code that static analyser can work with. PHPStan that Rector uses depends on <code>@var</code> annotations and not every property had that. Well... <strong>over 2500 of them</strong>.
<br><br>
I'll show you how we completed them without any manual change of the code and how you can do the same... today.</p> ]]></description>
                <content:encoded><![CDATA[ <p>This post has 2 parts:</p>
<ul>
<li>1st is about how we use other parts of class to infer <code>@var</code> types of used properties - <strong>good for analytical thinking and pattern-algorithms</strong></li>
<li>2nd is about <a href="#do-it-yourself">how to do it yourself</a> - <strong>good for your project</strong></li>
</ul>
<p><br></p>
<p>The latter part increased the <strong><code>@var</code> annotation count from 1790 to 4418</strong>.</p>
<p>Here you can see the whole process in real-time:</p>
<img src="/assets/images/posts/2019/var/rector-final-optimized.gif" alt="How the ECS + Rector change 2500+ missing `@var` annotations" class="img-thumbnail">
<p><br></p>
<p>So what will you do when you see property like this?</p>
<pre><code class="language-php">&lt;?php

class ProductController
{
    private $productRepository;
}</code></pre>
<h3 id="1-From-Constructor-Injection-Assign">1. From Constructor Injection Assign</h3>
<p>This is the most common case in most projects:</p>
<pre><code class="language-php">&lt;?php

class ProductController
{
    private $productRepository;

    public function __construct(ProductRepository $productRepository)
    {
        // ah, it's a "ProductRepository"
        $this-&gt;productRepository = $productRepository;
    }
}</code></pre>
<h3 id="2-From-setUp-Assign-in-Tests">2. From <code>setUp</code> Assign in Tests</h3>
<p>The next biggest group of missing <code>@var</code> annotations was in tests. Instead of <code>__construct</code> we have<code>setUp</code>:</p>
<pre><code class="language-php">&lt;?php

class BuilderTest extends TestCase
{
    private $factory;

    protected function setUp(): void
    {
        // ah, it's a "Builder"
        $this-&gt;factory = new Builder;
    }
}</code></pre>
<h3 id="3-From-Assign-in-Constructor">3. From Assign in Constructor</h3>
<p>Sometimes constructor is for setting default values:</p>
<pre><code class="language-php">&lt;?php

class HomeController
{
    private $maxNumberOfGirlfriends;

    public function __construct()
    {
        // ah, it's an "int"
        $this-&gt;maxNumberOfGirlfriends = 1;
    }
}</code></pre>
<p>So far quite simple, right? 3 files are ok, but imagine doing this for 2500+ properties 🧠🤯</p>
<h3 id="4-From-Setters-and-Getters">4. From Setters and Getters</h3>
<p>Some object don't have constructor injection, or are missing the information there, e.g.:</p>
<pre><code class="language-php">&lt;?php

class Product
{
    private $name;

    public function __construct($name)
    {
         $this-&gt;name = $name;
    }
}</code></pre>
<p>How can we know, what is <code>$name</code>? Well, we don't. Statical analysis can't help here, we can only guess and maybe crash the production code. To solve cases like this <strong>we need dynamical analysis</strong> - data are much better and solid than &quot;probability guessing&quot; of static analysis. Don't worry, I'll write about it in the future with a case study.</p>
<p>But what about this code:</p>
<pre><code class="language-php">&lt;?php

class Product
{
    private $name;

    public function __construct($name)
    {
         $this-&gt;name = $name;
    }

    public function getName(): string
    {
        // now we know it's a "string"
        return $this-&gt;name;
    }
}</code></pre>
<p>Although it could be also non-string value:</p>
<pre><code class="language-php">&lt;?php

$product = new Product(5); // this passes without error</code></pre>
<p>But the working code <code>getName(): string</code> says <strong>it must be <code>string</code></strong>, so we can rely on it.</p>
<p>Also, this is just <code>@var</code> annotation not <a href="/blog/2018/11/15/how-to-get-php-74-typed-properties-to-your-code-in-few-seconds/">typed properties</a>, so the change cannot break anything.</p>
<h3 id="5-From-Nullables">5. From Nullables</h3>
<p>Let's take this one step further. Also, let's be more realistic - there are barely any type declarations (PHP 7.0+) out there, so we have to take annotations into account:</p>
<pre><code class="language-php">&lt;?php

class Product
{
    private $name;

    /**
     * @param string $name
     */
    public function __construct($name = null)
    {
         $this-&gt;name = $name;
    }

    /**
     * @param $name
     */
    public function setName($name)
    {
        $this-&gt;name = $name;
    }

    /**
     * @return string
     */
    public function getName()
    {
        return $this-&gt;name;
    }
}</code></pre>
<p>What types can be in <code>$name</code>?</p>
<p>There is a type <code>string</code> everywhere, so probably <code>string</code>. But what happens in this case?</p>
<pre><code class="language-php">&lt;?php

$product = new Product();</code></pre>
<p>The <code>$name</code> will be actually <code>null</code>. So this is final correct code change:</p>
<pre><code class="language-diff"> &lt;?php

 class Product
 {
+     /**
+      * @var string|null
+      */
      private $name;
 }</code></pre>
<h3 id="6-From-Default-Value">6. From Default Value</h3>
<p>Before we get into Doctrine entities, let's get relaxed with a simple case:</p>
<pre><code class="language-php">&lt;?php

class Victim
{
     private $name = 'Tomas';

     public function getName()
     {
         return $this-&gt;name;
     }
}</code></pre>
<p>I don't have to tell you the <code>$name</code> property is always <code>string</code>.</p>
<h3 id="7-From-all-the-Other-Assigns">7. From all the Other Assigns</h3>
<p>What if we have no constructor, no getters, no setters, no default values... are we lost?</p>
<p>This actually happens more often than you think. Take this as just an example, in reality it could be much better, but is often much worse:</p>
<pre><code class="language-php">&lt;?php

class ProductController
{
    private $activeProduct;

    /**
     * @var ProductRepository
     */
    private $productRepository;

    public function default($id = null)
    {
        if ($id) {
            $this-&gt;activeProduct = $this-&gt;productRepository-&gt;get($id);
        } else {
            $this-&gt;activeProduct = $this-&gt;productRepository-&gt;getMainProduct();
        }

        // ...
    }
}</code></pre>
<p>This is hell to do manually. Not in 5 lines-long method, but in 30, 60 or even 100 lines in one method (don't forget you have to deliver feature and don't have paid time to play with stupid useless <code>@var</code> annotation).</p>
<p>The process has just 2 step:</p>
<ul>
<li>go through all <code>$this-&gt;activeProduct = X</code></li>
<li>resolve type for the <code>X</code> expression</li>
</ul>
<p>And that's it:</p>
<pre><code class="language-diff"> &lt;?php

 class ProductController
 {
+    /**
+     * @var Product
+     */
     private $activeProduct;

     // ...
 }</code></pre>
<p>We could argue if the <code>$activeProduct</code> could be also <code>null</code>. It can, but in our case base it never was. But if you find such a case that is invalid for your code, <a href="https://github.com/rectorphp/rector/issues/new?template=1_Bug_report.md">please report an issue</a> to improve this Rector rule.</p>
<h3 id="8-From-Doctrine-Column-Annotations">8. From Doctrine Column Annotations</h3>
<p>Missing Doctrine annotations are hard to spot, because there is always <em>some</em> annotation. Just not the one we need:</p>
<pre><code class="language-php">&lt;?php

use Doctrine\ORM\Mapping as ORM;

/**
 * @ORM\Entity
 */
class Product
{
    /**
     * @ORM\Column(type="text", nullable=true)
     */
    private $content;
}</code></pre>
<p>Pretty easy, right?</p>
<pre><code class="language-diff"> /**
  * @ORM\Column(type="text", nullable=true)
+ * @var text|null
  */
  private $content;</code></pre>
<p>Ups, not so fast. Database types and PHP scalar types are not 1:1 compatible. To pick a few: <em>longblob</em>, <em>decimal</em>, <em>set</em>, <em>time</em> or <em>year</em> (mini-quiz: <code>int</code> or <code>DateTimeInterface</code>)?</p>
<p><code>string</code> is the correct choice here:</p>
<pre><code class="language-diff"> /**
  * @ORM\Column(type="text", nullable=true)
+ * @var string|null
  */
  private $content;</code></pre>
<p><div class="card ml-4 mt-4 border-warning float-right post-snippet" style="width: 14em">
    <div class="card-body">
        Would you like to <strong>learn more about Rector</strong>? Step by step, from zero to hero?
        <br>

        <div class="text-center">
            <a href="/book/the-power-of-automated-refactoring/">
                <img src="/assets/images/rector_book.png" class="mb-3 mt-3 shadow">
                Get our new book
            </a>
        </div>
    </div>
</div>
</p>
<h3 id="9-From-Doctrine-Relation-Annotations">9. From Doctrine Relation Annotations</h3>
<p>Let's finish with the most complex case, yet brutally common. What do we mean by Doctrine Relation annotations?</p>
<pre><code class="language-php">&lt;?php

class Product
{
    /**
     * @ORM\ManyToMany(targetEntity="App\Entity\Storage")
     */
    private $storage;

    /**
     * @ORM\ManyToOne(targetEntity="App\Entity\Category", inversedBy="products")
     * @ORM\JoinColumn(name="category_id", referencedColumnName="id", nullable=true)
     */
    private $category;
}</code></pre>
<p>The docblock looks full and rich for useful content, so it's hard to spot the missing <code>@var</code> in there.</p>
<p>You probably know, that <code>OneToMany</code> and <code>ManyToMany</code> are not just an array of objects, but also <code>Doctrine\Common\Collections\Collection</code>.</p>
<p>So what <code>@var</code> we'd add here?</p>
<pre><code class="language-diff"> &lt;?php

 class Product
 {
     /**
      * @ORM\ManyToMany(targetEntity="App\Entity\Storage")
+     * @var \App\Entity\Storage[]|\Doctrine\Common\Collections\Collection
      */
     private $storage;

     /**
      * @ORM\ManyToOne(targetEntity="App\Entity\Category", inversedBy="products")
      * @ORM\JoinColumn(name="category_id", referencedColumnName="id", nullable=true)
+     * @var \App\Entity\Category|null
      */
     private $category;
 }</code></pre>
<p>That's it! Did you find any more cases that we forgot? Share with us in the comments.</p>
<p><br></p>
<p>Now the 2nd practical part - <strong>your project</strong> ↓</p>
<h2 id="Do-It-Yourself">Do It Yourself</h2>
<p>All above is not limited just to our project. You can use it too!</p>
<p>I'll guide you from step zero to final merge of pull-request, <strong>so the gif will not be just a picture, but a real change in your project</strong>.</p>
<p><strong>Install Rector + ECS</strong></p>
<pre><code class="language-bash">composer require rector/rector --dev
composer require symplify/easy-coding-standard --dev
composer require slevomat/coding-standard --dev</code></pre>
<p><strong>Run ECS to check missing <code>@var</code> annotations at properties</strong></p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\EasyCodingStandard\ValueObject\Option;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();
    // every property should have @var annotation
    $services-&gt;set(SlevomatCodingStandard\Sniffs\TypeHints\TypeHintDeclarationSniff::class);

    $parameters = $containerConfigurator-&gt;parameters();
    $parameters-&gt;set(Option::SKIP, [
        //  this part is needed, because `TypeHintDeclarationSniff` is actually mix of 7 rules we don't need
        // (they also delete code, so be sure to have this section here)
        'SlevomatCodingStandard\Sniffs\TypeHints\TypeHintDeclarationSniff.UselessDocComment' =&gt; null,
        'SlevomatCodingStandard\Sniffs\TypeHints\TypeHintDeclarationSniff.MissingTraversablePropertyTypeHintSpecification' =&gt; null,
        'SlevomatCodingStandard\Sniffs\TypeHints\TypeHintDeclarationSniff.MissingTraversableReturnTypeHintSpecification' =&gt; null,
        'SlevomatCodingStandard\Sniffs\TypeHints\TypeHintDeclarationSniff.MissingTraversableParameterTypeHintSpecification' =&gt; null,
        'SlevomatCodingStandard\Sniffs\TypeHints\TypeHintDeclarationSniff.MissingParameterTypeHint' =&gt; null,
        'SlevomatCodingStandard\Sniffs\TypeHints\TypeHintDeclarationSniff.MissingReturnTypeHint' =&gt; null,
    ]);
};</code></pre>
<p>Run coding standard on your code:</p>
<pre><code class="language-bash">vendor/bin/ecs check src tests</code></pre>
<p>↓</p>
<p>2 500 errors? Not a problem.</p>
<p><br></p>
<p><strong>1. Configure Rector</strong></p>
<pre><code class="language-php">use Rector\TypeDeclaration\Rector\Property\PropertyTypeDeclarationRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;rule(PropertyTypeDeclarationRector::class);
};</code></pre>
<p><strong>2. Run Rector to fix your code</strong></p>
<pre><code class="language-bash">vendor/bin/rector process src tests</code></pre>
<p>Then run coding standard again, to see how useful Rector was:</p>
<pre><code class="language-bash">vendor/bin/ecs check src tests</code></pre>
<ul>
<li>
<p>0 errors? Congrats and enjoy your vacation :)</p>
</li>
<li>
<p>1+ errors? Create an <a href="https://github.com/rectorphp/rector/issues/new?template=1_Bug_report.md">issue with missed PHP code snippet</a>. We'll look at it and add support for it to Rector if possible.</p>
</li>
</ul>
<p><br></p>
<blockquote class="blockquote">
    I hope you'll find this useful as we did!
</blockquote>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/07/29/how-we-completed-thousands-of-missing-var-annotations-in-a-day</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 29 Jul 2019 00:00:00 +0000</pubDate>
                                    <updated>2020-08-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Aug 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Aug 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/07/29/how-we-completed-thousands-of-missing-var-annotations-in-a-day#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Convert Listeners to Subscribers and Reduce your Configs ]]></title>
                <link>https://tomasvotruba.com/blog/2019/07/22/how-to-convert-listeners-to-subscribers-and-reduce-your-configs</link>
                <description><![CDATA[ <p>I wrote <a href="/blog/2019/05/16/don-t-ever-use-listeners/">Don't Ever use Symfony Listeners</a> 2 months ago (if you missed it, be sure to read it to better understand this 2nd part). It got many constructive comments, mostly focused on particular standalone sentences without context.
<br>
<br>
To my surprise, <strong>none of the comments shown that listener beats subscriber</strong>.<br>
But what can you do, if you'd like to try subscribers, but currently have over 100 listeners in your application?</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="2-Ways-to-do-One-Thing-WTF-WHY-TF">2 Ways to do One Thing? = WTF! WHY TF?</h2>
<p>Just a reminder, how hurtful is to teach people <strong>2 very similar ways to do one thing</strong>.</p>
<p>Google shows that people are confused since 2012, wow!</p>
<img src="/assets/images/posts/2019/listen-to-sub/github.png" class="img-thumbnail">
<img src="/assets/images/posts/2019/listen-to-sub/quote.png" class="img-thumbnail">
<img src="/assets/images/posts/2019/listen-to-sub/so.png" class="img-thumbnail">
<p>And this is not related only to big patterns as subscriber or listener. We do such decisions every day - while we code a new feature when we add a new package to <code>composer.json</code> when we integrate 4th API to verify payments.</p>
<p>Next time you'll be standing before 2 options, remember <a href="/blog/2019/07/01/5-workflow-tips-every-php-developer-should-know/#5-use-elementary-maths-to-become-master">the least common denominator</a> and <strong>make your code more durable</strong> in time.</p>
<h2 id="Why-Should-we-Re-Think-Listeners-in-our-Code">Why Should we Re-Think Listeners in our Code?</h2>
<p>If the readable and clear code is not good enough reason for you and you still think
you should stick with listeners at all cost, maybe the following steps will convince you.</p>
<p>Symfony 3.3 introduced <a href="/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3/">PSR-4 Autodiscovery</a> of services. In short, it means we don't have register services manually, if they respect PSR-4 (class name ~= file location):</p>
<pre><code class="language-diff"> services:
-    App\Controller\CoffeeController: ~
-    App\Controller\WifiController: ~
-    App\Controller\PlaneController: ~
-    # thousands more...

+    App\Controller\:
+        resource: '../src/Controller'</code></pre>
<h2 id="How-to-Migrate-Listeners-to-Subscribers">How to Migrate Listeners to Subscribers?</h2>
<p>It doesn't apply only to controllers, but to all services, like Event Subscribers:</p>
<pre><code class="language-diff"> services:
     _defaults:
         # this helps load event subscribers to EventDistpatcher
         autoconfigure: true

-    App\EventSubscriber\CoffeeEventSubscriber: ~
-    App\EventSubscriber\WifiEventSubscriber: ~
-    App\EventSubscriber\PlaneEventSubscriber: ~
-    # thousands more...

+    App\EventSubscriber\:
+        resource: '../src/EventSubscriber'</code></pre>
<p>Next time we create an event subscriber class, we don't have to <a href="/blog/2019/02/14/why-config-coding-sucks/">code in config</a> anymore ✅</p>
<p>We've <a href="/blog/2018/05/21/is-your-code-readable-by-humans-cognitive-complexity-tells-you/">reduced cognitive load</a> → code is easier to work with → hiring is faster → we can focus on business and feature value.</p>
<h3 id="How-can-we-Reduce-configs-with-Listeners">How can we Reduce configs with Listeners?</h3>
<pre><code class="language-yaml">services:
    App\EventListener\WifiEventListener:
        tags:
            - { name: kernel.event_listener, event: kernel.exception }
            - { name: kernel.event_listener, event: kernel.view }</code></pre>
<p>Well, what about...</p>
<pre><code class="language-yaml">services:
    App\EventListener\:
        resource: '../src/EventListener'</code></pre>
<p>Hm, how can be the listener called when it has now an information event?</p>
<p>That's one of legacy <a href="/blog/2017/02/12/drop-all-service-tags-in-your-nette-and-symfony-applications/">code smells of tags</a>.</p>
<p><strong>We can't reduce configs</strong>. We have to grow about configs together with code till the end of times ❌</p>
<p><br></p>
<p>If <strong>you're paid or motivated by productivity</strong> like me and not by produced lines of code or wasted time with no output, you care about this.</p>
<p><div class="card ml-4 mt-4 border-warning float-right post-snippet" style="width: 14em">
    <div class="card-body">
        Would you like to <strong>learn more about Rector</strong>? Step by step, from zero to hero?
        <br>

        <div class="text-center">
            <a href="/book/the-power-of-automated-refactoring/">
                <img src="/assets/images/rector_book.png" class="mb-3 mt-3 shadow">
                Get our new book
            </a>
        </div>
    </div>
</div>
</p>
<h2 id="Automated-Instant-Migration">Automated Instant Migration</h2>
<p>It's very nice use case for <a href="/blog/2019/04/15/pattern-refactoring/">pattern refactoring</a>, from A - <em>Listener</em> to B - <em>Event Subscriber</em>.</p>
<h3 id="1-Define-Patterns">1. Define Patterns</h3>
<p>A. <strong>Listener</strong></p>
<ul>
<li>it's a naked PHP class with a public method</li>
<li>event information (event, method, priority) is in a config</li>
</ul>
<p>B. <strong>Event Subscriber</strong></p>
<ul>
<li>it's a PHP class that implements <code>Symfony\Component\EventDispatcher\EventSubscriberInterface</code></li>
<li>event information is in a static method <code>getSubscribedEvents</code> inside the class</li>
<li>it is auto-discovered by PSR-4</li>
</ul>
<h3 id="2-Pattern-Change-In-Code">2. Pattern Change In Code?</h3>
<pre><code class="language-php">&lt;?php

class SomeListener
{
     public function methodToBeCalled()
     {
     }
}</code></pre>
<pre><code class="language-yaml"># in config.yaml
services:
    SomeListener:
        tags:
            - { name: kernel.event_listener, event: 'some_event', method: 'methodToBeCalled' }</code></pre>
<p>↓</p>
<pre><code class="language-php">&lt;?php
use Symfony\Component\EventDispatcher\EventSubscriberInterface;

class SomeEventSubscriber implements EventSubscriberInterface
{
     /**
      * @return mixed[]
      */
     public static function getSubscribedEvents(): array
     {
         return ['some_event' =&gt; 'methodToBeCalled'];
     }

     public function methodToBeCalled()
     {
     }
}</code></pre>
<p>Without any config.</p>
<h3 id="3-Instant-Upgrade-with-Rector">3. Instant Upgrade with Rector</h3>
<p>The latest <a href="https://twitter.com/rectorphp/status/1152862370630459393">Rector v0.5.8 is shipped</a> with rule exactly for this kind of migration.</p>
<p>Just register the rule in your <code>rector.php</code> config to start migration:</p>
<pre><code class="language-php">use Rector\SymfonyCodeQuality\Rector\Class_\EventListenerToEventSubscriberRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;rule(EventListenerToEventSubscriberRector::class);

    // optional, when something fails
    $parameters = $containerConfigurator-&gt;parameters();

    // use explicit Kernel, if not discovered by Rector
    $parameters-&gt;set('kernel_class', 'App\Kernel');

    // use explicit environment, if not found by Rector
    $parameters-&gt;set('kernel_environment', 'test');
};

Run it:

```bash
vendor/bin/rector process app src</code></pre>
<p>And now all the listeners were migrated to event subscribers ✅</p>
<h3 id="4-Update-Configs">4. Update Configs</h3>
<p>In the end, we have to remove all listeners + metadata from configs and add single autodiscovery for our EventSubscribers:</p>
<pre><code class="language-diff">services:
-    App\EventListener\WifiEventListener:
-        tags:
-            - { name: kernel.event_listener, event: kernel.exception }
-            - { name: kernel.event_listener, event: kernel.view }

+    _defaults:
+        autoconfigure: true
+
+    App\EventSubscriber\:
+        resource: '../src/EventSubscriber'</code></pre>
<p>That's it!</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/07/22/how-to-convert-listeners-to-subscribers-and-reduce-your-configs</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 22 Jul 2019 00:00:00 +0000</pubDate>
                                    <updated>2020-08-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Aug 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Aug 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/07/22/how-to-convert-listeners-to-subscribers-and-reduce-your-configs#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Why use One-Time Migration Scripts ]]></title>
                <link>https://tomasvotruba.com/blog/2019/07/15/why-use-one-time-migration-scripts</link>
                <description><![CDATA[ <p>School system taught me to despise old books and consider them outdated, rather about stories than knowledge. I wanted to prove I'm right, so I've read <a href="https://www.amazon.com/Pragmatic-Programmer-Journeyman-Master/dp/020161622X">Pragmatic Programmer</a> from 1999 and <em>you won't believe what happened</em>...</p> ]]></description>
                <content:encoded><![CDATA[ <p>You already probably know about instant refactoring and <a href="/blog/2019/04/15/pattern-refactoring/">pattern refactoring</a> (I'm deprecating refactoring as you know it) that's possible thanks to <a href="https://github.com/rectorphp/rector">Rector</a>. But they require a certain knowledge of code and it's patterns.</p>
<h2 id="Instant-Refactoring-Today">Instant Refactoring Today?</h2>
<p>I was wondering, <strong>how can you use instant refactoring at your work today with what you already know?</strong> So did <em>Andrew Hunt</em> and <em>David Thomas</em>, authors of <a href="https://www.amazon.com/Pragmatic-Programmer-Journeyman-Master/dp/020161622X">Pragmatic Programmer</a>.</p>
<p>They write about a migration script, that you <strong>write, use once and then delete it</strong>. Like a mandala-script :).
In the end, you only commit changed files, but no the script you've made for it.</p>
<h2 id="Where-to-use-Mandala-Script">Where to use <em>Mandala-Script</em>?</h2>
<ul>
<li>move files from one directory to another</li>
<li>rename files from <code>*.yml</code> to <code>*.yaml</code></li>
<li>remove all trailing whitespaces</li>
<li>remove <code>@throw</code> annotations from the docblocks</li>
<li>update version of all <code>&lt;your-framework&gt;/*</code> in all <code>composer.json</code> from 3 to 4</li>
<li>generate <code>.env</code>, <code>docker-composer.yml</code> and <code>.gitlab-ci.yml</code> from a set of env variables</li>
<li>etc.</li>
</ul>
<p>Any script that:</p>
<ul>
<li>is related to <strong>many files</strong></li>
<li>or is done <strong>over and over again</strong></li>
<li>is <strong>more fun (effective)</strong> to write than to do manually</li>
<li>has the potential to be reused or extended in the future</li>
</ul>
<h3 id="It-s-Good-for-Business">It's Good for Business</h3>
<p>From a business point of view, it's very useful in cases, <strong>where it can be done wrong</strong>. We talk about configuration files like ENV and YAML. Usually, they have poor (= no) validation, so finding a bug is like reading a manual written all over the walls of your house about how to open door.</p>
<p>Just last month the <code>KEY=value</code> vs <code>KEY: value</code> lead to 4-5 hours wasted in my current work.</p>
<p><br></p>
<p>As you can see, the idea is very simple, so let's use it in a simple case.
I have prepared 2 related examples for you:</p>
<h2 id="1-Migrate-app-config-to-config">1. Migrate <code>app/config</code> to <code>config</code></h2>
<p>In Symfony 4 the <a href="http://fabien.potencier.org/symfony4-directory-structure.html">base directory was changed</a>. We need to use new locations. In one project it's simple and better done manually. But we use monorepo and have  20+ <code>/packages/X/config</code> directories.</p>
<p>Let's code:</p>
<pre><code class="language-bash">composer require symfony/filesystem --dev
composer require symfony/finder --dev</code></pre>
<p><strong>Create <code>move_config_to_root.php</code> file</strong></p>
<pre><code class="language-php">&lt;?php

use Symfony\Component\Filesystem\Filesystem;
use Symfony\Component\Finder\Finder;

require __DIR__ . '/vendor/autoload.php';

$filesystem = new Filesystem();

$finder = (new Finder())-&gt;directories()
    -&gt;in(__DIR__ . '/packages')
    -&gt;name('config')
    -&gt;notPath('App/config')
    -&gt;getIterator();

$configDirectories = iterator_to_array($finder);

foreach ($configDirectories as $configDirectory) {
    $oldPath = $configDirectory-&gt;getRealPath();
    $newPath = dirname($configDirectory-&gt;getRealPath(), 2) . DIRECTORY_SEPARATOR . 'config';

    if (!file_exists($oldPath)) {
        continue;
    }

    $filesystem-&gt;rename($oldPath, $newPath);
}</code></pre>
<p><strong>Run <code>move_config_to_root.php</code> file</strong></p>
<pre><code class="language-bash">php move_config_to_root.php</code></pre>
<p><strong>See result</strong></p>
<pre><code class="language-bash">git diff</code></pre>
<p>Have you missed a spot? Just reset with:</p>
<pre><code class="language-bash">git checkout .</code></pre>
<p>Improve <code>move_config_to_root.php</code> and re-run again:</p>
<pre><code class="language-bash">php move_config_to_root.php</code></pre>
<p>It took me around 5 iterations to make it right, but the script was ready in 10 minutes. As a bonus, we could re-use it to move <code>/templates</code>, <code>/translations</code> etc. as well <strong>for just 1 minute of extra work</strong>.</p>
<h2 id="2-Update-resource-Paths-in-services-yaml">2. Update <code>resource:</code> Paths in <code>services.yaml</code></h2>
<p>But since we moved config files one level up, we also need to <strong>update paths inside the files</strong>. How?
You can use <code>str_replace</code> or (like me) regular expressions.</p>
<pre><code class="language-bash">composer require nette/utils --dev</code></pre>
<p><strong>Create <code>update_resource_in_configs.php</code></strong></p>
<pre><code class="language-php">&lt;?php

use Nette\Utils\FileSystem;
use Nette\Utils\Strings;
use Symfony\Component\Finder\Finder;

require __DIR__ . '/vendor/autoload.php';

$finder = (new Finder())-&gt;files()
    -&gt;in(__DIR__ . '/packages')
    -&gt;name('services.yaml')
    -&gt;getIterator();

$configFiles = iterator_to_array($finder);

foreach ($configFiles as $configFile) {
    $fileContent = FileSystem::read($configFile-&gt;getRealPath());

    $movedResource = Strings::replace($fileContent, '#(resource:\s(\')?)\.\.#', '$1../src');

    FileSystem::write($configFile-&gt;getRealPath(), $movedResource);
}</code></pre>
<pre><code class="language-diff"> services:
     App\:
-        resource: ..
+        resource: ../src</code></pre>
<p>Again, it took us 3-4 iterations to cover all edge cases, but then it was ready and bullet-proof.</p>
<h2 id="Start-Small-then-Take-it-to-the-Next-Level">Start Small, then Take it to the Next Level</h2>
<p><strong>If you want to get deeper into this thinking and find more inspiration, read the <em>Pragmatic Programmer</em> book</strong>. I personally found useful about 60 % of the content (compared to usual ~30 % in technical books), so 👍</p>
<img src="/assets/images/posts/2019/one-time/pragmatic_programmer.jpg" class="img-thumbnail">
<p>I use this approach in Rector to create new rule + test in 1 file:</p>
<p>Just copy <code>create-rector.php.dist</code> to <code>rector-recipe.php</code>, edit it and then run:</p>
<pre><code class="language-bash">bin/rector create</code></pre>
<p>It:</p>
<ul>
<li>creates a rule with a basic description</li>
<li>creates a test case</li>
<li>creates a test fixture</li>
<li>adds a rule to a set</li>
<li>adds a new namespace to <code>composer.json</code> PSR-4 if needed</li>
<li>dumps composer autoload if needed</li>
</ul>
<p>The sky is the limit, so fly high :)</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/07/15/why-use-one-time-migration-scripts</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 15 Jul 2019 00:00:00 +0000</pubDate>
                                    <updated>2020-08-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Aug 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Aug 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/07/15/why-use-one-time-migration-scripts#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 7 Tips to Write Flawless Issue Reports on Github ]]></title>
                <link>https://tomasvotruba.com/blog/2019/07/08/7-tips-to-write-flawless-issue-report-on-github</link>
                <description><![CDATA[ <p>Reporting issue is important for both you and the maintainer of the project. It can be a private issue in your local Gitlab repository, but open-source issues on Github have a much higher volume (obviously).
<br><br>
Do you want to be clear to the maintainer, be understood and resolve your issue quickly?
Here is how to write.</p> ]]></description>
                <content:encoded><![CDATA[ <p><strong>Issue report is like any other text</strong> - it can be a piece of text you read and take nothing from or it can fun and rich for the information you really need, for e.g. a job advertisement. You can see:</p>
<ul>
<li>boring job ad with a description of the company and how revolutionary their idea about selling mushroom is</li>
<li>or an ad, that tells you how you can full-fill your full potential, using PHP 7.4, Symfony 4.4, with ready-made Docker tested on 10 new developers with a focus on the mutual friendship between business and clean code</li>
</ul>
<h2 id="Why-Do-You-Need-to-Write-Better-Issues">Why Do You Need to Write Better Issues?</h2>
<p>Do you think better issues is extra work on your side just to make maintainer happier? No!
<strong>You profit from it</strong>.</p>
<h3 id="What-Do-You-Gain-by-Flawless-Issue-Report">What Do You Gain by Flawless Issue Report?</h3>
<ul>
<li>no further questions from the maintainers, just &quot;thanks&quot; → <strong>more free time (attention) for you</strong>, no need to think about the answers and reading their text</li>
<li>higher chance of fixing of your issue → <strong>you can enjoy the fix in 1-2 days</strong>, without waiting - unclear issues can take over 6 months to resolve, even if it's just missing '=' in the output</li>
<li>the maintainer will like you more because you're clear for them → <strong>your issues will get higher priority</strong> the longer and the better your write them</li>
<li>feature requests → after creating a streak of closed issues, <strong>your feature requests will be more likely accepted</strong></li>
</ul>
<h3 id="Where-Should-You-Apply-it">Where Should You Apply it?</h3>
<p>Writing issue like this takes extra attention, thought and energy. It takes a few weeks to get used to it. <strong>So should you write flawless issues in every Github repository you work with?</strong> It would probably drain your energy and burn-out into falling back to just poor issue reports.</p>
<p>Personally, I'd <strong>focus only on few repositories that matter to me and that I plan to use in the future</strong>. The top 3 from top of my head right now would be Symfony, PHP Parser and EasyAdminBundle.</p>
<p>That way you won't burn out writing 10 issues mind-full issues to 10 different projects in a week and projects you love and use daily will grow in time - <em>win-win</em>.</p>
<p><br></p>
<p>Now you know <em>why</em> and <em>where</em>. I think you're ready for creating the very first <em>flawless issue</em>™:</p>
<img src="/assets/images/posts/2019/issues/new_issue.png" class="img-thumbnail">
<p>(The examples will be related to Rector, as I work with it the most lately).</p>
<h2 id="1-Add-Project-Version">1. Add Project Version</h2>
<p>The version of the used project is very important. Maybe you use LTS version, maybe it's legacy already, maybe it's experimental version and it's expected to break. You don't care about this, but it will give maintainer the context of your issue.</p>
<p>&quot;I use Rector v0.5.7&quot;</p>
<p>How do you find this information quickly?</p>
<pre><code class="language-bash">composer show rector/rector | grep version
&gt; versions : * v0.5.7</code></pre>
<h3 id="Even-Better">Even Better</h3>
<p>This one is nice to have if you're into bleeding edge technologies:</p>
<p>&quot;I use Rector v0.5.7, and it's still broken on <code>dev-master</code>&quot;</p>
<p>Test <code>dev-master</code> as well. Maybe this issue was reported before 2 days and is already fixed on <code>master</code>?
You don't have to read all the past issues - it's a waste of time (maybe there was just PR, or maybe just commit right to the <code>master</code>), just try it:</p>
<pre><code class="language-diff"> {
     "require": {
-        "rector/rector": "^0.5.7"
+        "rector/rector": "dev-master"
     },
+    "minimum-stability": "dev",
+    "prefer-stable": true
 }</code></pre>
<pre><code class="language-bash">composer update</code></pre>
<pre><code class="language-bash">// retry your command</code></pre>
<h2 id="2-What-Happened-Clear-Exact-and-Right-To-the-Point">2. What Happened - Clear, Exact and Right To the Point</h2>
<ul>
<li><strike>&quot;I was trying to run on Rector on our codebase and it broke in hundreds of cases.&quot;</strike></li>
<li><strike>&quot;When I run Rector, it skips all the old PHP code that it should upgrade.&quot;</strike></li>
</ul>
<p>These reports have exactly 0 added information. By creating an &quot;issue&quot;, you've already told the maintainer it's broken.</p>
<p>What should you go for instead? Remove the ambiguous:</p>
<ul>
<li>&quot;Put the red apple to the 3rd shelf from the bottom.&quot;</li>
<li>&quot;Let's meet on Tuesday 3rd July at 17:00 on Vltavska square, here is the address http://...&quot;</li>
</ul>
<p>In an issue:</p>
<p>&quot;I run Rector on [this-code] and I got [this-exception] with [this-exception-message]&quot;</p>
<h2 id="3-Code-over-Text">3. Code over Text</h2>
<ul>
<li><strike>...our files</strike></li>
<li><strike>...our code-base</strike></li>
<li><strike>...1 PHP file with Factory with Guzzle that contains the connection to Twitter API</strike></li>
</ul>
<p>These reports could be replaced by black-box style &quot;...on something unknown&quot;. 0-value.</p>
<ul>
<li>&quot;On this code&quot;</li>
</ul>
<pre><code class="language-php">&lt;?php

use Guzzle\Client;

final class GuzzleFactory
{
     public function create()
     {
         return new Client([
             'key' =&gt; 'some_key'
         ]);
     }
}</code></pre>
<h2 id="4-Highlight-What-You-Can">4. Highlight What You Can</h2>
<p>Why do we use IDE? Why do traffic lights have colors? What does <span class="text-danger">red</span> in PHPUnit mean?</p>
<p><strong>Colors gives us meta-information</strong>, that is processed by other parts of the brain then reading is. That way we understand element with colors faster and easier:</p>
<pre><code class="language-php">echo "1" . 5 + 0x15;</code></pre>
<p>vs.</p>
<p>echo &quot;1&quot; . 5 + 0x15;</p>
<p>I'm not a dog so I fancy the 1st one.</p>
<p><br></p>
<p>In the most of Github issues you'll use <code>php</code> and <code>diff</code> syntax highligh:</p>
<p><span markdown=0></p>
<pre><code class="language-php">echo "Hi";</code></pre>
<p></span></p>
<p><span markdown=0></p>
<pre><code class="language-diff">-expected
+reality</code></pre>
<p></span></p>
<h2 id="4-The-Smaller-the-Better">4. The Smaller the Better</h2>
<p>&quot;What? I thought the more information you'll have, the easier is to fix it.&quot; This tip is counter-intuitive. The information is not about quantity, but quality.</p>
<p>The issue report should contain:</p>
<ul>
<li><strong>all the relevant information</strong></li>
<li><strong>0 of the irrelevant information</strong></li>
</ul>
<p>At first, it might be hard to figure out what's relevant for the maintainer of that particular project, but based on their feedback you can see it.</p>
<p>Let's look at the code of the previous example - this one has all the relevant information:</p>
<pre><code class="language-php">&lt;?php

use Guzzle\Client;

final class GuzzleFactory
{
     public function create()
     {
         return new Client([
             'key' =&gt; 'some_key'
         ]);
     }
}</code></pre>
<p>This one has duplicated of irrelevant information:</p>
<pre><code class="language-php">&lt;?php

use Guzzle\Client;

final class GuzzleFactory
{
     public function create()
     {
         return new Client([
             'key' =&gt; 'some_key',
             'another_key' =&gt; 'some_key',
         ]);
     }
}

final class FacebookFactory
{
     public function create()
     {
         return new FacebookClient([
             'key' =&gt; 'some_key',
             'another_key' =&gt; 'some_key',
         ]);
     }
}

final class TwitterFactory
{
   public function create()
   {
       return new TwitterClient([
           'key' =&gt; 'some_key',
           'another_key' =&gt; 'some_key',
       ]);
   }
}</code></pre>
<p>If all the code snippets produce the &quot;Factory return type cannot be resolved&quot; error, use just the first one.</p>
<p>(Hi <em>Honza</em> :D)</p>
<h2 id="5-What-Did-you-Do">5. What Did you Do?</h2>
<p>Now the maintainer knows:</p>
<ul>
<li>what do you use</li>
<li>what is the code causing it</li>
<li>what is the error message</li>
</ul>
<p>✅ Great job! If all the issues were reported like this, the productivity in open-source will sky-rocket (and I mean &quot;Elon Musk&quot; sky-rocket).</p>
<p>The 1st questions that will pop-up in the maintainer's head are &quot;How did you do that?&quot;</p>
<ul>
<li>Did you run it from command line?</li>
<li>What exact command have you used?</li>
<li>Did you use Docker?</li>
<li>Do you use custom <code>rector.php</code> config? What's inside?</li>
<li>Is the error still there with no config?</li>
</ul>
<p>Again, think of <em>4. The smaller the better</em> tip while copy-pasting the <code>config</code>.</p>
<ul>
<li>Which of those 400 lines in the config are responsible for this error?</li>
<li>What combinations of rules and parameters are causing the error?</li>
</ul>
<p>&quot;I installed Rector as dev dependency to composer and run:&quot;</p>
<pre><code class="language-bash">vendor/bin/rector process src/SomeFile.php --dry-run</code></pre>
<p>With <code>rector.php</code> config:</p>
<pre><code class="language-php">use Rector\Symfony\Set\SymfonySetList;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;import(SymfonySetList::SYMFONY_43);
};</code></pre>
<p>Perfect!</p>
<h2 id="6-What-do-You-Want">6. What do You Want?</h2>
<p>Now the maintainer has all the information about your code, your steps that lead to it and the configuration that caused it.</p>
<p>But <strong>what do you want</strong>?</p>
<ul>
<li>Do you expect the code to throw a better exception?</li>
<li>Are you ok with the behavior, just not sure if it's expected?</li>
<li>Do you want it to work a certain way?</li>
</ul>
<p>Here is the <code>diff</code> syntax becomes very useful:</p>
<pre><code class="language-diff">&lt;?php

-echo 1 + 5; // real
+echo 6; // expected</code></pre>
<p>Having comments is really great. Why?</p>
<pre><code class="language-diff">&lt;?php

-echo $value + $value2;
+echo $value+$value2;</code></pre>
<p>Which one is preferred?</p>
<h2 id="7-1-Issue-1-Issue">7. 1 Issue = 1 Issue</h2>
<p>Last but not least, <strong>1 issue report should talk about 1 issue</strong>. Imagine you go for a trip and you talk to your friend how to get there:</p>
<p>New issue - <em> traveling</em>:</p>
<ul>
<li>Let's take a train</li>
<li>We could take a bus, it's 50 € cheaper</li>
<li>But I'm not sure what to pack</li>
<li>Do you have a tent?</li>
<li>Ok, we'll take a bus</li>
</ul>
<p><em>issue is closed</em></p>
<ul>
<li>What are we gonna eat guys?</li>
<li>We could eat wursts all the time!</li>
</ul>
<p><br></p>
<p>Do you have 3 different (see tip #4 again) problems with your code? Create 3 different issues. Don't be afraid, you're not complaining too much.</p>
<p><strong>It's better to have 3 separated issue</strong>, that one is easy-pick, 2nd is a question and 3rd need a test case, that all these at once.</p>
<p><br></p>
<p>Now go out, try, fail and learn :)</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/07/08/7-tips-to-write-flawless-issue-report-on-github</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 08 Jul 2019 00:00:00 +0000</pubDate>
                                    <updated>2020-11-01UTC00:00:000</updated>
                    <atom:updated>Sun, 01 Nov 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sun, 01 Nov 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/07/08/7-tips-to-write-flawless-issue-report-on-github#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 5 Workflow Tips every PHP Developer Should Know ]]></title>
                <link>https://tomasvotruba.com/blog/2019/07/01/5-workflow-tips-every-php-developer-should-know</link>
                <description><![CDATA[ <p>I was surprised, how much of your attention got <a href="/blog/2019/02/25/5-tips-to-effective-work-with-github-repository/">5 Tips to Effective Work with Github Repository</a> post.
<br><br>
So <a href="https://github.com/TomasVotruba/tomasvotruba.com/issues/226">I started to collect tips</a> I use on training and mentoring that I don't even notice, but others find fascinating. Here is 5 of them.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="1-Find-any-file-in-Github-Repository-within-a-Second">1. Find any file in Github Repository within a Second</h2>
<p>Github repository is the best documentation, if <a href="/blog/2019/06/17/how-to-upgrade-meetup-com-api-to-oauth2-with-guzzle/">the code is written mindfully</a>.</p>
<p>E.g. you use Rector and you're curious about its guts. The main bin command is &quot;vendor/bin/rector process&quot;, so you're interested in <code>ProcessCommand</code>. What's inside?</p>
<p>You go to the Github repository:</p>
<ul>
<li>look for &quot;process command&quot; or &quot;ProcessCommand&quot;</li>
<li>find 150 irrelevant results</li>
<li>...and close it 😠</li>
</ul>
<p>Great documentation is useless without the even better search.</p>
<p><br></p>
<p><strong>Good news! Github is closer to PHPStorm than you think:</strong></p>
<img src="/assets/images/posts/2019/php_workflow_tips/hit_t.gif" class="img-thumbnail" style="max-width:35em">
<p><strong>Just press <span class="btn btn-light btn-outline-dark">t</span> on your keyboard and &quot;TypeYourClass&quot;.</strong></p>
<p>👍</p>
<h2 id="2-Get-rid-of-Phing">2. Get rid of Phing</h2>
<p>All Phing scripts I've seen look like someone programmed their own Arduino to open glass with water.
So I migrate them to composer scripts, so people can actually use them without having an MIT degree.</p>
<p>Martin already wrote about it in <a href="https://blog.martinhujer.cz/have-you-tried-composer-scripts">Have you tried Composer Scripts? You may not need Phing</a></p>
<p>👍</p>
<h2 id="3-Enable-Colors-in-Composer-Scripts">3. Enable Colors in Composer Scripts</h2>
<p>Let's say you already use composer scripts:</p>
<pre><code class="language-json">{
    "scripts": {
        "fix-cs": "vendor/bin/ecs check bin src tests --fix"
    }
}</code></pre>
<p>Great job! Now all you need to do is run it:</p>
<pre><code class="language-bash">composer fix-cs</code></pre>
<p>The scripts are running... Now imagine I'll come to you and slap you in the face for failing build <code>master</code> branch (that's just hypothetical case, we all know <code>master</code> can never fail, right?).</p>
<p>Your head turns around and you grab a part of the script output. Now...</p>
<p><strong>&quot;Was it <span class="text-danger">red</span> or <span class="text-success">green</span>?&quot;</strong></p>
<p>The output is hard to read quickly without <a href="https://www.amazon.com/Design-Everyday-Things-Donald-Norman/dp/1452654123">color patterns</a>.</p>
<p>How to fix this? Just add <code>--ansi</code>:</p>
<pre><code class="language-diff"> {
     "scripts": {
-        "fix-cs": "vendor/bin/ecs check bin src tests --fix"
+        "fix-cs": "vendor/bin/ecs check bin src tests --fix --ansi"
    }
}</code></pre>
<p>👍</p>
<p>Thanks for this tip to <a href="https://janmikes.cz">Jan Mikes</a> ❤️️.</p>
<p><br></p>
<p><em>For more composer tips, check <a href="https://blog.martinhujer.cz/17-tips-for-using-composer-efficiently">24 Tips for Using Composer Efficiently</a>.</em></p>
<h2 id="4-Get-rid-of-PHPMD">4. Get rid of PHPMD</h2>
<p>You might know PHPMD as <em>PHP Mess Detector</em>. But not many people know, the package is dead:</p>
<img src="/assets/images/posts/2019/php_workflow_tips/barely.png" class="img-thumbnail">
<p>Dead packages are ok if there is no alternative that is continuously evolving. If there is, by staying at the same place, <a href="/blog/2019/03/11/why-we-migrated-from-nette-to-symfony-in-3-weeks-part-3/">you're shooting your business and development speed to the leg</a>.</p>
<p>That's this case. PHPMD features are 99 % compatible with PHP Code Sniffer and PHP CS Fixer rules:</p>
<pre><code class="language-diff">-PHPMD rule
+PHP_CodeSniffer alternative</code></pre>
<p>E.g.:</p>
<pre><code class="language-diff">-rulesets/codesize.xml/CyclomaticComplexity
+Generic.Metrics.CyclomaticComplexity

-rulesets/controversial.xml/CamelCaseMethodName
+PSR1.Methods.CamelCapsMethodName

-rulesets/design.xml/GotoStatement
+Generic.PHP.DiscourageGoto</code></pre>
<p>I've migrated over 5 of these recently and you can see its a relief in developers eyes - they either have less code to maintain or (more often) they've finally got rid of that &quot;black hole&quot; code that no-one knew what it does.</p>
<p><strong>How to migrate?</strong></p>
<p>Just look at <a href="https://github.com/shopsys/shopsys/search?p=2&amp;q=phpmd&amp;type=Commits">PHPMD migration to PHP_CodeSniffer in Shopsys repository</a>.</p>
<p>👍</p>
<h2 id="5-Use-Elementary-Maths-to-become-Master">5. Use Elementary Maths to become Master</h2>
<p>Tips 2 and 4 have actually similar principals, <a href="/blog/2019/04/15/pattern-refactoring/">a pattern</a>. If you learn to think in patterns, <strong>you can merge 10 specific rules to 1 pattern</strong> and <a href="/blog/2018/09/13/your-brain-is-your-garden/">use that extra brain space for something else</a>.</p>
<h3 id="Least-Common-Denominator">Least Common Denominator</h3>
<p>I've learned this principle in 5th grade, it has fascinated me ever since. It fascinates me even more, how they are used to create effective code - easy to write, read, maintain and doing what it should do.</p>
<p><strong>What is the least common denominator?</strong></p>
<p>These 2 pictures explain it:</p>
<div class="row">
    <div class="col-12 col-md-6">
        <img src="/assets/images/posts/2019/php_workflow_tips/least.gif" class="img-thumbnail">
    </div>
    <div class="col-12 col-md-6">
        <img src="/assets/images/posts/2019/php_workflow_tips/not_so_least.gif" class="img-thumbnail">
    </div>
</div>
<p>Now, both pictures explain it. Which one do you prefer?</p>
<p><em>Disclosure</em></p>
<ul>
<li>the left image is actually self-explanatory - it's used <em>least common denominator</em> to explain <em>Least Common Denominator</em></li>
<li>the right image also explain it, but it uses much more extra data, that you don't need (e.g. root) and only slows down your neuron pipelines</li>
</ul>
<p><strong>Use the left approach to explain issues and problems. They're easier to understand, focused on the problem you really have and will get to the effective solution faster.</strong></p>
<p>The right path is how the legacy code is manufactured in companies every day.</p>
<h3 id="What-Else-is-There">What Else is There?</h3>
<ul>
<li>
<p><em>Occam's razor</em> - People that <a href="https://simple.wikipedia.org/wiki/Occam%27s_razor">use Wikipedia</a> or studied university renamed <em>least common denominator</em> to Occam's razor and added more academic words. The logic is the same, but you might prefer it.</p>
</li>
<li>
<p><em>SOLID</em> - Again the same family, just different letters and vocabulary.</p>
</li>
</ul>
<p>That's the beauty example of pattern thinking. Instead of remembering 3 different terms, you pick one and use it.</p>
<p>👍</p>
<p><br></p>
<p><strong>Do you want to go <em>balls deep</em> and learn more about this?</strong> Book it:</p>
<ul>
<li><a href="https://www.amazon.com/Pragmatic-Programmer-Journeyman-Master-ebook/dp/B003GCTQAE">The Pragmatic Programmer: From Journeyman to Master</a></li>
<li><a href="https://www.amazon.com/Dont-Make-Think-Revisited-Usability/dp/0321965515">Don't Make Me Think, Revisited</a> (3rd edition from 2014)</li>
</ul>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/07/01/5-workflow-tips-every-php-developer-should-know</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 01 Jul 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/07/01/5-workflow-tips-every-php-developer-should-know#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Do you use PHP_CodeSniffer and PHP CS Fixer PHPStorm Plugin? You are Slow and Expensive ]]></title>
                <link>https://tomasvotruba.com/blog/2019/06/24/do-you-use-php-codesniffer-and-php-cs-fixer-phpstorm-plugin-you-are-slow-and-expensive</link>
                <description><![CDATA[ <p>People keep asking me about IDE plugins <a href="https://www.reddit.com/r/phpstorm/comments/am1qzv/update_phpdoc_comment_action/efqpv8o">for Rector</a> and Easy Coding Standard.
Do you want it too? Do you use one for PHP_CodeSniffer of PHP CS Fixer? Have you ever thought about the benefits and costs of them?</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Benefits-of-Instant-Feedback">Benefits of Instant Feedback</h2>
<p>When you a PHPStorm plugin that tells you what to do, you have this extra information that you can follow:</p>
<img src="/assets/images/posts/2019/plugin/plugin.png">
<p>That's pretty cool, right? It will:</p>
<ul>
<li>save you running coding standard tool from command line later - forget <code>vendor/bin/ecs check src</code></li>
<li>help you to write code according to standards of the project</li>
<li>help you to write better code</li>
<li><strong>you have the information at the moment you made the mistake</strong></li>
</ul>
<p>The last benefit is wired to our brains.</p>
<h2 id="Trap-of-Instant-Gratification">Trap of Instant Gratification</h2>
<blockquote class="blockquote">
    "Everybody is addicted to dopamine."
</blockquote>
<img src="/assets/images/posts/2019/plugin/porn.jpg" class="img-thumbnail">
<p>Slack notification, Instagram likes, underline of <em>typoes</em> and suggestions in your IDE.<br>
<strong>This all makes us happy by brain design</strong>.</p>
<p><br></p>
<p>Coding standard tools are in your IDE already, next are static analyzers and instant upgraders:</p>
<div class="text-center">
    <img src="/assets/images/posts/2019/plugin/psalm.png">
    <br>
    Live report on <a href="https://psalm.dev/">Psalm.dev</a>
</div>
<p><br></p>
<p>Everyone writes about the benefits of these plugins, but <strong>how much do you pay for it</strong>?</p>
<p>&quot;It's free!&quot;</p>
<h2 id="Attention-Economy">Attention Economy</h2>
<p>Well, it's not. If you've never heard about <em>dopamine - notification</em> effect, read <a href="http://www.calnewport.com/blog/2017/10/02/are-you-using-social-media-or-being-used-by-it">Are You Using Social Media or Being Used By It?</a> by <em>Cal Newport</em>. This amazing guy helped me to <a href="/blog/2017/01/20/4-emotional-reasons-why-I-quit-my-twitter/">quit Twitter</a> and <a href="/blog/2017/09/25/3-non-it-books-that-help-you-to-become-better-programmer/#deep-work-by-cal-newport">go deeper</a> in topics I really care about in my life.</p>
<img src="/assets/images/posts/2019/plugin/addict.jpg">
<p>Basically, notifications turn your beautiful and dynamic brain capable of high abstract thinking to the <strong>brain of a heroin addict with instant feedback overloop</strong>.</p>
<p><br></p>
<p>Let's get back to our code again.</p>
<h3 id="What-Happens-When-we-Type-Code-in-PHPStorm-with-PHP-Code-Sniffer-plugin">What Happens When we Type Code in PHPStorm with PHP Code Sniffer plugin?</h3>
<img src="/assets/images/posts/2019/plugin/plugin.png">
<ul>
<li>we see an underscored text</li>
<li>we move our cursor above it (2 s)</li>
<li>we read the message (2 s)</li>
<li>we try to understand it (3 s)</li>
<li>we try to figure out what needs to be done to make it disappear (5-15 s)</li>
<li>we try it (2 s)</li>
</ul>
<p><strong>If we're lucky, it's gone</strong> under 15 seconds. If not, we get back to &quot;we try to understand it&quot; step.
In time, we get better, faster and we create a small database of &quot;message → solution&quot; in our brains. In a few weeks, we learn how to write perfect code without any underscores.</p>
<p>Then our team extends rule set with <a href="/blog/2018/04/09/try-psr-12-on-your-code-today/">PSR-12</a> and we have to upgrade our brain database. So we start to hate extending of coding standards and prefer less.</p>
<h2 id="Expensive-Fun">Expensive Fun</h2>
<p>Now the important question: do you know how expensive this is? If you have a boss who doesn't care about productivity and you can whatever you need without critical business thinking, <strong>stop reading</strong>, because you're primed to waste money by your work design.</p>
<p><strong>But if you're freelancer, or you pay your programmers or you desire to be effective by lazy</strong>, I have a comparison for you:</p>
<p>Without PHPStorm plugins, you have to run the tool manually in your command line <strong>once per git push</strong>:</p>
<ul>
<li>
<p>open command line (2 s)</p>
</li>
<li>
<p>run coding standard command (2 s)</p>
</li>
<li>
<p><strong>4 seconds per push</strong> vs <strong>15 seconds per 1 error + persisted database in your brain</strong></p>
</li>
</ul>
<p>What is cheaper in money and brain damage?</p>
<p><strong>Pro-lazy tip:</strong> I'm too lazy to type more than 2-3 chars manually, so I use <a href="https://blog.martinhujer.cz/have-you-tried-composer-scripts">composer scripts</a> and 2-3 chars long bash script shortcuts:</p>
<pre><code class="language-bash">cs
# aliased to vendor/bin/ecs check app packages tests

fs
# aliased to: vendor/bin/ecs check app packages tests --fix</code></pre>
<h2 id="Benefits-of-Deep-Work-and-Scaled-Automation">Benefits of Deep Work and Scaled Automation</h2>
<p><strong>Rule of the Thumb</strong>: If something requires your attention multiple times with same <em>A → B</em> operation, automate the change and delegate it.</p>
<p>PHP_CodeSniffer can actually report what should be changed, without any clear suggestion of how to change it (read-only). But PHP CS Fixer fixes the code by default, so you don't even have to think about the change. So using PHP CS Fixer manually is a pure waste of life and money.</p>
<p><br></p>
<p>And this just a very limited example of 1 programmer and 1 project. Most companies have multiple programmers and projects. *The waste of time for 10-programmer teams having 20 projects escalates quickly:</p>
<ul>
<li>plugin way: 15 seconds per one error <em> 10 programmers </em> 20 projects * (let's be optimistic) 50 errors per pull-request...</li>
<li>automated CI way: validate PR and click merge request - <strong>20-40 seconds per pull-request</strong></li>
</ul>
<p>In simple words: <em>exponential</em> costs vs <em>constant</em> costs</p>
<h2 id="Scale-to-Whole-PHP-World">Scale to Whole PHP World</h2>
<p>Now imagine all the PHP projects in the world. Which of those is faster?</p>
<p>Does it ring a bell? Now think about the same way about instant upgrades or refactoring?</p>
<p>If there will be Rector plugin for PHPStorm (I honestly hope it won't), <strong>you'd have to find every <a href="/blog/2019/04/15/pattern-refactoring/">new pattern</a> there is in your project, again manually and randomly in your PHP files</strong> and hit the &quot;refactor&quot; button.</p>
<p>If you're effective, lazy and don't want to produce waste, you'll run:</p>
<pre><code class="language-bash">vendor/bin/rector process src</code></pre>
<p>And save millions of your brain cells :)</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/06/24/do-you-use-php-codesniffer-and-php-cs-fixer-phpstorm-plugin-you-are-slow-and-expensive</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 24 Jun 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/06/24/do-you-use-php-codesniffer-and-php-cs-fixer-phpstorm-plugin-you-are-slow-and-expensive#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 7 News and Changes in Symplify 6 ]]></title>
                <link>https://tomasvotruba.com/blog/2019/06/20/7-news-and-changes-in-symplify-6</link>
                <description><![CDATA[ <p>Do you use Easy Coding Standard, Package Builder or Statie? Do you need to upgrade safely? <strong>Do you want to benefit from new features?</strong>
<br>
<br>
This post shows 7 news and changes, that might affect you (in a good way).</p> ]]></description>
                <content:encoded><![CDATA[ <p>What is <strong>new</strong>?</p>
<h2 id="EasyCodingStandard">EasyCodingStandard</h2>
<h3 id="1-Run-Checker-only-on-Specific-Path">1. Run Checker only on Specific Path</h3>
<p><a href="https://github.com/symplify/symplify/pull/1537" class="btn btn-dark btn-sm pull-right mt-2 mb-2">
&nbsp;
See PR #1357
</a></p>
<p><strong>I really love this feature, because it makes a lot of custom boiler code go away.</strong></p>
<p>In old <em>Symplify 5</em>, when you needed to run sniff only on <code>/tests</code>, you had to create own config, e.g. <code>ecs-only-for-tests.php</code> and run it separately.</p>
<pre><code class="language-bash">vendor/bin/ecs check src --config ecs.php
vendor/bin/ecs check tests --config tests-only-ecs.php</code></pre>
<p>That was way too complicated, right?</p>
<p><br></p>
<p>In new <em>Symplify 8</em>, you can use just one config with <code>only</code> option instead:</p>
<pre><code class="language-php">// ecs.php

use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\EasyCodingStandard\ValueObject\Option;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();

    // all rules must be registered
    $services-&gt;set(BasicSniff::class);
    $services-&gt;set(AnotherSniff::class);

    $parameters = $containerConfigurator-&gt;parameters();
    // here you can configure, what rules should only check particular paths
    $parameters-&gt;set(Option::ONLY, [
        AnotherSniff::class =&gt; [
            __DIR__ . '/tests/'
        ]
    ]);
};</code></pre>
<pre><code class="language-yaml">vendor/bin/ecs check src tests</code></pre>
<p>It's basically an inversion of <code>skip</code> parameter.</p>
<p><br>
<br>
<br></p>
<p>What has <strong>changed</strong>?</p>
<h3 id="2-yaml-php">2. <code>*.yaml</code> → <code>*.php</code></h3>
<p>As Symfony is <a href="https://github.com/symfony/symfony/issues/37186">moving to *.php</a> configuration, Symplify does too.</p>
<h2 id="EasyCodingStandard">EasyCodingStandard</h2>
<h3 id="3-Sets-are-Now-In-defined-in-SetList-Constants">3. Sets are Now In defined in <code>SetList</code> Constants</h3>
<p>Why? The sets are only string references, so its useless for human to remember them. Why not let IDE help us?</p>
<pre><code class="language-diff"> &lt;?php

 // ecs.php

 declare(strict_types=1);

 use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
+use Symplify\EasyCodingStandard\ValueObject\Option;
+use Symplify\EasyCodingStandard\ValueObject\Set\SetList;

 return function (ContainerConfigurator $containerConfigurator): void {
-    $containerConfigurator-&gt;import(__DIR__ . '/vendor/symplify/easy-coding-standard/config/php71.php');
+    $containerConfigurator-&gt;import(SetList::PHP_71);
 };</code></pre>
<h3 id="4-exclude-checkers-skip">4. <del>exclude_checkers</del> → <code>skip</code></h3>
<p>People confused this options and created <em>WTF</em> issues. That's why the <code>exclude_checkers</code> is now merged in <code>skip</code>, so you have less option names to remember:</p>
<pre><code class="language-diff"> // ecs.php
 use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
+use Symplify\EasyCodingStandard\ValueObject\Option;

 return function (ContainerConfigurator $containerConfigurator): void {
     $parameters = $containerConfigurator-&gt;parameters();
-    $parameters-&gt;set('exclude_checkers', [
+    $parameters-&gt;set(Option::SKIP, [
-        SomeFixer::class
+        SomeFixer::class =&gt; null,
     ]);
 };</code></pre>
<h2 id="PackageBuilder">PackageBuilder</h2>
<h3 id="5-Introducing-FinderSanitizer">5. Introducing <code>FinderSanitizer</code></h3>
<p>Do you like <code>SplFileInfo</code> that is 100 % sure the file exists? In that case, you use <code>Symplify\PackageBuilder\FileSystem\SmartFileInfo</code> instead of <code>SplFileInfo</code>. The easiest way to use it is via <code>FinderSanitizer</code> that is now available via <code>symplify/package-builder</code> package:</p>
<pre><code class="language-diff"> &lt;?php

 // ecs.php

 declare(strict_types=1);

 use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
+use Symplify\EasyCodingStandard\ValueObject\Option;

 return function (ContainerConfigurator $containerConfigurator): void {
     $services = $containerConfigurator-&gt;services();
-    $services-&gt;set(Symplify\EasyCodingStandard\Finder\FinderSanitizer);
+    $services-&gt;set(Symplify\PackageBuilder\FileSystem\FinderSanitizer);
 };</code></pre>
<h3 id="6-ConfigurableCollectorCompilerPass-AutowireArrayParameterCompilerPass">6. <del>ConfigurableCollectorCompilerPass</del> → <code>AutowireArrayParameterCompilerPass</code></h3>
<p>If you know collectors, you're using <code>ConfigurableCollectorCompilerPass</code>. It saves you so much time with configuration. The problem with that compiler pass, you still had to go to config to set it up, for no real advantage. And extra work for <a href="/blog/2019/02/14/why-config-coding-sucks/">no benefit sucks</a>. Also, there is big change someone will <a href="/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock/">forget it</a> and create a bug.</p>
<p>So instead, <em>Symplify 6</em> adds better system to pass collected services of certain type to single service - <strong><a href="/blog/2018/11/12/will-autowired-arrays-finally-deprecate-tags-in-symfony-and-nette/">autowired arrays</a></strong>:</p>
<pre><code class="language-diff">&lt;?php declare(strict_types=1);

 use Symfony\Component\DependencyInjection\ContainerInterface;
-use Symplify\PackageBuilder\DependencyInjection\CompilerPass\ConfigurableCollectorCompilerPass;
+use Symplify\PackageBuilder\DependencyInjection\CompilerPass\AutowireArrayParameterCompilerPass;

 final class AppKernel extends Kernel
 {
     protected function build(ContainerBuilder $containerBuilder): void
     {
-        $containerBuilder-&gt;addCompilerPass(new ConfigurableCollectorCompilerPass());
+        $containerBuilder-&gt;addCompilerPass(new AutowireArrayParameterCompilerPass());
    }
}</code></pre>
<p><a href="/blog/2018/11/12/will-autowired-arrays-finally-deprecate-tags-in-symfony-and-nette/">This post</a> explains how to use it without ever touching config again.</p>
<h2 id="CodingStandard">CodingStandard</h2>
<h3 id="7-RemoveUselessDocBlockFixer-NoSuperfluousPhpdocTagsFixer">7. <del>RemoveUselessDocBlockFixer</del> → <code>NoSuperfluousPhpdocTagsFixer</code></h3>
<p><code>RemoveUselessDocBlockFixer</code> was removed, since <a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer">PHP CS Fixer</a> now provides <code>NoSuperfluousPhpdocTagsFixer</code> with similar features:</p>
<pre><code class="language-diff"> // ecs.php
 use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

 return function (ContainerConfigurator $containerConfigurator): void {
     $services = $containerConfigurator-&gt;services();

-    $services-&gt;set(Symplify\CodingStandard\Fixer\Commenting\RemoveUselessDocBlockFixer::class);
+    $services-&gt;set(PhpCsFixer\Fixer\Phpdoc\NoSuperfluousPhpdocTagsFixer::class);
 };</code></pre>
<p>That's all. It was easy, right?</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/06/20/7-news-and-changes-in-symplify-6</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 20 Jun 2019 00:00:00 +0000</pubDate>
                                    <updated>2020-11-01UTC00:00:000</updated>
                    <atom:updated>Sun, 01 Nov 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sun, 01 Nov 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/06/20/7-news-and-changes-in-symplify-6#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to upgrade Meetup.com API to OAuth2 with Guzzle ]]></title>
                <link>https://tomasvotruba.com/blog/2019/06/17/how-to-upgrade-meetup-com-api-to-oauth2-with-guzzle</link>
                <description><![CDATA[ <p>I got an email from Meetup.com 5 days ago, that basically every API request will be paid since August 15, 2019. <strong>$ 30/month</strong>, that's like my phone bill.
<br>
<br>
<strong>95 % of data on <a href="https://friendsofphp.org">Friends Of Php</a> depend on Meetup.com API</strong> - updated daily. The website is free, so it might kill the content or I'd have to move to crawlers and hope for the lack of protection on Meetup.com against them.
<br>
<br>
<strong>Unless we use Oauth2 before August 15</strong>. I never used it, but how hard that can be, right?</p> ]]></description>
                <content:encoded><![CDATA[ <p>There is no information about Meetup.com API upgrade on <a href="https://medium.com/meetup">their blog</a>, so I'll share the email to give you an idea:</p>
<ul>
<li>
<p>API Keys will be replaced by OAuth: We will be removing API keys on August 15, 2019 and requiring you to <a href="https://www.meetup.com/meetup_api/auth">authenticate with OAuth</a>.</p>
</li>
<li>
<p>Move to OAuth soon for continued free API access: Until August 15, members will be able <a href="https://www.meetup.com/meetup_api/auth">to apply for OAuth access</a> free of charge. <strong>After August 15, anyone who wants to apply for API access through OAuth will need to have a <a href="https://www.meetup.com/pro">Meetup Pro account</a> in order to do so</strong>.</p>
</li>
</ul>
<p><br></p>
<h2 id="Documentation-vs-Code">Documentation vs. Code</h2>
<p>This is a simple task, that in the end has simple 15 lines of new code. But documentation turned it into almost 3 hours of work.</p>
<p>It seems like OAuth2 must be something very new, because Guzzle <a href="https://github.com/guzzle/oauth-subscriber">supports only Oauth (1)</a>. If the last commit in 2014 can be called &quot;supports&quot;.</p>
<p>After a bit of Googling if found <a href="https://github.com/kamermans/guzzle-oauth2-subscriber">kamermans/guzzle-oauth2-subscriber</a>. I tried to copy-paste the code</p>
<h3 id="Choose-Your-Path">Choose Your Path</h3>
<ul>
<li>Do you want to just read copy paste solution? Jump to <a href="#5-steps-to-guzzle-oauth2">5 Steps to Guzzle OAuth2</a> headline.</li>
<li>If you want to learn about writing software and documentation, keep on reading.</li>
</ul>
<h2 id="Fuck-up-1-Put-Oldest-First">Fuck-up #1: Put Oldest First</h2>
<p>Why would you put the newest content first, right? You know, like on Twitter, Facebook, basically any news, messages...</p>
<img src="/assets/images/posts/2019/oauth2/old_first.png" class="img-thumbnail">
<p>If you write a code that other people read, you should read <a href="https://www.amazon.com/Design-Everyday-Things-Donald-Norman/dp/1452654123">The Design of Everyday Things</a> or <a href="https://www.amazon.com/gp/product/0321965515">Don't Make Me Think</a></p>
<p>So now you can imagine I'm using the latest Guzzle 6 and trying to implement a solution for Guzzle 4 &amp; 5.</p>
<p><br></p>
<div class="card">
    <div class="card-body text-center bigger">
        👍 Rule of the thumb: <strong>put news and important information first</strong>.
    </div>
</div>
<h2 id="Fuck-up-2-Support-All-Versions">Fuck-up #2: Support All Versions</h2>
<p>Fuck-Up #1 is a natural consequence of trying to support multiple versions at one branch/tag. Instead of putting all code to one branch, <strong>let always the last branch support the latest LTS dependencies</strong>.</p>
<p><em>What does that mean?</em></p>
<p>Let's look at <a href="https://github.com/symfony/symfony">Symfony repository</a>. Instead of &quot;Symfony&quot; imagine any package that is version. Now there is Symfony 4, so there was version 3, 2, 1 in the past. Like Guzzle 6, 5, 4...</p>
<p>Now you've decided to upgrade and look for <code>CHANGELOG.md</code> (because you haven't heard about <a href="/blog/2019/02/28/how-to-upgrade-symfony-2-8-to-3-4/">Rector</a> yet):</p>
<img src="/assets/images/posts/2019/oauth2/symfony.png" class="img-thumbnail">
<p>But how do you upgrade from Symfony 3? In the latest branch, there is always <strong>context-aware information</strong>. Do you need any older version? Switch to branch <code>3.x</code> or <code>2.x</code>.</p>
<p>I love this, <strong>because it focuses on mainstream, providing minimal needed data, but also allows the same for minorities</strong>.</p>
<p>The Symfony docs does the same:</p>
<img src="/assets/images/posts/2019/oauth2/symfony_docs.png" class="img-thumbnail">
<p>I wrote about this in detail in <a href="/blog/2017/10/30/what-can-you-learn-from-menstruation-and-symfony-releases/">What can You Learn from Menstruation</a> post.</p>
<p><br></p>
<div class="card">
    <div class="card-body text-center bigger">
        👍 Rule of the thumb: <strong>never mix 2 major versions in one branch, unless LTS framework</strong>
    </div>
</div>
<h2 id="Fuck-up-3-Provide-more-solutions">Fuck-up #3: Provide more solutions</h2>
<p>After I figured out the <code>README</code> is not text for programmers but for detectives, I've found the code with middleware I though I was looking for:</p>
<pre><code class="language-php">&lt;?php

$oauth = new OAuth2Middleware($grant_type);

$stack = HandlerStack::create();
$stack-&gt;push($oauth);

$client = new Client([
    'auth'     =&gt; 'oauth',
    'handler'  =&gt; $stack,
]);</code></pre>
<p>This supposes to work... but instead I got as useless exceptions as &quot;cannot authenticate&quot;. After 60 minutes of trying, I went to sleep with frustration.</p>
<p>In the morning I've noticed little note:</p>
<img src="/assets/images/posts/2019/oauth2/alter.png" class="img-thumbnail">
<p>Tried it and it worked. WTF? Why there is a broken code first, then &quot;working alternative&quot; second?</p>
<p>This is a common problem with double complexity = exponential bugs. If you translate your website to English and German, it will have more translation bugs than the English-only version. Of course, German might be important to your business, but <strong>the alternative code has as little added value as having a website in American English and British English</strong>.</p>
<div class="card">
    <div class="card-body text-center bigger">
        👍 Rule of the thumb: <strong>don't create alternatives for mainstream, it mostly confuses people</strong>. People will always find alternatives themselves
    </div>
</div>
<h2 id="How-to-Write-Perfect-Documentation">How to Write Perfect Documentation?</h2>
<p>It's important to know, that I don't try to make this about the specific documentation, but rather about <em>any</em> open-source documentation and how it's written.</p>
<img src="/assets/images/posts/2019/oauth2/legacy.png" class="img-thumbnail" style="max-width:35em">
<p>If I'd be sending an invoice to my employer, it would look like this:</p>
<ul>
<li>2,5 hours - debugging documentation</li>
<li>0,5 hours - implementing OAuth2</li>
</ul>
<h3 id="How-to-Lower-Those-2-5-hours-to-15-minutes">How to Lower Those 2,5 hours to 15 minutes?</h3>
<p>Let's pause a bit and think - <strong>what do we really need, when we use the package for the first time</strong>?</p>
<ul>
<li>get a code that solves our problem (e.g. use OAuth2 with Guzzle to prevent paying $ for Meetup.com API)</li>
<li>solve it as fast as possible (e.g. in 30 minutes)</li>
<li>a code, that we can copy paste and it works (e.g. without looking for missing use statements - I just hate this!)</li>
<li>feel confident we understand the errors, so we can fix them ourselves (e.g. without StackOverflow, creating and issue on Github)</li>
</ul>
<p><br></p>
<p>If we agree on these as our priorities, then all we need is working piece of code.</p>
<h3 id="Be-Sure-the-Code-Works-without-Testing-it">Be Sure the Code Works without Testing it</h3>
<p><strong>How do we know the code is working?</strong></p>
<ul>
<li>it's tested</li>
<li>test passing</li>
<li>we can see test passing ourselves on Travis CI or Gitlab CI</li>
</ul>
<p>Instead of having documentation with text (= &quot;weak strings&quot;), the best would be:</p>
<ul>
<li>link to the code for Guzzle 6</li>
<li>link to test case for Guzzle 6</li>
<li>link to CI passing for a test case for Guzzle 6</li>
</ul>
<p>That's the perfect documentation, <strong>because we can skip the verification and detective part and trust it by validated contract</strong>.</p>
<p><br></p>
<p>Now finally to the solution ↓</p>
<h2 id="5-Steps-to-Guzzle-Oauth2">5 Steps to Guzzle Oauth2</h2>
<ul>
<li>Login to <a href="http://meetup.com">Meetup.com</a></li>
<li>Create new consumer here - <a href="https://secure.meetup.com/meetup_api/oauth_consumers">https://secure.meetup.com/meetup_api/oauth_consumers</a> - it's <em>credentials</em> actually</li>
<li>There you get Oauth key and secret</li>
<li>Have the latest <code>guzzle</code> + <code>oauth2-subscriber</code></li>
</ul>
<pre><code class="language-bash">composer require guzzlehttp/guzzle:^6.3
composer require kamermans/guzzle-oauth2-subscriber</code></pre>
<ul>
<li>Use Guzzle with Oauth2</li>
</ul>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

require __DIR__ . '/vendor/autoload.php';

use GuzzleHttp\Client;
use kamermans\OAuth2\GrantType\ClientCredentials;
use kamermans\OAuth2\OAuth2Middleware;

// get these here: https://secure.meetup.com/meetup_api/oauth_consumers
$meetupComOauth2Key = '123';
$meetupComOauth2Secret = 'ABC';

// boilerplate code for Oauth2
$oAuth2Client = new Client([
    // URL for access_token request
    'base_uri' =&gt; 'https://secure.meetup.com/oauth2/access',
]);

$oAuth2Config = [
    'client_id' =&gt; $meetupComOauth2Key,
    'client_secret' =&gt; $meetupComOauth2Secret,
];
$clientCredentials = new ClientCredentials($oAuth2Client, $oauthConfig);
$oAuth2Middleware = new OAuth2Middleware($clientCredentials);

// the main code
$client = new Client();
$client-&gt;getConfig('handler')-&gt;push($oAuth2Middleware);

// call anything
$response = $client-&gt;request('GET', '...');
var_dump($response);</code></pre>
<p>But does it still work?</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/06/17/how-to-upgrade-meetup-com-api-to-oauth2-with-guzzle</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 17 Jun 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/06/17/how-to-upgrade-meetup-com-api-to-oauth2-with-guzzle#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Don&#039;t Ever use Symfony Listeners ]]></title>
                <link>https://tomasvotruba.com/blog/2019/05/16/don-t-ever-use-listeners</link>
                <description><![CDATA[ <p>Another anti-pattern that deserves more attention than it has. I often see this in Symfony projects I consult and when I ask the dev <em>why</em> did he or she choose listener over subscriber, they don't really know - &quot;it was in the Symfony documentation, you can read it there&quot;.
<br><br>
Not good enough. <strong>So why you should never use a listener?</strong></p> ]]></description>
                <content:encoded><![CDATA[ <p>When we look into Symfony <a href="https://symfony.com/doc/current/event_dispatcher.html">EventDispatcher documentation</a>, this is the first YAML code we see:</p>
<pre><code class="language-yaml"># config/services.yaml
services:
    App\EventListener\ExceptionListener:
        tags:
            - { name: kernel.event_listener, event: kernel.exception }</code></pre>
<p>If I'd be in the process of learning Symfony, this would be my thoughts:</p>
<ul>
<li>&quot;I see that this option is the first one in the official Symfony documentation&quot;</li>
<li>&quot;Right above something called <em>Subscriber</em>&quot;</li>
<li>&quot;I guess I should use Listeners by default then. Why? For some unknown reason that only Symfony seniors know.&quot;</li>
</ul>
<p>Btw, there is not even &quot;Subscriber&quot; in the main headline!</p>
<img src="/assets/images/posts/2019/sub/listen_first.png" class="img-thumbnail">
<p>That's how you write a manipulative text if you wanted people to never use subscribers :).</p>
<h2 id="What-s-Wrong-With-Listeners">What's Wrong With Listeners?</h2>
<ul>
<li>Juniors will use Listeners by default (everywhere they can) ❌</li>
<li>YAML configs will get fat with listener configuration for basically no advantage ❌
<ul>
<li>Since <a href="/blog/2018/12/27/how-to-convert-all-your-symfony-service-configs-to-autodiscovery/">PSR-4 autodiscovery</a> this hurts config readability more then ever</li>
<li>You have to remember the YAML syntax for right registration</li>
<li>Do you know you have to tag it with <code>name</code> &amp; <code>event</code>?</li>
<li>Will <code>_autoconfigure: true</code> help you here?</li>
<li>What's the name of event - <code>kernel_exception</code> or <code>kernel.error</code>? Well, neither</li>
</ul></li>
<li>What will you do if name of Kernel event will change? ❌</li>
<li>How do you analyse it with PHPStan? ❌</li>
<li>How do you upgrade it with Rector, when Symfony will create a <a href="https://symfony.com/blog/new-in-symfony-4-3-simpler-event-dispatching">BC break</a> <a href="/blog/2020/05/25/the-bulletproof-event-naming-for-symfony-event-dispatcher/">change</a>? ❌</li>
<li>What if you decide to migrate to Laravel or the <em>new best framework X</em> later? ❌</li>
</ul>
<p>All these problems will shoot you or your colleague in the back in the future. <strong>You've just opened doors for 6 more possible bugs and problems</strong> to come to your project #carpeyolodiem.</p>
<p>Most of these problems are a result of config programming - <a href="/blog/2019/02/14/why-config-coding-sucks/">that just sucks</a>.</p>
<h2 id="Why-You-Should-Always-use-Event-Subscriber">Why You Should Always use Event Subscriber?</h2>
<p>Listeners have only one valid use case - it's a 3rd party code located in your <code>/vendor</code> and someone else wants you to use it with event of your choice in config, e.g.:</p>
<pre><code class="language-yaml"># config/services.yaml
services:
    Vendor\ThirdPartyProject\Listener\UseMeListener:
        tags:
            - { name: kernel.event_listener, event: kernel.exception }
            - { name: kernel.event_listener, event: kernel.view }</code></pre>
<p><br></p>
<p>If it would be a subscriber, it would be very similar to this:</p>
<pre><code class="language-php">&lt;?php

namespace App;

use Vendor\ThirdPartyProject\Listener\UseMeListener;
use Symfony\Component\HttpKernel\KernelEvents;
use Symfony\Component\EventDispatcher\EventSubscriberInterface;

final class YourListener extends UseMeListener implements EventSubscriberInterface
{
    public static function getSubscribedEvents()
    {
        return [
            KernelEvents::EXCEPTION =&gt; ['onKernelException'],
            KernelEvents::VIEW =&gt; ['onKernelView'],
        ];
    }
}</code></pre>
<p>What's wrong with this code? First, <code>UseMeListener</code> should be <a href="/blog/2019/01/24/how-to-kill-parents/"><code>final</code></a>, so you cannot break SOLID like this.</p>
<p>Let's take part by part.</p>
<h3 id="1-Validated-PHP-over-Config-Typos">1. Validated PHP over Config Typos</h3>
<pre><code class="language-php">$myEvents = [
    KernelEvents::EXCEPTION =&gt; ['onKernelException'],
    KernelEvents::VIEW =&gt; ['onKernelView'],
];</code></pre>
<ul>
<li>
<p>Using <code>KernelEvents::EXCEPTION</code> constant is <strong>a big win</strong>! Instead of some string a config that we cannot analyze nor refactor, we have a constant. If you create a typo like <code>KernelEvents::EXCEPTON</code>, you'll know. If you make a typo in a config? Good luck!</p>
</li>
<li>
<p>How is <code>'onKernelView'</code> string made? I have no idea. It's a convention name, that is somehow resolved from tag name in the config to a protected/public? local method that is called. We don't need that magic, right Mr. Potter?</p>
</li>
</ul>
<h3 id="2-Explicit-Services-instead-of-Circular-Coupled-Subscriber-Listener">2. Explicit Services instead of Circular-Coupled Subscriber/Listener</h3>
<p>If someone has created a listener that you can re-use, it's an anti-pattern already.</p>
<ul>
<li>Would you create a controller, that someone should call in another controller?</li>
<li>Or a command, that someone should use in their listener or controller?</li>
</ul>
<p>People actually do that, the <a href="https://stackoverflow.com/questions/31512200/calling-action-from-command">StackOverflow has dozens of questions like &quot;how to call command in a controller&quot; or &quot;how to controller in a command&quot;</a>.</p>
<h3 id="3-Don-t-Rape-Delegate">3. Don't Rape! Delegate</h3>
<p>Command, Controller, EventSubscriber, Listener - they all should be only delegating code to a model layer service. If you need to mutually call or inherit one in another, you're creating a code smell. That's a sign that you should <strong>decouple common logic to a service</strong> and pass it via constructor to both.</p>
<p>So instead of giving people the option to use your code wrong way, give them a service, they can call in e.g. the EventSubscriber.</p>
<h3 id="4-Let-Interface-take-the-Responsibility">4. Let Interface take the Responsibility</h3>
<p>EventSubscriber has own interface, that guides you:</p>
<pre><code class="language-php">&lt;?php

use Symfony\Component\EventDispatcher\EventSubscriberInterface;

final class MyCustomEventSubscriber implements EventSubscriberInterface
{
    public static function getSubscribedEvents()
    {
    }
}</code></pre>
<p>There is still a bit of magic... what should be in <code>getSubscribedEvents()</code> method? Honestly, I have no idea. I don't want to <a href="/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock/">remember what's written in code</a>. So I'll use PHPStorm:</p>
<img src="/assets/images/posts/2019/sub/event_names.gif" class="img-thumbnail">
<h2 id="What-s-Better-with-Event-Subscriber">What's Better with Event Subscriber?</h2>
<ul>
<li>No config coding and all the related possible bugs ✅</li>
<li>Adding new subscribers mean 0-work in config</li>
<li>Adding new subscribed event mean 0-work in config</li>
<li>No option to miss-use delegators ✅</li>
<li>Easy to statically analyse ✅</li>
<li>Easy to instantly upgrade ✅</li>
<li>Any Symfony BC break will be easy to discover due to unused constant in exact line of code ✅</li>
</ul>
<p>The trade-off worth the change</p>
<h2 id="Final-Unrelated-Tip-Constants-over-Strings">Final Unrelated Tip: Constants over Strings</h2>
<p>If you use <code>KernelEvents::VIEW</code> constants within PHP code, you make the code also easier to debug.</p>
<p>Where is <code>KernelEvents::VIEW</code> event actually dispatched? Just search <code>KernelEvents::VIEW</code> (or better <code>dispatch(KernelEvents::VIEW)</code>) in <code>/vendor</code> and PHPStorm will show you the exact line. If you'd look for a string, it will lead to a false source of <code>KernelEvents</code> (just a reference list of all Kernel events).</p>
<p>Also, when the event name is changed in a constant to <code>view_event</code>, you don't mind. If you have <code>view</code> in the config, good luck!</p>
<p>This makes using constants so fun. My rule of thumb is:</p>
<blockquote class="blockquote text-center mb-4 mt-4">
    When the same string is used at 2 different classes,
    <br>
    it's worth creating a constant to make it typo-proof.
</blockquote>
<p>Imagine you have some code like:</p>
<pre><code class="language-php"># in class A
$configuration-&gt;setOption('resource');

# in class B
$input-&gt;getOption('resource');</code></pre>
<p>Now you need to get this resource somewhere else. Was it &quot;source&quot;, &quot;sources&quot;, &quot;resource&quot; or &quot;directory&quot;? You don't care, constant autocomplete in PHPStorm tells you:</p>
<img src="/assets/images/posts/2019/sub/constant.gif" class="img-thumbnail">
<p><a href="/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock/">Don't remember what you don't need to</a>.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/05/16/don-t-ever-use-listeners</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 16 May 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/05/16/don-t-ever-use-listeners#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Hidden Gems of PHP Packages: Psalm Fixing Your Code ]]></title>
                <link>https://tomasvotruba.com/blog/2019/05/13/hidden-gems-of-php-packages-psalm-fixing-your-code</link>
                <description><![CDATA[ <p>Psalm is a static analyzer of PHP code originated at Vimeo and developed by <a href="https://github.com/muglug">Muglug</a>. It can analyze your code for incorrect type declarations or unused code.
<br><br>
But did you know it can automatically fix these issues?</p> ]]></description>
                <content:encoded><![CDATA[ <p>I did not and I was surprised. Psalm added this feature long time ago in March 2018 (as <a href="https://www.reddit.com/r/PHP/comments/84xrgy/fixing_code_that_aint_broken_vimeo_engineering">reported on Reddit</a>)! I was also surprised because static analyzer is read-only tools - &quot;here is error → fix it yourself manually&quot;</p>
<h2 id="Static-Analyzers-Evolving-to-Code-Fixers">Static Analyzers Evolving to Code Fixers</h2>
<p><strong>But it's not an unexpected development.</strong> As I wrote in <em><a href="/blog/2018/10/22/brief-history-of-tools-watching-and-changing-your-php-code/">Brief History of Tools Watching and Changing Your PHP Code</a></em>, coding standard tools were <em>read-only</em> too and you had to change all the spaces manually. That was so annoying with large code-bases and many programmers didn't adopt it because it added the extra work on a daily basis, instead of saving time.</p>
<p>In response to this pressure, they <strong>had to become more useful by working for the programmer</strong>. PHP CS Fixer fixed code from the very first commit and PHP_CodeSniffer added this feature in response.</p>
<p>We can assume PHPStan and Phan will follow Psalm path since human-fixing is hard to scale and will become annoying in time compared to automated instant upgrades.</p>
<p><br></p>
<p>So what Psalm can do for you?</p>
<h2 id="1-Missing-Type-Declaration">1. Missing Type Declaration?</h2>
<p>Do you know that feeling when PHPStan reports &quot;Method X is returning an int, but should be a string&quot; in 10 000 places? Yes, you can use <a href="/blog/2019/04/22/hidden-gems-of-php-packages-srab/">Baseliner</a> to ignore them and check only new code, <strong>but that only postpones the problem</strong>. One day there still will be 3-4 days of full-time boring work ahead of you.</p>
<pre><code class="language-php">/**
 * @return int
 */
function foo()
{
  return 'hello';
}</code></pre>
<p>That's what Psalm fixes for you and even adds the return type declaration:</p>
<pre><code class="language-diff">-/**
- * @return int
- */
-function foo()
+function foo(): string
 {
   return 'hello';
 }</code></pre>
<h3 id="How-to-Run-it">How to Run it?</h3>
<p>Just use binary with <code>--alter</code> (that says &quot;fix&quot; this) + the <code>--issues</code> option:</p>
<pre><code class="language-bash">vendor/bin/psalm src --alter --issues=MissingReturnType
vendor/bin/psalm src --alter --issues=MissingClosureReturnType
vendor/bin/psalm src --alter --issues=InvalidReturnType
vendor/bin/psalm src --alter --issues=InvalidNullableReturnType</code></pre>
<p>The docs doesn't say if they stack together, but I'd assume so by the plural in &quot;issues&quot;:</p>
<pre><code class="language-bash">vendor/bin/psalm src --alter --issues=MissingReturnType,MissingClosureReturnType,InvalidReturnType,InvalidNullableReturnType</code></pre>
<h2 id="2-Falseable-Strings">2. Falseable Strings?</h2>
<p>Though the same kind of <em>detect type → complete it</em> logic, this example is really nice:</p>
<pre><code class="language-php">function foo(): string {
  return rand(0, 1) ? 'hello' : false;
}</code></pre>
<p>↓</p>
<pre><code>/**
 * @return string|false
 */
function foo() {
  return rand(0, 1) ? 'hello' : false;
}</code></pre>
<h2 id="3-Unused-Property-or-Method">3. Unused Property or Method?</h2>
<p>I wish this would be run before each code-review. Imagine you decouple a method during refactoring and stop using one of the existing methods in the same class. A dead method is born. <strong>A dead method that you need to maintain, test and upgrade to new version of PHP or your framework.</strong></p>
<p>Not anymore.</p>
<pre><code class="language-diff"> class A {
-     private function foo() : void {}
-     protected function bar() : void {}
-     public function baz() : void {}
 }

 new A();</code></pre>
<p>Same goes for properties:</p>
<pre><code class="language-diff"> class A {
-    /** @var string */
-    public $foo;

-    /** @var string */
-    protected $bar;
 }

 new A();</code></pre>
<h3 id="How-to-Run-it">How to Run it?</h3>
<pre><code class="language-bash">vendor/bin/psalm src --alter --issues=UnusedMethod
vendor/bin/psalm src --alter --issues=PossiblyUnusedMethod
vendor/bin/psalm src --alter --issues=UnusedProperty
vendor/bin/psalm src --alter --issues=PossiblyUnusedProperty</code></pre>
<h2 id="4-Undefined-Variable">4. Undefined Variable?</h2>
<p>How do you like this code?</p>
<pre><code class="language-php">if (rand(0, 1)) {
  $a = 5;
}
echo $a;</code></pre>
<p>Ups, <code>$a</code> is not defined (sometimes).</p>
<p>PHPStorm would tell you what's wrong with this code if you'd be writing this code. But again, it adds you extra manual work and doesn't <del>check</del> fix the rest of your huge code base from your CI.</p>
<p>Psalm can:</p>
<pre><code class="language-diff">+$a = null;
 if (rand(0, 1)) {
   $a = 5;
 }
 echo $a;</code></pre>
<p>If you're into static analysis, you know it's very hard to examine this flow of control and moreover add the variable not just the beginning of file or method, but to the right place where you or I would add it.</p>
<p>Cudos to <a href="https://github.com/muglug">Mathew</a>! 👍</p>
<h3 id="How-to-Run-it">How to Run it?</h3>
<pre><code class="language-bash">vendor/bin/psalm src --alter --issues=PossiblyUndefinedVariable</code></pre>
<h2 id="Check-all-13-of-them">Check all 13 of them</h2>
<p>At the time of writing this post, there is 13 issue alters now. I believe we can expect up to 100 more in next year or two.</p>
<p>You can run them all like this:</p>
<pre><code class="language-bash">vendor/bin/psalm src --alter --issues=all</code></pre>
<p><strong>Read about them and about extra options like <code>--php-version</code>, <code>--dry-run</code> or <code>--safe-types</code> in <a href="https://psalm.dev/docs/fixing_code">very beautiful and short documentation</a></strong>.</p>
<h2 id="Try-it-Even-if-you-use-PHPStan">Try it, Even if you use PHPStan</h2>
<p>Personally, I use PHPStan because I'm not good with XML. But even if I should <strong>install Psalm just to complete type-declarations and remove dead code</strong>, it's worth the 10 minutes time to set it up. Give a try, it's huge time saver the bigger code base you have.</p>
<p>You don't have to take my word for it:</p>
<blockquote class="twitter-tweet mt-5 mb-5" data-lang="en"><p lang="en" dir="ltr">Damn, <a href="https://twitter.com/psalmphp?ref_src=twsrc%5Etfw">@psalmphp</a> type declarations are saving me *TONS* of time and testing.</p>— null (@Ocramius) <a href="https://twitter.com/Ocramius/status/1120797947921350656?ref_src=twsrc%5Etfw">April 23, 2019</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p><br></p>
<p>This is the future = PHP tools working for us - enjoy it :)</p>
<p><br><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/05/13/hidden-gems-of-php-packages-psalm-fixing-your-code</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 13 May 2019 00:00:00 +0000</pubDate>
                                    <updated>2019-06-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Jun 2019 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Jun 2019 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/05/13/hidden-gems-of-php-packages-psalm-fixing-your-code#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Is Rector Saving you Time? Support it on GitHub Sponsors ]]></title>
                <link>https://tomasvotruba.com/blog/2019/05/09/is-rector-saving-you-time-support-it-on-patreon</link>
                <description><![CDATA[ <p>Rector's mission is to upgrade anything you want. It already can upgrade PHP 5.3 all the way to PHP 7.4 (we've added arrow functions yesterday to php-parser and today to Rector), Symfony from 2.8 to 4.3, remove code that does nothing, import namespaces in a smart way and 29 more levels.
<br><br>
I've started project 2 years ago as a small idea challenge and I'm creating Rector in my free time. I think every Rector rule ever created should be free for everyone and for a that I need your help.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Rector can squash time that requires migration of 100 000 lines of code from 2-3 months to 5 days. We already made that happen <a href="/blog/2019/08/26/how-we-migrated-54-357-lines-of-code-nette-to-symfony-in-2-people-under-80-hours/">with Nette to Symfony migration</a>.</p>
<p>I want to make Rector even better - make <strong>migration of legacy code more affordable to anyone</strong>, let you instantly upgrade from an old framework that is not supported over 5 years to the newest version or even switch from framework that is no more useful to you to a one you want to use for age.</p>
<p>In the end, Rector should be the next member of your team that you will throw all the boring work at.</p>
<p>To be able to do that, I have to focus my time to work on private commercial projects and fund the Rector development from them.</p>
<h2 id="Legacy-Code"><del>Legacy Code</del></h2>
<p>When I look at Reddit, I see many questions regarding legacy PHP code with PHP 5.3, <code>mysql</code>, PHP templates, Zend 1, Symfony 1 (well anything <em>1</em>), own proprietary framework, that no-one wants to work with and when they complain to the boss, they get rejected: &quot;I can't afford it&quot;. It hurts me to see stories like this.</p>
<blockquote class="blockquote mt-4 mb-4 text-center">
    "Every line code becomes legacy in the second it's written."
</blockquote>
<p>But even if you run on PHP 7.3 and Symfony 4.2, Cake 3.7 or Laravel 5.8, in 2 years we'll call it &quot;legacy code&quot;.</p>
<p>Rector can make remove &quot;legacy code&quot; from our dictionaries. For that, I need your help!</p>
<div class="text-center mt-5 mb-3">
<h2 class="text-center">Do you find Rector useful?</h2>
<p><a href="https://github.com/sponsors/TomasVotruba" class="btn btn-success btn-lg mt-2 mb-4">
Support us on GitHub Actions
</a></p>
</div>
<p><br></p>
<h2 id="One-Time-Donation">One-Time Donation</h2>
<p>Aren't you sure about long-term contribution of Rector for you but still want to say &quot;thank you&quot;?
Use ↓</p>
<p><a href="https://www.paypal.me/rectorphp" class="btn btn-primary mt-2">
One-Time donation through PayPal
</a></p>
<p><br></p>
<p>Thank you! ❤️️</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/05/09/is-rector-saving-you-time-support-it-on-patreon</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 09 May 2019 00:00:00 +0000</pubDate>
                                    <updated>2021-05-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 May 2021 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 May 2021 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/05/09/is-rector-saving-you-time-support-it-on-patreon#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ End of goPhp71.org ]]></title>
                <link>https://tomasvotruba.com/blog/2019/05/06/end-of-gophp71-org</link>
                <description><![CDATA[ <p>I <a href="/blog/2017/06/05/go-php-71/">launched goPhp71.org</a> in June 2017, just 6 months after release of PHP 7.1. In those times nobody was sure what version to require - 7.1? 7.0? Or wait for 7.2?
<br>
<br>
Future is now. There is no need for the initiative now and it's time to <a href="https://zenhabits.net/letting-go">let it go</a>.
<br>
<strong>How much did it cost? What was the effect? Was it worth it?</strong> I'll share answers to these question so you know what to expect when you start a similar project. Let's get numberz!</p> ]]></description>
                <content:encoded><![CDATA[ <p>When I bought the <code>gophp71.org</code> domain, I had no idea what it will become. You know, try to tell the whole PHP open-source community what min version should they use in <code>composer.json</code>, right? Explain why it's a good idea to work as a community to people you've never met. <strong>But when I saw <a href="https://www.garfieldtech.com/blog/go-php-5-go">Go PHP 5</a> I felt it's my duty to give back to PHP community and help with PHP 7.1.</strong></p>
<p>Today it's gonna about numbers, how well PHP community works together and few of mine fuck-ups :)</p>
<h2 id="How-Much-Did-it-Cost">How Much Did it Cost?</h2>
<ul>
<li>Domain <code>gophp71.org</code>? - 15 $ per year, 2 years = <strong>30 $</strong> in total</li>
<li>Hosting? <strong>0 $</strong> Thanks to <a href="https://github.com/tomasVotruba/gophp71.org">Github Pages hosting</a> and <a href="https://www.statie.org">static site generator Statie</a></li>
<li>And the work? I didn't Toggle it, but with all the design iterations, posts and commenting all over the internet <strong>I'd say ~25-30 hours</strong>. As you can guess, I'm very bad at tuning CSS for mobiles. Use your own hourly rate to have the idea in $.</li>
</ul>
<h2 id="What-was-The-Impact">What was The Impact?</h2>
<p>I took a while. Thanks to Jordi (thank you!), we have numbers on min. required PHP version on Packagist:</p>
<ul>
<li><a href="https://seld.be/notes/php-versions-stats-2017-1-edition">May 2017</a> - 1,7 %</li>
<li><a href="https://seld.be/notes/php-versions-stats-2017-2-edition">November 2017</a> - 5,3 % (+ 218 % compared to previous 6 months)</li>
<li><a href="https://seld.be/notes/php-versions-stats-2018-1-edition">May 2018</a> - 11,8 % (+ 121 %)</li>
<li><a href="https://blog.packagist.com/php-versions-stats-2018-2-edition">November 2018</a> - 19,4 % (+ 64 %)</li>
</ul>
<p>Is 19,4 % to small for you?</p>
<p><strong>What about 38 528?</strong> That's the absolute number of packages that required PHP 7.1 in <a href="https://packagist.org/statistics">November 2018</a>.</p>
<p><br></p>
<p>I look forward to May 2019 stats update coming anytime soon.</p>
<h2 id="Correlation-Causality">Correlation !== Causality</h2>
<p>I don't think one website changed the PHP world. We made it together as one community. I tried to convince <em>David</em> from PHP 7.0 to PHP 7.1 over lunch. I thought I lost him not having enough arguments and <em>Nette</em> will go with PHP 7.0. <strong>Later that month Nette went 7.1</strong> as one of the first PHP frameworks - it was not stable, but still had a big effect on Czech open-source maintainers 👍</p>
<p>There was a sparkle of hope this might work.</p>
<p><br></p>
<p><strong>Fabien from Symfony helped</strong> <a href="https://twitter.com/fabpot/status/851558576770252800">by opening a pool on Twitter</a>:</p>
<img src="/assets/images/posts/2019/go-php-die/symfony_pool.png">
<p>Over 1000 people helped this in that pool! To sum it up - 1003 specific people so far 👍</p>
<p><br></p>
<p><strong>Doctrine team also helped</strong> with <a href="https://www.doctrine-project.org/2017/07/25/php-7.1-requirement-and-composer.html">PHP 7.1 announcement</a> for all their packages. They also explained very nicely <em>Why dropping PHP support in a minor version is not a BC break</em> 👍</p>
<blockquote class="blockquote mb-5 mt-5">
"A BC break happens when there is an incompatible change that your package manager can't handle. For example, changing a method signature in a minor version is a no-go, since the composer version constraints mentioned above assume any minor upgrade can safely be used."
</blockquote>
<p>Remember this quote, we'll need it when we'll go PHP 8.1 (maybe?) later.</p>
<p><br></p>
<p><a href="https://github.com/TomasVotruba/gophp71.org/graphs/contributors"><strong>Over 19 PHP projects</strong></a> have added their go PHP 7.1 statement to the website in the 1st year. Thank you' all! 👍</p>
<img src="/assets/images/posts/2019/go-php-die/most_active.png" class="img-thumbnail">
<p>Last but not the least, <strong><a href="https://www.reddit.com/r/PHP/comments/6xqa23/go_php_71">the_alias_of_andrea</a> helped</strong> spread the news on Reddit 👍</p>
<img src="/assets/images/posts/2019/go-php-die/reddit.png">
<p><br></p>
<p>&quot;Sure Tom, good job... you're the best, but we're really reading just for your fuck-ups.&quot;</p>
<p>All right...</p>
<h2 id="What-I-Fucked-Up">What I Fucked Up?</h2>
<h3 id="Too-Complicated-Wording">Too Complicated Wording</h3>
<p>I wrote &quot;add your project too&quot; instructions on the website, so all projects could join. <strong>I learned that people don't understand my complicated thoughts</strong>.</p>
<p>Instead of keeping it as simple as:</p>
<ul>
<li>&quot;Add your project if you require PHP 7.1 in the stable release&quot;</li>
</ul>
<p>I created a mess like this:</p>
<ul>
<li>&quot;Add your project if you have PHP 7.1 in the <code>composer.json</code> file. It doesn't matter it's not stable yet. If it's not stable yet, add <em>released: no</em> to the configuration file. But remember to update this website, when you finally decide to use a stable tag. Also, add some link to the statement, so we can read about it a bit more. I hope it's not too much to ask you to follow these very few simple steps. I really tried to make them very easy, as you can see. Thank you&quot;</li>
</ul>
<p>That led to hanged PRs, manual <em>yes/no</em> corrections that didn't have much-added value and confused comments from contributors (I'm sorry about that).</p>
<h3 id="Too-Late">Too Late</h3>
<p><strong>I fucked up timing.</strong> PHP 7.1 was released in December 2016, yet <code>gophp71.org</code> was not launched until 7 months later.
I had the idea before, but <strong>I was afraid how will you react</strong>. I had thoughts like &quot;Who the hell is this Votruba and why does he think he is that he tells us what PHP version should we use?&quot; or &quot;Do you want us to go PHP 7.1? Well, we'll go PHP 7.0 on one project and PHP 7.2 on the other, a-ha!&quot; or &quot;What is he selling us? That's some version conspiracy!&quot;</p>
<p>Now I see that was stupid. I should start earlier, try it, give a go and adapt upon the feedback.</p>
<p><br></p>
<p>That's all folks, hope you enjoyed it! I sure did start almost 24 months ago with just this:</p>
<img src="/assets/images/posts/2017/go-php-71/first-version.png">
<h2 id="What-s-Going-to-be-Next">What's Going to be Next?</h2>
<p>Will we &quot;Go PHP 8&quot;? Someone from Arizona, US <a href="https://gophp8.org">already bought the <code>gophp8.org</code> domain</a>.
Or 8.1, when 8 becomes more mature?</p>
<p>Who knows. All I know <strong>I'm very happy to be part of our PHP <del>community</del> family ❤️️, where we support each other despite our differences and work together when we need to</strong>.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/05/06/end-of-gophp71-org</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 06 May 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/05/06/end-of-gophp71-org#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Alias as a Code Smell ]]></title>
                <link>https://tomasvotruba.com/blog/2019/05/02/alias-as-a-code-smell</link>
                <description><![CDATA[ <p>Do you have 2 class with the same name? <code>App\Entity\Product</code> and <code>App\Entity\Product</code>? Of course not. But <strong>I bet you have at least 2 classes with the same <em>short name</em> <code>*\Product</code> and <code>*\Product</code></strong>.
<br>
<br>
And that smells... Why?</p> ]]></description>
                <content:encoded><![CDATA[ <p>In recent projects, I consult I start to notice an interesting pattern. It's how important are uniquely named short classes. Short class name = the part after last <code>\</code>.</p>
<p>How would you like to use this code?</p>
<img src="/assets/images/posts/2019/alias/too_many.gif" class="img-thumbnail">
<h2 id="Duplicated-Short-Classes-sponsored-by-DDD">Duplicated Short Classes sponsored by DDD</h2>
<p>When I ask why the programmer picked such a naming, more often than not they refer DDD patterns, where you don't care if the element is interface, trait or abstract. The naming is always the same. Do you know which of them is class, interface, category Query and product Query?</p>
<ul>
<li><code>Query</code></li>
<li><code>Query</code></li>
<li><code>Query</code></li>
<li><code>Query</code></li>
</ul>
<p><br></p>
<p>Now the programmer has to become a detective.</p>
<ul>
<li><code>Query</code> → see the namespace, oh it's a <code>/Contract</code>, that's probably an interface</li>
<li><code>Query</code> → oh, the namespace is <code>/Behavior</code>, that's probably a trait</li>
<li><code>Query</code> → see the file location, it's in <code>/Model/Category</code>, that's probably a category query</li>
<li><code>Query</code> → see the file location, it's in <code>/Model/Product/Contract</code>, that's probably a product query interface</li>
</ul>
<p>Good job! The <strong>code starts to steal time and energy</strong> the reader 🤦.</p>
<h2 id="Make-it-Clear-with-Aliases">Make it Clear with Aliases?</h2>
<p>Luckily, there is a band-aid to this problem, aliases!</p>
<pre><code class="language-php">&lt;?php

namespace App;

use App\Behavior\Query as QueryTrait;
use App\Model\Category\Query as CategoryQuery;
use App\Model\Product\Contract\Query as ProductQueryInterface;
use App\Contract\Query as QueryInterface;

final class ProductQuery implements ProductQueryInterface, QueryInterface
{
    use QueryTrait;

    public function findByCategoryQuery(CategoryQuery $categoryQuery)
    {
        // ...
    }
}</code></pre>
<p>Now we have 200 % more code and but it's a bit more clear.</p>
<blockquote class="blockquote mt-4 mb-4 text-center">
    When you see an alias, and it's not for 3rd party code,
    <br>
    you have a code smell in there.
</blockquote>
<p>Get rid of it!</p>
<h2 id="Use-Your-Common-Sense">Use Your Common Sense</h2>
<p>If you see a car of Tesla, you'd probably name it &quot;Tesla car&quot;. Not a &quot;car&quot;.</p>
<p><strong>Get rid of aliases and name your classes in a unique and clear way:</strong></p>
<pre><code class="language-php">&lt;?php

namespace App;

use App\Behavior\QueryTrait;
use App\Model\Category\CategoryQuery;
use App\Model\Product\Contract\ProductQueryInterface;
use App\Contract\QueryInterface;

final class ProductQuery implements ProductQueryInterface, QueryInterface
{
    use QueryTrait;

    public function findByCategoryQuery(CategoryQuery $categoryQuery)
    {
        // ...
    }
}</code></pre>
<h2 id="Automated-Smell-Detection">Automated Smell Detection</h2>
<p>Do you need to help to find these smells? Just add <code>NoDuplicatedShortClassNameRule</code> to your coding standard:</p>
<pre><code class="language-yaml"># phpstan.neon
rules:
    - Symplify\CodingStandard\Rules\NoDuplicatedShortClassNameRule</code></pre>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/05/02/alias-as-a-code-smell</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 02 May 2019 00:00:00 +0000</pubDate>
                                    <updated>2020-08-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Aug 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Aug 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/05/02/alias-as-a-code-smell#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Rector European Tour in May &amp; June 2019 ]]></title>
                <link>https://tomasvotruba.com/blog/2019/04/29/rector-european-tour-in-may-june-2019</link>
                <description><![CDATA[ <p>I asked Łukasz Chruściel if we see each other on one of the conferences I'm coming with Rector and he's like: &quot;I haven't noticed any announcements that you will talk somewhere. Did you set up any long distance trip?&quot;
<br><br>
Ops, I forgot to tell you. Let's fix it because I'd love to meet you and hear about your pain points.</p> ]]></description>
                <content:encoded><![CDATA[ <p><strong>I'd love to thank all people that support Rector, use it in their daily work and continuous integration</strong>. It took a while to get the attention of everyday use. I visited only 1 conference with Rector in 2018, but now <strong>it seems the side is turning</strong>.</p>
<div class="text-center">
    <img src="/assets/images/posts/2019/tour/rector-daily.png" class="img-thumbnail mt-4">
    <em>Rocketing Rector downloads on Packagist</em>
</div>
<p><br></p>
<p>I'm not sure who bribed all these folks, <strong>but this year I got accepted to 6 amazing conferences</strong>. I had to turn <a href="https://www.neoscon.io">Neos Conference</a> down with my deepest apologies, because I couldn't fit the flight to another conference in the same day.</p>
<p><strong>I'll visit 5 different countries in 30 days</strong>. I never traveled so much and so far in a month. I look forward to all these new countries and even more <strong>I look forward to you PHP folks</strong>!</p>
<p>I already missed a flight this year, so let's hope it will not <a href="/blog/2018/10/18/how-i-almost-missed-my-talk-in-php-asia-conference/">happen again</a>.</p>
<div class="text-center">
    <img src="http://getrector.org/assets/images/logo/rector-no_frame_vector.svg" style="width: 7em" class="mt-5">
</div>
<h2 id="Where-Exactly">Where Exactly?</h2>
<p>There are exact days and places where I'll present my Rector talk:</p>
<ul>
<li>Verona, Italy - <a href="https://2019.phpday.it">PHP Day</a> - <strong>May 10</strong></li>
<li>Moscow, Russia - <a href="https://phprussia.ru/2019">PHP Russia</a> - <strong>May 17</strong></li>
<li>Berlin, Germany - <a href="https://githubsatellite.com">Github Satelite</a> - <strong>May 23</strong> (just hanging out without talk)</li>
<li>Kiev, Ukraine - <a href="https://fwdays.com/en/event/php-fwdays-2019">PHP fwdays</a> - <strong>Jun 1</strong></li>
<li>Berlin, Germany - <a href="https://phpconference.com">PHP Conference</a> - <strong>Jun 4</strong></li>
<li>Amsterdam, Netherlands - <a href="https://www.phpconference.nl">Dutch PHP Conference</a> - <strong>Jun 8</strong></li>
</ul>
<p>I'll usually visit the city for 2 days around that date.</p>
<div class="text-center">
    <img src="/assets/images/talk_dresden.jpg" style="width: 30em" class="mt-4 img-thumbnail">
    <br>
    <em>This is how I look nowadays</em>
</div>
<h2 id="Let-s-Meet-and-Talk">Let's Meet and Talk</h2>
<p>I'll have limited time, but if you'll <a href="https://api.whatsapp.com/send?phone=420776778332&amp;text=Hi%20Tom,%20I&#039;d%20love%20to%20meet%20you%20at%20the%20conference%20:">WhatsApp me</a> (or <a href="/contact">call/mail</a> me), I'd love to grab a beer and talk with you.</p>
<p><strong>We can talk about</strong> Rector, legacy code, good coffee, communities, traveling, dnb, trains, psychology, mentoring, polyphasic sleep, intuitive education, artificial intelligence, children, 10x programming... whatever comes to our minds :)</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/04/29/rector-european-tour-in-may-june-2019</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 29 Apr 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/04/29/rector-european-tour-in-may-june-2019#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Don&#039;t Give Up Your PHP Code for Compiler Passes so Easily ]]></title>
                <link>https://tomasvotruba.com/blog/2019/04/25/don-t-give-up-your-php-code-for-compiler-passes-so-easily</link>
                <description><![CDATA[ <p>Sometimes you need to achieve very simple operation - e.g. get all services of a certain type in a certain order or key name. When we start to use a PHP framework, we tend to underestimate our PHP skills and look for <em>the framework</em> way.
<br><br>
<strong>Who cares if we use 50 lines in 3 files PHP files and 1 YAML file instead of 1 factory in 20 lines.</strong> We're cool!</p> ]]></description>
                <content:encoded><![CDATA[ <p>This mini-series started in <a href="/blog/2019/02/14/why-config-coding-sucks/">Why Config Coding Sucks</a>. <strong>There we learned to move <del>weakly</del> un-typed strings to strict-typed PHP code</strong>. It's not only about YAML or NEON files, but about any config-like syntax in general (XML, in...).</p>
<p>Today we move to PHP-only land, that suffers a similar problem.</p>
<h2 id="What-We-Talk-About">What We Talk About?</h2>
<p>So we talk about <a href="https://symfony.com/doc/current/service_container/compiler_passes.html">Compiler Passes in Symfony</a>? Well, yes and no. Not only about them, but about any PHP code that moves around services in the DI container.</p>
<ul>
<li>in Nette it's a class that extends <a href="/blog/2017/02/15/minimalistic-way-to-create-your-first-nette-extension/"><code>CompilerExtension</code></a></li>
<li>in Symfony it's class that implements <a href="https://github.com/symfony/symfony/blob/fba11b4dc34e7c589d8c30d5b6a090387d52e648/src/Symfony/Component/DependencyInjection/Compiler/CompilerPassInterface.php"><code>CompilerPassInterface</code></a> or extends <a href="https://github.com/symfony/symfony/blob/fba11b4dc34e7c589d8c30d5b6a090387d52e648/src/Symfony/Component/DependencyInjection/Extension/Extension.php"><code>Extension</code></a></li>
<li>in Laravel it can be <a href="https://laravel.com/docs/master/providers">service providers</a></li>
</ul>
<p>They have their useful use-cases, but people tend them to use <em>as a bazooka to mouse</em>. Just look at <a href="https://stackoverflow.com/questions/54590981/symfony-4-how-to-access-the-service-from-controller-without-dependency-injectio">answers under this StackOverflow question</a>.</p>
<p><br></p>
<p>Let's look at an example that is not far from the reality of your work with. But still it's only an example, it could be apples in a basket instead.</p>
<h2 id="Make-Price-Calculation-easy-to-Extend-and-Maintain-without-Changing-it">Make Price Calculation easy to Extend and Maintain without Changing it</h2>
<p>Based on <a href="/trainings">my experience with my clients</a>, this is the biggest problem in e-commerce projects. The ideal wishes of company owners clash with limits programmers and architecture:</p>
<ul>
<li>&quot;The price calculation must be ready for use&quot;</li>
<li>&quot;I need to add different price to product B if they're in combination with product A&quot;</li>
<li>&quot;It must be easy to maintain&quot;</li>
<li>&quot;The business must be able to update dependency on our code&quot;</li>
<li>&quot;We can't predict how the price will develop&quot;</li>
</ul>
<p><del>This not possible!</del> - How can we do it as close as possible now?</p>
<p>Let's say the solution is fairly easy. Same as <a href="https://symfony.com/doc/current/security/voters.html">Voters are to Security</a>, we introduce 1 service <code>PriceCalculator</code> that collects all the little one <code>PriceModifierInterface</code>.</p>
<p>How would such implementations look like in <em>framework-way</em>?</p>
<h3 id="1-In-Symfony">1. In Symfony</h3>
<pre><code class="language-php">&lt;?php

namespace App\DependencyInjection;

use Symfony\Component\DependencyInjection\Compiler\CompilerPassInterface;
use Symfony\Component\DependencyInjection\ContainerBuilder;

final class PriceCompilerPass implements CompilerPassInterface
{
    public function process(ContainerBuilder $containerBuilder)
    {
        $priceCalculator = $containerBuilder-&gt;get(PriceCalculator::class);

        foreach ($containerBuilder-&gt;findTaggedServiceIds('price_modifier') as $service =&gt; $tags) {
            $priceCalculator-&gt;addMethodCall('add', [new Reference($service)]);
        }
    }
}</code></pre>
<p><strong>Again, we need to create some legacy code that is hard to maintain:</strong></p>
<ul>
<li>add tagging in extension/bundle or better type resolution ❌</li>
<li>register this in Kernel ❌</li>
<li>remember the tag name (<a href="/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock">don't remember anything</a>/) ❌</li>
<li>use the tag everywhere (YAML) ❌</li>
<li>vendor-lock the metadata in the config (YAML) ❌</li>
<li>people maintaining project after you leave have to learn this <em>Symfony way</em> ❌</li>
</ul>
<p><br></p>
<h3 id="2-In-Nette">2. In Nette</h3>
<pre><code class="language-php">&lt;?php

namespace App\DI;

use Nette\DI\CompilerExtension;

final class PriceExtension extends CompilerExtension
{
    public function beforeCompile()
    {
        $containerBuilder = $this-&gt;getContainerBuilder();
        $priceCalculator = $containerBuilder-&gt;get(PriceCalculator::class);

        $priceModifiers = $containerBuilder-&gt;findByType(PriceModifierInterface::class);
        foreach ($priceModifiers as $service) {
            $priceCalculator-&gt;addSetup('add', [$service]);
        }
    }
}</code></pre>
<p><strong>Also, we create legacy code that is hard to maintain:</strong></p>
<ul>
<li>register extension to a config (Neon) ❌</li>
<li>vendor-lock the metadata in the config (Neon) ❌</li>
<li>people maintaining project after you leave have to learn this <em>Nette way</em> ❌</li>
</ul>
<p>I need to take a break, my brain is tired just <strong>by making up this complicated and non-sense code</strong>. I mean, I used to write this code in my every project for 5 years in Symfony and Nette projects, because it was &quot;the best practice&quot; and I didn't question it, but <strong>there was always something scratching in the back of my head</strong>.</p>
<p><br>
<br></p>
<h2 id="Keep-Simple-Things-Simple">Keep Simple Things Simple</h2>
<p>Now imagine you've ended in a train crash, hit your head and forget all the frameworks you know. All you have left is actually the best you can achieve in any mastery - a <a href="https://zenhabits.net/beginner">mind of the begginer</a>.</p>
<ul>
<li>&quot;How would you get all services of a certain type in a certain order or key name?&quot;</li>
</ul>
<p>In our specific example:</p>
<ul>
<li>&quot;How would you get all <code>PriceModifierInterface</code> services into <code>PriceCalculator</code> sorted by priority?&quot;</li>
</ul>
<pre><code class="language-php">&lt;?php

final class PriceCalculatorFactory
{
    /**
     * @var PriceModifierInterface[]
     */
    private $priceModifiers = [];

    /**
     * @param PriceModifierInterface[] $priceModifiers
     */
    public function __construct(array $priceModifiers)
    {
        $this-&gt;priceModifiers = $priceModifiers;
    }

    public function create(): PriceCalculator
    {
        $priceModifiersByPriority = [];
        foreach ($this-&gt;priceModifiers as $priceModifier) {
            $priority = $priceModifier-&gt;getPriority(); // this could be "getKey()" or any metadata
            $priceModifiersByPriority[$priority] = $priceModifier;
        }

        // sort them in any way
        ksort($priceModifiersByPriority);

        return new PriceCalculator($priceModifiersByPriority);
    }
}</code></pre>
<p>In some framework we have still have to add 1 config vendor-lock ❌ :</p>
<pre><code class="language-yaml">services:
    App\Price\PriceCalculator:
        factory: ['@App\Price\PriceCalculatorFactory', 'create']</code></pre>
<p>I use <a href="https://github.com/symplify/package-builder#do-not-repeat-simple-factories">compiler pass</a> for now, but if you know how to remove it, let me know.</p>
<p>How we get <code>$priceModifiers</code> is not that important now, it's <a href="/blog/2018/11/12/will-autowired-arrays-finally-deprecate-tags-in-symfony-and-nette/">an implementation detail</a>.</p>
<h2 id="Durable-and-amp-Readable">Durable &amp; Readable</h2>
<p>The important thing is we got a code that:</p>
<ul>
<li>is <strong>strictly typed</strong> ✅</li>
<li>we all understand it ✅</li>
<li>will not be affected by any syntax/architecture changes in our favorite framework ✅</li>
<li>can be checked by <strong>coding standard tools</strong> ✅</li>
<li>can be analysed by <strong>static analysis tools</strong> ✅</li>
<li>and refactored by <strong>instant upgrade tools</strong> ✅</li>
</ul>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/04/25/don-t-give-up-your-php-code-for-compiler-passes-so-easily</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 25 Apr 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/04/25/don-t-give-up-your-php-code-for-compiler-passes-so-easily#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Hidden Gems of PHP Packages: Static Analysis Results Baseliner ]]></title>
                <link>https://tomasvotruba.com/blog/2019/04/22/hidden-gems-of-php-packages-srab</link>
                <description><![CDATA[ <p>Have you used PHPStan, Psalm or Easy Coding Standard on a very old project and got 10 000+ errors?
<br>
<strong>Do you wish to skip fixing these 10 000 errors and check new code only?</strong>
<br>
<br>
Yes and yes? You'll love SARB.</p> ]]></description>
                <content:encoded><![CDATA[ <p>I found this package by random clicking on meetups on <a href="https://friendsofphp.org">Friends of PHP</a> and reading program of the meetup. One of them was Dave with his SARB - <em>Static Analysis Results Baseliner</em> tool. What an interesting name. In the Czech, I read <em>SRAB</em>, which means <em>coward</em>... what does such tool do?</p>
<h2 id="What-Does-SARB-Help-You-With">What Does SARB Help You With?</h2>
<p>&quot;SARB is used to create a baseline of these results. As work on the project progresses SARB can take the latest static analysis results, removes those issues in the baseline and report the issues raised since the baseline. SARB does this, in conjunction with it, by tracking lines of code between commits.&quot;</p>
<p>Such a simple idea with huge application in practice - amazing! What does it mean? Let me show you on a project:</p>
<ul>
<li>Let's say you add PHPStan to your project on 1. 4. 2019.</li>
<li>It shows 10 000 errors, yay!</li>
<li>You add SARB, get the baseline errors.</li>
<li>Then you add new 10 new PHP classes on 15. 4 2019.</li>
<li>Instead of getting 10 000 errors + 20 more on 10 PHP classes, <strong>you get only those 20 new errors on new files since 1. 4. 2019</strong>.</li>
</ul>
<p>No stress with the legacy you didn't even write, but full focus on the present moment.</p>
<h2 id="How-can-You-use-it">How can You use it?</h2>
<ol>
<li>Install it</li>
</ol>
<pre><code class="language-bash">composer require dave-liddament/sarb --dev</code></pre>
<ol start="2">
<li>Create a baseline file</li>
</ol>
<pre><code class="language-bash"># for psalm
vendor/bin/psalm --report reports/psalm-result.json
vendor/bin/sarb create-baseline reports/psalm-result.json reports/sarb_baseline.json psalm-json

# for phpstan
vendor/bin/phpstan analyse --error-format json &gt; reports/phpstan-result.json
vendor/bin/sarb create-baseline reports/phpstan-result.json reports/sarb_baseline.json phpstan-json</code></pre>
<ol start="3">
<li>
<p>Commit the code</p>
</li>
<li>
<p>Rerun the static analysis on the latest code</p>
</li>
</ol>
<pre><code class="language-bash"># for psalm
vendor/bin/psalm --report reports/psalm-result.json

# for phpstan
vendor/bin/phpstan analyse --error-format json &gt; reports/phpstan-result.json</code></pre>
<ol start="5">
<li>Use SARB to remove baseline results</li>
</ol>
<pre><code class="language-bash"># psalm
vendor/bin/sarb remove-baseline-results reports/psalm-result.json reports/sarb_baseline.json reports/issues_since_baseline.json

# phpstan
vendor/bin/sarb remove-baseline-results reports/phpstan-result.json reports/sarb_baseline.json reports/issues_since_baseline.json</code></pre>
<p>That's it!</p>
<p>You can use this also on EasyCodingStandard:</p>
<pre><code class="language-bash">vendor/bin/easy-coding-standard check src --output-format reports/ecs-result.json
vendor/bin/sarb remove-baseline-results reports/ecs-result.json reports/sarb_baseline.json reports/issues_since_baseline.json</code></pre>
<p>The sky is the limit :)</p>
<p><br></p>
<p>Read more about the tool in <a href="https://www.daveliddament.co.uk/sarb/introduction">Introduction post</a> and in <a href="https://github.com/DaveLiddament/sarb">README</a> of the project on Github.</p>
<p>Great job David!</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/04/22/hidden-gems-of-php-packages-srab</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 22 Apr 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/04/22/hidden-gems-of-php-packages-srab#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Symfony 4.2 is used Twice More than Symfony 3.4 ]]></title>
                <link>https://tomasvotruba.com/blog/2019/04/18/symfony-4-2-is-used-2-times-more-than-symfony-3-4</link>
                <description><![CDATA[ <p>PHP itself is very quickly adopted. Last Packagist stats from 2018/11 <a href="https://blog.packagist.com/php-versions-stats-2018-2-edition">report 32,6 %</a> people are using PHP 7.2. That's a very nice number, great job y' all!
<br><br>
But most of our code is not just plain PHP. <strong>It's framework-locked PHP</strong>. How is framework adoption?</p> ]]></description>
                <content:encoded><![CDATA[ <div class="alert alert-success mt-3">
This post was inspired by very active reactions to <a href="/blog/2019/04/11/trends-of-php-frameworks-in-numbers/">Trends of PHP Frameworks in Numbers</a>
</div>
<p>If you look at the <a href="https://phpfwtrends.org/">PHP Framework Trends table</a> and see Symfony with 595 mils. downloads last year, what will it tell us? What if 90 % of that is just legacy Symfony 2.8?</p>
<p>When I talked with my friends Marek and Honza about PHP downloads trends last week, they came with an idea that stats should include <strong>downloads numbers for each version</strong> and <strong>the release date</strong> of that version. That would help us separate long-tail dinosaurs from actively adopted packages.</p>
<p>So I closed myself in a closet for 3 days and put together framework downloads grouped by version (<a href="https://github.com/TomasVotruba/tomasvotruba.com/pull/738/files">see PR</a>). I won't lie, few numbers really surprised me.</p>
<h2 id="Symfony-on-Bleeding-Edge">Symfony on Bleeding Edge</h2>
<p>They say it's best practice to use LTS version - now Symfony 3.4. I personally prefer living on the edge with the 4.x version, but after feedback from the community, I lowered requirements to Symfony 3.4 as well.</p>
<p>Let's look at a base stone for Symfony applications - <a href="https://phpfwtrends.org/framework/symfony/">symfony/http-kernel</a>.</p>
<ul>
<li>v4.2 - <strong>1 838 593</strong> downloads monthly - <strong>54 %</strong> of all downloads</li>
<li>v4.1 - 230 975</li>
<li>v4.0 - 45 539</li>
<li>v3.4 - <strong>891 778</strong></li>
</ul>
<p>It's that Symfony community doesn't wait on another LTS. It grabs the new features as soon as they're out. Amazing job!</p>
<h2 id="Laravel-wide-Spread-and-Stable">Laravel wide Spread and Stable</h2>
<p>I don't follow Laravel releases much. There is no clear release plan like PHP or Symfony has and they seemed somewhat random to me.
So when I looked at stats of <a href="https://phpfwtrends.org/framework/illuminate">laravel/framework</a>, I was surprised there are <strong>basically 2 release/year every ~6 months</strong>.</p>
<p>It's also interesting, that people stick with various versions:</p>
<ul>
<li>v5.8 - 623 534 - <strong>30 % adoption</strong></li>
<li>v5.7 - 532 232</li>
<li>v5.6 - 240 762</li>
<li>v5.5 - 317 489</li>
<li>v5.4 - 146 119</li>
</ul>
<p>Other versions have less than 70 k downloads.</p>
<p>It's also notable that <strong>89,5 %</strong> downloads are for Laravel 5.x.</p>
<h2 id="Zend-Injection-along-with-Adoption">Zend Injection along with Adoption</h2>
<p>This week was <a href="https://mwop.net/blog/2019-04-17-from-zend-to-laminas.html">Matthew announced moving Zend to Laminas project</a>. For users, it technically means just change of <code>Zend</code> namespace to <code>Laminas</code>, but potentially growth of Zend features thanks Linux Foundation funding. Great news!</p>
<p>How is the <a href="https://phpfwtrends.org/framework/laminas/">Zend adoption doing now</a>?</p>
<ul>
<li>27 of 91 packages has an adoption rate of 80 %+</li>
<li>51 of 91 packages has an adoption rate of 60 %+</li>
</ul>
<p>The Zend community is clearly interested in new features, far from &quot;Zend is Dead&quot;.</p>
<h2 id="CakePHP-with-Peak">CakePHP with Peak</h2>
<ul>
<li>The most <strong>downloaded package is <code>cakephp/chronos</code></strong> - with 290 045 downloads/month. Next packages have only 60-70 000 downloads.</li>
</ul>
<h2 id="Nette-slowly-Adopting">Nette slowly Adopting</h2>
<ul>
<li>The backbone for applications - <a href="https://phpfwtrends.org/framework/nette/"><code>nette/application</code></a> - <strong>has only 4 % adoption</strong>. No surprise there, since Nette 3.0 was released only on April 2nd, 2019. Keep updating!</li>
</ul>
<p>Here are <a href="https://github.com/TomasVotruba/tomasvotruba.com/blob/6c9df3aa834a213ea1a94d619f4cbc1564ff727e/source/_data/generated/vendor_packages_by_version.yaml">data to this day</a>, I wonder how they change in 6 months.</p>
<p><br></p>
<p>This is just the tip of the iceberg that caught my eyes.</p>
<p><strong><a href="https://phpfwtrends.org">Check the full table</a></strong> and discover more interesting details about your favorite framework.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/04/18/symfony-4-2-is-used-2-times-more-than-symfony-3-4</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 18 Apr 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/04/18/symfony-4-2-is-used-2-times-more-than-symfony-3-4#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Pattern Refactoring ]]></title>
                <link>https://tomasvotruba.com/blog/2019/04/15/pattern-refactoring</link>
                <description><![CDATA[ <p>In <a href="/blog/2019/04/01/removing-static-there-and-back-again/">Removing Static - There and Back Again</a> post we tried looked at anti-patterns in legacy code from a new point of view. It can be static in your code, it can be active record pattern you needed for fast bootstrapping of your idea, it can be moving from the code in controllers to command bus.
<br>
<br>
<strong>They can be coupled in your code in hundreds of classes. That's a big problem, you might think, but it's only single pattern</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Use-Your-Personal-Preferences">Use Your Personal Preferences</h2>
<p>For pattern, refactoring is not important what I believe is the best or is considered <em>general best practice</em> (if such weak thing can even exist). I'm kicking myself in the nuts now, but I feel I have to write it.</p>
<p>No external consultant or blog post can give you a qualified answer on what to do with a code he or she saw for a few days. I mean, they can give you tip and qualified feedback, because they saw dozens of similar code bases, but in the end, it's up to you to do the experiment and verify it on your code base.</p>
<p>The best thing in the code is decided by the team, that works with the code every day.</p>
<h2 id="And-for-a-Time-It-Was-Good">And for a Time, It Was Good</h2>
<p>Let's look at our use case inspired by the problems of the people around me. Imagine you have an active record pattern all over your code base. In 1 000 places, so it's easier to work with it:</p>
<pre><code class="language-php">&lt;?php

$product = Product::find(5);
$product-&gt;name = 'Train Ticket';
$product-&gt;save();</code></pre>
<p>This pattern helped you to grow your minimal viable product, deliver features, enjoy growth and make money. It was very useful to you at a certain time in the past. The same way it was useful to live with parents when we went to school.</p>
<p>Your company grew every year for last 5 years, with growing code bases and new modules you have more bugs with weak typing and you've <strong>decided to move</strong> to Doctrine and separate Entity and Repository.</p>
<h2 id="Let-s-Refactor">Let's Refactor</h2>
<p>The <strong>why</strong> is clear and the decision to change the codebase has been made. Now <strong>how</strong> do you refactor your 1000 places that use active record?</p>
<p>Before answering, keep in mind, that you have to explain these options to your boss (CEO, product owner...) because he or she cares about following in this order:</p>
<ul>
<li><strong>How much time</strong> will it take? <em>The faster the better</em></li>
<li><strong>How much money</strong> will it cost? <em>The cheaper the better</em></li>
<li><strong>How big code good quality</strong> it brings? The <em>higher</em> the better</li>
</ul>
<p>Well, your boss will probably not ask the last question, but I've added it just for the sake of our programming perception of the relationship of code and business.</p>
<h3 id="1-Rewrite-Write-the-Same-Code-in-Clean-Way">1. Rewrite = Write the Same Code in Clean Way</h3>
<p>How could the pitch for rewrite look like?</p>
<p>&quot;<em>The active record is coupled with everything, it's in controllers, in commands, and in services. Even if we change it in a single class, it will probably influence most of the rest code. After we rewrite adding features would be much easier, because we would not have to switch between the old and new code base. We know what we want and it would take less time in the end than any other solution.</em>&quot;</p>
<p>Suddenly, your colleague comes. You don't like him, because he's too &quot;smart&quot;, younger and has less experience than you (he's younger, how can he have more experience, right?) and he starts to argue:</p>
<p>&quot;<em>Rewrite from scratch is one of the things you should never do. Why? Because rewriting from scratch has a bad history of failures. Joel Spolsky, CEO, and co-founder of StackOverflow wrote <a href="https://www.joelonsoftware.com/2000/04/06/things-you-should-never-do-part-i">Things You Should Never Do</a> in 2000.</em>&quot;</p>
<div class="text-center mb-4">
    <img src="https://i1.wp.com/www.joelonsoftware.com/wp-content/uploads/2016/12/Pong.png?zoom=1.100000023841858&amp;w=230&amp;ssl=1">
    <p>
        <em>Joel hodling a ping pong paddles in black/white</em>
    </p>
</div>
<p>Imagine you're the new CEO of your company. Would you go for rewrite after hearing this?</p>
<p>In my experience, every developer has to fuck-up one project by rewriting from scratch, to obtain this knowledge, so no article can help you if you're not there yet. Still, it's fun to <strong>read about failures of others</strong>.</p>
<h3 id="2-Gradual-Refactoring-Change-Old-Code-while-Adding-new-Features">2. Gradual Refactoring = Change Old Code while Adding new Features</h3>
<p>Your ballsy colleague continues his pitch: <em>It's much better to refactor as part of our coding. Only if we need it. If there is a new feature that affects, e.g. product object, we should refactor product to repository and entity. That way we can keep delivering features, we'll always have one code base that works and we don't have to split our attention for a month or potentially years.</em></p>
<h2 id="Which-Approach-is-Better">Which Approach is Better?</h2>
<p>Let's get to the questions that are in the position of CEO. The goal of the CEO is to keep the project running, make it grow in all fronts together. He or she will assess both options:</p>
<ul>
<li><strong>How much time</strong> will it take?</li>
<li><strong>How much money</strong> will it cost?</li>
<li><strong>How big code good quality</strong> it brings? <em>Pretty good</em></li>
</ul>
<h3 id="How-is-Rewrite-Doing">How is Rewrite Doing?</h3>
<p>The CEO: <em>&quot;So we have to basically pay programmers to create the same set of features as we had before, but it will cost us 2 months of work whole team? And in the end, we'll have exactly the same set of features, but the code will be nicer for you to work with?&quot;</em></p>
<h3 id="How-is-Continuous-Refactoring-Doing">How is Continuous Refactoring Doing?</h3>
<p>The CEO: <em>&quot;If I understand this correctly, you say that our application will slowly transform into a new one, we can still add features, it will only take slightly longer. In the end, it might take 12-14 months, but we'll get there? And during those 12-14 months, you'll have to work with 2 approaches in the same code-base?&quot;</em></p>
<p><br></p>
<p><em>&quot;Well, both solutions are expensive and slow, but I slightly prefer...&quot;</em></p>
<h2 id="Attention-Disruption">Attention Disruption</h2>
<p>We forgot one big problem that both approaches suffer from.</p>
<p>The best way to assess code quality is <strong>to let junior to work with it and count WTFs</strong>. The less the better (WTFs, not juniors). Juniors are like kids, honest and creative by nature. They don't know what they shouldn't tell and shouldn't do, so they find solutions much quicker than most of the older people... or people that work with the code base for a very long time and suffer from conformity bias. That's why I enjoy meeting &quot;less skilled&quot; people because I can learn from them much more than from &quot;the experts&quot;.</p>
<p>If the company growth is the main reason to refactor the code, so must expect to more PHP developers joining the project. Next new programmer coming to this code...</p>
<pre><code class="language-php">&lt;?php

// in one place
$product = Product::find(5);
$product-&gt;name = 'Train Ticket';
$product-&gt;save();

// in some other place
$product = $this-&gt;productRepository-&gt;get(5);
$product-&gt;changeName('Train Ticket');
$this-&gt;productRepository-&gt;save($product);</code></pre>
<p>...would be probably <strong>confused</strong>:</p>
<ul>
<li>Why is the other team working on the new code and we have to work with this shit-code for next year?</li>
<li>Why there is one entity with active record and other with the classic entity?</li>
<li>Why do you keep returning my code on code-reviews, since you there is active record all over the application?</li>
<li>Why there are 2 ways to get an item from the database with no clear boundary when to use which?</li>
<li>Why there is no documentation for when to use which pattern?</li>
<li>Why we have to implement every feature twice, once in the old code and once in the new code?</li>
<li>...</li>
</ul>
<p>And so on.</p>
<p>All this leads to moving focus from <a href="/blog/2017/09/25/3-non-it-books-that-help-you-to-become-better-programmer/#deep-work-by-cal-newport">deep work</a> and actually creating features to talking about meta-programming. You talk and answer and explain, but nothing in the code changes.</p>
<h2 id="Design-Code-for-Understanding">Design Code for Understanding</h2>
<p>I've started to code new Lekarna.cz in 2015 on Nette from scratch (exactly!). First 5 months I was all alone, then a new programmer joined me. He started to code in the same quality as the previous code, I didn't have to teach him almost anything. I was curious:</p>
<ul>
<li>&quot;Where did you learn work so well Doctrine, Nette and using patterns?&quot;</li>
<li>&quot;I did 2 small projects on Nette without Doctrine, but I just use what's already there.&quot;</li>
</ul>
<p>I was so happy! Once I can write readable code, second the code doesn't depend on my expertise and I don't have to waste both our times in <em>meta-programming</em> and explaining what code should explain.</p>
<p>The code can be designed to either confuse people or to lead them. It's a matter of thoughtful decision to make code understandable first, then it's pretty easy.</p>
<h2 id="Pattern-Refactoring">Pattern Refactoring</h2>
<p>How can we keep the attention focused, code understandable and also make CEO happy?</p>
<ul>
<li><strong>How much time</strong> will it take? 1 month</li>
<li><strong>How much money</strong> will it cost? Expenses for 1 month</li>
</ul>
<p>Do not focus on the code or on its size - that all is now just an implementation detail. Use the code that you and your colleagues build. Go for patterns:</p>
<ul>
<li>How do you define <strong>active record pattern</strong>?</li>
<li>How do you define <strong>entity</strong>?</li>
<li>How do you define <strong>repository</strong>?</li>
<li>What is <strong>takes step by step to change</strong> this code from active record to entity and repository?</li>
</ul>
<pre><code class="language-diff">-$product = Product::find(5);
+$product = $this-&gt;productRepository-&gt;get(5);

-$product-&gt;name = 'Train Ticket';
+$product-&gt;changeName('Train Ticket');

-$product-&gt;save();
+$this-&gt;productRepository-&gt;save($product);</code></pre>
<ul>
<li>What is the most efficient way to achieve it?</li>
</ul>
<div class="alert alert-success mt-3">
<p>Play with these question, <strong>ask them</strong>, <strong>break limits of your colleagues</strong> and <strong>look for the cheaper and faster solution that brings you better code quality</strong> at the same time.</p>
</div>
<p>There are many ways already:</p>
<ul>
<li>pattern refactoring is already in PHPStorm, the first kick off is <a href="https://blog.jetbrains.com/phpstorm/2019/02/phpstorm-2019-1-eap-191-5109-15">Code Cleanup</a>  feature</li>
<li>regular pattern</li>
<li>the most advanced is AST refactoring (I spoke about it in <a href="https://blog.shopsys.com/2019-trends-in-the-world-of-php-interview-with-tomas-votruba-c70f138c92a3">this interview</a>)</li>
</ul>
<p><br></p>
<p>Learn this minds set and tool kit - they will give you the power to move massive code bases with just a couple hours of preparation. <strong>Next time you'll be thinking of &quot;rewrite vs. gradual refactoring&quot;, remember pattern refactoring</strong>. There probably already is an easier way behind the corner that will make happy both your and your CEO.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/04/15/pattern-refactoring</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 15 Apr 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/04/15/pattern-refactoring#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Is Zend Dead? Is Laravel Losing Breath? Trends of PHP Frameworks in Numbers ]]></title>
                <link>https://tomasvotruba.com/blog/2019/04/11/trends-of-php-frameworks-in-numbers</link>
                <description><![CDATA[ <p>We often hear &quot;Zend is dead&quot;, &quot;Laravel is the most favorite&quot;, &quot;X is trending on Google&quot;, &quot;F is Dead, Migrate!&quot; etc. But are these statements supported by any research or numbers? No.
<br>
<br>
<strong>I was curious, how all PHP frameworks are doing, so I've looked at downloads and trends of each PHP framework</strong>. And here are the results.</p> ]]></description>
                <content:encoded><![CDATA[ <p>There are plenty <em>What is the Best PHP framework(s) in 20X</em> posts all over the Internet. Usually written by someone, who uses one of them and prefer them. It's pretty easy to put out many arguments, why is your favorite framework &quot;the best framework&quot;. These posts mislead the reader because only someone using all PHP frameworks out there in equal time and skill could evaluate it objectively.</p>
<h2 id="Numbers-vs-Vague-Statements">Numbers vs. Vague Statements</h2>
<p>I wanted to separate feelings and opinions of influencers - mostly framework leads or people paid for working in the framework (myself including) - from numbers and facts.</p>
<p>The active community, <strong>with long duration and rising trend</strong> will provide a much better idea, how the framework is really successful. You can use marketing and made up stories, but if the community isn't happy with the framework in the long term, the numbers will show.</p>
<h2 id="Methodology">Methodology</h2>
<p>I've downloaded a few numbers from Packagist API for every package in the vendor name. E.g. for Symfony framework, all <code>symfony/*</code> packages are included.</p>
<p>Then I took the <strong>sum of package downloads in the last 6 months</strong> and the <strong>trend in last 6 months</strong>. From those, I made an average for the whole framework.</p>
<p>Small packages with less than 500 downloads/day or younger than 12 months are excluded as outliers.</p>
<h2 id="There-is-More">There is More...</h2>
<ul>
<li>What packages are active in those frameworks?</li>
<li>What frameworks are dinosaurs - with big long-tail effect in total downloads, but losing in trends?</li>
<li>What frameworks have <a href="/blog/2018/07/30/hidden-gems-of-php-packages-nette-utils/">hidden</a> <a href="/blog/2018/08/13/hidden-gems-of-php-packages-symfony-finder-and-spl-file-info/">cool</a> utils packages?</li>
</ul>
<p><br></p>
<p>There is a <strong>detailed table</strong> where you can find these answers:</p>
<p><a href="https://phpfwtrends.org" class="btn btn-warning btn-2x mt-4 mb-5">See full PHP Framework Trends table</a></p>
<p><a href="https://phpfwtrends.org"></p>
<img src="https://user-images.githubusercontent.com/924196/110786128-0c566700-826c-11eb-912a-a8f79e177665.png" class="img-thumbnail">
<p></a></p>
<p><br></p>
<p>Next time you'll read <em>&quot;X is the Best PHP Framework...&quot;</em>, ask for numbers behind the statement and share this table.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/04/11/trends-of-php-frameworks-in-numbers</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 11 Apr 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/04/11/trends-of-php-frameworks-in-numbers#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ What You Lose by Switching to Symfony ]]></title>
                <link>https://tomasvotruba.com/blog/2019/04/08/what-you-lose-by-switching-to-symfony</link>
                <description><![CDATA[ <p>Switching one framework for another is nowadays getting easier and easier. What you could do for months only on your private projects, where income and delivering features are not important, is now an option for big websites with millions of lines of code. What seems like a divorce and switching a partner, is now as simple as changing your shoes from work to jogging ones.
<br>
<br>
&quot;Ok, we get it, it's simple. But why, what is the gain?&quot;</p> ]]></description>
                <content:encoded><![CDATA[ <p>I'm not writing this post because I use Symfony in my projects and love the community around it. I write this because in the last 2 weeks people around me asked me for help with Rector:</p>
<ul>
<li>from Laravel to Symfony</li>
<li>from Lumen to Symfony</li>
<li><a href="/blog/2019/02/21/how-we-migrated-from-nette-to-symfony-in-3-weeks-part-1/">from Nette to Symfony</a></li>
<li>from Zend to Symfony</li>
</ul>
<p>It's possible and in a small fraction of costs of manual work, but &quot;why not&quot; is a very poor argument. That's like taking cocaine because it gives you more energy. Life is not about solutions, it's about trade-offs. I'd like to inform you about the cons of such migration, so you can decide with more solid arguments on both sides.</p>
<h2 id="What-you-Lose-by-Switching-to-Symfony">What you Lose by Switching to Symfony?</h2>
<h3 id="1-and-quot-Your-team-will-be-surprised-from-the-new-framework-they-never-used-and-quot">1. &quot;Your team will be surprised from the new framework they never used&quot;</h3>
<p>In one Symfony project I consulted, they hired 2 programmers who knew only Nette. They didn't give them much attention, because delivering feature was more important than to educate your juniors. The problem is, they produced Nette-ish code in Symfony application, because of lack of attention. Switch framework under programmer's hands in a very short period could cause much more serious damage.</p>
<h3 id="2-and-quot-Your-team-loses-all-the-social-connections-with-your-old-framework-and-quot">2. &quot;Your team loses all the social connections with your old framework&quot;</h3>
<p>The best way to learn and validate ideas is to go out and talk with people. You probably have many offline connections with people who use a similar framework, you use Slack channel for this framework, you know maintainers of packages from the framework ecosystem.
When you break up with your girlfriend, your friends from &quot;her side&quot; will soon perish.</p>
<p><br>
<em>I'm obviously biased here, so if you have tips what will you lose, let me know in comments. I'll complete the article.</em></p>
<h2 id="How-to-Switch-Quickly-Smoothly">How to Switch <del>Quickly</del> Smoothly</h2>
<p>The main goal in any transition is to <strong>have everyone on board</strong>. If your country creates reform for a pension that will take more money from young people, there will be frictions. If there is reform for cheaper education, that will decrease pensions to older people, there will be frictions. A reform, that improves educations for young people, that in conclusion will generate money for older people, will be much smoother. Not perfect, but smoother.</p>
<p>There is a practice-proven way to for all the problems above. Let's look at them:</p>
<h3 id="1-and-quot-Your-team-will-be-surprised-from-the-new-framework-they-never-used-and-quot">1. &quot;<del>Your team will be surprised from the new framework they never used</del>&quot;</h3>
<p>It doesn't make sense to switch in one week without discussing the whole team. It is as foolish as giving PHPStorm to someone who only used Sublime Text and expects them to know how to use it.</p>
<p><strong>Always give your team proper daily mentoring on how to use and master a new tool.</strong> It will payback in higher quality code and faster feature delivery in the long term.</p>
<h3 id="How-to-do-it-better">How to do it better?</h3>
<p><strong>Install <a href="https://github.com/symfony/demo">symfony/demo</a></strong>, run it locally and try to break it.</p>
<p>Talk about WTFs with your team. Are there differences to your old framework? Just hate them, let the frustration out. It's normal to compare and feel this way.</p>
<p><strong>Look at <a href="https://symfonycasts.com">SymfonyCasts</a>, the best introduction to Symfony</strong>, even better than documentation - the text is always for free (videos are paid, but they contain the same content as text) - huge thanks <a href="https://twitter.com/weaverryan">Ryan Weaver</a> for funny videos.</p>
<p><strong>Hire an onsite/hot-line mentor for first 2 months</strong>. It might be more expensive than paying a programmer, but cheaper than the technical debt that programmer without experience would create during these 2 months. The mentor or she will help you to quickly overcome all the WTFs and give you the confidence to master the framework yourself.</p>
<h3 id="2-and-quot-Your-team-loses-all-the-social-connections-with-your-old-framework-and-quot">2. &quot;<del>Your team loses all the social connections with your old framework</del>&quot;</h3>
<p>If you know people that use Nette, Laravel, Lumen or Zend, there is a high probability that your friends use Symfony as well.
Nowadays, <em>components over framework</em> model has become so popular, that most programmer actually uses more frameworks in one projects. So switching to Symfony only opens new topics to talk about.</p>
<p>If you look for an offline meetup where you can talk about Symfony, look at <a href="https://friendsofphp.org">Friends of PHP</a>. Don't look just for &quot;Symfony&quot; keyword, but also PHP meetups in general. There you'll be able to talk about Symfony too since in Central and Western Europe Symfony is de facto &quot;the PHP framework&quot;.</p>
<h2 id="What-you-Gain-by-Switching-to-Symfony">What you Gain by Switching to Symfony?</h2>
<h3 id="Better-Hiring-Rates">Better Hiring Rates</h3>
<p>Symfony ecosystem will not give you magically 10 new Symfony developers you now desperately need each year. But the symfony community trend is clear - it's active, it grows and attracts programmers that want to push their static programming to the next level.</p>
<div class="text-center">
    <img src="/assets/images/posts/2019/lose-symfony/conferences.png">
    <em>There is 8 upcoming conferences in 2019 all over the Europe and America</em>
</div>
<h3 id="Community-of-Testers">Community of Testers</h3>
<p>Nette Application is downloaded <a href="https://packagist.org/packages/nette/application/stats">2 296× a day</a>. Symfony alternative HttpKernel is downloaded <a href="https://packagist.org/packages/symfony/http-kernel/stats">170 991× a day</a>. Each Symfony package is tested by a huge amount of developers right after it is released. In this case, <strong>there is 75× bigger chance the bug will be discovered and fixed</strong>.</p>
<p>That's a huge advantage of the big and stable community.</p>
<h3 id="Rock-Solid-Stability">Rock-Solid Stability</h3>
<p>Correct me if I'm wrong, but Symfony is <strong>the only PHP framework that has <a href="https://symfony.com/roadmap">predictable release</a></strong>. You can be 100 % sure that:</p>
<ul>
<li>every <strong>6 months</strong>, there will be a new release of Symfony with new hot features</li>
<li>every <strong>6 months</strong> you can plan &quot;upgrade day&quot; for all you PHP projects</li>
<li>every <strong>2 years</strong> there will be a new major version.</li>
<li>every <strong>2 years</strong> there will be a new version with long-term support</li>
</ul>
<div class="text-center">
    <img src="/assets/images/posts/2019/lose-symfony/stable.png" class="img-thumbnail">
</div>
<p>I wrote about the importance of leader stability for the rest ecosystem in <a href="/blog/2017/10/30/what-can-you-learn-from-menstruation-and-symfony-releases/">What Can You Learn from Menstruation and Symfony Releases</a>.</p>
<h3 id="You-re-Informed-about-Important-Stuff">You're Informed about Important Stuff</h3>
<p>To get into Symfony you have to read every post, every tweet, read newsletters, be on Slack and go to meetups... well, that would be hell.</p>
<ul>
<li>All you need to know is in <a href="https://symfony.com/blog/category/living-on-the-edge">&quot;Living on the Edge&quot;</a> category or Symfony blog. 2-3 months prior to the release (now 4.3), you'll find nice, short and sexy posts about upcoming features.</li>
</ul>
<p>Do you have an extra 5 minutes a week?</p>
<ul>
<li>
<p>Just follow <a href="https://twitter.com/symfony_en">@symfony_en</a> - cherry-picked tweets with important news</p>
</li>
<li>
<p>I personally also sniff <a href="https://symfony.com/blog/category/a-week-of-symfony">&quot;A Week of Symfony&quot;</a> every week, with newest issues, PRs and posts about Symfony (mostly to check if my posts are there ;)) to learn from others.</p>
</li>
</ul>
<p><strong><a href="https://github.com/javiereguiluz">Javier Eguiluz</a> is making this really easy for us, thank you!</strong></p>
<h3 id="You-re-Welcomed">You're Welcomed 🤗</h3>
<p>There are no numbers to describe this, yet I find it the most important pillar of any community. <strong>You're welcomed</strong>. You're welcomed to talk about your ideas, to argue (as in &quot;discuss with arguments&quot;, not to shout at each other) in issues on Github, to put arguments to support your statements.</p>
<p>I had many arguments with <a href="https://github.com/nicolas-grekas">Nicolas Grekas</a> about parameters, console or dependency injection features. In the end, there is always someone who decides to go for it or stops it, there must be so it's not chaos. Was I always happy about the decision? No. <strong>But I always feel respected. These discussions also help me to have a bigger picture and eventual implement the feature myself in a package.</strong></p>
<p>Sometimes I created a package, people found it useful and in a year or two, it becomes implemented in Symfony core. Then I could deprecate them, like <a href="/blog/2017/05/29/symplify-packages-deprecations-brought-by-symfony-33/">these Symplify packages in Symfony 3.3</a>:</p>
<div class="text-center">
    <img src="/assets/images/posts/2017/symplify-deprecations/pr-notes.png" class="img-thumbnail">
</div>
<p>I love how Symfony is ruled by decisions makers, but at the same time <strong>is opened to a change</strong>.</p>
<h2 id="It-s-not-a-Marketing-It-s-a-Family">It's not a Marketing, It's a Family</h2>
<p>The best thing is, it's not just marketing, it's not a well-bended lie, it's not a way to get money from you then say goodbye.
It's a company setting, that you can feel in the atmosphere of Symfony conference.</p>
<p>When I was at my first <a href="https://pariscon2015.symfony.com">SymfonyCon in Paris 2015</a>, there was a keynote by Fabien Potencier (Symfony founder and CEO) about &quot;10 Years of Symfony&quot;. I thought it will be one of these boring self-promo talks about how is Symfony awesome and what it does and how big projects it runs.</p>
<p>Instead, Fabien <strong>named people</strong>, who contributed to Symfony in any way, <strong>one by one and invited them to the stage, including his family</strong>.</p>
<img src="https://blog.radumurzea.net/wp-content/uploads/keynote.png" style="max-width:40em">
<p>It made me cry a bit and I still have goosebumps when I remember it.</p>
<p>That's what you gain by switching to Symfony.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/04/08/what-you-lose-by-switching-to-symfony</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 08 Apr 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/04/08/what-you-lose-by-switching-to-symfony#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Upgrade Twig from Underscored to Namespaces ]]></title>
                <link>https://tomasvotruba.com/blog/2019/04/04/how-to-upgrade-twig-from-underscored-to-namespaces</link>
                <description><![CDATA[ <p>Symfony <a href="https://symfony.com/blog/new-in-twig-namespaced-classes">recently announced a new version of Twig</a> with namespaces as we know it. Before PHP 5.2 there was <code>Underscored_Namespace</code> - I remember because that was the first version I used.
<br><br>
Today I'll show you how to upgrade from <code>_</code> to <code>\\</code> in few <del>minutes</del> seconds.</p> ]]></description>
                <content:encoded><![CDATA[ <div class="text-center">
    <img src="/assets/images/posts/2019/twig-under/twig-image.png" style="max-width: 28em">
</div>
<div class="alert alert-success mt-3">
    <p>This set would not be possible and as good as it is without you, open-source PHP community.
    I'd like to thank 👏:</p>

    <ul>
        <li><strong><a href="https://github.com/greg0ire">greg0ire</a></strong> <a href="https://github.com/rectorphp/rector/commit/493e418f4691f3a4beadf901bd54ea7406380891">for contributing</a> to this set</li>
        <li>and <strong><a href="https://github.com/enumag">enumag</a></strong> for <a href="https://github.com/rectorphp/rector/search?q=twig+is%3Aissue+author%3Aenumag&amp;unscoped_q=twig+is%3Aissue+author%3Aenumag&amp;type=Issues">battle testing and reported issues</a></li>
    </ul>
</div>
<p><div class="card ml-4 mt-4 border-warning float-right post-snippet" style="width: 14em">
    <div class="card-body">
        Would you like to <strong>learn more about Rector</strong>? Step by step, from zero to hero?
        <br>

        <div class="text-center">
            <a href="/book/the-power-of-automated-refactoring/">
                <img src="/assets/images/rector_book.png" class="mb-3 mt-3 shadow">
                Get our new book
            </a>
        </div>
    </div>
</div>
</p>
<h2 id="Find-and-Replace">Find and Replace?</h2>
<p>So all we need to do is replace <code>Twig_</code> with <code>Twig\</code>?</p>
<pre><code class="language-diff">-Twig_Function
+Twig\Function</code></pre>
<p>This would fail since <code>Twig\Function</code> class doesn't exist. <code>Twig\TwigFunction</code> does. There <a href="https://github.com/rectorphp/rector/blob/a1bd751f14c35e1e22c21ebcc3c26c922b4796a1/config/level/twig/underscore-to-namespace.yaml#L3-L154">150 more cases</a> where <strong>find and replace fails</strong>.</p>
<h2 id="2-Places">2 Places</h2>
<p>We need to replace both docblocks:</p>
<pre><code class="language-diff"> /**
- * @throws \Twig_Error_Loader
+ * @throws \Twig\Error\LoaderError
  */
 public function render(): void
 {
-    /** @var \Twig_Environment $env */
+    /** @var \Twig\Environment $env */
     $env = $this-&gt;getTwigEnv();

     // ...
 }</code></pre>
<p>And the code:</p>
<pre><code class="language-diff">-$safeTwigEnvironment = new \Twig_Environment(
+$safeTwigEnvironment = new \Twig\Environment(
-   new \Twig_Loader_Array([])
+   new \Twig\Loader\ArrayLoader([])
);</code></pre>
<p>In a reaction to the Symfony blog post, I see many developers <a href="https://github.com/sculpin/sculpin/pull/423/files">do upgrades manually</a>. In case of 50 changes, it's ok, but private code bases will go 1000+ use cases.</p>
<h2 id="Code-Pattern-Refactoring"><del>Code</del> Pattern Refactoring</h2>
<p>For <a href="https://github.com/rectorphp/rector">Rector</a> it just 1 pattern to refactor. Just tell him to process your files <code>src</code>:</p>
<ol>
<li>Install Rector</li>
</ol>
<pre><code class="language-bash">composer require rector/rector --dev</code></pre>
<ol start="2">
<li>Update <code>rector.php</code></li>
</ol>
<pre><code class="language-php">use Rector\Symfony\Set\TwigSetList;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;import(TwigSetList::TWIG_UNDERSCORE_TO_NAMESPACE);
};</code></pre>
<ol start="3">
<li>Run Rector</li>
</ol>
<pre><code class="language-bash">vendor/bin/rector process src</code></pre>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/04/04/how-to-upgrade-twig-from-underscored-to-namespaces</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 04 Apr 2019 00:00:00 +0000</pubDate>
                                    <updated>2020-11-01UTC00:00:000</updated>
                    <atom:updated>Sun, 01 Nov 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sun, 01 Nov 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/04/04/how-to-upgrade-twig-from-underscored-to-namespaces#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Removing Static - There and Back Again ]]></title>
                <link>https://tomasvotruba.com/blog/2019/04/01/removing-static-there-and-back-again</link>
                <description><![CDATA[ <p>The more companies I meet, the more I see <code>static</code> and <code>new</code> everywhere. Not like <code>new Product</code>, but rather <code>new ProductRepository(new Database())</code>. Not just Laravel, but across all PHP frameworks. I wish frameworks could prevent antipatterns, but they don't, do they?
<br><br>
Instead of &quot;refactor all the things&quot; step by step, class by class, I'd <strong>like share my thoughts when exploring full automated path</strong>. I look for feedback to improve this process.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="1-Show-Code">1. Show Code</h2>
<p>I usually start with a minimal code snippet possible, that explore the problem. No comments, no types, just the code. This is the real code I'm currently refactoring:</p>
<pre><code class="language-php">&lt;?php

final class Product
{
    private $price;

    public function __construct(float $price)
    {
        $this-&gt;price = $price;
    }

    public function getPrice(): Price
    {
        return new Price($this-&gt;price, CurrencyProvider::get());
    }
}

final class Price
{
    private $amount;

    private $currency;

    public function __construct(float $amount, Currency $currency)
    {
        $this-&gt;amount = $amount;
        $this-&gt;currency = $currency;
    }

    public function getAmount()
    {
        return $this-&gt;currency-&gt;convertFromCzk($this-&gt;amount);
    }
}</code></pre>
<h2 id="2-Describe-the-Code">2. Describe the Code</h2>
<p>Then I describe the problem with a few words using your common sense. No censorship, just flow of words.</p>
<p>&quot;There is a <code>Product</code> object... no, an entity since I can have multiple products. It has <em>active record pattern</em> since it creates <code>Price</code> in itself. There is also <em>static service locator</em> <code>CurrencyProvider::get()</code> to get current currency. I have no idea where the currency is set and it can be <em>overridden</em> multiple times during code run.</p>
<p>The goal of all this is probably to have price <em>always</em> in the same currency. Which is not true, since I can change the currency anytime I want. The price computation is input/output relations - so it should be solved by service, not an entity. I'm confused.&quot;</p>
<h2 id="3-Break-The-Code">3. Break The Code</h2>
<p>My favorite part. How can we break this code?</p>
<pre><code class="language-php">&lt;?php

$product = new Product(100.0);

CurrencyProvider::set('czk');
$product-&gt;getPrice(); // 100

CurrencyProvider::set('eur'); // this will be invoked in some other method, where the user needs a special price for newletter in Germany
$product-&gt;getPrice(); // ups, 2500?</code></pre>
<div class="alert alert-danger mt-3">
   1. An entity with the same ID can return different values on different calls of the same method.
</div>
<p>It's like my name would be &quot;Tom&quot; in the morning and &quot;John&quot; in the afternoon.</p>
<hr />
<pre><code class="language-php">&lt;?php

$product = new Product(100.0);
$product-&gt;getPrice(); // Error: 2nd argument of price cannot be null

CurrencyProvider::set('czk');</code></pre>
<div class="alert alert-danger mt-3">
    2. Due to a static design of <code>CurrencyProvider</code>, we cannot set currency at the single place of application, e.g. container creation, but we have to put it in the "right" place so it doesn't break the code. Here it broke the code because we set it too late.
</div>
<hr />
<pre><code class="language-php">&lt;?php

$product = new Product(100.0);

$allCurrencies = /* get from database */;
foreach ($allCurrencies as $currency) {
    CurrencyProvider::set($currency);
    echo $product-&gt;getPrice();
}

// what is the currency now?</code></pre>
<div class="alert alert-danger mt-3">
   3. How do I show a price for all the currencies we support?
</div>
<h2 id="3-The-Ideal-World">3. The Ideal World</h2>
<p>Now I imagine how I want this code to be designed in an ideal world, with enough time and skills. My goal is to make code work, while minimal as possible, while readable as quickly as possible. So when I leave the company, the person who reads the code will understand it at the same speed as I did.</p>
<ol>
<li>
<p>There will be a service that will take care of price computation.</p>
</li>
<li>
<p>It will accept <code>Product</code> and <code>Currency</code> as an argument.</p>
</li>
<li>
<p>That way it's easy to tests, method parameters are clearly stating dependencies, nothing to surprise.</p>
</li>
</ol>
<h2 id="4-Put-Ideal-World-into-Code">4. Put Ideal World into Code</h2>
<p>Now put that ideal into PHP code:</p>
<pre><code class="language-php">&lt;?php

final class Product
{
    private $price;

    public function __construct(float $price)
    {
        $this-&gt;price = $price;
    }

    public function getPrice()
    {
        return $this-&gt;price;
    }
}

final class Currency
{
    private $name;

    public function __construct(string $name)
    {
        $this-&gt;name = $name;
    }
}

final class PriceCalculator
{
    public function calculatePriceForProductAndCurrency(Product $product, Currency $currency): float
    {
        // ... computing algorithm ...
        return $price;
    }
}</code></pre>
<p>And then use:</p>
<pre><code class="language-php">&lt;?php

final class ProductController
{
    public function render()
    {
        $product = new Product(1000.0);
        $currency = new Currency('czk'); // default will be configured parameters in config.yaml

        $price = $this-&gt;priceCalculator-&gt;calculatePriceForProductAndCurrency($product, $currency);

        echo $price;
    }
}</code></pre>
<p>This is the thought process of most refactorings. It is mostly intuition until now. A small piece of code → the problem → the idea of how code should look like → the solution. Just commit and send for review, right?</p>
<p><br></p>
<p><a href="https://stackoverflow.com/a/454012/1348344">Martin Fowler</a> once said:</p>
<blockquote class="blockquote">
Refactoring is a controlled technique for improving the design of an existing code base. Its essence is applying <strong>a series of small</strong> behavior-preserving transformations, each of which "too small to be worth doing".<br><br>However the cumulative effect of each of these transformations is quite significant. <strong>By doing them in small steps you reduce the risk of introducing errors</strong>. You also avoid having the system broken while you are carrying out the restructuring - which allows you to gradually refactor a system over an <strong>extended period of time</strong>.
</blockquote>
<p>This worked well for a long period of time. Today I feel confident enough to say <strong>this paradigm is dead</strong> - and it's a good thing!</p>
<ul>
<li>&quot;series of small&quot;</li>
<li>&quot;small steps&quot;</li>
<li>&quot;extended period of time&quot;</li>
</ul>
<p>In 2019, we can do refactoring in <strong><a href="/blog/2019/02/21/how-we-migrated-from-nette-to-symfony-in-3-weeks-part-1/">one big step in short period of time</a></strong> - and still get working application in the end.</p>
<p>Clear proof is <strong>PHPStorm refactorings</strong> over the whole code base. They're still dumb compared to human and sometimes cause errors, but <a href="https://www.jetbrains.com/phpstorm/whatsnew">they get better and better each version</a>. Trend beats the status quo. You probably also know <strong><a href="https://github.com/kalessil/phpinspectionsea">Php Inspections (EA Extended)</a> plugin</strong> to PHPStorm.</p>
<p><br></p>
<p>It's easy to use these tools, but they still tend to solve the most generic problems. Instead of <strong>just blindly using
rules in these tools, we'll learn how to build them</strong> to solve your problem.</p>
<p><br></p>
<img src="/assets/images/posts/2019/removing-static/there.jpg" class="img-thumbnail">
<h2 id="5-Extract-The-Journey">5. Extract The Journey</h2>
<p>Back to the thinking process. This last step might seem a bit weird. We already have the clear code up and running and it's ready to ship. Why would we invest more energy into this? If I don't learn from this, I'm sentencing my future self to do it again in the future. It's funny to watch companies how they go for &quot;a business value&quot;, try to delivery features fast, but never pause to realize, that they do mostly repetitive tasks for the same price as the first one. So by this strategy to deliver business value fast, they cut their business value in half.</p>
<h3 id="Think-Big-Think-Absolute"><del>Think Big</del> Think Absolute</h3>
<p>Instead, I ask myself: &quot;how would I describe the process step by step to a machine, so it could refactor <strong>all PHP code</strong> on Github, Gitlab and the whole world with the same issue to the one in the end?&quot; There could be billions of such cases in the whole-world PHP code base.</p>
<p>If we're able to describe the process, <strong>we'll turn billions of use cases to 1 pattern transformation</strong>.</p>
<p>Imagine you try to fix typoes one-by-one manually. Or you could write a function, that fixes 5 most common typos for the user and hooks it on the Internet and SMS network (regardless of security) - to process every electronic message in the world. Just like that, the world became smarter thanks to you single function.</p>
<p>I disagree with Martin's statement: &quot;Its essence is applying a series of small behavior-preserving transformations&quot;. It's not about the behavior of code anymore. Much more important is the pattern in the code. We don't care about <code>Price</code>, nor <code>Currency</code> (it could be also called <code>Name</code> and <code>Invoice</code>).</p>
<p><br></p>
<p><strong>Instead we look at &quot;static call in an object&quot;.</strong></p>
<p><br></p>
<p>And what we did with that pattern it? Give your ideas in the comments or wait for the next post.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/04/01/removing-static-there-and-back-again</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 01 Apr 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/04/01/removing-static-there-and-back-again#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Mock Final Classes in PHPUnit ]]></title>
                <link>https://tomasvotruba.com/blog/2019/03/28/how-to-mock-final-classes-in-phpunit</link>
                <description><![CDATA[ <p>Do you prefer composition over inheritance? Yes, that's great. Why aren't your classes <code>final</code> then? Oh, you have tests and you mock your classes. <strong>But why is that a problem?</strong></p> ]]></description>
                <content:encoded><![CDATA[ <p>Since I started using <em><code>final</code> first</em> <a href="/blog/2019/01/24/how-to-kill-parents/">I got rid of many problems</a>. Most programmers I meet already know about the benefits of not having 6 classes extended in a row and that <code>final</code> remove this issue.</p>
<p>But many of those programmers are skilled and they write tests.</p>
<h2 id="How-Would-You-Mock-this-Class">How Would You Mock this Class?</h2>
<p>...so it returns <code>20</code> on <code>getNumber()</code> instead:</p>
<pre><code class="language-php">&lt;?php

final class FinalClass
{
    public function getNumber(): int
    {
        return 10;
    }
}</code></pre>
<p>We have few options out in the wild:</p>
<ul>
<li><a href="https://stackoverflow.com/a/33095281/1348344">You can use <code>uopz</code> extension</a> ❌</li>
<li><a href="https://gist.github.com/DragonBe/24761f350984c35b73966809dd439135">You can use reflection</a> ❌</li>
</ul>
<p>or...</p>
<h2 id="Extract-an-Interface">Extract an Interface</h2>
<pre><code class="language-diff"> &lt;?php

-final class FinalClass
+final class FinalClass implements FinalClassInterface
 {
     public function getNumber(): int
     {
         return 10;
     }
 }
+
+interface FinalClassInterface
+{
+    public function getNumber(): int;
+}</code></pre>
<p>Then use the interface instead of the class in your test:</p>
<pre><code class="language-diff"> &lt;?php

 use PHPUnit\Framework\TestCase;

 final class FinalClassTest extends TestCase
 {
     public function testSuccess(): void
     {
-        $finalClassMock = $this-&gt;createMock(FinalClass::class);
+        $finalClassMock = $this-&gt;createMock(FinalClassInterface::class);
         // ... it works! but at what cost...
     }
 }</code></pre>
<p>This will work, but creates <strong>huge debt you'll have to pay later</strong> (usually at a time you would rather skip):</p>
<ul>
<li>for every new <code>public</code> method in the class, you have to update the interface</li>
<li>&quot;interface everything&quot; approach will shift the meaning of interface from &quot;something to be implemented for a reason&quot; to &quot;anything you want to test&quot;</li>
<li>do you have 100 classes? you have 200 PHP files now, you're welcome!</li>
</ul>
<p>This is obviously annoying maintenance and it will lead you to one of 2 bad paths:</p>
<ul>
<li><strong>don't use <code>final</code></strong> at all</li>
<li>or <strong>do not test</strong></li>
</ul>
<p>❌</p>
<h2 id="By-Pass-Finals">By Pass Finals!</h2>
<p>Nette packages also missed <code>final</code> in the code, so people could mock it. Until David came with <a href="https://github.com/dg/bypass-finals">Bypass Finals</a> package. Some people think it's only for Nette\Tester, but I happily <strong>use it in PHPUnit universe</strong> as well.</p>
<p>We just install it:</p>
<pre><code class="language-bash">composer require dg/bypass-finals --dev</code></pre>
<p>And enable:</p>
<pre><code class="language-php">DG\BypassFinals::enable();</code></pre>
<p>✅</p>
<div class="alert alert-warning mt-5 mb-5" role="alert">
    Do you want to know, <strong>how BypassFinals works?</strong> Read author's <a href="https://phpfashion.com/how-to-mock-final-classes">blog post</a> or check <a href="https://github.com/dg/bypass-finals/blob/8f0f7ab7a17a6b5c188dde1cf5edc6ceb06c70c1/src/BypassFinals.php#L217">this line on Github</a>.
    <br>
    I don't know much, but I think it loads file via stream and removes the <code>T_FINAL</code> token.
</div>
<p>Hm, where should be put it?</p>
<h3 id="1-bootstrap-php-File">1. <code>bootstrap.php</code> File?</h3>
<pre><code class="language-php">require_once __DIR__ . '/../vendor/autoload.php';

DG\BypassFinals::enable();</code></pre>
<p>Update path in <code>phpunit.xml</code>:</p>
<pre><code class="language-diff"> &lt;phpunit
-    bootstrap="vendor/autoload.php"
+    bootstrap="tests/bootstrap.php"
 &gt;</code></pre>
<p>Let's run the tests:</p>
<pre><code class="language-bash">vendor/bin/phpunit

...

OK (3 tests, 3 assertions)</code></pre>
<p>Hm, mocks are worked, and let's try another approach.</p>
<h3 id="2-setUp-Method">2. <code>setUp()</code> Method?</h3>
<p>Let's put it into <code>setUp()</code> method. It seems like a good idea for these operations:</p>
<pre><code class="language-diff"> &lt;?php

+use DG\BypassFinals;
 use PHPUnit\Framework\TestCase;

 final class FinalClassTest extends TestCase
 {
+    protected function setUp(): void
+    {
+        BypassFinals::enable();
+    }

     public function testFailInside(): void
     {
         $this-&gt;createMock(FinalClass::class);
     }
 }</code></pre>
<p><br></p>
<p>And run tests again:</p>
<pre><code class="language-bash">vendor/bin/phpunit

...

OK (3 tests, 3 assertions)</code></pre>
<p>We're getting there, but there are still mocks in the <code>setUp()</code> method, and we've also added work to our future self - for every new test case, we <a href="/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock/">have to remember</a> to add <code>BypassFinals::enable();</code> manually.</p>
<p>❌</p>
<p><br>
<br></p>
<p>Why it doesn't work. I was angry and frustrated. Honestly, I wanted to give up now and just pick &quot;interface everything&quot; or &quot;final nothing&quot; quick solution.  I think <strong>that resolutions in emotions are not a good idea...</strong> so I take a deep breath, pause and go to a toilet to get some fresh air.</p>
<p><br></p>
<p>Suddenly... I remember that... PHPUnit has some Listeners, right? What if we could use that?</p>
<h3 id="3-Own-TestListener">3. Own TestListener?</h3>
<p>Let's try all the methods of <code>TestListener</code>, enable bypass in each of them by trial-error and see what happens:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

use DG\BypassFinals;
use PHPUnit\Framework\AssertionFailedError;
use PHPUnit\Framework\Test;
use PHPUnit\Framework\TestListener;
use PHPUnit\Framework\TestSuite;
use PHPUnit\Framework\Warning;

final class BypassFinalListener implements TestListener
{
    public function addError(Test $test, \Throwable $t, float $time): void
    {
    }

    public function addWarning(Test $test, Warning $e, float $time): void
    {
    }

    public function addFailure(Test $test, AssertionFailedError $e, float $time): void
    {
    }

    public function addIncompleteTest(Test $test, \Throwable $t, float $time): void
    {
    }

    public function addRiskyTest(Test $test, \Throwable $t, float $time): void
    {
    }

    public function addSkippedTest(Test $test, \Throwable $t, float $time): void
    {
    }

    public function startTestSuite(TestSuite $suite): void
    {
    }

    public function endTestSuite(TestSuite $suite): void
    {
    }

    public function startTest(Test $test): void
    {
        BypassFinals::enable();
    }

    public function endTest(Test $test, float $time): void
    {
    }
}</code></pre>
<p>In the end, it was just one method.</p>
<p>Then register listener it in <code>phpunit.xml</code>:</p>
<pre><code class="language-xml">&lt;phpunit bootstrap="vendor/autoload.php"&gt;
    &lt;listeners&gt;
        &lt;listener class="Listener\BypassFinalListener"/&gt;
    &lt;/listeners&gt;
&lt;/phpunit&gt;</code></pre>
<p><br></p>
<p>And run tests again:</p>
<pre><code class="language-bash">vendor/bin/phpunit

...

Success!</code></pre>
<p>Great! <strong>All our objects can be final and tests can mock them</strong>.</p>
<p>Is it a good enough solution? Yes, <strong>it works and it's a single place of origin</strong> - use it, close this post and your code will thank you in 2 years later.</p>
<p>✅</p>
<p><br></p>
<p>Are you a <strong>curious hacker that is never satisfied with his or her solution</strong>? Let's take it one step further.</p>
<p>What do you think about the Listener class? There is <strong>10+ methods</strong> and <strong>only one is used</strong>. It's very hard to read. To add more fire to the fuel, <code>TestListener</code> class is <a href="https://github.com/sebastianbergmann/phpunit/issues/3388">deprecated since PHPUnit 8</a> and will be <a href="https://github.com/sebastianbergmann/phpunit/issues/3389">removed in PHPUnit 9</a>. Don't worry, <a href="https://github.com/rectorphp/rector/pull/1270">Rector already covers the migration path</a>.</p>
<p>After bit of Googling on PHPUnit Github and documentation I found something called <em>hooks</em>!</p>
<h3 id="4-Single-Hook">4. Single Hook</h3>
<p>You can read about them in <a href="https://phpunit.readthedocs.io/en/9.5/extending-phpunit.html#extending-the-testrunner">the PHPUnit documentation</a>, but in short: they're the same as the listener, just <strong>with 1 event</strong>.</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

use DG\BypassFinals;
use PHPUnit\Runner\BeforeTestHook;

final class BypassFinalHook implements BeforeTestHook
{
    public function executeBeforeTest(string $test): void
    {
        BypassFinals::enable();
    }
}</code></pre>
<p>And again, register it in <code>phpunit.xml</code>:</p>
<pre><code class="language-xml">&lt;phpunit bootstrap="vendor/autoload.php"&gt;
    &lt;extensions&gt;
        &lt;extension class="Hook\BypassFinalHook"/&gt;
    &lt;/extensions&gt;
&lt;/phpunit&gt;</code></pre>
<p>The final test, run all tests:</p>
<pre><code class="language-bash">vendor/bin/phpunit

...

Success!</code></pre>
<p>✅
✅
✅</p>
<h3 id="Before">Before</h3>
<ul>
<li>we had to use interface for mocks</li>
<li>or we had to remove <code>final</code></li>
<li>we had to pick between inheritance hell or poor tests</li>
</ul>
<h3 id="After">After</h3>
<ul>
<li>A <strong>single solution, in single class</strong></li>
<li>we use PHPUnit feature directly, no weird bending code</li>
<li>we can <strong>mock anything</strong></li>
<li><strong>we can <code>final</code> anything</strong></li>
</ul>
<p><br></p>
<p>Finally :)</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/03/28/how-to-mock-final-classes-in-phpunit</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 28 Mar 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/03/28/how-to-mock-final-classes-in-phpunit#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Instantly Migrate Nette\Tester to PHPUnit ]]></title>
                <link>https://tomasvotruba.com/blog/2019/03/25/how-to-instantly-migrate-nette-tester-to-phpunit</link>
                <description><![CDATA[ <p>We had 🍺 after PHP meetup in Prague and Tomas asked me:
<br>
&quot;We don't use Nette, but we still have many tests in Tester. Can Rector migrate them to PHPUnit?&quot;
<br>
&quot;Hold my 🍺&quot;</p> ]]></description>
                <content:encoded><![CDATA[ <p>In the last post we looked on <a href="/blog/2019/03/21/how-to-instantly-migrate-phpspec-to-phpunit">instant migration of PhpSpec to PHPUnit</a>.</p>
<p>PhpSpec has a different architecture than PHPUnit - e.g.</p>
<ul>
<li>PHPUnit creates mocks in body of tested method <code>$this-&gt;createMock()</code> ,</li>
<li>but PhpSpec puts them in parameters <code>public function is_should_work(Category $categoryMock)</code>.</li>
</ul>
<p>This has a huge influence on the code, so <strong>it took a week to cover these differences in migration path</strong>.</p>
<p>How does Tester compare to PHPUnit?</p>
<h2 id="Trends-Revealed">Trends Revealed</h2>
<p>In the last post we looked at absolute downloads and trends of 3 PHP unit test frameworks:</p>
<div class="row text-center mb-5 mt-5">
    <div class="col-md-4 col-sm-4">
        <a href="https://packagist.org/packages/nette/tester/stats">
            <img src="/assets/images/posts/2019/unit-mig/tester.png">
            <br>
            <em>1 mil. downloads - Tester</em>
        </a>
    </div>
    <div class="col-md-4 col-sm-4">
        <a href="https://packagist.org/packages/phpspec/phpspec/stats">
            <img src="/assets/images/posts/2019/unit-mig/spec.png">
            <br>
            <em>14 mils. downloads - PhpSpec</em>
        </a>
    </div>
    <div class="col-md-4 col-sm-4">
        <a href="https://packagist.org/packages/phpunit/phpunit/stats">
            <img src="/assets/images/posts/2019/unit-mig/phpunit.png">
            <br>
            <em>117 mils. downloads - PHPUnit</em>
        </a>
    </div>
</div>
<p>Putting numbers and trends aside - <strong>this is about your needs</strong>. Do you need to change from Doctrine to Eloquent? From Symfony 4.2 to Laravel 5.8? From Symfony to Nette? Go for it, Rector will help you with the boring PHP work you'd love to skip.</p>
<p>The guy in the pub that night needed this, so...  <em>challenge accepted</em>!</p>
<p><div class="card ml-4 mt-4 border-warning float-right post-snippet" style="width: 14em">
    <div class="card-body">
        Would you like to <strong>learn more about Rector</strong>? Step by step, from zero to hero?
        <br>

        <div class="text-center">
            <a href="/book/the-power-of-automated-refactoring/">
                <img src="/assets/images/rector_book.png" class="mb-3 mt-3 shadow">
                Get our new book
            </a>
        </div>
    </div>
</div>
</p>
<h2 id="Single-Test-Case">Single Test Case</h2>
<p>Luckily, Tester and PHPUnit are like twins:</p>
<ul>
<li>share the same approach in configuring tests - <code>setUp</code> &amp; <code>tearDown</code></li>
<li>do assert with a call - <code>Assert::true($value)</code> vs. <code>self::assertTrue($value)</code></li>
<li>do share naming  - <code>public function testSomething()</code></li>
<li>do share data providers - <code>@dataProvider</code></li>
</ul>
<p>So all <strong>we need to do is rename a few methods</strong>? There are still a few gotchas:</p>
<ul>
<li><code>Assert::exception()</code> uses code inside anonymous function, while in PHPUnit it's just above the code that should fail</li>
<li>Tester includes bootstrap itself, PHPUnit include in <code>phpunit.xml</code></li>
<li>Tester creates the test under the test <code>(new SomeTest())-&gt;run()</code>, PHPUnit creates them automatically</li>
</ul>
<p>Luckily, last 2 operations are subtractions, so we can just remove them.</p>
<h3 id="And-the-Result">And the Result?</h3>
<pre><code class="language-diff"> &lt;?php

 namespace App\Tests;

 use App\Entity\SomeObject;
-use Tester\Assert;
-use Tester\TestCase;

-require_once __DIR__ . '/bootstrap.php';

-class ExpensiveObjectTest extends TestCase
+class ExpensiveObjectTest extends \PHPUnit\Framework\TestCase
 {
     public function testSwitches()
     {
-        Assert::false(5);
+        $this-&gt;assertFalse(5);

-        Assert::falsey('value', 'some messsage');
+        $this-&gt;assertFalse((bool) 'value', 'some messsage');

-        Assert::truthy(true);
+        $this-&gt;assertTrue(true);
     }

     public function testTypes()
     {
         $value = 'x';
-        Assert::type('array', $value);
+        $this-&gt;assertIsArray($value);

-        Assert::type(SomeObject::class, $value);
+        $this-&gt;assertInstanceOf(SomeObject::class, $value);
     }

     public function testException()
     {
         $someObject = new SomeObject;
-        Assert::exception(function () use ($someObject) {
-            $someObject-&gt;setPrice('twenty dollars');
-        }, InvalidArgumentException::class, 'Price should be string, you know');
+        $this-&gt;expectException(InvalidArgumentException::class);
+        $this-&gt;expectExceptionMessage('Price should be string, you know');
+        $someObject-&gt;setPrice('twenty dollars');
     }

+    /**
+     * @doesNotPerformAssertions
+     */
     public function testNoError()
     {
-        Assert::noError(function () {
-             new SomeObject(25)
-        });
+        new SomeObject(25);
     }
 }

-(new ExpensiveObjectTest())-&gt;run();</code></pre>
<h2 id="How-to-Instantly-Migrate-from-Nette-Tester-to-PHPUnit">How to Instantly Migrate from Nette\Tester to PHPUnit?</h2>
<ol>
<li>Install Rector</li>
</ol>
<pre><code class="language-bash">composer require rector/rector --dev</code></pre>
<ol start="2">
<li>Add <code>rector.php</code> config:</li>
</ol>
<pre><code class="language-php">use Rector\Set\ValueObject\SetList;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;import(SetList::NETTE_TESTER_TO_PHPUNIT);
};</code></pre>
<ol start="3">
<li>Run it on <code>/tests</code> directory</li>
</ol>
<pre><code class="language-bash">vendor/bin/rector process tests</code></pre>
<p>Then take few minutes to polish the details that Rectors missed and send the PR to your project
✅</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/03/25/how-to-instantly-migrate-nette-tester-to-phpunit</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 25 Mar 2019 00:00:00 +0000</pubDate>
                                    <updated>2020-11-01UTC00:00:000</updated>
                    <atom:updated>Sun, 01 Nov 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sun, 01 Nov 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/03/25/how-to-instantly-migrate-nette-tester-to-phpunit#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Instantly Migrate PhpSpec to PHPUnit ]]></title>
                <link>https://tomasvotruba.com/blog/2019/03/21/how-to-instantly-migrate-phpspec-to-phpunit</link>
                <description><![CDATA[ <p>I'm happy that more and more people try to use Rector upgrade and migrate their code-bases to the ones they really want for a long time.
<br>
<br>
Last week I was approached by 2 different people with single need - <strong>migrate their tests to PHPUnit</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <blockquote class="blockquote text-center">
    "Nobody believes in anything without an inner feeling that it can be realized.
    <br>
    This is the only source of dreamlike powers."
    <footer class="blockquote-footer">Peter Altenberg
</footer></blockquote>
<p><em>Disclaimer: I never saw PhpSpec code before this mentoring session. All I learned was from my client and their needs (and bit of reading the documentation)</em>.</p>
<h2 id="and-quot-Why-do-you-Have-2-Unit-Testing-Frameworks-and-quot">&quot;Why do you Have 2 Unit-Testing Frameworks?&quot;</h2>
<p>That was my question to one of my clients when I saw both PhpSpec and PHPUnit tests in its code base.</p>
<ul>
<li>&quot;So what is added value of PhpSpec over PHPUnit?&quot;</li>
<li>&quot;Well, I use it for unit testing.&quot;</li>
<li>&quot;How is that different to PHPUnit?&quot;</li>
<li>&quot;It tests the behavior.&quot;</li>
<li>&quot;Well, what is the difference between <code>assertSame()</code> and <code>shouldBeEqualTo()</code>&quot;?</li>
<li>&quot;None really.&quot;</li>
</ul>
<p><br></p>
<p>But before I noticed PhpSpec and asked about it, we had another chat:</p>
<ul>
<li>&quot;Why there is this static class when the rest of your code uses Symfony Dependency Injection?&quot;</li>
<li>&quot;It's needed for my test.&quot;</li>
<li>&quot;Why don't you use <code>KernelTestCase</code>&quot;?</li>
<li>&quot;I can't.&quot;</li>
<li>&quot;Well, you have Symfony and you run your whole application on it, you have PHPUnit, so you can. Why not?&quot;</li>
<li>&quot;It's not PHPUnit, it's PhpSpec.&quot;</li>
<li>&quot;So?&quot;</li>
<li>&quot;It doesn't use any container, there must be static in my code.&quot;</li>
<li>&quot;So what is added value of PhpSpec over PHPUnit?&quot;</li>
<li>&quot;...&quot;</li>
</ul>
<p>Then I explored PhpSpec and found out, it's <strong>basically PHPUnit with different naming</strong>.</p>
<blockquote class="blockquote text-center">
    "It looks like Y, a variant of X, could be done in
    <br>
    about half the time, and you lose only one feature."
    <footer class="blockquote-footer">The Pragmatic Programmer book
</footer></blockquote>
<h2 id="Trends-over-Long-Tail-Effect">Trends over Long-Tail Effect</h2>
<p>Why did we choose to migrate PhpSpec tests to PHPUnit? Well, it's better obviously... Do you agree with me just because I wrote that? <strong>Don't do that, it's my personal opinionated opinion (= feeling, emotion). Ask me for some data instead</strong>.</p>
<p>Let's look at downloads:</p>
<ul>
<li>1 mil. downloads</li>
<li><a href="https://packagist.org/packages/phpspec/phpspec/stats">14 mils. downloads</a></li>
<li><a href="https://packagist.org/packages/phpunit/phpunit/stats">117 mils. downloads</a></li>
</ul>
<p>But 117 mil. downloads can be like &quot;You should use Windows XP because it's the most used Windows version ever!&quot; That's classic manipulation of dying dinosaur.</p>
<p><br></p>
<p><strong>Let's see the trends!</strong> In the same order:</p>
<div class="row">
    <div class="col-md-4 col-sm-4">
        <img src="/assets/images/posts/2019/unit-mig/tester.png">
    </div>
    <div class="col-md-4 col-sm-4">
        <a href="https://packagist.org/packages/phpspec/phpspec/stats">
            <img src="/assets/images/posts/2019/unit-mig/spec.png">
        </a>
    </div>
    <div class="col-md-4 col-sm-4">
        <a href="https://packagist.org/packages/phpunit/phpunit/stats">
            <img src="/assets/images/posts/2019/unit-mig/phpunit.png">
        </a>
    </div>
</div>
<p><br></p>
<p>Which one would you pick from this 2 information? I'd go for the last one, so did my client. <strong>So that's why we agreed to migrate PhpSpec</strong> (the middle one) <strong>to PHPUnit</strong>.</p>
<p><br></p>
<p>This is how 1 spec migration might look like:</p>
<pre><code class="language-diff">-namespace spec\App\Product;
+namespace Tests\App\Product;

-use PhpSpec\ObjectBehavior;

-final class CategorySpec extends ObjectBehavior
+final class CategoryTest extends \PHPUnit\Framework\TestCase
 {
+    /**
+     * @var \App\Product\Category
+     */
+    private $createMe;

-    public function let()
+    protected function setUp(): void
     {
-        $this-&gt;beConstructedWith(5);
+        $this-&gt;createMe = new \App\Product\Category(5);
     }

-    public function it_returns_id()
+    public function testReturnsId()
     {
-        $this-&gt;id()-&gt;shouldReturn(5);
+        $this-&gt;assertSame(5, $this-&gt;createMe-&gt;id());
     }

-    public function it_blows()
+    public function testBlows()
     {
-        $this-&gt;shouldThrow('SomeException')-&gt;during('item', [5]);
+        $this-&gt;expectException('SomeException');
+        $this-&gt;createMe-&gt;item(5);
     }
 }</code></pre>
<p>Pretty clear, right?</p>
<h2 id="How-to-Instantly-Migrate-from-PhpSpec-to-PHPUnit">How to Instantly Migrate from PhpSpec to PHPUnit?</h2>
<p><div class="card ml-4 mt-4 border-warning float-right post-snippet" style="width: 14em">
    <div class="card-body">
        Would you like to <strong>learn more about Rector</strong>? Step by step, from zero to hero?
        <br>

        <div class="text-center">
            <a href="/book/the-power-of-automated-refactoring/">
                <img src="/assets/images/rector_book.png" class="mb-3 mt-3 shadow">
                Get our new book
            </a>
        </div>
    </div>
</div>
</p>
<p>First, take a 2-week paid vacation... Just kidding. Start with Rector which migrates ~95 % of code cases. It also renames <code>*Spec.php</code> to <code>*Test.php</code> and moves them from <code>/spec</code> to <code>/tests</code> directory:</p>
<ol>
<li>Add Rector</li>
</ol>
<pre><code class="language-bash">composer require rector/rector --dev</code></pre>
<ol start="2">
<li>Create <code>rector.php</code> config</li>
</ol>
<pre><code class="language-php">use Rector\Set\ValueObject\SetList;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;import(SetList::PHPSPEC_TO_PHPUNIT);
};</code></pre>
<ol start="3">
<li>Run Rector on your tests directories</li>
</ol>
<pre><code class="language-bash">vendor/bin/rector process tests</code></pre>
<p><br></p>
<p>Take couple of minutes to polish the rest of code and send PR to your project ✅</p>
<p><br></p>
<p>And what was the 2nd testing framework that Rector migrated? <a href="/blog/2019/03/25/how-to-instantly-migrate-nette-tester-to-phpunit">Nette\Tester</a>.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/03/21/how-to-instantly-migrate-phpspec-to-phpunit</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 21 Mar 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/03/21/how-to-instantly-migrate-phpspec-to-phpunit#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Detect Dead PHP Code in Code Review in 7 Snippets ]]></title>
                <link>https://tomasvotruba.com/blog/2019/03/18/how-to-detect-dead-php-code-in-code-review-in-7-snippets</link>
                <description><![CDATA[ <p>After few long Nette to Symfony migration series, it's time for relax.
<br>
Let's look at 7 snippets of PHP code, that <a href="/blog/2018/05/21/is-your-code-readable-by-humans-cognitive-complexity-tells-you/">happily takes your attention</a> but <strong>is never run</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Imagine you're doing a code review of &quot;various improvements&quot; pull-request with <strong>150 changed files</strong>...</p>
<img src="/assets/images/posts/2019/dead-code/fine.jpg" class="img-thumbnail">
<p>Ok, not that one. Let's go <strong>only for 7 changed files</strong>. There will be 7 code snippets, each possibly with extra code that looks useful, but it doesn't do anything really.</p>
<p>Then click on the button to see if you were right :)</p>
<h2 id="1-Duplicated-Array-Key">1. Duplicated Array Key</h2>
<pre><code class="language-php">&lt;?php

$items = [
    1 =&gt; 'A',
    1 =&gt; 'B',
    1 =&gt; 'C'
];</code></pre>
<p>What is <code>1</code>?</p>
<pre><code class="language-php">&lt;?php

var_dump($items[1]);</code></pre>
<p>&quot;A&quot; or &quot;C&quot;? Or Array with all fo them?</p>
<p><a class="btn btn-success mt-2 mb-2" href="https://3v4l.org/cjNWO">See Result</a></p>
<h2 id="2-Key-with-Key-Hole">2. Key with Key-Hole</h2>
<pre><code class="language-php">&lt;?php

$items = [];
$result = [];
foreach ($items as $key =&gt; $value) {
    $result[] = $value;
}</code></pre>
<p>What value is extra here?</p>
<p><a class="btn btn-success mt-2 mb-2" href="#example_2">See Result</a></p>
<p><br>
<br>
<br></p>
<p><a name="example_2"></a></p>
<pre><code class="language-diff">-foreach ($items as $key =&gt; $value) {
+foreach ($items as $value) {
     $result[] = $value;
 }</code></pre>
<h2 id="3-Call-for-Nothing">3. Call for Nothing</h2>
<pre><code class="language-php">&lt;?php

class ParentButNoMethod extends ParentMethod
{
    public function one()
    {
        parent::one();
    }

    public function two()
    {
        parent::two();
    }
}

class ParentMethod
{
    public function one()
    {
    }
}</code></pre>
<p><a class="btn btn-success mt-2 mb-2" href="#example_3">See Result</a></p>
<p><br>
<br>
<br></p>
<p><a name="example_3"></a></p>
<pre><code class="language-diff">&lt;?php

class ParentButNoMethod extends ParentMethod
{
    public function one()
    {
        parent::one();
    }

    public function two()
    {
-       parent::two();
    }
}

class ParentMethod
{
    public function one()
    {
    }
}</code></pre>
<h2 id="4-Reborn">4. Reborn?</h2>
<pre><code class="language-php">&lt;?php

class ProductController
{
    public function actionDiscount(Product $product)
    {
        $discount = $this-&gt;getDiscount();
        $productCategory = $this-&gt;categoryRepository-&gt;findCategoriesByProduct(
            $product-&gt;getCategory()
        );
        $discount = $this-&gt;getDiscount();

        return $this-&gt;render('product/discount.twig', [
            'discount' =&gt; $discount,
            'product' =&gt; $product,
            'productCategory' =&gt; $productCategory,
        ]);
    }
}</code></pre>
<p><a class="btn btn-success mt-2 mb-2" href="#example_4">See Result</a></p>
<p><br>
<br>
<br></p>
<p><a name="example_4"></a></p>
<pre><code class="language-diff">-$discount = $this-&gt;getDiscount();
 $productCategory = $this-&gt;categoryRepository-&gt;findCategoriesByProduct(
     $product-&gt;getCategory()
 );
 $discount = $this-&gt;getDiscount();</code></pre>
<h2 id="5-Behind-the-Mirror">5. Behind the Mirror</h2>
<pre><code class="language-php">&lt;?php

final class TimeMachine
{
    public function mirrorFunction(Quiz $quiz)
    {
        $timeLimit = $this-&gt;resolveTimeLimitForThisTest();
        if ($timeLimit &gt;= 20) {
            return false;
        }

        $timeLimit = $timeLimit;
        if ($this-&gt;isQuizFinished($quiz)) {
            $correctQuestions = 1;
            $correctQuestions = $correctQuestions;
            $incorrectQuestions = $correctQuestions - 3;
        }
    }
}</code></pre>
<p><a class="btn btn-success mt-2 mb-2" href="#example_5">See Result</a></p>
<p><br>
<br>
<br></p>
<p><a name="example_5"></a></p>
<pre><code class="language-diff"> &lt;?php

 final class TimeMachine
 {
     public function mirrorFunction(Quiz $quiz)
     {
         $timeLimit = $this-&gt;resolveTimeLimitForThisTest();
         if ($timeLimit &gt;= 20) {
             return false;
         }

-        $timeLimit = $timeLimit;
         if ($this-&gt;isQuizFinished($quiz)) {
             $correctQuestions = 1;
-            $correctQuestions = $correctQuestions;
             $incorrectQuestions = $correctQuestions - 3;
         }
     }
 }</code></pre>
<h2 id="6-Rinse-and-amp-Repeat">6. Rinse &amp; Repeat</h2>
<pre><code class="language-php">&lt;?php

final class WhateverMethodCall
{
    public function run()
    {
        $directories = 1;
        $anotherDirectories = 1;
        $directories = 2;
        $this-&gt;store($directories);
        $anotherDirectories = 2;
        $directories = 3;
        $anotherDirectories = 3;
        $directories = 4;
        $directories = 5;
        return $directories + $anotherDirectories;
    }
    public function store(int $directories)
    {
    }
}</code></pre>
<p><a class="btn btn-success mt-2 mb-2" href="#example_6">See Result</a></p>
<p><br>
<br>
<br></p>
<p><a name="example_6"></a></p>
<pre><code class="language-diff">&lt;?php

final class WhateverMethodCall
{
    public function run()
    {
-       $directories = 1;
-       $anotherDirectories = 1;
        $directories = 2;
        $this-&gt;store($directories);
-       $anotherDirectories = 2;
-       $directories = 3;
        $anotherDirectories = 3;
-       $directories = 4;
        $directories = 5;
        return $directories + $anotherDirectories;
    }
}</code></pre>
<h2 id="7-Privates-that-No-One-See">7. Privates that No-One See</h2>
<pre><code class="language-php">&lt;?php

final class SomeController
{
    private const MAX_LIMIT = 5;

    private const LIMIT = 5;

    private $cachedValues = [];

    private $cachedItems = [];

    public function run()
    {
        $values = $this-&gt;repeat();
        $values[] = 5;

        return $values + $this-&gt;cachedItems;
    }

    private function repeat()
    {
        $items = [];
        while ($this-&gt;fetch() &amp;&amp; $this-&gt;fetch() &lt; self::LIMIT) {
            $items[] = $this-&gt;fetch();
            $this-&gt;cachedItems[] = $this-&gt;fetch();
        }

        return $items;
    }

    private function fetch()
    {
        return mt_rand(1, 15);
    }

    private function clear()
    {
        $this-&gt;cachedItems = [];
    }
}</code></pre>
<p><a class="btn btn-success mt-2 mb-2" href="#example_7">See Result</a></p>
<p><br>
<br>
<br></p>
<p><a name="example_7"></a></p>
<pre><code class="language-diff">&lt;?php

final class SomeController
{
-    private const MAX_LIMIT = 5;

     private const LIMIT = 5;

-    private $cachedValues = [];

     private $cachedItems = [];

     public function run()
     {
         $values = $this-&gt;repeat();
         $values[] = 5;

         return $values + $this-&gt;cachedItems;
     }

     private function repeat()
     {
         $items = [];
         while ($this-&gt;fetch() &amp;&amp; $this-&gt;fetch() &lt; self::LIMIT) {
             $items[] = $this-&gt;fetch();
             $this-&gt;cachedItems[] = $this-&gt;fetch();
         }

         return $items;
     }

     private function fetch()
     {
         return mt_rand(1, 15);
     }

-    private function clear()
-    {
-        $this-&gt;cachedItems = [];
-    }
}</code></pre>
<h2 id="You-re-in-the-Finish">You're in the Finish!</h2>
<ul>
<li>How many dead codes did you find?</li>
<li>Did you just scan right here, because the task was too hard and it didn't make sense to you?</li>
<li>Would you do it again tomorrow or rather code?</li>
</ul>
<p>No wonder <strong>people don't do code-review</strong> (right), there is no time and it's often super boring.</p>
<p><br></p>
<p>What if there would be a way to <strong>automate all that checks above</strong> + 10 more with a CI tool. Something that:</p>
<ul>
<li>would <strong>do code-review for you</strong> making your team much smarter forever</li>
<li>would <strong>not require your check</strong> on every new piece of code</li>
<li>you could <strong>extend</strong> as you like</li>
</ul>
<h2 id="Have-you-tried-Rector">Have you tried Rector?</h2>
<p>Rector doesn't only refactor applications from one framework to another, upgrade your codebase and get you out of legacy. It can be also <strong>part of your CI</strong>:</p>
<ol>
<li>Install Rector</li>
</ol>
<pre><code class="language-bash">composer require rector/rector --dev</code></pre>
<ol start="2">
<li>Update <code>rector.php</code> with dead code set</li>
</ol>
<pre><code class="language-php">use Rector\Set\ValueObject\SetList;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;import(SetList::DEAD_CODE);
};</code></pre>
<ol start="3">
<li>Run Rector</li>
</ol>
<pre><code class="language-bash">vendor/bin/rector process src --dry-run</code></pre>
<p><strong>If Rector detects any dead code, CI will fail</strong>. You can, of course, run it without <code>--dry-run</code> after to actually remove the code.</p>
<p>See <a href="https://github.com/rectorphp/rector/blob/master/docs/rector_rules_overview.md#deadcode">Dead Code set</a> for more features.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/03/18/how-to-detect-dead-php-code-in-code-review-in-7-snippets</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 18 Mar 2019 00:00:00 +0000</pubDate>
                                    <updated>2020-11-01UTC00:00:000</updated>
                    <atom:updated>Sun, 01 Nov 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sun, 01 Nov 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/03/18/how-to-detect-dead-php-code-in-code-review-in-7-snippets#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Remove Dead Public Methods from Your Code ]]></title>
                <link>https://tomasvotruba.com/blog/2019/03/14/remove-dead-public-methdos-from-your-code</link>
                <description><![CDATA[ <p>We already have sniffs and rectors to remove unused private methods. But what about public methods? If you're creating open-source packages, public methods might be used by anyone.
<br><br>
But what if you're creating an application - you can remove unused with peace in mind.
There is only one problem to resolve - <strong>find public unused methods</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p><em>Too long to read? Look at <a href="https://www.youtube.com/watch?v=sKFB6XVmO_Q">3:45 min practical video</a> by a friend of mine <a href="https://jankuchar.cz">Jan Kuchař</a>.</em></p>
<p><br></p>
<p>As we code on an application for many years, some methods may be replaced by a few new-ones:</p>
<pre><code class="language-diff"> $person = new Person('Tomas');
-$person-&gt;getFullName();
+$person-&gt;getName();</code></pre>
<p>If the application is complex, we may not know if the old method is still in use anywhere:</p>
<pre><code class="language-php">&lt;?php

class Person
{
    /**
     * @var string
     */
    private $name;

    public function __construct(string $name)
    {
        $this-&gt;name = $name;
    }

    public function getName()
    {
        // ...
    }

    public function getFullName()
    {
        // ...
    }
}</code></pre>
<p>We don't have to manually read the codebase file by file. PHPStorm can help us examine each public method and where they are being used.</p>
<p><strong>Just right-click the method call</strong> (&quot;provide&quot; in the picture) <strong>and select &quot;Find Usages&quot;</strong>.</p>
<img src="/assets/images/posts/2019/dead-public/usages.png" class="img-thumbnail">
<p>It took us 5-10 seconds to <strong>find out that <code>getFullName()</code> is a dead method</strong>. Great job!</p>
<h2 id="Can-we-Find-Them-Faster">Can we Find Them Faster?</h2>
<p>Now <strong>do the same for all the other public methods</strong>.</p>
<p>I consider Symplify project quite small, at least compared to private web applications. Yet, there <a href="https://github.com/symplify/symplify/search?q=%22public+function%22&amp;unscoped_q=%22public+function%22">is over 684 public methods</a>. Even if we remove public methods from test fixtures, there will remain ~ 500 public methods:</p>
<div class="blockquote text-center">
    500 * 5 secs = 2500 secs ~= 41 mins
</div>
<p>...and we don't talk about brain wasted on linear operations. This is not the way.</p>
<h2 id="How-to-find-them-in-1-Minute">How to find them in 1 Minute?</h2>
<p>There is one little sniff in <code>symplify/coding-standard</code> only few people know about. Set it up:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();
    $services-&gt;set(Symplify\CodingStandard\Sniffs\DeadCode\UnusedPublicMethodSniff::class);
};</code></pre>
<p>And use it:</p>
<pre><code class="language-bash">vendor/bin/ecs check src</code></pre>
<h2 id="Magic">Magic?</h2>
<p>Not really. The sniff goes through your code and:</p>
<ul>
<li>finds all methods: <code>public function someMethod()</code></li>
<li>then find all method calls: <code>$this-&gt;someMethod()</code></li>
<li>and simply <strong>reports those public functions that were never called</strong></li>
</ul>
<p>Then just skip false positives, that are <a href="https://github.com/rectorphp/rector/blob/a8db80baff48eb02319963b3380f185461678815/packages/NodeTypeResolver/config/config.yaml#L15">called in yaml configs</a> or in strings - and that is it!</p>
<p><strong>You'll be surprised, how many methods are dead in your code :)</strong></p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/03/14/remove-dead-public-methdos-from-your-code</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 14 Mar 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/03/14/remove-dead-public-methdos-from-your-code#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Why we Migrated from Nette to Symfony in 3 Weeks - Part 3 - Brain Drain Dead Packages-Lock ]]></title>
                <link>https://tomasvotruba.com/blog/2019/03/11/why-we-migrated-from-nette-to-symfony-in-3-weeks-part-3</link>
                <description><![CDATA[ <p>Do you want to <strong>migrate your project from Nette to Symfony</strong>? In <a href="/blog/2019/03/07/why-we-migrated-from-nette-to-symfony-in-3-weeks-part-2/">the part 2</a> we looked at <strong>escaping semver hell</strong>.
<br><br>
Today we'll look on <strong>package vendor-locks</strong> caused by brain drain.</p> ]]></description>
                <content:encoded><![CDATA[ <p><em>This post will be a bit harder for me because I'm part of this problem. I'm a former Nette activist and open-source hyper. I created many open-source packages Nette developers use, but those are not actively maintained nor developed for the last couple of years. I'm sorry about that.</em></p>
<p><br></p>
<p><strong>If you love Nette, <a href="/blog/2018/05/31/symfony-vs-laravel-vs-nette-which-php-framework-you-should-choose/">keep using it</a>. This post is for people, whose companies are hurt by being locked to Nette ecosystem and who want to solve that but don't know how or if that is even possible.</strong></p>
<h2 id="February-2017">February 2017...</h2>
<p>When we talked with <a href="https://janmikes.cz">Honza</a> about framework A → framework B migration first related to <a href="https://entry.do">Entry.do</a>, it was on the first PHP Mountains 2017. Rector was still 5 months before being born, so manual work was the only way.</p>
<p>First, we looked into <code>composer.json</code> and tried to get rid of some packages. What packages we won't need on Symfony?</p>
<ul>
<li><code>kdyby/events</code></li>
<li><code>kdyby/console</code></li>
<li><code>kdyby/doctrine</code></li>
<li><code>kdyby/rabbitmq</code></li>
<li><code>kdyby/redis</code></li>
<li><code>kdyby/translation</code></li>
<li><code>zenify/doctrine-behaviors</code></li>
<li><code>zenify/doctrine-migrations</code></li>
<li><code>zenify/doctrine-filters</code></li>
<li><code>zenify/modular-latte-filters</code></li>
<li><code>zenify/doctrine-fixtures</code></li>
<li><code>zenify/doctrine-extensions-tree</code></li>
</ul>
<p><strong>We could drop all these</strong>, because:</p>
<ul>
<li><code>kdyby/*</code> is basically integration of Symfony packages with <code>nette/di</code>,</li>
<li>and <code>zenify/*</code> is basically <code>doctrine/*</code> integration with <code>nette/di</code></li>
</ul>
<p>Of course, you can't delete them right away. Yet, <a href="/blog/2019/02/21/how-we-migrated-from-nette-to-symfony-in-3-weeks-part-1/#3-automated-migration-gt-manual-changes">Rector covers most of this migration now</a>, so this part is fine.</p>
<h2 id="Upgrade-Lagging">Upgrade Lagging</h2>
<p>We decided to remove Symfony/Doctrine <em>glue packages</em> first, so we could work with fewer dependencies and be more flexible. And upgrade PHP first, so we can use right the newest Symfony packages.</p>
<p>We tried to remove one <code>zenify/*</code> package (because it's small → possibly easy to replace) and use the package we have in control.</p>
<h3 id="object"><code>object</code></h3>
<p>Thing is, PHP 7.2 introduced <code>object</code> keyword:</p>
<img src="/assets/images/posts/2019/nette-to-symfony3/nette-object-easy.png" class="img-thumbnail">
<p>Nette had class <code>Nette\Object</code> that was actively promoted as the parent of all classes in your code. Now it had *<em>to be removed from all these classes and replaced by trait</em>:</p>
<pre><code class="language-diff"> &lt;?php

-class SomeClass extends Nette\Object
+class SomeClass
 {
+    use Nette\SmartObject;
 }</code></pre>
<p><em>If you still have this problem, <a href="https://github.com/rectorphp/rector/blob/master/docs/rector_rules_overview.md#parentclasstotraitsrector">use Rector that handles this case</a>.</em></p>
<p><br></p>
<p>In that time, we had to use PHPStorm old-school <em>find &amp; replace</em> with regex pattern:</p>
<img src="/assets/images/posts/2019/nette-to-symfony3/nette-object-your-code.png">
<p>The upgrade path is like a road with holes. It's getting crappy, but there is still at least some road 👍</p>
<p><strong>But what if there are many packages</strong>, that nobody actively takes care of?</p>
<img src="/assets/images/posts/2019/nette-to-symfony3/nette-object-in-3rd-party.png">
<p><strong>Until the maintainer fixes that, the upgrade path is closed</strong>. We'd have to fork every Nette package that is not maintained, fix it manually in the code and add them into <code>composer.json</code>.</p>
<p>We don't talk about small package with few classes that is easy to rewrite:</p>
<img src="/assets/images/posts/2019/nette-to-symfony3/downloads.png" class="img-thumbnail">
<p>Most of Kdyby packages still have <a href="https://packagist.org/packages/kdyby/doctrine/stats">500-900 daily downloads</a>. Even if we take CI servers into account, that still <strong>might be 120-150 PHP applications</strong> locked to legacy with packages that no-one maintains.</p>
<blockquote class="blockquote text-center mt-5 mb-5">
    "When you stop growing, you start dying."
</blockquote>
<h2 id="Nette-Brain-Drain">Nette Brain Drain?</h2>
<p>With a healthy active community as in Laravel or Symfony, there would be PR and we never came across this problem. What's different with Nette?</p>
<p>David Grudl, the author of Nette <a href="https://twitter.com/geekovo/status/417869320677367808">tweeted at the end of 2013</a> that <strong>he ends with Nette</strong>. &quot;One tweet&quot;, you might think, but there was more of similar news on Nette forum and popular Czech IT blogs.</p>
<p>Many years later, when I become a Symfony consultant, I asked companies why did they choose Symfony over Nette. After all, there were Nette meetups in our the Czech Republic every month and maybe 2 non-Nette PHP meetups about other frameworks. The answer was almost unanimous: when they discussed what PHP framework to use, they saw David's tweet. <strong>They needed something stable they could for the next 5 years.</strong></p>
<p><br></p>
<p>In following years, without anyone noticing, <strong>slow brain drain from Nette to Symfony, Java or Javascript</strong> started:</p>
<ul>
<li><a href="https://prochazka.su">Filip Procházka</a>, the author of Kdyby → is now Java programmer</li>
<li><a href="https://patrik.votocek.cz">Patrik Votoček</a>, one of first Nette evangelist and author of Nella →  switched to Symfony, then to chaos monkey,</li>
<li><a href="https://github.com/mrtnzlml">Martin Zlámal</a>, very active Nette evangelist who held many Nette/PHP talks on university → now works with Javascript at Kiwi.com</li>
<li><a href="http://enumag.cz">Jáchym Toušek</a>, active Symfony to Nette integrator → switched to Symfony</li>
<li>I, author of Zenify and Symnedi → switched to Symfony</li>
<li>...</li>
</ul>
<p><strong>Many of open-source packages for Nette slowly become unmaintained.</strong> So this error is new status-quo for these packages:</p>
<img src="/assets/images/posts/2019/nette-to-symfony3/nette-object-in-3rd-party.png">
<p><br></p>
<p>When we realized with Honza that night, that to upgrade project means &quot;fork every unmaintained dependency and I hope there will be better times&quot;, we stopped. But <strong>the motivation remained and 2 years later</strong>, with better skills and Rector, we managed to migrate the application from Nette to Symfony in less than a month.</p>
<p><br></p>
<h2 id="Come-to-Meetup-and-Tell-Us-About-Your-Problem">Come to Meetup and Tell Us About Your Problem</h2>
<p>Are you stuck with Nette at home and thinking about in your wet dreams Symfony? This is your lucky week! :)</p>
<p>Honza Mikes will talk about Nette to Symfony migration on PHP meetup in Prague this Thursday - 14. 3.</p>
<p>Entrance free, language is English and I'll be there too!</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/03/11/why-we-migrated-from-nette-to-symfony-in-3-weeks-part-3</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 11 Mar 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/03/11/why-we-migrated-from-nette-to-symfony-in-3-weeks-part-3#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Why we Migrated from Nette to Symfony in 3 Weeks - Part 2 - Escaping Semantic Hell ]]></title>
                <link>https://tomasvotruba.com/blog/2019/03/07/why-we-migrated-from-nette-to-symfony-in-3-weeks-part-2</link>
                <description><![CDATA[ <p>Do you want to <strong>migrate your project from Nette to Symfony</strong>? In <a href="/blog/2019/02/21/how-we-migrated-from-nette-to-symfony-in-3-weeks-part-1/">part 1</a> we showed you how to get your project ready, why it's important to make team commitment and what you can automate.
<br><br>
Today we'll look on one of the core reasons for this migration - <strong>escaping to semantic hell</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p><a href="https://semver.org">Semantic versioning</a> aka <em>semver</em> tells you there is a BC break between <code>nette/di</code> in version 2.5 and 3.0. That's all you need to know as a web developer.</p>
<p>If you're an open-source developer, you'll probably learn more about semver. If you do it right, your user will be happy and never have to learn anything more 2.5 and 3.0.</p>
<h2 id="From-Nette">From Nette...</h2>
<p>When you run <code>composer update</code> Nette project, you'll find this normal:</p>
<img src="/assets/images/posts/2019/nette-to-symfony2/version-hell.png" style="max-width:30em">
<p>You can see there 3 variants:</p>
<ul>
<li><code>nette/utils</code> is on 2.5.3</li>
<li><code>nette/tokenizer</code> is on 2.3.0</li>
<li><code>nette/mail</code> is on 2.4.6</li>
</ul>
<p>Today, there are also some Nette packages on 3, but some not. Who cares, right?</p>
<p>If you don't know Nette, you might think &quot;why would somebody use the different versions in their <code>composer.json</code>&quot;?</p>
<pre><code class="language-json">{
   "require": {
       "nette/utils": "^2.5",
       "nette/tokenizer": "^2.3",
       "nette/mail": "^2.4"
   }
}</code></pre>
<p>Actually, <code>composer.json</code> looks like this:</p>
<pre><code class="language-json">{
   "require": {
       "nette/utils": "^2.3",
       "nette/tokenizer": "^2.3",
       "nette/mail": "^2.3"
   }
}</code></pre>
<p>And that's a huge overhead with Nette versioning. Each package requires different versions, even v2, and 3 at the same time. If you upgrade to the newer version, the last thing you want to solve is conflicts in a package that are not yours:</p>
<img src="/assets/images/posts/2019/nette-to-symfony2/install-fail.png">
<h2 id="What-s-different-in-Symfony">What's different in Symfony?</h2>
<p>When you install Symfony 4.0, you know that:</p>
<ul>
<li><strong>all your packages</strong> are using Symfony 4.0</li>
<li>all Symfony packages <strong>are compatible</strong> with each other</li>
<li><strong>when you find a bug</strong>, it will be fixed in Symfony 4.0.x</li>
<li>you can look forward to next version 4.1 in 6 months :)</li>
</ul>
<p>This approach is super stable since Symfony 3.4 and 2017. You can really on <a href="https://symfony.com/doc/current/contributing/code/bc.html">Symfony promise</a> it more than of stability airplanes (I'm writing this post on one, I hope this statement is true :D).</p>
<p>Imagine you're looking for a bug across <code>symfony/console</code> 3.4, <code>symfony/dependency-injection</code> 4.1 and <code>symfony/finder</code> 4.2. Or just read the Symfony documentation in 3 different versions.</p>
<h2 id="Don-t-Bother-the-User-with-Bad-Package-Design">Don't Bother the User with Bad Package Design</h2>
<p>Since I was raised in Nette, I used <strong>per-package tagging</strong> in my open-source projects (<em>Zenify</em>, <em>Symnedi</em> and now <em>Symplify</em>). It allowed me to release new versions when the package needed it.</p>
<ul>
<li>Does<code>zenify/doctrine-filters</code> has a BC break? Let's release 3.</li>
<li>Are there no changes <code>zenify/coding-standard</code> in last 1 year? Stick it with 1.</li>
</ul>
<p>That's <em>nice to have</em> for the maintainer. But what about the developers who use your packages? <strong>It's extra maintenance with 0-benefits.</strong></p>
<blockquote class="blockquote mt-5 mb-5 text-center">
    There should be less and academic thinking in programming
    <br>and more <strong>pragmatic common sense</strong>. We were born with it.
</blockquote>
<p>Maintainers should read books like <a href="https://www.amazon.com/Design-Everyday-Things-Revised-Expanded-ebook/dp/B06XCCZJ4L">The Design of Everyday Things</a>, <a href="https://www.amazon.com/Dont-Make-Think-Revisited-Usability-ebook-dp-B00HJUBRPG/dp/B00HJUBRPG">Don't Make me Think</a> and <a href="https://www.amazon.com/Pragmatic-Programmer-Journeyman-Master-ebook-dp-B003GCTQAE/dp/B003GCTQAE">The Pragmatic Programmer</a> to understand how others see our code.</p>
<h2 id="Symfony-KISS-Per-Vendor-Tagging">Symfony KISS = Per-Vendor Tagging</h2>
<p>So I decided <strong>to try <a href="/blog/2017/10/30/what-can-you-learn-from-menstruation-and-symfony-releases/">per-vendor tagging</a></strong> over per-package tagging. Now I have to answer questions like &quot;Why did you release a new version of your package, but no change between version 3.2.0 and 3.3.0?&quot; But I know <strong>bothering developers with semver-hell</strong> is not a better choice, so I answer patiently (with a link to this post :)).</p>
<p>After all:</p>
<blockquote class="blockquote text-center">
   There are no best solutions, just trade-offs.
</blockquote>
<p><br></p>
<p><strong>This was one of our reasons we switched from Nette to Symfony</strong>. Now we can upgrade all ~35 Symfony packages at once knowing they all work together.</p>
<p><br></p>
<p>Do you think it's impossible change for your project? Drop us a <a href="https://getrector.org">message at Rector</a>. We'll help you.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/03/07/why-we-migrated-from-nette-to-symfony-in-3-weeks-part-2</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 07 Mar 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/03/07/why-we-migrated-from-nette-to-symfony-in-3-weeks-part-2#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to turn Laravel from Static to Dependency Injection in one Day ]]></title>
                <link>https://tomasvotruba.com/blog/2019/03/04/how-to-turn-laravel-from-static-to-dependency-injection-in-one-day</link>
                <description><![CDATA[ <p>A framework is just a tool. Each teaches you coding habits you need to use them effectively.
Like Laravel gives you speed at prototyping with static &quot;facades&quot;. But the applications grows, so does the team, so does your skill and <strong>you start to prefer constructor injection</strong>.
<br><br>
What then? Switch framework or rewrite? But what if all you need is to <strong>switch single pattern</strong>?</p> ]]></description>
                <content:encoded><![CDATA[ <p>I don't use Laravel in my own life, but I follow the community closely. It likes the idea of Contracts from day 1 and it's also part of Rector upgrade set.</p>
<p>Recently I read the <a href="https://www.freecodecamp.org/news/moving-away-from-magic-or-why-i-dont-want-to-use-laravel-anymore-2ce098c979bd/">Moving away from magic—or: why I don’t want to use Laravel anymore</a> on medium by <em>Niklas Schöllhorn</em>.</p>
<p><a href="https://medium.freecodecamp.org/moving-away-from-magic-or-why-i-dont-want-to-use-laravel-anymore-2ce098c979bd"></p>
<img src="/assets/images/posts/2019/laravel/best-seller.png" class="img-thumbnail">
<p></a></p>
<p>Read the post, it's really beautifully written with respect to the framework by somebody, who uses is for 2 years. Also, I think it's <strong>about the natural evolution of code and how to deal with it</strong>, not Laravel itself.</p>
<p>Niklas finishes the post with a reasonable statement:</p>
<blockquote class="blockquote text-center">
"Other frameworks and tools come with better-designed defaults and less magic. So for now, I’ll say goodbye to Laravel."
</blockquote>
<p>But is switching the framework (language, girlfriends, parents...) really the best solution?</p>
<h2 id="Do-You-Leave-Your-Kid-on-Puberty">Do You Leave Your Kid on Puberty?</h2>
<p>Thing is, every framework (and developer) has this step in evolution. So did <a href="/blog/2018/04/26/how-i-got-into-static-trap-and-made-fool-of-myself/">Symplify with static methods</a>. Each framework I used in some period of its evolution used static:</p>
<p><strong>Nette</strong></p>
<pre><code class="language-php">&lt;?php

$result = Container::get('some_service')-&gt;someMethod();</code></pre>
<p><strong>Symfony</strong></p>
<pre><code class="language-php">&lt;?php

$result = $this-&gt;get('some_service')-&gt;someMethod();</code></pre>
<p><strong>Laravel</strong></p>
<pre><code class="language-php">&lt;?php

$result = SomeService::someMethod();</code></pre>
<h2 id="Help-Your-Parents-Grow">Help Your Parents Grow</h2>
<p>I don't think the point is to leave the framework but to help it to the quality. E.g. Symfony <strong>constructor injection autowiring wasn't always there</strong>. It was first suggested around Symfony 2.3 but strictly rejected by Fabien as an anti-pattern.</p>
<p>It took many bundles like <code>Kutny\AutowiringBundle</code>, <code>Skrz\Autowiring</code> or <code>symplify\autowiring</code>, closed issues and PRs with proof of concept before the Symfony core team was convinced enough to accept next autowiring-PR, <strong>that laid the foundation to autowiring we use today</strong>.</p>
<p>This is a completely normal process of community learning.</p>
<h2 id="and-quot-So-How-do-I-get-rid-of-Static-in-Laravel-and-quot">&quot;So How do I get rid of Static in Laravel?&quot;</h2>
<p>One option is change pattern by <strong>switching to another framework</strong>, that already promotes the feature you want. I did this once with Nette when the development stopped around 2015. First, I tried to add a feature, make packages with integration and propose PRs and issues. But after a few years of failure, I decided to switch to Symfony.</p>
<p>The second option is to try the approach in your framework, regardless of what is considered <em>best practice</em> or the <em>framework-way</em>.</p>
<p><div class="card ml-4 mt-4 border-warning float-right post-snippet" style="width: 14em">
    <div class="card-body">
        Would you like to <strong>learn more about Rector</strong>? Step by step, from zero to hero?
        <br>

        <div class="text-center">
            <a href="/book/the-power-of-automated-refactoring/">
                <img src="/assets/images/rector_book.png" class="mb-3 mt-3 shadow">
                Get our new book
            </a>
        </div>
    </div>
</div>
</p>
<h2 id="How-move-to-Dependency-Injection-in-Laravel">How move to Dependency Injection in Laravel?</h2>
<p>I like the way suggested in <a href="https://medium.freecodecamp.org/moving-away-from-magic-or-why-i-dont-want-to-use-laravel-anymore-2ce098c979bd">post above</a>.</p>
<pre><code class="language-diff"> &lt;?php

 namespace App\Http;

 use App\Example;
 use Request;
 use Response;

 class ExampleController extends Controller
 {
+    /**
+     * @var ResponseFactory
+     */
+    private $responseFactory;
+
+    public function __construct(ResponseFactory $responseFactory)
+    {
+        $this-&gt;responseFactory = $responseFactory;
+    }
+
     public function store()
     {
         $example = 5;
-        return Response::view('example',
+        return $this-&gt;responseFactory-&gt;view('example',
             ['new_example' =&gt; $example]
         );
     }
 }</code></pre>
<p>That looks great! If you have ~10 cases like that, you're done instead of reading this post.</p>
<p>But what if your project is commercially successful and there are 100+ cases like this? You'd probably think &quot;it would be nice for my small pet project, but my boss wouldn't pay for that&quot;.</p>
<h2 id="Rector-to-the-Rescue">Rector to the Rescue</h2>
<p>These kinds of problems are <em>so 2018</em>. Recently Rector got on board <a href="https://github.com/rectorphp/rector/pulls?utf8=%E2%9C%93&amp;q=laravel">Laravel instant upgrades</a>, first with Laravel 5.8.</p>
<p>Next impulse was the post by Niklas, so I've <strong>converted his idea to Rector rule</strong>. The change from facades to constructor injection can be done with new <code>laravel-static-to-injection</code>:</p>
<ol>
<li>Install Rector</li>
</ol>
<pre><code class="language-bash">composer require rector/rector --dev</code></pre>
<ol start="2">
<li>Create <code>rector.php</code> config with <code>SetList::LARAVEL_STATIC_TO_INJECTION</code> set</li>
</ol>
<pre><code class="language-php">use Rector\Laravel\Set\LaravelSetList;use Rector\Set\ValueObject\SetList;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;import(LaravelSetList::LARAVEL_STATIC_TO_INJECTION);
};</code></pre>
<ol start="3">
<li>Run Rector</li>
</ol>
<pre><code class="language-bash">vendor/bin/rector process /src</code></pre>
<p>No need to switch framework and you can enjoy new constructor injection in your Laravel application matter of minutes.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/03/04/how-to-turn-laravel-from-static-to-dependency-injection-in-one-day</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 04 Mar 2019 00:00:00 +0000</pubDate>
                                    <updated>2020-11-01UTC00:00:000</updated>
                    <atom:updated>Sun, 01 Nov 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sun, 01 Nov 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/03/04/how-to-turn-laravel-from-static-to-dependency-injection-in-one-day#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Upgrade Symfony 2.8 to 3.4 ]]></title>
                <link>https://tomasvotruba.com/blog/2019/02/28/how-to-upgrade-symfony-2-8-to-3-4</link>
                <description><![CDATA[ <p>Are you Symfony programmer? Do you work on a successful project? Then upgrading the Symfony project is a work you can't avoid.
Almost a year ago I wrote about <a href="https://blog.shopsys.com/5-5-steps-to-migrate-from-symfony-2-8-lts-to-symfony-3-4-lts-in-real-prs-50c98eb0e9f6">Five and Half Steps to Migrate from Symfony 2.8 LTS to Symfony 3.4 LTS in Real PRs</a>.
<br><br>
Now it's much easier to jump from one LTS to another - with <strong>instant upgrades</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Recently, more and more issues pop-up at Symfony repository <strong>asking for automated upgrade</strong>:</p>
<ul>
<li><a href="https://github.com/symfony/symfony/issues/30054">Why not to create a symfony framework updater software from command line</a></li>
</ul>
<p>I'm happy Symfony core team is supporting generic solution to all PHP-code upgrades ↓</p>
<img src="/assets/images/posts/2019/symfony-up/nick.png" class="img-thumbnail">
<h2 id="Upgrade-Symfony-and-PHP">Upgrade Symfony... and PHP</h2>
<p>To make a bad situation more complicated, this upgrade is also related to upgrading of PHP - <strong>Symfony 3.4 requires PHP 5.5.</strong></p>
<p>I wrote about <a href="/blog/2018/11/08/fatal-error-uncaught-error-operator-not-supported-for-strings-in/">PHP upgrades before</a>, but the main away is to upgrade <strong>one minor version at once</strong>:</p>
<ul>
<li>Symfony 2.8 → 3.0</li>
<li>PHP 5.3 → 5.4</li>
<li>Symfony 3.0 → 3.1</li>
<li>Symfony 3.1 → 3.2</li>
<li>PHP 5.4 → 5.5</li>
<li>Symfony 3.2 → 3.3</li>
<li>Symfony 3.3 → 3.4</li>
</ul>
<p>If you split each of these lines into standalone pull-requests, you're the best!</p>
<p><div class="card ml-4 mt-4 border-warning float-right post-snippet" style="width: 14em">
    <div class="card-body">
        Would you like to <strong>learn more about Rector</strong>? Step by step, from zero to hero?
        <br>

        <div class="text-center">
            <a href="/book/the-power-of-automated-refactoring/">
                <img src="/assets/images/rector_book.png" class="mb-3 mt-3 shadow">
                Get our new book
            </a>
        </div>
    </div>
</div>
</p>
<h2 id="Forget-UPGRADE-md">Forget <code>UPGRADE.md</code></h2>
<p>You probably know I work almost part-time on <a href="https://getrector.org">the Rector project</a>. I gather feedback from conferences and meetups all over Europe and try to make Rector better every day. Recently he also migrated between <a href="/blog/2019/02/21/how-we-migrated-from-nette-to-symfony-in-3-weeks-part-1">2 PHP frameworks</a>, because why not?</p>
<p>The PHP community gives me positive vibes about going the right direction. It helps me to make PHP and Symfony <strong>sets more and more complete</strong>.</p>
<h2 id="How-to-Upgrade-then">How to Upgrade then?</h2>
<p>All you need to do to upgrade your PHP code is to install Rector and run particular upgrades.</p>
<p><strong>Do you want to upgrade from Symfony 2.8 to 3.4?</strong></p>
<pre><code class="language-bash">composer require rector/rector --dev</code></pre>
<p>Create <code>rector.php</code> config:</p>
<pre><code class="language-bash">vendor/bin/rector init</code></pre>
<p>Add Symfony sets in it:</p>
<pre><code class="language-php">use Rector\Symfony\Set\SymfonySetList;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;import(SymfonySetList::SYMFONY_28);
    // take it 1 set at a time to so next set works with output of the previous set; I do 1 set per pull-request
    // $rectorConfig-&gt;import(SymfonySetList::SYMFONY_30);
    // $rectorConfig-&gt;import(SymfonySetList::SYMFONY_31);
    // $rectorConfig-&gt;import(SymfonySetList::SYMFONY_32);
    // $rectorConfig-&gt;import(SymfonySetList::SYMFONY_33);
    // $rectorConfig-&gt;import(SymfonySetList::SYMFONY_34);

    // set paths to directories with your code
    $parameters = $containerConfigurator-&gt;parameters();
    $parameters-&gt;set(Option::PATHS, [
        __DIR__ . '/app',
        __DIR__ . '/src',
        __DIR__ . '/tests',
    ]);
};</code></pre>
<p><strong>Are you stuck on old PHP 5.3?</strong> Rector got you covered:</p>
<pre><code class="language-php">use Rector\Set\ValueObject\SetList;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;import(SetList::PHP_53);
    // again 1 set at a time
    // $rectorConfig-&gt;import(SetList::PHP_54);
    // $rectorConfig-&gt;import(SetList::PHP_55);
    // $rectorConfig-&gt;import(SetList::PHP_56);
    // ...
};</code></pre>
<h2 id="Awesome-Symfony-3-3-Dependency-Injection">Awesome Symfony 3.3+ Dependency Injection</h2>
<p>Upgrade to Symfony 3.3 shrunk my configs to 1/5 of its original size. That's the  #1 reason you want to upgrade. If you don't know what I'm talking about, check <a href="/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3/">the diff post about those features</a>. But wait, don't do it manually! <strong><a href="/blog/2018/12/27/how-to-convert-all-your-symfony-service-configs-to-autodiscovery/">This tool converts it all</a> for you.</strong></p>
<p><br></p>
<p>And that's how we upgrade in 2019 :)</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/02/28/how-to-upgrade-symfony-2-8-to-3-4</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 28 Feb 2019 00:00:00 +0000</pubDate>
                                    <updated>2020-11-01UTC00:00:000</updated>
                    <atom:updated>Sun, 01 Nov 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sun, 01 Nov 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/02/28/how-to-upgrade-symfony-2-8-to-3-4#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 5 Tips to Effective Work with Github Repository ]]></title>
                <link>https://tomasvotruba.com/blog/2019/02/25/5-tips-to-effective-work-with-github-repository</link>
                <description><![CDATA[ <p>The best programmers aren't the smartest in the field. They're lazy, <strong>they know their tools well</strong> and <strong>they know good tools</strong> other programmers don't.
<br><br>
Do you know the following tips?</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="1-Single-Char-Console-Commands-for-Your-Tired-Fingers">1. Single-Char Console Commands for Your Tired Fingers</h2>
<p>Which one is correct?</p>
<pre><code class="language-bash">vendor/bin/rector process
vendor/bin/rector procces
vendor/bin/rector proccess
vendor/bin/rector proces</code></pre>
<p>You don't want to think about this and you don't have to! Just <strong>use the first letter</strong>:</p>
<pre><code class="language-bash">vendor/bin/rector p</code></pre>
<p>Works every-time there is no command named with that letter:</p>
<pre><code class="language-diff">-vendor/bin/phsptan analyse
+vendor/bin/phsptan a</code></pre>
<pre><code class="language-diff">-vendor/bin/ecs check
+vendor/bin/ecs c</code></pre>
<p>👍</p>
<h2 id="2-Be-informed-about-New-Packages-with-no-Spam">2. Be informed about New Packages - with no Spam!</h2>
<p>When you &quot;watch&quot; a Github repository, you'll get a notification about every new release, issue, pull-request, or comments. This makes sense when you maintain a repository, but for most of the people, it's annoying spam.</p>
<p>GitHub recently introduced a very nice feature. It will add notification <strong>only for releases</strong>:</p>
<img src="/assets/images/posts/2019/github-tips/github-subscription.png" class="img-thumbnail">
<p>👍</p>
<h2 id="3-Fix-Typos-with-UP">3. Fix Typos with UP</h2>
<p>Have you ever sent a comment with a typo? I barely do without, and always notice that after I hit the &quot;send&quot; (or CTRL + Enter).</p>
<p>Now move your cursor to the 3 dots in the right corner of the comment, click, select <em>Edit</em> and click again.</p>
<p><strong>No more!</strong></p>
<img src="/assets/images/posts/2019/github-tips/up.gif" class="img-thumbnail">
<p>Just <strong>hit ↑</strong> (arrow up), and you're there!</p>
<p>👍</p>
<h2 id="4-Refine-your-Github">4. Refine your Github</h2>
<p><a href="https://github.com/sindresorhus/refined-github">sindresorhus/refined-github</a> is like a smart secretary that gives you tips you ever wanted to know.</p>
<p><br></p>
<p>It <strong>narrows 3 click operation to single click</strong> - creating a pull-request from a fresh branch:</p>
<img src="https://user-images.githubusercontent.com/1402241/34099674-20433f60-e41b-11e7-8ca5-7ea23c70ab95.gif" class="img-thumbnail">
<p><br></p>
<p>It <strong>interlinks issues and PRs without opening them</strong>:</p>
<img src="https://user-images.githubusercontent.com/1402241/37037746-8b8eac8a-2185-11e8-94f6-4d50a9c8a152.png" class="img-thumbnail" style="max-width:35em">
<p><br></p>
<p>When I work on different pc, I feel stupid without this one. <strong>Issues sorted by activity</strong> beats default <em>create time</em>:</p>
<img src="/assets/images/posts/2019/github-tips/first-new.png" class="img-thumbnail">
<p><br></p>
<p>Check more of them in <a href="https://github.com/sindresorhus/refined-github#highlights">the README</a>.</p>
<h2 id="5-Extend-Composer-Scripts-from-CLI">5. Extend Composer Scripts from CLI</h2>
<p>Have you read the classic post <a href="https://blog.martinhujer.cz/have-you-tried-composer-scripts">Have you tried Composer Scripts? You may not need Phing</a>? I love this approach for simple scripts like coding standard and static analysis:</p>
<pre><code class="language-json">{
    "scripts": {
        "check-cs": "vendor/bin/ecs check bin src tests",
        "fix-cs": "vendor/bin/ecs check bin src tests --fix",
        "phpstan": "vendor/bin/phpstan analyse bin src tests --error-format symplify"
    }
}</code></pre>
<h3 id="What-s-the-Script-Name">What's the Script Name?</h3>
<p>But what if you forget it's &quot;check-cs&quot;? And what if you open a new project - what's the name in there?</p>
<img src="/assets/images/posts/2019/github-tips/list.gif" class="img-thumbnail">
<p>👍</p>
<p><br></p>
<p>Great, now we know the name! But what if you want to add <strong>one extra option</strong> just for a single run?</p>
<img src="/assets/images/posts/2019/github-tips/cached.gif" class="img-thumbnail">
<p>👍</p>
<p><br></p>
<ul>
<li><strong>What number is your favorite?</strong></li>
<li><strong>Which tip did I forget?</strong></li>
</ul>
<p>Tell me in the comments, please.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/02/25/5-tips-to-effective-work-with-github-repository</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 25 Feb 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/02/25/5-tips-to-effective-work-with-github-repository#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How we Migrated from Nette to Symfony in 3 Weeks - Part 1 ]]></title>
                <link>https://tomasvotruba.com/blog/2019/02/21/how-we-migrated-from-nette-to-symfony-in-3-weeks-part-1</link>
                <description><![CDATA[ <p>On the break of January/February 2019, we <strong>migrated whole <a href="https://entry.do">Entrydo</a> project from Nette to Symfony</strong>. It was API backend with no templates, but still, it wasn't as easy as I expected.
<br><br>
Many ☕ and 🍺 were drunk during this migration. 0 programmers were too frustrated to give up.
<br>
Yet, you'd laugh if you knew what took us the most time.</p> ]]></description>
                <content:encoded><![CDATA[ <p>And when I write we and 3 weeks, I mean myself and <a href="https://janmikes.cz">Jan Mikeš</a> and <strong>3 weeks of occasional codding</strong>, not full-time. In total, we <strong>spent around 30-40 hours</strong> each on this migration.</p>
<div class="text-center">
    <img src="/assets/images/posts/2019/nette-to-symfony/nette-to-symfony.png" class="img-thumbnail mt-5">
</div>
<p>How did that happen? One day I met with Honza to cowo-talk. No big topics, you know:</p>
<blockquote class="blockquote text-center">
"..."<br>
"Why don't you try Symfony?"<br>
"I don't have time to play with it. There's already pressure for new features, damn Tom!"<br>
"I'm pretty sure it's easier than you think. Let's give it 1 week and you'll see."
</blockquote>
<p>And that's how it started. In this short series, we'll share our short story about nights without sleep, PHP code and Neon parsing and short-term pain of having no clue what that code does. Maybe even... happy ending?</p>
<h2 id="1-Getting-Ready">1. Getting Ready 🤔</h2>
<p>A year ago we tried to migrate from unmaintained Kdyby and Zenify packages to Contributte and other implementations. And we ended licking our burns.</p>
<p>That's why planning the migration is much more important than the migration itself. You have to talk about resources - <strong>how much energy and time are we both willing to invest</strong>. The problem with migration (or coding in general) is that there is a chance that 80 % will be done in 2 days, but then there is this 1 bug that makes most of the database tests fail. You try and try and fail and fail... and after a week you have depression and after 2 weeks you give up and never go back.</p>
<h2 id="2-Making-a-Commitment">2. Making a Commitment 💍</h2>
<p>Also, we had to <strong>decide to give this a priority</strong>. I was planning to put up new Pehapkari.cz website with training admin and new design and Honza had to deliver the feature. We had a time span of 3 weeks, month top, to do this. Everything else is secondary.</p>
<p>When one sleeps, the other codes. We called each other at 3 AM in the morning to talk about frustration, we shared the joy when one solved the issue. Sometimes we slept for 2 hours, then coded some more because we felt we are very close and this must be the day we finish it. In 20 cases it wasn't, <strong>but we persisted</strong>. We persisted because we decided to.</p>
<p>If one would decide in the middle of a migration to work for a week on another project, the mutual motivation could go to garbage very quickly. No way!</p>
<h2 id="3-Automated-Migration-and-gt-Manual-Changes">3. Automated Migration &gt; Manual Changes 🤖</h2>
<p>The basic idea was to do automated instant migration. Anything manually changes on more than 1 place is a potential future black hole.</p>
<p>We quickly discovered, it's better to use <a href="/blog/2019/02/14/why-config-coding-sucks/">PHP factories over config coding</a> and <a href="/blog/2019/01/24/how-to-kill-parents/">kill all parents we could</a> (except our own ones of course).</p>
<p><div class="card ml-4 mt-4 border-warning float-right post-snippet" style="width: 14em">
    <div class="card-body">
        Would you like to <strong>learn more about Rector</strong>? Step by step, from zero to hero?
        <br>

        <div class="text-center">
            <a href="/book/the-power-of-automated-refactoring/">
                <img src="/assets/images/rector_book.png" class="mb-3 mt-3 shadow">
                Get our new book
            </a>
        </div>
    </div>
</div>
</p>
<h3 id="Use-Rector-for-PHP-Changes">Use Rector for PHP Changes</h3>
<p>In the start, we run <strong>Rector with generic rules with brute-force way</strong>. Don't think, just try it. That gave us more idea about the code - we started to spot places we can write in Rector rule.</p>
<p>In the end, <a href="https://getrector.org">Rector</a> helped us with many following changes:</p>
<ul>
<li>Response and Request ✅</li>
<li>Presenter to Controller ✅</li>
<li>RouterFactory to Controller Annotation ✅ - REST Routes and Invocable Controllers included</li>
<li>Kdyby/Events and Contributte/Events to Symfony/EventDispatcher ✅</li>
<li>Kdyby/Doctrine to Doctrine/DoctrineBundle ✅</li>
<li>Kdyby/Events to Symfony/EventDispatcher ✅</li>
<li>Kdyby/Translation to Symfony/Translation ✅</li>
<li>Nette DI methods to Symfony/DependendyInjection ✅</li>
</ul>
<p>The tricky part was to discover differences and create the bridge between both frameworks - <em>&quot;In Nette, you use this, in Symfony you'd use this.&quot;</em></p>
<p><strong>Now it's done</strong>, so you can use them <a href="https://github.com/rectorphp/rector/blob/267989bb05372db937a5e9ece7f2d68cfdec34bf/config/set/nette-to-symfony.php">in <code>NETTE_TO_SYMFONY</code> set</a> Rector set to migrate your code.</p>
<p><br></p>
<p>We didn't have to change any of these parts, because the code didn't use them:</p>
<ul>
<li>
<p>Components to Controllers ❌</p>
</li>
<li>
<p>CompilerExtensions to Bundles/CompilerPasses ❌</p>
</li>
</ul>
<p>Rector can automate them when some project will need them. Maybe your project :)</p>
<h3 id="Non-PHP-Migrations">Non-PHP Migrations</h3>
<ul>
<li>
<p><a href="/blog/2019/02/11/introducing-neon-to-yaml-converter/">Neon to YAML</a> ✅ - this package was created for needs of Entrydo</p>
</li>
<li>
<p><a href="/blog/2018/07/05/how-to-convert-latte-templates-to-twig-in-27-regular-expressions/">Latte to TWIG</a> ✅</p>
</li>
</ul>
<h3 id="Coding-Standards">Coding Standards</h3>
<p>After many many changes in the code, we didn't care about spaces, tabs or where the <code>{</code> is. That's the job of <a href="https://github.com/symplify/easy-coding-standard">EasyCodingStandard</a>. <strong>We had to focus full attention on code structure</strong>, not to play with style.</p>
<p>Actually, Nette uses tabs and Symfony spaces, so ECS actually helped with migration a lot too.</p>
<h2 id="4-WTFs-Everywhere">4. WTFs Everywhere! 🤦</h2>
<p>This code worked in Nette:</p>
<pre><code class="language-php">&lt;?php

$this-&gt;translation-&gt;translate('Hi, my name is %name%', [
    'name' =&gt; 'Tom'
]);</code></pre>
<p>In Nette:</p>
<pre><code class="language-bash">Hy, my name is Tom.</code></pre>
<p>After migration tests started to fail:</p>
<pre><code class="language-bash">Hy, my name is %Tom%.</code></pre>
<p>Damn! Why it's broken?</p>
<p>In this case, we had to look to the contents of the <code>translate</code> method of the previous service. Kdyby/Translation actually automatically <a href="https://github.com/Kdyby/Translation/blob/6b0721c767a7be7f15b2fb13c529bea8536230aa/src/Translator.php#L172">wraps key name to <code>%</code></a>, while Symfony doesn't:</p>
<pre><code class="language-diff"> &lt;?php

 $this-&gt;translation-&gt;translate('Hi, my name is %name%', [
-    'name' =&gt; 'Tom'
+    '%name%' =&gt; 'Tom'
 ]);</code></pre>
<p><strong>Problem solved</strong> in 20 minutes, doh! Now it's part of Rector set, so you can actually forget this paragraph. But be ready for such issues. <strong>The hardest problems are usually behind simple differences</strong> - like extra <code>%</code>.</p>
<p><br></p>
<p>Luckily, Honza is xdebug expert, so he deep dives into the code to find the spots where code failed. It took him some time, but in the end, he <strong>disclosed magic and fixed all the issues we had</strong>. You can read more about that, Doctrine events and HttpRequest as a services migration in the next post.</p>
<h2 id="There-are-no-Happy-Endings">There are no Happy Endings...</h2>
<p>...or are they?</p>
<ul>
<li>Do you wonder how the project ended-up?</li>
<li>How many changes the PR has?</li>
<li>When and <em>if</em> will be the migration merged?</li>
</ul>
<p>The project was published in staging for 2 days. The answer to the last question is <em>Happy Valentine</em>. That's the day <strong>the Symfony application was published to production</strong>.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/02/21/how-we-migrated-from-nette-to-symfony-in-3-weeks-part-1</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 21 Feb 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/02/21/how-we-migrated-from-nette-to-symfony-in-3-weeks-part-1#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How we Automated Shopsys Packages Release from 2 days to 1 Console Command ]]></title>
                <link>https://tomasvotruba.com/blog/2019/02/18/how-we-automated-shopsys-packages-release-from-2-days-to-1-console-command</link>
                <description><![CDATA[ <p>Do you <strong>release open-source</strong>? Do you have <strong>monorepo</strong>? Do you release over <strong>10 monorepo packages at once</strong>?
Do you still do it manually per package just to be sure?
<br><br>
Good news, it's not a single day-task, but this whole process can be automated. Let's me show how we did it in Shopsys.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Monorepo release management has <del>few</del> many gotchas. The one that requires most of your attention I described in <a href="/blog/2019/01/31/monorepo-composer-magic/">Monorepo Composer Magic</a> post. <strong>1 missed commit or forgotten version change</strong> in <code>composer.json</code> of your package and <strong>you've just released a broken package</strong>!</p>
<p>I mean the ugly kind of errors you'll find out only after someone tries to install the package. Of course, you can improve this by <a href="/blog/2018/11/22/how-to-test-monorepo-in-3-layers/">3-layer monorepo tests</a>, but there is still a 50 % chance for human error.</p>
<p>Let's get practical!</p>
<h2 id="The-Manual-Shopsys-Release-Process">The <em>Manual</em> Shopsys Release Process</h2>
<p><a href="https://github.com/shopsys/shopsys">Shopsys</a> is an open-source e-commerce build on Symfony. I helped them with monorepo, Symfony and open-source standards setup through 2018.</p>
<p>When we first looked at release todo-document, it had roughly 17 steps. After a bit deeper look we realized some steps have actually 5-10 more steps in it. In the end, we found over <strong>40 steps in 3 various stages</strong>.</p>
<p>Just to give you the idea...</p>
<h3 id="Before-Release-Stage">Before Release Stage</h3>
<ul>
<li>check if Travis passes for all packages</li>
<li>bump package interdependency for tagged version</li>
<li>bump Docker image version to tagged version</li>
<li><a href="/blog/2018/10/08/new-in-symplify-5-create-merge-and-split-monorepo-with-1-command/#2-validate-it">validate <code>composer.json</code> dependencies</a> of each package</li>
<li><a href="/blog/2018/06/25/let-changelog-linker-generate-changelog-for-you/">dump <code>CHANGELOG.md</code></a> since the previous release</li>
<li>check <code>UPGRADE.md</code></li>
<li>...</li>
</ul>
<h3 id="Release-Stage">Release Stage</h3>
<ul>
<li>check changelog has today's date</li>
<li>push the tag (and let CI service do the split)</li>
<li>...</li>
</ul>
<h3 id="After-Release-Stage">After Release Stage</h3>
<ul>
<li>open branch alias for <code>next-version-dev</code></li>
<li>bump package interdependency for <code>next-version-dev</code></li>
<li>bump Docker image version to <code>dev</code></li>
<li>check packages are pushed on Packagist</li>
<li>...</li>
</ul>
<p class="text-muted">
Do you want to check them all? Just see <a href="https://github.com/shopsys/shopsys/tree/master/utils/releaser/src/ReleaseWorker">this directory on Github</a>.
</p>
<p><br></p>
<p>Shopsys <a href="https://github.com/shopsys/shopsys/releases">releases new version every month</a> and they had to do all these steps manually. Until now. Automation of this process <strong>saves time and attention of 3 developers</strong> (2 for code-review), that could be used for new features.</p>
<p>No surprise here, that the final <a href="https://github.com/shopsys/shopsys/pull/623">pull-request</a> got a bit out of hand...</p>
<img src="/assets/images/posts/2019/release/pr.png" class="img-thumbnail text-center">
<p>It <strong>took 49 days</strong> and <strong>3 900 new lines</strong> to get the PR merged. Why? Well, when you introduce simple automatization of a complex process, <strong>people start to see how easy is to convert manual daunting work to a new PHP class that does the work for them</strong>. So more and more ideas came.</p>
<h2 id="From-Human-Check-list-to-Command-with-Workers">From Human Check-list to Command with Workers</h2>
<p>To automate the process, we used MonorepoBuilder, resp. it's <a href="https://github.com/symplify/monorepobuilder#6-release-flow">release-flow feature</a>.</p>
<pre><code class="language-bash">composer require symplify/monorepo-builder</code></pre>
<p>The implements a worker for each step described above. Workers are grouped by stage and ordered by priority, so the whole process is under control.</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace Utils\Release\ReleaseWorker;

use Nette\Utils\DateTime;
use Nette\Utils\FileSystem;
use Nette\Utils\Strings;
use Symplify\MonorepoBuilder\Release\Contract\ReleaseWorker;
use PharIo\Version\Version;

final class UpdateChangelogToDateReleaseWorker implements ReleaseWorkerInterface
{
    /**
     * 1 line description of what this worker does, in a commanding form! e.g.:
     * - "Add new tag"
     * - "Dump new items to CHANGELOG.md"
     * - "Run coding standards"
     */
    public function getDescription(Version $version): string
    {
        return 'Update CHANGELOG.md "Unreleased" to version and today date';
    }

    /**
     * Higher first
     */
    public function getPriority(): int
    {
        return 1000;
    }

    public function work(Version $version): void
    {
        $changelogPath = getcwd() . '/CHANGELOG.md';
        $content = FileSystem::read($changelogPath);

        // before: ## Unreleased
        // after: ## v7.0.0-beta6 - 2019-02-18
        $newContent = Strings::replace(
            $content,
            '#^\#\#Unreleased$#',
            '## ' . $version-&gt;getVersionString() . ' - ' . DateTime::from('today')-&gt;format('Y-m-d')
        );

        FileSystem::write($changelogPath, $newContent);
    }
}</code></pre>
<p>Each step is written this way.</p>
<p class="text-muted">
Do you want to include stages? We did, so the worker implemented <code>Symplify\MonorepoBuilder\Release\Contract\ReleaseWorker\StageAwareInterface</code>.
</p>
<p>In these workers, you can trigger Travis CI with API, use Packagist API to check new version are released... sky it the limit.</p>
<h2 id="Shopsys-Release-Process-Now">Shopsys Release Process <em>Now</em>?</h2>
<pre><code class="language-bash">vendor/bin/monorepo-builder release v7.0.0-beta6 --stage release-candidate

# → review...

vendor/bin/monorepo-builder release v7.0.0-beta6 --stage release

# → CI work + 2nd review...

vendor/bin/monorepo-builder release v7.0.0-beta6 --stage after-release</code></pre>
<p>Complex process made simple with PHP! ✅</p>
<p><br></p>
<p>Btw, do you know how Symplify 14-package monorepo release process looks like?</p>
<pre><code class="language-bash">vendor/bin/monorepo-builder release v5.4.1</code></pre>
<p>Just with bare <a href="https://github.com/Symplify/MonorepoBuilder">MonorepoBuilder</a> install.</p>
<p><br></p>
<p><strong>How does your package release process look like?</strong></p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/02/18/how-we-automated-shopsys-packages-release-from-2-days-to-1-console-command</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 18 Feb 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/02/18/how-we-automated-shopsys-packages-release-from-2-days-to-1-console-command#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Why Config Coding Sucks ]]></title>
                <link>https://tomasvotruba.com/blog/2019/02/14/why-config-coding-sucks</link>
                <description><![CDATA[ <p>Rector and static analysis help us to work with code better, but it also helps us spot new weak-points of our PHP code.
<br><br>
One of the biggest evils is <em>config coding</em>. <strong>How it can hurt you and how get rid of it</strong>?</p> ]]></description>
                <content:encoded><![CDATA[ <p>Many frameworks propagate config coding over PHP code. It's cool, it's easy to type, short and we have a feeling we learned something new.</p>
<p>One of the good examples is Laravel with its <a href="https://laravel.com/docs/5.7/configuration"><code>config/app.php</code></a> - really good work!</p>
<p>Since <a href="/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3/">Symfony 3.3+ service autodiscovery</a> feature, there is almost no reason to use code in config.</p>
<p>By coding in the config I mean anything more complex than:</p>
<ul>
<li>
<p>named services</p>
<pre><code class="language-yaml">services:
    someService: SomeService
    AnotherService:
        arguments:
            - '@someService'</code></pre>
</li>
<li>
<p><code>_defaults</code></p>
<pre><code class="language-yaml">services:
    _defaults:
        autowire: true
        autoconfigure: true</code></pre>
</li>
<li>
<p>and PSR-4 autodiscovery</p>
<pre><code class="language-yaml">services:
    App\:
        resource: '../src'</code></pre>
</li>
</ul>
<h2 id="The-Dark-Side">The Dark Side</h2>
<p>Less discussed side of config coding is that in exchange for sweet syntax sugar we lose:</p>
<ul>
<li>static analysis,</li>
<li>PHPStorm refactoring</li>
<li>and instant upgrades and refactoring by Rector.</li>
</ul>
<p>PHP code written in config format has the same value to these tools as a screen-shot of code... with scrollbar:</p>
<img src="/assets/images/posts/2019/config-evil/useless.png" alt="" class="img-thumbnail">
<p>Here are <strong>3 problems you invite to your code</strong> with config coding and how to get rid of them with PHP.</p>
<h2 id="1-Crappy-Code-Refactoring-Automation">1. Crappy Code Refactoring Automation</h2>
<pre><code class="language-yaml">services:
    - FirstService(@secondService::someMethod())</code></pre>
<h3 id="What-if">What if...</h3>
<ul>
<li>...we <strong>change</strong> method name <code>someMethod</code>?</li>
<li>...we <strong>change</strong> class name <code>FirstService</code>?</li>
<li>...we <strong>change</strong> service name <code>secondService</code>?</li>
</ul>
<p>With PHPStorm these changes are pretty easy:</p>
<img src="/assets/images/posts/2019/config-evil/rename.gif" alt="" class="img-thumbnail">
<p>But the config has to be changed manually - everywhere where Symfony/Nette/... plugins cannot reach.</p>
<p><em>How can we do this better?</em></p>
<h3 id="In-PHP">In PHP ✅</h3>
<pre><code class="language-php">&lt;?php

final class FirstServiceFactory
{
    /**
     * @var SecondService
     */
    private $secondService;

    public function __construct(SecondService $secondService)
    {
        $this-&gt;secondService = $secondService;
    }

    public function createFirstService(): FirstService
    {
        return new FirstService($this-&gt;secondService);
    }
}</code></pre>
<pre><code class="language-diff"> services:
-   - FirstService(@secondService::someMethod())
+   - FirstServiceFactory</code></pre>
<h2 id="2-Learn-the-Neon-YAML-Syntax-by-Heart">2. Learn the Neon/YAML Syntax by Heart</h2>
<p>When you start to use more and more &quot;cool&quot; syntax of your favorite markup language, you'll have to remember the spacing, chars and key names:</p>
<pre><code class="language-yaml">services:
    FirstService:
        setup:
        # or was is?
        calls:
            - 'setLogger', '@logger']
            # or was it?
            - ['setLogger', ['@logger']]
            # or was it?
            setLogger: '@logger'</code></pre>
<p>You can also say goodbye to <em>rename method</em> refactoring.</p>
<p>We don't want to pollute our brains with these syntax details, <strong>we want to code</strong> with light and clear mind.</p>
<p><em>How can we do this better?</em></p>
<h3 id="In-PHP">In PHP ✅</h3>
<pre><code class="language-php">&lt;?php

namespace App;

final class FirstServiceFactory
{
    /**
     * @var LoggerInterface
     */
    private $logger;

    public function __construct(LoggerInterface $logger)
    {
        $this-&gt;logger = $logger;
    }

    public function create(): FirstService
    {
        $someService = new FirstService();
        $someService-&gt;setLogger($this-&gt;logger);

        return $someService;
    }
}</code></pre>
<p>The service is autowired by return type declaration <code>public function create(): FirstService</code>.</p>
<h2 id="3-Service-Re-use-With-Bugs">3. Service Re-use With Bugs</h2>
<pre><code class="language-yaml">services:
    - EmailCodeCleaner(HTMLPurifier(HTMLPurifier_Config::create({
        Attr.EnableID: true
    })))</code></pre>
<p>Later that year somebody wants to use <code>HTMLPurifier</code>:</p>
<pre><code class="language-php">&lt;?php

final class MicrositeHtmlCodeCleaner
{
    /**
     * @var HTMLPurifier
     */
    private $htmlPurifier;

    public function __construct(HTMLPurifier $htmlPurifier)
    {
        $this-&gt;htmlPurifier = $htmlPurifier;
    }

    // ...
}</code></pre>
<p>Let's run the code:</p>
<pre><code class="language-bash">Service 'HTMLPurifier' was not found. Register it in the config.</code></pre>
<p>Ups! It looks like it's the first use of this service. It requires <code>HTMLPurifier_Config</code> class, so we have to create it too:</p>
<pre><code class="language-yaml">services:
    - HTMLPurifier(HTMLPurifier_Config::create())</code></pre>
<p>Done!</p>
<p>A few months later, you have an email campaign with a link to a microsite. Both with the same content. But a weird bug is reported - the microsite and email have different HTML outputs with the same content.</p>
<p>You already know, that's because <code>create()</code> had different arguments.</p>
<p><em>How can we remove this potential bug?</em></p>
<h3 id="In-PHP">In PHP ✅</h3>
<pre><code class="language-php">&lt;?php

namespace App;

use HTMLPurifier;

final class HTMLPurifierFactory
{
    public function create(): HTMLPurifier
    {
        return new HTMLPurifier(HTMLPurifier_Config::create());
    }
}</code></pre>
<p>We just returned the benefits of PHP code:</p>
<ul>
<li>the <strong>autowiring works</strong></li>
<li>there is only one instance of <code>HTMLPurifier</code> in your container</li>
<li>if you register more by accident, the container tells you</li>
</ul>
<p><br></p>
<p>Instead of config coding, use factories and <a href="/blog/2018/11/05/do-you-autowire-services-in-symfony-you-can-autowire-parameters-too/">autowired parameters</a>. You can also remove factory from configs with <a href="https://github.com/symplify/package-builder#do-not-repeat-simple-factories"><code>AutoReturnFactoryCompilerPass</code></a>.</p>
<pre><code class="language-diff"> services:
     App\:
        resource: ../src
-
-    SomeClass:
-         factory: ['@SomeClassFactory', 'create']</code></pre>
<p>That's it!</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/02/14/why-config-coding-sucks</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 14 Feb 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/02/14/why-config-coding-sucks#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Introducing Neon to YAML Converter ]]></title>
                <link>https://tomasvotruba.com/blog/2019/02/11/introducing-neon-to-yaml-converter</link>
                <description><![CDATA[ <p>I wrote about <a href="/blog/2018/03/12/neon-vs-yaml-and-how-to-migrate-between-them/">How to migrate between Neon to Yaml</a> almost a year ago. Recently we needed to migrate many files with parameters, imports, and mainly services.
<br><br>
<strong>Neon and YAML are basically arrays</strong>, right? So why not let a tool let do the dirty work?</p> ]]></description>
                <content:encoded><![CDATA[ <img src="/assets/images/posts/2019/neon-to-yaml/convert-neon-to-yaml.gif" class="img-thumbnail">
<h2 id="When-Do-You-need-it">When Do You need it?</h2>
<ul>
<li>You want to <strong>migrate your package</strong> dependency injection component from <code>Nette\DI</code> to <code>Symfony\HttpKernel</code></li>
<li>You want to <strong>migrate your application</strong> from Nette to Symfony</li>
<li>One of your dependency decided to migrate configuration from <code>*.neon</code> to <code>*.yaml</code> (e.g. ECS)</li>
</ul>
<h2 id="How-to-Use-it">How to Use it?</h2>
<p>To use <a href="https://github.com/symplify/neon-to-yaml-converter">symplify/neon-to-yaml-converter</a>, require it a composer dependency:</p>
<pre><code class="language-bash">composer require symplify/neon-to-yaml-converter --dev</code></pre>
<p>Run it on one file or directory - it takes all <code>*.neon</code>, <code>*.yml</code> and <code>*.yaml</code> files:</p>
<pre><code class="language-bash">vendor/bin/neon-to-yaml-converter convert file.neon</code></pre>
<h2 id="The-2-Most-Problematic-Places-Converter-Tool-Handles">The 2 Most Problematic Places Converter Tool Handles</h2>
<p>In Neon there are nested parameters = you can use <code>%payu.user%</code> to get parameter <code>user</code> in <code>payu</code> array. In YAML used in Symfony code, there are only one level parameters. That means you can use only the <code>payu</code> parameter, nothing nested.</p>
<p>That's why all parameters have to be converted to the <strong>single level of nesting</strong>, here to <code>payu_user</code>:</p>
<pre><code class="language-diff"> parameters:
-    payu:
-       user: Pepa
+    payu_user: Pepa
-       password: abz123
+    payu_password: abz123

 services:
     PayuService:
         arguments:
-            - '%payu.user%'
+            - '%payu_user%'
-            - '%payu.password%'
+            - '%payu_password%'</code></pre>
<p>Another case are <a href="/blog/2018/03/12/neon-vs-yaml-and-how-to-migrate-between-them/#4-very-complex-syntax">Neon entities</a>. Their goal is to make syntax short. Its cost is less readability.</p>
<p>Code is actually parsed to an object, that has different meaning in different places:</p>
<pre><code class="language-diff"> services:
-    - App\SomeService(@anotherService, %perex%)
+    App\SomeService:
+        arguments:
+            - @anotherService
+            - %perex%</code></pre>
<p>Those of you who don't use Neon for years, would you guess that?</p>
<p>All this converter handles for you.</p>
<p><br></p>
<p>Next time you <strong>migrate your config, package or whole application</strong> from Neon to YAML, let <a href="https://github.com/symplify/neon-to-yaml-converter">symplify/neon-to-yaml-conveter</a> do the work for you.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/02/11/introducing-neon-to-yaml-converter</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 11 Feb 2019 00:00:00 +0000</pubDate>
                                    <updated>2020-07-01UTC00:00:000</updated>
                    <atom:updated>Wed, 01 Jul 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Wed, 01 Jul 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/02/11/introducing-neon-to-yaml-converter#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ What I Learned by Using thecodingmachine/safe ]]></title>
                <link>https://tomasvotruba.com/blog/2019/02/07/what-i-learned-by-using-thecodingmachine-safe</link>
                <description><![CDATA[ <p><a href="https://thecodingmachine.io/introducing-safe-php"><em>Safe</em></a> replaces PHP native functions like <code>file_get_contents</code> with <code>Safe\file_get_contents</code>. Native functions return <code>false</code> on fail, but <em>Safe</em> throw exception instead.
<br><br>
&quot;Good idea&quot;, I though, so I tried the package myself in Symplify and Rector.</p> ]]></description>
                <content:encoded><![CDATA[ <p>I'm a big fan of <a href="/blog/2018/12/06/dont-learn-to-code/">instant personal experience</a> over over-thinking. I didn't know if this package would be useful for me, so I tried it. My code is different from yours, so your experience might be different.</p>
<blockquote class="blockquote text-center">
    If you don't know, just try it.
</blockquote>
<p><strong>This is my experience after 2 months of using Safe</strong>.</p>
<h2 id="What-I-like">What I like 😍</h2>
<ul>
<li>
<p>Less potential errors. I don't have to think about <code>false</code> verification. Mainly on Windows, the paths can fail, because of the <code>\</code> vs <code>/</code> problem, absolute paths not starting with <code>/</code> and different end of lines.</p>
</li>
<li>
<p>Less PHPStan reporting with <a href="https://github.com/thecodingmachine/phpstan-safe-rule">Safe rule</a>. Not sure if the package is useful without it since there is no CI control to tell you where you missed the <em>Safe</em> version of a function.</p>
</li>
</ul>
<h2 id="What-I-didn-t-like">What I didn't like 🙁</h2>
<h3 id="Function-Autoloading-Sucks-in-PHP">Function Autoloading Sucks in PHP</h3>
<p>Function autoloading has much worse support than PSR-4 class autoloading. 3rd party tool is not ready for it, because it's very rare out in the wild. I personally don't know about any other function-based package.</p>
<p>I got stuck with building prefixed <code>rector.phar</code> for a week. See <a href="https://github.com/humbug/box/issues/352">humbug/box#352</a> for more.</p>
<h3 id="The-API-Changes-Fast">The API Changes Fast</h3>
<p>In 0.11.1 there was added a new function, that caused ci to fail due to PHPStan rule that required to be used for all new functions. I added it to make CI pass. Then 0.11.2 it was removed - PHPStan passed, but function was removed and the code was broken.</p>
<p>BC breaks on patch versions caused Symplify packages to break down. This is allowed on the 0.x version (see <a href="https://semver.org">Semver point 4</a>), so it really resulted from my over-trust.</p>
<p>If this was the only issue, <strong>I could solve it with patch-lock</strong> in <code>composer.json</code>:</p>
<pre><code class="language-diff"> {
    "require": {
-       "thecodingmachine/safe": "^0.1.13"
+       "thecodingmachine/safe": "0.1.13"
    }
 }</code></pre>
<p>But the combination of PHPStan rule CI fail or code fails forced to upgrade. <strong>Optional use of functions</strong> would be probably better, so I'd drop the PHPStan rule next time. But who would check the need for a <em>Safe</em> alternative? Chicken vs egg problem.</p>
<h3 id="Memory-Lock-on-Every-Native-Function">Memory Lock on Every Native Function</h3>
<p>This leads me to <a href="/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock/">memory lock</a> problem.</p>
<p>When I add new native function <code>array_filter</code>, should I use the <em>Safe</em> version or not? I have to:</p>
<ul>
<li>run PHPStan to see the answer</li>
<li>fix it manually or <a href="https://github.com/thecodingmachine/safe#automated-refactoring">better with Rector</a></li>
<li>import namespace to <code>Safe\array_filter</code> with Easy Coding Standard</li>
</ul>
<p>Before? I just typed <code>array_filter</code> ✅</p>
<p><br></p>
<p>In the end, I feel it didn't solve any real problems for me, but add huge maintenance cost to my daily workflow. All this leads me to a conclusion:</p>
<blockquote class="blockquote text-center">
    A problem that doesn't exist, doesn't need a solution.
</blockquote>
<p>Hence, I <a href="https://github.com/symplify/symplify/pull/1409/files">removed the Safe package</a> from my workflow.</p>
<h2 id="What-are-Real-Issues-with-Native-Functions">What are Real Issues with Native Functions?</h2>
<h3 id="sprintf"><code>sprintf</code></h3>
<p>During the code cleanup, I found this:</p>
<pre><code class="language-php">&lt;?php

throw new ShouldNotHappenException(
    sprintf('The is problem "%s"', $message, __METHOD__)
);</code></pre>
<p>Can you spot the problem? <a href="https://3v4l.org/5bmvp">See code on 3v4l.org</a>.</p>
<p>It reports the <code>$message</code>, <strong>but the location of the error - <code>__METHOD__</code> is skipped silently</strong>.</p>
<p>I'd expect Safe function to help me exactly with this because this is a real problem. The code doesn't work as supposed to.</p>
<h3 id="realpath"><code>realpath</code></h3>
<p>Another real problem I have is <code>realpath</code> (it clear from the function name, right? :)):</p>
<pre><code class="language-php">&lt;?php

$filePath = 'missing_file';

$realFilePath = realpath($filePath);

$fileInfo = new SplFileInfo($realFilePath);

var_dump($fileInfo-&gt;getRealPath());</code></pre>
<p>Here PHP creates <code>$fileInfo</code> object, that might be a file... but is it?</p>
<p><a href="https://3v4l.org/Xflr4">See code on 3v4l.org</a>.</p>
<h3 id="preg"><code>preg_*</code></h3>
<p>David Grudl wrote about this issue <a href="https://phpfashion.com/zradne-regularni-vyrazy-v-php">many years ago</a>. How to make <code>preg_*</code> really safe? He suggests the following:</p>
<pre><code class="language-php">&lt;?php

function safeReplaceCallback($pattern, $callback, $subject)
{
    // verify callback
    if (! is_callable($callback)) {
        throw new Exception('Invalic callback.');
    }

    // test on empty string
    if (preg_match($pattern, '') === false) { // compilation error?
        $error = error_get_last();
        throw new Exception($error['message']);
    }

    // call PCRE
    $result = preg_replace_callback($pattern, $callback, $subject);

    // execution error?
    if ($result === null &amp;&amp; preg_last_error()) {
        throw new Exception('Error during regular execution.', preg_last_error());
    }

    return $result;
}</code></pre>
<p>So...</p>
<h2 id="Is-there-a-Better-Way">Is there a Better Way?</h2>
<p>Have you read <em>Hidden Gems of PHP Packages</em>?</p>
<ul>
<li><a href="/blog/2018/08/13/hidden-gems-of-php-packages-symfony-finder-and-spl-file-info/">Hidden Gems of PHP Packages: Symfony\Finder and SplFileInfo</a></li>
<li><a href="/blog/2018/07/30/hidden-gems-of-php-packages-nette-utils/">Hidden Gems of PHP Packages: Nette\Utils</a></li>
</ul>
<p>The point is simple - replace native functions with classes methods or objects that:</p>
<ul>
<li>handle all possible errors <strong>that specific function</strong></li>
<li><strong>throws tailored informative exception</strong> so you understand what exactly is wrong</li>
<li>if created, you can be 100% sure it has the value you need (e.g. <code>SplFileInfo</code> existing file)</li>
</ul>
<p>Here are few examples I use in my code:</p>
<pre><code class="language-diff">-file_get_contents($somePath);
+Nette\Utils\FileSystem::read($somePath);</code></pre>
<pre><code class="language-diff">-preg_match('#Hi (.*?)#', $content);
+Nette\Utils\Strings::match($somePath, '#Hi (.*?)#');</code></pre>
<pre><code class="language-diff">-// 50 % chance the file doesn't exist
-$fileInfo = new SplFileInfo($somePath);
+// throw exception on non-existing file
+$fileInfo = new Symplify\PackageBuilder\FileSystem\SmartFileInfo($somePath);</code></pre>
<p>They also make PHPStan happy, because they return <code>string</code>, <code>array</code>... or throw an exception ✅</p>
<p><br></p>
<p>I love <a href="https://github.com/nette/utils">Nette\Utils</a> and there are more packages like this in the PHP universe. Packages <strong>that use objects you can rely on</strong>.</p>
<p>And if not, just create your own object, that does the job you want like I did with <code>Symplify\PackageBuilder\FileSystem\SmartFileInfo</code>. If you know about <code>Sprintf</code> object, let me know :).</p>
<p><br></p>
<blockquote class="blockquote text-center">
    But remember: <strong>only solve problems that you already have</strong>.
</blockquote>
<p><br></p>
<p>Safe coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/02/07/what-i-learned-by-using-thecodingmachine-safe</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 07 Feb 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/02/07/what-i-learned-by-using-thecodingmachine-safe#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ New in Rector: Asterisk Type Match ]]></title>
                <link>https://tomasvotruba.com/blog/2019/02/04/new-in-rector-asterisk-type-match</link>
                <description><![CDATA[ <p>Rector had started just recently helping <strong>instantly refactor private commercial projects</strong>. Not just from legacy to modern PHP, but also <strong>from one PHP framework to another</strong>. I won't tell you which ones as the work is in progress, but when it's finished, you'll be the first to hear.
<br>
<br>
The positive side effect of Rector helping to migrate real commercial project <strong>are new features in its core</strong> that is free and open-source Today with little, yet powerful <em>asterisk type match</em>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>MVC (<a href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller">model-view-controller</a>) is wide-spread pattern across all PHP frameworks.
That allows migration between them pretty smooth process. What do have <em>presenter</em>, <em>action</em>, <em>route-target</em> or <em>controller</em> in common? All are various names for the same entry point to the application.</p>
<p>Each PHP frameworks has its conventions and conventions are the main topics during migration.</p>
<p>E.g. one framework has default method of controller named <code>run</code>, the other <code>__invoke</code>. How can Rector help us?</p>
<pre><code class="language-php">use Rector\Renaming\Rector\MethodCall\RenameMethodRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;ruleWithConfiguration(RenameMethodRector::class, [
        new MethodCallRename('SomeFramework\AbstractPresenter', 'run', '__invoke')
    ]);
};</code></pre>
<p>Then Rector will change the code for you:</p>
<pre><code class="language-bash">vendor/bin/rector process src</code></pre>
<p>↓</p>
<pre><code class="language-diff"> &lt;?php

 namespace App\SomeModule\Presenter;

 use SomeFramework\AbstractPresenter;

 final class SomeController extends AbstractPresenter
 {
-    public function run()
+    public function __invoke()
     {

     }
 }</code></pre>
<p>Do you have more classes? No troubles! Just put each class one by one carefully to the config...</p>
<p>Wait. What if you could use <a href="http://php.net/manual/en/function.fnmatch.php"><code>fnmatch</code></a> pattern?</p>
<pre><code class="language-php">use Rector\Renaming\Rector\MethodCall\RenameMethodRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;ruleWithConfiguration(RenameMethodRector::class, [
        new MethodCallRename('App\*Module\Presenter\*Controller', 'run', '__invoke')
    ]);
};</code></pre>
<p>Kittens will love you now!</p>
<p><em>This <a href="https://github.com/rectorphp/rector/pull/1004">feature</a> was added to Rector v0.3.40.</em></p>
<p><br></p>
<p>One more thing! You can use it on any type check:</p>
<pre><code class="language-diff"> use Rector\Renaming\Rector\ClassConstFetch\RenameClassConstFetchRector;
 use Rector\Renaming\ValueObject\RenameClassConstFetch;
 use Rector\Config\RectorConfig;

 return function (RectorConfig $rectorConfig): void {
     $rectorConfig-&gt;ruleWithConfiguration(RenameClassConstFetchRector::class, [
-        new RenameClassConstFetch('Framework\Request', 200, 'CODE_200'),
+        new RenameClassConstFetch('Framework\Request*', 200, 'CODE_200'),
-        new RenameClassConstFetch('Framework\Request', 300, 'CODE_300'),
+        new RenameClassConstFetch('Framework\Request*', 300, 'CODE_300'),
-        new RenameClassConstFetch('Framework\RequestInterface', 200, 'CODE_200'),
-        new RenameClassConstFetch('Framework\RequestInterface', 300, 'CODE_300'),
     ]);
};</code></pre>
<p><br></p>
<p>Happy instant refactorings!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/02/04/new-in-rector-asterisk-type-match</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 04 Feb 2019 00:00:00 +0000</pubDate>
                                    <updated>2021-12-01UTC00:00:000</updated>
                    <atom:updated>Wed, 01 Dec 2021 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Wed, 01 Dec 2021 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/02/04/new-in-rector-asterisk-type-match#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Monorepo Composer Magic ]]></title>
                <link>https://tomasvotruba.com/blog/2019/01/31/monorepo-composer-magic</link>
                <description><![CDATA[ <p>Symfony is by far the best source to learn about the monorepo practice. I learned most just by looking into it's <code>composer.json</code> - monorepo and package one.
<br>
<br>
Today, I'd like to share secrets behind <strong>biggest WTF</strong> that monorepo composer setup has.</p> ]]></description>
                <content:encoded><![CDATA[ <p>In each Symplify, Symfony, Shopsys or Sylius package <code>composer.json</code>, you'll find:</p>
<pre><code class="language-json">{
    "minimum-stability": "dev",
    "prefer-stable": true
}</code></pre>
<p>&quot;So I get unstable dev dependencies to my project by installing <code>symplify/*</code>?&quot;</p>
<p>No! These section are <em>root-only</em>. The most known is <code>require-dev</code> and also:</p>
<img src="/assets/images/posts/2019/dev-alias/root-only.png">
<p>When you install a package, e.g. <code>composer require symplify/easy-coding-standard --dev</code>, you won't download PHPUnit even if that package has it in <code>require-dev</code>.</p>
<p>&quot;So why is this needed? Do these monorepo packages use unstable versions?&quot;</p>
<p><strong>Of course not.</strong> When you install any package standalone, you'll get stable dependencies. It's not even possible to install dev dependency without explicitly saying that (e.g. <code>composer require symplify/statie:@dev</code>).</p>
<h2 id="What-is-Branch-Alias-for">What is Branch Alias for?</h2>
<p>Here comes the magical combo. Each package <code>composer.json</code> also includes:</p>
<pre><code class="language-json">{
    "extra": {
        "branch-alias": {
            "dev-master": "5.5-dev"
        }
    }
}</code></pre>
<p>Do you think it will install <code>composer require symplify/statie:5.5-dev</code>? <strong>No.</strong></p>
<p>The rule is: when last minor version is <code>5.4</code>, the alias will be <code>+0.1</code> version (<code>5.5</code>).
E.g. the latest released Symfony version is <code>4.2.x</code>, next one will be <code>4.3</code>, so the alias is:</p>
<pre><code class="language-json">{
    "extra": {
        "branch-alias": {
            "dev-master": "4.3-dev"
        }
    }
}</code></pre>
<p>Is that clear? Good.</p>
<p>&quot;So what the <code>branch-alias</code> and the <code>minimum-stability</code> have in common?&quot;</p>
<h2 id="After-Split-Interdependency">After-Split Interdependency</h2>
<p>The main goal of all this magic is simple. To use <strong>the most recent mutual dependencies</strong>. E.g., I added a new feature in the monorepo that changed the code of <code>symplify/statie</code> and <code>symplify/package-builder</code>.</p>
<p>When the monorepo is split, the dev <code>symplify/statie</code> uses the dev version of <code>symplify/package-builder</code>.</p>
<h2 id="Monorepo-Release-Maintenance">Monorepo Release Maintenance</h2>
<p>Let's say we'll release next Symplify version <code>v5.4.2</code>. What we have to handle before it's tagged and released?</p>
<h3 id="1-Bump-each-Interdependency-to-the-Release-Version">1. Bump each Interdependency to the Release Version</h3>
<pre><code class="language-diff"> {
     "name": "symplify/statie",
     "require": {
-        "symplify/package-builder": "^5.5"
+        "symplify/package-builder": "^5.4.2"
     }
 }</code></pre>
<h3 id="2-Tag-Current-Version">2. Tag Current Version</h3>
<pre><code class="language-bash">git tag v5.4.2</code></pre>
<h3 id="3-Push-the-Tag">3. Push the Tag</h3>
<pre><code class="language-bash">git push --tags</code></pre>
<h3 id="4-Bump-the-branch-alias-if-Needed">4. Bump the <code>branch-alias</code> if Needed</h3>
<p><code>5.4.x</code> still uses <code>5.5-dev</code> as the alias, so we don't have to change anything for <code>5.4.2</code> version.</p>
<p>In case we'll release <code>5.5</code> in the future, it would look like this:</p>
<pre><code class="language-diff"> {
     "extra": {
         "branch-alias": {
-            "dev-master": "5.5-dev"
+            "dev-master": "5.6-dev"
         }
     }
 }</code></pre>
<p>Now we can continue committing and packages will always use last committed code.</p>
<p><br></p>
<h2 id="and-quot-Monorepo-is-Hell-of-Work-and-quot">&quot;Monorepo is Hell of Work&quot;</h2>
<p>← You must be thinking right now. Well, these steps are basically <em>find and replace</em> - <strong>perfect weak spot to automate</strong>. All these 4 steps  can replace single command from <a href="https://github.com/symplify/monorepobuilder">Symplify/MonorepoBuilder</a>:</p>
<pre><code class="language-bash">vendor/bin/monorepo-builder release v5.4.2</code></pre>
<p>The lazy job is done :)</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/01/31/monorepo-composer-magic</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 31 Jan 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/01/31/monorepo-composer-magic#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 2 Files that Your Symfony Application Misses ]]></title>
                <link>https://tomasvotruba.com/blog/2019/01/28/2-files-that-your-symfony-application-misses</link>
                <description><![CDATA[ <p>Following files are supported by PHPStorm and Symfony plugin for years (since 2016) and they make working with a code so elegant. <strong>Yet, I came across them just recently.</strong>
<br><br>
They immediately became must-have of each repository with Symfony code.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Do-You-Know-the-Frustration-of-Clicking-to-Existing-twig-File">Do You Know the Frustration of Clicking to Existing <code>*.twig</code> File?</h2>
<p>Add directory with all your twig files to <code>ide-twig.json</code> in the project root:</p>
<img src="/assets/images/posts/2019/meta/ide_twig_json.gif" class="img-thumbnail">
<ul>
<li>Refresh!</li>
<li>Enjoy :)</li>
</ul>
<p><br></p>
<p>You'll appreciate this feature in a project <strong>with <a href="/blog/2018/11/19/when-you-should-use-monorepo-and-when-local-packages/#3-local-packages">multiple packages</a></strong>. It's real life-saver:</p>
<pre><code class="language-json">{
    "namespaces": [
        { "path": "templates" },
        { "path": "packages/Provision/templates" },
        { "path": "packages/Registration/templates" },
        { "path": "packages/Training/templates" },
        { "path": "packages/KnowHow/templates" },
        { "path": "packages/Marketing/templates" },
        { "path": "packages/User/templates" }
    ]
}</code></pre>
<p><em>Note: You need to install <a href="https://plugins.jetbrains.com/plugin/7219-symfony-plugin">Symfony Plugin</a> first. Then enable it in each project (yes, they're 2 different steps).</em></p>
<p>You can use <a href="https://www.slideshare.net/Haehnchen/symfonycon-berlin-2016-symfony-plugin-for-phpstorm-3-years-later-69804748#45">more magic</a> like namespaces, but they're nothing better than explicit paths.</p>
<h2 id="Why-PHPStorm-doesn-t-and-quot-get-and-quot-It">Why PHPStorm doesn't &quot;get&quot; It?</h2>
<p>PHPStorm knows types of object passed by constructor injection:</p>
<pre><code class="language-php">&lt;?php

// ...

public function __construct(Type $type)
{
    $type-&gt;someMethod(); // PHPStorm: object of "Type"
}</code></pre>
<p>But what if you need to <a href="/blog/2018/05/17/how-to-test-private-services-in-symfony/">test service</a> and get it from container?</p>
<pre><code class="language-php">&lt;?php

$service = $this-&gt;container-&gt;get(Type::class);
$service; // PHPStorm: "object" type
$service; // you need: object of "Type"</code></pre>
<p>To solve this, you need to <strong>spam your code with annotations</strong>:</p>
<pre><code class="language-diff"> $service = $this-&gt;container-&gt;get(Type::class);
+/** @var Type $service */
 $service;</code></pre>
<p>Is there a better way?</p>
<img src="/assets/images/posts/2019/meta/phpstorm_meta.gif" class="img-thumbnail">
<p>The <code>.phpstorm.meta.php</code> configuration seems a bit magic at first, but you'll understand it:</p>
<pre><code class="language-php">&lt;?php

namespace PHPSTORM_META;

// $container-&gt;get(Type::class) → instance of "Type"
override(\Psr\Container\ContainerInterface::get(0), type(0));</code></pre>
<p>And your container calls are now type-aware:</p>
<pre><code class="language-php">&lt;?php

$service = $this-&gt;container-&gt;get(Type::class);
$service; // PHPStorm: object of "Type"</code></pre>
<p>Pretty cool, right?</p>
<p><br></p>
<p>You can use this <a href="https://confluence.jetbrains.com/display/PhpStorm/PhpStorm+Advanced+Metadata">for much more</a>, like <strong>Doctrine repository autocomplete by entity class</strong>.</p>
<p>I'm using this for container and thanks to that there is <a href="https://github.com/symplify/symplify/commit/d53003ebc41dddcb228e517c98d59de70ebc17a0">49 fewer annotations</a> in Symplify code.</p>
<p><br></p>
<p>Do you <strong>use another metafile</strong> for PHPStorm? Let me know in the comments.</p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/01/28/2-files-that-your-symfony-application-misses</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 28 Jan 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/01/28/2-files-that-your-symfony-application-misses#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Kill Parents ]]></title>
                <link>https://tomasvotruba.com/blog/2019/01/24/how-to-kill-parents</link>
                <description><![CDATA[ <p>I see too many skilled developers missing <code>final</code> in every class they use. So I reposed <a href="http://ocramius.github.io/blog/when-to-declare-classes-final">When to declare classes final</a> - 4 years old post that shows you <em>why</em>. If you should learn just one skill this year, read and learn this one.
<br>
<br>
It's easier said than done, but the more parents you kill, the better you get at it. Today, we look on 3 effective ways to kill them.</p> ]]></description>
                <content:encoded><![CDATA[ <blockquote class="blockquote text-center mt-5 mb-5">
<p><strong>tl;dr</strong></p>
<p>Always declare your classes <code>final</code> and learn ways how to code with them.</p>
<p>It's not an easy path, but it will teach you SOLID better than anything else.</p>
</blockquote>
<p>S<strong>O</strong>L<strong>ID</strong> - 3 letters from <a href="https://en.wikipedia.org/wiki/SOLID">famous coding principles</a> are related to <code>final</code> classes, classes that cannot have children. The <code>final</code> topic is very popular:</p>
<img src="/assets/images/posts/2019/final/repost.png" class="img-thumbnail">
<p>But have you seen them in your favorite package?</p>
<h2 id="No-Parents-Happy-Family">No Parents = Happy Family</h2>
<p>There are few cases the when parent class is <strong>required</strong> by 3rd party package or PHP code:</p>
<pre><code class="language-php">use PHPUnit\Framework\TestCase;

final class PrivatesCallerTest extends TestCase
{
}</code></pre>
<pre><code class="language-php">&lt;?php

use Symfony\Component\Console\Command\Command;

final class PropagateCommand extends Command
{
}</code></pre>
<pre><code class="language-php">&lt;?php

use Exception;

final class OutputFormatterNotFoundException extends Exception
{
}</code></pre>
<p>These cases are valid - after all, if they shouldn't be extended, they would have been marked them <code>final</code>, right?</p>
<p>But in other cases, it is <strong>optional</strong>. One of the most spread terribly wrong use of parent class is Doctrine repository.</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace App\Repository;

use Doctrine\ORM\EntityRepository;

final class PostRepository extends EntityRepository
{
}</code></pre>
<p>Symfony upgrades this problem to <a href="https://github.com/doctrine/DoctrineBundle/blob/a6ab041f33a0af379314ad5dbe17006903fd9fb6/Repository/ServiceEntityRepository.php">one more layer</a> of vendor lock:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace App\Repository;

use Doctrine\Bundle\DoctrineBundle\Repository\ServiceEntityRepository;

final class PostRepository extends ServiceEntityRepository
{
}</code></pre>
<p><strong>Switching 3rd party dependency from one class to another doesn't solve your issue</strong>. You might switch heroin for meth, but you're still an addict.</p>
<p>Doctrine and Symfony documentation is full of this nonsense and it gives developers an idea that inheritance is a good thing.
That's why migration of database layer is so difficult. Read about <a href="/blog/2017/10/16/how-to-use-repository-with-doctrine-as-service-in-symfony/">How to use Repository with Doctrine as Service in Symfony</a> if you still have <code>extends</code> in your repository.</p>
<h2 id="Why-is-this-Such-A-Big-Deal">Why is this Such A Big Deal?</h2>
<p>In the end, the code without limits look like:</p>
<pre><code class="language-diff">namespace App\Repository;

namespace Doctrine\Bundle\DoctrineBundle\Repository\ServiceEntityRepository;

-final class PostRepository extends ServiceEntityRepository
+class PostRepository extends ServiceEntityRepository
 {
 }</code></pre>
<p>Do you need a homepage post? Just extend, it's the <em>Symfony</em> way:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace App\Repository;

use Doctrine\Bundle\DoctrineBundle\Repository\ServiceEntityRepository;

class HomepagePostRepository extends PostRepository
{
}</code></pre>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace App\Repository;

use Doctrine\Bundle\DoctrineBundle\Repository\ServiceEntityRepository;

class CachedHomepagePostRepository extends HomepagePostRepository
{
}</code></pre>
<p>This code is not made up, but the common sense of applying <em>inheritance over composition</em> approach on everything that can be extended. And <strong>everything that is not <code>final</code>, can be extended.</strong></p>
<p><br></p>
<h2 id="Vendor-Lock-Payback">Vendor-Lock Payback</h2>
<p>Overusing <code>extends</code> is similar to overuse of static methods in Laravel. Everyone with <a href="/blog/2018/04/26/how-i-got-into-static-trap-and-made-fool-of-myself/">bad expensive experience</a> knows why it's bad, but they're not able to pass this experience who are in &quot;the zone&quot; of using.</p>
<p>Then comes the day when 3rd party code changes:</p>
<pre><code class="language-diff"> &lt;?php declare(strict_types=1);

 namespace Doctrine\ORM;

 class EntityRepository
 {
-    public function createQueryBuilder($alias, $indexBy = null)
+    public function createQueryBuilder(string $alias, ?string $indexBy = null)
     {
     }

-     public function findAll()
+     public function findAll(): array
      }
 }</code></pre>
<p>Have you overridden this method? Your code is broken. If this example doesn't cover your method, maybe you've changed one of 15 methods in <code>EntityRepository</code> you can override now. And what is not <code>final</code> can...</p>
<p>And if you inherit <code>Doctrine\Bundle\DoctrineBundle\Repository\ServiceEntityRepository</code>, you'll have to wait for them to fix the code first. It's like waiting on Android upgrades with Samsung.</p>
<h2 id="Your-Parents-are-Good-Parents">Your Parents are Good Parents</h2>
<p><strong>You can avoid this completely</strong> by playing with your own parents. Do you need a common method for all your repositories? You can:</p>
<pre><code class="language-php">&lt;?php

abstract class AbstractDoctrineRepository
{
    // @inject EntityManager here

    // your common methods
}</code></pre>
<pre><code class="language-php">&lt;?php

final class ProductRepository extends AbstractDoctrineRepository
{
}</code></pre>
<p>This way</p>
<ul>
<li><strong>you own the code</strong></li>
<li>you <strong>have no troubles</strong> when <code>EntityRepository</code> changes the way above</li>
<li>migration of a database is a matter of weekend work</li>
</ul>
<h2 id="Make-Children-in-Factory-Instead">Make Children in Factory Instead</h2>
<p>This week we started a migration of Nette application to Symfony with Rector. One of the changes is <code>Nette\...\Response</code> to <code>Symfony\...\Response</code> change. It's easy:</p>
<pre><code class="language-diff"> class SomePresenter
 {
-    public function someAction(): \Nette\...\Response
+    public function someAction(): \Symfony\...\Response
     {
     }
 }</code></pre>
<p>There are over 50 classes like this, but still do-able even without Rector.</p>
<p>But how would you approach cases like this?</p>
<pre><code class="language-php">&lt;?php

class SomeResponse extends \Nette\...\Response
{
}</code></pre>
<pre><code class="language-php">&lt;?php

class SomePresenter
{
    public function someAction()
    {
        return new SomeResponse($values, $code);
    }
}</code></pre>
<p>Again, there <strong>are over 50 classes in this format</strong>.</p>
<p>Oh, and the arguments are in different order and there is one extra:</p>
<pre><code class="language-diff"> &lt;?php

 class SomePresenter
 {
     public function someAction()
     {
-        return new SomeResponse($values, $code);
+        return new Symfony\...\Response($values, $headers, $code);
     }
 }</code></pre>
<p>Now we have to go through all these cases and change them. To add more salt to the wound, once there is <code>OkResponse</code> or <code>DeniedResponse</code>, all children of <code>Nette\...\Response</code>. This got us by shock. <strong>Our big plan to refactor application in one afternoon went to dust.</strong></p>
<p>And it doesn't have to be such a big change as a framework, but argument swap or just new type declaration - <strong>there will be so many BC breaks just for <a href="/blog/2019/01/03/how-to-complete-type-declarations-without-docblocks-with-rector/">type declarations</a> in next 2 years</strong>.</p>
<p>&quot;What if instead, we'd have a factory.&quot;</p>
<pre><code class="language-diff"> &lt;?php

 class SomePresenter
 {
     public function someAction()
     {
-        return new SomeResponse($values, $code);
+        return $this-&gt;responseFactory-&gt;createSuccess($values);
     }
 }</code></pre>
<pre><code class="language-php">&lt;?php

class ResponseFactory
{
     public function createSuccess($values)
     {
         return new Nette\...\Response($values, 'OK');
     }
}</code></pre>
<p>The change here for <strong>every such call would be in 1 place</strong> instead of 50:</p>
<pre><code class="language-diff">-return new Nette\...\Response($values, 'OK');
+return new Symfony\..\Response($values, $headers, 'OK');</code></pre>
<p>Luckily, Honza <a href="https://github.com/rectorphp/rector/pull/982">added support for <code>new Instance($args)</code> → <code>$this-&gt;instanceFactory-&gt;create($args)</code></a> to Rector, so it won't be a stopper for us. But if the original parent would be <code>final</code>, this would never happen.</p>
<h2 id="Static-Anal-to-the-Rescue">Static Anal to the Rescue</h2>
<p>We don't have to wait for changes in all packages. There is a static analysis to help us. I just learned about <a href="https://github.com/localheinz/phpstan-rules">localheinz/phpstan-rules</a>. I can't wait to try these nice rules:</p>
<img src="/assets/images/posts/2019/final/rules.png" class="img-thumbnail">
<p><br></p>
<p>Next time you'll try to do coding, try using <code>final</code>. Do you know what will happen?</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/01/24/how-to-kill-parents</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 24 Jan 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/01/24/how-to-kill-parents#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ FriendsofPHP.org is Opening API with 250 Meetups a Month ]]></title>
                <link>https://tomasvotruba.com/blog/2019/01/21/friends-of-php-is-opening-api-with-250-meetups-a-month</link>
                <description><![CDATA[ <p><a href="https://friendsofphp.org">Friendsofphp.org</a> already checks <strong>over 1 145 PHP groups</strong> on meetup.com for new meetups every day. That's about 240 meetups in a single month - a great number, but some user groups don't use meetup.com.
<br><br>
I spend last weekend adding 4 new sources for meetups... and while doing it, I thought: &quot;why not make all that meetups and groups public in JSON&quot;?</p> ]]></description>
                <content:encoded><![CDATA[ <p>If you want to organize meetups on Meetup.com, it will cost you 10 $/month. Not every organizer can afford that, mainly in starting or small communities.</p>
<p>That's why there are other free platforms that collect meetups - each with their own way to export these meetups:</p>
<ul>
<li><a href="https://crossweb.pl/feed/wydarzenia/php">crossweb.pl</a> with xml feed in Poland</li>
<li><a href="https://dou.ua/calendar/feed/PHP">dou.ua</a> with xml feed in Ukraine</li>
<li><a href="webcal://www.posobota.cz/feed.ical.php">posobota.cz</a> with ical in the Czech Republic</li>
<li><a href="https://opentechcalendar.co.uk/api1/events.json">opentechcalendar.co.uk</a> <strong>with json</strong> in UK</li>
</ul>
<p>XML feeds are &quot;fun&quot; to work with. In dou.ua, the feed is so bad, that it contains only meetup name and its detail URL - no place or time. So you have to <strong>crawl each detail URL standalone</strong> and parse hidden JSON in HTML. But that's not all. Sometimes the json is but sometimes it isn't, so you have to actually parse the file and use XPath:</p>
<pre><code class="language-php">&lt;?php

$jsonData = $crawler-&gt;filterXPath('//script[@type="application/ld+json"]/text()');
if ($jsonData-&gt;getNode(0) === null) { // has some result?
    return null;
}

try {
    return Json::decode($jsonData-&gt;text(), Json::FORCE_ARRAY);
} catch (JsonException $jsonException) {
    // parse the whole site and get crawl HTML content
    return null;
}</code></pre>
<p>opentechcalendar.co.uk from UK is much better at this, providing json:</p>
<pre><code class="language-json">"data":[{"slug":7847,"slugforurl":"7847-machine-learning-adoption-enhancing-and-automating","summary":"Machine Learning Adoption: Enhancing and Automating Decision Making","summaryDisplay":"Machine Learning Adoption: Enhancing and Automating Decision Making","description":"","deleted":false,"cancelled":false,"is_physical":true,"is_virtual":false,"custom_fields":{"code_of_conduct":null},"siteurl":"https:\/\/opentechcalendar.co.uk\/event\/7847-machine-learning-adoption-enhancing-and-automating","url":"https:\/\/www.eventbrite.co.uk\/e\/machine-learning-adoption-enhancing-and-automating-decision-making...</code></pre>
<p>But, how well can we read that? With a bit of lagging... we can understand it.</p>
<h2 id="The-Simplest-API-Possible">The Simplest API Possible</h2>
<p><strong>I'm lazy to read anything I don't need for my work</strong>. I won't look and instantly know the keys I can use. Are there coordinates or do I have to geolocate them from the city?</p>
<pre><code class="language-json">{
    "meetups": [
        {
            "name": "Poslední Sobota 101",
            "userGroup": "Posobota",
            "start": "2019-01-26 15:00",
            "city": "Praha",
            "country": "Czech Republic",
            "latitude": 50.0874654,
            "longitude": 14.4212535,
            "url": "http://www.posobota.cz"
        }
    ]
}</code></pre>
<p>I want simple URL, with all the data I need. Just load and parse in 2 lines.</p>
<ul>
<li>No guzzle</li>
<li>No auth nor tokens</li>
<li>No back and forth HTML crawling</li>
<li>No XML entities to string conversion</li>
</ul>
<p>Simple like this:</p>
<pre><code class="language-php">&lt;?php

use Nette\Utils\FileSystem;
use Nette\Utils\Json;

$jsonContent = FileSystem::read('https://friendsofphp.org/api/meetups.json');
$json = Json::decode($jsonContent, Json::FORCE_ARRAY);

var_dump($json['meetups']); // all meetups on friendsofphp.org</code></pre>
<h2 id="Complains-Everywhere-What-about-Me">Complains Everywhere... What about Me?</h2>
<p>All right, all this API is clearly bad and the authors probably never used them themselves. But what about friendsofphp.org API? Is it good?</p>
<p>Well, there is none. Better bad API than no API → crawling and Xpaths. Better done than perfect. So to make this right...</p>
<p><strong>...I published all meetups and groups for anyone to use in API</strong>.</p>
<img src="/assets/images/posts/2019/fop/fop.png" class="img-thumbnail mb-5">
<p>With API you can list meetups in your country, sort them by a distance from your city, get all groups from your neighbor countries, render a map with Wordpress meetups... or whatever comes to your mind. It's all up to your creativity.</p>
<h2 id="API-with-Statie">API with Statie?</h2>
<p>With <em>encoded knowledge</em> approach, you don't have to think about pretty JSON, or studying XML vs JSON format. Just provide data and let program handle it.</p>
<p>This website runs on <a href="https://www.statie.org">Statie</a> - the most downloaded PHP static website generators supporting Twig and Markdown. Why don't we Statie handle this as well?</p>
<p>Since Statie 5.4-dev, you can do this:</p>
<pre><code class="language-yaml"># statie.yaml
parameters:
    api_parameters:
        - 'groups'
        - 'meetups'</code></pre>
<p>That way, their parameters will be turned into API feeds:</p>
<pre><code class="language-bash">/api/groups.json
/api/meetups.json</code></pre>
<p>With this beautiful json:</p>
<pre><code class="language-json">{
    "meetups": [
        {
            "name": "Poslední Sobota 101",
            "userGroup": "Posobota",
            "start": "2019-01-26 15:00",
            "city": "Praha",
            "country": "Czech Republic",
            "latitude": 50.0874654,
            "longitude": 14.4212535,
            "url": "http://www.posobota.cz"
        }
    ]
}</code></pre>
<p>That way you can publish a list of talks, books you've read or package you've made. <strong>You don't have to think</strong> about the design, URL, nor creating own templates and handling the empty output.</p>
<p><strong>Statie got you covered!</strong></p>
<img src="/assets/images/posts/2019/fop/gotit.jpg" class="img-thumbnail">
<p><br></p>
<p>How do you use API feeds? What is your approach to provide them?</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/01/21/friends-of-php-is-opening-api-with-250-meetups-a-month</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 21 Jan 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/01/21/friends-of-php-is-opening-api-with-250-meetups-a-month#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How Writing Posts Helps you to Become Better Programmer ]]></title>
                <link>https://tomasvotruba.com/blog/2019/01/17/how-writing-posts-helps-you-to-become-better-programmer</link>
                <description><![CDATA[ <p>I love to write about my packages. Why? The code you type <strong>you know</strong>, <strong>you know</strong> the name of variables, <strong>you know</strong> how to interface looks, you know the architecture. It's like raising your own child and <strong>knowing</strong> his favorite ice-cream...</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="What-does-Your-Child-Eat">What does Your Child Eat?</h2>
<p>The fun comes, when your neighbor needs to run to the hospital to visit his dying father and he drops you his daughter at your door. You're a good man, so you say you look after her. It getting late so you want to make some dinner.</p>
<p>But what does she like? Can she eat spicy food or sweets? <strong>Is she allergic to something?</strong> Many questions you wished you asked your neighbor now, but that didn't come to your mind before, because you know by heart these things about your child.</p>
<p>Luckily for us, a code is a bit different - when it eats something different than it supposed to do, the worst thing that can happen is an exception or invalid input type. We don't think about other peoples' code much - compared to ours. It's either not tested, crap, legacy or full of static (pick your own favorite label for the code you read and that is not yours).</p>
<h2 id="Why-you-Should-Yourself-to-One-s-Shoes">Why you Should Yourself to One's Shoes?</h2>
<p>If you learn how to think like somebody you're not, you get into <a href="http://www.agillo.net/zen-and-the-art-of-programming-beginners-mind">begginers mind</a>.
It might save a life of a child and also - in your case - you'll be able to write code not only you but <strong>also other people understand</strong>.</p>
<p>You'll get many benefits over your peers, just to name a few:</p>
<ul>
<li>You'll be more favorable in your team than others</li>
<li>You'll be more successful in selling your ideas to implement to your code</li>
<li>The other will contribute to your code more than to the one the only author understands</li>
</ul>
<p><strong>How do put there?</strong></p>
<h2 id="1-Use-Your-Own-Package">1. Use Your Own Package</h2>
<p><code>composer require your-package/name</code>, a plugin with bundle or extension and run. You probably have done this dozen of times. Do you think this will give you nothing new? On contrary - you might be surprised, how hard to configure your package is.</p>
<h2 id="2-Let-Your-Friend-use-You-Package-LIVE">2. Let Your Friend use You Package - LIVE!</h2>
<p>Ask a good friend who you're patient with to use your package <strong>personally right in front of you</strong>. Make task simple, e.g.</p>
<ul>
<li>download Easy Coding Standard and</li>
<li>check your code with it</li>
</ul>
<p>They will probably follow steps in <code>README</code>... oh, I've learned almost nobody reads them in these tests. They just find <code>composer require your-package/name</code> and wait for the first exception before going to any README at all. Not really intentionally :)</p>
<p>In your eyes it might look like this:</p>
<img src="/assets/images/posts/2019/write-to-code/autstin.gif" class="img-thumbnail mb-5">
<p>I'm always tempted to give them clues - &quot;click there, it's not <em>exclude</em>, it's <em>excluded</em>&quot;, but that <strong>would ruin your feedback</strong>. Stop any verbal and non-verbal output = <strong>shut up <a href="https://www.youtube.com/watch?v=yA1b2iJlBP0&amp;feature=youtu.be&amp;t=39">and listen</a></strong>.</p>
<p><em>Friend testing</em> is really the best way to get feedback. You can read more about this process in short book <a href="https://www.amazon.com/Rocket-Surgery-Made-Easy-Yourself/dp/0321657292">Rocket Surgery Made Easy</a> by my favorite common sense author <em>Steve Krug</em>.</p>
<p>On the other hand, it is consuming and you have to have many friends that are both willing to use your package and are feeling comfortable in failing to even run it.</p>
<p>Isn't there something you can do just by yourself that would keep their shoes on you? Something where all you need is yourself and free time and the only judge in your head? No, I don't mean masturbation.</p>
<h2 id="3-Write-Post-About-It">3. Write Post About It</h2>
<p>I love writing about packages, about <a href="/blog/2018/09/20/new-in-symplify-5-3-new-cool-features-of-package-builder/">those I create</a> and <a href="/blog/2018/07/30/hidden-gems-of-php-packages-nette-utils/">those I use</a>. It starts very simply, why it exists, what problems it solves and how you can use it in your home today. Why I love this writing?</p>
<p><strong>It helps me shift my thinking from fast to slow one</strong>. It's very rare in programming because thanks to IDE we barely type in words:</p>
<div class="text-center">
    <img src="/assets/images/posts/2019/write-to-code/typeless.gif" class="img-thumbnail">

    <p>This code took 10 seconds and exactly 34 keystrokes to type. It's <strong>233 chars long</strong>.</p>
</div>
<p><br></p>
<p>When we're in the flow and have clear idea what we code, most of our programming works looks like this.</p>
<p>Btw, if missed Social Psychology 101 on the university, <a href="https://www.amazon.com/Thinking-Fast-Slow-Daniel-Kahneman/dp/0374533555">Thinking, Fast and Slow</a> covers 90 % of it. Be careful, after reading it you'll see how lazy human brains is by design - in politics, in coding even or your family.</p>
<blockquote class="blockquote text-center">
    "Indeed, the ratio of time spent reading versus writing is well over 10 to 1. We are constantly reading old code as part of the effort to write new code. ...[Therefore,] making it easy to read makes it easier to write."

    <footer class="blockquote-footer">Robert C. Martin, <cite>author of Clean Code</cite></footer>
</blockquote>
<p>...and we don't talk about open source here, where the ratio might be way over 1000 views per year even in small packages.</p>
<p><br></p>
<ul>
<li>How long does it take to write about 233 chars-long code?</li>
<li>How long will the text be?</li>
<li><strong>What can you learn from this process?</strong></li>
</ul>
<p>It will take around 2-5 minutes to write such text and it will be over 500 chars long.</p>
<p>That's <em>slow thinking</em> - with patience to detail, understanding in context and most importantly - <strong>critical thinking</strong>:</p>
<ul>
<li>Is that method really needed?</li>
<li>Could I remove this?</li>
<li>Why is this named like this?</li>
<li>Should this be reused as a service?</li>
</ul>
<p>Writing such text - in private, for your colleagues or on your public blog - <strong>will give you many hints what you can do better with the code</strong>.</p>
<h2 id="How-Post-about-Statie-improves-Statie">How Post about Statie improves Statie</h2>
<p>One example for all - after writing of my last 2 posts - <a href="/blog/2019/01/14/11-steps-to-migrate-from-sculpin-to-statie/">11 Steps to Migrate From Sculpin to Statie</a>
and <a href="/blog/2019/01/10/9-steps-to-migrate-from-jekyll-to-statie/">9 Steps to Migrate From Jekyll to Statie</a> I realized, it's really difficult to switch from one static website to another. You need to follow many steps, in the correct order:</p>
<ul>
<li>move files</li>
<li>remove files</li>
<li>replace syntax in files A → B</li>
<li>load files in another file</li>
<li>make this path longer</li>
</ul>
<p>This got me to <em>slow thinking</em>:</p>
<ul>
<li>&quot;Do I really want to let people do this manually?&quot;</li>
<li>&quot;There are many PHP developers who use Sculpin or Jekyll, who might want to migrate to Statie.&quot;</li>
<li>&quot;Do they really have to go through this list? How many of them will pass all the steps?&quot;</li>
</ul>
<p><strong>I didn't think about this until I started writing the text</strong>. I assumed the post will give reader X points to follow. He or she will follow it, finish it and everybody is happy.</p>
<p>So I continued:</p>
<ul>
<li>&quot;What if there would a command that will do all this?&quot;</li>
<li>&quot;A command in Statie, that you can run in your project?&quot;</li>
<li>&quot;Something like <code>vendor/bin/statie migrate-jekyll</code>&quot;</li>
</ul>
<p>The hypothesis was made. Now only I only had to <strong>make a prototype</strong>. I did it <a href="https://github.com/symplify/symplify/pull/1339">over the weekend</a> and used it to <a href="https://github.com/tomasfejfar/blog/pull/2">migrate blog</a> of my friend and great mentor not only for PHPStorm - <a href="https://www.tomasfejfar.cz">Tomáš Fejfar</a>. It works and it was fun to explore static migration rules and limits. I learned a lot.</p>
<h2 id="Write-about-Your-Code">Write about Your Code</h2>
<p>But this post is not about Statie. It's about <strong>how text about your code can give you ideas you never knew were there</strong>. Ideas that are awesome and push you further to create better and shorter code, that more people understand.</p>
<p>Give your code a text try and you'll see how deep the rabbit hole goes.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/01/17/how-writing-posts-helps-you-to-become-better-programmer</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 17 Jan 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/01/17/how-writing-posts-helps-you-to-become-better-programmer#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 11 Steps to Migrate From Sculpin to Statie ]]></title>
                <link>https://tomasvotruba.com/blog/2019/01/14/11-steps-to-migrate-from-sculpin-to-statie</link>
                <description><![CDATA[ <p>In previous post we migrated <a href="/blog/2019/01/10/9-steps-to-migrate-from-jekyll-to-statie/">Jekyll to Statie</a>.
If you need to add a feature to the static website, like creating preview images for Instagram, <strong>you need PHP</strong>.
<br><br>
Sculpin is the older brother of Statie but is mostly retired last 3 years. Do you want to get on track with modern PHP on your static website? Here is how.</p> ]]></description>
                <content:encoded><![CDATA[ <h3 id="Statie-beats-Sculpin-in-Simplicity">Statie beats Sculpin in Simplicity</h3>
<p>Do you know that feeling when you look for <em>that post</em> someone wrote on their blog, you're on page 10 with 5 posts per page and you click <em>Next page</em> one more time hopefully being the last page you have to scan?</p>
<p>Sculpin uses paginator and tagging. Since static websites are not huge e-commerce sites, they're small in transferred data amount. <strong>It's all HTML, no database, no PHP, so even if you display 200 posts in one page it's blazing fast</strong>.</p>
<p>Statie doesn't create these problems - there is no paginator and tags/categories complexity that only bothers you and your readers. One page with all items → CTRL + F &quot;dorctr&quot; → that the one.</p>
<h2 id="1-Create-Basic-Statie-Structure">1. Create Basic Statie Structure</h2>
<p>Statie 5.3 brings <a href="/blog/2019/01/07/how-to-create-your-first-php-twig-static-website-under-2-minutes-with-statie/">new <code>init</code> command</a>, that creates basic structure in <code>/source</code> directory, <code>statie.yml</code>, <code>.travis.yml</code> and metafiles.</p>
<p>Before we start any moving, create a basic structure to save many copy-pasting steps:</p>
<pre><code class="language-bash">composer require symplify/statie
vendor/bin/statie init</code></pre>
<p>Then, clean <code>/source</code> directory from generated files and...</p>
<h2 id="2-Move-Parameters-Files-Into-statie-yaml">2. Move Parameters Files Into <code>statie.yaml</code></h2>
<p>From <code>app/config/sculpin_site.yml</code> to <code>statie.yaml</code>:</p>
<pre><code class="language-diff">-google_analytics_tracking_id: UA-33922165-1
+parameters:
+    google_analytics_tracking_id: UA-33922165-1</code></pre>
<h2 id="3-Keep-Post-Route">3. Keep Post Route</h2>
<p>From <code>app/config/sculpin_kernel.yml</code> to <code>statie.yaml</code>:</p>
<p><strong>Before</strong> - Sculpin</p>
<pre><code class="language-yaml">sculpin_content_types:
    posts:
        permalink: blog/:filename/</code></pre>
<p><strong>After</strong> - Statie</p>
<pre><code class="language-yaml">parameters:
    generators:
        posts:
            route_prefix: blog/ #filename is completed by default</code></pre>
<p>Look at <a href="https://www.statie.org/docs/generators">generators docs</a> to see other options to configure them.</p>
<h2 id="4-Make-File-Names-Explicit-about-twig">4. Make File Names Explicit about <code>*.twig</code></h2>
<p>And also move <code>_views</code> to <code>_layouts</code>. That's where Statie looks for global layouts.</p>
<pre><code class="language-diff">-_views/default.html
+_layouts/default.twig</code></pre>
<h2 id="5-Drop-Old-Files">5. Drop Old Files</h2>
<pre><code class="language-diff">-app/*
-build.sh # see step 6 for deploy replacement</code></pre>
<h2 id="6-Setup-Github-Pages-deploy-in-Travis">6. Setup Github Pages deploy in Travis</h2>
<p>Thanks to <code>vendor/bin/statie init</code> you have correctly configured <code>.travis.yml</code> in your repository.</p>
<p>To finish deploy, you need to:</p>
<ul>
<li>create <code>gh-pages</code> branch</li>
<li>pick it as a source for Github Pages</li>
<li>generate Github Token</li>
<li>put it to Travis configuration of your repository</li>
</ul>
<p>How you do this? Just <strong>follow <a href="https://www.statie.org/docs/github-pages">Statie.org documentation</a></strong> step by step.</p>
<h2 id="7-Complete-IDs-to-Your-Posts">7. Complete IDs to Your Posts</h2>
<p>Post:</p>
<pre><code class="language-diff"> ---
+id: 1
 layout: post
 title: My new blog
 ---</code></pre>
<p>Ids are used to internally interlink items, e.g to display <a href="https://www.statie.org/docs/related-items">related posts under the post</a>:</p>
<pre><code class="language-yaml">---
id: 1
title: My first post
related_items: [2]
---</code></pre>
<pre><code class="language-twig">{% set relatedPosts = post|relatedItems %}

{% if relatedPosts|length %}
    &lt;div&gt;
        &lt;strong&gt;Continue Reading&lt;/strong&gt;
        &lt;ul&gt;
            {% for relatedPost in relatedPosts %}
                &lt;li&gt;
                    &lt;a href="/{{ relatedPost.relativeUrl }}"&gt;{{ relatedPost.title }}&lt;/a&gt;
                &lt;/li&gt;
            {% endfor %}
        &lt;/ul&gt;
    &lt;/div&gt;
{% endif %}</code></pre>
<h2 id="8-Forget-repeating-Layout-and-Generator-from-Posts">8. Forget repeating Layout and Generator from Posts</h2>
<p>Since the layout is <a href="https://www.statie.org/docs/generators">defined in the config for all posts</a> by default...</p>
<pre><code class="language-yaml">parameters:
    generators:
        posts:
            layout: "_layouts/post.twig"</code></pre>
<p>...no need to repeat it in every file:</p>
<pre><code class="language-diff"> ---
 id: 1
-layout: post
-generator: [anything]
 title: My new blog
 ---</code></pre>
<p>All variables from parameters are available in templates, no need to pick explicitly each one of them.</p>
<h2 id="9-Update-Permalinks">9. Update Permalinks</h2>
<p>Sometimes you need to generate different output filename than Sculpin chooses. It's the same in Statie, just with more clear name:</p>
<pre><code class="language-diff"> ---
-permalink: atom.xml
+outputPath: atom.xml
 ---</code></pre>
<h2 id="10-Drop-Parameter-Prefixes">10. Drop Parameter Prefixes</h2>
<p>Parameters are prefixed in Sculpin - sometimes not, sometimes with page, sometimes with site.</p>
<pre><code class="language-yaml">parameters:
    title: "The Best Bugs"</code></pre>
<p>Statie doesn't make you think: names in parameters = variables is in templates.</p>
<pre><code class="language-diff">-{{ site.title }}
+{{ title }}</code></pre>
<h2 id="11-Run-Project-Locally">11. Run Project Locally</h2>
<p>Do you want live updates streamed to your browser on every change of the code?</p>
<pre><code class="language-bash">npm install
gulp</code></pre>
<ul>
<li>Then open <code>localhost:8000</code> to see your generated HTML.</li>
</ul>
<p><br></p>
<p>That's it! You can enjoy Markdown, Twig, Latte, and PHP directly from your local machine and still on Github Pages.</p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/01/14/11-steps-to-migrate-from-sculpin-to-statie</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 14 Jan 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/01/14/11-steps-to-migrate-from-sculpin-to-statie#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 9 Steps to Migrate From Jekyll to Statie ]]></title>
                <link>https://tomasvotruba.com/blog/2019/01/10/9-steps-to-migrate-from-jekyll-to-statie</link>
                <description><![CDATA[ <p>Jekyll is great a way to start static website on Github Pages. But Jekyll has one big problem - the language.
How would you add custom Twig or Latte filter to Jekyll?
<br><br>
I wanted to migrate my static websites from Jekyll to Statie. Can new <code>init</code> command make this piece of cake? And what needs to be done next?</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="1-Create-Basic-Statie-Structure">1. Create Basic Statie Structure</h2>
<p>Statie 5.3 brings <a href="/blog/2019/01/07/how-to-create-your-first-php-twig-static-website-under-2-minutes-with-statie/">new <code>init</code> command</a>, that creates basic structure in <code>/source</code> directory, <code>statie.yml</code>, <code>.travis.yml</code> and metafiles.</p>
<p>Before we start any moving, create a basic structure to save many copy-pasting steps:</p>
<pre><code class="language-bash">composer require symplify/statie
vendor/bin/statie init</code></pre>
<p>Then, clean <code>/source</code> directory from generated files and...</p>
<h2 id="2-Move-Source-files-to-source-Directory">2. Move Source files to <code>/source</code> Directory</h2>
<ul>
<li>Jekyll has all the source code in the root.</li>
<li>Statie works with <code>/source</code> directory, so the website is separated from PHP code, tests, metafiles.</li>
</ul>
<pre><code class="language-diff">-CNAME
+/source/CNAME</code></pre>
<pre><code class="language-diff">-index.html
+/source/index.html</code></pre>
<pre><code class="language-diff">-_data/projects.yaml
+/source/_data/projects.yaml</code></pre>
<h2 id="3-Move-Parameters-Files-Under-parameters-and-gt-param-name-Sections">3. Move Parameters Files Under <code>parameters &gt; [param name]</code> Sections</h2>
<p><strong>Before</strong> - Jekyll</p>
<pre><code class="language-yaml"># _data/projects.yaml
-
    name: Symplify
    url: https://github.com/symplify/symplify</code></pre>
<p><strong>After</strong> - Statie</p>
<pre><code class="language-yaml"># source/_data/projects.yaml
parameters:
    projects:
        -
            name: Symplify
            url: https://github.com/symplify/symplify</code></pre>
<h2 id="4-Upgrade-Absolute-Links-to-Moved-Files">4. Upgrade Absolute Links to Moved Files</h2>
<pre><code class="language-diff">-https://github.com/TomasVotruba/gophp71.org/edit/master/_data/projects.yaml
+https://github.com/TomasVotruba/gophp71.org/edit/master/source/_data/projects.yaml</code></pre>
<h2 id="5-Load-Moved-YAML-Files-in-statie-yml">5. Load Moved YAML Files in <code>statie.yml</code></h2>
<pre><code class="language-diff">+imports:
+    - { resource: "source/_data/projects.yaml" }</code></pre>
<h2 id="6-Remove-site-data-and-use-Variables-Directly">6. Remove <code>site.data.</code> and use Variables Directly</h2>
<pre><code class="language-diff"> &lt;ul&gt;
-    {% for project in site.data.projects %}
+    {% for project in projects %}
         &lt;li&gt;&lt;a href="{{ project.url }}"&gt;{{ project.name }}&lt;/a&gt;&lt;/li&gt;
     {% endfor %}
 &lt;/ul&gt;</code></pre>
<h2 id="7-Setup-Github-Pages-deploy-in-Travis">7. Setup Github Pages deploy in Travis</h2>
<p>Thanks to <code>vendor/bin/statie init</code> you have correctly configured <code>.travis.yml</code> in your repository.</p>
<p>To finish deploy, you need to:</p>
<ul>
<li>create <code>gh-pages</code> branch</li>
<li>pick it as a source for Github Pages</li>
<li>generate Github Token</li>
<li>put it to Travis configuration of your repository</li>
</ul>
<p>How you do this? Just <strong>follow <a href="https://www.statie.org/docs/github-pages">Statie.org documentation</a></strong> step by step.</p>
<h2 id="8-Clean-Metadata-from-Headers">8. Clean Metadata from Headers</h2>
<p>In Jekyll, it's required to have <code>---</code> section in files, even if empty. You can drop it now:</p>
<pre><code class="language-diff">- ---
- ---

HTML
...</code></pre>
<h2 id="9-Run-Project-Locally">9. Run Project Locally</h2>
<p>This is what I missed the most at Jekyll page - instant feedback. We want to develop and see output instantly - is it correct or is there a bug?</p>
<pre><code class="language-bash">npm install
gulp</code></pre>
<ul>
<li>Then open <code>localhost:8000</code> to see your generated HTML.</li>
<li>Did you edit code in <code>/source</code>? → Just <strong>refresh browser to see re-generated HTML</strong>.</li>
</ul>
<p>This is at least 100 times faster than deploying to Jekyll and checking the output in the production.</p>
<h3 id="Show-me-the-Real-Migration-Code">Show me the Real Migration Code</h3>
<ul>
<li><a href="https://github.com/DeprecatedPackages/gophp71.org/pull/32">pull request on gophp71.org</a></li>
<li><a href="https://github.com/DeprecatedPackages/gomonorepo.org/pull/7">pull request on gomonorepo.org</a></li>
</ul>
<p><br></p>
<p>That's it! You can enjoy Markdown, Twig and PHP directly from your local machine and still on Github Pages.</p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/01/10/9-steps-to-migrate-from-jekyll-to-statie</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 10 Jan 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/01/10/9-steps-to-migrate-from-jekyll-to-statie#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Create Your First PHP Twig Static Website under 2 Minutes with Statie ]]></title>
                <link>https://tomasvotruba.com/blog/2019/01/07/how-to-create-your-first-php-twig-static-website-under-2-minutes-with-statie</link>
                <description><![CDATA[ <p>Do you like to write or create micro-sites? This post is for you.
Statie is now <a href="https://packagist.org/packages/symplify/statie/stats">the most downloaded</a> PHP Twig static site generators, even surpassing 7-years old <a href="https://packagist.org/packages/sculpin/sculpin/stats">Sculpin</a> by 200 downloads a month. On the other hand, Sculpin is about to release <a href="https://github.com/sculpin/sculpin/releases">version 3</a> creating healthy competition.
<br><br>
As you can see, <strong>Static websites are on the rise in PHP</strong> and they were never used more than now. It's time to make creating a new static website simple for everyone.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Until today, to create and understand static website basics, you had to learn:</p>
<ul>
<li><a href="/blog/2017/02/20/statie-how-to-run-it-locally/">Statie - part 1: How to run it Locally</a></li>
<li><a href="/blog/2017/03/06/statie-2-how-to-add-contact-page-with-data">Statie - part 2: How to add Contact Page With Data
</a></li>
<li><a href="/blog/2017/03/09/statie-3-how-to-add-reusable-parts-of-code/">Statie - part 3: How to Add Reusable Parts of Code</a></li>
<li><a href="/blog/2017/03/13/statie-4-how-to-create-the-simplest-blog/">Statie - part 4: How to Create The Simplest Blog</a></li>
</ul>
<p><strong>Don't read it! It's an utter waste of time.</strong></p>
<h2 id="Documentation-is-Dead-Long-Live-Automatization">Documentation is Dead, Long Live Automatization</h2>
<p>In recent years, there is a trend towards <strong>embodied knowledge</strong>:</p>
<ul>
<li>Do you understand semver and compare package dependencies? - No, you use Composer.</li>
<li>Do you test your code against every PHP type? - No, you use PHPStan.</li>
<li>Do you type manually method names or class names? - No, you use PHPStorm (or any other IDE).</li>
<li>Do you upgrade your code manually? - No, you use Rector.</li>
</ul>
<p>In other words, <strong>the knowledge is shifting from human brain storage to tool's abilities</strong>.</p>
<p>Not the <em>smart knowledge</em> that helps us create algorithms, but the dummy knowledge like &quot;what is the 3rd most largest river in the USA&quot; that I can Google in 2-3 seconds (depending on internet connection in the train). We <a href="/blog/2017/12/04/life30-what-will-you-do-when-ai-takes-over-the-world/">don't become retarded</a>, we become more powerful to use our brains for what they're best at.</p>
<h2 id="Your-First-Statie-in-2-minutes">Your First Statie in 2 minutes</h2>
<p><a href="https://github.com/symplify/symplify/pull/1285" class="btn btn-dark btn-sm">
See pull-request #1285
</a></p>
<pre><code class="language-bash">composer require symplify/statie</code></pre>
<p>Statie 5.3 brings 1 new command:</p>
<pre><code class="language-bash">vendor/bin/statie init</code></pre>
<p>See how it works:</p>
<script id="asciicast-220449" src="https://asciinema.org/a/220449.js" async></script>
<p>Do you prefer Latte over Twig?</p>
<pre><code class="language-bash">vendor/bin/statie init --templating latte</code></pre>
<p>Explore the files to find hints on how to use templates, even if you never used Twig or Latte ever before ( ← embodied knowledge).</p>
<p><br></p>
<p>Great job! You're up and running locally.</p>
<p>Do you want to <strong>finish the Travis → Github Pages deployment</strong>? Just follow <a href="https://www.statie.org/docs/github-pages">the official documentation</a>.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/01/07/how-to-create-your-first-php-twig-static-website-under-2-minutes-with-statie</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 07 Jan 2019 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/01/07/how-to-create-your-first-php-twig-static-website-under-2-minutes-with-statie#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Complete Type Declarations without Docblocks with Rector ]]></title>
                <link>https://tomasvotruba.com/blog/2019/01/03/how-to-complete-type-declarations-without-docblocks-with-rector</link>
                <description><![CDATA[ <p>In <a href="/blog/2018/12/10/rocket-science-behind-migration-of-docblock-types-to-php-typehints/">previous post</a> we looked at how to migrate from docblocks to type declarations. From <code>@param Type $param</code> to <code>Type $param</code>. Even if it doesn't break code like coding standards do, works with inheritance, localized <code>self</code> and <code>static</code> and propagates types to all child classes, it's still not such a big deal.
<br><br>
But <strong>how do you complete type declarations if don't have any docblocks?</strong></p> ]]></description>
                <content:encoded><![CDATA[ <p>Well, you're doomed, because <strong>you should write</strong> <a href="/blog/2017/12/17/new-in-symplify-3-doc-block-cleaner-fixer/">docblocks everywhere where useful</a>.</p>
<pre><code class="language-php">&lt;?php

class SomeClass
{
    public function getItems()
    {
        return ['Statie', 'EasyCodingStandard', 'Rector'];
    }
}</code></pre>
<p>If you only typed <code>@return</code> annotation 4 years ago, where no-one thought there will ever be scalar type declarations and such annotations were only for geeks. Transition to PHP 7 features would be so easy:</p>
<pre><code class="language-diff"> &lt;?php

 class SomeClass
 {
-    public function getItems()
+    public function getItems(): array
     {
         return ['Statie', 'EasyCodingStandard', 'Rector'];
     }
 }</code></pre>
<p>Now, I hope you've learned, that <strong>future compatibility is a thing</strong> and you'll write annotations to each property, so they Rector will <a href="/blog/2018/11/15/how-to-get-php-74-typed-properties-to-your-code-in-few-seconds/#visualize-future-compatibility">convert them to type declarations</a> once PHP 7.4 is out.</p>
<h2 id="and-quot-It-s-Not-My-Fault-and-quot">&quot;It's Not My Fault&quot;</h2>
<p>Well, but what if you've inherited such legacy code, are you to blame? No, <strong>no-one is to blame even if you wrote the code</strong>. That's how change works. <strong>We feel like we know all today, but in 5 years array-type declarations will be considered code smell</strong> and we keep it only <em>for historical reasons</em>.</p>
<p>So how can we fight the change together?</p>
<pre><code class="language-php">&lt;?php

class SomeClass
{
    public function getItems()
    {
        $items = ['Statie', 'EasyCodingStandard', 'Rector'];

         return $this-&gt;sortItems($items);
    }

    private function sortItems(array $items)
    {
        sort($items);
        return $items;
    }
}</code></pre>
<p>How would upgrade this code to type declarations?</p>
<pre><code class="language-diff"> &lt;?php

 class SomeClass
 {
-    public function getItems()
+    public function getItems(): array
     {
         $items = ['Statie', 'EasyCodingStandard', 'Rector'];

         return $this-&gt;sortItems($items);
     }

-    private function sortItems(array $items)
+    private function sortItems(array $items): array
     {
         sort($items);
         return $items;
     }
 }</code></pre>
<p>Good job, that's correct! Now you can do it for the rest of your 25 000 lines of code.</p>
<p>Or... You can be <em>lazy smart </em> and <strong>use static analysis from PHPStan to do it for you</strong>. It already knows that:</p>
<ul>
<li><code>$items</code> is <code>array</code> with strings</li>
<li><code>sort</code> sorts <code>array</code> and keeps it an <code>array</code></li>
</ul>
<p>That was too easy... let's check case we'll find in our code:</p>
<pre><code class="language-diff"> &lt;?php

 // ...

-public function getResult()
+public function getResult(): float
 {
     if (true) {
         return 5.2;
     }

     $value = 5.3;

     return $value;
 }</code></pre>
<p>Don't get confused by incorrect doc:</p>
<pre><code class="language-diff"> /**
  * @return bool
  */
-public function getNumber()
+public function getNumber(): int
 {
     return 5;
 }</code></pre>
<p>Is one object or null?</p>
<pre><code class="language-diff"> &lt;?php

 // ...

-public function resolve(Product $product)
+public function resolve(Product $product): ?Product
 {
     // ...

     if (...) {
         return null;
     }

     return $product;
 }</code></pre>
<p><br></p>
<blockquote class="blockquote text-center mb-5 mt-5">
    If PHPStorm or PHPStan knows what type it is,<br>
    there is a big chance Rector can change it everywhere in your code.
</blockquote>
<p><br></p>
<p><a href="https://github.com/jkuchar">Honza Kuchař</a> spend one afternoon over Rector with me and motivated me to add this feature to Rector, so PHP developers can enjoy the laziness AST provides. Thank you, Honza! It's done (<a href="https://github.com/rectorphp/rector/pull/880">see PR</a>).</p>
<p>Just setup <a href="https://github.com/rectorphp/rector">Rector</a> and upgrade your code:</p>
<pre><code class="language-php">use Rector\TypeDeclaration\Rector\FunctionLike\ReturnTypeDeclarationRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;rule(ReturnTypeDeclarationRector::class);
};</code></pre>
<pre><code class="language-bash">vendor/bin/rector process src</code></pre>
<p>Done!</p>
<p><br></p>
<p>Just one more thing...</p>
<h2 id="Properties-Without-at-var">Properties Without <code>@var</code>?</h2>
<p>There is a big chance that if our code misses <code>@param</code> and <code>@return</code> type declarations, the <code>@var</code> is missing as well. We don't have to go to legacy code to find such code.</p>
<p>Do you recognize this class?</p>
<pre><code class="language-php">&lt;?php

namespace Symfony\Component\Console\Command;

use Symfony\Component\Console\Application;

class Command
{
    private $application;
    private $name;
    private $processTitle;
    private $aliases = [];
    private $definition;
    private $hidden = false;
    private $help;
    private $description;
    private $ignoreValidationErrors = false;
    private $applicationDefinitionMerged = false;
    private $applicationDefinitionMergedWithArgs = false;
    private $code;
    private $synopsis = [];
    private $usages = [];
    private $helperSet;

    // ...

    public function setApplication(Application $application = null)
    {
        $this-&gt;application = $application;
    }
}</code></pre>
<p>Quiz question: how would <strong>you utilize AST to autocomplete all <code>@var</code> annotations to properties above</strong>?</p>
<p><br></p>
<p><code>$this-&gt;application = $application;</code> we know that <code>$application</code> can be upgraded to:</p>
<pre><code class="language-diff">+/**
+ * @var \Symfony\Component\Console\Application
+ */
 private $application;</code></pre>
<p>That's it! Let's put this algorithm into Rector:</p>
<pre><code class="language-php">use Rector\TypeDeclaration\Rector\Property\CompleteVarDocTypePropertyRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;rule(CompleteVarDocTypePropertyRector::class);
};</code></pre>
<pre><code class="language-bash">vendor/bin/rector process src</code></pre>
<p>↓</p>
<pre><code class="language-diff"> &lt;?php

 namespace Symfony\Component\Console\Command;

 use Symfony\Component\Console\Application;

 class Command
 {
+    /**
+     * @var \Symfony\Component\Console\Application
+     */
     private $application;
+    /**
+     * @var string
+     */
     private $name;
+    /**
+     * @var string
+     */
     private $processTitle;
+    /**
+     * @var mixed[]|string[]
+     */
     private $aliases = [];
+    /**
+     * @var \Symfony\Component\Console\Input\InputDefinition
+     */
     private $definition;
+    /**
+     * @var bool
+     */
     private $hidden = false;
+    /**
+     * @var string
+     */
     private $help;
+    /**
+     * @var string
+     */
     private $description;
+    /**
+     * @var bool
+     */
     private $ignoreValidationErrors = false;
+    /**
+     * @var bool
+     */
     private $applicationDefinitionMerged = false;
+    /**
+     * @var bool
+     */
     private $applicationDefinitionMergedWithArgs = false;
+    /**
+     * @var callable
+     */
     private $code;
+    /**
+     * @var mixed[]
+     */
     private $synopsis = [];
+    /**
+     * @var mixed[]
+     */
     private $usages = [];
+    /**
+     * @var \Symfony\Component\Console\Helper\HelperSet
+     */
     private $helperSet;</code></pre>
<p>In matter of seconds now we have:</p>
<ul>
<li>Better static type analysis ✅</li>
<li>Better PHPStorm autocomplete ✅</li>
<li>Better coding standards ✅</li>
<li>No manual boring work required from the developer ✅</li>
</ul>
<p><br></p>
<p>If you want to how Rector works behind this scene, (<a href="https://github.com/rectorphp/rector/pull/885">check the PR</a>). <strong>The code size to make this happen is not what you'd expect</strong> thanks to php-parser elegance (thanks Nikic!).</p>
<p><br></p>
<p>What more could be done to turn legacy code to elegant code? Share in comments, I'm eager to know.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2019/01/03/how-to-complete-type-declarations-without-docblocks-with-rector</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 03 Jan 2019 00:00:00 +0000</pubDate>
                                    <updated>2020-08-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Aug 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Aug 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2019/01/03/how-to-complete-type-declarations-without-docblocks-with-rector#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Your Most Favorite Posts in 2018 ]]></title>
                <link>https://tomasvotruba.com/blog/2018/12/31/your-most-favorite-posts-in-2018</link>
                <description><![CDATA[ <p>It's a holiday, we want to rest and enjoy time with our families. Hence I won't bother you with a complex topic, but finish this year with the simple post instead. A post about the most read post in 2018.
<br><br>
<strong>Was it Symfony? Doctrine? PHP or...</strong></p> ]]></description>
                <content:encoded><![CDATA[ <p>Without further ado, these are stats <strong>for unique readers</strong> from Google Analytics for 2018:</p>
<div class="text-center pt-3">
    <img src="/assets/images/posts/2018/top-posts/pie.png" class="mr-5">

    <strong><span class="bigger">3 posts = 31,4 % of readers</span></strong>

    <br>
    <br>

    <img src="/assets/images/posts/2018/top-posts/top-stats.png" class="img-thumbnail">
</div>
<h2 id="Top-5">Top 5</h2>
<p>Did you miss some of them? These <strong>will give you useful knowledge through 2019</strong>:</p>
<ul>
<li>
<p><a href="/blog/2017/10/16/how-to-use-repository-with-doctrine-as-service-in-symfony/">How to use Repository with Doctrine as Service in Symfony</a></p>
</li>
<li>
<p><a href="/blog/2018/08/16/whats-new-in-php-73-in-30-seconds-in-diffs/">What's New in PHP 7.3 in 30 Seconds in Diffs</a></p>
</li>
<li>
<p><a href="/blog/2018/09/17/7-tips-to-write-exceptions-everyone-will-love/">7 Tips to Write Exceptions Everyone Will Love</a></p>
</li>
<li>
<p><a href="/blog/2018/12/13/kirill-smelov-s-phpstorm-tips-in-9-gifs/">Kirill Smelov's PHPStorm Tips in 9 Gifs</a></p>
</li>
<li>
<p><a href="/blog/2017/12/25/composer-local-packages-for-dummies/">Composer Local Packages for Dummies</a></p>
</li>
</ul>
<h2 id="You-Read-a-Crazy-Lot">You Read a Crazy Lot</h2>
<p>I'm very happy that you don't just open, copy-paste and bounce away. You actually read - and not just a few paragraphs. Your reading times are almost equal to times to read the whole post. <strong>You read from the start to the end</strong>, which is amazing!</p>
<div class="text-center">
    <img src="/assets/images/posts/2018/top-posts/time.png" class="img-thumbnail">
</div>
<p><br></p>
<p>As I said, this would be quick and right to the point... unless you're reading one of those top 5 now and never got here :).</p>
<blockquote class="blockquote">
    Thank you for your support, active feedback and comments. Now enjoy the end of 2018 and be sure to welcome 2019. I'm certain and wish you that is amazing for all of us!
</blockquote>
<p>I'll do my best to make this blog the best know-how source.</p>
<p>See you next year!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/12/31/your-most-favorite-posts-in-2018</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 31 Dec 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/12/31/your-most-favorite-posts-in-2018#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How To Convert All Your Symfony Service Configs to Autodiscovery ]]></title>
                <link>https://tomasvotruba.com/blog/2018/12/27/how-to-convert-all-your-symfony-service-configs-to-autodiscovery</link>
                <description><![CDATA[ <p>Do you use Symfony autodiscovery services registration everywhere and your configs have no extra lines?
Skip this post and rather read another one.
<br>
<br>
But if <strong>you have many configs with manual service registration</strong>, tagging, and autowiring, keep reading. I'll show you how you can convert them easily be new Symplify package.</p> ]]></description>
                <content:encoded><![CDATA[ <p>I've been consulting a few Symfony e-commerce projects recently that all have <code>service.yml</code>. Big configs with manual service registration:</p>
<pre><code class="language-yaml">services:
    App\SomeService:
        autowire: true

    App\Controller\SomeController:
        autowire: true

    # 50 more lines...
    # 20 more files similar to this one</code></pre>
<p>I already wrote <a href="/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3/">How to refactor to new Dependency Injection features in Symfony 3.3</a>, so you can read it.</p>
<h2 id="What-Can-Go-Wrong">What Can Go Wrong?</h2>
<p>There are many reasons to <strong>automate this work</strong>, because <strong>there are many gotchas</strong> you have to be careful about. In each single service registration.</p>
<h2 id="1-Tags">1. Tags</h2>
<p>Name-only system tags <strong>can be removed</strong> thanks to <code>autoconfigure</code>:</p>
<pre><code class="language-diff"> services:
-    first_command:
-        class: App\Command\FirstCommand
-        tags:
-            - { name: 'console.command' }
-
-    second_command:
-        class: App\Command\SecondCommand
-        tags: ['console.command']
+    _defaults:
+        autoconfigure: true
+
+     App\Command\:
+         resource: '../src/Command'</code></pre>
<p>But you have to <strong>keep</strong> <a href="https://symfony.com/doc/current/console/commands_as_services.html#lazy-loading">lazy-loaded commands</a></p>
<pre><code class="language-yaml">services:
    first_command:
        class: App\Command\FirstCommand
        tags:
          - { name: 'console.command', command: 'first' }</code></pre>
<p>And tags with metadata:</p>
<pre><code class="language-yaml">services:
    App\EventListener\ExceptionListener:
        tags:
            - { name: 'kernel.event_listener', event: 'kernel.exception' }</code></pre>
<h2 id="2-Single-class-Names">2. Single-class Names</h2>
<p>Service name can be often dropped:</p>
<pre><code class="language-diff"> services:
-    app.controller:
-        class: App\SomeController
+    App\SomeController: ~</code></pre>
<p>Except for classes with no namespace:</p>
<pre><code class="language-yaml">services:
    Single_Class_Name:
        class: Single_Class_Name</code></pre>
<h2 id="3-Vendor-Autodiscovery">3. Vendor Autodiscovery</h2>
<p>Configs are usually mixed of your code (<code>/app</code> or <code>/src</code>) and 3rd party code (<code>/vendor</code>):</p>
<pre><code class="language-yaml"># old config
services:
    App\SomeService: ~
    App\AnotherService: ~

    Symplify\PackageBuilder\Parameter\ParameterProvider: ~
    Symplify\PackageBuilder\FileSystem\FileGuard: ~</code></pre>
<p>Seeing this you have to think about that. If not, you might accidentally apply autodiscovery everywhere:</p>
<pre><code class="language-diff"> services:
-    App\SomeService: ~
-    App\AnotherService: ~
+    App\:
+        resource: ../src

-    Symplify\PackageBuilder\Parameter\ParameterProvider: ~
-    Symplify\PackageBuilder\FileSystem\FileGuard: ~
+    Symplify\PackageBuilder\: ~
+        resource: ../vendor/symplify/package-builder/src</code></pre>
<p>Ops, the last case should not be converted - <strong>all 3rd party classes have to be explicit</strong> since they're handled by their own config/bundle in <code>/vendor</code>:</p>
<pre><code class="language-yaml">services:
    Symplify\PackageBuilder\Parameter\ParameterProvider: ~
    Symplify\PackageBuilder\FileSystem\FileGuard: ~</code></pre>
<h2 id="4-Exclude-Obviously">4. Exclude Obviously</h2>
<p>When you try to autoload a class with a constructor, it's considered a service. But not all classes with constructors are services. Symfony doesn't know that unless you tell it, and it would fail with missing argument exception.</p>
<pre><code class="language-diff"> services:
     App\:
        resource: ../src
+       exclude:
+           - ../src/Entity/*
+           - ../src/Exception/*
+           - ../src/Contract/*</code></pre>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/12/27/how-to-convert-all-your-symfony-service-configs-to-autodiscovery</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 27 Dec 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/12/27/how-to-convert-all-your-symfony-service-configs-to-autodiscovery#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Thank You ]]></title>
                <link>https://tomasvotruba.com/blog/2018/12/24/thank-you</link>
                <description><![CDATA[ <p>This was an amazing year for me. I made so many things happen - I won't write about them since you can see them on [the homepage]() and <a href="https://github.com/tomasvotruba">my Github</a>.
<br><br>
I want to write about you, my dear reader and contributor. <strong>I would not make it this far without you in 2018.</strong></p> ]]></description>
                <content:encoded><![CDATA[ <p>Thank you for discussion under the post - it often leads me to think about the topic in-depth and from different perspectives. Thank you for keeping comments constructive and creative. Thank you for sharing gists to your approach to coding.</p>
<ul>
<li>
<p>Thank you for emoticons under the post, that way I know many of you like gifs and diffs :).</p>
</li>
<li>
<p>Thank you for fixing my typos and contributing to this blog.</p>
</li>
<li>
<p>Thank you for your comments and votes on <a href="https://www.reddit.com/r/PHP">Reddit /r/php</a>. It gives me an idea, how skilled developers from countries all over the world see PHP.</p>
</li>
<li>
<p>Thanks for the amazing and warm meetups in Berlin, Vienna, and Singapore. I really appreciate the place to sleepover (you know who you are) and passionate discussions.</p>
</li>
</ul>
<p><strong>Thanks for your feedback that keeps me going</strong>. Thanks to you I could set myself for a goal to write 2 posts a week. I failed a lot in the start. I tried and I failed. But your feedback kept me on track. I saw you're into controversial topics no-one talks about and in short and useful examples of how to code and how not to code. And why! Without you, I would not write 96 posts this year. I've very grateful PHP community is such <a href="https://friendsofphp.org">a big family all over the World</a> and I'm happy you've made me feel welcomed.</p>
<h2 id="You-re-Amazing">You're Amazing</h2>
<p>I'm really amazed by this because the job of a programmer is to find bugs and fix them. We find mistakes, we're biased that way and it reflects in our communication. Well, you - the community around me - prove this wrong almost every day. Programmers are such nice people, <strong>who can appreciate each other and respect each other's work, even if they don't agree with him or her</strong>.</p>
<p>That's very important in relationships to allow growth and staying connected.</p>
<div class="card">
    <div class="card-header text-center">
        I would like to share a few of your feedbacks that kept me going in hard times
    </div>
    <div class="card-body text-center">
        <img src="/assets/images/posts/2018/thank-you/1.png">
        <br>

        <img src="/assets/images/posts/2018/thank-you/2.png" class="img-thumbnail">
        <br>

        <img src="/assets/images/posts/2018/thank-you/3.png">
        <br>

        <img src="/assets/images/posts/2018/thank-you/4.png" class="img-thumbnail">
        <br>

        <img src="/assets/images/posts/2018/thank-you/5.png">
        <br>

        <img src="/assets/images/posts/2018/thank-you/12.png">
        <br>

        <img src="/assets/images/posts/2018/thank-you/6.png">
        <br>

        <img src="/assets/images/posts/2018/thank-you/10.png">
        <br>

        <img src="/assets/images/posts/2018/thank-you/8.png" class="img-thumbnail">
        <br>

        <img src="/assets/images/posts/2018/thank-you/7.png">
        <br>

        <img src="/assets/images/posts/2018/thank-you/9.png" class="img-thumbnail">
        <br>

        <img src="/assets/images/posts/2018/thank-you/11.png">
    </div>
</div>
<p>I don't share this with you to brag about myself. I write this to show, <strong>how easy is to be nice</strong>. All of these messages made me feel warm.</p>
<p>When was the last time you said something like that to <strong>your colleague</strong>? And when was the last time you said &quot;there's a bug&quot; or &quot;it's wrong&quot;. Maybe similar words that made me happy, would make your colleague happy. Maybe it would reinforce the same behavior to people around him or her. Try it :)</p>
<p><br><br></p>
<p>Thank you again, <strong>you allow me to follow my passion</strong> - that's the best gift I could wish for!</p>
<p><br></p>
<p>Merry Christmas You All!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/12/24/thank-you</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 24 Dec 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/12/24/thank-you#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Introducing Symfony Flex Loader ]]></title>
                <link>https://tomasvotruba.com/blog/2018/12/20/introducing-symfony-flex-loader</link>
                <description><![CDATA[ <p>Symfony 4 and Flex is heading in direction of zero-setup configuration - no bundles, no extensions, no configuration. You already know how to get rid of <a href="/blog/2018/11/29/how-to-manage-configuration-in-symfony-without-bundle-extension-and-configuraiton/">Configuration</a>. Flex now loads services instead of Extension class.
<br>
<br>
But it has an extra price, a lot of new boilerplate code in Kernel. Today you'll learn <strong>how to keep your Kernel Flex-ready and clean at the same time</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Can you spot, what extra directory is this Kernel loading...</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

// ...

final class AppKernel extends Kernel
{
    // ...

    protected function configureContainer(ContainerBuilder $container, LoaderInterface $loader): void
    {
        $container-&gt;addResource(new FileResource($this-&gt;getProjectDir() . '/config/bundles.php'));
        $container-&gt;setParameter('container.dumper.inline_class_loader', true);
        $confDir = $this-&gt;getProjectDir() . '/config';
        $loader-&gt;load($confDir . '/{packages}/*' . self::CONFIG_EXTS, 'glob');
        $loader-&gt;load($confDir . '/{packages}/' . $this-&gt;environment . '/**/*' . self::CONFIG_EXTS, 'glob');
        $loader-&gt;load($confDir . '/{services}' . self::CONFIG_EXTS, 'glob');
        $loader-&gt;load($confDir . '/{services}_' . $this-&gt;environment.self::CONFIG_EXTS, 'glob');
        $loader-&gt;load(__DIR__ . '/optional/custom/path' . self::CONFIG_EXTS, 'glob');
    }

    // ...
}</code></pre>
<p>...in 2 seconds?</p>
<p>If you found <code>__DIR__ . '/optional/custom/path'</code>, good job!</p>
<p><br></p>
<p>What directory does <em>this</em> Kernel load?</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

// ...

final class AppKernel extends Kernel
{
    // ...

    protected function configureContainer(ContainerBuilder $container, LoaderInterface $loader): void
    {
        $this-&gt;flexLoader-&gt;loadConfigs($container, $loader, [
            __DIR__ . '/another/custom/path'
        ]);

        $container-&gt;addCompilerPass(new AutowireArrayParameterCompilerPass());
    }

    // ...
}</code></pre>
<p>Do you prefer to read about extra compiler passes that modify your application or all the directories and suffixes your configs might be loaded from?</p>
<p>Programmers are lazy and they <strong> don't want to read any letter more then they have to</strong>. Unless they're paid by for each read letter :).</p>
<h2 id="Make-Kernel-Small-Again">Make Kernel Small Again</h2>
<p>Symplify is introducing a small handy package - <a href="https://github.com/symplify/flexloader">FlexLoader</a>. It handles <strong>Flex service and route loading with 3 lines</strong> (methods) and makes your Kernel to be nice and readable - like they used to the old times.</p>
<p><br></p>
<p>How does FlexLoader look in practice?</p>
<img src="/assets/images/posts/2018/flex-loader/flex-loader.gif">
<p><br></p>
<p><strong>That's all!</strong> Now you can focus on important things, like writing <a href="/blog/2018/11/12/will-autowired-arrays-finally-deprecate-tags-in-symfony-and-nette/">cool compiler passes</a>.</p>
<p><br>
<br></p>
<p>Happy weight loss, so you're fit and slim for Christmas :)</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/12/20/introducing-symfony-flex-loader</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 20 Dec 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/12/20/introducing-symfony-flex-loader#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Function create_function() is Deprecated in PHP 7.2 - How to Migrate? ]]></title>
                <link>https://tomasvotruba.com/blog/2018/12/17/function-create-function-is-deprecated-in-php-72-how-to-migrate</link>
                <description><![CDATA[ <p>If there would be &quot;Miss Deprecation of PHP 7.2&quot;, <code>create_function()</code> would definitely win. They can be <strong>very complex, tricky and very hard convert to PHP code</strong>. Moreover without tests.
<br><br>
Do you have over 5 <code>create_function()</code> pieces in your code? Let's see how to migrate them.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Why is this deprecated? Well, the string arguments of few functions behaves like <code>eval()</code> - that's <a href="https://stackoverflow.com/a/951868/1348344">evil</a>.</p>
<pre><code class="language-php">&lt;?php

create_function("$a", "return $a");
assert("$value == 5");</code></pre>
<p>And what about quotes?</p>
<pre><code class="language-php">&lt;?php

create_function("$a", "return $a");
create_function('$a', 'return $a');</code></pre>
<p>You don't want to think which if <code>"</code> or <code>`</code> breaks the code - you want make code.</p>
<p>I think it's a good move, <strong>so how do we refactor them?</strong> Let's start with simple code:</p>
<pre><code class="language-php">&lt;?php

$callback = create_function('$matches', "return strtolower(\$matches[1]);");</code></pre>
<p><strong>How would you refactor this to anonymous function?</strong></p>
<p><em>(Pause for deep thinking...)</em></p>
<pre><code class="language-php">&lt;?php

$callback = function ($matches) {
    return strtolower($matches[1]);
};</code></pre>
<p>As you can see:</p>
<ul>
<li>1st argument = function arguments</li>
<li>2nd argument = function body</li>
</ul>
<p>Also, notice the <code>\$matches</code> → <code>$matches</code>. That's because quote escaping.</p>
<p><br></p>
<p>What about this one?</p>
<pre><code class="language-php">&lt;?php

create_function('$a,$b', "return \"min(b^2+a, a^2,b) = \".min(\$a*\$a+\$b,\$b*\$b+\$a);");</code></pre>
<p><strong>How would you refactor this to anonymous function?</strong></p>
<p><em>(Pause for deep thinking...)</em></p>
<pre><code class="language-php">&lt;?php

function ($a, $b) {
    return "min(b^2+a, a^2,b) = " . min($a * $a + $b, $b * $b + $a);
};</code></pre>
<p>The <code>"min(b^2+a, a^2,b) = "</code> is still a string, because it was escaped string in a string.</p>
<img src="http://www.memefaces.com/static/images/memes/2868.jpg">
<p>Too easy for you? Damn, you're smart.</p>
<p><br></p>
<p>Can you handle this?</p>
<pre><code class="language-php">&lt;?php

create_function('$b,$a', 'if (strncmp($a, $b, 3) == 0) return "** \"$a\" '.
            'and \"$b\"** Look the same to me! (looking at the first 3 chars)";');</code></pre>
<p><strong>How would you refactor this to anonymous function?</strong></p>
<p><em>(Pause for deep thinking...)</em></p>
<pre><code class="language-php">&lt;?php

function ($b, $a) {
    if (strncmp($a, $b, 3) == 0) {
        return "** \"{$a}\" and \"{$b}\"** Look the same to me! (looking at the first 3 chars)";
    }
};</code></pre>
<p><br></p>
<p>Ok, but you won't make this code snippet I found in Drupal/Wordpress:</p>
<pre><code class="language-php">&lt;?php

$this-&gt;map_xmlns_func = create_function('$p,$n', 'if(strlen($n[0])&gt;0) $xd
    .= ":{$n[0]}"; return "{$xd}=\"{$n[1]}\"";');</code></pre>
<p><strong>How would you refactor this to anonymous function?</strong></p>
<p><em>(Pause for deep thinking...)</em></p>
<pre><code class="language-php">&lt;?php

$this-&gt;map_xmlns_func = function ($p, $n) use ($xd) {
    if (strlen($n[0]) &gt; 0) {
        $xd .= ":{$n[0]}";
    }
    return "{$xd}=\"{$n[1]}\"";
};</code></pre>
<p>Who did forget <code>use ($xd)</code>? An anonymous function can't access variables that are not passed as arguments, so without this would crash.</p>
<p><br></p>
<p>And we could continue and continue with more <em>edgy</em> cases... but I bet <strong>you're looking for a solution for your specific function</strong>.
Well, you could ask on StackOverflow (<a href="https://www.google.com/search?q=&quot;deprecated&quot;+&quot;create_function&quot;+&quot;php&quot;+&quot;7.2&quot;+site%3Astackoverflow.com+-preg_replace&amp;oq=&quot;deprecated&quot;+&quot;create_function&quot;+&quot;php&quot;+&quot;7.2&quot;+site%3Astackoverflow.com+-preg_replace">181 results and counting</a>), but posting each of your 10 cases might get you banned. I have good news for you.</p>
<img src="/assets/images/posts/2018/create-function/sonic.png" class="img-thumbnail">
<p><br></p>
<p>Today in 2019 (almost there), you can instantly upgrade your code and it <strong>will take you less time to install &amp; run, then read this whole post so far</strong>.</p>
<p>Just setup <a href="https://github.com/rectorphp/rector">Rector</a> and run it:</p>
<pre><code class="language-bash">composer require rector/rector --dev</code></pre>
<pre><code class="language-php">use Rector\Php72\Rector\FuncCall\CreateFunctionToAnonymousFunctionRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;rule(CreateFunctionToAnonymousFunctionRector::class);
};</code></pre>
<pre><code class="language-bash">vendor/bin/rector process src</code></pre>
<p><br></p>
<p>Happy instant upgrading!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/12/17/function-create-function-is-deprecated-in-php-72-how-to-migrate</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 17 Dec 2018 00:00:00 +0000</pubDate>
                                    <updated>2020-08-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Aug 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Aug 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/12/17/function-create-function-is-deprecated-in-php-72-how-to-migrate#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Kirill Smelov&#039;s PHPStorm Tips in 9 Gifs ]]></title>
                <link>https://tomasvotruba.com/blog/2018/12/13/kirill-smelov-s-phpstorm-tips-in-9-gifs</link>
                <description><![CDATA[ <p>Last week we hosted <a href="https://twitter.com/wbasrs">Kirill Smelov</a> in Friends of PHP meetup in Prague. Usually, I know most of tricks people show in PHPStorm talks or they pick too complicated cases - like SSH to Docker via PHPStorm GUI.
<br><br>
Kirill's talk was completely different, <strong>I could not stop taking notes</strong> about simple yet less known features of PHPStorm.
<br><br>
Instead of watching the 45-min talk, <strong>enjoy 9 cherry picked tips in 4,5-min gifs</strong>. I've dropped a few of my own daily habits. Enjoy!</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="1-Ctor-when-you-add-a-property-via-constructor">1. Ctor - when you add a property via constructor</h2>
<img src="/assets/images/posts/2018/phpstorm-tips-in-gifs/ctor.gif" class="img-thumbnail">
<p><br><br><br></p>
<h2 id="2-Post-Fix">2. Post-Fix</h2>
<p>Do you type the same code around a variable zillion times?</p>
<img src="/assets/images/posts/2018/phpstorm-tips-in-gifs/postfix.gif" class="img-thumbnail">
<p><br><br><br></p>
<h2 id="3-Forget-this-and-gt">3. Forget <code>$this-&gt;</code></h2>
<img src="/assets/images/posts/2018/phpstorm-tips-in-gifs/no-this.gif" class="img-thumbnail">
<p><br><br><br></p>
<h2 id="4-Jump-to-Next-use-of-Method">4. Jump to Next use of Method</h2>
<img src="/assets/images/posts/2018/phpstorm-tips-in-gifs/jump-to-method.gif" class="img-thumbnail">
<p><br><br><br></p>
<h2 id="5-Save-Live-Template">5. Save Live Template</h2>
<img src="/assets/images/posts/2018/phpstorm-tips-in-gifs/live-template.gif" class="img-thumbnail">
<p><br><br><br></p>
<h2 id="6-Jump-to-Another-Method">6. Jump to Another Method</h2>
<img src="/assets/images/posts/2018/phpstorm-tips-in-gifs/method-jump.gif" class="img-thumbnail">
<p><br><br><br></p>
<h2 id="7-Copy-FQN-class-or-File-line">7. Copy FQN class or File:line</h2>
<img src="/assets/images/posts/2018/phpstorm-tips-in-gifs/copy-reference.gif" class="img-thumbnail">
<p><br><br><br></p>
<h2 id="8-Jump-to-previous-File-Jump-to-previous-File">8. Jump to previous File → Jump to previous File</h2>
<img src="/assets/images/posts/2018/phpstorm-tips-in-gifs/recent-files.gif" class="img-thumbnail">
<p><br><br><br></p>
<h2 id="9-Create-a-shortcut">9. Create a shortcut</h2>
<img src="/assets/images/posts/2018/phpstorm-tips-in-gifs/create-shortcut.gif" class="img-thumbnail">
<p><br><br><br></p>
<h2 id="How-to-Work-With-Shortcuts">How to Work With Shortcuts?</h2>
<p>Get inspired by watching others, but in the end - <strong>always respect your brain</strong>. Every one of you has <strong>different preferences</strong>.</p>
<p>Let say you create a shortcut &quot;new file&quot;:</p>
<ul>
<li>you might like starting letter of action: <code>nf</code></li>
<li>or 2 letters of each word: <code>nefi</code></li>
<li>or just one letter, because you use 1 action per letter: <code>n</code></li>
</ul>
<h2 id="Punish-vs-Typo-Proof">Punish vs. Typo-Proof</h2>
<p>Also, as I love to type fast like crazy, I often make a typo or don't remember the exact 2 letters. Why punish yourself for a typo or not remembering the right combination?</p>
<p><strong>Add a fallback:</strong></p>
<ul>
<li><em>rf</em> → <code>return false;</code></li>
<li><em>refa</em> → <code>return false;</code></li>
<li><em>ref</em> → <code>return false;</code></li>
<li><em>reaf</em> → <code>return false;</code></li>
</ul>
<p>To give you an idea of my daily work, here is my current list of live templates:</p>
<img src="/assets/images/posts/2018/phpstorm-tips-in-gifs/my-live-templates.gif" class="img-thumbnail">
<h2 id="Start-with-Single-Step">Start with Single Step</h2>
<p>I took notes about 15 items during Kirill's talk. They all were very interesting and I wanted to integrate at least 5 of them the very next day. I was excited about my skills going the speed of light. I put too much on myself, then I was afraid I will fail to integrate them all. So I ended-up using just one.</p>
<p>What could I do different? <strong>Pick just one tip</strong>. Master it and then move to another.</p>
<p><br></p>
<blockquote class="blockquote text-center">
    What is the 1 tip you'll use tomorrow?
</blockquote>
<p>Integrate it and if you want more, you can always come back to this post.</p>
<p><br></p>
<p>Thanks to <a href="https://plugins.jetbrains.com/plugin/7345-presentation-assistant">Presentation Assistant</a> for the green banner that helped to make this post.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/12/13/kirill-smelov-s-phpstorm-tips-in-9-gifs</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 13 Dec 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/12/13/kirill-smelov-s-phpstorm-tips-in-9-gifs#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ The Rocket Science Behind Migration of Docblock Types to PHP Typehints ]]></title>
                <link>https://tomasvotruba.com/blog/2018/12/10/rocket-science-behind-migration-of-docblock-types-to-php-typehints</link>
                <description><![CDATA[ <p>What if you could add scalar typehints <code>int</code>, <code>bool</code>, <code>string</code>, <code>null</code> to all parameter type and return type by running a CLI command? But also all classes, <code>parent</code>, <code>self</code> and <code>$this</code>?
<br>
<br>
Do you think it's an easy task to move <code>@param int $number</code> to <code>(int $number)</code>?</p> ]]></description>
                <content:encoded><![CDATA[ <p>Sneak peak what this post will be about:</p>
<img src="/assets/images/posts/2018/rocket-typehints/example.gif" class="img-thumbnail">
<p><br></p>
<p>There are tools that convert <code>@param</code> and <code>@return</code> doc to types today - like coding standards:</p>
<pre><code class="language-diff"> /**
  * @param int $number
  * @param string|null $name
  * @return bool
  */
-public function isBigEnough($number, $name)
+public function isBigEnough(int $number, ?string $name): bool
 {
 }</code></pre>
<p>But its <strong>breaks your code</strong> because it <strong>only works with tokens of the current file</strong>. It's like robot seeing the text by <em>e a c h c h a r</em> instead of understanding a sentence in a paragraph context.</p>
<p><a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer/pull/4056#issuecomment-442264393" class="text-center"></p>
<img src="/assets/images/posts/2018/rocket-typehints/break.png" class="img-thumbnail">
<p></a></p>
<p>You probably assume coding standard would not break your code, but then you spend 2 days fixing invalid typehints.</p>
<p>&quot;How did the example above break your code?&quot;, you might ask. That one would pass. But what if your implements interface from <code>/vendor</code>?</p>
<pre><code class="language-php">&lt;?php

interface Sniff
{
    /**
     * @param int $position
     */
    function process(File $file, $position);
}</code></pre>
<p>Your code updated by coding standards:</p>
<pre><code class="language-diff"> &lt;?php

 final class SuperCoolSniff implements Sniff
 {
     /**
      * @param int $position
      */
-    public function process(File $file, $position)
+    public function process(File $file, int $position)
     {
         // ...
     }
 }</code></pre>
<p class="text-danger">
    <strong>PHP Fatal error</strong>:
    Declaration of <code>SuperCoolSniff::process(File $file, <strong>int $position)</strong></code>
    <br>
    must be compatible with <code>Sniff::process(File $file, <strong>$position</strong>)</code> ...
</p>
<p><br></p>
<p>&quot;Just fix these cases manually&quot;. Yes, you could do that. But <strong>why would you test your code manually</strong> after each commit if you can cover them with tests in a matter of minutes?</p>
<p><br></p>
<p>I wonder what Albert Einstein would say seeing you do that work manually:</p>
<blockquote class="blockquote text-center">
    If you can't ~~explain~~ <em>automate</em> it simply,
    <br>
    you don't understand it well enough.
</blockquote>
<p><br></p>
<h2 id="Doc-Type">Doc != Type</h2>
<p>The problematic itself is not as simple as moving <code>@return int</code> to <code>int</code>.</p>
<p>If there is <code>@param boolean</code>, can the typehint be<code>boolean</code>?</p>
<pre><code class="language-diff">/**
 * @param integer $value
 * @return boolean|NULL $value
 */
-function some($value)
+function some(int $value): ?bool
 {
 }</code></pre>
<p><em>Since PHP 7.0 <a href="http://php.net/supported-versions.php">is dead now</a>, we'll work with PHP 7.1 with <code>void</code> and nullables on board.</em></p>
<p>I did some research on <a href="https://github.com/nikic/PHP-Parser/issues">existing tools</a>, <a href="https://github.com/dunglas/phpdoc-to-typehint/issues">their issues</a> and <a href="https://github.com/symfony/symfony/compare/master...TomasVotruba:typehint-test?expand=1">Symfony code</a> and this is what I found:</p>
<pre><code class="language-diff">/**
 * @param false|true|null $value
 */
-function some($value)
+function some(?bool $value)
 {
 }</code></pre>
<pre><code class="language-diff">/**
 * @param $this $value
 */
-function some($value)
+function some(self $value)
 {
 }</code></pre>
<pre><code class="language-diff">/**
 * @param array|Item[]|Item[][]|null $value
 */
-function some($value)
+function some(?array $value)
 {
 }</code></pre>
<pre><code class="language-diff">/**
 * @param \Traversable|array $value
 */
-function some($value)
+function some(iterable $value)
 {
 }</code></pre>
<p>Docs are quite easy, just parse few strings and change them to types that PHP accepts. <a href="https://github.com/phpstan/phpdoc-parser">phpdoc-parser</a> by <em>Jan&nbsp;Tvrdík</em> helps it lot, together with <a href="https://github.com/Symplify/BetterPhpDocParser">format-preserving printer</a>.</p>
<p>Let's get harder...</p>
<h2 id="Interface-Children-Traits-all-Together">Interface, Children, Traits all Together</h2>
<p>What happens when your interface is changed?</p>
<pre><code class="language-diff"> interface WorkerInterface
 {
      /**
       * @param string $version
       */
-     public function work($version);
+     public function work(string $version);
 }</code></pre>
<p>You need to update all its children:</p>
<pre><code class="language-diff"> final class StrongWorker implements WorkerInterface
 {
      /**
       * @param string $version
       */
-     public function work($version)
+     public function work(string $version)
      {
      }
 }</code></pre>
<pre><code class="language-diff"> final class SmartWorker implements WorkerInterface
 {
      /**
       * @param string $version
       */
-     public function work($version)
+     public function work(string $version)
      {
      }
 }</code></pre>
<p>Don't forget the interface too:</p>
<pre><code class="language-diff"> interface CacheableWorkerIntreface extends WorkerInterface
 {
      /**
       * @param string $version
       */
-     public function work($version);
+     public function work(string $version);
 }</code></pre>
<p>And finally, one of my favorite cases I found in Symfony:</p>
<pre><code class="language-php"> &lt;?php

 final class SmartWorker implements WorkerInterface
 {
      use BasicWorkerTrait;
 }</code></pre>
<p>Oh no, we almost forgot to upgrade the trait that implements the interface indirectly:</p>
<pre><code class="language-diff"> &lt;?php

 trait BasicWorkerTrait
 {
-    public function work($version)
+    public function work(string $version)
     {
     }
 }</code></pre>
<p>Trait has no doc block, no interface, no class, no other trait in it. She has no idea she should be updated.</p>
<h2 id="self-and-amp-parent"><code>self</code> &amp; <code>parent</code></h2>
<p><code>self</code> and <code>parent</code> are unique in each classes.</p>
<pre><code class="language-diff"> &lt;?php

 class P
 {
 }

 class A extends P
 {
     /**
      * @return self
      */
-    public function foo()
+    public function foo(): self
     {
     }

     /**
      * @return parent
      */
-    public function bar()
+    public function bar(): parent
     {
     }
 }

 class B extends A
 {
-    public function foo()
+    public function foo(): A
     {
     }

-    public function bar()
+    public function bar(): P
     {
     }
 }</code></pre>
<h2 id="Respect-The-Namespace">Respect The Namespace</h2>
<p>Last but not least, different namespaces can cause another error:</p>
<pre><code class="language-diff"> &lt;?php

 namespace SomeNamespace;

 class A
 {
     /**
      * @return B ← "SomeNamespace\B"
      */
-    public function foo()
+    public function foo(): B
     {
     }
 }

 namespace AnotherNamespace;

 class C extends A
 {
-    public function foo()
+    public function foo(): B // missing class "AnotherNamespace\B"
+    public function foo(): \SomeNamespace\B // correct!
     {
     }
 }</code></pre>
<p><strong>Do you want more <em>wild code cases</em>?</strong> You'll find the full test battery of <a href="https://github.com/rectorphp/rector/tree/main/packages/Php/tests/Rector/FunctionLike">60 snippets here in Github test</a>.</p>
<p><br></p>
<p>This where <a href="/blog/2018/10/25/why-ast-fixes-your-coding-standard-better-than-tokens/">good old AST</a> comes the rescue. It knows all the nodes in your scope = not in <code>/vendor</code>, all children, all their implementations and used traits. It can traverse up and down this tree and see if the typehint would break something.</p>
<h2 id="Give-Your-Code-a-Typehint-Facelift">Give Your Code a Typehint Facelift</h2>
<p><a href="http://php.net/supported-versions.php">PHP 7.3 is out and PHP 7.0</a> is in <span class="text-danger">end of life</span> for 6 days. This is the best time to go PHP 7.1.</p>
<h3 id="1-Install">1. Install</h3>
<pre><code class="language-bash">composer require rector/rector --dev</code></pre>
<p><em>For those of you who have Rector already installed, use at least <code>0.3.24</code> version to get these features.</em></p>
<h3 id="2-Create-Config">2. Create Config</h3>
<pre><code class="language-php">use Rector\TypeDeclaration\Rector\FunctionLike\ParamTypeDeclarationRector;
use Rector\TypeDeclaration\Rector\FunctionLike\ReturnTypeDeclarationRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;rule(ParamTypeDeclarationRector::class);
    $rectorConfig-&gt;rule(ReturnTypeDeclarationRector::class);
};</code></pre>
<h3 id="3-Run">3. Run</h3>
<pre><code class="language-bash">vendor/bin/rector process src --dry-run

# all good? instantly upgrade your code ↓
vendor/bin/rector process src</code></pre>
<p>As there are many ways class-like elements can be connected - like the one with the trait that was accidentally part of interface -, there might be some more cases. <strong><a href="https://github.com/rectorphp/rector/issues">Report everything</a> you found</strong>, so one day this will be able to refactor all PHP Github code without breaking anything.</p>
<p><br></p>
<p>And when you're done, you can <a href="/blog/2017/12/17/new-in-symplify-3-doc-block-cleaner-fixer/">get your docblocks cleaned</a> :)</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/12/10/rocket-science-behind-migration-of-docblock-types-to-php-typehints</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 10 Dec 2018 00:00:00 +0000</pubDate>
                                    <updated>2020-08-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Aug 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Aug 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/12/10/rocket-science-behind-migration-of-docblock-types-to-php-typehints#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Don&#039;t Learn to Code ]]></title>
                <link>https://tomasvotruba.com/blog/2018/12/06/dont-learn-to-code</link>
                <description><![CDATA[ <p>Do you know what each letter in S.O.L.I.D. means? Do you know commonly used design patterns? Do you know the most popular PHP frameworks? Do know what <a href="/blog/2018/05/21/is-your-code-readable-by-humans-cognitive-complexity-tells-you/">cyclomatic complexity</a> is?
<br><br>
Don't learn to code. <strong>Learn how to think.</strong></p> ]]></description>
                <content:encoded><![CDATA[ <p><strong>Ask more different people on the same topic</strong>. It's very easy to have <a href="https://en.wikipedia.org/wiki/Confirmation_bias">confirmation bias</a> if you're in a team. In time, everyone tends to think the same and it's very difficult to get creative or critical thinking. Go to <a href="https://friendsofphp.org">meetup</a> and ask what advantages has Docker in your situation. Go to <a href="https://www.reddit.com/r/PHP">reddit</a> and ask for other projects that sell tickets online. Go to Slack, <a href="https://pehapkari.herokuapp.com">Pehapkari</a> or <a href="https://symfony.com/slack-invite">Symfony</a> one and ask for tips to migrate to Symfony 4.2 and PHP 7.3. There is a huge chance you're not the first who has this idea.</p>
<p><br></p>
<p><strong>Beware of a <em>cult</em> thinking.</strong> When you're in a team where your team-leader has strong opinions, it's very probably there is polarized thinking. E.g. Nette, Doctrine and PostgreSQL is the best combination for big PHP applications.</p>
<blockquote class="blockquote text-center">
    "Do this." vs. "I prefer this, because..."
</blockquote>
<p>But do you know why? If you do, take one more step: do you know why do you think that? Have you read it somewhere, did you best friends told or did you actually experience it? <em>Cult thinking</em> is also common for people who followed trend-setters in PHP community - those who speak, write, tweet or comments on Reddit and StackOverflow the internet. I meet many people who read my blog and think monorepo is the best approach to work with repositories. But why, when do you use monorepo and when rather not? They don't know. Don't be afraid to question me or other people like me, be <a href="/blog/2018/03/19/how-to-criticize-like-a-senior-programmer/">critical</a> so we can both learn something. I've noticed it's common for lecturers and speakers like this to repeat what they've learned in last 10 years of the coding. Today is the slowest changing day for the rest of the humankind. Everything changes so help us see it so we can <a href="/blog/2018/12/03/it-bloggers-deprecate-your-posts-to-stop-spreading-legacy/">share back valid ideas</a>.</p>
<p>Ask in comments, learn how to disagree - there is a beautiful 6-point overview on how to <a href="http://www.paulgraham.com/disagree.html">disagree</a> by Paul Graham.</p>
<p><br></p>
<p><strong>Start with why.</strong> Do you know <a href="https://i.pinimg.com/originals/10/5c/fe/105cfe0d5374447963bcfea7e9c4ffe8.jpg">Simon Sinek</a>? If so, just skip this. If not, check his <a href="https://www.ted.com/talks/simon_sinek_how_great_leaders_inspire_action">Ted talk</a>. This changed my view on IT meetings in companies and meetups with PHP folks. Before I asked &quot;why&quot;, I only memorized other people's opinions. Now I feel I learn something.</p>
<p><br></p>
<p><strong>If nobody is doing it yet, you're just the first one who talks about it.</strong> Don't be afraid to <a href="https://austinkleon.com/show-your-work">share your work</a> and be open to other innovative ideas. Not everything under 1000 downloads is useless. Even Symfony had once had just a couple of downloads and had to go to market that was already dominated by established PHP frameworks. When I realized that AST can be used to refactor all PHP code on Github in a matter of hours from PHP 5.3 to 7.1 I pushed the idea back for many months because I thought somebody had to do that already. It's basically PHP CS Fixer, just with AST instead of tokens. I believe you, my dear reader, have a couple of ideas like this - &quot;it must exist somewhere&quot;. If you're not sure, go to <a href="https://packagist.org">packagist</a> and do little research. If it's not there, you have a go for new Github repository.</p>
<p><br></p>
<p>So go out, doubt, learn and play, because <strong>you already have the best sources</strong> to find out your answer.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/12/06/dont-learn-to-code</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 06 Dec 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/12/06/dont-learn-to-code#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ IT Bloggers, Deprecate Your Posts to Stop Spreading Legacy ]]></title>
                <link>https://tomasvotruba.com/blog/2018/12/03/it-bloggers-deprecate-your-posts-to-stop-spreading-legacy</link>
                <description><![CDATA[ <p>Do you blog about IT? Do you blog for more than a year? There is a big chance <strong>you're spreading already outdated information</strong>.
<br>
<br>
The problem is, your readers see that as <em>the best practise</em>... did you know the Earth is flat?
<br>
<br>
How to prevent that and keep your content quality high?</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="The-Long-Tail-Effect">The <em>Long-Tail</em> Effect...</h2>
<p>...that's spreads fake news.</p>
<p>If you answered &quot;yes&quot; twice to the perex, your posts are probably under long-tail effect.</p>
<img src="/assets/images/posts/2018/version-blog/long-tail.gif" class="img-thumbnail">
<p>They're frequently shared in the start, but the older they're, their total popularity rises. You might ask, <strong>what's the problem with that?</strong></p>
<p>Let's say you want to know how to use parameters in Symfony controller. What will you do? Google to <a href="https://stackoverflow.com/search?q=symfony+get+parameter+in+controller">StackOverflow</a>:</p>
<img src="/assets/images/posts/2018/version-blog/answer.png" class="img-thumbnail">
<p>Click <a href="https://stackoverflow.com/questions/13901256/how-do-i-read-from-parameters-yml-in-a-controller-in-symfony2/13901273#13901273">the first answer</a> and copy-paste the solution:</p>
<img src="/assets/images/posts/2018/version-blog/popular.png" class="img-thumbnail">
<p>We know it's outdated for years, but <strong>reader has no idea</strong>. He or she googled &quot;parameter Symfony Controller&quot; and just go with the most voted solution. I'd do it too.</p>
<p>The <strong>second answer for Symfony 3+</strong> that was released in 2016 has much less attention:</p>
<img src="/assets/images/posts/2018/version-blog/second.png" class="img-thumbnail">
<p>When the <em>long-tail effect</em> kicks in for this answer, it will be outdated. There will be also new answer for Symfony 6 with only 13 votes that no-one will read.</p>
<p>Legacy is spreading, Dark Legacy Lord is happy. <em>That's why <a href="/blog/2018/06/28/dont-read-books/">Don't Read books</a>.</em></p>
<h3 id="Old-Outdated">Old !== Outdated</h3>
<p>If time was the only issue, you could just limit Google results to last year. But it's not that easy.</p>
<p><strong>The old post doesn't mean outdated</strong>. One example for all - Matthias Noback, my favorite PHP writer, wrote about <a href="https://matthiasnoback.nl/2014/06/how-to-create-framework-independent-controllers">decoupled controllers as services</a> in 2014. It's still valid and we're just almost getting there now.</p>
<h2 id="How-to-Make-it-Right">How to Make it Right?</h2>
<p>How can I even write a post about PHP when I know they'll be useless in a few years? Well, you can <a href="/blog/2019/09/16/why-software-articles-must-be-ci-tested/">tests your posts</a> to automate this, but it takes time and setup.</p>
<p>Right now, <strong>I feel it's our responsibility as writers to inform our readers</strong> what is good and tasty to eat and what id rotten old trash.</p>
<p class="text-danger"><strong>Inform people clearly in the start of the page.</strong></p>
<p><br></p>
<p><a href="https://symfony.com/doc/3.1/components/console.html">Symfony blog</a> &nbsp;✅</p>
<img src="/assets/images/posts/2018/version-blog/symfony-warning.png">
<p><a href="https://mattstauffer.com/blog/how-to-organize-class-namespaces">Matt Stauffer blog</a> &nbsp;✅</p>
<img src="/assets/images/posts/2018/version-blog/update.png" class="img-thumbnail">
<p>It seems like a small detail, but it really helps people who are new in the fields to navigate differentiate between useless and good content.</p>
<h2 id="When-is-the-Best-Time-Now">When is the Best Time? Now!</h2>
<p>It's not an urgent call, December is really the best month to do this.</p>
<p>Why? A <a href="[/blog/2017/10/30/what-can-you-learn-from-menstruation-and-symfony-releases/]">new Symfony and PHP is released</a> - Symfony 4.2 is out now (this blogs is running on it already) and PHP 7.3 is around corner.</p>
<p>It can be as easy as upgrade <code>composer.json</code>:</p>
<pre><code class="language-diff"> {
     "require": {
-        "symfony/symfony": "^4.1"
+        "symfony/symfony": "^4.2"
     }
 }</code></pre>
<h2 id="Practical-Example">Practical Example</h2>
<p>&quot;Code, not words!&quot; I hear you.</p>
<p>I'm working on such PR right now for this blog - <a href="https://github.com/TomasVotruba/tomasvotruba.com/pull/582">see it on Github</a>.</p>
<h3 id="What-Changes-are-Included">What Changes are Included?</h3>
<ul>
<li>Symfony <del>4.1</del> → 4.2</li>
<li>deprecate Statie posts → official documentation <a href="https://www.statie.org">Statie.org</a></li>
<li>deprecate <a href="/blog/2017/06/26/php-object-calisthenics-rules-made-simple-version-3-0-is-out-now/">Object Calisthenics post</a> → <a href="/blog/2018/05/21/is-your-code-readable-by-humans-cognitive-complexity-tells-you/">Cognitive Complexity</a> instead</li>
<li><a href="/blog/2017/08/14/how-to-apply-nette-coding-standard-in-your-project/">Nette\CodingStandard post</a> - <del>0.5</del> → 2.0</li>
<li>deprecate <a href="/blog/2017/06/12/how-to-require-minimal-code-coverage-for-github-pull-requests-with-coveralls/">How to Require Minimal Code Coverage for Github Pull-Requests with Coveralls</a> - there is no added value</li>
<li>news in Symplify 2, 3 and 4 + reflect deprecations and removed classes</li>
<li>and few more...</li>
</ul>
<p>Notice, the depreciation is not removing. <strong>I always try suggests a link to go or at least keywords to Google or provide &quot;why&quot; you should not do that at all</strong>. That way people know where to go, instead of just bumping to a wall.</p>
<h2 id="Step-Up-and-Help-Spreading-Up-To-Date-Information">Step-Up and Help Spreading Up-To-Date Information</h2>
<p><strong>It's ok to make mistake and be wrong</strong>. It's also normal to change your opinion based on a change in the worlds - that's what happened to me with <a href="/blog/2017/03/27/why-is-doctrine-dying/">Why Doctrine is Dying</a> post.</p>
<p>When I wrote this post, the situation was really frustrating, no vision, no new features, and passive community. That's change during the following year and even though I didn't use Doctrine, it felt wrong having this post still up, even though it was not in sync with reality.</p>
<img src="/assets/images/posts/2018/version-blog/deprecated.png">
<p>That's why I deprecated original post and released a new one <a href="/blog/2018/07/09/6-reasons-why-doctrine-is-alive-and-kicking/">6 Reasons Why Doctrine is Alive and Kicking</a>.</p>
<p><br></p>
<p>Happy upgrading and thank you for doing this for PHP community!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/12/03/it-bloggers-deprecate-your-posts-to-stop-spreading-legacy</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 03 Dec 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/12/03/it-bloggers-deprecate-your-posts-to-stop-spreading-legacy#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Manage Configuration in Symfony without Bundle, Extension, and Configuration? ]]></title>
                <link>https://tomasvotruba.com/blog/2018/11/29/how-to-manage-configuration-in-symfony-without-bundle-extension-and-configuraiton</link>
                <description><![CDATA[ <p>Symfony Flex is moving towards of bundle-less applications. That doesn't mean you should create a monolith code in <code>/src</code> as fast as possible, but rather control everything via <code>.yaml</code> and <code>.env</code> files. It's takes <a href="/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3/#refactor-service-config-in-5-steps">few steps</a> to <strong>remove extension and move to import</strong> of <code>services.yaml</code>.
<br>
<br>
But how would you approach a simple task <strong>as <em>setup an account number</em> parameter</strong>?</p> ]]></description>
                <content:encoded><![CDATA[ <p>If you hear about the <strong>trend of &quot;no-bundle&quot; application</strong> for the first time, is very nicely summarized in 10 points in <a href="https://symfonycasts.com/blog/AppBundle">SymfonyCasts</a>. Go check it, I'll wait here.</p>
<img src="/assets/images/posts/2018/bundle-less/bundle-less.png" class="img-thumbnail" style="max-width:400px">
<h2 id="1-How-this-Affected-Service-Registration">1. How this Affected Service Registration?</h2>
<p>Before you need 3 classes to get services to the application:</p>
<pre><code class="language-bash">/app
    AppKernel.php
/packages
    /accountant
        /src
            /DependencyInjection
                AccountantExtension.php
            AccountantBundle.php
        /config
            services.yaml</code></pre>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace App;

use Project\Accountant\AccountantBundle;
use Symfony\Component\HttpKernel\Kernel;
use Symfony\Component\HttpKernel\Bundle\BundleInterface;

final class AppKernel extends Kernel
{
    /**
     * @return BundleInterface[]
     */
    public function registerBundles(): array
    {
        return [new AccountantBundle];
    }

    // ...
}</code></pre>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace Project\Accountant;

use Project\Accountant\DependencyInjection\AccountantExtension;
use Symfony\Component\HttpKernel\Bundle\Bundle;

final class AccountantBundle extends Bundle
{
 public function getContainerExtension()
    {
        return new AccountantExtension();
    }
}</code></pre>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace Project\Accountant\DependencyInjection;

use Symfony\Component\DependencyInjection\ContainerBuilder;
use Symfony\Component\DependencyInjection\Extension\Extension;
use Symfony\Component\DependencyInjection\Loader\YamlFileLoader;
use Symfony\Component\Config\FileLocator;

final class AccountantExtension extends Extension
{
    public function load(array $configs, ContainerBuilder $container)
    {
        $loader = new YamlFileLoader($container, new FileLocator(__DIR__.'/../../config'));
        $loader-&gt;load('services.yaml');
    }
}</code></pre>
<pre><code class="language-yaml"># packages/accountant/config/services.yaml
services:
    Project\Accountant\:
        resource: "../src"</code></pre>
<p>Now we can drop all of the PHP <a href="https://matthiasnoback.nl/2013/10/symfony2-some-things-i-dont-like-about-bundles">magic code</a> down:</p>
<pre><code class="language-diff"> /app
     AppKernel.php
 /packages
     /accountant
         /src
-            /DependencyInjection
-                AccountantExtension.php
-            AccountantBundle.php
         /config
             services.yaml</code></pre>
<p>...and load services in local config:</p>
<pre><code class="language-yaml"># app/config.yaml
imports:
   - { resource: "packages/accountant/config/services.yaml" }</code></pre>
<p>Or we can set this up just once for all <a href="/blog/2017/12/25/composer-local-packages-for-dummies/">local packages</a> with <a href="https://symfony.com/blog/new-in-symfony-3-3-import-config-files-with-glob-patterns">glob</a>:</p>
<pre><code class="language-yaml"># app/config.yaml
imports:
   - { resource: "packages/*/config/services.yaml" }</code></pre>
<p><strong>We deleted all PHP files and add 2 lines to config</strong> - that's what a good trade, right? Much less code can go wrong and the result is easy to read even for a programmer who was just hired today.</p>
<p><br></p>
<p>I think most of you already know this configuration shift and use it for months, right? Now the harder part, that many people still struggle with.</p>
<h2 id="2-How-this-Affected-Configuration">2. How this Affected Configuration?</h2>
<p>In the &quot;accountant&quot; package we have a service that sends money... no ordinary money, Bitcoins! And we need to <strong>set an account number parameter</strong> to it:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace Project\Accountant;

final class BitcoinSender
{
    /**
     * @param string
     */
    private $accountNumber;

    public function __construct(string $accountNumber)
    {
        $this-&gt;accountNumber = $accountNumber;
    }

    public function donateTo(float $amount, string $targetAccountNumber)
    {
        // move $amount
        // from $this-&gt;accountNumber
        // to $targetAccountNumber
    }
}</code></pre>
<p>The configuration of <code>$accountNumber</code> value in <a href="https://stovepipe.systems/post/creating-bundle-configuration"><em>bundle-school</em> paradigm</a> looks like this:</p>
<pre><code class="language-diff"> # packages/accountant/config/services.yaml
+accountant:
+     account_number: "123_secret_hash"
+
 services:
     Project\Accountant\:
         resource: "../src"</code></pre>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace Project\Accountant;

use Project\Accountant\DependencyInjection\AccountantExtension;
use Symfony\Component\HttpKernel\Bundle\Bundle;

final class AccountantBundle extends Bundle
{
    public function getContainerExtension()
    {
        return new AccountantExtension();
    }
}</code></pre>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace Project\Accountant\DependencyInjection;

use Symfony\Component\DependencyInjection\ContainerBuilder;
use Symfony\Component\DependencyInjection\Extension\Extension;

final class AccountantExtension extends Extension
{
    public function load(array $configs, ContainerBuilder $container)
    {
        $configuration = new AccountantConfiguration();
        $config = $this-&gt;processConfiguration($configuration, $configs);

        // for bitcoin sender
        $container-&gt;getDefinition('Project\Accountant\BitcoinSender')
            -&gt;setArgument('accountNumber', $config['account_number']);

        // for further use (optional)
        // $container-&gt;setParameter('account_number', $config['account_number']);
    }
}</code></pre>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace Project\Accountant\DependencyInjection;

use Symfony\Component\Config\Definition\Builder\TreeBuilder;
use Symfony\Component\Config\Definition\ConfigurationInterface;

final class AccountantConfiguration implements ConfigurationInterface
{
    public function getConfigTreeBuilder(): TreeBuilder
    {
        $treeBuilder = new TreeBuilder();
        $rootNode = $treeBuilder-&gt;root('accountant');
        $rootNode
            -&gt;children()
                -&gt;scalarNode('account_number')
                -&gt;end()
            -&gt;end();

        return $treeBuilder;
    }
}</code></pre>
<p>All this fuss just to <strong>load single parameter</strong>? Not anymore:</p>
<pre><code class="language-diff"> /app
     AppKernel.php
 /packages
     /accountant
         /src
-            /DependencyInjection
-                AccountantExtension.php
-                AccountantConfiguration.php
-            AccountantBundle.php
         /config
             services.yaml</code></pre>
<p>All cleaned up. We run the app and...</p>
<p><em>ERROR: &quot;$accountNumber&quot; argument was not set</em></p>
<p>Damn! What now?</p>
<h2 id="What-Options-do-We-Have">What Options do We Have?</h2>
<h3 id="1-Keep-the-Extension">1. Keep the Extension</h3>
<pre><code class="language-php">&lt;?php

$container-&gt;getDefinition('Project\Accountant\BitcoinSender')
    -&gt;setArgument('accountNumber', $config['account_number']);</code></pre>
<p>❌</p>
<p>We want to get rid of this code, not to maintain it.</p>
<h3 id="2-Set-Parameter-Manually-in-the-Config">2. Set Parameter Manually in the Config</h3>
<pre><code class="language-diff"> # packages/accountant/config/services.yaml
-accountant:
+parameters:
     account_number: "123_secret_hash"

 services:
     Project\Accountant\:
         resource: "../src"

+    Project\Accountant\BitcoinSender:
+        arguments:
+            $accountNumber: "%account_number%"</code></pre>
<p>We want config to use PSR-4 autodiscovery to it's fullest potential, not go back to manual service definitions.</p>
<h3 id="3-Bind-the-parameter">3. Bind the parameter</h3>
<p>Good idea! Since <a href="https://symfony.com/blog/new-in-symfony-3-4-local-service-binding">Symfony 3.4</a> we can do this:</p>
<pre><code class="language-diff"> # packages/accountant/config/services.yaml
-accountant:
+parameters:
     account_number: "123_secret_hash"

 services:
+    _defaults:
+        bind:
+            $accountNumber: "%account_number%"
+
     Project\Accountant\:
         resource: "../src"</code></pre>
<p>✅</p>
<h3 id="4-Autowire-the-Parameter">4. Autowire the Parameter</h3>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace App;

use Symplify\PackageBuilder\DependencyInjection\CompilerPass\AutowireArrayParameterCompilerPass;
use Symfony\Component\DependencyInjection\ContainerBuilder;
use Symfony\Component\HttpKernel\Kernel;

final class AppKernel extends Kernel
{
    protected function build(ContainerBuilder $container): void
    {
        $container-&gt;addCompilerPass(new AutowireArrayParameterCompilerPass());
    }
}</code></pre>
<p>You set up this only once, but then you can enjoy short and clear configs:</p>
<pre><code class="language-diff"> # packages/accountant/config/services.yaml
-accountant:
+parameters:
     account_number: "123_secret_hash"

 services:
     Project\Accountant\:
         resource: "../src"</code></pre>
<p>✅</p>
<p>This compiler autowires parameters by convention:</p>
<ul>
<li><code>%parameter_name%</code> =&gt; <code>$parameterName</code></li>
</ul>
<p>You can <a href="/blog/2018/11/05/do-you-autowire-services-in-symfony-you-can-autowire-parameters-too/">read more about it here</a>.</p>
<h2 id="Final-Results">Final Results</h2>
<p>So how does our bundle-less application looks like in the end?</p>
<ul>
<li>we got rid of the <code>Configuration</code> class - no more tree fluent builds for a bunch of parameters</li>
<li>we got rid of the <code>Extension</code> class - no more relative paths</li>
<li>we got rid of the <code>Bundle</code> class - no more <code>createExtension()</code>, <code>getExtension()</code> typos</li>
<li>we gain parameter binding/autowiring</li>
</ul>
<p><strong>We work with configs that clearly state all we parameters and services we use</strong>. Explicit, clear, in one place.</p>
<p><br></p>
<p>How do you approach parameter for your packages (previously bundles) in Symfony 4 applications?</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/11/29/how-to-manage-configuration-in-symfony-without-bundle-extension-and-configuraiton</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 29 Nov 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/11/29/how-to-manage-configuration-in-symfony-without-bundle-extension-and-configuraiton#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 14 Tips to Write PHP Code that is Hard to Maintain and Upgrade ]]></title>
                <link>https://tomasvotruba.com/blog/2018/11/26/14-tips-to-write-php-code-that-is-hard-to-maintain-and-upgrade</link>
                <description><![CDATA[ <p>Today I'll show you how to own your company. All you need to do is write code that no-one can read, is hard to refactor and creates technical debt. It's not easy, because if other programmers spot you're writing legacy code, you're busted.
<br><br>
If you keep a low profile of very smart architect and do it right, you'll be the only one in the company who knows what is going on and you'll have a value of gold. Learn how to be <strong>successful living vendor lock</strong>!</p> ]]></description>
                <content:encoded><![CDATA[ <h3 id="3-Signs-of-Living-Vendor-Lock-In">3 Signs of Living Vendor Lock-In</h3>
<p><code>/vendor</code> is a directory in your project with all the packages dependencies. <a href="https://en.wikipedia.org/wiki/Vendor_lock-in">Vendor lock-in</a> is life-death dependency company on you.
It's like having a baby - <strong>you have to take care of it for the next 18 years</strong> (at least):</p>
<img src="/assets/images/posts/2018/vendor/free-hug.jpg" class="img-thumbnail">
<p>How to make company code depend on you? You want to write a code that static analysis and instant upgrades are very hard to use. Where Rector could help you to turn not-so-bad-code to the modern code base in a matter of few weeks, here will fail hard and the only way out will be greenfield review.</p>
<p><a href="http://www.osnews.com/story/19266/WTFs_m"></p>
<img src="/assets/images/posts/2018/vendor/wtf.jpg" class="img-thumbnail">
<p></a></p>
<p>But not an obvious way like the right one. The company can't find out! You have to be sneaky as <em>Eliot</em> to <em>E-Corp</em>.</p>
<p>Here are 15 examples of such <strong>code collected from existing vendor lock-in projects</strong> I reviewed:</p>
<h2 id="1-Never-use-final">1. Never use <code>final</code></h2>
<p>Programmers want freedom, users desire options. Why setting healthy boundaries, when you can set them free:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace YourProject;

class PriceCalculator
{

}</code></pre>
<p>That way, anyone can extend your class:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

class BetterPriceCalculator extends PriceCalculator
{

}</code></pre>
<p>Also, it's <a href="https://github.com/cpliakas/git-wrapper/issues/159">needed for mocking</a> and there is no <a href="https://github.com/dg/bypass-finals">way around that</a>. There's not even <a href="https://ocramius.github.io/blog/when-to-declare-classes-final">8 reasons</a> to use <code>final</code> anywhere anytime.</p>
<h2 id="2-Use-protected-instead-of-private">2. Use <code>protected</code> instead of <code>private</code></h2>
<p>What is opened class good for with <code>private</code> methods? You need to use <code>protected</code> method to be really opened:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

class PriceCalculator
{
    protected function calculatePrice(Product $product)
    {
        // ...
    }
}</code></pre>
<p>Be careful, <code>public</code> would be too obvious to anyone who ever heard that SOLID and other might find out what's your real intention.</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

class BetterPriceCalculator extends PriceCalculator
{
    protected function calculatePrice(Product $product)
    {
        return 1000;
    }
}</code></pre>
<h2 id="3-Use-Non-String-Method-Names">3. Use Non-String Method Names</h2>
<p>This is tricky for real professionals - I hope you're to look smart in front of your team! If there is a way</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

class PriceCalculator
{
    public function calculateDiscount(Product $product, string $type)
    {
        $methodName = 'calculate' . $type; // great job!

        return $this-&gt;$methodName($product);
    }
}</code></pre>
<p><code>$methodName</code> is a string - it can be anything, so freedom &amp; dynamic!</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

class ProductController
{
    public function orderProductAction(Request $request)
    {
        $form = new OrderProductForm;
        $form-&gt;afterSubmit = [$this, 'processForm']; // great job!

        $form-&gt;handle($request);
    }

    public function processForm(Request $request)
    {
        // ...
    }
}

class Form
{
    public $afterSubmit;

    public function handle(Request $request)
    {
        // ...

        call_user_func($this-&gt;afterSubmit, $request);
    }
}</code></pre>
<p>Why is this so well written? Imagine we're looking at the legacy code - huge code base, 100 of places where the method is used at.
Try to rename <code>processForm</code> to <code>processOrderProduct</code> - AST is not able to detect method name, all it sees is a string. Instant upgrade impossible and you have to do it all manually, good job!</p>
<h2 id="4-Don-t-Always-use-PSR-4">4. Don't Always use <code>PSR-4</code></h2>
<p>Classes need to be autoloaded to be parsed to AST. PSR-4 section in <code>composer.json</code> solves this easily:</p>
<pre><code class="language-json">{
    "autoload": {
        "psr-4": {
            "App\\": "src"
        }
    }
}</code></pre>
<p>Damn, now every class is easy to find and respects <code>file.php</code> → <code>Class</code> naming. <strong>How could you complicate this?</strong></p>
<h3 id="Put-more-Classes-into-1-file">Put more Classes into 1 file</h3>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

class FatalException extends Exception
{

}

class ApplicationException extends Exception
{

}

class RequestException extends Exception
{

}</code></pre>
<p>You have 1 file instead of 3 - you saved so much disk space!</p>
<h3 id="Use-Small-Case-Naming">Use Small Case Naming</h3>
<pre><code class="language-bash">/app
   /Controller
       ProductController.php</code></pre>
<p>↓</p>
<pre><code class="language-bash">/app
   /controller
       ProductController.php</code></pre>
<p>PSR-4 is unable to find this file, great job!</p>
<h3 id="Don-t-Load-Tests">Don't Load Tests</h3>
<p>Let's say your <code>/app</code> code is loaded by PSR-4. You also have covered it with tests. If you run instant upgrades, it should actually upgrade tests too. Damn.</p>
<p>If you have this section, drop it:</p>
<pre><code class="language-diff">-{
-    "autoload-dev": {
-        "psr-4": {
-            "App\\Tests\\": "tests"
-        }
-    }
-}</code></pre>
<p>PHPUnit uses its own autoload anyway.</p>
<h2 id="5-Use-Your-Own-Autoloader">5. Use Your Own Autoloader</h2>
<p>While you're at it, follow PHPUnit example. And not only PHPUnit. Have you ever wondered why there is missing <a href="https://github.com/squizlabs/PHP_CodeSniffer/blob/b53f64e10e41aa754ffa7c11999af1881e6c1780/composer.json"><code>"autoload"</code> section PHP_CodeSniffer <code>composer.json</code></a>
Make your own autoloader - using <code>spl_autoload_register</code> or <a href="https://github.com/nette/robot-loader">nette/robot-loader</a>. That way instant upgrade tools get confused and probably won't work. Good job!</p>
<h2 id="6-Hide-Your-Dependencies-in-Constructor">6. Hide Your Dependencies in Constructor</h2>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

class PackagistApi
{
    public function getPackagesByOrganization(string $organization): array
    {
        $guzzle = new Guzzle\Client();
        $response = $guzzle-&gt;get('https://packagist.org/packages/list.json?vendor=' . $organization);

        // ...

        return $packages;
    }
}

$packagistApi = new PackagistApi;
$shopsysPackages = $packagistApi-&gt;getPackagesByOrganization('shopsys');</code></pre>
<p>When you send such code a to code-review, you are provoking this comment:</p>
<ul>
<li>&quot;<code>PackagistApi</code> hides <code>Guzzle\Client</code> dependency. Put that into constructor injection&quot;</li>
</ul>
<p>Busted! But there is a way <strong>to improve your chances to make this pass</strong> and still skip constructor injection:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

class PackagistApi
{
    private $guzzle;

    public function __construct()
    {
        $this-&gt;guzzle = new Guzzle\Client();
    }

    public function getPackagesByOrganization(string $organization): array
    {
        $response = $this-&gt;guzzle-&gt;get('https://packagist.org/packages/list.json?vendor=' . $organization);

        // ...

        return $packages;
    }
}</code></pre>
<h2 id="7-Put-Different-Kinds-of-Objects-to-One-Directory">7. Put Different Kinds of Objects to One Directory</h2>
<p>Do you love DDD? Everyone loves it! Thanks to DDD you have socially accepted reason to use directory names based on categories:</p>
<pre><code class="language-bash">/app
    /Controller
        ProductController.php
    /Entity
        Product.php
    /Repository
        ProductRepository.php</code></pre>
<p>↓</p>
<pre><code class="language-bash">/app
    /Product
        ProductController.php
        Product.php
        ProductRepository.php</code></pre>
<p>Who needs standards! It's this nice? Now no-one can find any classes by expected directory name.</p>
<p>As a bonus, service auto-discovery is not possible anymore:</p>
<pre><code class="language-yaml">services:
    App\:
        resource: '../app'
        exclude: '../app/{Entity}'</code></pre>
<p>Great job!</p>
<h2 id="8-Use-Annotations-to-Define-Magic-Methods">8. Use Annotations to Define Magic Methods</h2>
<p>Now you know how to use strings in method names from tip #3. Let's get this to the next level. I've already used this tip above:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

$guzzle = new Guzzle\Client();
$guzzle-&gt;get('...');</code></pre>
<p>What happens when you type <code>get</code> method? The IDE will tell you the <code>get</code> method exists. You can adapt this pattern to your code too!</p>
<p>Then you rename it with instant upgrade tools, but it will fail. It's not a string... so what the hack?</p>
<p>It's only <a href="https://github.com/guzzle/guzzle/blob/8db1967d92f55de1b94b175478ed16a7dfc53a90/src/Client.php#L11-L24">an annotation</a>:</p>
<img src="/assets/images/posts/2018/vendor/magic-annotation.png" class="img-thumbnail">
<p>You now have a reason to add <code>__call</code> integration and combine method names with many more strings. Great job!</p>
<h2 id="9-Use-Traits-with-Annotations-to-Define-Magic-Methods">9. Use Traits with Annotations to Define Magic Methods</h2>
<p>You can take this to one more level!</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

class ApiCaller
{
   use GetMethodTrait;
}

/**
 * @method getPackagesByOrganization($organization)
 * @method getPackagesByCategory($category)
 */
trait GetMethodTrait
{
}</code></pre>
<p>Goodbye automated typehints and static analysis!</p>
<h2 id="10-Don-t-use-a-Different-Naming-to-separate-Interface-Trait-from-Class">10. Don't use a Different Naming to separate <code>Interface</code>, <code>Trait</code> from <code>Class</code></h2>
<p>Oh, I actually made a mistake. Above I wrote <code>GetMethodTrait</code>, that might actually help the user and tool to guess it's a trait:</p>
<pre><code class="language-bash">- ProductInterface
- ProductTrait
- Product</code></pre>
<p>We don't want that. Let's take another cool tip from DDD and make them look the same ↓</p>
<pre><code class="language-bash">- Product
- Product
- Product</code></pre>
<p>Now no-one can use Finder to find all traits or interface. Each file has to be parsed now and that's super slow. Good job!</p>
<h2 id="11-Use-as-Short-Naming-as-Possible">11. Use as Short Naming as Possible</h2>
<p>Long class names are annoying to read. Just compare yourself:</p>
<pre><code class="language-/ash">- YamlParser
- YamlFileParser
- LatteTemplateParser
- LatteParser
- XmlParser</code></pre>
<p>This is much better ↓</p>
<img src="/assets/images/posts/2018/vendor/omg-naming.gif" class="img-thumbnail">
<p>It also it also increases chances to bother with manual aliasing:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

use Yaml\Parser;
use Latte\Parser as LatteParser;
use Xml\Parser as XmlParser;

class ProductXmlFeedCrawler
{

}</code></pre>
<p>WTF, it's so good!</p>
<h2 id="12-Don-t-use-a-Different-Naming-to-separate-Abstract-classes">12. Don't use a Different Naming to separate <code>Abstract</code> classes</h2>
<p>Abstract classes are also classes. Why would make that easier for a reader by stating that in a name? Have you ever seen an <code>AbstractInterface</code> or <code>AbstractTrait</code>? I did not.</p>
<pre><code class="language-diff">-abstract class AbstractXmlCrawler
+abstract class XmlCrawler</code></pre>
<p>Let them look into to class manually. Time well spent!</p>
<h2 id="13-Use-Fluent-API-with-Different-Return-Values">13. Use Fluent API with Different Return Values</h2>
<p><a href="https://ocramius.github.io/blog/fluent-interfaces-are-evil">Fluent interfaces are great</a>, they save you typing the variable name all over again:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

class Definition
{
    private $class;

    private $arguments;

    public function setClass(array $class)
    {
        $this-&gt;class = $class;

        return $this;
    }

    public function setArguments(array $arguments)
    {
        $this-&gt;arguments = $arguments;

        return $this;
    }
}

$definition = (new Definition)-&gt;setClass('ProductController')
    -&gt;setArguments(['@Request']);</code></pre>
<p>The best thing is, there are more ways to create the same object:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

$definition = new Definition;
$definition-&gt;setClass('ProductController');
$definition-&gt;setArguments(['@Request']);</code></pre>
<p>How can anyone use that incorrectly now?</p>
<h2 id="14-Use-Fluent-API-with-Different-Return-Values">14. Use Fluent API with Different Return Values</h2>
<p>Let's take fluent to the next level - make every method return different object:</p>
<pre><code class="language-php">&lt;?php

// ...

$rootNode
    -&gt;beforeNormalization()
        -&gt;ifTrue(function ($v) { return !isset($v['assets']) &amp;&amp; isset($v['templating']) &amp;&amp; class_exists(Package::class); })
        -&gt;then(function ($v) {
            $v['assets'] = array();
            return $v;
        })
    -&gt;end()
    -&gt;children()
        -&gt;scalarNode('secret')-&gt;end()
        -&gt;scalarNode('http_method_override')
            -&gt;info("Set true to enable support for the '_method' request parameter to determine the intended HTTP method on POST requests. Note: When using the HttpCache, you need to call the method in your front controller instead")
            -&gt;defaultTrue()
        -&gt;end()
        -&gt;scalarNode('ide')-&gt;defaultNull()-&gt;end()
        -&gt;booleanNode('test')-&gt;end()
        -&gt;scalarNode('default_locale')-&gt;defaultValue('en')-&gt;end()
        -&gt;arrayNode('trusted_hosts')
            -&gt;beforeNormalization()-&gt;ifString()-&gt;then(function ($v) { return array($v); })-&gt;end()
            -&gt;prototype('scalar')-&gt;end()
        -&gt;end()
    -&gt;end()
;</code></pre>
<div class="text-center pb-4">
    <em>
      From <a href="https://github.com/symfony/symfony/blob/0d35f97e9b9c27df0d6317e8ae09d5b963dc2916/src/Symfony/Bundle/FrameworkBundle/DependencyInjection/Configuration.php">Symfony/FrameworkBundle configuration</a>.
    </em>
</div>
<p>Fluent API like this is <a href="https://github.com/phpstan/phpstan/issues/254">proven to break PHPStan and thus Rector</a>. Such code is almost impossible to upgrade instantly. The longer the fluent methods, the bigger the damage - great job!</p>
<p><br></p>
<p>Do you know more tips to write code that is hard to maintain and upgrade in <em>not-so-obvious</em> way? <strong>Let me know in the comment, I'll update the list with them.</strong></p>
<p><br></p>
<p>P.S.: If you love sarcastic posts like this, go check <a href="https://ocramius.github.io/blog/eliminating-visual-debt">Eliminating Visual Debt</a> by Marco Pivetta or <a href="/blog/2018/03/19/how-to-criticize-like-a-senior-programmer/">How to Criticize like a Senior Programmer</a>.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/11/26/14-tips-to-write-php-code-that-is-hard-to-maintain-and-upgrade</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 26 Nov 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/11/26/14-tips-to-write-php-code-that-is-hard-to-maintain-and-upgrade#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Test Monorepo in 3 Layers ]]></title>
                <link>https://tomasvotruba.com/blog/2018/11/22/how-to-test-monorepo-in-3-layers</link>
                <description><![CDATA[ <p>Do you have a monorepo, with 2 packages at least, autoloaded with composer and splitting works?
Good! Now you're about to set up testing and code quality tools.
<br><br>
How to make testing so tight no bug can escape?</p> ]]></description>
                <content:encoded><![CDATA[ <p>There are 3 layers you test your monorepo in. Most projects have 2 of them max.:</p>
<ul>
<li><strong>Testing Monorepo</strong> (Symfony, Sylius)</li>
<li><strong>Testing Standalone Packages in Monorepo</strong> (Symfony, Sylius)</li>
<li><strong>After Split Testing</strong></li>
</ul>
<p>I'm not sure why the last one is often skipped. Surprisingly, it's very easy to setup - a matter of single a new workflow file in <code>.github/workflows</code>.</p>
<p>Now we know the 3 testing layers. It's time to look <strong>why each particular layer is important</strong>.</p>
<h2 id="1-Testing-Monorepo">1. Testing Monorepo</h2>
<pre><code class="language-bash">/.github/workflows/...
/packages
    /first-package
    /second-package
phpunit.xml</code></pre>
<h3 id="Why-is-it-Important">Why is it Important?</h3>
<p>Monorepo is more complex than the classic package. The developers who use it needs to study more nested directories, special rules and exceptions he didn't have to before. He's already exhausted by learning all this and he's barely some energy left to contribute.</p>
<p>That's why <strong>your monorepo workflow has to be as simple as possible</strong>.</p>
<p>Testing should be as easy as:</p>
<pre><code class="language-bash">vendor/bin/phpunit</code></pre>
<p>One run and I we can see test are passing or failing. Must have.</p>
<h2 id="2-Testing-Standalone-Packages-in-Monorepo">2. Testing Standalone Packages in Monorepo</h2>
<pre><code class="language-diff"> /.github/workflows/...
 /packages
     /first-package
+        phpunit.xml
     /second-package
+        phpunit.xml
 phpunit.xml</code></pre>
<p>In this layer, each package has own PHPUnit setup. It still uses root <code>vendor/autoload.php</code>, but the testing scope is more similar to standalone package testing. If's <em>faking</em> split testing for poor people.</p>
<pre><code class="language-bash">vendor/bin/phpunit packages/first-package
vendor/bin/phpunit packages/second-package</code></pre>
<h3 id="Why-is-it-Important">Why is it Important?</h3>
<p>PHPUnit <strong>has own autoloading so it autoloads tests</strong> without relying on your <code>composer.json</code>. It's for historical reasons and also the fact, it's not standard to autoload test files or even user PSR-4 naming in them.</p>
<p><br></p>
<p>So when we run e.g. <code>vendor/bin/phpunit packages</code>, we basically tell the PHPUnit <em>autoload <code>packages</code> directory</em>.</p>
<p>What happens, when:</p>
<ul>
<li><code>packages/first-package/tests/Fixture/SomeClass.php</code> is used in test in</li>
<li><code>packages/second-package/tests/UnrelatedTest.php</code>?</li>
</ul>
<p>❌</p>
<p><strong>It will silently pass</strong>. Monorepo has many classes you work with and some test classes can be accidentally reused in another package. Your test run says it passes, even though it's broken.</p>
<p>You'll find out eventually when <code>second-package</code> is downloaded and break the code to somebody but isn't automated testing suppose to prevent that?</p>
<h2 id="3-Split-Testing">3. Split Testing</h2>
<h3 id="Why-is-it-Important">Why is it Important?</h3>
<p>This is like a double condom with birth control - the best quality testing we can get. It's <strong>almost identical with real use when programmer downloads</strong> a package by <code>packages/second-package</code>.</p>
<p>Our goal is to autoload:</p>
<ul>
<li>the second-package code in <code>packages/second-package/src</code></li>
<li>dependencies from <code>packages/second-package/composer.json</code> <strong>ONLY</strong></li>
</ul>
<p><br></p>
<p>You've figured out by now <em>the why</em> by seeing <strong>ONLY</strong>. You can't find this bug in layer 1 or 2.</p>
<p>Our first package uses Doctrine <code>packages/first-package/composer.json</code></p>
<pre><code class="language-json">{
    "name": "our-project/first-package",
    "require": {
        "php": "^7.2",
        "doctrine/orm": "^2.7"
    }
}</code></pre>
<p>At the same time, <code>second-package</code> is using the Doctrine class:</p>
<pre><code class="language-php">namespace OurProject\SecondPackage;

use Doctrine\ORM\EntityManagerInterface;

final class ProductController
{
    public function __construct(EntityManagerInterface $entityManager)
    {
    }
}</code></pre>
<p>But does <strong>not require Doctrine</strong> it in <code>composer.json</code>:</p>
<pre><code class="language-json">{
    "name": "our-project/second-package",
    "require": {
        "php": "^7.2"
    }
}</code></pre>
<p>How does the GitHub Action <strong>workflow look like exactly</strong>? Checkout <a href="/blog/2020/02/10/how-to-test-monorepo-after-split-before-actual-split/">How to Test Monorepo After Split Before Actual Split</a>.</p>
<p>That's why after split testing is so important. GitHub Action will tell us!</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/11/22/how-to-test-monorepo-in-3-layers</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 22 Nov 2018 00:00:00 +0000</pubDate>
                                    <updated>2021-02-01UTC00:00:000</updated>
                    <atom:updated>Mon, 01 Feb 2021 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Mon, 01 Feb 2021 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/11/22/how-to-test-monorepo-in-3-layers#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ When You Should Use Monorepo and When Local Packages ]]></title>
                <link>https://tomasvotruba.com/blog/2018/11/19/when-you-should-use-monorepo-and-when-local-packages</link>
                <description><![CDATA[ <p>Recently I gave <a href="/talks/#monorepo/">a few talks about monorepo in PHP</a> and how to integrate it to companies in a useful way. I'm very happy to see many people already use it and know what problems it solves.
<br><br>
Before monorepo hype takes over private PHP projects, I think <strong>you should know about its limits</strong>: When is the best time for you to go monorepo? When you gain less complexity while integrating it? How can you make the transition better? Is it really needed?</p> ]]></description>
                <content:encoded><![CDATA[ <p>Today we'll not focus on open-source projects, but <strong>rather on your private code</strong>. All from point of <strong>timing and transition</strong>. Let me show you the architecture that <a href="https://www.lekarna.cz">Lekarna.cz</a> uses to this day and how did we get there despite very chaotic start.</p>
<h3 id="1-Monolith">1. Monolith</h3>
<p>We started development in a single repository, adding features here and there. It grew, the <code>/src</code> directory had over 150 classes very soon and it became more and more cluttered. The development was coupled to one monolithic code and the architecture started to disappear from code-review focus and from the code itself. <strong>Not good.</strong></p>
<p>↓</p>
<h3 id="2-Many-Repository">2. Many-Repository</h3>
<p>So we've decided to split too many repositories. There was a repository <code>lekarna/cms</code>, <code>lekarna/shop</code>, <code>lekarna/warehouse</code> etc.</p>
<p>First, it looked cool, each with own repository, own <code>composer.json</code>. Now you can spot this <em>academic coolness</em> by <strong>focusing mostly on technical facts</strong> (e.g. each repository has own <code>composer.json</code>) rather <strong>than how it feels to use it</strong> (e.g. it really sucks to do one change in many places).</p>
<p>In every PR more energy and attention was invested in the maintenance of there many-repositories and their mutual dependencies, than to PR itself. <strong>Not good.</strong></p>
<p>↓</p>
<h3 id="3-Local-Packages">3. Local Packages</h3>
<p>We realized, we needed the code to be at one place <strong>and</strong> keep it as separate as possible. In 2014 it didn't have a name, but I came with an idea to create a <code>/packages</code> directory in our main repository and <em>pretend</em> we have repositories there. <em>Treat it like</em> one day it might be decoupled to own repository, with own dependencies and own tests. Few years later it became known as <a href="/blog/2017/12/25/composer-local-packages-for-dummies/">local packages</a>.</p>
<p>This lead new programmers to focus deeply on a single part of huge codebase at a time and also make changes the easiest way possible. <strong>We didn't have to explain them anything</strong>, the knowledge was embodied in the code. This is a <strong>golden pattern you look for</strong> in any part of business or life - you just give people smartphone and they <em>intuitively know</em> what to do.</p>
<p>↓</p>
<h3 id="4-Open-Sourced-Monorepo">4. Open-Sourced Monorepo</h3>
<p>This next step can be used to build a community to fuel your code-base. It's a state when your <strong>need a feedback from the community to push the quality further</strong> and also turning that code to a product for others. That's what happened to all companies that were private in the start - Symfony, Sylius or Shopsys.</p>
<p>But this was not a step for Lekarna.cz code-base. It has no such ambitions and it doesn't make sense. You don't have to do everything you can, just because you can.</p>
<p><br></p>
<p>So do <em>local packages</em> have meaning? <strong>Yes, they do</strong>, because their purpose is not to become an open-source monorepo company, but to make your private/public code as easy to work with as possible while it grows. In short: <strong>to enjoy coding in very large code-bases.</strong></p>
<p><br></p>
<h2 id="When-You-Should-Evolve">When You Should Evolve?</h2>
<p>As you can see, we had to make many costly transitions. Switching from monolith to many-repo and then to local packages is no cheap fun.</p>
<p>The rule that guides a <strong>good transition</strong> is:</p>
<blockquote class="blockquote text-center">
    Value after transition &gt; Cost lost by transition
</blockquote>
<p>E.g. if your project is 20 % easier to contribute, but it costs 50 % of your team energy on learning new technologies, fixing regression bugs or not believing in it, it's not worth it.</p>
<p>As future is unclear and hindsight is always 20/20, these numbers are not easy to establish before you do any real change. <strong>So how to decide?</strong> You can see the code <strong>is maturing and is ready to evolution jump</strong>. If we take a broader picture and look at PHP frameworks, in the last 5 years there is a big evolution jump from service locators to constructor injection. Do you want a more recent example? Weak typing to strict typing.</p>
<p>You just feel it. It's not an easy skill to build but <strong>the more and more you develop and make transitions, the more you'll improve this skill and your success rate</strong>. You'll get there by trying, believe in yourself and learn from mistakes. How crazy this might sound, the more mistakes you make, the faster you learn.</p>
<p><br></p>
<h2 id="When-Monorepo-Makes-sense-For-Private-Projects">When Monorepo Makes sense For Private Projects?</h2>
<p>I was asked this question at <a href="https://www.hubbr.cz/udalosti/events/developer-day-2018">Developer Day 2018</a> (amazing event by amazing brothers duo). To answer completely: if I were you, I'd <strong>start every project with local packages by default</strong>. You never ever have to jump to monorepo nor open-source, but you make any future possible transition very cheap. Very!</p>
<p>All it costs you is to learn what local packages are how to work with them. Too busy to learn? Just <a href="/contact">give me a call</a> and I'll explain it to you.</p>
<p>Because one day, you might see one of obvious <strong>reasons to go monorepo</strong>:</p>
<ol>
<li>Your product becomes useful to others</li>
<li>Your component becomes useful to others</li>
<li>You develop <strong>multiple-projects with the same code base</strong>, e.g. 5 projects running on Symfony 4.1</li>
<li>You develop the <strong>single project for multiple clients</strong>, e.g. one e-commerce platform for 10 customers</li>
</ol>
<p>And we're still in privates here.</p>
<p>But these <strong>reasons never have to come</strong>, so just going monorepo blindly from the start might actually hurt your development.</p>
<p><br></p>
<p>Happy evolving!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/11/19/when-you-should-use-monorepo-and-when-local-packages</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 19 Nov 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/11/19/when-you-should-use-monorepo-and-when-local-packages#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Get PHP 7.4 Typed Properties to Your Code in Few Seconds ]]></title>
                <link>https://tomasvotruba.com/blog/2018/11/15/how-to-get-php-74-typed-properties-to-your-code-in-few-seconds</link>
                <description><![CDATA[ <p>PHP 5.6 and 7.0 is going to be dangerous <a href="http://php.net/supported-versions.php">since 2019</a>, PHP 7.1 is new baseline and PHP 7.3 is just about to be released in the end of 2018.
<br><br>
Is this <strong>the best time to upgrade your code to PHP 7.4</strong>?</p> ]]></description>
                <content:encoded><![CDATA[ <p>Yes, because PHP 7.4 was released 2 years ago.</p>
<h2 id="Can-at-var-Annotations-be-Useful">Can <code>@var</code> Annotations be Useful?</h2>
<p>Annotations were always in the bottom, ashamed and not considered a <em>real code</em>. They help us to guess the type of the property. Not only to us, but also to <a href="/blog/2018/10/22/brief-history-of-tools-watching-and-changing-your-php-code/#2-static-analysis-tools">static analysis tools</a>.</p>
<pre><code class="language-php">final class SomeClass
{
   /**
    * @var int
    */
   private $count;
}</code></pre>
<p>Here we can see that <code>$count</code> is an <code>int</code> number.</p>
<p><strong>In PHP 7.4</strong> we could change this code to get a <a href="https://wiki.php.net/rfc/typed_properties_v2">strict typing</a>:</p>
<pre><code class="language-diff"> &lt;?php declare(strict_types=1);

 final class SomeClass
 {
-   /**
-    * @var int
-    */
-   private $count;
+   private int $count;
 }</code></pre>
<p>When you write <code>@var</code> annotation today, you'll be preparing your code for future refactoring. You might laugh now: &quot;everyone is doing that today, why do you even write about this obvious standard&quot;.</p>
<p>Well, not everyone...</p>
<div class="text-center">
    <img src="/assets/images/posts/2018/php74-typed/symfony-lacking.png" class="img-thumbnail">
    <p>This is my favorite class to extend in whole Symfony - a <a href="https://github.com/symfony/symfony/blob/dbf053bc854f6768ddcd8ed39f7cbb2c21e500e6/src/Symfony/Component/Console/Command/Command.php#L37-L51"><code>Command</code> class</a>.
</p></div>
<p>This is Symfony 4.2 (dev) we're talking about with PHP 7.1+. Lot's of Symfony code is <del>weakly</del> <em>not</em> typed, but that's not the biggest problem.</p>
<h2 id="and-quot-My-favorite-framework-Uses-It-It-must-be-the-Best-Practise-in-PHP-and-quot">&quot;<em>My-favorite-framework</em> Uses It, It must be the Best Practise in PHP!&quot;</h2>
<p>The problem is <em>framework-way</em> approach to learning PHP. Many developers I've met <strong>think their framework uses the best practices of the PHP itself</strong>. Why? <strong>Have you ever tried to learn some other PHP framework than the one you're using today?</strong> I mean learn, not just try on the workshop, during the weekend, but to really build a big application with it.</p>
<p>Saying that, <strong>many developers adopt Symfony practices thinking <em>it the best form of PHP there is</em></strong>. There's no place to blame developers, it's just how society works - with <em>observational learning</em>. We should not blame Symfony either since there is no <em>code quality engineer</em>, who would push <em>non-feature</em> code changes. Unfortunately, Symfony team itself is strictly against these changes as you can see in PR comments.</p>
<p>Recently I'm very happy to see these engineers around me - <a href="https://www.lmc.eu">LMC</a> to name one for all.</p>
<h2 id="Visualize-Future-Compatibility">Visualize Future Compatibility</h2>
<p>When you code, think about the way to write <strong><em>future compatible</em> code</strong>. What is happening in PHP for the last 2-3 years? Type hints, ?nullables, <code>void</code>, AST and static analysis suggest, there is more coming. I wouldn't be surprised if these annotations turn out to be useful in pure PHP one day:</p>
<pre><code class="language-php">&lt;?php

final class SomeClass
{
    /**
     * @var int
     */
    private const NUMBER = 5;

    /**
     * @var Product[]
     */
    private $products = [];
}</code></pre>
<p>In PHP 8 or 9 this might come:</p>
<pre><code class="language-diff"> &lt;?php declare(strict_types=1);

 final class SomeClass
 {
-    /**
-     * @var int
-     */
-    private const NUMBER = 5;
+    private const int NUMBER = 5;

-    /**
-     * @var Product[]
-     */
-    private $products = [];
+    private Product[] $products = [];
}</code></pre>
<p>In <a href="/blog/2018/10/18/how-i-almost-missed-my-talk-in-php-asia-conference/">PHP Asia</a>, <em>typed arrays</em> was the most desired feature in next versions of PHP. So were <em>typed properties</em> once and so were <em>strict types</em> before them. In 2015 we would only dream about those 2, now one is part of our every-day life, second coming soon.</p>
<h2 id="and-quot-in-Seconds-and-quot">&quot;...in Seconds&quot;</h2>
<p>Yeah, right, I made a promise - I'll get back to nearer future with <em>typed properties</em>.</p>
<p>Let's say we're thinking about the future and adding all <code>@var</code> annotations we can. Is that enough? You'd still have to do these diffs manually:</p>
<pre><code class="language-diff"> &lt;?php declare(strict_types=1);

 final class SomeClass
 {
-    /**
-     * @var boolean
-     */
-    public $a;
+    public bool $a;

     /**
-     * @var bool
      * another comment
      */
-    private $b = false;
+    private bool $b = false;

     /**
      * @var callable
      */
     private $c;

-    /**
-     * @var AnotherClass|null
-     */
-    private $d = null;
+    private ?AnotherClass $d = null;

     /**
      * @var int
      */
     public $e = 'string';
}</code></pre>
<p>Or you could <strong>be actually rewarded for your daunting <code>@var</code> work</strong>. Good news! Rector handles this for you.</p>
<h2 id="3-Steps-to-Add-Typed-Properties-to-your-code-With-Rector">3 Steps to Add Typed Properties to your code With Rector</h2>
<ol>
<li>Install Rector</li>
</ol>
<pre><code class="language-bash">composer require rector/rector --dev</code></pre>
<ol start="2">
<li>Add <code>rector.php</code> config with <code>TypedPropertyRector</code> Rule</li>
</ol>
<pre><code class="language-php">use Rector\Php74\Rector\Property\TypedPropertyRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;ruleWithConfiguration(TypedPropertyRector::class, [
        TypedPropertyRector::INLINE_PUBLIC =&gt; true,
    ]);
};</code></pre>
<ol start="3">
<li>Run Rector</li>
</ol>
<pre><code class="language-bash">vendor/bin/rector process src</code></pre>
<p><br></p>
<p>I started this post to show how Rector helps with huge refactorings like <code>@var</code> annotations to types that are about to come next year. But the message is far being that - observing trends, seeing the future and working towards that.</p>
<h2 id="How-To-Make-Your-Future-Self-Happy">How To Make Your Future-Self Happy?</h2>
<ul>
<li><strong>write <code>@var</code> above each property</strong></li>
<li>write <code>@var</code> or any other <code>@value</code> info <strong>above each constant</strong></li>
<li><strong>write <code>@var Type[]</code> above each array property</strong>
<ul>
<li>not <code>mixed</code>, not <code>object</code>, but scalar or specific class or interface</li>
</ul></li>
<li>think about rules in your code that you've <strong>non-critically copy-pasted from the framework</strong></li>
</ul>
<p>You're saving work to yourself, to your colleagues and to tools like Rector, that will do the work for you. If you're ready...</p>
<p><br></p>
<p>Do you have some own future compatibility tips you use in your code today? I'd love to hear them ↓</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/11/15/how-to-get-php-74-typed-properties-to-your-code-in-few-seconds</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 15 Nov 2018 00:00:00 +0000</pubDate>
                                    <updated>2020-11-01UTC00:00:000</updated>
                    <atom:updated>Sun, 01 Nov 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sun, 01 Nov 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/11/15/how-to-get-php-74-typed-properties-to-your-code-in-few-seconds#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Will Autowired Arrays Finally Deprecate Tags in Symfony and Nette? ]]></title>
                <link>https://tomasvotruba.com/blog/2018/11/12/will-autowired-arrays-finally-deprecate-tags-in-symfony-and-nette</link>
                <description><![CDATA[ <p>To be clear: we talk about those tags that only have a name. No priority, no level, no event name, nothing, <strong>just the name</strong>. If you're not sure why these tags are bad, read <em><a href="/blog/2017/02/12/drop-all-service-tags-in-your-nette-and-symfony-applications/">Drop all Service Tags in Your Nette and Symfony Applications</a></em> first.
<br>
<br>
I'm very happy to see that collectors are getting to the core of DI components of PHP frameworks. Tags, extensions, compiler passes and <code>autoconfigure</code> now became workarounds. Collectors are now in the best place they can... <strong>the PHP code</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Let's say we need to build a tool for releasing a new version of the open-source package. Something like what I use for
<a href="https://github.com/symplify/monorepobuilder">Symplify and Rector releases</a>, <strong>but better</strong>.</p>
<p>You want it to be <em>open for extension and closed for modification</em>. How do we do that?</p>
<p>You introduce and a <code>ReleaseWorkerInterface</code>:</p>
<pre><code class="language-php">namespace Moses\ReleaseWorker;

interface ReleaseWorkerInterface
{
    public function work(string $version): void;
}</code></pre>
<p>Good, now if anyone wants to extend it, they' just create a new service:</p>
<pre><code class="language-php">namespace Moses\ReleaseWorker;

use Nette\Utils\Strings;

final class CheckBlogHasReleasePostReleaseWorker implements ReleaseWorkerInterface
{
    public function work(string $version): void
    {
        $blogContent = file_get_contents('https://tomasvotruba.com');

        // is there a post with this title?
        if (Strings::match($blogContent, '#Release of ' . $version . '#')) {
            // good
            echo 'Good job! The blog post was released.';
            // early return
            return;
        }

        // bad
        throw new DoThisFirstException(sprintf('Write release post about "%s" version first', $version));
    }
}</code></pre>
<p>and register it</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();
    $services-&gt;set(Moses\ReleaseWorker\CheckBlogHasReleasePostReleaseWorker::class);
};</code></pre>
<h2 id="Find-all-the-ReleaseWorkerInterface">Find all the <code>ReleaseWorkerInterface</code>?</h2>
<p>Note: I'll be mixing Nette | Symfony syntax now, but they're almost identical in DI component, so just imagine it's your favorite framework.</p>
<p>How can we get all the services that implement <code>ReleaseWorkerInterface</code>?</p>
<h3 id="1-Tags">1. Tags!</h3>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();
    $services-&gt;set(Moses\ReleaseWorker\CheckBlogHasReleasePostReleaseWorker::class)
        -&gt;tag('release_worker');
};</code></pre>
<p>In extension/compiler pass:</p>
<pre><code class="language-php">$mosesDefinition = $containerBuilder-&gt;getDefinition(Moses::class);

foreach ($containerBuilder-&gt;findByTags('release_worker') as $workerDefinition) {
   $mosesDefinition-&gt;addCall('addWorker', [$workerDefinition-&gt;getName()]);
}</code></pre>
<p>This is what we would do in 2010. <strong>This brings <a href="/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock/">memory-lock</a> on tag name and disables common sense</strong>. And we need common sense to create usable code.</p>
<p>What's the next option we have?</p>
<h3 id="2-byType-methods">2. <code>byType()</code> methods</h3>
<p>In extension/compiler pass:</p>
<pre><code class="language-php">$mosesDefinition = $containerBuilder-&gt;getDefinition(Moses::class);

foreach ($containerBuilder-&gt;findByType(ReleaseWorkerInterface::class) as $workerDefinition) {
   $mosesDefinition-&gt;addCall('addWorker', [$workerDefinition-&gt;getName()]);
}</code></pre>
<p>This drops memory-lock, good. But <strong>we still have to go to extension/compiler-pass</strong>, lands that are visited by fractions of framework-users.</p>
<p>What about something &quot;2018&quot;?</p>
<h3 id="3-Autowired-Arrays">3. Autowired Arrays</h3>
<p>All options above hides a contract. Which one? The <code>Moses</code> class looks like this:</p>
<pre><code class="language-php">final class Moses
{
    // property + setter

    public function release(string $version)
    {
        foreach ($this-&gt;releaseWorkers as $releaseWorker) {
            $releaseWorker-&gt;work($version);
        }
    }
}</code></pre>
<p>What is wrong with this contract? Have you noticed the constructor? Me neither, <strong>it's not there!</strong> It needs at least some release workers, it's useless without it, but we lie about this contract:</p>
<pre><code class="language-php">$moses = new Moses\Moses;
$moses-&gt;release('v5.0.0');

// nothing
// ...
// WTF?</code></pre>
<p>We already know that <strong>public properties, setters, and drugs are bad</strong>. <strong>Missing constructor contract and sniffing dependency somewhere else by setters - not good either</strong>. Moreover when your other classes keep that contract. What's the point of rules in your code then?</p>
<h3 id="Success-is-Given-to-Reliable-People">Success is Given to Reliable People</h3>
<p>We should make a design that is reliable.</p>
<ul>
<li>Do you need these services? Tell us in the constructor.</li>
<li>Do you need all <code>ReleaseWorkerInterface</code>s? <strong>Tell us in the constructor.</strong></li>
</ul>
<pre><code class="language-php">$releaseWorkers = [
    new Moses\ReleaseWorker\CheckBlogHasReleasePostReleaseWorker,
];

$moses = new Moses\Moses($releaseWorkers);</code></pre>
<p>Now when we call the service, <strong>we can actually see some output</strong>:</p>
<pre><code class="language-php">$moses-&gt;release('v5.0.0');

// "Good job! The blog post was released."
// ...
// Thanks!</code></pre>
<p>Sound nice, right? Is that even possible? Without that, we could drop tags, the compiler passes, YAML/Neon stringly-typed configuration, anti-conception... The world would finally make sense again!</p>
<blockquote class="blockquote text-center">
    "Vision over Expectations."
</blockquote>
<p>It sounds really nice. But how would that work in PHP? How does container now what we need in the constructor. Yes, Mr. Potter?</p>
<pre><code class="language-php">namespace Moses;

use Moses\ReleaseWorker\ReleaseWorkerInterface;

final class Moses
{
    /**
     * @param ReleaseWorkerInterface[] $releaseWorkers
     */
    public function __construct(array $releaseWorkers)
    {
    }
}</code></pre>
<p>No need for magic. <strong>Just use typehint in annotation</strong>.</p>
<p><br></p>
<p>Typehint in the annotation. It's that simple.</p>
<h2 id="When-Can-I-use-That">When Can I use That <my-favorite-framework>?</h2>
<p>I have no idea.</p>
<p>But you can <strong>install it today</strong>:</p>
<ul>
<li>with <code>"nette/di": "v3.0"</code> with <a href="https://github.com/nette/di/pull/178">this feature enabled in the core</a></li>
<li>and <a href="https://github.com/symplify/autowire-array-parameter"><code>symplify/autowire-array-parameter</code></a></li>
</ul>
<h2 id="Does-it-Work">Does it Work?</h2>
<p>Yes, for the cases above it's 1:1 substitution with 0-configuration. It's part of <a href="https://github.com/symplify/symplify/pull/1145/files">Symplify since 5.1</a> and it works flawlessly.</p>
<p><br></p>
<p>And why <em>Moses</em>? Well, he <em>released</em> thousands of people from slavery :)</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/11/12/will-autowired-arrays-finally-deprecate-tags-in-symfony-and-nette</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 12 Nov 2018 00:00:00 +0000</pubDate>
                                    <updated>2021-02-01UTC00:00:000</updated>
                    <atom:updated>Mon, 01 Feb 2021 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Mon, 01 Feb 2021 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/11/12/will-autowired-arrays-finally-deprecate-tags-in-symfony-and-nette#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Fatal error: Uncaught Error: [] operator not supported for strings in ]]></title>
                <link>https://tomasvotruba.com/blog/2018/11/08/fatal-error-uncaught-error-operator-not-supported-for-strings-in</link>
                <description><![CDATA[ <p>That's right! PHP 5.6 and 7.0 are entering EOL - end of <del>line</del> life this December. Social networks, Slacks, Twitter, Reddit are <a href="https://www.reddit.com/r/PHP/comments/9syr3m/php_56_eol_end_of_life_end_of_2018_and_php_7">full</a> of it. Are you running PHP 7.1? Good, come next year when PHP 7.1 is <em>eoling</em>.
<br><br>
For the rest of you, what will you do when PHP will tell you the message in the title?</p> ]]></description>
                <content:encoded><![CDATA[ <div class="text-center">
    <img src="/assets/images/posts/2018/upgrade-php/important.png" class="img-thumbnail">
    <p>The most important info from <a href="http://php.net/supported-versions.php">PHP.net</a> nowadays</p>
</div>
<p><br></p>
<p>You see all this social boom, your boss is scared by &quot;no security support&quot; and <strong>you finally have a <em>go</em> to upgrade your PHP code</strong> to PHP 7.1. You upgrade your PHP locally to see if everything works:</p>
<pre><code class="language-bash">"Warning: count(): Parameter must be an array or an object that implements Countable in"</code></pre>
<pre><code class="language-bash">"Fatal error: Uncaught Error: [] operator not supported for strings in"</code></pre>
<pre><code class="language-bash">"Deprecated: Methods with the same name as their class will not be constructors in a future version of PHP; Filter has a deprecated constructor in"</code></pre>
<pre><code class="language-bash">"Fatal error: Uncaught Error: Call to undefined function ereg() in"</code></pre>
<pre><code class="language-bash">"Fatal error: Cannot use empty list in"</code></pre>
<p><br></p>
<p>You're probably thinking <em>lets jump to PHP 7.2, while you're at it</em>:</p>
<pre><code class="language-bash">"Deprecated: The each() function is deprecated. This message will be suppressed on further calls in"</code></pre>
<p>Don't do it, <strong>always jump by minor versions</strong> - for both PHP and packages.</p>
<p><br></p>
<p>Actually, when you see a message - that's a good sign. How else would you notice this?</p>
<pre><code class="language-php">// PHP 5.6-
list($a[], $a[]) = [1, 2];

// to get same result in PHP 7.0+
list($a[], $a[]) = array_reverse([1, 2])</code></pre>
<p>True story - see <a href="https://3v4l.org/H1hfA">3v4l.org</a>. The nice silent error just for you!</p>
<img src="/assets/images/posts/2018/upgrade-php/swap.png" class="img-thumbnail">
<h2 id="and-quot-I-Got-This-and-quot">&quot;I Got This&quot;</h2>
<p>But let's say you know that &quot;Deprecated: The each() function is deprecated. This message will be suppressed on further calls in&quot; means <strong>refactor <em>each</em> <code>each()</code> usage to <code>foreach()</code>.</strong></p>
<p>(Often it's more complicated, but keep this simple for now.)</p>
<p>Some cases are easy, if your <strong>variables are well-named</strong>:</p>
<pre><code class="language-php">while (list($key, $callback) = each($callbacks)) {
    // ...
}</code></pre>
<p>↓</p>
<pre><code class="language-php">foreach ($callbacks as $key =&gt; $callback) {
    // ...
}</code></pre>
<p><br></p>
<p>But some... how would you change this one?</p>
<pre><code class="language-php">while (list($callback) = each($callbacks)) {
    // ...
}</code></pre>
<p>↓</p>
<pre><code class="language-php">foreach ($callbacks as $callback) {
    // ...
}</code></pre>
<p>Are you sure? I think it should be like this:</p>
<pre><code class="language-php">foreach (array_keys($callbacks) as $callback) {
    // ...
}</code></pre>
<p><a href="https://github.com/rectorphp/rector/pull/661/" class="btn btn-dark btn-sm">
See pull-request #661
</a></p>
<p><strong>Honestly, I'm not sure either.</strong> But I took time to test all possible <code>each()</code> combinations with <code>list()</code>, <code>while()</code> and <code>do/while</code>, put them into awesome <a href="https://3v4l.org">3v4l.org</a>, wrote a bunch of tests and wrote tested rules for Rector.</p>
<p><br></p>
<pre><code class="language-bash">"Fatal error: Uncaught Error: Call to undefined function ereg() in"</code></pre>
<h2 id="How-Rector-got-into-pure-PHP-Upgrades">How Rector got into pure PHP Upgrades</h2>
<p>At the <a href="/blog/2018/10/18/how-i-almost-missed-my-talk-in-php-asia-conference/">PHP Asia Conference</a> Rasmus Lerdorf spoke about <strong>upgrading PHP as a big problem</strong>. Much bigger than upgrading particular frameworks. Many WTF namings in PHP are just for BC sake. I struck me, that there is much more legacy PHP code in every company than there is framework-bound code.</p>
<p>I instantly created an issue at Rector, that deals with <a href="https://github.com/rectorphp/rector/issues/638">PHP 5.3 to 7.4 upgrades</a>.
I went full-time on writing PHP upgrade rules - in the train, in the buss, in the plane (the best place to code actually, wonder why).</p>
<p><br></p>
<p class="bigger">
   <strong>Today I'm proud to announce 7 new Rector levels</strong> that were not here a month ago:
</p>
<pre><code class="language-php">use Rector\Core\Configuration\Option;
use Rector\Set\ValueObject\SetList;
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;sets([
        SetList::PHP_54,
        SetList::PHP_55,
        SetList::PHP_56,
        SetList::PHP_70,
        SetList::PHP_71,
        SetList::PHP_72,
        SetList::PHP_73,
        SetList::PHP_74,
    ]);
};</code></pre>
<p><br></p>
<p>I finally looked over my small framework bubble and <strong>learned a lot about problems of the <a href="https://friendsofphp.org">world PHP community</a></strong>.</p>
<h3 id="How-to-ereg-Correctly">How to <em>ereg</em> Correctly?</h3>
<p>One example for all:</p>
<p><a href="https://github.com/rectorphp/rector/pull/661/" class="btn btn-dark btn-sm">
See pull-request #661
</a></p>
<pre><code class="language-bash">"Fatal error: Uncaught Error: Call to undefined function ereg() in"</code></pre>
<p>That's easy, just add <code>#</code> around and change the function name, right?</p>
<pre><code class="language-diff">-ereg('hi', $string);
+preg_match('#hi#', $string);</code></pre>
<p>But what about?</p>
<pre><code class="language-php">ereg('[]-z]', $string);
ereg('^[a-z]+[.,][a-z]{3,}$', $string);</code></pre>
<p>Don't reinvent the wheel! Did you know that 8 years ago some guy <a href="https://gist.github.com/lifthrasiir/704754/7e486f43e62fd1c9d3669330c251f8ca4a59a3f8">wrote ereg → preg patterns converter</a>? That <em>some guy</em> is Kang Seonghoon and helped hundreds if not thousands of people <em>to not to give a fuck</em>. Including me. <strong>Amazing work</strong> and I learned about it just by accidental googling. I wonder how many hidden gems are out there.</p>
<h2 id="Harder-Better-Faster-Stronger-PHP-Community">Harder, Better, Faster, Stronger... PHP Community</h2>
<p>Take the Rector out, run it on your code, let it fix what it can and <strong>report the rest you had to do manually in the issues</strong>. Maybe it can be automated.
You'll be helping each other developer, who upgrades the same PHP version you did. Imagine PHP version 5.3 would be shipped with set like this, covering 100 % of all changes. It's up to us to make a brighter future now.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/11/08/fatal-error-uncaught-error-operator-not-supported-for-strings-in</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 08 Nov 2018 00:00:00 +0000</pubDate>
                                    <updated>2020-11-01UTC00:00:000</updated>
                    <atom:updated>Sun, 01 Nov 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sun, 01 Nov 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/11/08/fatal-error-uncaught-error-operator-not-supported-for-strings-in#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Do you Autowire Services in Symfony? You can Autowire Parameters Too ]]></title>
                <link>https://tomasvotruba.com/blog/2018/11/05/do-you-autowire-services-in-symfony-you-can-autowire-parameters-too</link>
                <description><![CDATA[ <p>I love how Symfony caught up late autowiring integration in since Symfony 2.8. Then set a trend in Symfony 3.3 with service autoregistration.
<br><br>
That opens new possibilities to <strong>almost config-less registration</strong>, doesn't it?</p> ]]></description>
                <content:encoded><![CDATA[ <p>Do you still have these old-school Symfony 2.7- configs?</p>
<pre><code class="language-yaml"># services.yml
services:
    first_service:
        class: 'OpenProject\FirstClass'

    second_service:
        class: 'OpenProject\SecondClass'
        arguments:
            - '@first_service'</code></pre>
<p>You have to <strong>register</strong> every service manually and <strong>set service arguments</strong> manually.</p>
<p>Honestly, I envy you. I can't imagine more wet PHP dream than refactoring to autowiring.</p>
<p><br></p>
<p>Are running on a newer Symfony? You'll be more familiar with this syntax:</p>
<pre><code class="language-yaml"># services.yml
services:
    OpenProject\FirstClass: ~

    OpenProject\SecondClass:
        arguments:
            - '@OpenProject\FirstClass'</code></pre>
<p>...or even...</p>
<pre><code class="language-yaml"># services.yml
services:
    _defaults:
        autowire: true

    OpenProject\FirstClass: ~
    OpenProject\SecondClass: ~</code></pre>
<p>...or even on the final one - <a href="/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3/">autodiscovery</a>:</p>
<pre><code class="language-yaml"># services.yml
services:
    _defaults:
        autowire: true

    OpenProject\:
        resource: "../src"</code></pre>
<p>This allows you to forget, that you actually have any config with services.</p>
<p>Why? Because <strong>creating and using new service</strong> = creating a PHP class. No YAML, no XML, no <em>whatever</em> <a href="/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock/">memory-locking</a> configuration.</p>
<p><br></p>
<p>Programmers used DI containers, config was getting into the shape of Miss World, autowiring and autodiscovery became status-quo and life was good.</p>
<p>Suddenly...</p>
<h2 id="You-Want-to-Use-Parameters">...You Want to Use Parameters</h2>
<p>No problem! Since you already know <a href="/blog/2018/01/22/how-to-get-parameter-in-symfony-controller-the-clean-way/">the clean-way</a>, you'll use constructor:</p>
<pre><code class="language-php">&lt;?php

namespace OpenProject;

class FirstClass
{
    public function __construct(string $apiKey)
    {
        // ...
    }
}</code></pre>
<p>And add parameter values to config:</p>
<pre><code class="language-yaml">parameters:
    api_key: "asdf"</code></pre>
<p>How do we get those parameters in there?</p>
<pre><code class="language-diff"> services:
     _defaults:
         autowire: true

     OpenProject\:
         resource: "../src"
+
+    OpenProject\FirstClass:
+        arguments:
+             - "%api_key%"</code></pre>
<p>It's that simple! <em>Just kidding.</em></p>
<p>Symfony guys realized this needs to follow innovations as service registration did.</p>
<pre><code class="language-diff"> services:
     _defaults:
         autowire: true
+    bind:
+        $apiKey: "%api_key%"

     OpenProject\:
         resource: "../src"</code></pre>
<p>Not bad, at least compared to the previous solution.</p>
<table class="table table-bordered table-responsive mt-4 mb-4">
    <thead class="thead-inverse">
        <tr>
            <th class="w-25">New Service?</th>
            <th class="w-50">New Parameter?</th>
        </tr>
    </thead>
    <tr>
        <td>
            <ul>
                <li>create a PHP class</li>
                <li>require it in the constructor</li>
            </ul>
        </td>
        <td>
            <ul>
                <li>create a parameter</li>
                <li>require it in the constructor</li>
                <li class="text-danger">bind it in config</li>
                <li class="text-danger">bind it in every config where it is required by service</li>
                <li class="text-danger">also, remove it from every config where it's not used anymore - otherwise you'll get nice Symfony exception</li>
            </ul>
        </td>
    </tr>
</table>
<p>It's that simple! <em>Just kidding, again.</em></p>
<h2 id="Autowired-Parameters-in-Symfony">Autowired Parameters in Symfony</h2>
<blockquote class="blockquote text-center mt-5 mb-5">
    If services are autowired by unique type,<br>
    parameters can be autowired by <strong>unique name</strong>.
</blockquote>
<p>You don't need this:</p>
<pre><code class="language-diff"> services:
     _defaults:
         autowire: true
-    bind:
-        $apiKey: "%api_key%"

     OpenProject\:
         resource: "../src"</code></pre>
<p>All you need is... <em>love</em>... and to:</p>
<ul>
<li>create a parameter</li>
</ul>
<pre><code class="language-yaml">parameters:
    api_key: "asdf"</code></pre>
<ul>
<li>require it in the constructor</li>
</ul>
<pre><code class="language-php">&lt;?php

namespace OpenProject;

class FirstClass
{
    public function __construct(string $apiKey)
    {
        // ...
    }
}</code></pre>
<p>That's all folks!</p>
<p><br></p>
<h3 id="Convention-over-Configuration">Convention over Configuration</h3>
<p>If you can <a href="https://simple.wikipedia.org/wiki/Occam%27s_razor">shave off 2 almost identical approaches</a> - <em>element autowiring</em> - <strong>to single 1, do it</strong>.</p>
<p>By respecting the naming <code>%param%</code> = <code>$param</code> your code is consistent with services,<br>
where <code>Type</code> = <code>$type</code> and clean and easy to read.</p>
<p><br></p>
<p>I got bad news - this is not part of Symfony - yet. But neither was autowiring for 8 years until it was.</p>
<p><strong>In the meantime, <a href="https://github.com/symplify/package-builder#autobind-parameters">register</a> <code>Symplify\PackageBuilder\DependencyInjection\CompilerPass\AutoBindParametersCompilerPass</code>.</strong></p>
<p>You don't know how? <a href="https://symfony.com/doc/current/service_container/compiler_passes.html">See Symfony docs</a>.</p>
<p><br></p>
<h2 id="How-Far-Can-We-Push-Autowiring-Together">How Far Can We Push Autowiring Together?</h2>
<p>What about array-typed autowiring?</p>
<pre><code class="language-php">&lt;?php

class SomeClass
{
    /**
     * @param CollectedType[] $collectedClasses
     */
    public function __construct(array $collectedClasses)
    {
        // ...
    }
}</code></pre>
<p>✅ &nbsp;Done for <a href="https://github.com/symplify/symplify/pull/1145">Symfony 3.4+</a> and in <a href="https://github.com/nette/di/pull/178">Nette 3.0</a>.</p>
<p><br></p>
<p>Or...?</p>
<p><em>(Place your crazy ideas below ↓)</em></p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/11/05/do-you-autowire-services-in-symfony-you-can-autowire-parameters-too</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 05 Nov 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/11/05/do-you-autowire-services-in-symfony-you-can-autowire-parameters-too#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Teach Your Team Private Method Sorting in 3 mins ]]></title>
                <link>https://tomasvotruba.com/blog/2018/11/01/how-teach-your-team-private-method-sorting-in-3-mins</link>
                <description><![CDATA[ <p>When I started PHP in 2004, all you had to do is to learn a few functions to become the most senior dev in your town. Nowadays, devs have to learn a framework, IDE and coding patterns to get at least to an average level. <br><br> Instead of reading 346 pages of <a href="https://www.amazon.com/Clean-Code-Handbook-Software-Craftsmanship/dp/0132350882">Clean Code</a>, you need to produce code and learn as you read it at the same time. <strong>There will be never less information than it is today.</strong> <br><br> That's why effective learning is a killer skill. <strong>Today we learn how to sort private methods in 2 mins</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Why-is-Private-Method-Order-so-Important">Why is Private Method Order so Important?</h2>
<p>This simple class is in your code now:</p>
<pre><code class="language-php">&lt;?php

class SomeClass
{
    public function run()
    {
        $this-&gt;call1();
        $this-&gt;call2();
    }

    private function call3()
    {
    }

    private function call2()
    {
    }

    private function call1()
    {
        $this-&gt;call3();
    }
}</code></pre>
<p>Thanks to Gregor Harlan, there is a coding standard <code>OrderedClassElementsFixer</code>, that already takes care about <code>public</code>/<code>protected</code>/<code>private</code> elements order.</p>
<p>But what about these <strong>private methods</strong> - are they ok for you?</p>
<p><br></p>
<p>When you read such a code for the firs time, you might think:</p>
<ul>
<li><code>private function call3()</code> - ah, it does this and that... but wait, <strong>who is using it?</strong></li>
<li><code>private function call2()</code> - it does this and that, it was called in <code>run()</code> method</li>
<li><code>private function call1()</code> - it does this and... the <code>call3()</code> is used here, yes... <strong>what it actually did?</strong></li>
</ul>
<blockquote class="blockquote text-center mt-5 mb-5">
    <p>
        "Be able to read down the file from top to bottom like a newspaper article,<br>
    which would naturally suggest that <strong>helper methods appear after the methods they are helping</strong>.<br>
    This would lead to maximum readability of the code structure."
    </p>
    <footer class="blockquote-footer text-right">
        <a href="https://softwareengineering.stackexchange.com/a/186421/148956">Anthony Pegram</a>, Clean Code reader
    </footer>
</blockquote>
<h2 id="Nice-Theory-Bro-but-Real-Life">Nice Theory, Bro, but... Real-Life?</h2>
<p>It's easy to spot and correct the example above...</p>
<pre><code class="language-php">&lt;?php

class SomeClass
{
    public function run()
    {
        $this-&gt;call1();
        $this-&gt;call2();
    }

    private function call1()
    {
        $this-&gt;call3();
    }

    private function call2()
    {
    }

    private function call3()
    {
    }
}</code></pre>
<p>...but in real life pull-requests are usually longer than 20 lines:</p>
<div class="text-center mb-5">
    <img src="/assets/images/posts/2018/private-method-order/example.png" class="img-thumbnail">

    <p>
        Taken from <a href="https://github.com/shopsys/shopsys/pull/554/files">my 5 days-old-PR</a>
    </p>
</div>
<p>Nor junior nor senior dev is able to check the proper private method order in these big chunks of code.</p>
<h2 id="Unless">Unless...</h2>
<p>...somebody or something does it for you.</p>
<blockquote class="blockquote text-center mt-5 mb-5">
    "Automate everything that brings you <strong>more value until you die<br>compared to value lost to create it</strong>."
</blockquote>
<p>There is now a Rector rule that does exactly what we need in an <strong>automated way</strong>:</p>
<pre><code class="language-bash">composer require rector/rector --dev</code></pre>
<pre><code class="language-php">use Rector\Order\Rector\Class_\OrderPrivateMethodsByUseRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;rule(OrderPrivateMethodsByUseRector::class);
};</code></pre>
<p>And run Rector:</p>
<pre><code class="language-bash">vendor/bin/rector process src</code></pre>
<p>At first, you might need to re-run the command few times, because of the new order of private methods will automatically change calling order. But that's it:</p>
<ul>
<li>no books,</li>
<li>no lectures,</li>
<li>0 hours wasted on code-reviews.</li>
</ul>
<p><br></p>
<p>Let finish with <em>Martin Fowler</em> quote:</p>
<blockquote class="blockquote text-center">
    "Any fool can write code that a computer can understand.<br>
    Good programmers write code that <strong>humans can understand</strong>."
</blockquote>
<p>I think we're coming to times, where:</p>
<blockquote class="blockquote text-center">
    "Any computer can write a code that humans can understand."
</blockquote>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/11/01/how-teach-your-team-private-method-sorting-in-3-mins</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 01 Nov 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/11/01/how-teach-your-team-private-method-sorting-in-3-mins#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 7 Tips to Get the Most out of Travis CI ]]></title>
                <link>https://tomasvotruba.com/blog/2018/10/29/7-tips-to-get-the-most-out-of-travis-ci</link>
                <description><![CDATA[ <p>Travis CI is the most spread CI in checking open-source projects. <br><br> Do you want to know how to use it <strong>3x faster</strong>? <br> How to make Travis <strong>generate code for you</strong>? <br> And how to make your <strong>tokens safe</strong>?</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="1-Skip-x-debug">1. Skip x-debug</h2>
<p>Xdebug makes everything much slower in exchange for deep analysis. It's useful<strong>only for code coverage</strong> in CI.</p>
<p>Turn it off to get faster:</p>
<pre><code class="language-yaml">before_script:
    - phpenv config-rm xdebug.ini || return 0</code></pre>
<p>Do you use coverage? Just use condition:</p>
<pre><code class="language-yaml">before_script:
    # disable xdebug if not coverage
    - if [[ $COVERAGE == "" ]]; then phpenv config-rm xdebug.ini; fi</code></pre>
<h2 id="2-Deliver-PR-Checks-Fast">2. Deliver PR Checks Fast</h2>
<p>The speed of feedback loop in PRs has the same effect as page load time. If the page is loading <strong>more than 4 seconds</strong>, <a href="https://www.hobo-web.co.uk/your-website-design-should-load-in-4-seconds">most people leaves thinking it's broken</a>.</p>
<p>What is <strong>must-have</strong> in PR check?</p>
<ul>
<li>tests</li>
<li>static analysis</li>
<li>coding style</li>
</ul>
<p>What can be <strong>checked later</strong>?</p>
<ul>
<li>code coverage</li>
<li>deploy</li>
<li>documentation build</li>
</ul>
<p>When tests, static analysis, and coding style can finish in 3 minutes including <code>composer install</code>, the code coverage and deploy could prolong waiting to <strong>9 minutes</strong>. For no added value, because it should be performed <em>on merge</em>.</p>
<p>Would you contribute to PR where you <strong>wait 9 minutes or 3 to know it passed</strong>?</p>
<p>For these reasons, there is <code>$TRAVIS_BRANCH</code> ENV var:</p>
<pre><code class="language-yaml">after_script:
    - |
      if [[ $COVERAGE == true &amp;&amp; $TRAVIS_BRANCH == "master" ]]; then
        vendor/bin/phpunit --coverage-clover coverage.xml
        wget https://github.com/php-coveralls/php-coveralls/releases/download/v2.1.0/php-coveralls.phar
        php php-coveralls.phar --verbose
      fi</code></pre>
<p>This way coverage is run just once the PR merged. Imagine the safe process time and human nerves in PR where were additional 10 commits after code-review.</p>
<h2 id="3-Use-ENV-vars">3. Use ENV vars</h2>
<p>ENV vars is a standard approach to set secure values, pass options to containers and PHP application. It's a trend Symfony pushes every version, recently with this <a href="https://symfony.com/blog/new-in-symfony-4-2-important-deprecations">Symfony 4.2 deprecation</a>:</p>
<pre><code class="language-diff">-php bin/console command_name --env=test --no-debug
+APP_ENV=test APP_DEBUG=0 php bin/console command_name</code></pre>
<p>How to use them?</p>
<pre><code class="language-yaml">language: php

matrix:
    include:
      - php: 7.2
        env: STATIC_ANALYSIS=true
      - php: 7.2

script:
    - vendor/bin/phpunit

    - |
      if [[ $STATIC_ANALYSIS == true ]]; then
        vendor/bin/ecs check src
        vendor/bin/phpstan analyze src --level max
      fi</code></pre>
<p>Travis also allows <a href="https://docs.travis-ci.com/user/build-stages">Stages</a> oppose ENV variables. I've tried that and it has much more complicated YAML syntax, than just <code>VAR=value</code>. Also due to ENV trends lead by Docker, containers in general and Symfony, I'd stick with ENV vars for open-source projects.</p>
<p><strong>For private projects stages are great</strong> since you need to deploy migrations and the code itself. But for private projects, I think Gitlab CI is a much more valuable option. Ask <a href="https://janmikes.cz">Jan Mikeš</a> about that.</p>
<h2 id="4-Use-Travis-to-do-More-Just-Watching">4. Use Travis to do More Just Watching</h2>
<p>Most projects use Travis to check tests and analyze code. But did you know you can also use it for <strong>open-source deploy</strong>? And even more:</p>
<ul>
<li><strong>running validations</strong>, e.g. if all links are still responding with 200</li>
<li><strong>crawl websites</strong> and storing data to YAML</li>
<li><strong>Tweet</strong>!</li>
</ul>
<pre><code class="language-yaml">script:
    # make sure there are no duplicates
    - bin/console validate-groups

    # import data and genearte YAML
    - bin/console import

    # generate website to "/output" directory
    - vendor/bin/statie generate source</code></pre>
<p>Since filesystem exists as long as the container is running, you can download, dump and work with almost any data in it.</p>
<p>One more thing: <strong>Travis is super fast.</strong> What on my laptop takes 10 minutes, it can solve in 2.</p>
<h2 id="5-Rebuild-your-GitHub-Pages-Daily">5. Rebuild your GitHub Pages Daily</h2>
<p>One of the sexy features of Travis are <a href="https://docs.travis-ci.com/user/cron-jobs">Cron Jobs</a> in combination with Github Pages and <code>deploy</code>:</p>
<p>It is this easy to <a href="https://www.statie.org/docs/github-pages/#configure-travis">deploy Statie website</a> to Github Pages:</p>
<pre><code class="language-yaml">language: php

php: 7.2

install:
    - composer install

script:
    - vendor/bin/statie generate source

deploy:
    provider: pages
    skip_cleanup: true
    github_token: $GITHUB_TOKEN
    local_dir: output
    on:
        branch: master</code></pre>
<p>Check real life <code>.travis.yml</code> to getter better idea:</p>
<ul>
<li><a href="https://github.com/pehapkari/pehapkari.cz/blob/7cb58f17cedffc8222d063d632b7d353c7728342/.travis.yml#L35-L41">pehapkari.cz</a></li>
<li><a href="https://github.com/TomasVotruba/friendsofphp.org/blob/76f64d0fa48633abcd4e256eb575f8d99ba1d78b/.travis.yml#L24-L40">friendsofphp.org</a></li>
</ul>
<h2 id="6-Stay-Secure">6. Stay Secure</h2>
<p>When I said you can <strong>Tweet</strong> with your Travis, I mean it. That's what me lazy bastard <a href="https://github.com/TomasVotruba/tomasvotruba.com/tree/master/packages/StatieTweetPublisher">does</a> on this blog:</p>
<pre><code class="language-yaml">after_deploy:
    - |
      if [[ $TRAVIS_BRANCH == "master" &amp;&amp; $TRAVIS_PULL_REQUEST == "false" ]]; then
        packages/StatieTweetPublisher/bin/publish-new-tweet
      fi</code></pre>
<p>You may think &quot;that not secure, bro&quot;, and you're right! To be able to tweet Travis needs to know the auth tokens that Twitter generates for you:</p>
<pre><code class="language-yaml">language: php

env:
    - TWITTER_CONSUMER_KEY="asd0830GA709GA"
    - TWITTER_CONSUMER_SECRET="asd0830GA709GA"
    - TWITTER_OAUTH_ACCESS_TOKEN="asd0830GA709GA"
    - TWITTER_OAUTH_ACCESS_TOKEN_SECRET="asd0830GA709GA"
    # they're all fake, don't even try it!</code></pre>
<p>This could work, but then everyone would see it.</p>
<p><strong>How to do it in secret?</strong></p>
<p>You can actually <strong>enter them manually</strong> in Travis administration of your repository - <a href="https://github.com/TomasVotruba/tomasvotruba.com/tree/master/packages/StatieTweetPublisher#setup-travis-online">here is the tutorial</a>.</p>
<p>But still, what if someone will send you following PR:</p>
<pre><code class="language-yaml">script:
    - echo $TWITTER_CONSUMER_KEY
    - echo $TWITTER_CONSUMER_SECRET
    - echo $TWITTER_OAUTH_ACCESS_TOKEN
    - echo $TWITTER_OAUTH_ACCESS_TOKEN_SECRET</code></pre>
<p>That's not nice and you should not do that to your friends! No, really, it a good way of thinking how to hack - good job.</p>
<p>Travis thought about this:</p>
<ul>
<li>first, they will be displayed as <code>**secret**</code> everywhere in the code</li>
</ul>
<p>But what if you try:</p>
<pre><code class="language-php">$secret = getenv('TWITTER_CONSUMER_KEY');
for ($i = 0; $i &lt; strlen($secret); ++$i) {
    echo $secret[$i] . PHP_EOL;
}</code></pre>
<p>Well, that still won't work (I tried that), since these variable <strong>are available only for the repository owner</strong>.</p>
<p>But if you as an owner do echo it like this PHP script, you're screwed :).</p>
<h2 id="7-Make-use-of-Composer-Scripts">7. Make use of Composer Scripts</h2>
<p>Did you know you can define your own composer scripts and run them with <code>composer &lt;name&gt;</code>? If not, check <a href="https://blog.martinhujer.cz/have-you-tried-composer-scripts">Have you tried Composer Scripts? You may not need Phing</a> that explains it in a very practical way.</p>
<p>So instead of writing it manually in Travis and locally and just waiting for a typo or miss use of invalid config:</p>
<pre><code class="language-yaml">script:
    # static analysis
    - vendor/bin/ecs check bin src test packages
    - vendor/bin/phpstan analyze packages bin src tests packages --level max</code></pre>
<p>you can actually use these in Travis as well:</p>
<pre><code class="language-yaml">script:
    # static analysis
    - composer check-cs
    - composer phpstan</code></pre>
<p>Anyone who needs to debug and know what's behind these shortcuts can just open <code>composer.json</code>:</p>
<pre><code class="language-json">{
    "scripts": {
        "check-cs": "vendor/bin/ecs check bin src tests packages",
        "phpstan": "vendor/bin/phpstan analyse bin src tests packages --level max"
    }
}</code></pre>
<p><br></p>
<p>Did I miss some tip you use every day or do you know a better one? <strong>Share in comments!</strong></p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/10/29/7-tips-to-get-the-most-out-of-travis-ci</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 29 Oct 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/10/29/7-tips-to-get-the-most-out-of-travis-ci#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Why AST Fixes your Coding Standard Better than Tokens ]]></title>
                <link>https://tomasvotruba.com/blog/2018/10/25/why-ast-fixes-your-coding-standard-better-than-tokens</link>
                <description><![CDATA[ <p>In the last post <a href="/blog/2018/10/22/brief-history-of-tools-watching-and-changing-your-php-code/"><em>Brief History of Tools Watching and Changing Your PHP Code</em></a> we saw there are over <strong>dozen tools in PHP that can modify code</strong>. So there is no surprise coding standard tools are &quot;upgrading&quot; code from PHP 5.6 to PHP 7.2 without knowing types and that AST is moving <code>false</code> to <code>!</code>. <br><br> Should coding standard upgrade your code? Should AST make your code cleaner? Should AST take of coding standard changes? <strong>Which is born for it?</strong></p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Tokens">Tokens</h2>
<p>PHP CS Fixer can upgrade to few features of new PHP using just <code>token_get_all()</code>:</p>
<div class="text-center">
    <img src="/assets/images/posts/2018/ast-tokens/php-cs-fixer-migrate.png" class="img-thumbnail">

    <p><a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer/blob/03e13fb91c775a151dc57ae51e80ba3f2abe7da6/src/RuleSet.php#L209-L240"><code>RuleSet.php</code></a></p>
</div>
<h2 id="AST">AST</h2>
<p><a href="https://github.com/rectorphp/rector">Rector</a> can solve rather low-level changes in <a href="https://github.com/rectorphp/rector/issues/424">code quality</a> level:</p>
<pre><code class="language-diff">-if (! $this-&gt;isTrue($condition) === false) {
+if ($this-&gt;isTrue($condition)) {</code></pre>
<pre><code class="language-diff">-count(func_get_args()) === 1);
+func_num_args() === 1</code></pre>
<h3 id="The-and-quot-Code-Quality-and-quot-Level">The &quot;Code Quality&quot; Level</h3>
<p>It's the most favorite level in Rector. Why?</p>
<ul>
<li>it <strong>makes your code clear</strong></li>
<li>it's <strong>easy to use on any PHP code regardless framework</strong> you're using - from pure PHP, over Drupal, Wordpress, Magento, to frameworks like Symfony, Nette, and Laravel</li>
<li>it helps you to <strong>use direct PHP functions</strong> instead of wrapping them into complex structures ↓</li>
</ul>
<pre><code class="language-diff">-foreach ($this-&gt;oldToNewFunctions as $oldFunction =&gt; $newFunction) {
-    if ($currentFunction === $oldFunction) {
-        return $newFunction;
-    }
-}
-
-return null;
+return $this-&gt;oldToNewFunctions[$currentFunction] ?? null;</code></pre>
<p>Huge thanks to <a href="https://github.com/carusogabriel">Gabriel Caruso</a>, who brought this idea to Rector and helped me to shift my view to the one I'll show you below.</p>
<p><br></p>
<p>If there would be no AST, this all could be handled by <code>token_get_all</code> (<a href="/blog/2017/07/31/how-php-coding-standard-tools-actually-work">like PHP_CodeSniffer and PHP CS Fixer</a>/), but <strong>such implementation needs to be lot longer to achieve similar quality</strong>, since you have to check every previous and next tokens for any unexpected values.</p>
<blockquote class="blockquote text-center pb-5 pt-5">
    "I really don't like programming. I built this tool to program less so that I could just reuse code."
    <footer class="blockquote-footer">Rasmus Lerdorf
</footer></blockquote>
<h2 id="Shifting-the-Scope">Shifting the Scope</h2>
<p>We're here at the moment:</p>
<ul>
<li>tokens / coding standard === styling only</li>
<li>AST / static analysis === context aware only</li>
</ul>
<p>That's very narrow and old-school, but the shift has already begun...</p>
<h3 id="Tokens-are-Best-at">Tokens are Best at</h3>
<ul>
<li>
<p>spacing and exact positions</p>
<pre><code class="language-diff">-if ($condition )
-{
+if ($condition) {</code></pre>
</li>
<li>
<p>sign changes</p>
<pre><code class="language-diff">-$items = array(1, 2, 3;);
+$items = [1, 2, 3];</code></pre>
</li>
<li>
<p>doc block changes</p>
<pre><code class="language-diff">/**
-* @param    int|string
+* @param int|string $id
 */</code></pre>
</li>
</ul>
<h3 id="AST-is-Best-at">AST is Best at</h3>
<ul>
<li>
<p>logic and structure changes</p>
<pre><code class="language-diff">-if (! $this-&gt;isTrue($condition) === false) {
+if ($this-&gt;isTrue($condition)) {</code></pre>
</li>
<li>
<p>code cleanup</p>
<pre><code class="language-diff">-$value = $value;</code></pre>
</li>
<li>
<p>context-aware names</p>
<pre><code class="language-diff">-$formBuilder-&gt;add('name', new TextType);
+$formBuilder-&gt;add('name', TextType::class);</code></pre>
</li>
</ul>
<h2 id="1-Example-for-Coding-Standards-in-AST">1 Example for Coding Standards in AST</h2>
<p>Let's take this case of useless variable:</p>
<pre><code class="language-diff"> function () {
-    $a = true;
-    return $a;
+    return true;
 };</code></pre>
<p>My first thought was: &quot;Why is it assigned, is there some magic behind this? I need to explore more.&quot;
Well, there isn't - <strong>it's a trap</strong>. Both for the programmer and for PHP to interpret it.</p>
<p>So this change will not only make your code more readable but also faster. A nice side effect, right?</p>
<p>Let's briefly compare how tokens and AST approach this:</p>
<table class="table table-bordered table-responsive mt-5 mb-5">
    <thead class="thead-inverse">
        <tr>
            <th class="text-center w-50">Tokens</th>
            <th class="text-center w-50">AST</th>
        </tr>
    </thead>
    <tr>
        <td>PHP_CodeSniffer</td>
        <td>Rector</td>
    </tr>
    <tr>
        <td>
            <a href="https://github.com/slevomat/coding-standard/blob/5ae298bdb3bbdf573d506d0da3e8c6eadde6ba12/SlevomatCodingStandard/Sniffs/Variables/UselessVariableSniff.php">
                <code>UselessVariableSniff</code>
            </a>
        </td>
        <td>
            <a href="https://github.com/rectorphp/rector/blob/9855690778272de1033ad1f8c520bbee0a877201/packages/CodeQuality/src/Rector/Return_/SimplifyUselessVariableRector.php">
                <code>SimplifyUselessVariableRector</code>
            </a>
        </td>
    </tr>
    <tr>
        <td><strong>329 lines</strong></td>
        <td><strong>120 lines</strong></td>
    </tr>
    <tr>
        <td>2 helper services</td>
        <td>1 helper service</td>
    </tr>
</table>
<p>Note that it would be very difficult to write both versions shorter and keep reliability high and I believe <a href="https://github.com/kukulich">kukulich</a> is very good at implementing Sniffs effectively. <strong>It's a matter of used technology, not implementation skill</strong>.</p>
<p>To sum up, <strong>the AST version takes only 36,47 % of code what token version</strong>.</p>
<p><br></p>
<p>Also, AST implementation also solved this case without no extra work:</p>
<pre><code class="language-diff"> function test() {
     $a = 1;
     $b = 1;
-    $c = [
+    return [
         $b-- =&gt; $a++,
         --$b =&gt; ++$a,
     ];
-    return $c;
 }</code></pre>
<h2 id="Coding-Standards-on-Steroids-with-AST">Coding Standards on Steroids with AST</h2>
<p>I still imagine how PHP would look like today if we had AST in <a href="https://github.com/nikic/PHP-Parser/issues/41">2012 when Fabien started PHP CS Fixer</a>.</p>
<img src="/assets/images/posts/2018/ast-tokens/scope.png" class="mb-2">
<p><br></p>
<ul>
<li>
<p>Would you be interested in such AST rules for coding standard?</p>
</li>
<li>
<p><strong>What rules would you add</strong> if it would be easier to create them with AST?</p>
</li>
</ul> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/10/25/why-ast-fixes-your-coding-standard-better-than-tokens</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 25 Oct 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/10/25/why-ast-fixes-your-coding-standard-better-than-tokens#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Brief History of Tools Watching and Changing Your PHP Code ]]></title>
                <link>https://tomasvotruba.com/blog/2018/10/22/brief-history-of-tools-watching-and-changing-your-php-code</link>
                <description><![CDATA[ <p>From coding standard tools, over static analysis to instant upgrade tools. This post is going to be a geeky history trip. <br> <br> Which tool was first? How they <strong>build on shoulders of each other</strong>?</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="1-Coding-Standard-Tools">1. Coding Standard Tools</h2>
<h3 id="PHP-CodeSniffer-from-Australia"><a href="https://github.com/squizlabs/PHP_CodeSniffer">PHP_CodeSniffer</a> from Australia</h3>
<p><span class="badge badge-light">Tokens</span>
<span class="badge badge-success">Modifies Code</span></p>
<p>The first tool that made it to the mainstream of coding standard tools was created around <strong>2007</strong> by Greg Sherwood from Australia. At least by date <a href="http://gregsherwood.blogspot.com/2006/12/if-not-test-first-then-test-really-soon.html">of the oldest post I could found</a>.</p>
<p>Greg has been maintaining the repository for last <strong>11 years</strong> (at least). I don't know anyone else who would take care of his project for such a long time without stepping back - <strong>much respect</strong>!</p>
<h3 id="PHP-CS-Fixer-from-Symfony"><a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer">PHP CS Fixer</a> from Symfony</h3>
<p><span class="badge badge-light">Tokens</span>
<span class="badge badge-success">Modifies Code</span></p>
<p>Reporting errors are helpful, but fixing them for you is even more helpful. More people got a similar need and around <a href="https://gist.github.com/fabpot/3f25555dce956accd4dd">Symfony 2.0 times and 2011</a> next tools were born - PHP CS Fixer.</p>
<p><a href="https://gist.github.com/fabpot/3f25555dce956accd4dd">The first version</a> was created by Fabien Potentier, author and founder of Symfony, and it used mostly regular expressions.</p>
<p>The decision to <strong>fix everything by default was the huge jump in history</strong> of these tools. It was the first case of a tool that would be so bold to change your code for you. You had to believe it, you had to overcome the fear of modifying it the wrong way or even deleting. I mean, now we're used to it like to cars, but at one point of history, they were just riding bombs.</p>
<p><br></p>
<p>With <a href="http://fabien.potencier.org/php-cs-fixer-finally-reaches-version-1-0.html">PHP CS Fixer 1.0 release in 2014</a> and rising popularity of <strong>automated fixes</strong> was <strong>big motivation for PHP_CodeSniffer</strong> to add similar feature - <a href="https://github.com/squizlabs/PHP_CodeSniffer/wiki/Fixing-Errors-Automatically"><em>code beautifier</em></a> - to version 2.</p>
<p>It also helped with another issue. The development of PHP_CodeSniffer 2.8 and later almost froze to zero. I remember because I started working on <a href="https://github.com/symplify/easy-coding-standard">EasyCodingStandard</a> right between
PHP_CodeSniffer 2.8 and 3.0 (depending on <code>3.0-dev</code>), which took 14 uncertain months.</p>
<p><strong>So PHP_CodeSniffer now holds <span class="badge badge-success">Modifies Code</span> as well.</strong></p>
<p><br></p>
<p>Both use <code>token_get_all()</code> that basically parses code to strings. Do you want to know <a href="/blog/2017/07/31/how-php-coding-standard-tools-actually-work/">how they actually work</a>?</p>
<h3 id="EasyCodingStandard-from-the-Czech-Republic"><a href="https://github.com/symplify/easy-coding-standard">EasyCodingStandard</a> from the Czech Republic</h3>
<p><span class="badge badge-light">Tokens</span>
<span class="badge badge-success">Modifies Code</span></p>
<p>I saw many projects that use both tools, yet very poorly - because split attention divides the focus in the same ratio. The mission of this tool is <strong>to help new generations to adopt coding standard with almost no effort</strong>. So in <strong>2016</strong> the EasyCodingStandard was born.</p>
<h2 id="2-Static-Analysis-Tools">2. Static Analysis Tools</h2>
<h3 id="nikic-php-parser"><a href="https://github.com/nikic/PHP-Parser">nikic/php-parser</a></h3>
<p><span class="badge badge-danger">AST</span></p>
<p>This package is barely known for code analysis. But it provides the technology that all the other tool builds on - <em>abstract syntax tree</em> (known as <em>AST</em>).</p>
<p>It all started as a question on <a href="https://stackoverflow.com/questions/5586358/any-decent-php-parser-written-in-php">StackOverflow</a> - <em>Any decent PHP parser written in PHP?</em> nikic answered himself with a <a href="https://github.com/nikic/PHP-Parser"><code>php-parser</code></a> less than a 6 months later.</p>
<p>I would not write this post and neither have my fuel for passion without this tool, so <strong>huge thank you, Nikita, for creating it and maintaining it</strong>.</p>
<p><br></p>
<p>All following tools use an <strong>AST analyzer</strong> - that's how they know what object is <code>$object</code> variable, like in this example:</p>
<pre><code class="language-php">&lt;?php

class SomeObject
{
    public function exist()
    {
    }
}

$object = new SomeObject; // AST remembers that "$object" is "SomeObject" type
$object-&gt;missing(); // here we know that "missing" does not exist in "SomeObject"</code></pre>
<h3 id="PHPStan-by-Ondrej-Mirtes"><a href="https://github.com/phpstan/phpstan">PHPStan</a> by Ondrej Mirtes</h3>
<p><span class="badge badge-danger">AST</span>
<span class="badge badge-info">
<a href="https://github.com/phpstan/phpstan/releases/tag/0.1">* 2016</a>
</span></p>
<p>If you don't use any static analysis tool, give PHPStan a try. I've made <a href="/blog/2017/01/28/why-I-switched-scrutinizer-for-phpstan-and-you-should-too/">minimalist intro that will help you with first steps </a>. It's worth investing even day or two to set it up because <strong>these tools will join toolkit of everyday use</strong>, like Composer or PHPUnit.</p>
<h3 id="vimeo-psalm-by-Matthew-Brown"><a href="https://github.com/vimeo/psalm">vimeo/psalm</a> by Matthew Brown</h3>
<p><span class="badge badge-danger">AST</span>
<span class="badge badge-info">
<a href="https://github.com/vimeo/psalm/releases/tag/0.1">* 2016</a>
</span>
<span class="badge badge-success">Modifies Code</span></p>
<p>Psalm is a very interesting tool that was born to fight Vimeo code complexity. It was the first tool from this group of 3, <strong>that started <a href="https://psalm.dev/docs/manipulating_code/fixing/">fixing the code</a></strong>.</p>
<h2 id="3-Deprecation-Detectors">3. Deprecation Detectors</h2>
<p>This group is widely used in the framework-agnostic PHP community.</p>
<h3 id="PHPCompatibility-PHPCompatibility"><a href="https://github.com/PHPCompatibility/PHPCompatibility">PHPCompatibility/PHPCompatibility</a></h3>
<p><span class="badge badge-light">Tokens</span></p>
<p>This tool checks for PHP cross-version compatibility. It allows you to analyze your code for compatibility with higher and lower versions of PHP.</p>
<p><br></p>
<p>It's useful to know what places are wrong, but you still have to fix them all manually.</p>
<h2 id="4-Instant-Upgrade-Tools">4. Instant Upgrade Tools</h2>
<h3 id="umpirsky-Symfony-Upgrade-Fixer"><a href="https://github.com/umpirsky/Symfony-Upgrade-Fixer">umpirsky/Symfony-Upgrade-Fixer</a></h3>
<p><span class="badge badge-light">Tokens</span>
<span class="badge badge-success">Modifies Code</span>
<span class="badge badge-secondary">Deprecated</span></p>
<p>This tool was created in <strong>2015</strong> and it's revolutionary. Why? It wisely connects the token analysis of PHP CS Fixer with deprecations in Symfony 2 to 3. Imagine it like PHP CS Fixer + <code>sensiolabs-de/deprecation-detector</code> <strong>working for you</strong>.</p>
<p>Isn't that amazing? <strong>You just sit, run this tool and send invoices. Genius!</strong> The features are limited due to Tokens, but still, I love this.</p>
<h3 id="Rector"><a href="https://github.com/rectorphp/rector">Rector</a></h3>
<p><span class="badge badge-danger">AST</span>
<span class="badge badge-success">Modifies Code</span></p>
<p>It's <strong>2017</strong> and Rector still had to wait many months to be born. For what?</p>
<p>Well, it's built on php-parser and as it modifies the code and prints it back, it <strong>needed to keep spacing</strong>. That's one of AST drawbacks - it doesn't care about all that coding standards spacings.</p>
<p>They say &quot;history repeats&quot;, but I never trusted that. Untill I saw that similar need Fabien had while making the PHP CS Fixer in 2012 - <a href="https://github.com/nikic/PHP-Parser/issues/41">Optionally add nodes for whitespace</a>. More <strong>people wanted AST-based coding standards</strong>:</p>
<blockquote class="twitter-tweet" data-lang="cs"><p lang="en" dir="ltr"><a href="https://twitter.com/fabpot?ref_src=twsrc%5Etfw">@fabpot</a> zendframework, though we are moving afay from php-cs-fixer because it is not AST-based</p>— Supervising Program (@Ocramius) <a href="https://twitter.com/Ocramius/status/532622405290971136?ref_src=twsrc%5Etfw">12. listopadu 2014</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>php-parser <code>4.0-dev</code> already had this feature, so Rector ran on it since the very start. It was not until <a href="https://github.com/nikic/PHP-Parser/releases/tag/v4.0.0"><strong>February 2018</strong></a> when it was finally released.</p>
<p>Last giant Rector builds on is the one for type analysis - PHPStan. Thanks to that, it <strong>doesn't reinvent the wheel and can focus on the refactoring part</strong>.</p>
<p><br></p>
<p>And that's a brief history of big-brother tools that watch your code and modify it for you.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/10/22/brief-history-of-tools-watching-and-changing-your-php-code</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 22 Oct 2018 00:00:00 +0000</pubDate>
                                    <updated>2020-12-01UTC00:00:000</updated>
                    <atom:updated>Tue, 01 Dec 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Tue, 01 Dec 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/10/22/brief-history-of-tools-watching-and-changing-your-php-code#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How I Almost Missed My Talk in PHP Asia Conference ]]></title>
                <link>https://tomasvotruba.com/blog/2018/10/18/how-i-almost-missed-my-talk-in-php-asia-conference</link>
                <description><![CDATA[ <p>Last month you could not call me, cause I was on a month trip to Asia. For fun? Of course, <del>but also</del> for <a href="https://2018.phpconf.asia">PHP Conference Asia</a> where I talked about <a href="https://github.com/rectorphp/rector">Rector</a>. <br><br> It was my first trip to Asia ever, so obviously, it went wrong...</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Complex-over-Simple">Complex over Simple</h2>
<p>I was flying to <a href="https://2018.phpconf.asia">PHP Conf Asia</a> that was held in Singapore from the beautiful city of Berlin... in 1 flight? No, that would too easy for me. Sometimes I want to go to my past me, <strong>slap him and make him choose the easy way for once</strong>.</p>
<p>So I picked rather <strong>dynamic trip</strong>:</p>
<ul>
<li>from Berlin to Riga - 1,5 hours flight</li>
<li>from Riga to Istanbul - 3 hours</li>
<li>and from Istanbul to Singapore - 10 hours!</li>
</ul>
<p>I had 4 hours break at each airport because airports are so fun, right? I took a risk in Riga and went from airport to the city center, just to get fresh rain and a good coffee. I made it - thanks EU internet treat!</p>
<p>I decided to spend my 4 hours in Istanbul Airport since it was my first time flying more than 3 hours and I was scared that I fill fuck something up if I'd got to the city.</p>
<p>I felt like a responsible traveler:</p>
<ul>
<li>I found a gate 709,</li>
<li>sit in front of it, <strong>3 meters</strong> from the table where airport worker checks your passport and ticket</li>
<li>checked the depart time 2:00 in the morning,</li>
<li>checked the <strong>gate closing time 1:35</strong>,</li>
<li>picked up my laptop and start working.</li>
</ul>
<p>I was there <strong>3 hours ahead</strong>, what could go wrong? There were a couple of Chinese and Japanese guys around, so it was obviously clear this is the flight to the right location.</p>
<h2 id="Going-Too-Deep">Going Too Deep</h2>
<p>So, I'm coding, preparing a <a href="https://github.com/rectorphp/demo">new Rector demo repository</a> for the conference and fixing few bugs I found along. It's around 1:00 and a guy comes to the table - &quot;it will start soon and I'm right here, great&quot;, I thought to myself. <strong>This man made me feel secure</strong>, I would have to be really stupid to miss <em>his</em> last call right in front of me.</p>
<p><strong>I got back to coding and dove deep to the flow</strong>, fixing the code and making test pass like a machine gun. It's around 1:25 when I rise my ahead again. Still no boarding, hm. It's probably delayed a bit, that happened on my last flight, no big deal, 10 minutes here and there.</p>
<p>I don't know how that happened but when I raise my head again from the code, it was <strong>1:35</strong>. What is going on? Why the guy didn't come to me to tell me to board? I looked around and I saw nobody else was boarding. There were still the same 20 people I saw when I came here. I swear this is the first time I realized, it's a bit weird that there are only 20 people flying to Singapore. I mean, how big the plane is?</p>
<p><strong>My heart started to racing, I must have fucked up something.</strong> I closed the computer and almost jumped to the desk:</p>
<ul>
<li>&quot;Hi, is this the flight to Singapore?&quot;</li>
<li><em>&quot;Hello, I'm busy.&quot;</em></li>
</ul>
<p>I understood his not very clear English. <em>Fuck. Fuck. Fuck!</em> Noise in my head, <strong>this is not the right gate</strong>. What will I tell Mike? That I was on airport 4 hours in advance and that I missed my 3rd flight? That's a great way to start an international speaker career, Tom!</p>
<p>I run to displays and checked for my flight... It's here, 709. Good, uff... wait, it's 705. <em>Damn!</em> These are moments I appreciate really good UX. There were no number signs, except mine 709, so <strong>I started running in random direction</strong>... numbers were going up. I U-turned, hoping for at least <em>some</em> logic.</p>
<p>Good, it's rising! But the gate was closing at 1:35 and it was 1:38. Oh no, <strong>not that London experience again, when we missed the flight to Prague</strong> (the night end-up being awesome because there were 8 of us).</p>
<p>I run like crazy! This is my only chance!</p>
<p><br></p>
<p>Well, I missed the flight and spend my &quot;awesome&quot; month in Istanbul...</p>
<p><br></p>
<p>No, just kidding. <strong>I got almost heart attack, but in 10 seconds I found the right gate with 2 other last-call colleagues</strong>. I was thanking God, promising I'll never say anything bad to another living creature as thank-you reward for this gift.</p>
<p>Lesson learned? <strong>Ask, ask, ask!</strong> When I came to the group of people in 22:00, I could ask &quot;Is this flight to Singapore, right?&quot;. They'd say &quot;no&quot;, then I'd try to convince them it is, then I'd find the right gate. This one helped me a lot in next month, and it was just awesome!</p>
<h2 id="What-Would-I-Miss-on-PHP-Conf-Asia-if-I-d-Miss-the-Flight">What Would I Miss on PHP Conf Asia if I'd Miss the Flight?</h2>
<div class="text-center">
    <img src="https://2018.phpconf.asia/images/phpconfasia-logo.png">
</div>
<p>I'm very glad I made it. People on the conference <strong>were possessed with kindness and generosity</strong> I never saw before on such a big IT event:</p>
<ul>
<li>from the best wing-woman &quot;Tom, have you met...&quot; that introduced me to many fellow-speakers and visitors,</li>
<li>over curious guys from all around Asia, who tried Rector and assumed every bug was their mistake,</li>
<li>to organizer <a href="https://twitter.com/coderkungfu">Michael Cheng</a>, who always let me rest from my first jet lag.</li>
</ul>
<div class="text-center">
    <img src="/assets/images/posts/2018/phpasia/round.jpg" class="img-thumbnail">
</div>
<p><strong>I'm very grateful I could be their guys, I enjoyed talking with you, sharing experience and views on life and code.</strong></p>
<p>I also loved panel discussion <em>PHP - The journey so far (and what's ahead)</em> with Rasmus Lerdorf, Sebastian Bergmann and Derick Rethans. The questions from the community were insightful and touching really important moments.</p>
<p>I would not believe how much can change in software in 15 years.</p>
<div class="text-center">
    <img src="/assets/images/posts/2018/phpasia/coffee.jpg" class="img-thumbnail">
</div>
<p>One more thing, <strong>the coffee was supreme</strong>. I never had better coffees at the conference - so good I had 6 of them in 2 hours.</p>
<h2 id="Come-Next-Time">Come Next Time!</h2>
<p>Michael shared with a big secret: <strong>not many people from Europe knew about the CFP</strong> or were willing to fly such a distance, who knows - there were actually more free talks slots.</p>
<p>This conference really loves to support diversity and international exchange visitors. So if you want to talk somewhere abroad and you've been to your neighbor country already, <strong>follow <a href="https://twitter.com/phpconfasia">@phpconfasia</a> and be ready to send your talks</strong>.</p>
<div class="text-center">
    <img src="/assets/images/posts/2018/phpasia/mefie.jpg" class="img-thumbnail">
</div>
<p>I'd be happy to go with you if I'll have the chance.</p>
<h2 id="What-is-Singapore-Like">What is Singapore Like?</h2>
<div class="text-center">
    <img src="/assets/images/posts/2018/phpasia/nature.jpg" class="img-thumbnail">
</div>
<p>I got a chance to stay a whole week (thanks again, Michael!) there and I must say, it's a huge crazy city.</p>
<p>But it also has...</p>
<ul>
<li>cheap places to eat in,</li>
<li><strong>super cheap public transport</strong> - where Berlin costs 7 €/day, you'll spend that in Singapore in 3 days</li>
<li><strong>rich free gardens</strong>,</li>
<li><strong>great coffee</strong> + wifi right in the center (too bad I found out the night before I left the city)</li>
<li>awesome views from the top of buildings,</li>
</ul>
<p>...and many more for you to discover</p>
<p>Everyone speaks English so it's easy to ask, orientate and get it right.</p>
<h2 id="There-is-a-Bigger-PHP-Family-than-You-Think">There is a Bigger PHP Family than You Think</h2>
<div class="text-center">
    <img src="/assets/images/posts/2018/phpasia/family.png" class="img-thumbnail">
    <p><a href="https://friendsofphp.org/">Friendsofphp.org</a></p>
</div>
<p><br></p>
<p>In the end, this conference gave me a lot to think about. There is more than Symfony, than Laravel, than PHP 7, than Europe.
There is huge PHP community I never knew about, with many awesome people... not people, <strong>but heroes who build their local communities, share their know-how and bring people together</strong> with much less payment and resource then we in Europe have.</p>
<p><strong>This gave me a kick from my bubble I live in</strong>. The kick I needed. Such a kick that during next 2 week I stayed in Malaysia it made me work on:</p>
<ul>
<li><a href="https://friendsofphp.org">Friendsofphp.org</a> - to grow from 200 PHP groups to 1023 PHP groups from the whole world</li>
<li><a href="https://github.com/rectorphp/rector/issues/638">Rector PHP Upgrades</a> - we all have framework preferences, but we all write code in some PHP version</li>
</ul>
<p><br></p>
<p>I had a great time - thank you Michael and the whole PHP Asia Conf team!</p>
<p>See you next time in Singapore.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/10/18/how-i-almost-missed-my-talk-in-php-asia-conference</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 18 Oct 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/10/18/how-i-almost-missed-my-talk-in-php-asia-conference#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ What is Your Third Door? - Book Review ]]></title>
                <link>https://tomasvotruba.com/blog/2018/10/15/what-is-your-third-door-book-review</link>
                <description><![CDATA[ <p>Do you live in a big house? Then I guess you know this problem. There is the main door, there is the garden door and most people use these.
<br>
<br>
But what if the police come to bring you in for your financial frauds and child porn, <strong>what door do you take to run</strong>?</p> ]]></description>
                <content:encoded><![CDATA[ <img src="/assets/images/posts/2018/third-door/book.jpg" class="img-thumbnail">
<p>The <em>Third Door</em> book is actually a story of 18-year Alex, <strong>who chases a dream to interview people like</strong>:</p>
<ul>
<li>Bill Gates</li>
<li>Warren Buffet</li>
<li>Steve Wozniak - in this book I finally saw Steve Jobs from another point of view,</li>
<li>Jessica Alba - do you she owns <em>The Honest Company</em>?</li>
<li>Tim Ferris</li>
<li>Steven Spielberg</li>
<li>Larry King</li>
<li>Mark Zuckerberg</li>
</ul>
<p>I don't remember names usually, but I got all these from top of my head - that's how <strong>emotional and tense this book is</strong>.</p>
<h2 id="Why">Why?</h2>
<p>He wants to find out, what all these people do differently. What skills got them to the place they are now.
This book is about <strong>hackers' minds</strong>.</p>
<p>And it's not an easy journey, it takes more than 4 years of struggle, pain, childhood traumas, rejections, a friend who turns to great liar but also mentor from heaven, support from family, friends and bigger community of people alike.</p>
<blockquote class="blockquote text-center">
    "Reading about Tony Hsieh’s journey—about the leaps of faith he took despite everything that could go wrong—helped me find the courage within myself I didn’t know I had. Reading about his dream fueled me to pursue my own."
</blockquote>
<p><strong>What would you do for 4 years in a row without getting above the profit line?</strong></p>
<h2 id="Emotions-over-Solutions">Emotions over Solutions</h2>
<p>What <strong>I love about this book</strong> is that it's different from all the other self-help porn. It doesn't include:</p>
<ul>
<li>&quot;10 ways to be more effective you can do right now&quot;</li>
<li>or better &quot;scientist found out, that average person spends 30 minutes a day in the deep-work state, aim for 8 hours to beat your competition&quot;</li>
</ul>
<p>These are all <strong>imperatives</strong>, we love to use them, but they barely work.</p>
<p>Do you know what spreads better than thoughts? <strong>Emotions</strong>! The Third Dood book tells the story with wisdom very neatly placed between the lines.</p>
<blockquote class="blockquote text-center">
    "A true hustler is always looking for the next one," he said.<br>
    "It's like playing a video game - let's say Mario Bros."
</blockquote>
<h2 id="Single-Honest-Story">Single Honest Story</h2>
<p>I don't want to spoil much, but I'll say one thing: <strong><em>The Third Door</em>  is the most engagement book I've read in 2018</strong>. It sucked me in and let me go in a few weeks. I felt smart, I felt connected to Alex, I cried when... well, you'll see.</p>
<blockquote class="blockquote text-center">
    "When I was young, I admired clever people. Now that I am old, I admire kind people."
</blockquote>
<p>Many pop-science-self-help authors like <em>Daniel Pink</em>, <em>Simon Sinek</em> or <em>Cal Newport</em> pop one book after another. Their books are mostly based on research and many small stories and have high quality. They're helpful, but in time it gets boring when you have to think and don't learn much (do you remember school?). In and out.</p>
<p>What I want to say is that I love that <strong>Alex only wrote only this single one book</strong>. It's his life story. Do you connect better to single life's person or to 15 research papers and 50 small stories? And rapport is crucial in learning.</p>
<h2 id="Give-it-a-1-Chapter-Try">Give it a 1-Chapter Try</h2>
<p>It's so hard not to spoil anything when the story was so good. You know like in the <em>Avengers: Infinity War</em>, when (spoiler protection), and you wanted to tell everyone?</p>
<blockquote class="blockquote text-center">
    "When it's in front of you... make your move."
</blockquote>
<p>So I stop here. If you feel you don't have time to read this book, just reach me in person and I'll tell you more.</p>
<p><br></p>
<p>But if you want to <strong>become better and more confident hacker</strong> in both life and software, <strong><a href="https://www.amazon.com/Third-Door-Uncover-Successful-Launched-ebook/dp/B076NS2JSW">download first chapter</a> for free</strong> and see if it fits you.</p>
<p><br><br></p>
<p>Happy hacking!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/10/15/what-is-your-third-door-book-review</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 15 Oct 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/10/15/what-is-your-third-door-book-review#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Hi, my name is Tom - Concat vs. Sprintf vs. In-String Variable ]]></title>
                <link>https://tomasvotruba.com/blog/2018/10/11/hi-my-name-is-tom-conctat-vs-in-sprintf-vs-in-string-variables</link>
                <description><![CDATA[ <p>My recent post about <a href="/blog/2018/09/17/7-tips-to-write-exceptions-everyone-will-love/">lovely exceptions</a> opened very interesting question. <a href="/blog/2018/09/17/7-tips-to-write-exceptions-everyone-will-love/#comment-4100904216">In comments bellow the post</a>, <a href="https://www.reddit.com/r/PHP/comments/9hehv6/7_tips_to_write_exceptions_everyone_will_love/e6d3hic">in Reddit thread</a> and <a href="https://mobile.twitter.com/geekovo/status/1043185111309713408">on  Twitter</a>.
<br>
<br>
A questions about <strong>connecting string with variables</strong>.
You have 3 options. Each has its strong and weak points. How do you pick the right one?</p> ]]></description>
                <content:encoded><![CDATA[ <p>In how many ways you can register a service in Symfony or call a service method in Laravel?
PHP and PHP frameworks are so free, that you often have 3+ ways to do one 1 thing. But that comes with a price.</p>
<p><strong>The more approaches you use, the more has to the reader learn about rules of coding and the less space he or she has for real algorithms</strong>. You can be really cool by using marginal PHP features, but if nobody except you understands it, you only hurt your code.</p>
<h2 id="How-to-Pick-The-Best-Solution">How to Pick The Best Solution?</h2>
<p>Instead of using what you already use (the most common non-sense argument for everything), try to imagine that <strong>your colleague is about to create a pull-request with PHP features you've never seen before</strong>.</p>
<p>What should it be like?</p>
<ul>
<li><strong>easy to learn</strong></li>
<li><strong>easy to maintain</strong> = changed by somebody else who might see it for the first time</li>
<li><strong>hard to fuck up</strong></li>
</ul>
<p><br></p>
<p>Let's try the simplest example possible:</p>
<blockquote class="blockquote text-center">
    "Hi, my name is Tom."
</blockquote>
<h2 id="1-Easy-To-Learn">1. Easy To Learn</h2>
<pre><code class="language-php">&lt;?php

$name = 'Tom';

# 1. concat
$message = 'Hi, my name is ' . $name;

# 2. sprintf
$message = sprintf('Hi, my name is %s', $name);

# 3. in-string variable
$message = 'Hi, my name is $name';</code></pre>
<h3 id="Concat">✅ Concat</h3>
<p>Just like a <code>+</code> for numbers, but for strings.</p>
<h3 id="Sprintf">❌ Sprintf</h3>
<p>What the hell is <code>%s</code>? I'd have to read <a href="http://php.net/manual/en/function.sprintf.php">the manual</a>... <code>%s</code> for strings, <code>%d</code> for numbers.</p>
<h3 id="In-String-Variable">✅ In-String Variable</h3>
<p>I guess I copy the variable inside the string.</p>
<h2 id="2-Easy-To-Maintain">2. Easy To Maintain</h2>
<p>Let's say, I'd like to tell more about myself.</p>
<pre><code class="language-diff"> &lt;?php

 $name = 'Tom';
+$love = 'PHP';

 # 1. concat
-$message = 'Hi, my name is ' . $name;
+$message = 'Hi, my name is ' . $name . ' and I love ' . $love;

 # 2. sprintf
-$message = sprintf('Hi, my name is %s', $name);
+$message = sprintf('Hi, my name is %s and I love %s', $name, $love);

 # 3. in-string variable
-$message = 'Hi, my name is $name';
+$message = 'Hi, my name is $name and I love $love';</code></pre>
<p>Or quote the name to express it's a variable string:</p>
<pre><code class="language-diff"> &lt;?php

 $name = 'Tom';
 $love = 'PHP';

 # 1. concat
-$message = 'Hi, my name is ' . $name . ' and I love ' . $love;
+$message = 'Hi, my name is "' . $name . '" and I love ' . $love;

 # 2. sprintf
-$message = sprintf('Hi, my name is %s and I love %s', $name, $love);
+$message = sprintf('Hi, my name is "%s" and I love %s', $name, $love);

 # 3. in-string variable
-$message = 'Hi, my name is $name and I love $php';
+$message = 'Hi, my name is "$name" and I love $php';</code></pre>
<h3 id="Concat">❌ Concat</h3>
<p>1 new element = 2 new dots <code>.</code>. I have to think where to put it. Imagine there will be 4 elements one day.
I also type like a dyslexic, so seeing <code>'"'</code> hurts.</p>
<h3 id="Sprintf">✅ Sprintf</h3>
<p>Nice to read.</p>
<h3 id="In-String-Variable">✅ In-String Variable</h3>
<p>Still the same.</p>
<h2 id="3-Hard-to-Fuck-Up">3. Hard to Fuck Up</h2>
<h3 id="Concat">❌ Concat</h3>
<pre><code class="language-php">&lt;?php

$name = 'Tom';
$love = 'PHP';
$also =  'to travel';

$message = 'Hi, my name is ' . $name . ' and I love ' . $love . 'and also' . $also;</code></pre>
<p>Can you spot it? This already happened me million times. I never make extra spaces anywhere else in the code.</p>
<h3 id="Sprintf">✅ Sprintf</h3>
<p>This also happens...</p>
<pre><code class="language-php">&lt;?php

$name = 'Tom';
$love = 'PHP';

$message = sprintf('Hi my name is %s and I love %s', $name);
// PHP Warning: sprintf(): Too few arguments</code></pre>
<p>...or this...</p>
<pre><code class="language-php">&lt;?php

$name = 'Tom';
$love = 'PHP';

$message = sprintf('Hi my name is %s and I love s', $name, $love);
// PHPStan: Call to sprintf contains 1 placeholder, 2 values given.</code></pre>
<p>...but PHP and PHPStan got us covered.</p>
<h3 id="In-String-Variable">❌❌ In-String Variable</h3>
<p>I must confess, I've tricked you (and myself too until I tried <a href="https://3v4l.org/RXpu1">running the code</a>):</p>
<img src="/assets/images/posts/2018/connect-strings/quote-fuckup.png" class="img-thumbnail">
<p><strong>And PHP tells you... <em>nothing</em>, it happily prints the wrong strings.</strong></p>
<p>From removing magic quotes, I'm very happy that I don't have to think about what is really working.</p>
<p>This problem is <a href="http://php.net/manual/en/migration70.incompatible.php#migration70.incompatible.variable-handling.indirect">mentioned in PHP Doc</a> though, but who of you even read what <code>%f</code> in <code>sprintf</code> stands for:</p>
<img src="/assets/images/posts/2018/connect-strings/php-fuckup.png" class="img-thumbnail">
<p>And what about this, will it be escaped?</p>
<img src="/assets/images/posts/2018/connect-strings/escaped.png" class="img-thumbnail">
<p>Why stopping there. What about <strong>method calls</strong>?</p>
<pre><code class="language-php">&lt;?php

$nameProvider = new NameProvider();

# 1. concat
$message = 'Hi, my name is ' . $nameProvider-&gt;provide();

# 2. sprintf
$message = sprintf('Hi, my name is %s', $nameProvider-&gt;provide());

# 3. in-string variable
$message = 'Hi, my name is $nameProvider-&gt;provide()';
$message = 'Hi, my name is ${nameProvider}-&gt;provide()';
$message = 'Hi, my name is ${nameProvider-&gt;provide()}';
$message = 'Hi, my name is {$nameProvider-&gt;provide()}';
# ?</code></pre>
<p>This is so complex, that there is even a <strong>coding standard fixer for such cases</strong>:</p>
<img src="/assets/images/posts/2018/connect-strings/fixer.png" class="img-thumbnail">
<p>Next image is not exclusively related to strings, but it shines the same <em>instant coolness</em> that will hunt you down later:</p>
<img src="/assets/images/posts/2018/connect-strings/fuckup.png">
<p>And it's a hell to upgrade such a code (even with Rector). Read more about it in <a href="https://secure.php.net/manual/en/language.types.string.php#language.types.string.parsing">PHP Doc</a></p>
<p><br></p>
<h2 id="Whatever-You-Pick-Stick-With-It">✅ Whatever You Pick, Stick With It</h2>
<p>We all <strong>start with one approach, then jump to another whenever we need</strong>. <em>Damn you, brain!</em></p>
<p>That's how such code is born:</p>
<img src="/assets/images/posts/2018/connect-strings/dual.png" class="img-thumbnail">
<p>And your code readers will have to think:</p>
<ul>
<li>Is there some hidden reason I don't know?</li>
<li>When is the line?</li>
<li>What to use when?</li>
</ul>
<p><a href="https://www.amazon.com/Dont-Make-Me-Think-Usability/dp/0321344758">Don't make them think</a> and stick with one approach in your code.
Your readers will have <strong>50 % more brain energy to improve your code</strong> then they'd have otherwise.</p>
<p><br></p>
<p>But still, <strong>which one of</strong>...</p>
<ul>
<li>concat</li>
<li><code>sprintf</code></li>
<li>in-string variable</li>
</ul>
<p>...<strong>is your favorite and why?</strong> Tell me in comments, I've definitely missed many fuckups.</p>
<p><br></p>
<p>Happy connecting!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/10/11/hi-my-name-is-tom-conctat-vs-in-sprintf-vs-in-string-variables</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 11 Oct 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/10/11/hi-my-name-is-tom-conctat-vs-in-sprintf-vs-in-string-variables#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ New in Symplify 5: Create, Merge and Split Monorepo with 1 Command ]]></title>
                <link>https://tomasvotruba.com/blog/2018/10/08/new-in-symplify-5-create-merge-and-split-monorepo-with-1-command</link>
                <description><![CDATA[ <p>Do you want to create, validate and manage your monorepo like a pro? There is no science behind it, just a few routine steps that you need to repeat.
<br><br>
And now there is a <strong>tool that will handle these steps for you</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>This package was initially released in Symplify 4.5, but it took some time to test in practice, remove WTFs and be sure it contains all people need.</p>
<p>Now there are 7 commands in total, but today we'll focus <strong>on the 4 most important ones</strong>.</p>
<p>First, install this package to an empty repository:</p>
<pre><code class="language-bash">composer require symplify/monorepo-builder --dev</code></pre>
<h2 id="1-Create-Your-Monorepo">1. Create Your Monorepo</h2>
<p>You'll run this command <strong>just once</strong> to create a monorepo in the empty repository.</p>
<pre><code class="language-bash">vendor/bin/monorepo-builder init</code></pre>
<p>It will prepare basic monorepo structure with 2 packages:</p>
<pre><code class="language-bash">/packages
    /first-package
        /src
        composer.json
    /second-package
        /src
        composer.json
composer.json
monorepo-builder.yml # basic configuration</code></pre>
<p>Use <code>composer.json</code> as you know it for most sections. But to manage <strong><code>require</code>, <code>require-dev</code>, <code>autoload</code> and <code>autoload-dev</code></strong> sections use only <code>/packages/first-package/composer.json</code>, <code>/packages/second-package/composer.json</code> like they were standalone packages.</p>
<p>Extra - mostly-dev - dependencies are managed by <code>monorepo-builder.yml</code>.</p>
<p>Is that unclear to you? Don't worry, you'll see how it works in <code>merge</code> command below.</p>
<h2 id="2-Validate-it">2. Validate it</h2>
<p>This command will tell you if your dependency versions are the same in every packages' <code>composer.json</code> and in root <code>composer.json</code>.</p>
<pre><code class="language-bash">vendor/bin/monorepo-builder validate</code></pre>
<img src="/assets/images/posts/2018/symplify-5-monorepo-builder/validate.png" class="img-thumbnail">
<p>You don't have to run this command manually since it's included in the next one.</p>
<h2 id="3-Merge-composer-json">3. Merge <code>composer.json</code></h2>
<pre><code class="language-bash">vendor/bin/monorepo-builder merge</code></pre>
<p>Here you'll understand the magic from <code>init</code> command. With <code>merge</code> command, the Monorepo Builder will join all packages' <code>composer.json</code> - after validation of course.</p>
<p>And what about extra dependencies like PHPUnit, coding standards and static analysis?</p>
<pre><code class="language-yaml"># monorepo-builder.yml
parameters:
    # for "merge" command
    data_to_append:
        require-dev:
            phpunit/phpunit: '^7.3'</code></pre>
<p>That's what <code>data_to_append</code> section is for. These packages and versions will be added to <code>composer.json</code>.</p>
<p><em>Btw, all packages are nicely sorted by name so you always find them quickly.</em></p>
<h3 id="Do-you-Want-to-Know-More">Do you Want to Know More?</h3>
<p>Discover other commands:</p>
<pre><code class="language-bash">vendor/bin/monorepo-builder</code></pre>
<p>and read <a href="https://github.com/symplify/monorepobuilder"><code>README</code></a> for detail usage and tricks.</p>
<p><br></p>
<p>Happy monorapping!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/10/08/new-in-symplify-5-create-merge-and-split-monorepo-with-1-command</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 08 Oct 2018 00:00:00 +0000</pubDate>
                                    <updated>2020-12-01UTC00:00:000</updated>
                    <atom:updated>Tue, 01 Dec 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Tue, 01 Dec 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/10/08/new-in-symplify-5-create-merge-and-split-monorepo-with-1-command#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ New in Symplify 5: Public Method Order and External Final in CodingStandard ]]></title>
                <link>https://tomasvotruba.com/blog/2018/10/04/new-in-symplify-5-public-method-order-and-external-final-in-coding-standard</link>
                <description><![CDATA[ <p>Coding Standard 5 replaced fixers that renamed classes with more tolerant sniffs. What else is there?
<br>
New config options <strong>that shorten your config file</strong> and <strong>2 new checkers to keep your code in order</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Don't you have this package installed yet?</p>
<pre><code class="language-bash">composer require symplify/coding-standard --dev</code></pre>
<p>Now enjoy the news ↓</p>
<h2 id="3-Final-for-3rd-Party-Classes">3. Final for 3rd Party Classes</h2>
<p>If you're strict enough to <code>final</code> or <code>abstract</code> everywhere, you'll love this. Sometimes 3rd party code is not <code>final</code>, but you'd love to never see that class in your code - Abstract Controller, Abstract Doctrine Repository or Abstract Object.</p>
<p>Those <code>abstract</code> classes are full of <strong>magic everyone has to <a href="/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock/">remember</a></strong>. What if you could <strong>prevent that spreading to your code without constant code-reviews</strong>?</p>
<p>Let PHPStan rule do the job:</p>
<pre><code class="language-yaml"># phpstan.neon
rules:
    - Symplify\CodingStandard\Rules\ForbiddenParentClassRule

parameters:
    symplify:
        forbidden_parent_classes:
            - 'Doctrine\ORM\EntityRepository'
            - 'Doctrine\Bundle\DoctrineBundle\Repository\ServiceEntityRepository'</code></pre>
<p>This will prevent over-inheritance and embrace composition - like in <a href="/blog/2017/10/16/how-to-use-repository-with-doctrine-as-service-in-symfony/">Repositories as Services</a> approach:</p>
<p>❌</p>
<pre><code class="language-php">&lt;?php

use Doctrine\ORM\EntityRepository;

final class ProductRepository extends EntityRepository
{
}</code></pre>
<p>✅</p>
<pre><code class="language-php">&lt;?php

use Doctrine\ORM\EntityRepository;

final class ProductRepository
{
    /**
     * @var EntityRepository
     */
    private $entityRepository;

    public function __construct(EntityRepository $entityRepository)
    {
        $this-&gt;entityRepository = $entityRepository;
    }
}</code></pre>
<p><br></p>
<p>That's all folks. Happy sniffing!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/10/04/new-in-symplify-5-public-method-order-and-external-final-in-coding-standard</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 04 Oct 2018 00:00:00 +0000</pubDate>
                                    <updated>2020-08-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Aug 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Aug 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/10/04/new-in-symplify-5-public-method-order-and-external-final-in-coding-standard#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ New in Symplify 5: Generate Rich, Precise and Smart Changelog in Seconds ]]></title>
                <link>https://tomasvotruba.com/blog/2018/10/01/new-in-symplify-5-generate-rich-precise-and-smart-changelog-in-seconds</link>
                <description><![CDATA[ <p>ChangelogLinker started as a small tool to complete links to PRs, authors, and versions in <code>CHANGELOG.md</code>. Then it started to <a href="/blog/2018/06/25/let-changelog-linker-generate-changelog-for-you/">generate</a> the <code>CHANGELOG.md</code>.
<br><br>
<strong>Where is now and how to start using it?</strong></p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Tested-on-Humans">Tested on Humans ✅</h2>
<p><a href="https://github.com/shopsys/shopsys/pull/446/files" class="btn btn-dark btn-sm mt-2">
See pull-request #446 on Shopsys
</a></p>
<blockquote class="blockquote text-center">
    "If you're not embarrassed by the first version of your product,<br>
    you've launched too late."
    <footer class="blockquote-footer"><a href="https://www.linkedin.com/pulse/arent-any-typos-essay-we-launched-too-late-reid-hoffman">Reid Hoffman</a>, Founder of Linkedin</footer>
</blockquote>
<p>The first version of any software is how the author(s) think people will use it. It's like trying to see the future of people you've never met. That's why the first version is <strong>better done than perfect</strong>. The important part is to <strong>collect feedback as soon as possible and improve based</strong> on it.</p>
<p>Saying that I recommended ChangelogLinker to Shopsys to manage news in their <a href="https://github.com/shopsys/shopsys">monorepo</a>. In exchange, I got informative and clear feedback with creative ideas on how to solve it from <a href="https://github.com/vitek-rostislav">Rostislav Vitek</a> and <a href="https://github.com/petrheinz">Petr Heinz</a>. <strong>Huge thanks for making this tool better belongs to you guys</strong>.</p>
<p><br></p>
<p>First, install this package:</p>
<pre><code class="language-bash">composer require symplify/changelog-linker --dev</code></pre>
<h2 id="1-Multiple-CHANGELOG-md-for-Smaller-Versions">1. Multiple <code>CHANGELOG.md</code> for Smaller Versions</h2>
<p><a href="https://github.com/symplify/symplify/pull/1047/files#diff-3b69acbe6b33a88158b373e6e96de097" class="btn btn-dark btn-sm">
See pull-request #1047
</a></p>
<p>If you have more than 2 major versions, your changelog can be really long and hard to orientate. Some people want to see the news in your version 3, some are still using version 1 and need to upgrade gradually.</p>
<p>I got this inspiration from Symfony, where they have *<em>own CHANGELOG per minor versions</em>:</p>
<pre><code class="language-bash">CHANGELOG-4.0.md
CHANGELOG-4.1.md</code></pre>
<p>Good idea to keep files not huge and clear. So <strong>Now</strong> it's possible to work with each CHANGELOG file separately - just use file path as the first argument of any command:</p>
<pre><code class="language-php">vendor/bin/changelog-linker link # "CHANGELOG.md" is used
vendor/bin/changelog-linker link CHANGELOG-2.md
vendor/bin/changelog-linker link CHANGELOG-3.md</code></pre>
<h2 id="2-Smarter-Last-Change-Detection">2. Smarter Last Change Detection</h2>
<p><a href="https://github.com/symplify/symplify/commit/05d91b9412ebec49a66a4717d856a5a2c6718232" class="btn btn-dark btn-sm">
See commit
</a></p>
<p>This package generates changelog from merged PRs, that are not mentioned in your <code>CHANGELOG.md</code> yet.</p>
<pre><code class="language-bash">vendor/bin/changelog-linker dump-merges</code></pre>
<p><strong>Before</strong> it looks for the highest merged PR ID and added only PRs with higher id. But what if you merge PR with number 1000, but number 990 is still opened due to longer code review?</p>
<p><strong>Now</strong> it works with the <code>merged_at</code> instead, so no merged PR is left behind.</p>
<h2 id="3-Remove-Dead-Links">3. Remove Dead Links</h2>
<p><a href="https://github.com/symplify/symplify/pull/1045/files" class="btn btn-dark btn-sm">
See pull-request #1045
</a></p>
<p>This is the best command to start with when you install this package for the first time.</p>
<p><code>CHANGELOG.md</code> can be edited, items removes, shifter above or links duplicated. To keep it fit and slim, you'd have to check this manually with every link. And believe me, if you have 500+ PRs, 50+ contributors and 30+ versions, it's not as fun as you imagine.</p>
<p>That's where &quot;cleanup&quot; rocks:</p>
<pre><code class="language-bash">vendor/bin/changelog-linker cleanup

# again, you can use the file as argument
vendor/bin/changelog-linker cleanup CHANGELOG-2.md</code></pre>
<p>In Symplify <code>CHANGELOG.md</code> itself it <a href="https://github.com/symplify/symplify/pull/1045/files#diff-4ac32a78649ca5bdd8e0ba38b7006a1e">removed 50 dead lines</a>.</p>
<h2 id="4-Improved-Category-Detection">4. Improved Category Detection</h2>
<p><a href="https://github.com/symplify/symplify/pull/1064/files#diff-2ee93fc74523d03ea046d5419ae75a9a" class="btn btn-dark btn-sm">
See pull-request #1064
</a></p>
<p><small>
Thanks to <a href="https://github.com/petrheinz">Petr Heinz</a> ❤️️
</small></p>
<p><br></p>
<p>When you generate a <code>CHANGELOG.md</code> you can use <code>--in-categories</code> option:</p>
<pre><code class="language-bash">vendor/bin/changelog-linker dump-merges --in-categories</code></pre>
<p>It will assign PRs to one of 4 categories: <em>Added</em>, <em>Fixed</em>, <em>Changed</em> and <em>Removed</em>. I didn't make them up, it's a standard taken from <a href="https://keepachangelog.com/en/1.0.0">keepachangelog.com</a>.</p>
<p><strong>How it works?</strong> It uses regex to detect keywords in the pull-request title, e.g.</p>
<p><code>Added "cleanup" command</code> → Added
<code>Remove dead links</code> → Removed
<code>Fix ID detection</code> → Fixed</p>
<p>You can see all the regexes in <a href="https://github.com/symplify/symplify/blob/v5.0.0/packages/ChangelogLinker/src/ChangeTree/Resolver/CategoryResolver.php"><code>CategoryResolver</code></a>.</p>
<p>Peter added many keywords, but also showed me a new trick : <strong>the <a href="https://www.regular-expressions.info/wordboundaries.html"><code>\b</code> wrapper</a></strong>:</p>
<pre><code class="language-bash">-private const ADDED_PATTERN = '#(add|added|adds) #i';
+private const ADDED_PATTERN = '#\b(add(s|ed|ing)?)\b#i';</code></pre>
<p>It means, that words need to be standalone. Not part of any other string.
Regex <code>\b(is)\b</code> applied to <code>"This island is beautiful"</code> returns <code>["is"]</code>.</p>
<p>A very nice trick that made detection much more precise. Thanks, Peter!</p>
<p><br></p>
<p>Happy changing!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/10/01/new-in-symplify-5-generate-rich-precise-and-smart-changelog-in-seconds</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 01 Oct 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/10/01/new-in-symplify-5-generate-rich-precise-and-smart-changelog-in-seconds#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Open-Source Behind The Scenes - Finding the Rector Vision ]]></title>
                <link>https://tomasvotruba.com/blog/2018/09/27/open-source-behind-the-scenes-finding-the-rector-vision</link>
                <description><![CDATA[ <p>Open-source is not only about programming, maintaining, adding new features and spreading the word. It's also about other decisions of the maintainer, that are hidden from users.
<br><br>
I often ask myself: What values should it spread around the world? Where do I take time and money to develop it? How should it scale? How to make it useful to both people and me?</p> ]]></description>
                <content:encoded><![CDATA[ <p>It's not always easy to work with community feedback, as opinions and needs are often unique, sometimes contradictory. Sometimes clean-code kills growth, sometimes it's the legacy.</p>
<p>To give you a little <strong>insight into maintainer's mind</strong>, I'll share a letter I've to send to Symfony guys where I sum up events of recent months.</p>
<p><br></p>
<p>&quot;...thank you for your reply. It gave me a very nice kick and more energy to my blood to work on this.</p>
<p>Sorry for my late reply, but I had to explore my vision with Rector a lot. I had to face many blinds paths and demons.</p>
<p>I held talks in Berlin, Vienna, and Pardubice during past 3 months and had to think a lot about the following direction. I talked with Dan Leech, author of <a href="https://github.com/phpactor/phpactor">phpactor</a> (~= Rector as a plugin for Vim) and from Nils Adermann with insights from Private Packagist. I got plenty of feedback, offline and online.</p>
<p>Many people told me to go to the &quot;Symfony&quot; shift. It would make money, it would save bug reports from people since I'd be the one to manage it and I could invest that money to grow Rector a more.</p>
<p>But then <strong>I got feedback from more communities</strong>. I'm in touch with the CakePHP community. In last week I made this config that can do <a href="https://github.com/rectorphp/rector/pull/634/files#diff-66bde3273ac825a92cf71b2e0bb9f674">140 changes in Cake PHP 3.4</a>.</p>
<blockquote class="blockquote text-center">
    Everyone is having the same problem: <strong>they need to move fast wide-spread legacy code in their growing communities</strong>.
</blockquote>
<p>Also, a company from Vienna invited me again, sponsored my travel + stay and <a href="https://github.com/nikic/PHP-Parser/pull/533">we made live PR to php-parser in a matter of 30 seconds</a>. It got merged 2 days after. The company itself is almost finished with a migration of private legacy code to Laravel and they were interested in Rector's features.</p>
<p>Have you seen &quot;safe&quot; package in Github trends? Rector is now <a href="https://github.com/thecodingmachine/safe#automated-refactoring">helping people to migrate their code</a>.</p>
<p>Yes, I could go to one community and help only them to make the migration almost flawless. But now I see many communities using Rector creative way I could never think of. Also, I'm not doing this for money (like ClangMR from Google or Larashift), but so programmers can be free with the most recent version of the framework they love.</p>
<p>So, for now, I'm deciding to stay open, help here and there little with projects that come along, and see what inspiration it brings to people...&quot;</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/09/27/open-source-behind-the-scenes-finding-the-rector-vision</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 27 Sep 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/09/27/open-source-behind-the-scenes-finding-the-rector-vision#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ New in Symplify 5: 3 News in EasyCodingStandard to Smoother Your Experience ]]></title>
                <link>https://tomasvotruba.com/blog/2018/09/24/new-in-symplify-5-3-news-in-easy-coding-standard-to-smoother-your-experience</link>
                <description><![CDATA[ <p>Let's get lazier and lazier.</p> ]]></description>
                <content:encoded><![CDATA[ <p>You don't have this package installed yet?</p>
<pre><code class="language-bash">composer require symplify/easy-coding-standard --dev</code></pre>
<p>Now enjoy the news ↓</p>
<h2 id="1-Friendlier-Skips">1. Friendlier Skips</h2>
<p><a href="https://github.com/symplify/symplify/pull/948/files" class="btn btn-dark btn-sm">
See pull-request #948
</a></p>
<p>Little details make more pleasant developer experience UX. You already know <strong>you can use  <a href="http://php.net/manual/en/function.fnmatch.php"><code>fnmatch()</code></a> for skipping files</strong>. The problem is, it requires very specific format people struggle with and often end up using explicit 10 paths to many files.</p>
<p><strong>Before</strong> you had to hit the format:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\EasyCodingStandard\ValueObject\Option;

return function (ContainerConfigurator $containerConfigurator): void {
    $parameters = $containerConfigurator-&gt;parameters();

    $parameters-&gt;set(Option::SKIP, [
        SomeFixer::class =&gt; [
            // this worked
            '*src/*CaseConverter.php',

            // this didn't work
            'src/*CaseConverter.php',
        ]]
    );
};
</code></pre>
<p><strong>Now</strong> you can use your intuition, copy paste the filename from error result and both versions work.</p>
<h2 id="2-In-Lazy-We-Trust">2. In Lazy We Trust</h2>
<p><a href="https://github.com/symplify/symplify/pull/832/files" class="btn btn-dark btn-sm">
See pull-request #832
</a></p>
<p><strong>Before</strong> you had to type the whole config name and use YAML:</p>
<pre><code class="language-bash">easy-coding-standard.yaml
easy-coding-standard.yml</code></pre>
<p>As you've already noticed, <strong>now</strong> you can use short version with <strong>normal PHP - <code>ecs.php</code></strong>:</p>
<h2 id="3-Are-There-Some-and-quot-array-and-quot-Checkers">3. Are There Some &quot;array&quot; Checkers?</h2>
<p><a href="https://github.com/symplify/symplify/pull/967/files" class="btn btn-dark btn-sm">
See pull-request #967
</a></p>
<p>Many people asked for an overview of all checkers there are, if there any related to an array, to <code>strict_types</code> position and so on.</p>
<p><strong>Before</strong> you had to go to huge <code>README.md</code> files of PHP CS Fixer and PHP_CodeSniffer on Github to read it all. But <strong>why leave the luxury of CLI if these checkers are already downloaded</strong> on your machine?</p>
<p><strong>Now</strong> you can use &quot;find&quot; command:</p>
<img src="/assets/images/posts/2018/symplify-5-ecs/find.gif" class="img-thumbnail">
<p>Next time you'll wonder what are &quot;Symplify&quot; rules, keep your browser closed and just find them:</p>
<pre><code class="language-bash">vendor/bin/ecs find symplify</code></pre>
<p><br></p>
<p>Enjoy laziness, intuitive use and faster access to the information you look for.</p>
<p>We'll continue to make it this way!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/09/24/new-in-symplify-5-3-news-in-easy-coding-standard-to-smoother-your-experience</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 24 Sep 2018 00:00:00 +0000</pubDate>
                                    <updated>2020-08-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Aug 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Aug 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/09/24/new-in-symplify-5-3-news-in-easy-coding-standard-to-smoother-your-experience#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ New in Symplify 5: 3 New Cool Features of PackageBuilder ]]></title>
                <link>https://tomasvotruba.com/blog/2018/09/20/new-in-symplify-5-3-new-cool-features-of-package-builder</link>
                <description><![CDATA[ <p><a href="https://github.com/symplify/package-builder">PackageBuilder</a> was always sort of meta package with all <strong>the cool and shiny features anyone can use</strong>. After all, it's the most downloaded Symplify package hitting almost <a href="https://packagist.org/packages/symplify/package-builder/stats">1000 downloads a day</a>.
<br>
<br>
In Symplify 5 now it allows you to <strong>drop manual binds</strong> from Symfony configs, separate files from directories <strong>in one method</strong> and merge nested YAML parameters <strong>with 1&nbsp;service</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>You don't have this package installed yet?</p>
<pre><code class="language-bash">composer require symplify/package-builder</code></pre>
<p>Now enjoy the news ↓</p>
<h2 id="1-Drop-Manual-Binds-in-Symfony-configs">1. Drop Manual Binds in Symfony configs</h2>
<p><a href="https://github.com/symplify/symplify/pull/998" class="btn btn-dark btn-sm">
See pull-request #998
</a></p>
<p>You can add <a href="https://symfony.com/blog/new-in-symfony-3-4-local-service-binding">parameter binding since Symfony 3.4</a>:</p>
<pre><code class="language-yaml">services:
    _defaults:
        bind:
            $meetupComApiKey: '%meetup_com_api_key%'</code></pre>
<p>That's nice. But what if you have multiple configs that use multiple parameters?</p>
<pre><code class="language-yaml">services:
    _defaults:
        bind:
            $meetupComApiKey: '%meetup_com_api_key%'
            $facebookApiKey: '%facebook_api_key%'
            $maxPostOnHomepage: '%max_post_on_homepage%'

    App\FirstPackage\:
        resource: ..</code></pre>
<pre><code class="language-yaml">services:
    _defaults:
        bind:
            $facebookApiKey: '%facebook_api_key%'
            $maxPostOnHomepage: '%max_post_on_homepage%'

    App\SecondPackage\:
        resource: ..</code></pre>
<h3 id="Not-for-Lazy-Programmer">Not for Lazy Programmer</h3>
<p>This way you'll be writing more bindings than there are parameters. And there is more! When you remove autodiscovered service that depends on a bound parameter, you'll get this &quot;nice&quot; exception:</p>
<blockquote class="blockquote">
    Unused binding "maxPostOnHomepage" in service "App\SomeUnterlatedService"
</blockquote>
<p>You can solve this all by having a huge config with all parameters, binding and services. Even if the config would be shorter than 100 lines, you still have to maintain parameters, bindings and services and it teaches other programmers to <em>put-everything-to-one-place</em> instead of SOLID principles.</p>
<p><br></p>
<p><strong>Would you like to get rid of this all extra maintenance, and just code cleanly instead?</strong> I would!</p>
<p>So, have you noticed the pattern?</p>
<ul>
<li><code>$variableName</code> &lt;=&gt; <code>%parameter_name</code></li>
<li><code>camelCase</code> &lt;=&gt; <code>underscore_case</code></li>
</ul>
<p>And exactly this can be automated! Just add <code>Symplify\PackageBuilder\DependencyInjection\CompilerPass\AutoBindParametersCompilerPass</code> compiler pass:</p>
<pre><code class="language-diff">&lt;?php

    // ...

 use Symfony\Component\DependencyInjection\ContainerBuilder;
 use Symfony\Component\HttpKernel\Kernel;
+use Symplify\PackageBuilder\DependencyInjection\CompilerPass\AutoBindParametersCompilerPass;

 final class YourAppKernel extends Kernel
 {
     // ...

+    protected function build(ContainerBuilder $containerBuilder): void
+    {
+        $containerBuilder-&gt;addCompilerPass(new AutoBindParametersCompilerPass());
+    }
 }</code></pre>
<p>And if you keep this convention, you can keep yours configs clear and minimalistic:</p>
<pre><code class="language-diff"> services:
-    _defaults:
-        bind:
-            $meetupComApiKey: '%meetup_com_api_key%'
-            $facebookApiKey: '%facebook_api_key%'
-            $maxPostOnHomepage: '%max_post_on_homepage%'</code></pre>
<p>Of course you can bind your parameters manually:</p>
<pre><code class="language-yaml">services:
    _defaults:
        bind:
            $anotherName: '%non_standard_parameter_naming%'

    SomeClass:
        arguments:
            - '%very_specfici_meetup_com_api_key%'</code></pre>
<h2 id="2-Separate-Files-from-Directories">2. Separate Files from Directories</h2>
<p><a href="https://github.com/symplify/symplify/pull/963" class="btn btn-dark btn-sm">
See pull-request #963
</a></p>
<p>Do you need to work multiple file/directories arguments?</p>
<pre><code class="language-bash">vendor/bin/ecs check src tests/ThisFile.php</code></pre>
<p>Just use <code>Symplify\PackageBuilder\FileSystem\FileSystem</code>:</p>
<pre><code class="language-php">&lt;?php

$sources = [
   __DIR__ . '/SomeDirectory',
   __DIR__ . '/SomeFile.php'
];

$symplifyFileSystem = new Symplify\PackageBuilder\FileSystem\FileSystem;
[$files, $directories] = $symplifyFileSystem-&gt;separateFilesAndDirectories($sources);

// ...</code></pre>
<h2 id="3-Merge-Parameters-without-Leaving-Any-Behind">3. Merge Parameters without Leaving Any Behind</h2>
<p><a href="https://github.com/symplify/symplify/pull/989" class="btn btn-dark btn-sm">
See pull-request #989
</a></p>
<p>At the moment, Symfony is unable to merge nested parameters <a href="https://github.com/symfony/symfony/issues/26713">for historical and other reasons</a>:</p>
<pre><code class="language-yaml"># config.yml
imports:
    - { resource: 'imported-file.yml' }

parameters:
    festivals:
        - three</code></pre>
<pre><code class="language-yaml"># imported-file.yml
parameters:
    festivals:
        - one
        - two</code></pre>
<p>This will end up with just 1 festival in classic Symfony Applicatoin. Do you want to use the <strong>full power of YAML, glob and imports</strong> and <strong>still keep all the parameters</strong>?</p>
<p>Use <code>Symplify\PackageBuilder\Yaml\ParameterMergingYamlLoader</code>:</p>
<pre><code class="language-php">&lt;?php

$parametersMergingYamlLoader = new Symplify\PackageBuilder\Yaml\ParameterMergingYamlLoader;
$parameterBag = $parametersMergingYamlLoader-&gt;loadParameterBagFromFile(
    __DIR__ . '/config.yml'
);

var_dump($parameterBag-&gt;get('festivals'));
// ['one', 'two', 'three']</code></pre>
<p><br></p>
<p>And that's all folks!</p>
<p><br></p>
<p>Happy tuning of your code!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/09/20/new-in-symplify-5-3-new-cool-features-of-package-builder</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 20 Sep 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/09/20/new-in-symplify-5-3-new-cool-features-of-package-builder#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 7 Tips to Write Exceptions Everyone Will Love ]]></title>
                <link>https://tomasvotruba.com/blog/2018/09/17/7-tips-to-write-exceptions-everyone-will-love</link>
                <description><![CDATA[ <p><code>InvalidArgumentException</code>, <code>FileNotFoundException</code>, <code>InternalException</code>.
<br><br>
Have you ever had that feeling, that <strong>you've seen that exception before and you know what it means and how to solve?</strong> What if that would be clear even for those who see it for the first time? It would save yours and their time.
<br><br>
Exceptions are not just error state. <strong>Exceptions are the new documentation</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>I wrote a <a href="/blog/2018/02/12/sleep-shorter-to-get-62-percent-smarter/">50-page thesis about polyphasic sleep</a>. My opponent told me, that there is a missing part about uncontrolled intervening values. The part in pages 34-36 he probably skipped. Today we have too much going on <strong>we have to scan</strong>. Anything longer than 140 chars is exhausting. Moreover for us programmers, who dance among tsunami of information coming every hour as they code and investigate code of others.</p>
<h3 id="Do-you-Find-this-and-quot-Circle-of-Code-and-quot-Familiar">Do you Find this &quot;Circle of Code&quot; Familiar?</h3>
<ol>
<li>you open the application</li>
<li>you code and code, life is great!</li>
<li>suddenly, it's broken by <code>InvalidStateException</code> exception (<a href="https://github.com/thecodingmachine/safe#the-problem">if we're lucky</a>)</li>
<li>you open exception in IDE to find out more... nothing</li>
<li>you open the documentation to find out more... nothing</li>
<li>you Google and StackOverflow to find out more... nothing</li>
<li>you close the application frustrated, have a ☕ or social joint to restore your will to overcome shit code</li>
</ol>
<p><strong>What if you could stay between 1, 2 and 3 much more often?</strong></p>
<p><br></p>
<p>When people used EasyCodingStandard for their first time, they experienced many WTFs. After 30&nbsp;minutes they gave up saying &quot;coding standards are hard&quot;. When I asked them to show me how they used it, <strong>it took me 3 minutes to solve</strong>. Why? Because I made it? Well maybe. But also because <strong>exceptions were so lousy, that nobody knew how to solve them</strong> and that's wrong. Shame on me.</p>
<h2 id="1-Make-Exception-Names-for-Humans">1. Make Exception Names for Humans</h2>
<p>Not machines but people read exceptions. Well, machines read it to but they just log it - humans have to make code work again.</p>
<blockquote class="blockquote">
    <em>InvalidStateException</em>
</blockquote>
<p>WTF? Could you be more clear?</p>
<blockquote class="blockquote">
     <em>ConfigurationFileNotFoundException</em>
</blockquote>
<p>A-ha, I create <code>ecs.php</code> and it works!</p>
<p><strong>+10 % happier programmer</strong></p>
<p>Do you need help with this? There is <a href="https://github.com/symplify/coding-standard#use-explicit-and-informative-exception-names-over-generic-ones">Sniff</a> that makes sure no exception is generic.</p>
<h2 id="2-Use-and-quot-around-and-quot-Statements">2. Use &quot; around&quot; Statements</h2>
<blockquote class="blockquote">
     <em>Filter class  VeryLongNamespace\InNestedNamespace\WithMissingClassInTheEnd was not found</em>
</blockquote>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $parameters = $containerConfigurator-&gt;parameters();
    $parameters-&gt;set('filters', [
        ' VeryLongNamespace\InNestedNamespace\WithMissingClassInTheEnd'
    ]);
};</code></pre>
<p>The class <strong>exists</strong> and it <strong>is</strong> autoloaded:</p>
<pre><code class="language-php">require_once __DIR__ . '/vendor/autolaod.php'

var_dump(class_exists(
    VeryLongNamespace\InNestedNamespace\WithMissingClassInTheEnd::class
));
// "true"</code></pre>
<p>So what is wrong?</p>
<p><br></p>
<p><em>5 minutes later...</em></p>
<pre><code class="language-diff"> &lt;?php

 declare(strict_types=1);

 use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

 return function (ContainerConfigurator $containerConfigurator): void {
     $parameters = $containerConfigurator-&gt;parameters();
     $parameters-&gt;set('filters', [
-        ' VeryLongNamespace\InNestedNamespace\WithMissingClassInTheEnd'
+        'VeryLongNamespace\InNestedNamespace\WithMissingClassInTheEnd'
     ]);
 };</code></pre>
<p>Ah, there was a space, a single small space!</p>
<p>You probably noticed it, because there are 3 lines of code and they get all your attention. In reality, there are 80 lines of code, 5 files opened in your IDE/brain and your colleague is asking you for wise advice, so your chances to spot this are much lower.</p>
<p><strong>How to prevent this from happening ever again to anyone in the world?</strong></p>
<blockquote class="blockquote">
     <em>Filter class  VeryLongNamespace\InNestedNamespace\WithMissingClassInTheEnd was not found</em>
</blockquote>
<p><em>Filter class &quot; VeryLongNamespace\InNestedNamespace\WithMissingClassInTheEnd&quot; was not found</em></p>
<p><strong>Use quotes around every argument:</strong></p>
<pre><code class="language-php">throw new FilterClassNotFoundException(sprintf(
    'Filter class "%s" was not found',
    $filterClass
));</code></pre>
<p><strong>+20 % happier programmer</strong></p>
<h2 id="3-What-Exactly-is-Wrong">3. What Exactly is Wrong?</h2>
<blockquote class="blockquote">
     <em>main parameter is invalid</em>
</blockquote>
<pre><code class="language-php">throw new InvalidParameterException(sprintf(
    '%s parameter is invalid.',
    $parameterName
));</code></pre>
<p>What parameter?</p>
<blockquote class="blockquote">
     <em>"main" parameter is invalid</em>
</blockquote>
<pre><code class="language-diff"> throw new InvalidParameterException(sprintf(
-    '%s parameter is invalid.',
+    '"%s" parameter is invalid.',
     $parameterName
));</code></pre>
<p>Aha! Where do I find it? In the &quot;parameters&quot; section?</p>
<blockquote class="blockquote">
     <em>Parameter in "parameters &gt; page_name &gt; main" is invalid</em>
</blockquote>
<pre><code class="language-php">throw new InvalidParameterException(sprintf(
    'Parameter in "parameters &gt; page_name &gt; %s" is invalid.',
    $parameterName
));</code></pre>
<p>Aha, now I know where to find it, thanks!</p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $parameters = $containerConfigurator-&gt;parameters();
    $parameters-&gt;set('page_name', [
        'main' =&gt; []
    ]);
};</code></pre>
<p><strong>+20 % happier programmer</strong></p>
<h2 id="4-What-is-The-Wrong-Value">4. What is The Wrong Value?</h2>
<blockquote class="blockquote">
     <em>Parameter in "parameters &gt; page_name &gt; main" is invalid</em>
</blockquote>
<p>We already know <em>where</em> it is, but <strong>what value it actually has</strong>?</p>
<blockquote class="blockquote">
     <em>Parameter value "false" in "parameters &gt; page_name &gt; main" is invalid</em>
</blockquote>
<p>I see, so &quot;main&quot; parameter can't have <code>false</code> value. What it <strong>can have</strong> then?</p>
<blockquote class="blockquote">
     <em>Parameter value "false" in "parameters &gt; page_name &gt; main" is invalid. It must be a string</em>
</blockquote>
<pre><code class="language-php">if (is_array($value)) {
    $value = 'array';
} elseif (is_bool($value)) {
    $value = ($value === true) ? 'true' : 'false';
}

throw new InvalidParameterException(sprintf(
    'Parameter value "%s" in "parameters &gt; page_name &gt; %s" is invalid. It must be a string.',
    $value,
    $parameterName
));</code></pre>
<p><strong>+15 % happier programmer</strong></p>
<p>Tip: You can use <a href="https://github.com/nette/tracy">Tracy</a> to delegate the value dumping.</p>
<h2 id="5-What-File-Exactly-is-Broken">5. What File Exactly is Broken?</h2>
<blockquote class="blockquote">
     <em>Invalid file</em>
</blockquote>
<p>In EasyCodingStandard, PHP_CodeSniffer, PHP CS Fixer, Rector or PHPStan there is always work with files. Is there some error with the file? Show it!</p>
<blockquote class="blockquote">
     <em>File /var/www/tomasvotruba.com/packages/src/TweetPublisher.php not found</em>
</blockquote>
<p>Oh, sorry:</p>
<blockquote class="blockquote">
     <em>File "/var/www/tomasvotruba.com/packages/src/TweetPublisher.php" not found</em>
</blockquote>
<p><strong>Absolute paths can be really long</strong> in Docker, CI or in the non-basic install. We don't need irrelevant information - every character counts!</p>
<p>How can we make it a bit more familiar to the user? Show the <strong>relative path</strong>:</p>
<blockquote class="blockquote">
     <em>File "packages/src/TweetPublisher.php" not found</em>
</blockquote>
<p><strong>How to do this nice and lazy in PHP?</strong></p>
<pre><code class="language-php">// "$filePath" can be absolute or relative; we don't care, it only must exists
$fileInfo = new SplFileInfo($filePath);

// remove absolute path start to cwd (current working directory)
$relativePath = substr($fileInfo-&gt;getRealPath(), strlen(getcwd()) + 1);

throw new FileProcessingException(sprintf(
    'File "%s" not found',
    $relativePath
));</code></pre>
<p><strong>+20 % happier programmer</strong></p>
<h2 id="6-What-Options-do-I-have">6. What Options do I have?</h2>
<pre><code class="language-bash">vendor/bin/finder show laravel</code></pre>
<blockquote class="blockquote">
     <em>"laravel" was not found</em>
</blockquote>
<ul>
<li>Is incorrectly loaded?</li>
<li>Should I register it somehow?</li>
<li>Where do I find these levels so I know what are available?</li>
</ul>
<p><a href="https://www.amazon.com/Dont-Make-Think-Revisited-Usability-ebook-dp-B00HJUBRPG/dp/B00HJUBRPG">Don't make the programmer think</a>!</p>
<blockquote class="blockquote">
     <em>Level "laravel" was not found. Pick one of: "symfony", "nette", "zend"</em>
</blockquote>
<p>That's better!</p>
<p>If there is the limited or reasonable amount of options, don't be shy. Show them!</p>
<pre><code class="language-php">$allOptions = $this-&gt;findAllLevelsInDirectory($configDirectory);

throw new OptionNotFoundException(sprintf(
    'Option "%s" was not found. Pick one of: "%s"',
    $optionName,
    implode('", "', $allOptions)
));</code></pre>
<p><strong>+40 % happier programmer</strong></p>
<h2 id="7-Link-what-You-can-t-Fit-140-Chars">7. Link what You can't Fit 140 Chars</h2>
<p>Sometimes you might find yourself writing a poem instead of an exception:</p>
<pre><code class="language-php">throw new ConfigurationFileNotFound(
    'Class not found. Configure autoload, you can use either `parameters &gt; autoload_files`' .
    'or `parameters &gt; autoload_directories`. Be careful to use paths relative to the file you are using.'
);</code></pre>
<p>Who would read that? Except for the author of course.</p>
<p>To make it shorted and readable, we end up with a lousy statement like:</p>
<pre><code class="language-php">throw new ConfigurationFileNotFound('Class not found. Configure autoload first.');</code></pre>
<p>10 Tweets = 1 post, so just link it!</p>
<pre><code class="language-php">throw new ConfigurationFileNotFound(
    'Class not found. Configure autoload: https://github.com/rectorphp/rector/blob/master/README.md'
);</code></pre>
<p>A bit more perfect? <strong>Use headline anchor</strong>:</p>
<pre><code class="language-php">throw new ConfigurationFileNotFound(
    'Class not found. Configure autoload: https://github.com/rectorphp/rector/blob/master/README.md#extra-autoloading'
);</code></pre>
<p>Here is one pitfall - end of lines and line breaks in CLI. You might end up with this error message:</p>
<pre><code class="language-bash">https://github.com/rectorphp/rector/blob/
master/README.md#extra-autoloading</code></pre>
<p>Where only <code>https://github.com/rectorphp/rector/blob/</code> is a link. Invalid link.</p>
<p>How to save this?</p>
<pre><code class="language-php">throw new ConfigurationFileNotFound(
    'Class not found. Configure autoload:' .
    PHP_EOL .
    'https://github.com/rectorphp/rector/blob/master/README.md#extra-autoloading'
);</code></pre>
<p>Kaboom!</p>
<p><strong>+30 % happier programmer</strong></p>
<p><br></p>
<p>And in these 7 steps, you just made any programmer using your code 125 % happier!</p>
<p><strong>What are your the most favorite exceptions?</strong></p>
<p><br></p>
<p>Happy throwing!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/09/17/7-tips-to-write-exceptions-everyone-will-love</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 17 Sep 2018 00:00:00 +0000</pubDate>
                                    <updated>2020-11-01UTC00:00:000</updated>
                    <atom:updated>Sun, 01 Nov 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sun, 01 Nov 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/09/17/7-tips-to-write-exceptions-everyone-will-love#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Your Brain is Your Garden ]]></title>
                <link>https://tomasvotruba.com/blog/2018/09/13/your-brain-is-your-garden</link>
                <description><![CDATA[ <p>After a few technical and open-source posts, it's time <a href="/blog/2018/05/03/how-do-you-treat-your-own-first-ai/">for brain hacking</a>. Thanks to the recent boom of AI, neuroscience starts to overlap with human psychology. When it comes to learning methods, humans and computers are more alike than ever before.
<br><br>
To overcome <a href="/blog/2017/12/04/life30-what-will-you-do-when-ai-takes-over-the-world/">AI disruption</a>, you'll be valuable by actually making AI or by hacking your brain to be super-adaptable and irreplaceable.</p> ]]></description>
                <content:encoded><![CDATA[ <p><em>This post consists of my personal experience and few books with research background. If you feel you need more science behind this, you can read <a href="https://www.amazon.com/gp/product/B00435DZ7S">The Happiness Advantage</a>, <a href="http://calnewport.com/books/deep-work">Deep Work</a> and <a href="https://www.amazon.com/Life-3-0-Being-Artificial-Intelligence-ebook-dp-B07474JB3Q/dp/B07474JB3Q">Life 3.0</a>.</em></p>
<p>I'm a father of 3,5-year-old that is in Czech educational system for last 1 year on one hand, a close observer of programming, machine learning, artificial intelligence on other hand and mentor, <a href="http://friendsofphp.org">Europe PHP-meetup traveler</a> that observes and helps people learning on the third hand.</p>
<p>In all these communities I see one common pattern - <strong>they all try to learn, adapt and teach as effectively as they can</strong>. Yet they each have <strong>own believes that holds them back</strong>. What a wonder  jump in human history would be a conference, where human-teachers learn from programmers about the most effective way to teach a machine various skills, and where programmers learn from teachers about the effect of long-term reinforced learning. <strong>Both groups could learn so much from each other's mistakes</strong>, instead of repeating them.</p>
<p>But let's get back to you, my dear reader, and your <a href="http://calnewport.com/blog/2017/11/30/on-the-complicated-economics-of-attention-capital">attention capital</a>. Recently I've been re-reading <a href="/blog/2017/09/25/3-non-it-books-that-help-you-to-become-better-programmer/#deep-work-by-cal-newport">Deep Work</a> to transform my shallow-habits to deep ones. I realized more and more that's <strong>all about the attitude of every single one of us</strong>. My attitude. Your attitude.</p>
<h2 id="Treat-Your-Eyes-like-a-Door-to-Your-Garden">Treat Your Eyes like a Door to Your Garden</h2>
<p>Imagine that your brain is your garden, with flowers and a tree of your choice. Every flower is a skill you know, every leaf of grass is a memory you bear. It's up to you, what flowers you take care about and what goes to compost. Only you can choose every day, who you let inside by your garden door.
Only you can choose if you let in 150 incoherent tweets of 10 page from a book if you let in 150 flowers that will die soon or let a part of the tree you'll continue to grow the next day. <strong>It's your attention span, that let's these in, you decide what you focus on.</strong></p>
<h2 id="Big-Trees-Needs-Times-and-Care-to-Grow">Big Trees Needs Times and Care to Grow</h2>
<p>Imagine there are 150 flowers in your garden. They need water, they need to be protected parasites and fertilized to grow strong. Where do you take time for that? You can give them all your day and energy and <strong>still some would probably die each week</strong>.</p>
<p>Or you can have 5 trees instead. Since trees are more fragile in the very beginning and much harder to grow, they need more of your attention at the very start. But as years go by, they <strong>become strong and standalone</strong>. You can climb on them, they have own seeds so they grow other trees for you and <strong>you can lean on them</strong>.</p>
<p>In reality, most people prefer flowers because they're easier to take care of now. It's natural since we're raised to <em>instant gratification</em> in schools, by our society and economy system and by our parents who were raised the same.</p>
<blockquote class="blockquote text-center">
    "Dream as if you will live forever. Live as if you will die today."
    <footer class="blockquote-footer">James Dean</footer>
</blockquote>
<p>But instant gratification doesn't work very well for a long term. You might learn a lot on a shallow level, but you'd not understand much in depth. One example for all, I went to school for 9 + 4 + <a href="/blog/2017/11/13/7-tips-you-should-know-before-going-to-university/">4 years</a> and I learned about somewhat 40 subjects. I <strong>would not dare to ask for a job in any of that</strong>. Luckily, my parent taught me to <em>learn what you want</em> principle so I grew my 5 trees that hold my back now outside the school myself.</p>
<h2 id="Children-and-Adult-are-Alike-Even-Smarter">Children and Adult are Alike, Even Smarter</h2>
<p>You probably think now, that children have to learn basics to be able to build their know-how on them. I agree to some level. When I learn something completely new with 0 know-ledge - like how the PHP parser works -, I know I have to <strong>learn basics first</strong>. I give it <strong>30 minutes a day</strong> because I know trees take time to grow and you can't rush it up. If I'd give these basics 6 hours a day, like in a school, I know I would fail, feel bad that I'm slow and probably never learn it.</p>
<p>From my personal single-use-case observation and 3 years on Psychology University, I see that brain of children works the very similar way as adult one. It's still a neural network. Even better, because they're at the very beginning, <em>tabula rasa</em>, where they can land basics for their gardens.</p>
<p>Instead of doing it themselves, we see children as somewhat lower species that needs to be controlled, developed and programmed. So in school <strong>someone else is going to visit their garden and decide what's good for them and what flowers and trees they should grow</strong>. With no clear evidence why and mostly, without understanding the garden's owner. And <strong>understanding is the most important in learning</strong>, right?</p>
<p>And here is <strong>the place where artificial intelligence era can bring a lot to human education and vice versa</strong>. Machines are never treated this way, because that is not efficient. And we found out that by <a href="/blog/2018/09/10/5-advices-i-would-love-to-get-before-starting-to-maintain-open-source/#5-don-t-take-advise-as-granted-experiment-for-yourself">experimenting</a>, failing and learning from mistakes. Doing similar research on a human is restricted by human rights, so we're motivated to repeat the same mistakes over and over again on each new generation.</p>
<h2 id="Experiment-and-Learn-About-Yourself">Experiment and Learn About Yourself</h2>
<p>Instead of going for average and &quot;what works for them must work for me&quot; approach, go experiment for yourself. <strong>Because science doesn't work with unique outliers</strong>:</p>
<div class="text-center">
    <img src="https://d2f99xq7vri1nk.cloudfront.net/AllDinosGrey_1.png">
    <br>
    <a href="https://www.autodeskresearch.com/publications/samestats">The Datasaurus Dozen: Same Stats, Different Graphs</a>
</div>
<p><br></p>
<p>Your garden is the most important one and as one my very smart friend told me:</p>
<blockquote class="blockquote text-center">
    "Each of has our own universe and none one-is never ever get to understand it."
</blockquote>
<p>Take a break for a day or two, think about what you let in your garden world and what trees will hold your back if you'll ever need them. <strong>Your life is about you, your dreams, your universe and your garden</strong>. Take care of it well and your fruits will take care of you.</p>
<blockquote class="blockquote text-center">
    Don't waste your life by working on dreams of someone else.
</blockquote> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/09/13/your-brain-is-your-garden</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 13 Sep 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/09/13/your-brain-is-your-garden#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 5 Advices I Would Love to Get Before Starting to Maintain an Open Source ]]></title>
                <link>https://tomasvotruba.com/blog/2018/09/10/5-advices-i-would-love-to-get-before-starting-to-maintain-open-source</link>
                <description><![CDATA[ <p>I wasn't always confident while making public every single line of PHP code I write. I had to take many blind paths, spend a night full of stress coding in unknown waters and make a lot of over-complicated code that backfired to me months later.
<br><br>
They say &quot;experience cannot be passed and it must be experienced&quot; and I agree with that, but still <strong>there are some shortcuts that would speed-up my path to joyful open-source coding</strong> I have today. Here are 5 of them.</p> ]]></description>
                <content:encoded><![CDATA[ <img src="/assets/images/posts/2018/advices-open-source/father-son.jpg" class="img-thumbnail">
<h2 id="1-Be-Open-to-Change-any-Package">1. Be Open to Change any Package</h2>
<p>Everything changes and when it comes to software, it's exponentially faster. How much changed the school system we have nowadays and how much changed content we absorb - mostly through the internet - every day in the last 5 years?</p>
<p>I used Nette for as my favorite framework for many many years. Later I found out what components and packages are and I picked few packages from Nette and few from Symfony for my base stack. One package was the hearth of all my packages - Dependency injection component. Nette\DI with default autowiring was light-years ahead in 2014. But Nette didn't have any new features anymore and the software grew exponentially. Symfony 2.8 came with autowiring. Symfony 3.3 came with <a href="/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3/">service autodiscovery</a>.</p>
<h3 id="Share-Your-Doubts">Share Your Doubts</h3>
<p>I loved most of the new features in Symfony and I integrated them as packages to Nette. Since I know their both DI components by the hearth, it was easy for me. But it my lazy-brain stated itching. <strong>Why do I create, maintain and test a code that was already written in another framework?</strong></p>
<p>It was until one afternoon I was happy to share with <a href="https://www.martinhujer.cz">Martin Hujer</a>. I shared my itching and how I love these Symfony DI features and he asked me very simple yet powerful question:</p>
<blockquote class="blockquote text-center">
    Why don't you switch that component from Nette to Symfony?
</blockquote>
<p>I didn't know the answer and I promised to make <strong>an experiment that night</strong>. I tried it on Statie and <a href="https://github.com/symplify/symplify/pull/184">this PR was born</a>. I'm still happy when I see this pull-request with <code>+425 −723</code>. The best refactoring is the one where you <strong>leave less code, more readable and with better features</strong>.</p>
<p>The experiment worked and whole Symplify and Rector are now running on Symfony DependencyInjection (+ <a href="https://github.com/symplify/package-builder">few cool additions</a>).</p>
<p><strong>So if there are good reasons to switch, don't let your past preferences hold you back - just switch</strong>.</p>
<h2 id="2-Don-t-Keep-Every-feature-You-Have">2. Don't Keep Every feature You Have</h2>
<p>When I started my first open-source PHP packages, called Zenify, I focused to have as many features as possible. I thought it's the way to success - all frameworks did it.</p>
<p>Then I became <a href="https://github.com/apigen/apigen">ApiGen</a> maintainer in 2014. It had over 30 options to configure: file encoding, colors in the command line, coding style check (oh yeah), enable/disable progress bar, check for newer version and many more. First I added more features that were requested and felt great, that the package is growing in its value. <strong>But does eating more and more food make your more healthy? The more feature there was, the more difficult it was to refactoring, to test and to add new features.</strong></p>
<h3 id="Find-Out-What-You-Don-t-Need">Find Out What You Don't Need</h3>
<p>I investigate Github issues of ApiGen and found out, that many features were implemented after a single request. There was a possibility that only that single person needed it so there are 300 lines of PHP untested code just because the single person wanted a feature for that one run he used ApiGen.</p>
<blockquote class="blockquote text-center">
    The amount of code != the value of the code.
</blockquote>
<p>I realized there is a lot of &quot;dead&quot; code just a few people are using. This alone would be ok but dozens of <strong>these &quot;little&quot; features made the core code unable to maintain</strong>, so tool didn't work for 95 % users.</p>
<p>I didn't know which options are used and which are not, so <strong>I did a little experiment</strong>. I made a release candidate version without these options. If the features were really important, some would create an issue - and there were such rare cases. But <a href="https://github.com/ApiGen/ApiGen/releases/tag/v4.0.0">8 in total</a> of these features could be dropped at the spot.</p>
<p><strong>Instead of adding more and more features, you should focus on keeping the main value fit. Take 80/20 rule - drop 20 % of the least used features to make 80 % of those most valuable grow faster.</strong></p>
<h2 id="3-Lock-to-LTS-Maintained-Dependencies-and-green-PHP">3. Lock to LTS, Maintained Dependencies and green PHP</h2>
<p>I thought supporting the oldest version is the best because that's how you get the most users. I supported PHP 5.3, 5.4, 5.5, 5.6 and 7.0. What a wide range of diversity, who cares PHP 5.3 was in End of life, were still people using it so I have to be there for them!</p>
<p>How naive I was :) it only caused me troubles with maintaining and I taught people it's ok to use PHP versions without security fixes.
Now I support PHP 7.1 and 7.2 and it's just a fine amount of PHP versions to maintain.</p>
<p>You don't have to make the same mistakes as me. There are many great examples that work today:</p>
<ul>
<li><a href="https://github.com/sebastianbergmann/phpunit/wiki/Release-Process">Cyclic PHPUnit Release Process</a> - stick to <a href="/blog/2017/10/30/what-can-you-learn-from-menstruation-and-symfony-releases/"><em>menstruation</em> dependency</a></li>
<li><a href="http://php.net/supported-versions.php">PHP.net - Supported Versions</a> - stay green on PHP</li>
</ul>
<p><strong>Go through them and suck the gold in.</strong></p>
<p>But this can also backfire. I was so frustrated by maintaining more versions that I could manage, that I bounced to the other extreme - tried to &quot;educate&quot; people to update as early as they can. I tend to lock to the highest Symfony version, no matter if LTS or not. So until just a couple of months ago, Symplify supported only Symfony 4, not Symfony 3.4 today. I had many discussion about that, where I explained reasons like the one above. The last person who finally &quot;broke&quot; me for good was <a href="https://github.com/lchrusciel">Łukasz Chruściel</a> from Sylius when he asked:</p>
<blockquote class="blockquote text-center">
    "How difficult would it be to support Symfony 3.4 as well?"
</blockquote>
<p>I didn't know, so I made an experiment. And <a href="https://github.com/symplify/symplify/pull/818/files">this PR was born</a>.</p>
<p><strong>Since then I lock to <a href="https://symfony.com/roadmap#maintained-symfony-branches">Symfony LTS</a>, not higher.</strong></p>
<h2 id="4-All-You-Need-to-Maintain-is-1-Repository">4. All You Need to Maintain is 1 Repository</h2>
<p>It's very easy to create a PHP package nowadays. It's very easy to create 10 of them. When I started with Zenify, then Symplify, the package-counter could be around 20 for 2 years. I thought that only people who earn living from the open-source project <a href="/blog/2017/06/01/thank-you-david/">David Grudl</a> could maintain such a big number of packages. I had zero income from them, but I wanted them to live, so maintained them... and then I burned out.</p>
<p>After that, I recall I was looking at Symfony repository - many packages but just repository. WTF? It took a few more months to find out, what monorepo is and understand how it works and how to set it up in very very basic form.</p>
<p>Nowadays there are <strong>projects to guide you</strong>:</p>
<ul>
<li><a href="https://github.com/symplify/monorepobuilder">Symplify\MonorepoBuilder</a> for CI split</li>
</ul>
<p>...so if you know YAML syntax, how to open a command line and you have a Github account, you also know how to run your own monorepo in 10 minutes even if you see it for the first time.</p>
<p>In that time, Nette went from monorepo to multirepo. I didn't know if that opposite way was the right step for me but I wanted to know. <strong>So I made a small experiment</strong> - a monorepo with 2 packages. It was just awesome. 1 commit to all, instead of duplicated commits in each package.</p>
<p><strong>I never came back.</strong></p>
<h2 id="5-Don-t-Take-Advise-as-Granted-Experiment-for-Yourself">5. Don't Take Advise as Granted, Experiment for Yourself</h2>
<p><strong>No one knows the answer for your</strong>. The most of these fuckups above were based on the result of the experience of someone else. &quot;If he's doing this and this and he's popular, he's right.&quot; Or maybe he isn't, try it for yourself. Fail fast to learn fast what works best for your own situation.</p>
<p>I wouldn't know how to do it right if I didn't go wrong first.</p>
<p><br></p>
<p>Happy growing!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/09/10/5-advices-i-would-love-to-get-before-starting-to-maintain-open-source</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 10 Sep 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/09/10/5-advices-i-would-love-to-get-before-starting-to-maintain-open-source#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Develop Multiple Symfony Applications Fast while Keeping the Quality ]]></title>
                <link>https://tomasvotruba.com/blog/2018/09/06/how-to-develop-multiple-symfony-applications-fast-while-keeping-the-quality</link>
                <description><![CDATA[ <p>Do you take care of 2 or more projects on the same framework? Do you upgrade them both to the newest version of the framework from time to time?
Or maybe you're successful, you grow and have 10 such projects.
<br><br>
<strong>Today I'll show you how to maintain speed while keeping the maintenance cost low</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>This idea came originally from tech companies with large code bases and constantly growing products:</p>
<div class="text-center">
    <img src="/assets/images/posts/2018/multi-symfony/intro.png" class="img-thumbnail">
    <br>
    <em>From <a href="https://danluu.com/monorepo/">the first post about monorepo</a> there is</em>
</div>
<p><br></p>
<p>Yet I never saw such approach in PHP world. I mean, I saw monoliths but never a monorepo. Last year I started to work more closely with Shopsys and they did one crazy thing - <a href="https://github.com/shopsys/shopsys/tree/master/project-base">put the sandbox project into monorepo repository</a>. Instead of having 2 repositories - <strong>monorepo and showcase project separated</strong> - like <a href="https://github.com/symfony/symfony">Symfony</a> and its <a href="https://github.com/symfony/demo">Demo</a>, Laravel, CakePHP, Nette or basically any PHP framework I've seen, <strong> it is just one</strong>.</p>
<p>I had my concerns about how packages and project development will go together, but now I see it was just fear from unknown.</p>
<h2 id="I-hate-Repetitive-Work-I-Hate-Repetitive-Work">I hate Repetitive Work, I Hate Repetitive Work</h2>
<p>The fuel for the next step of this approach came last month. I'm currently working on 2 open-sourced Symfony Application (non CLI!) - <a href="https://github.com/TomasVotruba/open-training">open-training</a> and <a href="https://github.com/TomasVotruba/open-project">open-real-estate</a>.</p>
<p><strong>How are 2 Symfony applications different</strong>? Well, the entities, repository queries, templates, design and controller actions are unique.
But the PHP, used framework, bundle integration, database type, deploy strategy, own packages that <a href="https://github.com/TomasVotruba/open-project/tree/master/packages/auto-discovery">auto-discover entities</a> for example, Kernel boilerplate are the same.</p>
<p>One example from last month for all: I made first package that extends EasyAdminBundle (you can <a href="/blog/2018/08/20/painful-experience-over-solutions-extend-configuratin-in-easy-admin-bundle-with-collector">read it here</a>/) for <em>open-lecture</em> project. Of course, I need that for <em>open-real-estate</em>. Now I had to create a package, make own Github repository, register it on packagist, add it to other project and somehow switch between them for every update... ugh, I guess you would not want to pay me for this bureaucracy.</p>
<p>Since I'm the main investor of myself and I hate wasting time on repetitive work, I decided to give myself a question:</p>
<blockquote class="blockquote text-center">
    "Is possible to maintain 2 Symfony applications in a single repository with ease?"
</blockquote>
<p>Google answered by miss-leading <a href="https://jolicode.com/blog/multiple-applications-with-symfony2">Multiple Kernels</a> <a href="https://stackoverflow.com/questions/45925697/more-than-one-application-per-project-repository-with-symfony-4">for one Project</a>..</p>
<p><br></p>
<p>The goal is to run...</p>
<pre><code class="language-bash">*/bin/console server:run</code></pre>
<p>...and <strong>have a running website, with own database, own code and also no duplicated code</strong>.</p>
<p>After a few hours of playing with the code (my favorite game), I started to see light in the darkness.
I'm right in the very start of using this architecture, so you'll have the knowledge in the rawest form of fresh experience. It's easier to explain and understand, rather than something I do daily for the last 5 years and don't have to think about it.</p>
<h2 id="4-Steps-to-turn-Single-Repository-project-to-Parts-of-Monorepo">4 Steps to turn Single-Repository project to Parts of Monorepo</h2>
<h3 id="1-App-Unique-Namespace">1. <del>App</del> Unique Namespace</h3>
<p>If there are 2 <code>App\Kernel</code> classes the application would break. Pick a name that is specific for the project - here it's &quot;OpenTraining&quot; - and rename it in <code>namespace App\</code>, <code>namespace App;</code>, <code>use App\</code> in PHP code. Don't forget the <code>composer.json</code> as well.</p>
<div class="text-center">
    <img src="/assets/images/posts/2018/multi-symfony/replace.png" class="img-thumbnail">
    <br>
    <em>PHPStorm → Replace in path</em>
</div>
<pre><code class="language-diff">-namespace App;
+namespace OpenTraining;

 use Symfony\Component\HttpKernel\Kernel;

-final class AppKernel extends Kernel
+final class OpenTraining extends Kernel
 {
     // ...
 }</code></pre>
<p><br></p>
<p>And let composer know, what we did:</p>
<pre><code class="language-bash">composer dump-autoload</code></pre>
<h3 id="2-Fix-Autoload-Paths">2. Fix Autoload Paths</h3>
<ul>
<li><code>bin/console</code></li>
</ul>
<pre><code class="language-diff">-require __DIR__ . '/vendor/autoload.php';
+require getcwd() .'/vendor/autoload.php';

// ...</code></pre>
<ul>
<li><code>public/index.php</code></li>
</ul>
<p>This is more complicated because the working directory is not in the monorepo root but in the project root (<code>/projects/open-training</code>):</p>
<pre><code class="language-diff">-require __DIR__ . '/../vendor/autoload.php';

+$possibleAutoloadFiles = [
+    // project
+    __DIR__  .'/../vendor/autoload.php',
+    // monorepo
+    __DIR__  .'/../../../vendor/autoload.php',
+];

+foreach ($possibleAutoloadFiles as $possibleAutoloadFile) {
+    if (file_exists($possibleAutoloadFile)) {
+        require $possibleAutoloadFile;
+    }
+}</code></pre>
<h3 id="3-Bin-Console">3. Bin\Console</h3>
<p>Instead of the old root as you're used to...</p>
<pre><code class="language-bash">bin/console server:run</code></pre>
<p>...you have to use projects' <code>bin/console</code>:</p>
<pre><code class="language-bash">projects/open-training/bin/console server:run
projects/open-real-estate/bin/console server:run</code></pre>
<h3 id="4-Merge-Projects-Composer">4. Merge Projects Composer</h3>
<p>You might be already wondering <em>How do manage composer dependencies in all this madness?</em> Well, you have to update projects' <code>composer.json</code> separately, pick them all and copy to root <code>composer.json</code>. And <strong>be careful</strong> not to use different versions, it might cause the project to work on monorepo but fail after deploying on production...</p>
<p><em>Just kidding</em>, you know I'm too lazy for this</p>
<p>All you need to do is to update projects' <code>composer.json</code>. For the rest, there is a tool I use to manage Symplify monorepo dependencies that does the dirty work for you:</p>
<pre><code class="language-bash">composer require symplify/monorepo-builder

# make sure there is the same version for every package in every composer.json
vendor/bin/monorepo-builder validate

# merge "require", "require-dev", "autoload" and "autoload-dev" from projects to the root composer.json
vendor/bin/monorepo-builder merge

# to make sure we have installed projects' dependencies
composer update</code></pre>
<p>In the root <code>composer.json</code> you might want to add some coding standards and static analysis, that is not in projects.
See the <a href="https://github.com/TomasVotruba/open-project/blob/master/monorepo-builder.yml"><code>monorepo-builder.yml</code> config </a> in my <a href="https://github.com/TomasVotruba/open-project">open-project</a> monorepo repository to get the idea how to configure it.</p>
<p><br></p>
<p>And that's it! We have now one repository to maintain, no matter how many projects we have, and we met our goals:</p>
<ul>
<li>We have the entities, repository queries, templates, design and controller actions <strong>are unique</strong>.</li>
<li>PHP, used framework, bundle integration, database type, deploy strategy, own packages, Kernel boilerplate <strong>are the same</strong>.</li>
</ul>
<p>Now we can run application with <code>projects/open-training/bin/console server:run</code> and it works!</p>
<p><br></p>
<p>Happy maintaining!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/09/06/how-to-develop-multiple-symfony-applications-fast-while-keeping-the-quality</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 06 Sep 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/09/06/how-to-develop-multiple-symfony-applications-fast-while-keeping-the-quality#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 4 Ways to Add Global Option or Argument to Symfony Console Application ]]></title>
                <link>https://tomasvotruba.com/blog/2018/09/03/4-ways-to-add-global-option-or-argument-to-symfony-console-application</link>
                <description><![CDATA[ <p>I'm working on <a href="https://github.com/symplify/changeloglinker">ChangelogLinker</a>, a package that makes managing <code>CHANGELOG.md</code> very easy - it generates it. It a CLI Application with a <a href="https://github.com/Symplify/ChangelogLinker/tree/master/src/Console/Command">3 Console Commands</a>. All was good, until <strong>I needed to add an argument to all commands at once</strong>... and in lazy, extensible, maintainable way.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Why? Symplify <code>CHANGELOG.md</code> was growing and growing, keeping upgrade data about 3 major versions. Then I realized there can be more <code>CHANGELOG.md</code> files, right?</p>
<img src="/assets/images/posts/2018/global-option/multiple-changelog.png" class="img-thumbnail">
<p>At that time, the path to file was hardcoded as <code>getcwd() . '/CHANGELOG.md'</code>, so each command worked only with that file:</p>
<pre><code class="language-bash">vendor/bin/changelog dump-merges
vendor/bin/changelog link
vendor/bin/changelog cleanup</code></pre>
<p>But I needed to change the file:</p>
<pre><code class="language-bash">vendor/bin/changelog dump-merges CHANGELOG.md
vendor/bin/changelog link CHANGELOG-2.md
vendor/bin/changelog cleanup CHANGELOG-3.md</code></pre>
<p>We need to add global file argument. So, what option do we have?</p>
<h2 id="1-Add-Argument-to-Each-Command">1. Add Argument to Each Command</h2>
<pre><code class="language-diff"> use Symfony\Component\Console\Command\Command;
 use Symfony\Component\Console\Input\InputArgument;

 final class LinkCommand extends Command
 {
     protected function configure(): void
     {
         // ...
+        $this-&gt;addArgument('file', InputArgument::OPTIONAL, 'Path to changelog file to work wiht');
     }
 }

 final class DumpMergesCommandCommand extends Command
 {
     protected function configure(): void
     {
         // ...
+        $this-&gt;addArgument('file', InputArgument::OPTIONAL, 'Path to changelog file to work wiht');
     }
 }

 final class LinkCommand extends Command
 {
     protected function configure(): void
     {
         // ...
+        $this-&gt;addArgument('file', InputArgument::OPTIONAL, 'Path to changelog file to work wiht');
     }
 }</code></pre>
<h3 id="Advantages">✅ Advantages</h3>
<ul>
<li>It's the fastest way - under 2 minutes including reading this post.</li>
<li>It's the most common way to add argument and options to Commands - most people would understand it.</li>
</ul>
<h3 id="Disadvantages">❌ Disadvantages</h3>
<ul>
<li>Well, have you noticed the &quot;wiht&quot; typo? Now I have to <strong>fix it in every single class</strong>.</li>
<li>For every change, we have to find and modify every single place this <strong>duplicated code</strong> is in.</li>
<li>When a new command is added, you have to remember to <strong>add exactly this line there</strong> - you already know <a href="/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock/">how memory-locks backfire</a>, right?</li>
</ul>
<p>Good for creating &amp; sell applications, bad for projects you want to work on for a couple of years.</p>
<h2 id="2-Modify-Application-Definition">2. Modify Application Definition</h2>
<p>I'll tell you a secret. There is one place you can <strong>modify definition not just for active command, but for the whole application</strong> - it's Application Definition!</p>
<p>The first simple &amp; short solution you'd <a href="https://gist.github.com/dhrrgn/8847309">Googled up</a> is to modify it in bin file:</p>
<pre><code class="language-diff"> &lt;?php

 use Symplify\EasyCodingStandard\Console\Application;
 use Symfony\Component\Console\Input\InputArgument;

 $application = $container-&gt;get(Application::class);
+$applicationDefinition = $application-&gt;getDefinition();
+$applicationDefinition-&gt;addArguments([
+    new InputArgument('file', InputArgument::OPTIONAL, 'Path to changelog file to work wiht');
+]);
 $application-&gt;run();</code></pre>
<h3 id="Advantages">✅ Advantages</h3>
<ul>
<li>1 place to maintain the code</li>
</ul>
<h3 id="Disadvantages">❌ Disadvantages</h3>
<ul>
<li>
<p>we program outside the Application - when we get the application somewhere else (e.g. tests), it might break</p>
<pre><code class="language-php">$application = $container-&gt;get(Application::class);
$application-&gt;run();
// passing `CHANGELOG-2.md` as argument → invalid argument error</code></pre>
</li>
<li>
<p>that's why the should be encapsulated - always prefer tree dependencies over these circle ones</p>
</li>
</ul>
<h2 id="3-The-Symfony-Event-Subscriber-Way">3. The <del>Symfony</del> Event Subscriber Way</h2>
<p>I found this approach on <a href="https://matthiasnoback.nl/2013/11/symfony2-add-a-global-option-to-console-commands-and-generate-pid-file">Matthias Noback's blog</a>. The process is similar to above, just wrapped in event subscriber that hooks into the Console Application cycle:</p>
<pre><code class="language-php">&lt;?php

use Symfony\Component\Console\Event\ConsoleCommandEvent;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\EventDispatcher\EventSubscriberInterface;
use Symfony\Component\Console\ConsoleEvents;

final class FileArgumentEventSubscriber implements EventSubscriberInterface
{
    /**
     * @return string[]
     */
    public static function getSubscribedEvents(): array
    {
        return [ConsoleEvents::COMMAND =&gt; 'onConsoleCommand'];
    }

    public function onConsoleCommand(ConsoleCommandEvent $event): void
    {
        $applicationDefinition = $event-&gt;getCommand()-&gt;getApplication()-&gt;getDefinition();
        $applicationDefinition-&gt;addArguments([
           new InputArgument('file', InputArgument::OPTIONAL, 'Path to changelog file to work with')
        ]);
    }
}</code></pre>
<h3 id="Advantages">✅ Advantages</h3>
<ul>
<li>there is 1 place to maintain the code</li>
<li>our application is consistent everywhere</li>
</ul>
<h3 id="Disadvantages">❌ Disadvantages</h3>
<p>There are now new memory-locks, that not really needed:</p>
<ul>
<li>we have to have/add event dispatcher - <code>composer require symfony/event-dispatcher</code></li>
<li>we have to load it with subscribers/listeners</li>
<li>we have to pass event dispatcher to symfony console</li>
<li>we break one of <a href="https://williamdurand.fr/2013/06/03/object-calisthenics/#5-one-dot-per-line">object calisthenics</a></li>
</ul>
<p>Also, would you add routes this way?</p>
<pre><code class="language-php">class SomeController
{
    public function someAction(Request $request)
    {
        $router = $request-&gt;getAttribute('controller')-&gt;getContainer()-&gt;get('router');
        $router-&gt;addRoute('...');
    }
}</code></pre>
<p>Above, we ask event to get a service, to invoke a callback on another service. <strong>When you ask event (unique object) for a service (global class), there is something wrong</strong>. Events should work with unique information - they're value objects after all.</p>
<p><br></p>
<p>The post is 5 years old and I don't think Matthias still sees this as the best way to go, yet Google shows it in top 5 results. Matthias has a popular and valuable blog (I learned a lot myself back in my early years in Symfony) and some people might think this is the best practice. To add more salt to the wound, this answer also <a href="https://stackoverflow.com/questions/40674814/how-to-add-a-new-command-line-option-to-symfony-console">spread to StackOverflow</a> without concurrency.</p>
<p><br></p>
<p>What is really important? <strong>The definition of application</strong>, nothing more.</p>
<h2 id="4-Extend-the-Application">4. Extend the Application</h2>
<p>I'm very happy to see that <a href="https://github.com/composer/composer/pull/1110/files">composer code has this right</a>. There is global option <code>--working-dir</code>, that allows you simply run composer in another directory:</p>
<pre><code class="language-bash">composer update --working-dir projects/open-training

# equals to
cd projects/open-training
composer update
cd ../..</code></pre>
<p>How did I find this out? I needed to remove one of the basic options Symfony Console Application has out of the box:</p>
<img src="/assets/images/posts/2018/global-option/basic.png" class="img-thumbnail">
<p>It took me a while but the track lead to <a href="https://github.com/symfony/symfony/blob/59fad59886fc2e47c4e49bcb668a6e1e0795a6d7/src/Symfony/Component/Console/Application.php#L951"><code>Application::getDefaultInputDefinition()</code></a> method.</p>
<pre><code class="language-diff"> &lt;?php

 use Symfony\Component\Console\Application;
 use Symfony\Component\Console\Input\InputArgument;

 final class SomeApplication extends Application
 {
+    protected function getDefaultInputDefinition()
+    {
+        $definition = parent::getDefaultInputDefinition();
+        $definition-&gt;addArgument(new InputArgument('file', InputArgument::OPTIONAL, 'Path to changelog file to work with'));
+
+        return $definition;
+    }
 }</code></pre>
<p><code>Symfony\Component\Console\Application</code> is <strong>one of very few classes I'd allow to <a href="https://ocramius.github.io/blog/when-to-declare-classes-final">extend</a></strong>. It's just 1:1 = easy to maintain and change. Not like entity repository, that can have dozens of children.</p>
<h3 id="Disadvantages">❌ Disadvantages</h3>
<ul>
<li>
<p>very little known → very hard to discover and debug - we should add a note about this to <code>config.yml</code></p>
<pre><code class="language-yaml">services:
    # we extend default definition here with `file` argument
    SomePackage\Console\SomeApplication: ~</code></pre>
</li>
</ul>
<h3 id="Advantages">✅ Advantages</h3>
<ul>
<li><strong>one place</strong>, that creates a consistent code</li>
<li><strong>we use API that is designed for these changes</strong></li>
<li>you don't need any extra packages, adding anything to the application</li>
<li>very simple to add: it takes 10 lines</li>
<li>it just works :)</li>
</ul>
<p><br></p>
<p>For all these reasons, this is the one I prefer. Do you want to see it in the real world? Here <a href="https://github.com/symplify/symplify/pull/1047/commits/c07c49ae4eff067db7cfe5e5ed1b283ae37c8c29#diff-3b69acbe6b33a88158b373e6e96de097">is a commit</a> from Monorepo Builder for our <code>file</code> argument.</p>
<p><br></p>
<h2 id="Think-in-Anti-Patterns">Think in (Anti) Patterns</h2>
<p>This post is not just about adding an option/argument to console. It's about applying the best choice in every feature you add. <strong>And if you don't know, look for it</strong>. Don't just blindly take the first result provided Google. It might be popular, widespread, but that doesn't mean it's high quality and valid solution.</p>
<p>Do you see similar anti-patterns as 1, 2 or 3 in your code you're now happy with? How could you make it better?</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/09/03/4-ways-to-add-global-option-or-argument-to-symfony-console-application</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 03 Sep 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/09/03/4-ways-to-add-global-option-or-argument-to-symfony-console-application#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Ways I Fucked Up Open Source Code: Mock Everything and Test Units ]]></title>
                <link>https://tomasvotruba.com/blog/2018/08/30/ways-i-fucked-up-open-source-code-mock-everything-and-test-units</link>
                <description><![CDATA[ <p>In a normal job, decisions are made by those above you. They pay you and when it goes down, you leave in 2 months. Open-source code is different because <strong>you're the one making choices but also the one who deals with results when it fails</strong>. Moreover, if you love the project and want to spend years with it.
<br>
<br>
Today I'll show you one of my many fuckups - let's mock units!</p> ]]></description>
                <content:encoded><![CDATA[ <p>I was using <a href="https://github.com/apigen/apigen">ApiGen</a> back in 2014. I had no commit for past 2 years so no surprise it didn't work for PHP 5.5+. I was young inexperienced... <em>a complainer</em> in that time, so I created issues and I blamed every contributor for creating such a bad project.</p>
<p>At the same time, I had a baby on the way and I didn't want to teach him to complain. <em>Change it or let it go</em> - that's what I wanted to teach him, so I wrote an email to Jarda, joined the project, <strong>started making the code better and failing at it</strong>.</p>
<h2 id="Mock-Almost-Everything">Mock (Almost) Everything</h2>
<p>The project had 0 % coverage, so every line I changed raised my heart-beat and blood pressure to enormous levels. I broke completely unrelated code (= regression bug) many times making the project even more bugged than it was before I came.</p>
<p>&quot;Let's increase the coverage to 90 %&quot;, I thought. I read this number on the Internet, so it had to be true. In that time I was pretty new to unit testing and mocking was on the hype. I didn't know that <em>hype</em> is <em>fake success</em> and that everything popular needs to be tested first instead of blindly integrated.</p>
<p>I took mocking, aimed for a high coverage and make unit tests strictly unit. Each class had standalone. After all, that will make the project, successful and easy to maintain. That what I thought at least. I managed to go to 84 % of coverage and burn out in the process. But it was &quot;clean&quot; and I thought the open-source is hard to make, so it <em>felt</em> right.</p>
<h2 id="How-I-Found-Out-I-Failed">How I Found Out I Failed?</h2>
<p>The story could end here with success final note. I turned 0  % coverage to 84 % on a project I never coded before. I used mocks and unit test - that's cool and great, right? It wasn't until 2 years later I worked on the code again to experience the real &quot;added&quot; value. Without exposing to feedback there is no place to improve.</p>
<img src="/assets/images/posts/2018/fuckups/before-after.png" class="img-thumbnail">
<p>ApiGen used 3rd party reflection package that was not developed for 4 years in that time. The only reasonable way to add PHP 5.5+ and features was to use BetterReflection. I won't go in much details here, but you can <a href="/blog/2017/09/04/how-apigen-survived-its-own-death/">read the whole story of migration here</a>.</p>
<img src="/assets/images/posts/2018/fuckups/change.png" class="img-thumbnail">
<p>The specific change is not that important. It might have been another situation like Symfony\Console was dead for 5 years and a new better package needed to replace it, or PHP 8.0 is out with many new API changes. The important part is mocking and unit testing. <strong>Do you know what happens if you have 84 % test coverage, mostly unit-tested with mocks and you need to switch 1 single package</strong>?
Refactoring usually mean that you replace the code in <code>/src</code> with a new one, run tests and fixes anomalies. Not in this case! I had to refactor all the unit tests to respect the new API. Rename every single class, rename every single method in your tests and find out how they work internally and re-simulate they behavior with the new package:</p>
<pre><code class="language-diff">-/** @var OldReflectionClass|\PHPUnit\Framework\MockObject\MockObject $oldReflectionClassMock */
+/** @var NewReflectionClass|\PHPUnit\Framework\MockObject\MockObject $oldReflectionClassMock */
-$reflectionClassMock = $this-&gt;createMock('OldReflectionClass');
+$reflectionClassMock = $this-&gt;createMock('NewReflectionClass');
-$reflectionClass-&gt;method('oldReflectionMethod')
+$reflectionClass-&gt;method('newReflectionMethod')
-    -&gt;willReturnCallback(...);
+    -&gt;willReturnCallback(...);</code></pre>
<p>Uff. I was refactoring old code to a new one for weeks. It was hell, hell that made me think why I'm doing it like this? What I <strong>really need</strong>? <strong>I really needed to develop safely when working code of ApiGen and enjoy it</strong>. If I don't enjoy it, I burn out and no matter how &quot;professional&quot; code looks like, it will perish in the past. <em>Better done than perfect</em>.</p>
<p>Let's turn it into the code language:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace Apigen\Tests;

use PHPUnit\Framework\TestCase;

final class ApiGenTest extends TestCase
{
    public function test()
    {
        exec('bin/apigen tests/test-source --output tests/generated-source');

        $this-&gt;assertSame('tests/expected-source', 'tests/generated-source');
    }
}</code></pre>
<p>This is clearly opposite extreme thinking, that has its flaws. Mock everything and unit test every single class? Run just bin file and before/after? In the end, I found the best deal is somewhere in the middle:</p>
<ul>
<li>
<p>Instead of testing the lowest levels, <strong>I started to use the main parts of the application with before/after approach</strong>. You can see it nicely in this <a href="https://github.com/symplify/symplify/blob/e35b7e0564e08028f626241ca4860123c29a5b5e/packages/CodingStandard/tests/Fixer/Property/ArrayPropertyDefaultValueFixer/ArrayPropertyDefaultValueFixerTest.php#L34-L40">Symplify\CodingStandard test</a>. They've proven to be easily extendable and easier to understand. You see PHP code before and PHP code after. Good old common sense.</p>
</li>
<li>
<p>Instead of mocking, <strong>I started to use <a href="/blog/2018/06/11/how-to-turn-mocks-from-nightmare-to-solid-kiss-tests/">anonymous classes</a></strong>. They've proven to be readable, programmers understand them (it's PHP code, you know) and there are no strings or plugins attached.</p>
</li>
</ul>
<h2 id="What-I-Learned-From-this-Fail">What I Learned From this Fail?</h2>
<p><strong>I ask more</strong> and go for experience and small experiments.</p>
<h3 id="1-Is-it-Hype-or-is-it-Quality">1. Is it Hype or is it Quality?</h3>
<p>Why do I think it's a good solution? Is it based on opinions or experience? If the first one, I make a little experiment to know and prevent huge consequences. I also found out that famous people are taken seriously... or rather miss taken seriously. Without knowing their experience and whys, people take blindly their statements. Take me as an example - I went for strict unit testing and 90 % coverage without really knowing why.</p>
<p>These statements are usually out of context and <strong>based on their specific experience</strong>. I might be working with 10-years-old PHP project where there is no space (budget) for automated refactorings or code-self-improvement, so I go for unit tests of everything I can. But <strong>does it make sense in your context</strong> where your leader is more educated and focuses on the effectivity in the long-run over today?</p>
<p>Advice have meaning in their context, <strong>you have to create your own</strong>. The same applies to my me. I share my own views, that is based on my own experience. It might work for you, but it doesn't mean it's right for everybody. Even if I don't write explicitly in every post my whole history, try to think about the background I'm from, what projects I work on and how that relates to you.</p>
<p>This <em>false positive</em> is called <a href="https://www.google.cz/search?q=anecdotal+evidence+example">anecdotal evidence</a> in psychology research.</p>
<img src="https://pixfeeds.com/images/32/608973/1200-608973-7125124.jpg" class="img-thumbnail">
<p><em>Fail fast and fail safe.</em> Try 2 frameworks to understand the first one, try <a href="/blog/2017/10/02/easy-coding-standard-and-phpstan-meet-3-symfony-ecommerce-projects/">3 e-commerce projects to make yours better</a>, try 10-20 projects to understand yours.</p>
<h3 id="2-What-Maintenance-Cost-it-Brings">2. What Maintenance Cost it Brings?</h3>
<p>If I'd work in the agency that takes every year new project, I would not mind. I would create code that somebody else would have to rewrite in 5 years and got paid for it. But <strong>I prefer long-term projects and the challenge of keeping them fit and slim even after many years of development</strong>.</p>
<p>Every feature will make something better, so it doesn't make sense to ask if the project will be better with it. Even the school system gives you something. That's not the point. Instead for every new code feature, I ask - <strong>is added value bigger than an increase in maintenance cost it adds to our daily routine</strong>? I mean it's great to have online support form in javascript, but if it takes 1 hour daily due to bugs of the unstable package... - again, there is space for an experiment.</p>
<p><br></p>
<h2 id="Out-of-Context-Takeaways">Out of Context Takeaways</h2>
<p>So that's my fuckup story based on repeated in headlines and one-line advice I've heard.</p>
<p>What should you take as one-line takeaways?</p>
<ul>
<li>Personal experience from fast and safe experiment over external ideas out of context.</li>
<li>Stick with a project at least for a year, to see consequences of your early decisions.</li>
<li>It's ok to fail. It's not ok to fail over and over again with the same mistake.</li>
<li>Go out and fail to learn!</li>
</ul>
<p><br></p>
<p>Happy failing!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/08/30/ways-i-fucked-up-open-source-code-mock-everything-and-test-units</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 30 Aug 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/08/30/ways-i-fucked-up-open-source-code-mock-everything-and-test-units#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Why and How to Avoid the Memory Lock ]]></title>
                <link>https://tomasvotruba.com/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock</link>
                <description><![CDATA[ <p>When you close the door of my home, they're closed and you need a key to get in. But what if your door has door handle? You have to also lock them.
<br><br>
Instead of just closing the door you have to close the door and <em>that one more thing</em>. Why is that a bad thing in the code and how to avoid it?</p> ]]></description>
                <content:encoded><![CDATA[ <p>I started <a href="https://github.com/javiereguiluz/easybook/pull/185">refactoring <em>easybook</em> package</a> last week and I found a few interesting snippets there.</p>
<p>Let's start with a simple question: which of following 7 code snippets <strong>opens space for potential bug</strong> that will take your new colleague 2-3 hours to solve?</p>
<p><br></p>
<p>1.</p>
<pre><code class="language-php">&lt;?php

// ...

foreach ($this-&gt;publishingItems as $item) {
   $item['content'] = $this-&gt;decorateContent($item['content']);
}</code></pre>
<p><br></p>
<p>2.</p>
<pre><code class="language-php">&lt;?php

use Symfony\Component\EventDispatcher\EventSubscriberInterface;

final class SomeEventSubscriber implements EventSubscriberInterface
{
    /**
     * @return string[]
     */
    public static function getSubscribedEvents(): array
    {
         return ['processEvent'];
    }

    public function processEvent(ItemAwareEvent $itemAwareEvent)
    {
        $item = $itemAwareEvent-&gt;getItem();
        $item['content'] = 'new content';
    }
}</code></pre>
<p><br></p>
<p>3.</p>
<pre><code class="language-php">&lt;?php

// ...

$this-&gt;bookGenerator-&gt;setBookDirectory($bookDirectory);
$this-&gt;bookGenerator-&gt;generate();</code></pre>
<p><br></p>
<p>4.</p>
<pre><code class="language-php">&lt;?php

// ...

protected function setUp(): void
{
    $this-&gt;epub2Publisher = $this-&gt;container-&gt;get(Epub2Publisher::class);
}</code></pre>
<p><br></p>
<p>5.</p>
<pre><code class="language-php">&lt;?php

class SomeController
{
    public function someAction()
    {
        // ...

        $product = ...;

        $this-&gt;entityManager-&gt;persist($product);
        $this-&gt;entityManager-&gt;flush();
    }
}</code></pre>
<p><em>Don't mind the presence of Doctrine in Controller here. That's a code smell we don't look for right now.</em></p>
<p><br></p>
<p>6.</p>
<pre><code class="language-php">&lt;?php

use Symfony\Component\Console\Command\Command;

class SomeCommand extends Command
{
    /**
     * @var SomeDependency
     */
    private $someDependency;

    public function __construct(SomeDependency $someDependency)
    {
        $this-&gt;someDependency = $someDependency;
    }

    // ...
}</code></pre>
<p><br></p>
<p>7.</p>
<pre><code class="language-php">&lt;?php
use PhpParser\NodeTraverser;

class SomeNodeTraverser extends NodeTraverser
{
    /**
     * @var SomeDependency
     */
    private $someDependency;

    public function __construct(SomeDependency $someDependency)
    {
        $this-&gt;someDependency = $someDependency;
    }

    public function process()
    {
        foreach ($this-&gt;visitors as $visitor) {
            // ...
        }
    }
}</code></pre>
<p>Do you have your favorite number? Good, try to remember it.</p>
<p>The memory-lock <strong>is very difficult to spot</strong>. We owe that to <em>author blindness</em> and <em>thinking heuristics</em> (brain short-cuts), that limits our ability to work effectively in the chaos or under pressure. If you've read <a href="https://www.amazon.com/Thinking-Fast-Slow-Daniel-Kahneman-ebook/dp/B005MJFA2W/ref=sr_1_1?ie=UTF8&amp;qid=1535407760&amp;sr=8-1&amp;keywords=Thinking%2C+Fast+and+Slow">Thinking, Fast and Slow</a> (must have for anyone curious about his or her brain false positives) or any other book about social psychology, you know where I'm heading.</p>
<h2 id="When-Expectations-are-Met">When Expectations are Met</h2>
<p>Why it's difficult to spot? <strong>It depends on other code and it might code work if our expectations are met</strong>. What does it mean?</p>
<p>Let's take code snippet 7. Will this work or not? Under what condition?</p>
<pre><code class="language-php">&lt;?php

foreach ($this-&gt;visitors as $visitor) {
    // ...
}</code></pre>
<p><a href="https://github.com/nikic/PHP-Parser/pull/528">This pull-request</a> reveals the answer.</p>
<p>Now back to your coding:</p>
<ul>
<li>Do you want to create a code that works under certain assumption?</li>
<li>Do you want to remember to do the B after each A?</li>
<li>Do you want to <strong>keep over 50 of such A-B pairs in your head</strong> every time you open your main project?</li>
</ul>
<p>I don't. I want to be effective and create a valuable bullet-proof code that can be used only one way. A code that doesn't put the burden on the developer to investigate my code first. A code that is safe to use and cannot be broken (if possible).</p>
<p><br></p>
<p>So which of those 7 code snippets above are dangerous?</p>
<p><br></p>
<p><em>Drum rolls...</em></p>
<p><br></p>
<p><strong>Yes, all of them!</strong> I knew you'd reveal my poor confusion.</p>
<h3 id="Don-t-make-the-Programmer-Think">Don't make the Programmer Think</h3>
<p>I'm taking the title from my favorite <a href="http://sensible.com/dmmt.html">intro UX book</a> because it really punches the line. <strong>There are 3 groups of memory-locks that could be done better</strong> in the code snippets above.</p>
<h2 id="1-Change-Array-Return">1. Change Array Return</h2>
<div class="card">
    <div class="card-body">
        The memory lock: <em>after I change array value, I have to put it back into an original set of an array or return it</em>.
    </div>
</div>
<p>Snippets 1 and 2.</p>
<p>This code would change the <code>$item['content</code>] value, but <code>$this-&gt;publishingItems</code> remains unchanged:</p>
<pre><code class="language-php">&lt;?php

// ...

foreach ($this-&gt;publishingItems as $item) {
    $item['content'] = $this-&gt;decorateContent($item['content']);
}</code></pre>
<h3 id="How-to-Solve-it">How to Solve it?</h3>
<pre><code class="language-diff"> &lt;?php

 // ...

-foreach ($this-&gt;publishingItems as $item) {
+foreach ($this-&gt;publishingItems as $key =&gt; $item) {
     $item['content'] = $this-&gt;decorateContent($item['content']);
+    $this-&gt;publishingItems[$key] = $item;
 }</code></pre>
<p><strong>Use object instead</strong>:</p>
<pre><code class="language-diff"> &lt;?php

 // ...

 foreach ($this-&gt;publishingItems as $item) {
-     $item['content'] = $this-&gt;decorateContent($item['content']);
+     $item-&gt;changeContent($this-&gt;decorateContent($item['content']));
 }</code></pre>
<p>Objects <a href="https://gist.github.com/nikic/5015323">consume less memory</a> anyway and <strong>you are safe</strong> - more importantly, <strong>anyone extending this code ever after is safer</strong>.</p>
<h2 id="2-Double-Method-Call">2. Double-Method Call</h2>
<div class="card">
    <div class="card-body">
       The memory lock: <em>After I call this method I have to call that method to make it really work</em>.
    </div>
</div>
<p>Snippets 3 and 5.</p>
<p>You also have to think about the C - the order:</p>
<pre><code class="language-php">$this-&gt;bookGenerator-&gt;setBookDirectory($bookDirectory);
$this-&gt;bookGenerator-&gt;generate();</code></pre>
<p>vs.</p>
<pre><code class="language-php">$this-&gt;bookGenerator-&gt;generate();
$this-&gt;bookGenerator-&gt;setBookDirectory($bookDirectory);</code></pre>
<p>vs.</p>
<pre><code class="language-php">$this-&gt;bookGenerator-&gt;generate();</code></pre>
<h3 id="How-to-Solve-it">How to Solve it?</h3>
<p>Use one method that handles it both:</p>
<pre><code class="language-diff"> &lt;?php

 // ...

-$this-&gt;bookGenerator-&gt;setBookDirectory($bookDirectory);
-$this-&gt;bookGenerator-&gt;generate();
+$this-&gt;bookGenerator-&gt;generateFromDirectory($bookDirectory);</code></pre>
<p>Same applied to code snippet 5:</p>
<pre><code class="language-diff"> &lt;?php

 // ...

-$this-&gt;entityManager-&gt;persist($product);
-$this-&gt;entityManager-&gt;flush();
+$this-&gt;productRepository-&gt;save($product);</code></pre>
<p>I dare you to generate the book or save the product the wrong way now!</p>
<h2 id="3-Parent-Logic">3. Parent Logic</h2>
<p>Snippets 4, 6 and 7.</p>
<div class="card">
    <div class="card-body">
       The memory lock: <em>After I call anything in parent method, I have check if I need to call the constructor to prepare some logic</em>.
    </div>
</div>
<p>This would actually fail:</p>
<pre><code class="language-php">&lt;?php

foreach ($this-&gt;visitors as $visitor) {
    // ...
}</code></pre>
<p>Why? Because in <code>parent::__construct()</code> is set default value for property with null:</p>
<pre><code class="language-php">&lt;?php

// ...

public function __construct()
{
    $this-&gt;visitors = [];
}</code></pre>
<h3 id="How-to-Solve-it">How to Solve it?</h3>
<p>In this case just add default value to property itself:</p>
<pre><code class="language-diff">-private $visitors;
+private $visitors = [];</code></pre>
<p>There is even coding <a href="https://github.com/symplify/coding-standard#array-property-should-have-default-value-to-prevent-undefined-array-issues">standard fixer for that</a>.</p>
<p>Also, <strong>do not add any logic to constructor</strong> apart dependency injection. Constructor injection is the main reason to use the constructor in 99 %, so most people probably don't expect any extra logic there. Create extra method instead or decouple a class, put it into the constructor and call the method on it.</p>
<p><strong>Try to avoid these patterns in code, in door design or in architecture of the application as a whole.</strong> One day some programmer will silently thank you when he or she will find what <em>memory lock</em> is (the painful way).</p>
<p><br></p>
<p>Do you know any other <em>memory locks</em> we should watch out for? Share them in the comment!</p>
<p><br></p>
<blockquote class="twitter-tweet" data-lang="cs"><p lang="en" dir="ltr">"90% of the bugs I produced were for one of the two reasons:<br>1. Doing multiple things at one place<br>2. Doing one thing at multiple places" - <a href="https://twitter.com/pseudo_coder?ref_src=twsrc%5Etfw">@pseudo_coder</a></p>— Programming Wisdom (@CodeWisdom) <a href="https://twitter.com/CodeWisdom/status/998180793385209856?ref_src=twsrc%5Etfw">20. května 2018</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p><br></p>
<p>Happy brain cells liberation!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 27 Aug 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 9 Features of PHPStorm Symfony Plugin You Should Not Miss in Gifs ]]></title>
                <link>https://tomasvotruba.com/blog/2018/08/23/9-features-of-symfony-plugin-you-should-not-miss-in-gifs</link>
                <description><![CDATA[ <p>After very successful <a href="/blog/2018/08/16/whats-new-in-php-73-in-30-seconds-in-diffs/">PHP 7.3 diffs post</a>, let's dive to gifs of <a href="https://plugins.jetbrains.com/plugin/7219-symfony-plugin">Symfony Plugin for PHPStorm</a>. You might know them, but they <strong>might surprise you like they did surprise me</strong>. Let's go!</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="0-Be-Grateful">0. Be Grateful ❤️️</h2>
<img src="/assets/images/posts/2018/symfony-plugin/thank-you.png" class="img-thumbnail">
<p><a href="https://github.com/Haehnchen/idea-php-symfony2-plugin#building-debugging-and-other">Click PayPal in README</a></p>
<p><br></p>
<h2 id="1-Enable-the-Plugin">1. Enable the Plugin</h2>
<p>Easy, but must have step!</p>
<img src="/assets/images/posts/2018/symfony-plugin/enable.gif" class="img-thumbnail">
<p><br></p>
<h2 id="2-Faster-Translation-Autocreate-TWIG">2. Faster Translation Autocreate (TWIG)</h2>
<img src="/assets/images/posts/2018/symfony-plugin/translate-add-key.gif" class="img-thumbnail">
<p><br></p>
<h2 id="3-Autocomplete-Translation-Key-TWIG">3. Autocomplete Translation Key (TWIG)</h2>
<p>Write your <code>|trans</code> first.</p>
<img src="/assets/images/posts/2018/symfony-plugin/translate-autocomplete.gif" class="img-thumbnail">
<p><br></p>
<h2 id="4-Instant-Service-Autocomplete-in-YAML-YAML">4. Instant Service Autocomplete in YAML  (YAML)</h2>
<p>The trick is go after <code>:</code>.</p>
<img src="/assets/images/posts/2018/symfony-plugin/yaml-class.gif" class="img-thumbnail">
<p><br></p>
<h2 id="5-Forget-The-Tag-YAML">5. Forget The Tag (YAML)</h2>
<img src="/assets/images/posts/2018/symfony-plugin/yaml-tag.gif" class="img-thumbnail">
<p><br></p>
<h2 id="6-Jump-from-Href-to-Route-TWIG">6. Jump from Href to Route (TWIG)</h2>
<img src="/assets/images/posts/2018/symfony-plugin/route-in-twig.gif" class="img-thumbnail">
<p><br></p>
<h2 id="7-Instant-Route-in-Controller-PHP">7. Instant Route in Controller (PHP)</h2>
<img src="/assets/images/posts/2018/symfony-plugin/route-in-php.gif" class="img-thumbnail">
<p><br></p>
<h2 id="8-Faster-Queries-in-Doctrine-Repository-PHP">8. Faster Queries in Doctrine Repository (PHP)</h2>
<img src="/assets/images/posts/2018/symfony-plugin/doctrine-query-autocomplete.gif" class="img-thumbnail">
<p><br></p>
<h2 id="9-Template-Autocomplete-PHP">9. Template Autocomplete (PHP)</h2>
<p>You know the basic template autocomplete from <code>/templates</code>. But how to do that for decoupled templates in <code>/packages/Provision/templates</code>?</p>
<img src="/assets/images/posts/2018/symfony-plugin/template-elsewhere.gif" class="img-thumbnail">
<p><br></p>
<p>That's it!</p>
<p>What number was <strong>new to you</strong>? And which feature I missed?</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/08/23/9-features-of-symfony-plugin-you-should-not-miss-in-gifs</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 23 Aug 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/08/23/9-features-of-symfony-plugin-you-should-not-miss-in-gifs#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Painful Experience over Solutions: Extend Configuration in Easy Admin Bundle ]]></title>
                <link>https://tomasvotruba.com/blog/2018/08/20/painful-experience-over-solutions-extend-configuratin-in-easy-admin-bundle-with-collector</link>
                <description><![CDATA[ <p><em>Use SOLID to write Clean Code...</em> Are you tired of theoretical post about how to do achieve some therm? So am I.
<br>
Instead, let's <strong>dive into real problems I came across while coding and let the code speak the theory between lines</strong>.
<br><br>
Today we try to add own config option to YAML of Easy Admin Bundle (without pull-request to the package).</p> ]]></description>
                <content:encoded><![CDATA[ <blockquote class="blockquote text-center">
    Hindsight is 20/20.
</blockquote>
<p>Instead of writing about solution how to do and how awesome I am to know the solution right from the start of this page, I start right from the beginning, where I know nothing about it just like you.</p>
<p><br></p>
<h3 id="The-Application">The Application</h3>
<p>I'm coding an open-sourced training platform build Symfony 4.2 and Doctrine 2.7 for <a href="https://github.com/pehapkari">Pehapkari community training</a>. It's fully open-sourced on Github under the typical open-source name - <a href="https://github.com/tomasvotruba/open-training">Open Training</a>.</p>
<p>Admin is just a CRUD to maintain few entities, so I use <a href="https://github.com/easyCorp/EasyAdminBundle">EasyAdminBundle</a> to handle forms, grids, update, create, delete actions in controllers for me. Huge thanks to <a href="https://github.com/javiereguiluz">Javier Eguiluz</a> for this amazingly simple and powerful idea.</p>
<img src="https://symfony.com/doc/current/bundles/EasyAdminBundle/_images/easyadmin-default-backend.png">
<h3 id="The-Need">The Need</h3>
<p>There is <code>Training</code> entity with <code>name</code> and relation to <code>TrainingTerm</code> entity:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace App\Entity;

use Doctrine\Common\Collections\ArrayCollection;
use Doctrine\ORM\Mapping as ORM;

/**
 * @ORM\Entity
 */
class Training
{
    /**
     * @ORM\Id()
     * @ORM\GeneratedValue()
     * @ORM\Column(type="integer")
     * @var int
     */
    private $id;

    /**
     * @ORM\Column(type="string", length=255)
     * @var string
     */
    private $name;

    // ...

    /**
     * @ORM\OneToMany(targetEntity="App\Entity\TrainingTerm", mappedBy="training")
     * @var TrainingTerm[]|ArrayCollection
     */
    private $trainingTerms = [];
}</code></pre>
<p>I want to edit this entity in administration, so I add it to <code>config/packages/easy_admin.yaml</code>:</p>
<pre><code class="language-yaml">easy_admin:
    entities:
        Training:
            class: 'App\Entity\Training'</code></pre>
<p>This creates a grid and form with all the entity properties - <code>name</code> and <code>trainingTerms</code>. So, when I click <em>Add</em> in the admin I can change them both. <strong>But I want to change the <code>name</code> only and handle <code>TrainingTerm</code> entity in a standalone form.</strong></p>
<h3 id="Google-First">Google First</h3>
<p>Now what? I Google <em>easy admin custom field form</em> and after while I find <a href="https://symfony.com/doc/2.x/bundles/EasyAdminBundle/book/edit-new-configuration.html#customize-the-properties-displayed"><em>Customize the Properties Displayed</em></a> tutorial. It looks like exactly what I need.</p>
<pre><code class="language-diff"> easy_admin:
     entities:
         Training:
             class: 'App\Entity\Training'
+            fields: ['name']</code></pre>
<p>It works! The <code>trainingTerms</code> property is hidden in the form.</p>
<p><br></p>
<h3 id="But">But...</h3>
<p>After 2 hours I need to add <code>price</code>.</p>
<pre><code class="language-diff"> &lt;?php declare(strict_types=1);

 namespace App\Entity;

 use Doctrine\Common\Collections\ArrayCollection;
 use Doctrine\ORM\Mapping as ORM;

 /**
  * @ORM\Entity
  */
 class Training
 {
     // ...

+    /**
+     * @ORM\Column(type="integer")
+     * @var int
+     */
+    private $price;</code></pre>
<p>Price is there, great! Now we can earn some money. I <em>edit</em> training in admin... but, where is the price?</p>
<p>Because I'm coding many other features I don't realize, there is <em>memory-vendor-lock</em> - <strong>a code smell, when after doing the A, you always have to remember the B</strong>. Do you see it? When I add a property, I always have a to add it to <code>fields</code> in config.</p>
<pre><code class="language-diff"> easy_admin:
     entities:
         Training:
             class: 'App\Entity\Training'
-            fields: ['name']
+            fields: ['name', 'price']</code></pre>
<p>If this is the only case, that would be ok-ish. But now there are 10 entities with 50 properties. How the hell will I remember to do this on every new property I add?</p>
<pre><code class="language-diff"># ...
-            fields: ['name', 'price']
+            fields: ['name', 'price', 'capacity']</code></pre>
<p>And how can will anyone else find this out without me doing the code-review and remembering?</p>
<pre><code class="language-diff"># ...
-            fields: ['name', 'price', 'capacity']
+            fields: ['name', 'price', 'capacity', 'duration']</code></pre>
<p>So much <em>memory-leaks</em> it hurts my neurons.</p>
<h3 id="Creative-Time">Creative Time</h3>
<p>Life is not perfect and every code is legacy by the time you end the line with <code>;</code>.</p>
<blockquote class="blockquote text-center">
    There are no solutions. Just trade-offs.
</blockquote>
<p>I stop and think a bit. How can I write less code to prevent possible bugs and make changes as effective as possible?
<strong>I see there are fewer properties to exclude than properties to include</strong>, by 1:10. It would not be perfect code, but still 10 times safer and more effective code. Worth it!</p>
<pre><code class="language-diff"> easy_admin:
     entities:
         Training:
             class: 'App\Entity\Training'
-            fields: ['name', 'price', 'capacity', 'duration', 'perex', 'description', 'place', 'trainer']
+            exclude_fields: ['trainingTerms']</code></pre>
<h3 id="Make-that-Happen-and-Face-False-Expectations">Make that Happen and Face False Expectations</h3>
<p>But is that <code>exclude_fields</code> or <code>excluded_fields</code> or maybe <code>skip_fields</code>? I want to see the documentation, so I Google <a href="https://www.google.cz/search?q=easy+admin+bundle+exclude+fields&amp;oq=easy+admin+bundle+exclude+fields&amp;aqs=chrome..69i57.4891j0j7&amp;sourceid=chrome&amp;ie=UTF-8"><em>easy admin bundle excludes fields</em></a>. I find <a href="https://github.com/EasyCorp/EasyAdminBundle/issues/589"><em>Exclude fields in list fields</em> issue in EasyAdminBundle</a>. I read it and see the content <strong>is not what I need</strong>. It looks like this option is not supported. I'm sad. What now?</p>
<p><br></p>
<p>Open-source packages are closed to extension more than you'd expect. To add one custom feature, you have to basically copy and extend the whole class or use reflection. It's not <strong>because it's difficult to create an extendable code, it's because nobody <em>believes</em> it can be done in a nice way</strong>. It <em>can</em>, just keep reading.</p>
<p><br></p>
<p>Being that suspicious I start my <em>inner over-engineer</em> voice:</p>
<ul>
<li>&quot;Create own extension that will hack into the <code>EasyAdminExtension</code> and get the config and add <code>exclude_fields</code> option&quot;</li>
<li>&quot;Create own <code>BetterEasyAdminBundle</code> that will be run before the <code>EasyAdminBundle</code> and will pass parameters there&quot;</li>
</ul>
<p><strong>This might end-up wasting many hours</strong> on custom and useless solution (like &quot;create own Doctrine&quot; idea, true story). Instead I try to invest a bit more time and I continue the brainstorming:</p>
<ul>
<li>&quot;Send pull-request with this feature to the core code&quot;</li>
</ul>
<p>Slightly better, but what if Javier doesn't like it? Or what if he's on holiday for 3 weeks? I know, it's summer and very rare to happen, but I have to finish the app in 2 weeks and I don't want to think about bugs like these in the meantime. The <strong>least I can do is to create <a href="https://github.com/EasyCorp/EasyAdminBundle/issues/2325">an issue</a></strong> with this idea and my reasons for it.</p>
<h2 id="Wander-in-the-Code">Wander in the Code</h2>
<p>I need a solution and I need it today. What can I do? No hacking, no pull-request, just looking for something in files:</p>
<img src="/assets/images/posts/2018/collector-easy-admin-bundle/random.png" class="img-thumbnail">
<p>Do you think this is just a random screen-shot not worth your attention?</p>
<ul>
<li>there is a checkbox in <em>Match case</em> because <code>'fields'</code> is lowercased and we want to focus on that only (no properties or methods with <code>Fields</code>)</li>
<li>there is a limit to <code>*.php</code> because that <em>would be probably</em> place to extend</li>
<li>there is a limit to <em>Directory</em>: <code>/../vendor/easycorp</code>, because we want to hack into this package</li>
<li>there is <code>fields</code> word in search; later I improve it to <code>'fields'</code> to narrow results, because we know it's a string</li>
</ul>
<p><br></p>
<p><strong>I still have no idea about the solution I'll pick. I'm only randomly looking for the light, blindfolded in a dark foggy forest.</strong>
This is called <em>creative chaos</em> in coaching circles and it's the most important part of the client's work.</p>
<p><br></p>
<p>I scroll down a bit looking at both code and the file name. Suddenly, the fog starts slowly disappearing...</p>
<img src="/assets/images/posts/2018/collector-easy-admin-bundle/pass.png" class="img-thumbnail">
<p>I notice <code>*ConfigPass</code> suffix. Is that like <code>CompilerPassInterface</code>, a collector-pattern used in Symfony to modify services in the container?</p>
<p>Being curious I open <code>NormalizerConfigPass.php</code> file:</p>
<pre><code class="language-php">&lt;?php

// ...

namespace EasyCorp\Bundle\EasyAdminBundle\Configuration;

use Symfony\Component\DependencyInjection\ContainerInterface;

class NormalizerConfigPass implements ConfigPassInterface
{
    // ...
}</code></pre>
<p>An interface! That's a good sign.</p>
<h3 id="Keep-Wandering">Keep Wandering</h3>
<p>So I look for <code>ConfigPassInterface</code> in somewhere else than just <code>implements ConfigPassInterface</code>.</p>
<p>That doesn't work, so I try to look for <code>ConfigPass</code>.</p>
<p>That doesn't work, so I try to look for any file, not just <code>*.php</code>. That show as valuable, since services are defined in YAML or XML.</p>
<img src="/assets/images/posts/2018/collector-easy-admin-bundle/services.png" class="img-thumbnail">
<p>I see a tag: <code>easyadmin.config_pass</code>. Let's look for that string:</p>
<img src="/assets/images/posts/2018/collector-easy-admin-bundle/bingo.png" class="img-thumbnail">
<p>Warmer! <strong>I've just found a collector pattern.</strong> To config, I look for service under <code>easyadmin.config.manager</code> name - <a href="https://github.com/EasyCorp/EasyAdminBundle/blob/07194017918aebe382e1ab0e53c68f6242547a0e/src/Configuration/ConfigManager.php#L112-L119"><code>ConfigManager</code></a> and look for <code>foreach</code> on collected services:</p>
<pre><code class="language-php">private function doProcessConfig($backendConfig): array
    {
    foreach ($this-&gt;configPasses as $configPass) {
        $backendConfig = $configPass-&gt;process($backendConfig);
    }

    return $backendConfig;
}</code></pre>
<p>Bingo! <strong>That means, when I register a service with <code>easyadmin.config_pass</code> tag, I'll be able to read and modify the YAML configuration</strong>.</p>
<p>So I register a service:</p>
<pre><code class="language-yaml">services:
    ExcludeFieldsConfigPass:
        tags:
             -
                 name: "easyadmin.config_pass"
                 priority: 120 # it took me more time to figure out if -100 or 0 or 100 or 1000 means "the first"</code></pre>
<p>That does 1 thing:</p>
<p><code>fields</code> (value to be set) = entity properties − <code>exclude_fields</code> (value I set in the config)</p>
<p><br></p>
<p>It allows me to do simplify <code>config/packages/easy_admin.yaml</code> config:</p>
<pre><code class="language-diff"> easy_admin:
     entities:
         Training:
             class: 'App\Entity\Training'
-            fields: ['name', 'price', 'capacity', 'duration', 'perex', 'description', 'place', 'trainer']
+            exclude_fields: ['trainingTerms']</code></pre>
<p>You can see full code of <a href="https://github.com/TomasVotruba/open-training/pull/7/files#diff-318660bf4cd1ad8a5d0e608e94df8fae"><code>ExcludeFieldsConfigPass</code> on Github</a>.</p>
<p>Very smart move Javier - thank you!</p>
<h2 id="Learn-1-Algorithm-instead-of-10-Solutions">Learn 1 Algorithm instead of 10 Solutions</h2>
<p>And that's all folks. I hope I've shown you how to approach problems and how to find a way in situations you're the first time in.
The same way I don't memorize Wikipedia and just Google it instead, <strong>I don't remember solutions to 100 PHP problems, but have a couple of algorithms to approach problem solving</strong>.</p>
<ul>
<li>Try A - Failed?</li>
<li>Try B - Failed?</li>
<li>Try C - Failed?</li>
<li>Take a break to prevent <a href="https://en.wikipedia.org/wiki/Learned_helplessness">learned helplessness</a> :)</li>
<li>Try D - Failed?</li>
<li>Try E - Failed?</li>
<li>Try F - Kaboom! It works!</li>
</ul>
<p><br>
If artificial intelligence could figure this all out for us, we'd be screwed :).</p>
<p>Btw, are you coming to <a href="https://www.hlai-conf.org">Human Level AI Conference</a> in Prague this weekend? I'll be there and I'd be happy if you stop me and say Hi!</p>
<p><br></p>
<p>Happy solving!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/08/20/painful-experience-over-solutions-extend-configuratin-in-easy-admin-bundle-with-collector</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 20 Aug 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/08/20/painful-experience-over-solutions-extend-configuratin-in-easy-admin-bundle-with-collector#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ What&#039;s New in PHP 7.3 in 30 Seconds in Diffs ]]></title>
                <link>https://tomasvotruba.com/blog/2018/08/16/whats-new-in-php-73-in-30-seconds-in-diffs</link>
                <description><![CDATA[ <p>No time but eager to hear PHP news? PHP 7.3 is out in December 2018 and it brings <a href="https://github.com/php/php-src/blob/PHP-7.3/NEWS">173 changes</a>. Which are the most useful ones?</p> ]]></description>
                <content:encoded><![CDATA[ <p>From features that might be the most interesting to those lesser ones, that anybody will rarely use.</p>
<h2 id="1-Comma-After-the-Last-Argument">1. Comma After the Last Argument</h2>
<p><a href="https://wiki.php.net/rfc/trailing-comma-function-calls" class="btn btn-info btn-sm">
See RFC
</a></p>
<p>Do you know this?</p>
<pre><code class="language-diff"> $array = [
     1,
+    2,
 ];</code></pre>
<p>We'll be able to do this:</p>
<pre><code class="language-diff"> $this-&gt;someFunction(
     $arg,
+    $arg2,
 );</code></pre>
<p>But <strong>still not this</strong>:</p>
<pre><code class="language-diff"> function someFunction(
     $arg,
+    $arg2,
 ) {}</code></pre>
<p>Thanks <a href="/blog/2018/08/16/whats-new-in-php-73-in-30-seconds-in-diffs/#comment-4056622976">Jacob</a> for pointing <a href="https://wiki.php.net/rfc/trailing-comma-function-calls#wait_didn_t_we_just_vote_on_this">this difference</a> out.</p>
<p><br></p>
<p><em>25 seconds to go...</em></p>
<p><br></p>
<h2 id="2-First-and-Last-Array-Key">2. First and Last Array Key</h2>
<p><a href="https://wiki.php.net/rfc/array_key_first_last" class="btn btn-info btn-sm">
See RFC
</a></p>
<ul>
<li><a href="http://php.net/manual/en/function.array-key-first.php"><code>array_key_first</code></a></li>
</ul>
<pre><code class="language-diff"> $items = [
     1 =&gt; 'a',
     2 =&gt; 'b',
 ];

-reset($items);
-$firstKey = key($items);
+$firstKey = array_key_first($items);
 var_dump($firstKey); // 1</code></pre>
<ul>
<li><a href="http://php.net/manual/en/function.array-key-last.php"><code>array_key_last</code></a></li>
</ul>
<pre><code class="language-diff"> $items = [
     1 =&gt; 'a',
     2 =&gt; 'b',
 ];

-end($items);
-$lastKey = key($items);
+$lastKey = array_key_last($items);
 var_dump($lastKey); // 2</code></pre>
<p>These will be handy in <a href="https://github.com/symplify/symplify/blob/84987acb99b68748997fe205e9e5506035a36cfc/packages/TokenRunner/src/Wrapper/FixerWrapper/ClassWrapper.php#L118-L120">coding standard</a> <a href="https://github.com/symplify/symplify/blob/84987acb99b68748997fe205e9e5506035a36cfc/packages/CodingStandard/src/Fixer/Strict/BlankLineAfterStrictTypesFixer.php#L59-L60">tools</a>.</p>
<p><br></p>
<p><em>Still 15 seconds...</em></p>
<p><br></p>
<h2 id="3-Countable-for-Risky-Variables">3. Countable for Risky Variables</h2>
<p><a href="https://wiki.php.net/rfc/is-countable" class="btn btn-info btn-sm">
See RFC
</a></p>
<p>I don't think having a variable of 2 forms is a good idea:</p>
<pre><code class="language-php">&lt;?php

$items = null; // same as "private $items;" in a class

echo sprintf('There is %d items', count($items));
// error Warning: count(): Parameter must be an array or an object that implements Countable</code></pre>
<p>But in case of that smelly (3rd party) code, there is a help:</p>
<ul>
<li><a href="http://php.net/manual/en/function.is-countable.php"><code>is_countable</code></a></li>
</ul>
<pre><code class="language-diff"> $items = null;

+if (is_countable($items)) {
-echo sprintf('There is %d items', count($items));
+     echo sprintf('There is %d items', count($items));
+}</code></pre>
<p><em>Only 5 seconds, hurry!</em></p>
<p><br></p>
<h2 id="4-Safer-JSON-Parsing">4. Safer JSON Parsing</h2>
<p><a href="https://wiki.php.net/rfc/json_throw_on_error" class="btn btn-info btn-sm">
See RFC
</a></p>
<pre><code class="language-diff">-json_encode($data);
+json_encode($data, JSON_THROW_ON_ERROR);</code></pre>
<pre><code class="language-diff">-json_decode($json);
+json_decode($json, false, 512, JSON_THROW_ON_ERROR);</code></pre>
<p>So you'll be able to do:</p>
<pre><code class="language-php">try {
    return json_decode($json, false, 512, JSON_THROW_ON_ERROR);
} catch (JsonException $exception) {
    // ...
}</code></pre>
<p>I've used similar technique for years thanks to <a href="https://doc.nette.org/en/2.4/json">Nette\Utils</a> and I've never complained:</p>
<pre><code class="language-php">&lt;?php

try {
    return Nette\Utils\Json::encode($value);
} catch (Nette\Utils\JsonException $exception) {
    // ...
}</code></pre>
<p><em>...0, you made it! Congrats, now get back to pwning the world!</em></p>
<p><br></p>
<p>Did I miss a feature you plan to use from day 1 of your PHP 7.3? I might too, drop it in the comments!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/08/16/whats-new-in-php-73-in-30-seconds-in-diffs</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 16 Aug 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/08/16/whats-new-in-php-73-in-30-seconds-in-diffs#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Hidden Gems of PHP Packages: Symfony\Finder and SplFileInfo ]]></title>
                <link>https://tomasvotruba.com/blog/2018/08/13/hidden-gems-of-php-packages-symfony-finder-and-spl-file-info</link>
                <description><![CDATA[ <p>The series on not-so-well-known packages that might save your ass more than you think continues.
Today we look on <strong>files as objects</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Why-I-Use-it">Why I Use it?</h2>
<ol>
<li>
<p>Do you work with files in 5 different places in your application in a single way and you miss consistent naming?</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

function processFile(string $file) {
     // is absolute?
     // relative to what?
}

function processFile(string $fileAbsolute) {}
function processFile(string $filePath) {}
function processFile(string $absoluteFile) {}
function processFile(string $relativePath) {}
function processFile(string $filename) {}</code></pre>
</li>
<li>
<p>Do you need to test file paths on various CI machines?</p>
<pre><code class="language-diff">Expected test string didn't match:
-Error was found in: /home/im-very-cool-guy/my-website/www/my-home-porn-web/public/index.php
+Error was found in: /travic-ci/travis-directory-for-this-web/public/index.php</code></pre>
</li>
<li>
<p>Do you want to report the user the relative path instead of hard to read absolute one?</p>
<pre><code class="language-diff">-Error was found in: /home/im-very-cool-guy/my-website/www/my-home-porn-web/public/index.php
+Error was found in: public/index.php</code></pre>
</li>
<li>
<p>Do you want to forget all those <code>file_*</code> functions and just work with the file instead?</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

file_exists($file);
is_file($file);
is_directory($file); // actually: is_dir($file);
is_readable($file);
is_absolute($file); // well, you have to create this one yourself, and don't forget the Windows and Linux differences!</code></pre>
</li>
</ol>
<p><strong>Thanks to Symfony\Finder and its custom <code>SplFileInfo</code> I can be lazy, use object API and work safer and faster</strong> in all these cases above and more. Actually, I started to using <code>SplFileInfo</code> over <em>stringly</em> file paths/names after too many bugs appeared in my code and I'm happier and more relaxed ever since.</p>
<p>What is <a href="http://php.net/manual/en/class.splfileinfo.php"><em>splFileInfo</em></a>? It's native object in PHP - like <code>DateTime</code> - that wraps the file and provides nice object API for it. The Symfony\Finder package adds 3 extra methods that make work with files just a bit smoother. They go very well together since the package creates all the <code>splFileInfo</code> instances for you.</p>
<h2 id="How-to-Install">How to Install</h2>
<pre><code class="language-bash">composer require symfony/finder</code></pre>
<h2 id="How-I-Use-it">How I Use it</h2>
<p>We'll find all available feature in <a href="https://symfony.com/doc/current/components/finder.html">the documentation</a>, but basic usage it like this:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

use Symfony\Component\Finder\Finder;

$finder = Finder::create()
    -&gt;files()
    -&gt;in(__DIR__)
    -&gt;name('composer.json')
    -&gt;getIterator();

foreach ($finder as $splFileInfo) {
    var_dump($splFileInfo); // instance of "Symfony\Component\Finder\SplFileInfo"
}</code></pre>
<h2 id="Symfony-Component-Finder-Finder"><code>Symfony\Component\Finder\Finder</code></h2>
<h3 id="name"><code>name()</code></h3>
<p>This method accepts also regular expressions. Do you want to find all YAML files?</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

use Symfony\Component\Finder\Finder;

$finder = Finder::create();
$finder-&gt;name('#\.(yaml|yml)$#');</code></pre>
<h3 id="append"><code>append()</code></h3>
<p>Do you want to add just a single file that finder criteria would not find? Normally, you'd have to create <code>SplFileInfo</code> manually, think of relative/absolute paths etc. So much work. Instead, you can just append it and Finder will add it for you.</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

use Symfony\Component\Finder\Finder;

return Finder::create()
    -&gt;name('#\.php$#')
    -&gt;in(__DIR__ . '/Source')
    -&gt;append([__DIR__ . '/Source/SomeClass.twig']);</code></pre>
<h3 id="notPath-or-exclude"><code>notPath()</code> or <code>exclude()</code></h3>
<p>It's common and bad practice to put tests files into <code>/src</code>. It's historical reason mostly, but we still have to deal with that.
You don't want to work with 3rd party code tests, right?</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

use Symfony\Component\Finder\Finder;

$finder = Finder::create()
    // directories
    -&gt;exclude('spec')
    -&gt;exclude('test')
    -&gt;exclude('Tests')
    -&gt;exclude('tests')
    -&gt;exclude('Behat')
    -&gt;name('*.php');

// or match path name
$finder-&gt;notPath('#tests#');</code></pre>
<h2 id="Symfony-Component-Finder-SplFileInfo"><code>Symfony\Component\Finder\SplFileInfo</code></h2>
<h3 id="getRelativePath"><code>getRelativePath()</code></h3>
<p>Let's get back to the <code>composer.json</code> example above (from in <a href="https://github.com/Symplify/MonorepoBuilder/blob/71d81fe279b43b3353d107560198fd5cf52d487c/src/PackageComposerFinder.php#L23-L38">MonorepoBuilder</a>). This is how we get relative <strong>directory</strong>:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

/** @var \Symfony\Component\Finder\SplFileInfo $splFileInfo */
$splFileInfo-&gt;getRelativePath(); // "/"</code></pre>
<h3 id="getRelativePathname"><code>getRelativePathname()</code></h3>
<p>This method is bit different - it returns <strong>relative filename</strong>:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

/** @var \Symfony\Component\Finder\SplFileInfo $splFileInfo */
$splFileInfo-&gt;getRelativePath(); // "composer.json"</code></pre>
<p>This is very handy for output reporting in PHP CLI Apps like ECS, PHP CS Fixer, PHP_CodeSniffer or PHPStan. Compare yourself - the computer absolute scope:</p>
<pre><code class="language-diff">An error was found in /home/im-very-cool-guy/my-website/www/my-home-porn-web/public/index.php</code></pre>
<p>and human relative scope:</p>
<pre><code class="language-diff">An error was found in public/index.php</code></pre>
<h3 id="Honorable-Mentions">Honorable Mentions</h3>
<p>There are few more methods that I use from time to time:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

/** @var \Symfony\Component\Finder\SplFileInfo $splFileInfo */
$splFileInfo-&gt;getRealPath();
// absolute path - returns "/var/www/this-post/composer.json"

$splFileInfo-&gt;getContents();
// gets the content of file with error propagated to an exception - very nice!

$splFileInfo-&gt;getBasename('.' . $splFileInfo-&gt;getExtension());
// returns "composer"</code></pre>
<p><br></p>
<p>Do you like it? <strong>Go and give <a href="https://github.com/symfony/finder">Symfony\Finder</a> or at least <a href="http://php.net/manual/en/class.splfileinfo.php"><code>SplFileInfo</code></a> a try</strong>.</p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/08/13/hidden-gems-of-php-packages-symfony-finder-and-spl-file-info</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 13 Aug 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/08/13/hidden-gems-of-php-packages-symfony-finder-and-spl-file-info#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Why is Your Company Losing Money By Not Open Sourcing 2: Code Quality ]]></title>
                <link>https://tomasvotruba.com/blog/2018/08/09/why-is-your-company-losing-money-by-not-open-sourcing-2-code-quality</link>
                <description><![CDATA[ <p>There is more high-quality code in open-source than in closed-source. Open-source code is rarely rewritten from the scratch investing loads of time and effort - <a href="https://blog.codinghorror.com/version-1-sucks-but-ship-it-anyway">apart 1st version because it's designed to be dropped</a>. This case is not so rare in the private sector in long-term projects.
<br><br>
<strong>Rubber ducking. Standard-bias of public behavior. Social learning. Embodied know-how.</strong> Values natural for open-source, yet seen only in high-standard private coding. Why is that? And <strong>how to make your project benefit from these values</strong>?</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="1-Cheap-Standards-vs-Expensive-Private-Few-Person-Based-Solutions">1. Cheap Standards vs. Expensive Private Few-Person-Based Solutions</h2>
<h3 id="Why-Even-Bother-With-Standards">Why Even Bother With Standards?</h3>
<p>Standards are not just a set of rules to bully your individual approach as a programmer or as a team. Spaces and tabs are not here to make teams, although the in-group and out-group effect is strong. Standards are brought up naturally by people, who do so much repetitive work, they want to automate it. <strong>They see a pattern a small majority is using to save time from too little details and invest in values that matter for them instead</strong>. Whether it's sustainable code people will love so much they'll want to grab a beer with you or 1-minute deployment of your application.</p>
<p>That's the reason all these PSR-2, PSR-4 etc. were created. Huge thanks to all guys from FIG - <strong>especially for <a href="https://medium.com/php-fig">monthly summaries on Medium</a></strong>.</p>
<p>Btw, do you know <a href="https://www.php-fig.org/faqs/#what-does-psr-stand-for">what does <em>PSR</em> stand for</a>? <em>PHP Strict Rules...</em>? That's would terrible. It's <strong>PHP Standard Recommendation</strong>. Read it as:</p>
<blockquote class="blockquote text-center">
    "Here is a baseline for a thing you don't want to think about. You can work with it and most people will understand it without you explaining anything. Just like that."
</blockquote>
<p>When I talk about standards, there lays much more value beyond PSRs. That's how we get to <em>the money</em>.</p>
<h3 id="Where-is-Your-Company-Losing-Money">Where is Your Company Losing Money?</h3>
<p>If your team start a big project, you need to resolve many <em>first-steps</em>:</p>
<ul>
<li>What rules should belong to coding standard?</li>
<li>How to deploy and where?</li>
<li>Should you use MVC or plain PHP?</li>
<li>How to design architecture that will last over 5 years?</li>
<li>How to make sure that after you leave, others will still understand and effectively contribute the code?</li>
<li>etc.</li>
</ul>
<p><strong>You can waste thousands of company money by reinventing everything from scratch. Everything that community already solved for you.</strong></p>
<p>By choosing a framework that is not much adopted or doesn't respect standard, <strong>naturally leads to extra pointless expenses</strong>:</p>
<ul>
<li>To pay somebody to teach them the framework</li>
<li>To pay people to learn the specific non-standard behavior of the framework</li>
<li>To pay for bugs that will be created by not following a framework that has such practices embodied in the code</li>
<li>To pay for the eventual rewriting of your coupled code in next 10 years to a new framework the next team will choose, after the first team will leave you for a better experience - personally, I've seen a code of 8 such projects.</li>
</ul>
<h3 id="Frameworks-Teach-Bad-Practises">Frameworks Teach Bad Practises</h3>
<p>I hear you: &quot;but most PHP frameworks teach people bad practice just to vendor lock them&quot;. I <a href="https://matthiasnoback.nl/2014/10/unnecessary-contrapositions-in-the-new-symfony-best-practices">agree</a>. <strong>But it's still easier to learn what works and what doesn't from standard frameworks. Why? The amount of paths to create a website is limited, so is the scope we have to orientate. Compared to plain PHP where you can use zillion ways to create a website.</strong></p>
<p>It's like having parents - they bring you something good and something bad. Yet it's still better to learn from them than from no parents at all.</p>
<h3 id="Get-Embodied-Know-How-For-Free">Get Embodied Know-How For Free</h3>
<p>So instead of putting money into lecturers that will teach you rarely used technologies, you can adopt standards that are natural in open-source and to a big part of the PHP community. <strong>That way the know-how is embedded into your code and you don't need a lecturer to explain it.</strong></p>
<p>What does it mean? Imagine Symfony. Just by using this framework, you'll get access to many PSRs that Symfony uses. That allows you to use many PHP packages that support these PRSs. Instead of writing Doctrine yourself from scratch, just use it and save yourself loads of money.</p>
<h2 id="2-How-to-Get-All-Services-for-Your-Project-for-0-a-Month">2. How to Get All Services for Your Project for 0 $ a Month?</h2>
<p>From Travis, Github, Gitlab, CircleCI, Github Pages, to Slack, Cloudflare and many more - they give you <strong>free services for open-sourced code</strong>. They probably believe most people will start there for free. Then they grow and change to closed-source when the code base is so huge to be kept at high standards. Maybe they need to do some nasty things that people should not know.</p>
<p>Instead, you can go vice-versa. Drop Jenkins, private Github, private Travis and all the other services and <strong>go from 5000 $ of expenses to 0 $ in one week</strong>.</p>
<h3 id="All-About-the-Money">All About the Money</h3>
<p>A reminder this is not solely about the money. You can save money for private Github and Travis just by migrating to private Gitlab that you can even host. Many friends and projects of I know work this way. But the benefit I talk about works the best in one wave with all other benefits, like embodied know-how, mentoring from experts and <a href="/blog/2018/07/26/why-is-your-company-losing-money-by-not-open-sourcing-1-hiring/">open-source hiring</a>.</p>
<h2 id="3-How-to-Pay-Top-PHP-Mentors-0">3. How to Pay Top PHP Mentors 0 $</h2>
<p>Tom Preston-Werner, one of Github founders <a href="https://tom.preston-werner.com/2011/11/22/open-source-everything.html">wrote</a>:</p>
<blockquote class="blockquote">
    "<strong>Smart people like to hang out with other smart people. Smart developers like to hang out with smart code</strong>. When you open source useful code, you attract talent. Every time a talented developer cracks open the code to one of your projects, you win. I've had many great conversations at tech conferences about my open source code. Some of these encounters have led to ideas that directly resulted in better solutions to problems I was having with my projects. In an industry with such a huge range of creativity and productivity between developers, the right eyeballs on your code can make a big difference."
</blockquote>
<p>The best people don't go after money, nor powerful Docker cluster setup, nor extra 5 days of holiday. These might be important elements and their absence won't appreciate, but the best programmers strive for something extra.</p>
<p><strong>The best programmers go for know-how, credit, and impact.</strong></p>
<h3 id="Impact-or-5-Days-of-Extra-Holiday">Impact or 5 Days of Extra Holiday?</h3>
<p>Imagine this: you contribute a feature to a private project for selling cars. If you're lucky, 2 more programmers will see your code during the code review, then it gets merged and forgotten until there is a bug with your name in <code>git blame</code> line.</p>
<p>On the other hand, <strong>if you contribute to a Symfony project, around 10-20 people on average will see your code pull-request</strong>. And if it gets merged? <strong>Your code will be downloaded to <a href="https://packagist.org/packages/symfony/http-kernel/stats">110 000+ applications every day</a></strong>.</p>
<p>Of course, it's nonsense to compare your <em>about-to-be-open-sourced</em> project with 13-years old Symfony. Yet 10 downloads a week is a huge success compared to current zero. This number will be only growing if you continue the package development.</p>
<p>I remember EasyCodingStandard had 3 downloads a day (my, my girlfriend and my mum ;)). Now a 1,5 year later it has over <a href="https://packagist.org/packages/symplify/easy-coding-standard/stats">500 installs a day</a>.</p>
<h3 id="Give-Me-the-Mentors">Give Me the Mentors</h3>
<p>So where do the mentors come from? They're people using your package or - and that's more common than you think - <strong>a people who love to spread their gene code into commits of your package by</strong> cleaning it up or adding their package that will help you with the code.</p>
<p>Here are few examples of <em>win-win</em> situation I noticed on Github:</p>
<ul>
<li><a href="https://github.com/nikic/PHP-Parser/pull/408">Tomas Votruba fixing coding style in php-parser</a></li>
<li><a href="https://github.com/php/php-src/pulls?q=is%3Apr+author%3Acarusogabriel+is%3Aclosed+sort%3Aupdated-desc">Gabriel Caruso and his 110 PRs to php-src</a></li>
<li><a href="https://github.com/cakephp/cakephp/pull/9943">Ondrej Mirtes adding PHPStan to CakePHP</a></li>
</ul>
<p><strong>One could say that by open-sourcing a project you'll get the attention of alfa-males programmers.</strong></p>
<p>Such programmers will give you contributions for free. They'll talk with you for free, they'll suggest you or send you features for free and that's definitely less than what your company is paying programmers for the work. Well, not for free, but <strong>for the credit that open-source project's popularity will give them back</strong>. They wouldn't do it if you'd remove their names from commits messages.</p>
<h3 id="Be-Opened-to-Free-Fixes">Be Opened to Free Fixes</h3>
<p>By open-sourcing, you also say: &quot;Do we have a bug? Come and fix it, please&quot;. One example for all:</p>
<p>I was using <a href="http://naucmese.cz">Naucmese.cz</a> a lecture from anyone to anyone portal about 5 years ago. I found a bug. 2 bugs. After the 3rd bug, I wrote them &quot;just open-source the project and I'll fix it for free&quot;. I was frustrated by those bugs that <strong>I'd be happy to invest 30 minutes of my free time to fix them and make using the application much nicer experience</strong>. If that project would be open-sourced, they'd get 2-3 hours per week of my work for free in that time. Instead, they hired me but that's another story.</p>
<p>My approach still stands for other projects, just write me about freshly open-sourced code and I'd be happy to be your first contributor on GitHub.</p>
<h2 id="4-The-Coding-Naked-Man">4. The Coding Naked Man</h2>
<p>Do you know <a href="https://blog.codinghorror.com/rubber-duck-problem-solving">rubber ducking</a>? In short: <strong>it's way of working with an invisible second person next to you that increases the quality of code you produce</strong>.</p>
<p>I've experienced this myself in many layers:</p>
<p>When I was working in Brno on freelance and had a small flat just for myself, I spent 1/3 of my work time playing games and watching porn.
I wanted to stop, I wanted to focus, to code, to work, but it was extremely difficult for every single of 3 months I was there alone.
Then I moved to coworking center into open-space and suddenly - it stopped. I began to be 200 % more productive in the first week. How was that possible? Well, obviously I was shy to watch porn and masturbate in the public so I worked that 1/3 of time, but there is more. <strong>Just by having people around me, I wanted to be like them, to work, to bring values. In such a place as coworking hub, it was standard to work and to do meaningful work</strong>. So I adapted for better just by being there.</p>
<p>The same goes for <em>Coding Naked Man</em> principle. When I put my first code open-source (after 2 years of hiding in fear from rejection and being a fraud) on GitHub in 2010, I was super ashamed for the code. It felt like I'm putting my favorite porn on school page where every single schoolmate could see it.</p>
<p>By simply putting the code out I realized that I can do much better with the code. But what's the most important, <strong>I started to see path what exactly can I learn</strong> just by seeing other similar projects.</p>
<h3 id="Hide-Your-Private-Shame">Hide Your Private Shame</h3>
<p>You can probably see this principle work even in your company. Have you ever seen an open-source project where maintainers say, that you can use static methods, public properties, and service locators if you know why? I don't say that happens, but it's very rare.</p>
<p>On the other hand, when I code-review private projects on such code smells, I get almost brain-washed answers like:</p>
<ul>
<li>&quot;we had to use it there&quot;,</li>
<li>&quot;we know it's not optimal, but...&quot;,</li>
<li>&quot;we didn't have time&quot;,</li>
<li>&quot;we know we have to keep it only in that place&quot;.</li>
</ul>
<p>But when I ask more, I see they have no deeper idea why. They only know the 1 reason to write bad code even if they really don't have to. <strong>It's like a candy you steal but nobody knows about it</strong>. Nobody else will ever see this code, and if they'll do, you'd be already in that another company.</p>
<p>And it's super difficult to think open while being closed. But by having code open-source, you'll adopt this mindset by natural in just a few months. After years, I can now feel if I'm hacking something the wrong way <a href="/blog/2018/04/26/how-i-got-into-static-trap-and-made-fool-of-myself/">that will hunt me down 2 years later</a> or if the code really can't be better.</p>
<p><br><br></p>
<p>And that's it!</p>
<p>Happy open-sourcing</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/08/09/why-is-your-company-losing-money-by-not-open-sourcing-2-code-quality</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 09 Aug 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/08/09/why-is-your-company-losing-money-by-not-open-sourcing-2-code-quality#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Stylish and Standard Console Output with Symfony Style ]]></title>
                <link>https://tomasvotruba.com/blog/2018/08/06/stylish-and-standard-console-output-with-symfony-style</link>
                <description><![CDATA[ <p>Even if you don't use any component from Symfony or even installed one, you can use this trick in your PHP CLI App.
<br><br>
It's simple, provides standard and makes your output look like a design from Apple - useful and nice at the same time.</p> ]]></description>
                <content:encoded><![CDATA[ <p>We want to <strong>report various states</strong> in PHP CLI Apps. Success message on the finish, errors message in case of failure or just simple note so users know that command is not stuck but working.</p>
<h2 id="Too-Many-Ways-to-Do-1-Thing">Too Many Ways to Do 1 Thing</h2>
<p>You can use plain PHP like <a href="https://github.com/squizlabs/PHP_CodeSniffer/blob/f893189392f9a0566aa837c4bcad3929c60d5348/src/Runner.php#L199">in PHP_CodeSniffer</a>:</p>
<pre><code class="language-php">&lt;?php

try {
    // code
} catch (Exception $exception) {
    echo $exception-&gt;getMessage();
    return $exception-&gt;getCode();
}</code></pre>
<p>There is also a bit advanced use of native <code>OutputInterface</code> in command like <a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer/blob/1c10240da97479274fd40a136c3857ff94f7f93f/src/Console/Command/FixCommand.php#L236-L239">PHP CS Fixer</a>:</p>
<pre><code class="language-php">&lt;?php

use Symfony\Component\Console\Command\Command;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Output\OutputInterface;

final class SomeCommand extends Command
{
    protected function execute(InputInterface $input, OutputInterface $output)
    {
        // ...

        $output-&gt;write('Working on it!');

        // ...
    }
}</code></pre>
<p>The advantage of these approaches is <strong>they cannot be simpler and they're ready to be used</strong>. I bet everyone can use <code>echo 'DONE';</code>:</p>
<img src="/assets/images/posts/2018/console-output/plain.png">
<p>The second approach is not as easy, but if you're in a Symfony Command class using PHPStorm all you have to do is hit <code>Ctrl + Space</code> on an <code>$output</code> variable. And in their time they were good enough.</p>
<p>But we want more than a plain text. <strong>If websites can have CSS, colors, and pictures, why not the CLI output?</strong></p>
<img src="/assets/images/posts/2018/console-output/console.png">
<p>But it's not about colors, <strong>it's about UX</strong>. <em class="text-white bg-success p-2">Green</em> and <em class="text-white bg-danger p-2">red</em> lines instead of white on black spaghetti like on the first image.</p>
<img src="/assets/images/posts/2018/console-output/tracy.png">
<p><br></p>
<p>Last but not least, Symfony <code>$output</code> has <a href="https://symfony.com/doc/current/console/coloring.html#using-color-styles">few predefined styles</a>:</p>
<pre><code class="language-php">&lt;?php

// green text
$output-&gt;writeln('&lt;info&gt;foo&lt;/info&gt;');

// white text on a red background
$output-&gt;writeln('&lt;error&gt;foo&lt;/error&gt;');</code></pre>
<p>And also some colors and <strong><u>cool stuff</u></strong>:</p>
<pre><code class="language-php">// green text
$output-&gt;writeln('&lt;fg=green&gt;foo&lt;/&gt;');

// bold text with underscore
$output-&gt;writeln('&lt;options=bold,underscore&gt;foo&lt;/&gt;');</code></pre>
<p><br></p>
<p>Which one do you like so far? So many colors, so many options... maybe too many.</p>
<h3 id="United-We-Stand-Divided-We-Autumn">United We Stand, Divided We Autumn</h3>
<p>Do you remember when there were <a href="https://github.com/container-interop/container-interop">a dozen ways to create Dependency Injection Container</a>? Fortunately, the <a href="https://www.php-fig.org/psr/psr-11">PSR-11 was born</a> to solve this and moved our focus to things that matter more.</p>
<p>We don't want to play with colors, with <code>fg</code>, <code>underscore</code>, <code>green</code>, <code>cyan</code> (wtf is cyan?) words. Also, you know what they say:</p>
<blockquote class="blockquote text-center">
    Strings?<br>
    Break things.
</blockquote>
<p><strong>We want to print the error and get back to coding</strong>.</p>
<h2 id="Symfony-2-8-to-the-Rescue">Symfony 2.8 to the Rescue</h2>
<p>I was super happy when the <a href="https://symfony.com/blog/new-in-symfony-2-8-console-style-guide">SymfonyStyle</a> helper class came with Symfony 2.8. Simple wrapper about all mentioned above, <code>success()</code> method, <code>error()</code> method, all in API.</p>
<img src="https://farm1.staticflickr.com/666/23555673406_6cbd4f5460_o.png">
<p>I think it's not an understatement to say that <code>SymfonyStyle</code> is state of art in this matter.</p>
<h3 id="1-It-s-Easy-to-Integrate-into-Symfony-Command">1. It's Easy to Integrate into Symfony Command</h3>
<p>PHPStan is <a href="https://github.com/phpstan/phpstan/blob/1e232b3da00671a578b0ba451c5d15c904a82fd5/src/Command/ErrorsConsoleStyle.php#L9">using it</a>:</p>
<pre><code class="language-diff"> &lt;?php

 use Symfony\Component\Console\Command\Command;
 use Symfony\Component\Console\Input\InputInterface;
 use Symfony\Component\Console\Output\OutputInterface;
+use Symfony\Component\Console\Style\SymfonyStyle;

 final class SomeCommand extends Command
 {
     protected function execute(InputInterface $input, OutputInterface $output)
     {
         $output-&gt;write('Working on it!');
+         $symfonyStyle = new SymfonyStyle($input, $output);
+         $symfonyStyle-&gt;note('Working on it!');
+         $symfonyStyle-&gt;success('DONE!');
    }
}</code></pre>
<h3 id="2-Don-t-make-User-Think">2. Don't make User Think</h3>
<p>When I was 13 years old I've accidentally read <a href="https://www.sensible.com/dmmt.html"><em>Don’t Make Me Think</em></a>, amazing book about UX, programming and psychology for dummies (I'm about to read 2014-revised version). The main point of the book was the Apple, the UX, and the DX mantra - <strong>create a design that users already expect, don't teach them doing common things differently</strong>.</p>
<p>I recall many CLI Apps that each has different output - no colors, different font-size, cool underlines, error message is not red but success is green etc. <strong>User have to focus on the design and understand it instead of enjoying your app</strong>. WTF of non-red exception is just great!</p>
<p>This class offers a common way not to make use think. ECS users it, Statie uses it, PHPStan uses it, Rector uses and <a href="https://github.com/lmc-eu/steward/blob/66b90dc1b7325f680481e104ae19f7e6d77e7133/src/Console/Command/Command.php#L52">Steward</a> use it.</p>
<h3 id="3-SymfonyStyle-as-a-Service">3. SymfonyStyle as a Service</h3>
<p>You can create <code>SymfonyStyle</code> in simple static construction as in point 1, but what if you need it somewhere else than in a command? Imagine you have 1200 long Command (~= Controller) and you want to extract logic to another class?</p>
<p>Do you have to pass the whole command there or move the <code>SymfonyStyle</code> manually?</p>
<p>Save <a href="/blog/2018/04/26/how-i-got-into-static-trap-and-made-fool-of-myself/">the vendor-locking statics</a> for value objects and enjoy the constructor injection. There are more lines than one because we need to register <code>Input</code> and <code>Output</code> as a service and autowire their interfaces.</p>
<pre><code class="language-yaml">services:
    # SymfonyStyle
    Symfony\Component\Console\Input\ArgvInput: ~
    Symfony\Component\Console\Input\InputInterface:
        alias: 'Symfony\Component\Console\Input\ArgvInput'
    Symfony\Component\Console\Output\ConsoleOutput: ~
    Symfony\Component\Console\Output\OutputInterface:
        alias: 'Symfony\Component\Console\Output\ConsoleOutput'
    Symfony\Component\Console\Style\SymfonyStyle: ~</code></pre>
<pre><code class="language-diff"> &lt;?php

 use Symfony\Component\Console\Command\Command;
 use Symfony\Component\Console\Input\InputInterface;
 use Symfony\Component\Console\Output\OutputInterface;
 use Symfony\Component\Console\Style\SymfonyStyle;

 final class SomeCommand extends Command
 {
+    /**
+     * @var SymfonyStyle
+     */
+    private $symfonyStyle;
+
+    public function __construct(SymfonyStyle $symfonyStyle)
+    {
+        $this-&gt;symfonyStyle = $symfonyStyle;
+    }
+
     protected function execute(InputInterface $input, OutputInterface $output)
     {
-         $symfonyStyle = new SymfonyStyle($input, $output);
-         $symfonyStyle-&gt;note('Working on it!');
+         $this-&gt;symfonyStyle-&gt;note('Working on it!');
-         $symfonyStyle-&gt;success('DONE!');
+         $this-&gt;symfonyStyle-&gt;success('DONE!');
    }
}</code></pre>
<h3 id="4-Show-Your-Style">4. Show Your Style</h3>
<p>Last little detail that makes the whole experience nice and smooth. EasyCodingStandard uses SymfonyStyle, but it needed to add 1 extra method.</p>
<ul>
<li>There could be 2 services but that extra burden for the contributors... but <strong>we don't make the user think</strong>.</li>
<li>Then I tried composition, so I had to replicate many public methods. It shoots me back with too much maintenance and duplicated code.</li>
<li>After seeing these options, I've happily settled with extension:</li>
</ul>
<pre><code class="language-php">final class OurStyle extends SymfonyStyle
{
    public function pink(string $message)
    {
        // ...
    }
}</code></pre>
<p><em>One real example for all, check <a href="https://github.com/lmc-eu/steward/blob/724f72da6ae732065142f10b4100ea65b7282406/src/Console/Style/StewardStyle.php"><code>StewardStyle</code> class on Github</a>.</em></p>
<p><br><br></p>
<p>And that's it!</p>
<p>Try the simple approach today and you'll see you won't regret it:</p>
<pre><code class="language-php">&lt;?php

use Symfony\Component\Console\Command\Command;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\Console\Style\SymfonyStyle;

final class SomeCommand extends Command
{
     protected function execute(InputInterface $input, OutputInterface $output)
     {
         $symfonyStyle = new SymfonyStyle($input, $output);
         $symfonyStyle-&gt;note('Working on it!');
         $symfonyStyle-&gt;success('DONE!');
    }
}</code></pre>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/08/06/stylish-and-standard-console-output-with-symfony-style</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 06 Aug 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/08/06/stylish-and-standard-console-output-with-symfony-style#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 5 Gotchas of the Bin File in PHP CLI Applications ]]></title>
                <link>https://tomasvotruba.com/blog/2018/08/02/5-gotchas-of-the-bin-file-in-php-cli-applications</link>
                <description><![CDATA[ <p>This post focuses on bin files. It's the smallest part of PHP CLI Application, so I usually start with it.
<br><br>
Yet, there are still a few blind paths you can struggle with. I'll drop a few extra tricks to make your bin file clean and easy to maintain.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="What-is-the-Bin-File">What is the Bin File?</h2>
<p>The bin file is not a trash bin. It's a binary file, the entry point to your application the same way <code>www/index.php</code> is. You probably already use them:</p>
<ul>
<li><a href="https://github.com/symplify/symplify/blob/master/packages/easy-coding-standard/bin/ecs">vendor/bin/ecs</a></li>
<li><a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer/blob/master/php-cs-fixer">vendor/bin/php-cs-fixer</a></li>
<li><a href="https://github.com/squizlabs/PHP_CodeSniffer/blob/master/bin/phpcs">vendor/bin/phpcs</a></li>
<li><a href="https://github.com/phpstan/phpstan-src/blob/master/bin/phpstan">vendor/bin/phpstan</a></li>
</ul>
<h2 id="1-Create-it">1. Create it</h2>
<h3 id="The-Name">The Name</h3>
<p>The bin file should be <strong>named after the application</strong>, <strong>short</strong> and <strong>easy to type</strong>.
So when I first released EasyCodingStandard, I used <code>easy-coding-standard</code> name. It was easy to remember, but when I had a talk I often miss-typed such a long name. After a while, I moved to <code>ecs</code>.</p>
<p>It should be also <strong>easy to remember</strong> and <strong>unique</strong>.
Imagine that <code>php-cs-fixer</code> would be <code>phpcf</code> or <code>phpcf</code>. Since there is already <code>phpcs</code> taken, it might be trouble to remember. I think that's why the name is a little bit longer.</p>
<h3 id="The-Location">The Location</h3>
<p>Where to put the file? Few people in the past put it in the root directory (only <code>php-cs-fixer</code> from 4 projects above have it that way). But <strong>the trend is to use <code>bin</code> directory</strong>. The same way <code>index.php</code> was moved to <code>www/index.php</code> or <code>public/index.php</code>.</p>
<pre><code class="language-bash">bin/your-bin-file</code></pre>
<h2 id="2-Composer-Autoload">2. Composer Autoload</h2>
<p>With structure like this:</p>
<pre><code class="language-bash">/bin/your-bind-file
/src
/vendor/autoload.php</code></pre>
<p>The obvious code to add to <code>/bin/your-bind-file</code> is:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

require_once  __DIR__ . '/../vendor/autoload.php';</code></pre>
<p>And that's it!</p>
<p><br></p>
<p>Not that fast. It might work for your <code>www/index.php</code> file in your application, but is <strong>that application ever installed as a dependency</strong>?</p>
<p>How do we cover autoload for a dependency? Imagine somebody would install <code>your-vendor/your-package</code> on his application. The file structure would look like this:</p>
<pre><code class="language-bash">/src/
/vendor/autoload.php
/vendor/your-vendor/your-package/bin/your-bin-file</code></pre>
<p>Now we need to get to <code>/vendor/autoload.php</code> of that application:</p>
<pre><code class="language-diff"> &lt;?php declare(strict_types=1);

-require_once  __DIR__ . '/../vendor/autoload.php';
+require_once  __DIR__ . '/../../../../vendor/autoload.php',</code></pre>
<p>Great, people can use our package now. But it stopped working for our local repository. We'll probably have to seek for both of them:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

$possibleAutoloadPaths = [
    // local dev repository
    __DIR__ . '/../vendor/autoload.php',
    // dependency
    __DIR__ . '/../../../../vendor/autoload.php',
];

foreach ($possibleAutoloadPaths as $possibleAutoloadPath) {
    if (file_exists($possibleAutoloadPath)) {
        require_once $possibleAutoloadPath;
        break;
    }
}</code></pre>
<p><strong>Comments are very important</strong> because this is very easy to get lost in. Trust me, I managed to fail a dozen times. Also, other people will appreciate it because it's WTF to see loading more than one <code>vendor/autoload.php</code>.</p>
<p>Imagine you'd move your package to a monorepo structure:</p>
<pre><code class="language-diff"> $possibleAutoloadPaths = [
-    // local dev repository
+    // after split repository
     __DIR__ . '/../vendor/autoload.php',
     // dependency
     __DIR__ . '/../../../../vendor/autoload.php',
+    // monorepo
+    __DIR__ . '/../../../vendor/autoload.php',
 ];</code></pre>
<h3 id="Exceptionally-Well-Done">Exceptionally Well Done</h3>
<pre><code class="language-diff"> &lt;?php declare(strict_types=1);

 $possibleAutoloadPaths = [
     // local dev repository
     __DIR__ . '/../vendor/autoload.php',
     // dependency
     __DIR__ . '/../../../../vendor/autoload.php',
 ];

+$isAutoloadFound = false;
 foreach ($possibleAutoloadPaths as $possibleAutoloadPath) {
     if (file_exists($possibleAutoloadPath)) {
         require_once $possibleAutoloadPath;
+        $isAutoloadFound = true;
         break;
     }
 }
+
+if ($isAutoloadFound === false) {
+    throw new RuntimeException(sprintf(
+        'Unable to find "vendor/autoload.php" in "%s" paths.',
+        implode('", "', $possibleAutoloadPaths)
+    ));
+}</code></pre>
<h2 id="3-She-Bangs">3. She Bangs</h2>
<p>Since the bin file doesn't have a <code>.php</code> suffix by convention a system doesn't know, what language it's in. What happens when we run the bin file?</p>
<pre><code class="language-bash">bin/your-bin-file</code></pre>
<p>↓</p>
<pre><code class="language-bash">vendor/bin/your-bin-file: 1: vendor/bin/your-bin-file: Syntax error: "(" unexpected</code></pre>
<p>Well, we know it's in PHP so run it with PHP:</p>
<pre><code class="language-bash">php bin/your-bin-file</code></pre>
<p>All works! But do we ever run this?</p>
<pre><code class="language-php">php composer</code></pre>
<p>No, because <strong>we're lazy and we want to type as less as possible</strong>. How do we achieve the same effect for our file?</p>
<p>We add a <a href="https://www.youtube.com/watch?v=5ihtX86JzmA"><em>shebang</em></a> - a special line that will tell the system what interpret should be used:</p>
<pre><code class="language-php">#!/usr/bin/env php
&lt;?php declare(strict_types=1);

// ...</code></pre>
<p>It can be translated to:</p>
<pre><code class="language-bash">/usr/bin/env php bin/your-bin-file</code></pre>
<p>Try it. Does it work?</p>
<h2 id="4-Free-Access-Rights">4. Free Access Rights</h2>
<p>This allows to run the bin file on other people's computer:</p>
<pre><code class="language-php">chmod +x bin/your-bin-file</code></pre>
<h2 id="5-The-Composer-Symlink">5. The Composer Symlink</h2>
<p>If we install your package, we'll find the bin file here:</p>
<pre><code class="language-bash">/vendor/your-vendor/your-package/bin/your-bin-file</code></pre>
<p>But not in:</p>
<pre><code class="language-bash">/vendor/bin/your-bin-file</code></pre>
<p>Too bad. We're super lazy, so we want it there. How can we make it happen?</p>
<p>The Composer has <a href="https://getcomposer.org/doc/articles/vendor-binaries.md#how-is-it-defined-">special <em>bin</em> section</a>, where we can <strong>define the symlink path for your bin file</strong>. Just add this to <code>composer.json</code> of your package:</p>
<pre><code class="language-json">{
    "bin": "bin/your-bin-file"
}</code></pre>
<p>Tada! After we install such a package, we'll find it in the right place.</p>
<pre><code class="language-bash">/vendor/bin/your-bin-file</code></pre>
<h2 id="Final-Version">Final Version</h2>
<pre><code class="language-php">#!/usr/bin/env php
&lt;?php declare(strict_types=1);

$possibleAutoloadPaths = [
     // local dev repository
     __DIR__ . '/../vendor/autoload.php',
     // dependency
     __DIR__ . '/../../../autoload.php',
];

foreach ($possibleAutoloadPaths as $possibleAutoloadPath) {
    if (file_exists($possibleAutoloadPath)) {
        require_once $possibleAutoloadPath;
        break;
    }
}

// your PHP code to run

$container = (new ContainerFactory)-&gt;create();
$application = $container-&gt;get(Application::class);
exit($application-&gt;run());</code></pre>
<p>And that's it!</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/08/02/5-gotchas-of-the-bin-file-in-php-cli-applications</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 02 Aug 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/08/02/5-gotchas-of-the-bin-file-in-php-cli-applications#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Hidden Gems of PHP Packages: Nette\Utils ]]></title>
                <link>https://tomasvotruba.com/blog/2018/07/30/hidden-gems-of-php-packages-nette-utils</link>
                <description><![CDATA[ <p>In this series, I will show you <strong>not-so-known PHP packages, that I happily use in my daily workflow</strong>. They're hard to describe in few words for their various features, but awesome and simple to use.
<br><br>
Today we start with <a href="https://github.com/nette/utils">Nette\Utils</a> package.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Why-I-Use-it">Why I Use it</h2>
<ol>
<li>
<p>Do you know how is called the PHP function that checks the presence of a string in another string?</p>
</li>
<li>
<p>Do you know what is the difference between those 3 calls?</p>
</li>
</ol>
<pre><code class="language-php">$contains = strpos('content', $lookFor) === 0;</code></pre>
<pre><code class="language-php">$contains = strpos('content', $lookFor) == 0;</code></pre>
<pre><code class="language-php">$contains = strpos('content', $lookFor) === false;</code></pre>
<p><strong>If you can tell the difference under 1 s</strong>, good job!</p>
<p><br></p>
<p>I can't. I have to think hard to remember what was that danger WTF of <a href="http://php.net/manual/en/function.strpos.php#refsect1-function.strpos-returnvalues"><code>strpos()</code> function</a>...</p>
<img src="/assets/images/posts/2018/nette-utils/warning.png" class="img-thumbnail">
<p>...that makes this code run into condition, even though you don't want to:</p>
<pre><code class="language-php">$contains = strpos('content', $lookFor);
if ($contains) {
   // ... should I be here?
}</code></pre>
<ol start="3">
<li>Do you prefer exceptions over <code>false</code>? Do you prefer exceptions over learning various errors codes in PHP native functions like <code>file_get_contents()</code> or <code>preg_replace</code>?</li>
</ol>
<img src="/assets/images/posts/2018/nette-utils/preg_replace.png" class="img-thumbnail">
<ol start="4">
<li>
<p>Do you prefer thinking less about PHP language details and doing more effective work while being safe?</p>
</li>
<li>
<p>Do you prefer PHPStan not reporting forgotten validation of <code>bool|string</code> return type?</p>
</li>
</ol>
<pre><code class="language-php">if (file_exists($filePath)) {
    // can return `false|string`
    $fileContent = file_get_contents($filePath);
}</code></pre>
<p><strong>Thanks to Nette\Utils I can be lazy, safe and much faster</strong> in all these cases above and more.</p>
<h2 id="How-to-Install">How to Install</h2>
<pre><code class="language-bash">composer require nette/utils</code></pre>
<h2 id="How-I-Use-it">How I Use it</h2>
<p>We can look at <a href="https://doc.nette.org/en/2.4/utils">the Nette\Utils documentation</a> to find 12 classes with many methods and study their API... and leave the page overwhelmed by details and over-bored.</p>
<p>Instead, <strong>we can look at real-life examples in Symplify code</strong>. That's much more interesting and relevant, right? When we use Github search, we see that Symplify packages use Nette\Utils package at <a href="https://github.com/search?l=&amp;q=Nette%5CUtils+repo%3Asymplify%2Fsymplify+extension%3Aphp&amp;type=Code">100+ places</a>. What are these cases?</p>
<h2 id="Strings-class"><code>Strings</code> class</h2>
<h3 id="replace"><code>replace()</code></h3>
<p>It accepts content, pattern to look for and replacement. This is basic building stone for packages like <a href="/blog/2018/07/05/how-to-convert-latte-templates-to-twig-in-27-regular-expressions/">LatteToTwigConverter</a>:</p>
<pre><code class="language-php">// in Latte: {var $var = $anotherVar}
// in Twig: {% set var = anotherVar %}
$content = Nette\Utils\Strings::replace($content, '#{var \$?(.*?) = \$?(.*?)}#s', '{% set $1 = $2 %}');</code></pre>
<p>It's nice that you don't have to deal with PHP native edge-cases of regular expressions. I think regulars are difficult enough to work with, so this piece comes very handy.</p>
<h3 id="contains"><code>contains()</code></h3>
<p>It accepts the content and the string we look for:</p>
<pre><code class="language-php">if (Nette\Utils\Strings::contains($key, '.')) {
    // is a code
    $this-&gt;skippedCodes[$key] = $settings;
} else {
    // is a class
    $this-&gt;skipped[$key] = $settings;
}</code></pre>
<h3 id="startsWith"><code>startsWith()</code></h3>
<p>How to detect a nullable type?</p>
<pre><code class="language-php"># &lt; 1 s of thinking
return Nette\Utils\Strings::startsWith($type, '?');</code></pre>
<pre><code class="language-php"># &gt; 1 s of thinking
return strpos('Content', $lookingFor) === ?;
# or was it this one?
return strpos('Content', $lookingFor) === strlen($lookingFor);</code></pre>
<h3 id="endsWith"><code>endsWith()</code></h3>
<pre><code class="language-php">if (Strings::endsWith($class, 'Interface')) {
    // is interface
}</code></pre>
<h2 id="FileSystem-class"><code>FileSystem</code> class</h2>
<h3 id="read"><code>read()</code></h3>
<p>If we know the file will be there (e.g. it's convention or we just put it there), we can use <code>file_get_contents()</code>.</p>
<pre><code class="language-php">$content = file_get_contents($accidentallyMissingFile);
// $content is `FALSE`</code></pre>
<p>But we find out 35 lines later in this method:</p>
<pre><code class="language-php">private function processContent(string $content)
{
    // ...
}</code></pre>
<p>But all we see is <em>$content should be string, bool passed</em> error. Just great, isn't it?</p>
<p>Of course, you can put <code>file_exists()</code> and <code>is_file()</code> validation everywhere and teach every programmer in your team to use them and also create a sniff, that will enforce this behavior in CI level (which nobody really does) and spend hundreds of hours on regression bugs or...</p>
<p>...you could use helper method and make yourself useful instead:</p>
<pre><code class="language-php">Nette\Utils\FileSystem::read($accidentallyMissingFile);</code></pre>
<p>✅ Kaboom! An Exception!</p>
<h3 id="createDir"><code>createDir()</code></h3>
<p>Do you want to create a directory for your cache?</p>
<pre><code class="language-php">mkdir($cacheDiretory);</code></pre>
<p>Oh, but what if that already exists?</p>
<p>❌ <strong>Already exists error!</strong></p>
<p>Ok, let's say you're lucky, your hard drive was wiped out and it doesn't exist yet.</p>
<pre><code class="language-php">mkdir($cacheDiretory);</code></pre>
<p>But what if the directory is <code>some/cache</code>?</p>
<p>❌ <strong>Nested directory error!</strong></p>
<p>Ok, but what if we don't care about these because <strong>all we need is to create a directory</strong>?</p>
<pre><code class="language-php">Nette\Utils\FileSystem::createDir($cacheDirectory);</code></pre>
<p>✅</p>
<h3 id="delete"><code>delete()</code></h3>
<p>We want to delete temporary data in tests or a gallery of pictures. All we have is a <code>$source</code> variable.</p>
<p>I admit I often have to Google the name of this function because it's super counter-intuitive to first that pops to my mind - <code>delete(file|directory)</code>.</p>
<p>So let's try:</p>
<pre><code class="language-php">unlink($source);</code></pre>
<p>❌ <strong>It's a directory error.</strong></p>
<p>Ah, let's try this then:</p>
<pre><code class="language-php">rmdir($source);</code></pre>
<p>❌ <strong>The directory is not empty error.</strong></p>
<p>Doh, I already imagine some <code>glob()</code> of <code>Finder</code> madness.</p>
<p>Or maybe <strong>we just want to delete it</strong>:</p>
<pre><code class="language-php">Nette\Utils\FileSystem::delete($source);</code></pre>
<p>✅</p>
<p><br></p>
<p>Do you like it? <strong>Go and give <a href="https://github.com/nette/utils">Nette\Utils</a> a try</strong>. It's the only package I allow to use static methods and that's a lot, since <a href="/blog/2018/04/26/how-i-got-into-static-trap-and-made-fool-of-myself/">I'm very strict to them</a>.</p>
<blockquote class="blockquote text-center mt-5 mb-5">
    Do you want to play with details someone else already solved for you<br>
    or<br>
    <strong>build your awesome application instead</strong>?
</blockquote>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/07/30/hidden-gems-of-php-packages-nette-utils</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 30 Jul 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/07/30/hidden-gems-of-php-packages-nette-utils#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Why is Your Company Losing Money by not Open Sourcing: 1. Hiring ]]></title>
                <link>https://tomasvotruba.com/blog/2018/07/26/why-is-your-company-losing-money-by-not-open-sourcing-1-hiring</link>
                <description><![CDATA[ <p>Do you want to hire developers? Do you want to hire those developers who help your company in the long term? Do you want to save money for random picks of <em>HR</em> agencies? Do you want to hire developers who already know your code before even meeting you?
<strong>Do you want to attract developers in the long term with zero investment?</strong>
<br>
<br>
Go Open-source!
<br>
<br>
Did you miss my talk on <a href="https://phpprague.cz">PHPPrague 2018</a> Conference about this topic? Read this post.</p> ]]></description>
                <content:encoded><![CDATA[ <p>As a PHP meetup organizer in the Czech Republic, I'm in contact with many companies and HR agencies that try to hire PHP developers. I used <em>try</em> because the most of them use old-school methods, <a href="/blog/2017/11/20/how-to-write-interesting-job-offers-for-programmers/">boring job offers</a>, employees benefits like meal vouchers, possibility to work from home for only 1 day a week. They often end-up in giving up or using body shopping of random programmers for huge amounts of money.</p>
<blockquote class="twitter-tweet text-center" data-lang="cs"><p lang="cs" dir="ltr">On <a href="https://twitter.com/PhpPrague?ref_src=twsrc%5Etfw">@PhpPrague</a> <a href="https://twitter.com/VotrubaT?ref_src=twsrc%5Etfw">@VotrubaT</a> about How to use Open Source to Hire. <a href="https://twitter.com/hashtag/OpenSource?src=hash&amp;ref_src=twsrc%5Etfw">#OpenSource</a> <a href="https://twitter.com/hashtag/Hiring?src=hash&amp;ref_src=twsrc%5Etfw">#Hiring</a> <a href="https://t.co/X7rUBv5zso">pic.twitter.com/X7rUBv5zso</a></p>— Veronika Hlavacova (@Sput_Nika) <a href="https://twitter.com/Sput_Nika/status/1010547562783354880?ref_src=twsrc%5Etfw">23. června 2018</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>Honor exceptions like <a href="https://twitter.com/sput_nika">Veronika Hlaváčová</a>, who goes to meetups with disruptive ideas and is doing great job in teaching this the HR world.</p>
<h3 id="Open-Source-Everything">Open-Source Everything</h3>
<p>And you don't have to take my word for it. Do you know Github? It was founded in 2008 by 3 guys. One of them Tom Preston-Werner who wrote a post about investors vs. values in <em><a href="https://tom.preston-werner.com/2010/10/18/optimize-for-happiness.html">Optimize for Happiness</a></em> and <strong>also <em><a href="https://tom.preston-werner.com/2011/11/22/open-source-everything.html">Open Source (Almost) Everything</a></em></strong>. If you
have only 5 minutes to read a post today, go read one of them instead. It's well of pure wisdom.</p>
<p>I found this post 2 weeks after my talk and I must say, I was surprised how many ideas I share with him. 7 years prior to my talk! Tom shares great insight on how to run a huge company while keeping human values in the center.</p>
<h2 id="How-to-Attract-Programmers-in-2018-Way">How to Attract Programmers in 2018 Way?</h2>
<p>In this part we'll focus on the point where the companies I meet suffer the most - <strong>a hiring process</strong>. I think this is a big problem because they're not willing to accept it, which hurts both the company and developers.</p>
<p><br></p>
<p>Your company is growing and you get more project offers than your team can handle. <strong>You'd be actually losing profit if you had smaller team</strong>. Let's start hiring with HR!</p>
<p>And by HR mean I mean a <strong>person who can handle relationships a slightly better than the job they're hiring for</strong>.</p>
<h2 id="A-The-Story-of-Traditional-Hiring">A. The Story of Traditional Hiring</h2>
<p>You're skilled HR, so you prepare a job offer with a story about your company, list of benefits, that you're using PHP 7.1 and Symfony 4. <strong>You'd pay 2 most popular job advertisement websites to spread the job offer</strong>. If you're lucky and your programmers are proud of working at your company, they will share it on their Twitter accounts.</p>
<p>You'll collect over 50 replies from developers in 2 weeks period and you invite them to a job interview. You might ask them to make an entrance task (which will tell you nothing) that will be evaluated by one of your senior programmers and <strong>cost his time</strong>.</p>
<p>You'll pick top 20 people on the job interview and ask the senior programmer to join you. 30 minutes per each, you and the senior programmer → <strong>another cost for 10 hours of 2 people</strong>.</p>
<p>After some evaluation, you'll pick 2 developers to join your team on full-time. <strong>After only 30 minutes of spending time with them</strong>, where was probably no coding. And if there was some live coding on the interview - it really was waste of time, because programmer who can't work on their machine and they have to work in front of 2 people intensively watching them, <strong>they're not really in the best position to show their real skills</strong>.</p>
<blockquote class="blockquote text-center">
    Imagine you'd meet 20 girls for 30 minutes each<br>
    and then you'd decide to live with one of them the next week.
</blockquote>
<p>These 2 developers come to the work for their first week and they try to integrate to the team. Senior programmers found out they know much less then they told during the interview and have to teach them few skills <strong>in his paid working time</strong>. That way, the project is suffering.</p>
<p>In the end, you decide to pick 1 programmer because you have only 1 senior who can teach them and they have a very different skill set.</p>
<h3 id="Evaluate">Evaluate!</h3>
<ul>
<li>Estimated HR hours: <strong>20</strong></li>
<li>Estimated senior programmer hours: <strong>60</strong></li>
<li>Estimated total costs: <strong>10000 $</strong></li>
<li>The person hired: <strong>1</strong></li>
<li>How much of this work can be automated next time: <strong>~10 %</strong> (the job offer is already written)</li>
</ul>
<h2 id="B-The-Story-of-Open-Hiring">B. The Story of Open Hiring</h2>
<p>You're a senior developer in your company and you have few open-sourced packages on Github. It's <a href="https://github.com/lmc-eu/steward">Selenium wrapper</a> or set of the <a href="https://github.com/lmc-eu/steward">coding standard</a>. You're looking for a very specific developer. The one that understands the code you write finds it interesting and clean but also looks for a code where he or she can learn new skills. <strong>So you won't post a general job offer anywhere</strong>, because you know that would only attract people looking for any PHP job.</p>
<div class="text-center">
    <img src="/assets/images/posts/2018/open-source-money/match.jpg">
</div>
<p>What you're looking for <strong>a double match</strong> right from the beginning. A programmer wants you and you want a programmer.
So instead of posting a job offer and paying agencies which knows nothing about your company culture nor your code level, you'll get straight to the source of people who already know you.</p>
<p>You go to your package on Github and open page with all the contributors. You know you need people that are active now, not years ago, so you limit only to last year or so.</p>
<div class="text-center">
    <img src="/assets/images/posts/2018/open-source-money/contributors.gif" class="img-thumbnail">
</div>
<p><strong>You know these people are your focus group, because they know your code, you know them, they know how to contribute</strong>, they know git (obviously but not standard), your team accepted their solution to your code, so they will be much better colleagues than just anyone who knows PHP 7 and Symfony 4 and if they contributed twice and more, you know they're into you.</p>
<p>Then, your HR and you will prepare a short email to <strong>express your gratitude for their contributions, to praise their skills and to ask them if they're looking for a job</strong>. You'll send such post to 10 most active contributors you find.</p>
<p>4 of them will reply with interest and you'll invite them to the interview, with you and your HR. Thanks to the low number of contestants, you can spend 1 hour with them and invite them for a lunch to get to know them as a person. Because that who you'll be working with - a whole person - and you want to be sure you'll match each other.</p>
<div class="text-center">
    <img src="/assets/images/posts/2017/job-offers/attitude.jpg" class="img-thumbnail">
</div>
<p><strong>You don't need to see any code, because you already know their level from merged pull-requests</strong>. Neither do they, because they can imagine your company code level from open-sourced packages. But you know your public and private code differs, so you'll show them part of private code anyway, just to be sure they're ok with it.</p>
<p>After these 4 hours, you'll mutually 2 developers that you'll hire for a full-time. <strong>You know their level well at that moment</strong>, no surprises here.</p>
<p>In the end, you decide to pick 1 programmer because neither this process is ideal.</p>
<h3 id="Evaluate">Evaluate!</h3>
<ul>
<li>Estimated HR hours: <strong>4</strong></li>
<li>Estimated senior programmer hours: <strong>6</strong></li>
<li>Estimated total costs: <strong>2000 $</strong></li>
<li>The person hired: <strong>1</strong></li>
<li>How much of this work can be automated next time: <strong>~80 %</strong></li>
</ul>
<p><br></p>
<p>So, how much money is your company losing by not open-sourcing?</p>
<h2 id="Slowly-but-Surely">Slowly, but Surely</h2>
<p>The B. process is not ideal if you're doing the first time, because there are a lot of new things to learn. But I think your HR can handle it and get there on the 3rd round.</p>
<p><br></p>
<p><strong>Have you tried something similar to <em>open hiring</em>?</strong> And what are your proven practice to get the best colleagues? Let me know in the comments.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/07/26/why-is-your-company-losing-money-by-not-open-sourcing-1-hiring</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 26 Jul 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/07/26/why-is-your-company-losing-money-by-not-open-sourcing-1-hiring#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 5 Signs You Should Never Have a Talk Abroad ]]></title>
                <link>https://tomasvotruba.com/blog/2018/07/23/5-signs-should-never-have-a-talk-abroad</link>
                <description><![CDATA[ <p>I find PHP meetups abroad more and more valuable to my programming life. They're the best place to diverse my skills and knowledge without eating dump and self-proclaiming Twitter feeds.
<br>
<br>
Wait, don't rush to your train ticket so fast to enjoy the presence of great developers, interesting topic, surprisingly open-minded people and tasty beer afterward.
<br>
<br>
I'm about to tell you why you should not do it.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="1-You-re-not-Famous-Enough-to-be-Accepted">1. You're not Famous Enough to be Accepted</h2>
<p>❌</p>
<p>I'm sorry, but you were not born lucky enough to be Linus Torvalds, Rasmus Lerdorf, Fabien Potencier or Marco Pivetta. You'd have to work hard on yourself, have at least 1000 followers, 3 popular open-source packages and own website with real PHP blog posts.</p>
<p>From my experience, if you response to Call for Papers to one of <a href="http://php.net/conferences/index.php">the PHP conferences</a> there are free 10 times fewer talk slots than talk suggestions.</p>
<div class="text-center mb-4">
    <img src="/assets/images/posts/2018/friends/ou.png" class="img-thumbnail">
    <br>
    <img src="/assets/images/posts/2018/friends/ou2.png" class="img-thumbnail">
    <br>
    <em>Selection of my rejections</em>
</div>
<p>Only a madman would not give up this, right?</p>
<p>✅</p>
<p>How wrong was I thinking this? Meetups and conferences are a completely different field. Meetups are held almost every month and I can tell you, every organizer is super happy for an active speaker who writes him with a talk proposal. And an active speaker from abroad? <strong>Shut-up up and take my money!</strong></p>
<p>What do you need to do? Go to a meetup.com event detail, ask in comments to have a talk with this title, 2-3 sentences what it's about and length in minutes. It usually didn't take longer than 2 days before I got <em>you're accepted</em> email.</p>
<p>Some groups make this experience even more exceptional, like:</p>
<div class="text-center">
    <img src="/assets/images/posts/2018/friends/berlin.png" class="img-thumbnail">
    <br>
    <em><a href="http://www.bephpug.de/">Berlin PHP User Group</a> is fully open-sourced on Github, so all you need to do send PR</em>

    <br>

    <img src="/assets/images/posts/2018/friends/vienna.png" class="img-thumbnail">
    <br>
    <em><a href="https://www.meetup.com/viennaphp/">Vienna PHP</a> provides simple form, also on homepage → click &amp; send it
</em></div>
<h2 id="2-You-re-too-Shy-to-Talk">2. You're too Shy to Talk</h2>
<p>❌</p>
<p>People living abroad are much more skilled, have high standards and are very critique. Just imagine you'd confuse <code>sort</code> with <code>asort</code> - you're dead.</p>
<p>✅</p>
<p>I'm not sure if that's <em>the Czech Republic</em> or <em>home-country</em> effect, but I find programmers in other countries more curious, with questions, own ideas, and own experiments. Instead of saying how your idea is bad or why they propose situations when it could go wrong and want to hear arguments from you. Also, they're not so focused on nitpicking, but rather they try to understand the main idea of your talk.</p>
<p>And as for mistakes? I think going abroad is the best to battle-test anything. When people go on holidays, they're naturally more open to people, because they know they'll never see them again (unless you go 10 years to the same destination over and over again).</p>
<p>Are you shy? Don't have a talk in your hometown where everyone knows you, but go somewhere new where nobody knows you.</p>
<h2 id="3-You-re-not-very-Good-at-English-Tongue">3. You're not very Good at English Tongue</h2>
<p>❌</p>
<p>Abroad, there are only native English speakers and they will always correct your mistakes, typos and non-precise wording. Why do you think English programmers go to meetup anyway?</p>
<p>✅</p>
<p>This could not be far from the truth. In my experience, I've been meeting roughly 10 % of native English speakers. Instead, they're from Germany, France, Italy, Spain, Hungary, Slovakia, Netherlands, Belgium or Poland. Imagine having all these nationalities together, in one room, almost all of them having English as seconds language (in the best case scenario).</p>
<p>In such a group being too good in English would actually hurt you. The most common vocabulary that everyone understands the most wins.
After all, <a href="https://xkcd.com/simplewriter">1000 words</a> are all you need.</p>
<h2 id="4-You-don-t-have-Money-for-Traveling-and-AirBnb">4. You don't have Money for Traveling and AirBnb</h2>
<p>❌</p>
<p>Let's admit it, traveling abroad is not cheap. A return ticket from Prague to Berlin can cost over 50 €! And the AirBnb once more the same amount. And who of our programmers with poor pays can afford that?</p>
<p>If there only would be organizer you ask for accommodation or one of the other speakers or a friend. But that would be pure hope, no chance.</p>
<p>✅</p>
<p>All you need to do is check <a href="https://www.meetup.com/sfugberlin/events">the meetup</a> and write to the organizer and the speakers. Why? Because these people are usually the most opened one. Thanks, <a href="http://mhlavac.net">Martin Hlaváč</a> for an awesome stay that helped me for this tip.</p>
<h2 id="5-It-s-Very-Hard-to-Find-these-Meetups">5. It's Very Hard to Find these Meetups</h2>
<p>❌</p>
<p>You can go to meetup.com and <a href="https://www.meetup.com/find/events/?allMeetups=false&amp;keywords=php">search for PHP</a>. But meetup.com is designed for all meetups, not just PHP, so there are many boiler place features you don't need and nice map around your location is missing. Despite that, not all groups are there, they' use GitHub Page, Facebook, Twitter or own calendar.</p>
<div class="text-center mb-4">
    <img src="/assets/images/posts/2018/friends/meetupcom.png" class="img-thumbnail">
    <br>
    <em>Search on meetup.com is not really friendly</em>
</div>
<p>The second option is to go to <a href="http://php.ug">php.ug</a> and try to find meetups around you. This project is much better than meetup.com because it's <a href="https://github.com/php-ug/php.ug">open-sourced</a> and community can fix it, but it's not very active for the last 2 years.</p>
<div class="text-center">
    <img src="/assets/images/posts/2018/friends/phpug.png" class="img-thumbnail">
    <br>
    <em>Current Meetup coverage at php.ug</em>
</div>
<p>✅</p>
<p>Make no mistake, <a href="https://github.com/heiglandreas">Andreas Heigl</a> is doing a great job with <a href="http://php.ug">php.ug</a>, with Slack promotion and so on. I talked with him about this project, because I really missed a place where people could see meetups around them that would just work. Nothing more, nothing less.</p>
<p><strong>Thank you, Andreas, for inspiration, working API on php.ug and super fast bugfixes under 60 minutes from reporting</strong>. Be sure to check <a href="http://andreas.heigl.org">his blog</a> - I love his kind and wise style of sharing his experience.</p>
<h2 id="Find-Your-Next-Meetup-on-FriendsOfPHP-org">Find Your Next Meetup on FriendsOfPHP.org</h2>
<p>Today, this one last reason <em>Not to have a talk abroad</em> became history.</p>
<p>I <a href="/blog/2017/09/25/3-non-it-books-that-help-you-to-become-better-programmer/#steal-like-and-artist-by-austing-kleon">Steal like an Artist</a> from many projects:</p>
<ul>
<li><a href="https://leafletjs.com">Leaflet.js</a></li>
<li><a href="https://www.meetup.com/meetup_api">Meetup.com API</a></li>
<li><a href="https://php-ug.github.io/php.ug/api">php.ug API</a></li>
<li><a href="https://pages.github.com">GitHub Pages</a></li>
<li><a href="https://www.statie.org">Statie</a></li>
<li><a href="https://docs.travis-ci.com/user/cron-jobs">Travis Daily Cron</a></li>
<li>and <a href="https://symfony.com/events">Symfony Events</a></li>
</ul>
<p>to put down a simple page with meetups in Europe:</p>
<p><a href="https://friendsofphp.org/"></p>
<img src="/assets/images/posts/2018/friends/homepage.png" class="img-thumbnail">
<p></a></p>
<p>It's a fresh MVP (<em>not model-view-presenter</em> but <em>minimum viable product</em>) from last week, but you know that they say - <em>release early, release often</em>. You can find it on <a href="https://github.com/tomasvotruba/friendsofphp.org">Github</a> (obviously), try it, run it locally without any database thanks to YAML and Statie.</p>
<p><br></p>
<p>The mission of <a href="https://friendsofphp.org">friendsofphp.org</a> page is simple:</p>
<blockquote class="blockquote text-center">
    Help programmers to share their ideas and travel as easy as possible
</blockquote>
<p><br></p>
<p><strong>So get up, forget all the reasons in your head stopping you from going to your first meetup aboard and enjoy it!</strong></p>
<p>That's all the life about :)</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/07/23/5-signs-should-never-have-a-talk-abroad</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 23 Jul 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/07/23/5-signs-should-never-have-a-talk-abroad#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Make Github and Travis Split Monorepo to Multiple Git Repositories for You ]]></title>
                <link>https://tomasvotruba.com/blog/2018/07/19/how-to-make-github-and-travis-split-monorepo-to-multiple-git-repositories-for-you</link>
                <description><![CDATA[ <p>Do you use a monorepo? Then you know <a href="https://blog.shopsys.com/how-to-maintain-multiple-git-repositories-with-ease-61a5e17152e0">How to maintain multiple Git repositories with ease</a>. If you're not there yet, you may wonder <a href="https://blog.shopsys.com/how-to-merge-15-repositories-to-1-monorepo-keep-their-git-history-and-add-project-base-as-well-6e124f3a0ab3">How to Merge 15 Repositories to 1 Monorepo and Keep their Git History</a>.
<br><br>
Are you and your monorepo ready? Today we'll focus on <strong>fast, secured and outsourced monorepo auto split</strong> - all that under 10 minutes.</p> ]]></description>
                <content:encoded><![CDATA[ <p>It's great to be alive in this era. We have solved maintaining multiple repositories, even merge migration of their git history to one repository. Creating huge code bases was more never cost effective and never had a steeper learning curve.</p>
<p>The same way it was never easier to drive an autonomous car. You just sit in the car, press the button of your destination, and Tesla will drive you there when you check all the news on <a href="https://www.reddit.com/r/PHP">/r/PHP</a>.</p>
<p>Well, the monorepo paradigm is not there yet but it's getting there.</p>
<h2 id="The-Split-Problem">The Split Problem</h2>
<p>One of the last problems I'm aware of is splitting the monorepo to particular packages. Imagine you have <a href="https://github.com/symfony/symfony">Symfony monorepo</a> and you're trying to split it to all standalone packages like <a href="https://github.com/symfony/console">symfony/console</a>, <a href="https://github.com/symfony/dependency-injection">symfony/dependency-injection</a> and so on.</p>
<h3 id="Current-Status">Current Status</h3>
<p>This whole &quot;take a code from this directory and put it into this repository in <code>master</code> branch and last tag&quot; process is now:</p>
<ul>
<li>complex</li>
<li>slow</li>
<li>requires a lot of setups</li>
</ul>
<p>Instead, we want it to be:</p>
<ul>
<li><strong>simple so you will understand it at the end of reading this post</strong></li>
<li><strong>fast like Travis build of your project</strong></li>
<li><strong>easy to set up in 1 composer package and 5 lines of YAML</strong></li>
</ul>
<p>Why? So you could amaze your friends at the party that you just set-up a monorepo split and they can enjoy merged PRs in a matter of minutes (even if you know almost nothing about git or PHP).</p>
<p>Do you think we can get there? You'll see.</p>
<h2 id="The-Best-Solutions-to-Split-So-Far">The Best Solutions to Split (So Far)</h2>
<p>Feel free to explore these following solutions. I did it for you and here are a few blockers that hold them from being massively adopted.</p>
<p>On the other hand, <strong>I'm grateful for each one of them, because they're pushing the evolution further and further. Thanks to them we don't have to reinvent the wheel and we can build on their shoulders</strong>.</p>
<h3 id="1-splitsh-lite">1. splitsh/lite</h3>
<ul>
<li><a href="https://github.com/splitsh/lite">https://github.com/splitsh/lite</a></li>
<li>You need to know Go and bash and be able to resolve conflicts of their dependencies.</li>
</ul>
<h3 id="2-dflydev-git-subsplit">2. dflydev/git-subsplit</h3>
<ul>
<li><a href="https://github.com/dflydev/git-subsplit">https://github.com/dflydev/git-subsplit</a></li>
<li>Extra splits that are not needed</li>
<li>Complex configuration</li>
<li>Requires manual bash install</li>
<li>It was used by Laravel and then by Symplify</li>
</ul>
<h2 id="What-Would-the-Ideal-State-Look-Like">What Would the Ideal State Look Like?</h2>
<p>Before diving into solution and how to do it, I try to stop and go into a wonderland. What would the ideal solution look like? How would I use it? How would I explain it to others? How fast would it be? Try to break away from your know-how limits (because they're limiting your thinking) and be free to come up with absolutely non-sense answers:</p>
<ul>
<li>&quot;1 command to install&quot;</li>
<li>&quot;zero setup&quot;</li>
<li>&quot;1 command to run&quot;</li>
<li>&quot;1 minute to finish the whole process&quot;</li>
<li>&quot;split only what I and people really need&quot;</li>
</ul>
<p><br></p>
<p>If we put it in the code, it might look like:</p>
<pre><code class="language-bash">composer require symplify/monorepo-builder --dev</code></pre>
<pre><code class="language-yaml"># monorepo-builder.yml
parameters:
    directories_to_repositories:
        packages/MonorepoBuilder: 'git@github.com:Symplify/MonorepoBuilder.git'</code></pre>
<pre><code class="language-bash">vendor/bin/monorepo-builder split</code></pre>
<p>That could do, right? At least from a <a href="https://symfony.com/blog/making-the-symfony-experience-exceptional">developer's experience</a> view.</p>
<p><br></p>
<p>But what would <a href="https://www.michalspacek.com">security expert Michal Špaček</a> say to lousy code like that?</p>
<img src="/assets/images/posts/2018/monorepo-split/found-keys.jpg" class="img-thumbnail">
<h2 id="How-To-Avoid-Rape-on-Github-and-Travis">How To Avoid Rape on Github and Travis?</h2>
<blockquote class="blockquote text-center">
    "So, anyone can now push to your repository whatever he wants?"
</blockquote>
<p>This is a valid question that was probably scratching your mind when you saw <em>Github + Travis + git + open-source</em> combination.
Travis is basically a terminal, that runs few command lines. What would prevent someone from using this to &quot;play with&quot; your repository?</p>
<p>Let's look at the repository address in our example:</p>
<pre><code class="language-bash">git@github.com:Symplify/MonorepoBuilder.git</code></pre>
<p>This basically means <strong>we need to make ssh key or username and a password public</strong>. Does that sound like a good idea to you?</p>
<p>Don't worry, Github and Travis thought about these cases - with a hashed <code>GITHUB_TOKEN</code> environment variable.</p>
<h3 id="1-Create-a-Personal-Access-Token-on-Github">1. Create a Personal Access Token on Github</h3>
<p>First, you need to create a custom token, that will authorize access to your Github repositories from any command line where it will be used.</p>
<p>Read <a href="https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line">the Github docs</a> or use <strong>tl;dr;</strong>:</p>
<ul>
<li>Go to your <a href="https://github.com/settings/tokens">Github Tokens</a></li>
<li>Click <em>Generate new token</em></li>
<li>Check only <em>repo</em> scope
<img src="/assets/images/posts/2018/monorepo-split/github-token.png" class="img-thumbnail"></li>
<li>Click <em>Generate token</em></li>
</ul>
<h3 id="2-Add-GITHUB-TOKEN-in-Repository-Settings-on-Travis">2. Add <code>GITHUB_TOKEN</code> in Repository Settings on Travis</h3>
<p>Then we need to store this token to Travis build, so Travis can be authorized to manipulate with your repositories without any password or ssh key.</p>
<p>Read <a href="https://docs.travis-ci.com/user/environment-variables/#Defining-Variables-in-Repository-Settings-">the Travis docs</a> or use <strong>tl;dr;</strong>:</p>
<ul>
<li>Go to Travis settings of your repository - <code>https://travis-ci.org/&lt;your&gt;/&lt;repository&gt;/settings</code></li>
<li>Jump to <em>Environment Variables</em> section</li>
<li>Create <code>GITHUB_TOKEN</code> with the value from Github</li>
<li>Click <em>Add</em></li>
</ul>
<p>In the end, it should look like this:</p>
<div class="text-center">
    <img src="/assets/images/posts/2018/monorepo-split/token-after.png" class="img-thumbnail">
</div>
<h3 id="GitHub-and-Travis-Protects-You">GitHub and Travis Protects You</h3>
<p>Now the best part. If you accidentally commit your access token in <code>.travis.yml</code> (like I did while testing), <strong>GitHub will immediately disable it</strong> and sends you an email (to bad I found that out the next day after 4 hours of debugging with that token).</p>
<p>And if you add the token to your repository on Travis as above, <strong>it will hide it in all logs for you</strong>. No need to hash it.</p>
<p>So instead of insecure</p>
<pre><code class="language-bash">git@github.com:Symplify/MonorepoBuilder.git
# or
https://aFjk02FJlkj1675jlk@github.com/Symplify/MonorepoBulder.git</code></pre>
<p>everyone will see:</p>
<pre><code class="language-bash">https://[secure]@github.com/Symplify/MonorepoBulder.git</code></pre>
<p>Sound and safe!</p>
<p><br></p>
<p><strong>Now we have:</strong></p>
<ul>
<li>the <code>symplify/monorepo-builder</code> package as a local dependency</li>
<li>configured package to repository paths in <code>monorepo-builder.yml</code></li>
<li>secured <code>GITHUB_TOKEN</code> in Travis settings for your monorepo repository</li>
<li>a command to run the split: <code>vendor/bin/monorepo-builder split</code></li>
</ul>
<p>Something is missing...</p>
<p>Oh right, <strong>when</strong> will the monorepo be split? Do we have to do it manually? How often? Should Travis CRON do it on daily basis?</p>
<h2 id="When-is-the-Best-Time-to-Split-our-Monorepo">When is the Best Time to Split our Monorepo?</h2>
<p>In times like these, get back to our ideal product:</p>
<ul>
<li>&quot;1 command to install&quot;</li>
<li>&quot;zero setup&quot;</li>
<li>&quot;1 command to run&quot;</li>
<li><strong>&quot;1 minute to finish the whole process&quot;</strong></li>
<li>&quot;split only what maintainer and users really need&quot;</li>
</ul>
<p>It often happens <strong>we merge fix or feature to monorepo and we want to try it</strong> before rushing to tagging a stable release. We want to do it <strong>as soon as possible</strong>, <strong>without manually triggering Travis</strong> to do it. Also, we <strong>don't want Travis to waste energy on pull-requests</strong> that are not merged to master. That would only slow the whole CI process down and frustrate contributors and maintainer.</p>
<p>Saying that how <code>.travis.yml</code> should look like?</p>
<pre><code class="language-yaml">language: php

# required for "git tag" presence for MonorepoBuilder split and ChangelogLinker git tags resolver
# see https://github.com/travis-ci/travis-ci/issues/7422
git:
  depth: false

matrix:
  include:
    - php: 7.2
      env: MONOREPO_SPLIT=true
    # ... other builds

install:
  - composer install

# ... other scripts

after_script:
  # split monorepo to packages - only on merge to master
  - |
    if [[ $TRAVIS_EVENT_TYPE == "push" &amp;&amp; $MONOREPO_SPLIT == true &amp;&amp; $TRAVIS_BRANCH == "master" ]]; then
      vendor/bin/monorepo-builder split -v
    fi</code></pre>
<p>That way the split command is run only merge to <code>master</code> and <strong>exactly once after each merge</strong>. So you can test your feature in a matter of minutes...</p>
<p>Wait wait, no vague statements like <em>a matter of minutes</em>. How <strong>fast it really is</strong>? To give you an idea, this is Symplify Travis build with a split of 10 packages:</p>
<img src="/assets/images/posts/2018/monorepo-split/speed.png" class="img-thumbnail mb-4">
<p><strong>It takes under 7,5 minutes</strong> including all the tests, static analysis and code style validation.</p>
<p>That's all folks. You're ready to go and try it on your monorepo.</p>
<p><br></p>
<p>So, do you think you're ready to fascinate your friends tonight with all your brand new monorepo split setup?</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/07/19/how-to-make-github-and-travis-split-monorepo-to-multiple-git-repositories-for-you</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 19 Jul 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/07/19/how-to-make-github-and-travis-split-monorepo-to-multiple-git-repositories-for-you#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ New in Statie 4.5: Twig Support ]]></title>
                <link>https://tomasvotruba.com/blog/2018/07/16/new-in-statie-45-twig-support</link>
                <description><![CDATA[ <p>Statie supports YAML and Symfony Dependency Injection for some time. But you wanted more! <strong>You wanted Twig</strong>. Sculpin and all <a href="https://www.staticgen.com">the other PHP Static Website generators</a> have it.
<br><br>
So there you go! Enjoy</p> ]]></description>
                <content:encoded><![CDATA[ <p><a href="https://github.com/symplify/symplify/pull/892" class="btn btn-dark btn-sm">
See pull-request
</a></p>
<h2 id="3-Steps-to-Your-First-Page-on-Statie">3 Steps to Your First Page on Statie</h2>
<h3 id="1-Prepare-Layout-layouts-default-twig">1. Prepare Layout <code>_layouts/default.twig</code></h3>
<pre><code class="language-twig">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
    {% include "_snippets/head.twig" %}
    &lt;body&gt;
        {% include "_snippets/menu.twig" %}

        &lt;div&gt;
            {% block content %}{% endblock %}
        &lt;/div&gt;

        {% include "_snippets/footer.twig" %}
    &lt;/body&gt;
&lt;/html&gt;</code></pre>
<h3 id="2-Create-Template-contact-twig">2. Create Template <code>contact.twig</code></h3>
<pre><code class="language-twig">---
layout: "_layouts/default.twig"
---

{% block content %}
    &lt;h1&gt;Call me&lt;/h1&gt;

    &lt;a href="tel:+420776778332"&gt;+420 &lt;strong&gt;776 778 332&lt;/strong&gt;&lt;/a&gt;
{% endblock %}</code></pre>
<p>And you're ready to go!</p>
<h2 id="How-to-Upgrade-to-Statie-4-5">How to Upgrade to Statie 4.5?</h2>
<img src="/assets/images/posts/2018/statie-45/statie-45.png">
<p>Update it in composer:</p>
<pre><code class="language-bash">composer require symplify/statie 4.5</code></pre>
<p>And try:</p>
<pre><code class="language-bash">vendor/bin/source generate</code></pre>
<p>It will probably fail because there was one change in templating reference.</p>
<p>Before the paths of included files were just a file name and the full path was guessed. This practice is common in Nette and Symfony Controllers, so I used as a starting point. But it caused many WTFs and name conflicts like:</p>
<pre><code class="language-bash">/_snippets
    /post
        detail.twig
    /lecture
        detail.twig</code></pre>
<pre><code class="language-twig">{% include "detail" %}</code></pre>
<p>Which file will is used? Or is it a block import? Magic :)</p>
<p>How to do it better with <em>a principle of the least surprise</em>?</p>
<h3 id="Clear-Obvious-File-Naming">Clear, Obvious File Naming</h3>
<p>All files in <code>_layouts</code> and <code>_snippets</code> are now referenced by <strong>they full relative path to source</strong> (usually <code>/source</code> directory):</p>
<pre><code class="language-diff">-layout: "default"
+layout: "_layouts/default.twig"
 ---

-{% include "postMetadata" %}
+{% include "_snippets/postMetadata.twig" %}</code></pre>
<p>Do you use <a href="https://www.statie.org/docs/generators">Generators</a>? Don't forget to upgrade them too:</p>
<pre><code class="language-diff"> parameters:
     generators:
         posts:
-            layout: 'post'
+            layout: '_layouts/post.twig'</code></pre>
<h3 id="Already-Running-on-Statie-4-5">Already Running on Statie 4.5</h3>
<p>Check diffs of these merged pull-requests so you have the idea <strong>how small the change really is</strong>:</p>
<ul>
<li><a href="https://github.com/crazko/statie-web/pull/18/files">statie.org</a></li>
<li><a href="https://github.com/crazko/romanvesely.com/pull/44/files">romanvesely.com</a></li>
<li><a href="https://github.com/pehapkari/pehapkari.cz/commit/a8256817acc61a14c4adcd0f6ed06b042450bfc3#diff-f9937b27a07038e5d12db3b137e228ce">tomasvotruba.com</a></li>
</ul>
<h2 id="How-to-Migrate-Latte-to-Twig-as-Well">How to Migrate Latte to Twig as Well?</h2>
<img src="/assets/images/posts/2018/statie-45/latte-twig.png">
<p>If you use Statie, you're probably running on Latte. In the case you prefer Twig, <strong>I guess you're already frustrated from annoying Latte to Twig migration you have ahead of you</strong>.</p>
<p>Again, check these diffs, so you have the idea <strong>how big that change really is</strong>:</p>
<ul>
<li><a href="https://github.com/TomasVotruba/tomasvotruba.com/pull/380/files">tomasvotruba.com</a></li>
<li><a href="https://github.com/pehapkari/pehapkari.cz/pull/486/files">Pehapkari.cz</a></li>
</ul>
<p>I feel you. You can stay with Latte until... just kidding. That's a lot of work, right? Well, I'm not that hardworking, don't worry. I'm a lazy bastard, so I made <a href="/blog/2018/07/05/how-to-convert-latte-templates-to-twig-in-27-regular-expressions/">a package for Latte to Twig migration</a>.</p>
<p>Enjoy!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/07/16/new-in-statie-45-twig-support</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 16 Jul 2018 00:00:00 +0000</pubDate>
                                    <updated>2018-09-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Sep 2018 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Sep 2018 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/07/16/new-in-statie-45-twig-support#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Notes from &#039;Peace is Every Step&#039; Book ]]></title>
                <link>https://tomasvotruba.com/blog/2018/07/12/20-notes-from-peace-is-every-step-book</link>
                <description><![CDATA[ <p>Zen To Done, Deep Work, ZenHabits... You've probably noticed I'm a fan of Leo Babauta. The first person I met on the Internet who explained to me that I'm not weird, but a minimalist.
<br><br>
Leo <a href="https://zenhabits.net">writes</a> minimalist tips from daily life that is easy to relate to. Thanks to quotes in his posts I got chance to meet <em>Thich Nhat Hanh</em>, a Buddhist monk who helped to restore peace between the USA and Vietnam...
<br><br>
...and recently I've finished reading his book <em>Peace Is Every Step: The Path of Mindfulness in Everyday Life</em>. What was it about?</p> ]]></description>
                <content:encoded><![CDATA[ <p><em>Btw, Leo also writes little books. If there is one I enjoyed the most, it's <a href="https://zenhabits.net/little-book">The Little Book of Contentment</a>. Not because it's free and short, but because it helped me to focus on my inner passion and my own meaning and fears that were stopping me.</em></p>
<p><br></p>
<p>I really enjoyed reading <em>Peace is Every Step</em> and it gave me a broader view of conflicts around me as well as deeper understanding of my inner conflicts and ways to enjoy the way I am. Without judging myself against past or future and other, yet acting with more loving kindness and courage to overcome past fears and failures.</p>
<img src="/assets/images/posts/2018/peace/book.jpg" class="col-6">
<p>Instead of a random summary, I'll leave you to absorb a handful of quotes that really resonated with me.</p>
<h2 id="Part-One-Breathe-You-Are-Alive">Part One: Breathe! You Are Alive</h2>
<h3 id="10-years-for-Diploma-beats-the-Present-Moment">10-years for Diploma beats the Present Moment</h3>
<blockquote class="blockquote">
    We know how to sacrifice ten years for a diploma, and we are willing to work very hard to get a job, a car, a house, and so on. But we have difficulty remembering that we are alive in the present moment, the only moment there is for us to be.
</blockquote>
<blockquote class="blockquote">
    When I hold a bowl of rice or a piece of bread, I know that I am fortunate, and I feel compassion for all those who have no food to eat and are without friends or family. This is a very deep practice.
</blockquote>
<h3 id="Aware-or-Not-At-All">Aware or Not At All</h3>
<blockquote class="blockquote">
    The foundation of happiness is mindfulness. The basic condition for being happy is our consciousness of being happy. If we are not aware that we are happy, we are not really happy.
</blockquote>
<blockquote class="blockquote">
    <strong>Enlightenment, peace, and joy will not be granted by someone else.</strong>
</blockquote>
<blockquote class="blockquote">
    There is no way to peace, peace is the way.
</blockquote>
<h2 id="Part-Two-Transformation-and-Healing">Part Two: Transformation and Healing</h2>
<h3 id="We-are-Our-Feelings">We are Our Feelings</h3>
<blockquote class="blockquote">
    Mindful observation is based on the principle of "non- duality": our feeling is not separate from us or caused merely by something outside us; our feeling is us, and for the moment we are that feeling. We are neither drowned in nor terrorized by the feeling, nor do we reject it. Our attitude of not clinging to or rejecting our feelings is the attitude of letting go, an important part.
</blockquote>
<h3 id="Throw-Away-Parts-of-Yourself">Throw Away Parts of Yourself?</h3>
<blockquote class="blockquote">
    When we have something irregular in our body, too often they advise us to have an operation. The same seems to be true in psychotherapy. <strong>Therapists want to help us throw out what is unwanted and keep only what is wanted</strong>. But what is left may not be very much. <strong>If we try to throw away what we don't want, we may throw away most of ourselves</strong>.
    <br>
    ...
    <br>
    We do not need surgery to remove our anger. If we become angry at our anger, we will have two angers at the same time. We only have to observe it with love and attention.
</blockquote>
<h3 id="Teach-by-Creating-Teachers">Teach by Creating Teachers</h3>
<blockquote class="blockquote">
    A teacher has to give birth to the teacher within his student, and a psychotherapist has to give birth to the psychotherapist within his patient.
</blockquote>
<h3 id="What-if-Somebody-is-Angry-at-You">What if Somebody is Angry at You?</h3>
<blockquote class="blockquote">
    His dishonesty and hatefulness may be real, imaginary, or exaggerated, but, in fact, the root of the problem is the anger itself, and we have to come back and look first of all inside ourselves. It is best if we do not listen to or look at the person whom we consider to be the cause of our anger. <strong>Like a fireman, we have to pour water on the blaze first and not waste time looking for the one who set the house on fire</strong>.
</blockquote>
<blockquote class="blockquote">
    When we are angry, our anger is our very self. To suppress or chase it away is to suppress or chase away our self. When we are joyful, we are the joy. When we are angry, we are the anger. When anger is born in us, we can be aware that <strong>anger is an energy in us, and we can accept that energy in order to transform it into another kind of energy</strong>.
</blockquote>
<h3 id="Understand-Garbage-in-People">Understand Garbage in People</h3>
<blockquote class="blockquote">
    The key is knowing a person's suchness. We do not expect a person always to be a flower. We have to understand his or her garbage as well.
</blockquote>
<h3 id="What-to-Say-Before-Dying">What to Say Before Dying</h3>
<blockquote class="blockquote">
    "Whenever you miss me, look into your hand, and you will see me immediately." How penetrating these simple, sincere words!
</blockquote>
<h3 id="Focus-on-Pain-Grows-Pain">Focus on Pain Grows Pain</h3>
<blockquote class="blockquote">
    We often ask, "What's wrong?" Doing so, we invite painful seeds of sorrow to come up and manifest. We feel suffering, anger, and depression, and produce more such seeds. We would be much happier if we tried to stay in touch with the healthy, joyful seeds inside of us and around us. We should learn to ask, "What's not wrong?" and be in touch with that.
</blockquote>
<blockquote class="blockquote">
    We don't need to wait until we have asthma to enjoy our breathing.
</blockquote>
<h3 id="Blame-or-Understand">Blame or Understand?</h3>
<blockquote class="blockquote">
    Blaming has no positive effect at all, nor does trying to persuade using reason and arguments. That is my experience. No blame, no reasoning, no argument, just understanding. <strong>If you understand, and you show that you understand, you can love, and the situation will change</strong>.
</blockquote>
<h3 id="All-Relationship-are-Mutual">All Relationship are Mutual</h3>
<blockquote class="blockquote">
    "Mommy, remember to water me. I am your lettuce." I was so pleased that she had understood my point completely. Then I heard her mother reply, "Yes, my daughter, and I am your lettuce also. So please don't forget to water me too."
</blockquote>
<blockquote class="blockquote">
    <strong>Once there is seeing, there must be acting. Otherwise, what is the use of seeing?</strong>
</blockquote>
<h3 id="Bring-Peace-to-2-Enemies">Bring Peace to 2 Enemies</h3>
<blockquote class="blockquote">
    We get angry, we shout, but rarely do we rise above all this to look at a conflict <strong>the way a mother would who is watching her two children fighting. She seeks only their reconciliation</strong>.
</blockquote>
<img src="/assets/images/posts/2018/peace/mononoke.jpg">
<h3 id="How-to-Say-Sorry-People-You-ve-Hurt">How to Say Sorry People You've Hurt</h3>
<blockquote class="blockquote">
    There are few things to do. The first thing is to take the time to say, "I am sorry, I hurt you out of my ignorance, out of my lack of mindfulness, out of my lack of skillfulness. I will try my best to change myself. I don't dare to say anything more to you."
</blockquote>
<h2 id="Part-Three-Peace-Is-Every-Step">Part Three: Peace Is Every Step</h2>
<h3 id="Do-You-Suffer-for-a-Day-Delay-of-Your-Order">Do You Suffer for a Day Delay of Your Order?</h3>
<blockquote class="blockquote">
    There were "boat people" who were just one or two years old, who were about to be sent back to their country because they were classified as illegal immigrants. <strong>They had lost both father and mother during the trip. When you see that kind of suffering, you know that the suffering your friends in Europe and America are undergoing is not very great</strong>.
</blockquote>
<blockquote class="blockquote">
    Do not accumulate wealth while millions are hungry. Do not take as the aim of your life fame, profit, wealth, or sensual pleasure. <strong>Live simply and share time, energy, and material resources with those who are in need</strong>.
</blockquote>
<h3 id="Keep-Community-Strong-with-the-Right-Words">Keep Community Strong with the Right Words</h3>
<blockquote class="blockquote">
    Do not utter words that can create discord and cause the community to break. Make every effort to reconcile and resolve all conflicts, however small.
</blockquote>
<blockquote class="blockquote">
    I have enjoyed our journey together. I hope you have enjoyed it too. We shall see each other again.
</blockquote>
<p><br></p>
<p>Did you? <a href="https://www.amazon.com/Peace-Every-Step-Mindfulness-Everyday-ebook/dp/B0038AUYSW/">Give a try to free first chapter</a> to Kindle app</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/07/12/20-notes-from-peace-is-every-step-book</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 12 Jul 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/07/12/20-notes-from-peace-is-every-step-book#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 6 Reasons Why Doctrine is Alive and Kicking ]]></title>
                <link>https://tomasvotruba.com/blog/2018/07/09/6-reasons-why-doctrine-is-alive-and-kicking</link>
                <description><![CDATA[ <p>Almost 1,5 year ago I wrote <a href="/blog/2017/03/27/why-is-doctrine-dying/">Why is Doctrine Dying</a>. I didn't use <em>dead</em>, because it's is just state of time being. Open-source projects - like people - tend to find themselves on the top, being stuck or struggling with the right path from time to time. It's a completely normal process of evolution.
<br><br>
I don't know if that post helped it, but since then many <strong>things changed for better in Doctrine project</strong>. Saying that this post deprecates my old view and celebrate changes.
<br><br>
<strong>May this be an inspiration for open-source projects that find themselves stuck and the maintainers that find themselves unhappy</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>What's new in Doctrine and what might help you and your project to restart?</p>
<h2 id="1-Bump-PHP-7-1-Without-Waiting-for-Major-Release">1. Bump PHP 7.1 Without Waiting for Major Release</h2>
<p>Doctrine bumped <strong>all packages</strong> to min PHP 7.1. This change reduces a lot of features that have to be maintained. But that's not the best benefits in my opinion. The best thing is <strong>the maintainer doesn't have to keep in mind all the clutter know-how</strong> he or she probably uses only for this project, like arrays should be written in <code>array()</code>, there is no <code>void</code> yet or <code>yield</code> yet etc. This makes development much faster and enjoyable.</p>
<p>In <a href="https://www.doctrine-project.org/2017/07/25/php-7.1-requirement-and-composer.html">the official post</a> they explain why this not a BC (back-compatibility) break and I must say I really like it and often refer to it:</p>
<blockquote class="blockquote mt-5 mb-5">
    One question we frequently hear is, "isn't dropping support for a PHP version a BC break"? In a nutshell, no. <strong>A BC break happens when there is an incompatible change that your package manager can't handle</strong>. For example, changing a method signature in a minor version is a no-go, since the composer version constraints mentioned above assume any minor upgrade can safely be used.
    <br>
    <br>
However, when we drop support for an older version of PHP, <strong>composer will not consider the new version if the PHP version requirement is no longer fulfilled</strong>. Thus, you won't end up with a fatal error due to a wrong method signature, you just won't get the new version.
</blockquote>
<p>Until we agree on regular PHP minor version bumping as a community, I think it's the best to jump to <em>the unicorn</em> versions. Those with the biggest impact, the most stable and helpful - and go PHP 7.1 as one.</p>
<h2 id="2-Use-Coding-Standard">2. Use Coding Standard</h2>
<p>Although the coding standard is standard nowadays, it's not very easy to setup them to existing projects. Moreover more complex ones than a few basic rules. I'm very happy to see that Doctrine made this happen. The <a href="https://github.com/doctrine/coding-standard/blob/master/lib/Doctrine/ruleset.xml"><code>ruleset.xml</code></a> is quite rich.</p>
<p>Coding Standard makes contributing much more fearless since <strong>you don't have to worry I'll get smashed in code-review by &quot;extra space here&quot; comment</strong>.</p>
<p>Since it uses only PHP_CodeSniffer and not PHP CS Fixer, these still is a lot of manual work and space for huge cost-effective improvement. I tried to help with EasyCodingStandard implementation many months ago, but in that time ECS required PHP 7.1 and Doctrine not and used Neon of YAML to configure. Not anymore! <a href="/blog/2018/03/26/new-in-easy-coding-standard-4-clean-symfony-standard-with-yaml-and-services/">YAML is now default since ECS 4</a>, so the path is open from the technical point of view.</p>
<h2 id="3-Cut-the-Weight-to-Save-Yourself">3. Cut the Weight to Save Yourself</h2>
<p>Let's stay with YAML for a few more moments. There was PR to Doctrine to <a href="https://github.com/doctrine/doctrine2/pull/5932">remove all YAML references</a> (mainly Entity mapping) in the time of writing my former post, but it was not clear when that will happen.</p>
<img src="/assets/images/posts/2018/doctrine-alive/yaml-drop.png" class="img-thumbnail">
<p>Now it's clear the Doctrine 3.0 will include this drop. This is very similar to PHP 7.1 change. The most healthy benefit is that maintainers don't have to constantly think about PHP, XML, YAML and Annotation support in everything they do - just in case it might be related to it. Instead, <strong>the focus is now more narrow, clear and as a side effect - development is more enjoyable</strong>.</p>
<div class="text-center">
    <img src="/assets/images/posts/2018/doctrine-alive/balloon.jpg" class="img-thumbnail">
    <br>
    <em>
        It's like a hot air balloon.<br>
        If you have too many sandbags, you won't fly as high you want no matter how hard you try.
        <br>
        Drop just a few of them and you'll see how life becomes much lighter.
    </em>
</div>
<h3 id="Get-rid-of-Over-Support-as-part-of-Psychohygiene">Get rid of Over-Support as part of Psychohygiene</h3>
<p><em>Over-support</em> is very common in open source. It happened to me in ECS, <a href="/blog/2017/09/04/how-apigen-survived-its-own-death//">I saw it ApiGen</a> and almost burned out while getting rid of it (it also took me many months to even realize it and step out of it). <strong>People request features, your project is popular, you gave people these features and that makes it more popular, so more people request features... it's challenging to keep on track when you're on celebrity power-trip</strong>.</p>
<p>It's very healthy to be <a href="/blog/2018/06/21/open-source-is-selfish//">selfish in open-source</a>, not just for you for for the project to live and prosper.</p>
<h2 id="4-Give-People-Vision-to-Follow">4. Give People Vision to Follow</h2>
<p>How can people orientate in the product, the package, the ideas, if you have no information about it? People need to know, what will happen when - at least approximately, but moreover in software that changes so fast. There were times when there was one post for a whole year <a href="https://www.doctrine-project.org/blog">on Doctrine's blog</a>. That changed!</p>
<p>The blog was refreshed, <a href="https://github.com/doctrine/doctrine-website">fully-open sourced</a> and now runs on Sculpin, a project that I used before and get a lot of inspiration for <a href="https://www.statie.org">Statie</a>.</p>
<p>There is news about Doctrine ORM 3.0 about PHP 7.1 bump etc. Even these small notes give a great feeling of trust, of <em>something is going on</em> feeling, that creates a relationship.</p>
<h2 id="5-From-Talks-and-Post-Evangelization-to-Code-Improvements">5. From Talks and Post Evangelization to Code Improvements</h2>
<p>I didn't really measure myself this so <a href="https://www.goodreads.com/quotes/300097-i-only-believe-in-statistics-that-i-doctored-myself">I can't fake it</a>, but I have a feeling that there are fewer talks and posts about Doctrine than years before. And that's a good thing. Why? Because this energy is now directed to the code.</p>
<img src="/assets/images/posts/2018/doctrine-alive/contrib.png" class="img-thumbnail">
<p>Don't take me wrong, both development and popularization are important, but if the project is not moving ahead, the popularization only vendor-lock know-ledge to slowly deprecating code.</p>
<div class="text-center">
    <img src="/assets/images/posts/2018/doctrine-alive/hide.jpg" class="img-thumbnail">
    <em>
        So don't forget to hide from time to time from the public and deep-work on your project.<br>
        The world will wait in excitement for your news.
    </em>
</div>
<h2 id="6-New-Release-as-a-Baseline">6. New Release as a Baseline</h2>
<p>Last but not least, take a time and <a href="http://how-to-stay-organized.blogspot.com/2011/08/declutter-desk.html">declutter your desk</a> once a few months.</p>
<img src="https://4.bp.blogspot.com/-uISp2pDSrTs/Tjr1Rr_07NI/AAAAAAAAAls/F3cq72YywMw/s320/computer-desk-before.JPG" width="400px" class="img-thumbnail">
<p>↓</p>
<img src="https://4.bp.blogspot.com/-W7YoCGWIlP4/Tjr1y2qZaxI/AAAAAAAAAlw/RWqZI7ECmfQ/s320/computer-desk-after.JPG" width="400px" class="img-thumbnail">
<p>I think you know what a great feeling is to work with a clean desk. How does that relate to an open-source project?</p>
<p>Packages <strong>tagging</strong> is like <a href="https://www.doctrine-project.org/2017/07/25/php-7.1-requirement-and-composer.html">publishing a book</a>. You summarize all you know, all you did up-to-the one point of time. It's a big step, you celebrate it and... then you continue working on your next book.</p>
<img src="/assets/images/posts/2018/doctrine-alive/packages.png" class="img-thumbnail">
<p><strong>Tag from time to time just to put your work out, to get feedback, to share it with the world</strong> so anyone can <a href="/blog/2017/09/25/3-non-it-books-that-help-you-to-become-better-programmer/#steal-like-and-artist-by-austing-kleon">steal it</a>.</p>
<p><br><br></p>
<p>And that's all folks. <strong>I'm happy Doctrine is moving forward to the version 3.0 and I really look forward to it</strong> - it will run on PHP 7.2, one more sandbag dropped to make code better.</p>
<p>How is your project doing? What do you do when you feel stuck for a while? Let me know in the comments.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/07/09/6-reasons-why-doctrine-is-alive-and-kicking</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 09 Jul 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/07/09/6-reasons-why-doctrine-is-alive-and-kicking#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Convert Latte Templates to Twig in 27 Regular Expressions ]]></title>
                <link>https://tomasvotruba.com/blog/2018/07/05/how-to-convert-latte-templates-to-twig-in-27-regular-expressions</link>
                <description><![CDATA[ <p>Statie - a tool for generating static open-sourced website like this blog or <a href="https://github.com/pehapkari/pehapkari.cz">Pehapkari.cz</a> - runs on YAML and Symfony DI Container. That way it's easy to understand by the PHP community worldwide.
<br><br>
But there are some pitfalls left. Like templates - being Latte the only one is a pity. Twig is often requested feature and one of the last big reasons not to use Statie.
<br><br>
Well, <strong>it was</strong>. Statie now supports <a href="https://github.com/symplify/symplify/pull/892">Twig</a>.
<br><br>
<strong>Are you a Twig fan? As a side effect, I made 27 regular expression to handle 80 % of the Latte to Twig migration for you.</strong></p> ]]></description>
                <content:encoded><![CDATA[ <img src="/assets/images/posts/2018/latte-twig/latte.png" class="mt-5 ml-5">
<img src="/assets/images/posts/2018/latte-twig/twig.jpg">
<p>This regex saga started as an experiment on this site. I tested the Twig support in Statie here. This web had ~20 files in Latte and I needed them to be in Twig, so I know the Twig support works with all the edge cases I use on daily basis.</p>
<p>After the 5th change of code from <code>{$value}</code> to <code>{{ value }}</code> I started to have a weird feeling of being a robot or <a href="/blog/2018/05/03/how-do-you-treat-your-own-first-ai/">a very slow AI</a>. So I stopped to think a bit...</p>
<blockquote class="blockquote text-center">
    "The question you should be asking isn't, "What do I want?" or "What are my goals?" but "What would excite me?"
    <footer class="blockquote-footer">Tim Ferriss</footer>
</blockquote>
<p>And what excites me? <strong>Investing 5 hours to automate 30-minutes manual work under 10 seconds, so no-one else will have to do that ever again.</strong></p>
<h2 id="Brother-from-Another-Mother">Brother from Another Mother</h2>
<p>The biggest difference between Latte, Twig, Smarty, Blade and all other templating engines is rather in the way they're written inside than in the syntax itself.</p>
<p>See Latte code:</p>
<pre><code class="language-html">{foreach $values as $key =&gt; $value}
    {$value-&gt;getName()}

    {if isset($value['position'])}
        {$value['position']|noescape}
    {else}
        {var $noPosition = true}
    {/if}
{/foreach}</code></pre>
<p>And see Twig code:</p>
<pre><code class="language-twig">{% for key, value in values %}
    {{ value.getName() }}

    {% if value.position is defined %}
        {{ value.position|raw }}
    {% else %}
        {% set noPosition = true %}
    {% endif %}
{% endfor %}</code></pre>
<p>And that's how 27 regular expressions solution was born step by step.</p>
<p><br></p>
<p>I'm not using <code>preg_replace</code>, but rather util method <a href="https://github.com/nette/utils/blob/8eda0c33f798f7ce491715e9dae8797f191e9b00/src/Utils/Strings.php#L475"><code>Nette\Utils\String::replace()</code></a> that handles compile-time errors, run-time errors and few more tricks in a fancy way. Do you want to use it too? Just run <code>composer update nette/utils</code>.</p>
<p><strong>Do you want to skip details and use it?</strong> Jump to <em><a href="#install-and-use-it">Install and Use It</a></em> section.</p>
<h3 id="1-Block-Define-Include">1. Block, Define, Include</h3>
<ul>
<li><a href="https://latte.nette.org/en/macros#toc-blocks">in Latte</a></li>
<li><a href="https://twig.symfony.com/doc/2.x/tags/block.html">in Twig</a></li>
</ul>
<pre><code class="language-php">use Nette\Utils\Strings;

// ...

// {block someBlock}...{/block} =&gt;
// {% block anotherBlock %}...{% endblock %}
$content = Strings::replace($content, '#{block (\w+)}(.*?){\/block}#s', '{% block $1 %}$2{% endblock %}');

// {include "_snippets/menu.latte"} =&gt;
// {% include "_snippets/menu.latte" %}
$content = Strings::replace($content, '#{include ([^}]+)}#', '{% include $1 %}');

// {define sth}...{/define} =&gt;
// {% block sth %}...{% endblock %}
$content = Strings::replace($content, '#{define (.*?)}(.*?){\/define}#s', '{% block $1 %}$2{% endblock %}');

// {% include ... %} =&gt;
// {{ block('...') }}
$content = Strings::replace($content, '#{% include \'?(\w+)\'? %}#', '{{ block(\'$1\') }}')</code></pre>
<p>The most useful expression here is <code>(.*?)</code>. <strong>It will capture everything until the next pattern</strong>. In this case it keeps everything between 2 tags.</p>
<p>Also, <strong>mind the <code>#s</code> modifier</strong>. <code>(.*?)</code> matches newlines as well thanks to that. You can read more about modifiers in <a href="http://php.net/manual/en/reference.pcre.pattern.modifiers.php">PHP Documentation</a></p>
<p>The last notable tip I learned is <code>\w</code>, that matches <code>[a-zA-Z0-9_]</code> characters - usually all you need for variable names.</p>
<h3 id="2-Capture-Set">2. Capture, Set</h3>
<ul>
<li><a href="https://latte.nette.org/en/macros#toc-variable-declaration">in</a> <a href="https://latte.nette.org/en/macros#toc-capturing-to-variables">Latte</a></li>
<li><a href="https://twig.symfony.com/doc/2.x/tags/set.html">in Twig</a></li>
</ul>
<pre><code class="language-php">use Nette\Utils\Strings;

// ...

// {var $var = $anotherVar} =&gt;
// {% set var = anotherVar %}
$content = Strings::replace($content, '#{var \$?(.*?) = \$?(.*?)}#s', '{% set $1 = $2 %}');

// {capture $var}...{/capture} =&gt;
// {% set var %}...{% endset %}
$content = Strings::replace($content, '#{capture \$(\w+)}(.*?){\/capture}#s', '{% set $1 %}$2{% endset %}');</code></pre>
<p>As Twig doesn't use <code>$var</code> but just <code>var</code> as variable name, we need to get rid of the dollar <code>$</code> sign.</p>
<p>That's what this expression does:</p>
<pre><code class="language-bash">\$?(.*?)</code></pre>
<p>It will capture anything, but if there is <code>$</code>, it will remove it.</p>
<h3 id="3-Comments">3. Comments</h3>
<ul>
<li><a href="https://latte.nette.org/en/macros">in Latte</a></li>
<li><a href="https://twig.symfony.com/doc/2.x/templates.html#comments">in Twig</a></li>
</ul>
<pre><code class="language-php">use Nette\Utils\Strings;

// ...

$content = Strings::replace($content, '#{\*(.*?)\*}#s', '{#$1#}');</code></pre>
<h3 id="4-Conditions-If-Ifset">4. Conditions, If, Ifset</h3>
<ul>
<li><a href="https://latte.nette.org/en/macros#toc-conditions">in Latte</a></li>
<li><a href="https://twig.symfony.com/doc/2.x/tags/if.html">in Twig</a></li>
</ul>
<pre><code class="language-php">use Nette\Utils\Strings;

// ...

// https://regex101.com/r/XKKoUh/1/
// {if isset($post['variable'])}...{/if} =&gt;
// {% if $post['variable'] is defined %}...{% endif %}
$content = Strings::replace(
    $content,
    '#{if isset\((.*?)\)}(.*?){\/if}#s',
    '{% if $1 is defined %}$2{% endif %}'
);

// {ifset $post}...{/ifset} =&gt;
// {% if $post is defined %}..{% endif %}
$content = Strings::replace($content, '#{ifset (.*?)}(.*?){\/ifset}#s', '{% if $1 is defined %}$2{% endif %}');

// {% if $post['deprecated'] =&gt;
// {% if $post.deprecated
// https://regex101.com/r/XKKoUh/2
$content = Strings::replace($content, '#{% (\w+) \$([A-Za-z]+)\[\'([\A-Za-z]+)\'\]#', '{% $1 $2.$3');

// {if "sth"}..{/if} =&gt;
// {% if "sth" %}..{% endif %}
// https://regex101.com/r/DrDSJf/1
$content = Strings::replace($content, '#{if (.*?)}(.*?){\/if}#s', '{% if $1 %}$2{% endif %}');

$content = Strings::replace($content, '#{else}#', '{% else %}');

$content = Strings::replace($content, '#{elseif (.*?)}#', '{% elseif $1 %}');</code></pre>
<p>Nothing fancy here, just another great use case for <code>(.*?)</code> group.</p>
<h3 id="5-Filters">5. Filters</h3>
<ul>
<li><a href="https://latte.nette.org/en/filters">in Latte</a></li>
<li><a href="https://twig.symfony.com/doc/2.x/filters/index.html">in Twig</a></li>
</ul>
<pre><code class="language-php">use Nette\Utils\Strings;

// ...

// {$post['updated_message']|noescape} =&gt;
// {{ post.updated_message|noescape }}
$content = Strings::replace($content, '#{\$([A-Za-z_-]+)\[\'([A-Za-z_-]+)\'\]\|([^}]+)}#', '{{ $1.$2|$3 }}');

// | noescape =&gt;
// | raw
$content = Strings::replace($content, '#\|(\s+)?noescape#', '|$1raw');

// {% if count($var) %} =&gt;
// {% if $var|length) %}
$content = Strings::replace($content, '#{% (.*?) count\(\$?(\w+)\)#', '{% $1 $2|length');</code></pre>
<p>No surprises here.</p>
<h3 id="6-Loops-While-For-Foreach">6. Loops, While, For, Foreach</h3>
<ul>
<li><a href="https://latte.nette.org/en/macros#toc-loops">in Latte</a></li>
<li><a href="https://twig.symfony.com/doc/2.x/tags/for.html">in Twig</a></li>
</ul>
<pre><code class="language-php">use Nette\Utils\Strings;

// ...

// {foreach $values as $key =&gt; $value}...{/foreach} =&gt;
// {% for key, value in values %}...{% endfor %}
$content = Strings::replace(
    $content,
    '#{foreach \$([()\w ]+) as \$([()\w ]+) =&gt; \$(\w+)}#',
    '{% for $2, $3 in $1 %}'
);

// {foreach $values as $value}...{/foreach} =&gt;
// {% for value in values %}...{% endfor %}
$content = Strings::replace($content, '#{foreach \$([()\w ]+) as \$([()\w ]+)}#', '{% for $2 in $1 %}');
$content = Strings::replace($content, '#{/foreach}#', '{% endfor %}');

// {sep}, {/sep} =&gt; {% if loop.last == false %}, {% endif %}
$content = Strings::replace($content, '#{sep}([^{]+){\/sep}#', '{% if loop.last == false %}$1{% endif %}');</code></pre>
<h3 id="7-Variables">7. Variables</h3>
<ul>
<li><a href="https://latte.nette.org/en/macros#toc-variable-printing">in Latte</a></li>
<li><a href="https://twig.symfony.com/doc/2.x/templates.html#variables">in Twig</a></li>
</ul>
<pre><code class="language-php">use Nette\Utils\Strings;

// ...

// {$google_analytics_tracking_id} =&gt;
// {{ google_analytics_tracking_id }}
// {$google_analytics_tracking_id|someFilter} =&gt;
// {{ google_analytics_tracking_id|someFilter }}
$content = Strings::replace($content, '#{\$(\w+)(\|.*?)?}#', '{{ $1$2 }}');

// {$post-&gt;getId()} =&gt;
// {{ post.getId() }}
$content = Strings::replace($content, '#{\$([\w]+)-&gt;([\w()]+)}#', '{{ $1.$2 }}');

// {$post['relativeUrl']} =&gt;
// {{ post.relativeUrl }}
$content = Strings::replace($content, '#{\$([A-Za-z_-]+)\[\'([A-Za-z_-]+)\'\]}#', '{{ $1.$2 }}');

// {% if $post['rectify_post_id'] is defined %} =&gt;
// {% if post.rectify_post_id is defined %}
$content = Strings::replace($content, '#({% \w+) \$(\w+)\[\'(\w+)\'\]#', '$1 $2.$3');</code></pre>
<p>This was the simplest set so far. Always start with the easiest first.</p>
<h3 id="8-Suffix">8. Suffix</h3>
<pre><code class="language-php">use Nette\Utils\Strings;

// ...

// "_snippets/menu.latte" =&gt;
// "_snippets/menu.twig"
$content = Strings::replace($content, '#([A-Za-z_/"]+).latte#', '$1.twig');</code></pre>
<h3 id="9-Include-With-Vars">9. Include With Vars</h3>
<p>This is the most complex solution in the set. What it does?</p>
<pre><code class="language-diff">-{% include "_snippets/menu.latte", "data" =&gt; $data %}
+{% include "_snippets/menu.twig" with { "data": data } %}</code></pre>
<p>It looks pretty simple, but I could not find an easier way to work with the nested array items.</p>
<pre><code class="language-php">use Nette\Utils\Strings;

// include var:
// {% include "_snippets/menu.latte", "data" =&gt; $data %} =&gt;
// {% include "_snippets/menu.twig", { "data": data } %}
// see https://twig.symfony.com/doc/2.x/functions/include.html
// single lines
// ref https://regex101.com/r/uDJaia/1
$content = Strings::replace($content, '#({% include [^,]+,)([^}^:]+)(\s+%})#', function (array $match) {
    $variables = explode(',', $match[2]);
    $twigDataInString = ' { ';
    $variableCount = count($variables);
    foreach ($variables as $i =&gt; $variable) {
        [$key, $value] = explode('=&gt;', $variable);
        $key = trim($key);
        $value = trim($value);
        $value = ltrim($value, '$'); // variables do not start with
        $twigDataInString .= $key . ': ' . $value;
        // separator
        if ($i &lt; $variableCount - 1) {
            $twigDataInString .= ', ';
        }
    }
    $twigDataInString .= ' }';

    return $match[1] . $twigDataInString . $match[3];
});

// {% include "sth", =&gt;
// {% include "sth" with
$content = Strings::replace($content, '#({% include [^,{]+)(,)#', '$1 with');</code></pre>
<p>What is here to take away? The <code>[^,{]+</code> set. It tells <em>find everything until the first <code>,</code> or <code>{</code> character</em>.
That way we catch everything we don't really work with.</p>
<h2 id="Install-and-Use-It">Install and Use It</h2>
<pre><code class="language-bash">composer require symplify/latte-to-twig-converter:@dev --dev
vendor/bin/latte-to-twig-converter convert app/templates</code></pre>
<p>It will find all the <code>*.twig</code> files, look for Latte code in it and if that matches, it will convert it to Twig. That way your <code>*.latte</code> files will keep Latte as long as you don't rename them.</p>
<p>I'd link you to <a href="https://github.com/symplify/lattetotwigconverter">README</a> now for more, but actually, there is no more, this is all the usage.</p>
<p><br></p>
<h3 id="How-Does-This-Set-Work-in-Real-Project">How Does This Set Work in Real Project?</h3>
<p>Just see <a href="https://github.com/TomasVotruba/tomasvotruba.com/pull/380">the PR on this website</a>
or <a href="https://github.com/pehapkari/pehapkari.cz/pull/486">the PR to Pehapkari.cz website</a>.</p>
<img src="/assets/images/posts/2018/latte-twig/diff.png" class="img-thumbnail">
<p><br></p>
<h2 id="Go-Out-and-Play">Go Out and Play</h2>
<p>In the end, I'd like to encourage you to do more of such experiments. I meet many programmers on meetups all across the Europe and they often don't have space - either the time in work or they won't allow themselves - to <strong>do such experiments</strong>.</p>
<p>In my open-source experience, these experiments give you the most knowledge. Instead of choosing the first solution because <em>I don't have time and I have to deliver the value</em>, I tried 3-4, tested them and then picked the one that worked the best. It was not the first one of course, and even if it was, I'd be much more convinced the solution is right instead of just blindly believing it.</p>
<p>I learned a lot about regular expressions, about delimiters and universal capturing groups (easter egg: seek &quot;http&quot; in the source code and you'll find all the tips I found and found useful) thanks to StackOverflow and <a href="https://regex101.com">regex101.com</a>. I also must thank Jáchym Toušek and Ondra Mirtes with PHPStan who got me more engaged in regular expressions in a useful and not-so-frustrating way.</p>
<p><br>
<br></p>
<p><strong>Free your mind and experiment! It's the best way to get better every iteration.</strong></p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/07/05/how-to-convert-latte-templates-to-twig-in-27-regular-expressions</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 05 Jul 2018 00:00:00 +0000</pubDate>
                                    <updated>2019-03-01UTC00:00:000</updated>
                    <atom:updated>Fri, 01 Mar 2019 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Fri, 01 Mar 2019 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/07/05/how-to-convert-latte-templates-to-twig-in-27-regular-expressions#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Cluster: More Interactive than a Book, Deeper than a Post ]]></title>
                <link>https://tomasvotruba.com/blog/2018/07/02/cluster-more-interactive-than-book-deeper-than-post</link>
                <description><![CDATA[ <p>I started this 2-part series by <a href="/blog/2018/06/28/dont-read-books/">Don't Read Books</a>. What should we do instead?
<br><br>
There is no silver bullet, but I have few proposals that anyone sharing knowledge in text form can do to rise quality of the content better and make readers get more out of it in the long-term.
<br>
It will not earn as much money as &quot;bestselling&quot; books, but if you value education more than money like me, keep on reading.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Tested-Content-is-Easier-To-Keep-Up-To-Date">Tested Content is Easier To Keep Up-To-Date</h2>
<p>Is there a code in your post or chapter, piece of text? It <a href="/blog/2019/09/16/why-software-articles-must-be-ci-tested/">should be tested</a>. Back to our Symfony book. Imagine you buy it, you read it and there is section about forms. But thanks to <em>everlasting deprecation</em> effect, you happen to use Symfony 4.1, but book is about Symfony 3.0, so it doesn't work and you've just wasted 20 $ in money for a book and hundreds $ in time investment.</p>
<p>Now imagine this post would be tested, with unit tests and Travis CI that would run daily to make sure the content is still valuable in the present. The day new Symfony with BC break is released, the new version of post is published. And that works super easily for version 4, version 5, version 6...</p>
<p>Btw, I know you can find up-to-date know-how for Symfony Forms in the documentation, but this is just an example. It could be any more complex non-documented code, like writing a <a href="/blog/2018/05/28/build-your-first-symfony-console-application-with-dependency-injection-under-4-files/">Console application with Dependency Injection</a>.</p>
<h2 id="Let-People-Into-Your-Hearth">Let People Into Your Hearth</h2>
<p>...or at least your thoughts. <strong>A book content is one-man-show, with one-man ideas</strong> and I think that is dangerous, unless we talk about God that helps us all and everyone can agree on that. I don't think my ideas are the best and that I know everything (or anything). I just want to open discussion in the best direction I believe at the moment.</p>
<blockquote class="blockquote text-center">
    "The community of people knows much more<br>
    than the most skilled person in it."
</blockquote>
<p>If people cooperate and talk to each other, they can bring much more value and higher quality solutions.
That's probably the reason companies have more than 1 employee, right? :)</p>
<p>How to allow this in written content? <strong>Simple - allow comments.</strong> Allow them all the time, <a href="/blog/2018/01/29/how-to-deal-with-haters-in-comments-and-github/">without censorship of opposed ideas</a>.</p>
<p>That way people can express themselves and improve content to be:</p>
<ul>
<li>community-proofed</li>
<li>validated by more than 1 person</li>
<li>questioned if that is really the best there is (at the time of reading)</li>
</ul>
<h2 id="Let-People-Build-the-Content">Let People Build the Content</h2>
<p>If you allow comments, it's the first step to improve the content. But most people read the content and not the comments - by naturally, you need to read the post, so you could understand comments under it.</p>
<p>What if the readers could change the content? And what if you make it as easy for them as <a href="https://github.com/TomasVotruba/tomasvotruba.com/edit/master/source/_posts/2018/2018-06-28-dont-read-books.md">clinking a link</a>.</p>
<p>That way the content is cooperative work of more people, more authors would be happy to share it and get credit for it. 3 posts about Symfony Console <a href="https://www.linkedin.com/pulse/proven-practices-process-stan-garfield">proven practice</a> by 3 different authors can never be as good as 1 written by 3 authors together.</p>
<div class="text-center mb-3">
    <img src="/assets/images/posts/2018/no-books/contributors.png" class="img-thumbnail">
    <br>
    This is number of contributors to this blog. It's not like we're writing together all the time, but I'm very happy it's more than 0, much more. Thank <a href="https://github.com/TomasVotruba/tomasvotruba.com/graphs/contributors">you all</a>!
</div>
<h2 id="Levelling-Up-Tailored-to-Your-Personal-Needs">Levelling Up Tailored to Your Personal Needs</h2>
<p>Each of us has different experience, past, motivation and know-how. It makes no sense that all of us read whole book about Symfony.</p>
<p>Also each skill has a group - <em>a cluster</em> of knowledge of various levels that you can master.</p>
<div class="text-center mb-3">
    <img src="/assets/images/posts/2018/no-books/hollocracy.png" class="img-thumbnail" width="500">
    <br>
    <em>A cluster pattern in <a href="https://sylius.com/blog/holacracy-our-future-is-teal">Holacracy organization</a>
</em></div>
<p>It makes no sense that everyone would read the same book from beginning till the end. Instead you can start at level 5, I can start
at level 2, and somebody only wants the level 10, if there is something new he can learn in the field he thinks he masters already.</p>
<p>With a cluster of posts, you can see clearly where to start and what you want to read.</p>
<h3 id="The-Next-Nearest-Skill">The Next Nearest Skill</h3>
<p>This is connected to <em>prerequisite skill</em> system. Each skill is followed by the nearest one that is super easy to learn thanks to previous experience. Compare 2 learning scenarios:</p>
<ul>
<li>You drive a bike, then motorcycle, then a car and than a bus.</li>
<li>You drive a bike and jump directly to the bus.</li>
</ul>
<p>Which can build on previous experience and utilize neuron patterns faster?</p>
<h2 id="Inform-Clearly-about-Deprecations-and-Changes">Inform Clearly about Deprecations and Changes</h2>
<p>The last but most least, people often return to content they believe in and look for iterative improvement in it. That's why we use StackOverflow and see answers that worked in 2015 to have 100 vote, but also there is a new one in 2018, that has already 20 votes and in 2020 there will come even better one...</p>
<p>That's why I try to make clear what and how changed right in the beginning on such posts.</p>
<p><a href="/blog/2017/12/17/new-in-symplify-3-doc-block-cleaner-fixer/"></p>
<img src="/assets/images/posts/2018/no-books/updated-post.png" class="img-thumbnail">
<p></a></p>
<p>And also not to promote outdated deprecated know-how:</p>
<p><a href="/blog/2017/06/19/symbiotic-controller-nette-presenter-with-freedom/"></p>
<img src="/assets/images/posts/2018/no-books/deprecated-post.png" class="img-thumbnail">
<p></a></p>
<p>You might see this as redundant work and that I'm a nerd (guilty!), but <strong>I'm super-focused on you, my readers and I want you to understand every change that happens so you can learn fast in safe environment</strong>.</p>
<p><br></p>
<h2 id="The-Clusters-in-Progress">The Clusters in Progress</h2>
<p>First, I started this series as to show you the idea of clusters on my site, but then it went much further beyond that.</p>
<p>Check the idea and feedback me, what do you think about that.</p>
<p><br><br></p>
<p>Happy clustering!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/07/02/cluster-more-interactive-than-book-deeper-than-post</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 02 Jul 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/07/02/cluster-more-interactive-than-book-deeper-than-post#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Don&#039;t Read Books ]]></title>
                <link>https://tomasvotruba.com/blog/2018/06/28/dont-read-books</link>
                <description><![CDATA[ <p>You're probably thinking: &quot;He's joking, right? That's kind of that title, that is a parody to show us we should do the opposite. You won't get us again, Tomas.&quot;
<br>
<br>
<strong>No, I really don't think we should read books nor feel bad for not reading them</strong>. And now talk about those non-fiction books with the knowledge that readers want to use in their lives.
<br>
<br>
Do you still think this is sarcasm? Keep on reading.</p> ]]></description>
                <content:encoded><![CDATA[ <div class="text-center">
    <img src="/assets/images/posts/2018/no-books/fahrenheit-book.jpg" class="img-thumbnail">
    <br>
    <em>Don't worry, it's not illegal to read books yet...</em>
</div>
<p><br></p>
<p>I've read <a href="/blog/2018/04/12/the-best-5-of-256-bloghacks-book/">256 Bloghacks</a>, <a href="/blog/2017/09/25/3-non-it-books-that-help-you-to-become-better-programmer/">Steal Like an Artist, Deep Work, No More Mr. Nice Guy</a>, <a href="/blog/2018/06/18/14-surprising-tip-from-selling-is-human-to-influence-others/">Selling is Human</a> and <a href="/blog/2017/12/04/life30-what-will-you-do-when-ai-takes-over-the-world/">Life 3.0</a> during last 2 years and a couple more I haven't written about yet.</p>
<p>I mostly love books.</p>
<p>I just don't think <strong>it's the best-written format to learn from and that such format can actually hurt learning</strong>. It's not the author, the topic, but really <strong>the historical format to blame</strong>.</p>
<h2 id="Single-Person-Monolog">Single Person Monolog</h2>
<p>When you read a book, you absorb information without much critical thinking. There is no space to express disagreement, to pose a question, to clarify, to add a tip of your own. So we get used to just read, be silent and absorb. Can you recall any other situation on your life, where you absorb information without a doubt? I can't.</p>
<p>And be sure to let me know <a href="#comments">in the comments</a> if you <a href="http://www.paulgraham.com/disagree.html">disagree</a>.</p>
<h2 id="Best-Seller-vs-Best-Read">Best-Seller vs. Best-Read</h2>
<p>I'm known to be a minimalist so my bookshelf bears only 5 books, while all my other friends have 20-30 books. I always wondered &quot;do they read so fast, wow they're smart&quot;? So I was curious:</p>
<ul>
<li>&quot;Which are your favorite books?&quot;</li>
<li>&quot;What do you read now?&quot;</li>
<li>&quot;Well, how many have you read actually?&quot;</li>
</ul>
<p>The answers vary a bit, but the last question usually hits the nail on the head. It's barely a 1/4 on average.</p>
<h2 id="Buy-a-Book-to-Have-Friends">Buy a Book to Have Friends</h2>
<p>Then I realized that &quot;bestseller&quot; has nothing to do with the content. It's like having a cool free application in your phone that you never use or famous &quot;friend&quot; on Facebook you never write but anyone can see you're &quot;friends&quot;.</p>
<p>Hype beats knowledge, at least at the time being. <strong>It's less important the how book really is valuable to the reader than how cool it is, how nice cover it has, how many of my friends and celebrities recommend it</strong>.</p>
<p>I personally know many technical books from Czech authors that people bought, but never read. Which makes me sad for both sides, the reader and the author, and also for the trees that will now lie dead on a shelf made from another tree.</p>
<h2 id="The-Longer-The-Vaguer">The Longer, The Vaguer</h2>
<p>Imagine this post would have 20 pages. I would go on detail, start to talk about my day and how everyday life is connected to reading books and what I read in my childhood and formed me to who I am... blah blah blah.</p>
<p>It's called state of <em>flow</em> and you can see it very clearly when somebody gives a talk that lasts 30+ minutes. It's not a rule, but the easiest way to spot it in the public.</p>
<p>Why? Because <a href="https://www.ted.com/talks/mihaly_csikszentmihalyi_on_flow">flow makes people happy</a> and they <a href="https://en.wikipedia.org/wiki/Flow_(psychology)">thoroughly focus on the present, hours seem to pass by the minute</a>.</p>
<blockquote class="blockquote text-center">
    "Give me a man a week to finish a 4-hour work – he'll finish it in a week.
    <br>
    Give him 4 hours to finish a week work – he'll finish it in 4 hours."
</blockquote>
<p>One example for all: have you ever read my bachelor thesis about polyphasic sleep that has 50+ pages? Me neither, so I made <a href="/blog/2018/02/12/sleep-shorter-to-get-62-percent-smarter/">a short post</a>.</p>
<h2 id="The-Book-Chapter-Format-vs-Skill-Leveling">The Book Chapter Format vs. Skill Leveling</h2>
<p>The book format is great for stories. There is a beginning, plot... well, the classic <em>Hero's Journey</em>.</p>
<img src="/assets/images/posts/2018/no-books/heros-journey.png" class="img-thumbnail" width=500>
<p>It works for stories, but what about skills and know-how? Let's say you have a new job and you want to learn a new framework - Symfony.
Do you buy &quot;a Symfony book&quot; and read it? And then you know Symfony? You might and you'll be feeling great about it.</p>
<div class="text-center">
    <img src="/assets/images/posts/2018/no-books/know.jpg" class="img-thumbnail">
</div>
<blockquote class="blockquote text-center">
    "It's interesting how the brain works when you have no clue."
    <footer class="blockquote-footer">Jakob Oberhummer at <a href="https://www.meetup.com/viennaphp/events/djtpjpyxjbcc/">Vienna PHP</a></footer>
</blockquote>
<p>But what do so much of random education (it has its meaning, but not here) if your first task is to create a contact form? Maybe there are <a href="https://github.com/pehapkari/awesome-symfony-education#forms">posts about writing forms that go beyond the documentation</a> that take you 20 minutes to read.</p>
<p>Having a whole book would probably confuse you and make you feel great at the same time.</p>
<h2 id="Everlasting-Deprecation">Everlasting Deprecation</h2>
<p>Like <a href="/blog/2017/10/30/what-can-you-learn-from-menstruation-and-symfony-releases/">menstruation</a>, the cycle of life is very similar to the cycle of knowledge - or to <em>a paradigm</em> if you prefer.</p>
<img src="/assets/images/posts/2018/no-books/seasons.jpg" class="img-thumbnail" width=500>
<p>Think of PHP application you work on right now. You start fresh and with PHP 7.2, with the newest version of Symfony 4.1 and all goes great. Do you think that in 3 years you'll be using PHP 8.0 and Symfony 5.0 or rather stick to the old ones? And what about in next 3 years?</p>
<p>I'd pick first because the trend is they're faster, easier to learn and more intuitive to use.</p>
<p>Using old one (for whatever business reasons) is called <em>vendor lock</em> or <em>legacy code</em>.</p>
<img src="/assets/images/posts/2018/no-books/legacy.png" class="img-thumbnail" width=500>
<p>Same vendor lock happens to knowledge. You can see it the most in school systems, where 40-year-old people teach 15-year-olds their &quot;up-to-date&quot; know-how. People write PHP 7 as PHP 5.3 because there are so many old books out there about PHP 5.3.</p>
<h2 id="Wikipedia-2010-in-2018">Wikipedia 2010 in 2018?</h2>
<p><strong>Imagine that Wikipedia would be published just once 10 years as a book</strong>. So today, in 2018, somebody would quote a 8-year-old information in his school essay. It's crazy, right? But that's how books work naturally.</p>
<p><br><br></p>
<p>Yet, is there a better way to share <strong>inter-connected deep knowledge than in books that would be longer a single standalone post</strong>?</p>
<p>We'll explore few ideas in the following post.</p>
<p><br></p>
<p>Happy reading and let me know in the comments what you think about all this.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/06/28/dont-read-books</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 28 Jun 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/06/28/dont-read-books#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Let Changelog Linker Generate CHANGELOG.md for You ]]></title>
                <link>https://tomasvotruba.com/blog/2018/06/25/let-changelog-linker-generate-changelog-for-you</link>
                <description><![CDATA[ <p>Do you have an open-source project on Github? Do you want your users to know about new features and changes without you writing posts about it?
Do you <a href="https://keepachangelog.com/en/1.0.0">keep a changelog</a>? Do you struggle with keeping it up-to-date and descriptive and with all the links to all merged pull-requests?
<br>
<br>
Yes? Then you'll love <em>Changelog Linker</em>. A PHP CLI tool that does all this boring work for you.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Changelogs have many forms.</p>
<p>From standard <a href="https://keepachangelog.com/en/1.0.0">keepachangelog.com</a> with <em>Added</em>, <em>Changed</em>, <em>Fixed</em> and <em>Removed</em>:</p>
<img src="/assets/images/posts/2018/generate-changelog/keepachangelog.png" class="img-thumbnail">
<p>Through <a href="https://raw.githubusercontent.com/symfony/symfony/master/CHANGELOG-4.1.md">Symfony dump</a>:</p>
<img src="/assets/images/posts/2018/generate-changelog/symfony.png" class="img-thumbnail">
<p>Over <a href="https://github.com/phpstan/phpstan/releases/tag/0.10">PHPStan Release notes</a>:</p>
<img src="/assets/images/posts/2018/generate-changelog/phpstan.png" class="img-thumbnail">
<h2 id="Why-is-Every-Changelog-Different">Why is Every Changelog Different?</h2>
<p>There is a standard recommendation in <a href="https://keepachangelog.com/en/1.0.0">keepachangelog.com</a>, so it can all be the same, right?
I think it's because <strong>there is no easy way to generate such changelog</strong>. And by easy I mean automated = 1 click solution. And we don't even talk about monorepo changelog yet.</p>
<p>When I looked on Github <a href="https://github.com/symplify/symplify/issues/841">for inspiration</a>, I found only <a href="https://github.com/github-changelog-generator/github-changelog-generator">github-changelog-generator</a> - that has over 4600 stars on Github. Yet, it still doesn't work with <em>Added</em>, <em>Changed</em> etc. categories and requires labeling issues and pull-requests and adding milestones. <strong>I wanted to save time, not to add extra work.</strong></p>
<h2 id="Category-Monorepo-Support">Category + Monorepo Support?</h2>
<p>All I wanted to do is run 1 command and update <code>CHANGELOG.md</code> with content like this:</p>
<pre><code class="language-markdown">## [v4.4.0] - 2018-06-03

### Added

#### BetterPhpDocParser

- [#811] Add multi-types method support
- [#810] Add `AbstractPhpDocInfoDecorator`
- [#809] Allow `PhpDocInfoFactory` extension without modification
- [#807], [#808] Add `replaceTagByAnother()`
- [#806] Add `getParamTypeNodeByName()`
- [#804] Add `hasTag()` to `PhpDocInfo` and other improvements
- [#801] Add `PhpDocModifier` class

#### CodingStandard

- [#851] Add _ support to PropertyNameMatchingTypeFixer
- [#845] Extended RemoveEmptyDocBlockFixer fix
- [#836] Improve cognitive complexity error, Thanks to [@enumag]
- [#823] Add Cognitive complexity sniff</code></pre>
<p>I aim for 80/20 rule = let 80 % of manual work, manual linking, collecting of <em>Added</em>, grouping by <em>CodingStandard</em> package etc. handle program for us. Then we can polish the rest 20 %, like adding a description to the release or moving PR that the program failed to classify.</p>
<p>I imagined something like:</p>
<pre><code class="language-bash">vendor/bin/changelog-linker dump-mergers</code></pre>
<p>That would be much better than looking on Github, going through commits and putting it all together manually, right? Or bare git dump that no-one except you orients in.</p>
<p>Well, 2 months of work later and after detailed feedback from <a href="https://github.com/MattCzerner">Matouš Czerner</a> and <a href="https://github.com/vitek-rostislav">Rosťa Vítek</a> whom I'm very thankful, a <a href="https://github.com/symplify/changeloglinker">Symplify\ChangelogLinker</a> package was born.</p>
<h2 id="5-Steps-to-Your-Generated-CHANGELOG">5 Steps to Your Generated CHANGELOG</h2>
<ol>
<li>
<p>Install it</p>
<pre><code class="language-bash">composer require --dev symplify/changelog-linker</code></pre>
</li>
<li>
<p>Add target to your <code>CHANGELOG.md</code></p>
<pre><code class="language-markdown"># CHANGELOG

This is a changelog, you know?

&lt;!-- changelog-linker --&gt;</code></pre>
<p>There will be dumped the list of changes.</p>
</li>
<li>
<p>Run it dry</p>
<pre><code class="language-bash">vendor/bin/changelog-linker dump-merges --dry-run</code></pre>
<p>to see this preview:</p>
<pre><code class="language-markdown">## Unreleased

- [#868] [ChangelogLinker] Add ChangeTree to manage merge messages
- [#867] [ChangelogLinker] Change Worker registration from implicit to explicit
- [#864] [MonorepoBuilder] improve coverage
</code></pre>
</li>
<li>
<p>There are 2 more cool options: <code>--in-packages</code> and <code>--in-categories</code>. How to they work?</p>
<p>This...</p>
<pre><code class="language-bash">vendor/bin/changelog-linker dump-merges --dry-run --in-categories</code></pre>
<p>...will create:</p>
<pre><code class="language-markdown">## Unreleased

### Added

- [#868] [ChangelogLinker] Add ChangeTree to manage merge messages

### Changed

- [#867] [ChangelogLinker] Change Worker registration from implicit to explicit
- [#864] [MonorepoBuilder] improve coverage
</code></pre>
<p>And this...</p>
<pre><code class="language-bash">vendor/bin/changelog-linker dump-merges --dry-run --in-packages</code></pre>
<p>...will create:</p>
<pre><code class="language-markdown">## Unreleased

### ChangelgoLinker

- [#868] Add ChangeTree to manage merge messages
- [#867] Change Worker registration from implicit to explicit

### MonorepoBuilder

- [#864] improve coverage
</code></pre>
<p>Pro tip: you can combine them and set the priority by order:</p>
<pre><code class="language-bash">vendor/bin/changelog-linker dump-merges --dry-run --in-categories --in-packages
vendor/bin/changelog-linker dump-merges --dry-run --in-packages --in-categories</code></pre>
</li>
<li>
<p>When you're ready, run dump to <code>CHANGELOG.md</code>:</p>
<pre><code class="language-bash">vendor/bin/changelog-linker dump-merges --in-packages --in-categories</code></pre>
</li>
</ol>
<h2 id="Do-You-Have-Existing-CHANGELOG-md">Do You Have Existing <code>CHANGELOG.md</code>?</h2>
<p>The Changelog Linker doesn't work only for new changes, <strong>it can also link your existing file</strong>:</p>
<pre><code class="language-bash">vendor/bin/changelog-linker linkify</code></pre>
<h2 id="ProTip-Use-Composer-Script-and-Forget">ProTip: Use Composer Script and Forget</h2>
<p>Composer scripts are handy, if you use CLI command with many options and <strong>you don't want to remember and type them over and over again</strong>.</p>
<p>This is how I simplify my setup for Symplify <code>CHANGELOG.md</code>:</p>
<pre><code class="language-json">{
    "scripts": {
        "changelog": "vendor/bin/changelog-linker dump-merges --in-categories --in-packages"
    }
}</code></pre>
<p>So all I need to do is run...</p>
<pre><code class="language-bash">composer changelog</code></pre>
<p>...and the <code>CHANGELOG.md</code> file is updated. Pretty cool, huh?</p>
<p>Find more about Composer scripts in <em><a href="https://blog.martinhujer.cz/have-you-tried-composer-scripts">Have you tried Composer Scripts? You may not need Phing</a></em> post by amazing Martin Hujer.</p>
<p><br></p>
<p>That's it.</p>
<p><br></p>
<p><strong>For more features like linked <em>thanks</em>, package aliases or linked words see <a href="https://github.com/symplify/changeloglinker">README</a>.</strong></p>
<p><br></p>
<p>Enjoy your new free time!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/06/25/let-changelog-linker-generate-changelog-for-you</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 25 Jun 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/06/25/let-changelog-linker-generate-changelog-for-you#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Open Source is Selfish ]]></title>
                <link>https://tomasvotruba.com/blog/2018/06/21/open-source-is-selfish</link>
                <description><![CDATA[ <p>Most people I meet see <em>open-source</em> as &quot;putting all your work free to the public&quot;. Do you think that I'd love it so much if that was the case?
<br><br>
That's why I want to talk about the selfish benefits of open-source, that come first, almost always, but just a few people can see them. And that <em>selfish open-source</em> is a good thing.</p> ]]></description>
                <content:encoded><![CDATA[ <p>There are 2 major views I see in open-source: <em>a victim</em> and <em>a selfish egoist</em>.</p>
<h2 id="Open-Source-as-a-Victim">Open-Source as a Victim</h2>
<p>We had a panel discussion at <a href="http://www.phplive.cz">PHPLive 2018</a>  about the pros and cons of making your code open-source and <strong>it surprised me how negatively open-source is viewd</strong>. This might be related mainly to Czech &amp; Slovak programmers, since we were raised victims by default in communism till 1993.</p>
<p>What am I talking about? That open-source code is something you do for the public, in your free time. You expect them to contribute to your project; in a way you expect the code to be written. You feel like a boss and you own all the keys.</p>
<p>People are not listening to you, you have to raise them, you do it for them, you help them, you take care of them. You were the chosen one and you know the best, because you have programmed for much longer than them, you're older and you earn at least triple their income.</p>
<p>They should be thankful!</p>
<p><br></p>
<p>You see the victim?</p>
<h3 id="How-Does-it-Work">How Does it Work?</h3>
<p>I'm exaggerating a bit, but this can easily happen to anyone, due to the <em>power trip effect</em>. It has happened to me before and I still have to be careful not to give in to strong emotions. <strong>This is the best way to drive people away, trust me.</strong></p>
<h2 id="Open-Source-as-a-Selfish-Act">Open-Source as a Selfish Act</h2>
<p><a href="http://jakubkratina.cz">Jakub Kratina</a> is a friend of mine, who organizes livestreams in Péhápkaři. He helped me a lot to become a better businessman and - little may he know - about <em>self-love</em> in open-source.</p>
<p>One day I was frustrated with <a href="https://github.com/symplify/easy-coding-standard">EasyCodingStandard</a> - I wanted to have the best (the all) features and resolve all the issues as fast as possible <em>to make people happy</em>. <strong>Inside I felt I want to do something else.</strong> Instead, I wanted to migrate from magic in extension to explicit services. I felt like those people are stopping me from being happy, I was a victim of all those issues.</p>
<p>Luckily I talked with Jakub and he told me very wise words (I even printed on my <a href="https://www.danpink.com/pinkcast">love board</a> later):</p>
<p>&quot;It's your open-source, your code, your passion, and your work. If you want to do it, do it. What is the point of doing work if it's not making you happy?&quot;</p>
<p>I realized a very simple point:</p>
<h3 id="The-Open-Source-Work-Has-To-Make-You-Happy">The Open-Source Work Has To Make You Happy</h3>
<p>And if not, I'm doing something wrong and I have to change that, or I will burn out. This helped me to <a href="https://github.com/symplify/symplify/pull/660">push my idea</a> to a PR a few days later at Epicon.</p>
<p><br></p>
<h2 id="There-is-More-than-Meets-the-Eye">There is More than Meets the Eye</h2>
<p>How does open-sourcing makes your code grow, get your company to hire great developers, or give you a super boost in programming skills?
More posts to come on this topic.</p>
<img src="https://pehapkari.cz/assets/images/conferences/prague-2018/logo.png" class="img-thumbnail">
<p>Oh, you can't wait that long and want to challenge my points in person? I'll have a talk <em>Why Your Company Loses Money By Not-Open-Sourcing</em> on <a href="https://phpprague.cz">PHPPrague</a> this Saturday. Be sure to come!</p>
<p><br></p>
<p>You can go further on <a href="https://jlongster.com/Why-Frequently-Absent-Open-Source">Why I'm Frequently Absent from Open Source
</a> by James Long.</p>
<p><br></p>
<p>Happy code-loving!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/06/21/open-source-is-selfish</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 21 Jun 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/06/21/open-source-is-selfish#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 14 Surprising Tips from Selling is Human to Influence Others ]]></title>
                <link>https://tomasvotruba.com/blog/2018/06/18/14-surprising-tip-from-selling-is-human-to-influence-others</link>
                <description><![CDATA[ <p>Recently, I've read <a href="https://www.youtube.com/watch?v=nKrBitIQrgo&amp;feature=youtu.be&amp;t=290">Selling is Human</a> by Daniel Pink. He's famous for <a href="https://www.danpink.com/pinkcast">Pinkcast</a> - an espresso of knowledge. I like him, because he's often right to the point, with examples, stories, and science.
<br><br>
What can we learn about selling?
Lucky for you, you don't have to read the whole book - here are the top 10 points I found very useful.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="How-is-Selling-Useful-to-Programmers">How is Selling Useful to Programmers?</h2>
<p><em>Selling</em> is not just you buying a cup of coffee or selling a computer on the online store you made. Selling is rather an abstract term, to sell your ideas, to persuade people around you. But not just to make them abide you but to cooperate with you. <strong>To be a leader people love.</strong></p>
<p>You probably think &quot;I'm a programmer, I don't handle selling, I just do my job by making the best code I can.&quot;</p>
<p>Let me give you few examples when I had to <em>sell</em> to be able to write the best I can:</p>
<ul>
<li>When I wanted to write tests in an application with 0 % coverage a get paid for it.</li>
<li>When I wanted to write open-source code and be paid for it.</li>
<li>When I wanted to convince other that Doctrine is wiser to use than writing their own ORM.</li>
<li>When I have a talk about ECS and I want to people starting using coding standard even thou got burned in the past by complexity of other tools.</li>
</ul>
<p>And so on. I believe you can think of 2 ideas right know where <strong>do you want to sell your ideas better</strong>.</p>
<p>How does <em>Selling is human</em> can help us with it?</p>
<p>Take following quotes as list of notes you'd make by reading the whole book. Save time to win knowledge.</p>
<h2 id="1-Selling-Win-Win-in-Long-Term">1. Selling = Win-Win in Long Term</h2>
<img src="/assets/images/posts/2018/selling/quote.png" class="img-thumbnail">
<p><br></p>
<h2 id="2-Self-Boost-Before-the-Pitch">2. Self-Boost Before the Pitch</h2>
<blockquote class="blockquote">
    "I'm the best. This is going to be a breeze," and that might give you a short-term emotional boost. <strong>But if you instead ask, "Can I make a great pitch?" the research has found that you provide yourself something that reaches deeper and lasts longer.</strong>
    <br>
    <br>
    You might respond to yourself "Well, yes, I can make a great pitch. In fact, I've probably pitched ideas at meetings two dozen times in my life." You might remind yourself of your preparation. "Sure, I can do this. I know this material inside out and I've got some great examples to persuade the people who might be skeptical." You might also give yourself specific tactical advice. "At the last meeting like this, I spoke too quickly - so this time I'll slow down."
</blockquote>
<hr />
<blockquote class="blockquote">
    "Questioning self-talk elicits the reasons for doing something and reminds people that many of those reasons come from within."
</blockquote>
<hr />
<blockquote class="blockquote">
    Ask yourself: "Can I move these people?" As social scientists have discovered, interrogative self-talk is often more valuable than the declarative kind. <strong>But don't simply leave the question hanging in the air like a lost balloon. Answer it - directly and in writing. List 5 specific reasons why the answer to your question is yes. These reasons will remind you of the strategies that you'll need to be effective on the task, providing a sturdier.</strong>
</blockquote>
<p><br></p>
<h2 id="3-Too-much-Positive-Harms">3. Too much Positive Harms</h2>
<blockquote class="blockquote">
    Once positive emotions outnumbered negative emotions by 3:1 - that is, for every three instances of feeling gratitude, interest, or contentment, they experienced only one instance of anger, guilt, or embarrassment - people generally flourished. Those below that ratio usually did not. But Fredrickson and Losada also found that positivity had an upper limit. <storng>Too much can be as unproductive as too little. Once the ratio hit about 11 to 1, positive emotions began doing more harm than good.</storng>
</blockquote>
<p><br></p>
<h2 id="4-Working-with-Feedback-that-Hurts">4. Working with Feedback that Hurts</h2>
<p>I wrote <a href="/blog/2018/01/29/how-to-deal-with-haters-in-comments-and-github/">How to Deal With Haters in Comments and Github</a> a while ago. And Daniel Pink shows 2 tips that can be added there right away:</p>
<blockquote class="blockquote">
    When something bad occurs, ask yourself three questions - and come up with an intelligent way to answer each one "no": 1. Is this permanent? Bad response: "Yes. I've completely lost my skill for moving others." Better response: "No. I was flat today because I haven't been getting enough sleep." 2. Is this pervasive?"
</blockquote>
<blockquote class="blockquote">
    The more you explain bad events as temporary, specific, and external, the more likely you are to persist even in the face of adversity.
</blockquote>
<p><br></p>
<h2 id="5-Compare-Give-a-Context-to-Bare-Phrases">5. Compare, Give a Context to Bare Phrases</h2>
<p>A blind man was collecting money on the street with a sign: <em>I am blind</em>. A researcher goes around and adds 4 words: <em>It is spring time and</em>. It results in:</p>
<p><strong>It is spring time and</strong>
<br>
<strong>I am blind</strong></p>
<blockquote class="blockquote">
    That's why the most essential question you can ask is this: Compared to what?
</blockquote>
<p><br></p>
<h2 id="6-Potential-With-Imagination-beats-Real-Achievements">6. Potential With Imagination beats Real Achievements</h2>
<blockquote class="blockquote">
    People often find potential more interesting than accomplishment because it's more uncertain, the researchers argue. That uncertainty can lead people to think more deeply about the person they're evaluating - and the more intensive processing that requires can lead to generating more and better reasons why the person is a good choice.
    <br>
    <br>
    So next time you're selling yourself, don't fixate only on what you achieved yesterday. Also, emphasize the promise.
</blockquote>
<p><br></p>
<h2 id="7-Juices-over-Numbers">7. Juices over Numbers</h2>
<blockquote class="blockquote">
I've learned that <strong>rational questions are ineffective for motivating resistant people</strong>. <br>
Instead, I've found that <strong>irrational questions actually motivate people better</strong>.
</blockquote>
<p><br></p>
<h2 id="8-Focus-on-Roots-of-Motivation-instead-of-Blaming">8. Focus on Roots of Motivation instead of Blaming</h2>
<p>Your daughter is about to have a test tomorrow, but she's procrastinating so she might fail.
You ask her: &quot;On scale 1 to 10, how confident do you feel you'll make the test?&quot;</p>
<p>&quot;I guess 4&quot;, she replies.</p>
<blockquote class="blockquote">
    "Why didn't you pick a lower number?" This is the question that catches everybody off guard," Pantalon writes in his book Instant Influence.
    <br>
    <br>
    <strong>She moves from defending her current behavior to articulating why, at some level, she wants to behave differently</strong>. And that says Pantalon, allows her to clarify her personal, positive, and intrinsic motives for studying, which increases the chances she actually will. So, on a scale of 1 to 10, how ready are you to try Pantalon's two-question technique? And why isn't your number lower?"
</blockquote>
<p><br></p>
<h2 id="9-How-was-the-Elevator-Pitch-Born">9. How was <em>the Elevator Pitch</em> Born?</h2>
<img src="/assets/images/posts/2018/selling/elevator-pitch.jpg" class="img-thumbnail">
<blockquote class="blockquote">
    One afternoon, he gathered convention-goers for a demonstration. He climbed onto the platform and directed an assistant to hoist the elevator to its top height, about three stories off the ground. Then, as he stood and gazed down at the crowd, Otis took an ax and slashed the rope that was suspending the elevator in midair.
    <br>
    <br>
    The audience gasped. The platform fell. But in seconds, the safety brake engaged and halted the elevator's descent. Still alive and standing, Otis looked out at the shaken crowd and said, "All safe, gentlemen. All safe."
</blockquote>
<p><br></p>
<h2 id="10-Langauge-Hacking">10. Langauge Hacking</h2>
<p>Daniel shares a link to <a href="http://www.danpink.com/pitch">Get ready for your pitch</a> and also talks about <strong>1-word pitch</strong>. What's that?</p>
<ul>
<li>Google - &quot;search&quot;</li>
<li>Facebook - &quot;social networks&quot;</li>
<li>Rector - &quot;instant upgrades&quot;</li>
<li>Your-project - ?</li>
</ul>
<p>People need to associate yours with <strong>the 1 word</strong>. Pick it and take it!</p>
<p><br></p>
<h2 id="11-Should-I-be-the-First-or-the-Last-to-Pitch-or-Speak">11. Should I be the First or the Last to Pitch or Speak?</h2>
<blockquote class="blockquote">
    "Go first if you're the incumbent, last if you're the challenger. In competitive sales presentations, where a series of sellers make their pitches one after another, the market leader is most likely to get selected if it presents first, according to Virginia Tech University researchers. But for a challenger, the best spot, by far, is to present last."
</blockquote>
<p>How widely this applies to other settings isn't clear from the research, but in general, <strong>the middle is the place you're most overseen</strong>.</p>
<p><br></p>
<h2 id="12-329-over-80">12. 329 over 80 %</h2>
<blockquote class="blockquote">
    Granular numbers are more credible than coarse numbers. A University of Michigan study asked participants to estimate the battery life of two GPS devices. One device claimed to have a battery life of "up to 2 hours"; the other had an identical, but more finely grained claim of "up to 120 minutes." Participants estimated the first battery would last 89 minutes, but the second would last longer - 106 minutes.
</blockquote>
<p><br></p>
<h2 id="13-Rejection-is-an-Offer">13. Rejection is an Offer</h2>
<blockquote class="blockquote">
    "But he's unlikely to say only that. He's more likely to say, "Sorry, I can't give two hundred dollars." That's an offer."
</blockquote>
<p><br></p>
<h2 id="14-Improvisation-Together">14. Improvisation Together</h2>
<blockquote class="blockquote">
    Improv artists have long understood that helping your fellow performer shine helps you both create a better scene. <strong>Making your partner look good doesn't make you look worse; it actually makes you shine</strong>.
</blockquote>
<blockquote class="blockquote">
    "That's so interesting!" The maneuver gives her time to conjure a question, but it also spins the weather vane in a friendlier direction. And when she poses a question, I have to stop a moment, think, and offer an intelligent answer.
</blockquote>
<img src="/assets/images/posts/2018/selling/book.png" class="img-thumbnail">
<p><br></p>
<p>Do you want to get 53 more tips? <a href="https://www.amazon.com/Sell-Human-Surprising-Persuading-Influencing-ebook/dp/B00AO3K05S/ref=tmm_kin_swatch_0?_encoding=UTF8&amp;qid=&amp;sr=">Get free 1st chapter</a> to your Smartphone Kindle App and try it for yourself.</p>
<p><br></p>
<p>Happy reading!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/06/18/14-surprising-tip-from-selling-is-human-to-influence-others</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 18 Jun 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/06/18/14-surprising-tip-from-selling-is-human-to-influence-others#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Collector Pattern for Dummies ]]></title>
                <link>https://tomasvotruba.com/blog/2018/06/14/collector-pattern-for-dummies</link>
                <description><![CDATA[ <p>I wrote <em><a href="/blog/2018/03/08/why-is-collector-pattern-so-awesome/">Why is Collector Pattern so Awesome</a></em> a while ago, but I got feeling and feedback that it's way too complicated.
<br><br>
The pattern itself is simple, but put in framework context, it might be too confusing to understand.
<br><br>
That's why we look on collector pattern in minimalistic plain PHP way today.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Let's say you have a simple <code>PriceCalculator</code> class that calculates a price for a product with a VAT:</p>
<pre><code class="language-php">class PriceCalculator
{
    public function calculate(Product $product): float
    {
        // compute vat
        $price = $product-&gt;getPrice() * 1.15;

        return $price;
    }
}</code></pre>
<p>Then we decide to have 50 % discount for admins:</p>
<pre><code class="language-diff"> class PriceCalculator
 {
     public function calculate(Product $product): float
     {
         // compute vat
         $price = $product-&gt;getPrice() * 1.15;

+        // discount for admin
+        if ($this-&gt;currentUser-&gt;getRole() === 'admin') {
+            $price *= 0.5;
+        }
+
         return $price;
     }
 }</code></pre>
<p>And another 20 % discount for students:</p>
<pre><code class="language-diff"> class PriceCalculator
 {
     public function calculate(Product $product): float
     {
         // compute vat
         $price = $product-&gt;getPrice() * 1.15;

         // discount for admin
         if ($this-&gt;currentUser-&gt;getRole() === 'admin') {
             $price *= 0.5;
         }

+        // discount for students
+        if ($this-&gt;currentUser-&gt;getOccupation() === 'student') {
+            $price *= 0.8;
+        }
+
         return $price;
     }
 }</code></pre>
<p>Our <code>PriceCalculator</code> grows and grows, our e-commerce platform expands all over Europe and we found out they have a different strategy to calculate price with VAT. How do we solve it?</p>
<p>&quot;Override the whole class and implements <code>calculate()</code> method for yourself.&quot;</p>
<pre><code class="language-php"> class UnitedKingdomPriceCalculator extends PriceCalculator
 {
     public function calculate(Product $product): float
     {
         // compute vat
         $price = $product-&gt;getPrice() * 1.15;

         return $price;
     }
 }</code></pre>
<p>That's an easy solution for the end-user. But it also means zero reusable code that leads to duplicated work. Imagine there will be 20 websites in the UK and <strong>each of them will have their own code to calculate price with VAT</strong>. 100 % similar code (if written correctly), because it applies to the whole country.</p>
<h2 id="Sharing-is-Caring">Sharing is Caring</h2>
<p>Instead, such UK solution can be one of many, that is openly shared.</p>
<ul>
<li>Do you need a UK price calculator? Plug it in.</li>
<li>Do you need a configurable discount based on role? Plug it in.</li>
<li>Do you need to decrease all price by 100 € if possible? Plug it in.</li>
</ul>
<p>No need to write it more than once for all of the e-commerce sites.</p>
<h2 id="How-Does-That-Look-in-the-Code">How Does That Look in the Code?</h2>
<h3 id="1-Turn-Your-Main-Class-to-A-Collector">1. Turn Your Main Class to A Collector</h3>
<pre><code class="language-php">class PriceCalculatorCollector
{
    /**
     * @var PriceCalculatorInterface[]
     */
    private $priceCalculators = [];

    /**
     * @param PriceCalculatorInterface[] $priceCalculators
     */
    public function __construct(array $priceCalculators)
    {
        $this-&gt;priceCalculators = $priceCalculators;
    }

    public function calculate(Product $product): float
    {
        $price = $product-&gt;getPrice();

        foreach ($this-&gt;priceCalculators as $priceCalculator) {
            $price = $priceCalculator-&gt;calculate($price);
        }

        return $price;
    }
}</code></pre>
<p>with interface decoupling:</p>
<pre><code class="language-php">interface PriceCalculatorInterface
{
    public function calculate(float $price): float;
}</code></pre>
<h3 id="2-Converts-Each-Case-to-Collected">2. Converts Each Case to Collected</h3>
<pre><code class="language-php">final class CzechVatPriceCalculator implements PriceCalculatorInterface
{
    public function calculate(float $price): float
    {
        return $price * 1.21;
    }
}</code></pre>
<pre><code class="language-php">final class AdminDiscountPriceCalculator implements PriceCalculatorInterface
{
    public function calculate(float $price): float
    {
        if (! $this-&gt;currentUser-&gt;getRole() === 'admin') {
            return $price;
        }

        return $price *= 0.5;
    }
}</code></pre>
<pre><code class="language-php">final class UnitedKingdomPriceCalculator implements PriceCalculatorInterface
{
   public function calculate(float $price): float
   {
       return $price * 1.15;
   }
}</code></pre>
<h3 id="3-Let-Collector-Collect-What-You-Need">3. Let Collector Collect What You Need</h3>
<p>Based on your needs, collect this or that service.</p>
<pre><code class="language-php">$priceCalculatorCollector = new PriceCalculatorCollector([
    new AdminDiscountPriceCalculator(),
    new UnitedKingdomPriceCalculator(),
]);

$price = $priceCalculatorCollector-&gt;calculatePrice($product);</code></pre>
<p>✅ single entry point for <code>Collector</code></p>
<p>✅ each solution that implements <code>PriceCalculatorInterface</code> <strong>is reusable</strong></p>
<p>✅ <strong>to extend</strong> <code>PriceCalculatorCollector</code> with another feature, e.g. have a discount for Lenovo laptops from now till the end of June 2018, <strong>we don't have to modify</strong> it - just register a new <code>PriceCalculator</code></p>
<p>✅ <strong>to reflect 1 change in reality</strong>, e.g. from 15 % to 20 % VAT, all we need to do it <strong>change 1 class for everyone</strong></p>
<p><br></p>
<p><strong>Win for the end-user, win for your project and win for the code.</strong></p>
<p><br></p>
<p><em>And that's all there is.</em> Just kidding, there is much more, but that's out of the scope of this simple tutorial.
Why the collector class doesn't implement the interface and other questions will be answered in following posts.</p>
<p><br><br></p>
<p>Happy collecting!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/06/14/collector-pattern-for-dummies</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 14 Jun 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/06/14/collector-pattern-for-dummies#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Turn Mocks from Nightmare to Solid Kiss Tests ]]></title>
                <link>https://tomasvotruba.com/blog/2018/06/11/how-to-turn-mocks-from-nightmare-to-solid-kiss-tests</link>
                <description><![CDATA[ <p><a href="http://mhlavac.net">Martin Hlaváč</a> had a very nice talk about testing in <a href="http://www.bephpug.de/2018/06/05/june.html">Berlin PHP Meetup</a> last week (while I hosted with <a href="https://github.com/rectorphp/rector">Rector</a>), and one of the topic was mocking.
<br><br>
I often see developers fighting with this, in places they don't have to, just because this topic is so widespread all over the internet and unit tools.
<br><br>
Did you know there is easier and more clear way to do &quot;mocking&quot;?</p> ]]></description>
                <content:encoded><![CDATA[ <p>At the time being, there is only 1 post about <a href="https://mnapoli.fr/anonymous-classes-in-tests/">anonymous classes in tests</a> (thanks to Matthieu!). Compared to that, there are many PHP tool made just for mocking: Prophecy, Mockery, PHPUnit native mocks, Mockista and so on. If you're a developer who uses one of them, knows that he needs to add proper annotations to make autocomplete work, has the PHPStom plugin that fixes bugs in this autocomplete and it works well for you, just stop reading.</p>
<p>This post is for developers who struggle with mocking and have a feeling, that they're doing something wrong.</p>
<p><strong>You're not. It's the mocking part</strong>. Mocks are often the bottleneck of understanding in tests. They're so easy to make, that they can overpopulate your tests... the same way units test can test every getter and setter of all your entities in 20 minutes <em>(hint: not a way to go)</em>.</p>
<h2 id="Was-it-willReturn-willReturnAny-or-willReturnExact">Was it <code>willReturn()</code>, <code>willReturnAny()</code> or <code>willReturnExact()</code>?</h2>
<p>Let's get to code. <a href="https://github.com/shopsys/shopsys/commit/b73fc8da82f7d2679f05c8aedd29f010fd5d0630#diff-f1a8f90cb34e69e324153cce909467a2R92">Real open source code</a> from one of my code-reviews that inspired me to make this post:</p>
<pre><code class="language-php">namespace PHPUnit\Framework\TestCase;

final class SomeTest extends TestCase
{
    public function test()
    {
        $heurekaCategoryFacade = $this-&gt;createHeurekaCategoryFacadeMock();

        // ...
    }

    /**
     * @return \PHPUnit\Framework\MockObject\MockObject|\Shopsys\ProductFeed\HeurekaBundle\Model\HeurekaCategory\HeurekaCategoryFacade
     */
    private function createHeurekaCategoryFacadeMock()
    {
        $returnCallback = function ($categoryId) {
            if ($categoryId === self::CATEGORY_ID_FIRST) {
                return $this-&gt;heurekaCategory;
            }
            return null;
        };

        /** @var HeurekaCategoryFacade|\PHPUnit\Framework\MockObject\MockObject $heurekaCategoryFacadeMock */
        $heurekaCategoryFacadeMock = $this-&gt;createMock(HeurekaCategoryFacade::class);

        $heurekaCategoryFacadeMock
            -&gt;method('findByCategoryId')
            -&gt;willReturnCallback($returnCallback);

        return $heurekaCategoryFacadeMock;
    }
}</code></pre>
<p>The code is intentionally more complex, so we have real-life example, instead of made-up code with <code>Car</code> class and <code>open()</code> method that no-one can relate to.</p>
<p><strong>Now answer me in 5 seconds:</strong></p>
<ul>
<li>What does mock do?</li>
<li>How would you extends it to work with number 7?</li>
</ul>
<p>Now try to implement your idea. If you made it under another 60 seconds and your tests pass, you master mocking well and there is nothing for you to learn from this post.</p>
<h3 id="Documentation-Google-and-Stackoverflow-Juggling">Documentation, Google and Stackoverflow Juggling</h3>
<p>What happened to use in reality? <strong>We got stuck for at least 30 minutes on modification of methods like that</strong>. Studying PHPUnit manual and looking to StackOverflow with my favorite <a href="https://stackoverflow.com/questions/5988616/phpunit-mock-method-multiple-calls-with-different-arguments">PHPUnit mock method multiple calls with different arguments</a>.</p>
<p>That's not what tool should do for you. <strong>Tools should work for you, not you for them.</strong></p>
<h2 id="Pure-PHP-Code">Pure PHP Code</h2>
<p>Let me show an alternative approach that has the same result.</p>
<p>~ 95 % developers can read this code, even if they see PHPUnit for the first time:</p>
<pre><code class="language-php">namespace PHPUnit\Framework\TestCase;

final class SomeTest extends TestCase
{
    public function test()
    {
        $heurekaCategoryFacade = $this-&gt;createHeurekaCategoryFacade();

        // ...
    }

    private function createHeurekaCategoryFacadeMock()
    {
        // anonymous class mock
        return new class extends HeurekaCategoryFacade
        {
            public function findByCategoryId($categoryId)
            {
                if ($categoryId === self::CATEGORY_ID_FIRST) {
                    return $this-&gt;heurekaCategory;
                }

                return null;
            }
        };
    }
}</code></pre>
<p>We don't need no PHPStorm plugin, memorized methods from mock framework nor duplicated|annotations.</p>
<p>I believe now we all made it under 5 seconds with both answers:</p>
<pre><code class="language-diff"> namespace PHPUnit\Framework\TestCase;

 final class SomeTest extends TestCase
 {
     public function test()
     {
         $heurekaCategoryFacade = $this-&gt;createHeurekaCategoryFacade();

         // ...
     }

     private function createHeurekaCategoryFacade()
     {
         // anonymous class mock
         return new class extends HeurekaCategoryFacade
         {
             public function findByCategoryId($categoryId)
             {
-                if ($categoryId === self::CATEGORY_ID_FIRST) {
+                if ($categoryId === self::CATEGORY_ID_FIRST || $categoryId === 7) {
                     return $this-&gt;heurekaCategory;
                 }

                 return null;
             }
         };
     }
 }</code></pre>
<h2 id="Your-Code-Guides-You-Just-Be-Open-to-Listening">Your Code Guides You, Just Be Open to Listening</h2>
<p>The code already tells us what to do next.</p>
<p>Some people mock because they follow good practice and <strong><a href="https://ocramius.github.io/blog/when-to-declare-classes-final">make every class abstract or final</a></strong>. They don't want to deal with constructors, that would often lead to more mocking. It's great practice and super easy to put make classes final with Rector CI:</p>
<pre><code class="language-bash">composer require rector/rector --dev</code></pre>
<pre><code class="language-php">use Rector\SOLID\Rector\Class_\FinalizeClassesWithoutChildrenRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;rule(FinalizeClassesWithoutChildrenRector::class);
};</code></pre>
<p>Yes, it's that simple, you just saved your project from most of its legacy code. But <code>final</code> classes should <strong>not be the reason to choose to mocks</strong>. Well, you can also <a href="https://phpfashion.com/how-to-mock-final-classes">hack the <code>final</code> and use mocking right away</a>, or you can go with the code flow. Dance with it!</p>
<h2 id="SOLID-Code-as-a-Side-Effect">SOLID Code as a Side Effect</h2>
<p>You don't need to go on a mocking spree. The <em>constructor issue</em> naturally lead us to <strong>abstract an interface</strong> refactoring.</p>
<p>We create a new interface:</p>
<pre><code class="language-php">interface CategoryFacadeInterface
{
    public function findByCategoryId($categoryId);
}</code></pre>
<p>And use it in anonymous class:</p>
<pre><code class="language-diff"> private function createHeurekaCategoryFacade()
 {
     // anonymous class mock
-    return new class extends HeurekaCategoryFacade
+    return new class implements CategoryFacadeInterface
     {
         public function findByCategoryId($categoryId)
         {
            // ...
         }
     };
 }</code></pre>
<p>And now you respect SOLID principles - your code is:</p>
<ul>
<li>extendable (<em>O</em>pen-closed principle - open to extension, closed to modification)</li>
<li>and replaceable (<em>D</em>ependency inversion principle).</li>
</ul>
<p>Also, your application can now use abstraction (= interface) instead of specific implementation (= class). That leads to autowiring benefits, decoupling from monolith and better service replace-ability.</p>
<h2 id="1000x-Code">1000x Code</h2>
<p>They say <strong>your code is 10x more read than written</strong> on average. I believe it's at least 1000x in open-source. Knowing that we want our code, not to be just clear and readable, but to be</p>
<ul>
<li>super-readable,</li>
<li>deterministic = with only one clear way one can understand it,</li>
<li>with <a href="/blog/2018/05/21/is-your-code-readable-by-humans-cognitive-complexity-tells-you/">cognitive complexity</a> &lt; 8,</li>
<li>easy to fix,</li>
<li>easy to extend,</li>
<li>easy to test.</li>
</ul>
<p><br></p>
<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/ab/William_of_Ockham_-_Logica_1341.jpg/220px-William_of_Ockham_-_Logica_1341.jpg">
<p>Let's close this with <a href="https://en.wikipedia.org/wiki/Occam%27s_razor">Occam's razor</a>:</p>
<blockquote class="blockquote text-center mt-5 mb-5">
    One should select the answer that makes the fewest assumptions
</blockquote>
<p>Pick a solution that is understandable to the most people. No tool, posts or studying tutorials or reading books is needed. <strong>People will thank you and your code will attract more people because they'll feel confident to manage the code</strong>. Then naturally, your code will get more contributions from happy developers. Win win :)</p>
<p><br><br></p>
<p>Happy anonymocking!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/06/11/how-to-turn-mocks-from-nightmare-to-solid-kiss-tests</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 11 Jun 2018 00:00:00 +0000</pubDate>
                                    <updated>2020-08-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Aug 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Aug 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/06/11/how-to-turn-mocks-from-nightmare-to-solid-kiss-tests#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Migrate From PHP CS Fixer to ECS in 6 Steps ]]></title>
                <link>https://tomasvotruba.com/blog/2018/06/07/how-to-migrate-from-php-cs-fixer-to-easy-coding-standard</link>
                <description><![CDATA[ <p>We looked at how to migrate from PHP_CodeSniffer to Easy Coding Standard on Monday. But what if your weapon of choice is PHP CS Fixer and you'd to run also some sniffs?
<br>
There are <strong>a few simple A → B changes</strong>, but one has to know about them or will get stuck. Let's learn about them.</p> ]]></description>
                <content:encoded><![CDATA[ <p>ECS is a tool build on Symfony components that <a href="/blog/2017/05/03/combine-power-of-php-code-sniffer-and-php-cs-fixer-in-3-lines/">combines PHP_CodeSniffer and PHP CS Fixer</a>. It's easy to use from scratch:</p>
<pre><code class="language-bash">composer require symplify/easy-coding-standard --dev</code></pre>
<p>ECS uses standard Symfony PHP config:</p>
<pre><code class="language-php">// ecs.php
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\EasyCodingStandard\ValueObject\Set\SetList;

return function (ContainerConfigurator $containerConfigurator): void {
    $containerConfigurator-&gt;import(SetList::PSR_12);
};</code></pre>
<p>And runs as CLI command:</p>
<pre><code class="language-bash">vendor/bin/ecs check src</code></pre>
<p>But what if you already have PHP CS Fixer on your project and want to switch?</p>
<h2 id="1-From-String-Codes-to-Autocompleted-Classes">1. From String Codes to Autocompleted Classes</h2>
<p>You use string references like <code>strict_types</code> in your <code>.php_cs</code> file. You need to remember them, <a href="https://github.com/friendsofphp/php-cs-fixer">copy paste them from README</a> and <strong>copy-paste them right</strong>.</p>
<pre><code class="language-php">return PhpCsFixer\Config::create()
    -&gt;setRules([
        'strict_types' =&gt; true,
    ])
    -&gt;setFinder($finder);</code></pre>
<p>That can actually cause typos like:</p>
<pre><code class="language-diff"> return PhpCsFixer\Config::create()
     -&gt;setRules([
-        'strict_types' =&gt; true,
+        'declare_strict_types' =&gt; true,
     ])
     -&gt;setFinder($finder);</code></pre>
<p>How to do that in ECS? Copy paste the fixer name, capitalize first letter and remove <code>_</code>:</p>
<p>Then hit the &quot;ctrl&quot; + &quot;space&quot; for class autocomplete in PHPStorm (it works even now when I write this post in markdown, nice!).</p>
<pre><code class="language-php">// ecs.php
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use PhpCsFixer\Fixer\Strict\DeclareStrictTypesFixer;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();
    $services-&gt;set(DeclareStrictTypesFixer::class);
};</code></pre>
<p>No more typos with <em>strong</em> over <em>string typing</em>.</p>
<h2 id="2-From-notPath-to-skip-Parameter">2. From <code>notPath()</code> to <code>skip</code> Parameter</h2>
<p>If you'd like to skip nasty code from being analyzed, you'd probably use this in PHP CS Fixer.</p>
<pre><code class="language-php">$finder = PhpCsFixer\Finder::create()
    -&gt;exclude('somedir')
    -&gt;notPath('my-nasty-dirty-file.php')
    -&gt;in(__DIR__);</code></pre>
<p>Do you need <code>DeclareStrictTypesFixer</code> to skip this file? Sorry, PHP CS Fixer will skip it for ever rule.</p>
<p>ECS solves this common case - to skip a file, just use <code>skip</code> parameter:</p>
<pre><code class="language-php">// ecs.php
use PhpCsFixer\Fixer\Strict\DeclareStrictTypesFixer;
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\EasyCodingStandard\ValueObject\Option;

return function (ContainerConfigurator $containerConfigurator): void {
    $parameters = $containerConfigurator-&gt;parameters();

    $parameters-&gt;set(Option::SKIP, [
        DeclareStrictTypesFixer::class =&gt; [
            __DIR__ . '/my-nasty-dirty-file.php',
            // you can add more files
            __DIR__ . '/Legacy/too-legacy-to-look-at.php',

            // or directories
            __DIR__ . '/Legacy',

            // or mask paths with fnmatch()
            __DIR__ . '/*/Command',
        ]
    ]);
};</code></pre>
<p>Do you really want to skip <strong>1 fixer</strong> for all files?</p>
<pre><code class="language-php">// ecs.php
use PhpCsFixer\Fixer\Strict\DeclareStrictTypesFixer;
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\EasyCodingStandard\ValueObject\Option;

return function (ContainerConfigurator $containerConfigurator): void {
    $parameters = $containerConfigurator-&gt;parameters();

    $parameters-&gt;set(Option::SKIP, [
        DeclareStrictTypesFixer::class =&gt; null,
    ]);
};</code></pre>
<p>For all other <code>skip</code> options, <a href="https://github.com/symplify/easy-coding-standard/#ignore-what-you-cant-fix">see README</a>.</p>
<h2 id="3-From-php-cs-to-PHP-Config">3. From <code>.php_cs</code> to PHP Config</h2>
<p>PHP CS Fixer looks for <code>.php_cs</code> file in the root directory by default.</p>
<p><strong>And ECS looks for <code>ecs.php</code></strong></p>
<p>What about non-default locations or names?</p>
<p>From:</p>
<pre><code class="language-bash">vendor/bin/php-cs-fixer fix /path/to/project --config=custom/location.yml --dry-run</code></pre>
<p><strong>to:</strong></p>
<pre><code class="language-bash">vendor/bin/ecs check /path/to/project --config custom/location.php</code></pre>
<h2 id="4-Configuring-Fixer-Values">4. Configuring Fixer Values</h2>
<p>From PHP configuration in PHP CS Fixer:</p>
<pre><code class="language-php">return PhpCsFixer\Config::create()
    -&gt;setRules([
        'array_syntax' =&gt; ['syntax' =&gt; 'short'],
    ])
    -&gt;setFinder($finder);</code></pre>
<p><strong>to explicit Symfony service parameters in EasyCodingStandard:</strong></p>
<pre><code class="language-php">use PhpCsFixer\Fixer\ArrayNotation\ArraySyntaxFixer;
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();

    $services-&gt;set(ArraySyntaxFixer::class)
        -&gt;call('configure', [[
            'syntax' =&gt; 'short'
        ]]);
};</code></pre>
<p>Nice and clear!</p>
<h2 id="5-From-no-dry-run-to-fix-option">5. From no <code>--dry-run</code> to <code>--fix</code> option</h2>
<p>From PHP CS Fixer:</p>
<pre><code class="language-bash">vendor/bin/php-cs-fixer fix /path/to/project --dry-run
vendor/bin/php-cs-fixer fix /path/to/project</code></pre>
<p>to ECS equivalent:</p>
<pre><code class="language-bash">vendor/bin/ecs check /path/to/project
vendor/bin/ecs check /path/to/project --fix</code></pre>
<h2 id="6-From-at-Rules-to-imports">6. From <code>@Rules</code> to <code>imports</code></h2>
<p>Do you like to use standards like PSR-2 or even <a href="/blog/2018/04/09/try-psr-12-on-your-code-today/">PSR-12</a>?</p>
<p>From <code>@strings</code> in PHP CS Fixer:</p>
<pre><code class="language-php">$config = PhpCsFixer\Config::create()
    -&gt;setRules([
        '@PSR2' =&gt; true,
    ]);</code></pre>
<p><strong>to autocompleted set constant in PHP file in ECS</strong>:</p>
<pre><code class="language-php">// ecs.php
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\EasyCodingStandard\ValueObject\Set\SetList;

return function (ContainerConfigurator $containerConfigurator): void {
    $containerConfigurator-&gt;import(SetList::PSR_12);
};</code></pre>
<p><br></p>
<h2 id="Give-it-a-Try">Give it a Try...</h2>
<p>...and you won't regret it. Sylius, <a href="https://github.com/pestphp/drift">PestPHP</a>, LMC, Shopsys and Nette did and never came back.</p>
<p><br></p>
<p>Did I forget a step that you had to fight with? <strong>Please, let me know in the comments or just send PR to this post to add it</strong>, so we help other readers.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/06/07/how-to-migrate-from-php-cs-fixer-to-easy-coding-standard</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 07 Jun 2018 00:00:00 +0000</pubDate>
                                    <updated>2020-11-01UTC00:00:000</updated>
                    <atom:updated>Sun, 01 Nov 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sun, 01 Nov 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/06/07/how-to-migrate-from-php-cs-fixer-to-easy-coding-standard#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Migrate From PHP_CodeSniffer to ECS in 7 Steps ]]></title>
                <link>https://tomasvotruba.com/blog/2018/06/04/how-to-migrate-from-php-code-sniffer-to-easy-coding-standard</link>
                <description><![CDATA[ <p>Last year, I helped <a href="https://github.com/shopsys/coding-standards">Shopsys Coding Standards</a> and <a href="https://github.com/lmc-eu/php-coding-standard">LMC PHP Coding Standard</a> to migrate from PHP_CodeSniffer to ECS.
<br><br>
There are <strong>a few simple A → B changes</strong>, but one has to know about them or will get stuck.
<br><br>
<strong>Do you also use PHP_CodeSniffer and give it EasyCodingStandard a try</strong>? Today we look at how to migrate step by step.</p> ]]></description>
                <content:encoded><![CDATA[ <p>ECS is a tool build on Symfony components that <a href="/blog/2017/05/03/combine-power-of-php-code-sniffer-and-php-cs-fixer-in-3-lines/">combines PHP_CodeSniffer and PHP CS Fixer</a>. It's easy to use from scratch:</p>
<pre><code class="language-bash">composer require symplify/easy-coding-standard --dev</code></pre>
<p>ECS uses standard Symfony PHP config:</p>
<pre><code class="language-php">// ecs.php
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\EasyCodingStandard\ValueObject\Option;
use Symplify\EasyCodingStandard\ValueObject\Set\SetList;

return function (ContainerConfigurator $containerConfigurator): void {
    $containerConfigurator-&gt;import(SetList::PSR_12);
};</code></pre>
<p>And runs as CLI command:</p>
<pre><code class="language-bash">vendor/bin/ecs check src</code></pre>
<p>But what if you already have PHP_CodeSniffer on your project and want to switch?</p>
<h2 id="1-From-String-Codes-to-Autocompleted-Classes">1. From String Codes to Autocompleted Classes</h2>
<p>You probably use string references to sniffs in your <code>*.xml</code> configuration for PHP_CodeSniffer. You need to remember them, copy paste them and <strong>copy-paste them right</strong>.</p>
<pre><code class="language-xml">&lt;!-- phpcs.xml --&gt;
&lt;rule ref="Generic.Comenting.DocComment"/&gt;</code></pre>
<p>That can actually cause typos like:</p>
<pre><code class="language-diff">-&lt;rule ref="Generic.Comenting.DocComment"/&gt;
+&lt;rule ref="Generic.Commenting.DocComment"/&gt;</code></pre>
<p>How to do that in EasyCodingStandard? Copy paste the last name <code>DocComment</code> and add rule in <code>set()</code> method. Hit CTRL + Space and  PHPStorm will autocomplete class for you:</p>
<pre><code class="language-php">// ecs.php
use PHP_CodeSniffer\Standards\Generic\Sniffs\Commenting\DocCommentSniff;
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();
    $services-&gt;set(DocCommentSniff::class);
};</code></pre>
<p>No more typos with strong over string typing.</p>
<h2 id="2-From-at-codingStandardsIgnoreStart-to-skip-Parameter">2. From <code>@codingStandardsIgnoreStart</code> to <code>skip</code> Parameter</h2>
<p>If you'd like to skip nasty code from being analyzed, you'd use <code>@codingStandardsIgnoreStart</code> in PHP_CodeSniffer.</p>
<pre><code class="language-php">#  packages/framework/src/Component/Constraints/EmailValidator.php

private function isEmail($value)
{
    // @codingStandardsIgnoreStart
    $atom = "[-a-z0-9!#$%&amp;'*+/=?^_`{|}~]"; // RFC 5322 unquoted characters in local-part
    // @codingStandardsIgnoreEnd
}</code></pre>
<p>One big cons of this is <strong>that all sniffs will skip this code</strong>, not just one. So even if here we need to only allow double quotes <code>"</code>, all other checks will miss it.</p>
<p>To skip this in EasyCodingStandard just use <code>skip</code> parameter:</p>
<pre><code class="language-php">// ecs.php
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\EasyCodingStandard\ValueObject\Option;
use PHP_CodeSniffer\Standards\Squiz\Sniffs\Strings\DoubleQuoteUsageSniff;

return function (ContainerConfigurator $containerConfigurator): void {
    $parameters = $containerConfigurator-&gt;parameters();
    $parameters-&gt;set(Option::SKIP, [
        DoubleQuoteUsageSniff::class =&gt; [
            __DIR__ . '/packages/framework/src/Component/Constraints/EmailValidator.php',

            // or whole directory
            __DIR__ . '/packages/framework/src/Component',

            // or for mask directory
            __DIR__ . '/packages/*/src/Component',
        ]
    ]);
};</code></pre>
<h2 id="3-From-and-lt-severity-and-gt-0-and-lt-severity-and-gt-and-and-lt-exclude-name-and-gt-to-skip-Parameter">3. From <code>&lt;severity&gt;0&lt;/severity&gt;</code> and <code>&lt;exclude name="..."&gt;</code> to <code>skip</code> Parameter</h2>
<p>Do you need to skip only 1 part of the sniff? In PHP_CodeSniffer:</p>
<pre><code class="language-xml">&lt;rule ref="Generic.Commenting.DocComment.ContentAfterOpen"&gt;
    &lt;severity&gt;0&lt;/severity&gt;
&lt;/rule&gt;</code></pre>
<p>or</p>
<pre><code class="language-xml">&lt;rule ref="Generic.Commenting.DocComment"&gt;
    &lt;exclude name="Generic.Commenting.DocComment.ContentAfterOpen"/&gt;
&lt;/rule&gt;</code></pre>
<p>In EasyCodingStandard, we put that again under <code>skip</code> parameter in format <code>&lt;Sniff&gt;.&lt;CodeName&gt;</code>:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\EasyCodingStandard\ValueObject\Option;
use PHP_CodeSniffer\Standards\Generic\Sniffs\Commenting\DocCommentSniff;

return function (ContainerConfigurator $containerConfigurator): void {
    $parameters = $containerConfigurator-&gt;parameters();
    $parameters-&gt;set(Option::SKIP, [
        DocCommentSniff::class . '.ContentAfterOpen' =&gt; null,
    ]);
};</code></pre>
<p>For all other <code>skip</code> options, <a href="https://github.com/symplify/easy-coding-standard/#ignore-what-you-cant-fix">see README</a>.</p>
<p><br></p>
<p>In case you need to <strong>skip the whole sniff</strong>:</p>
<pre><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;ruleset name="ruleset"&gt;
    &lt;rule ref="Generic.Commenting.DocComment"&gt;
        &lt;severity&gt;0&lt;/severity&gt;
    &lt;/rule&gt;
&lt;/ruleset&gt;</code></pre>
<p>or</p>
<pre><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;ruleset name="ruleset"&gt;
    &lt;rule ref="ruleset.xml"&gt;
        &lt;exclude name="Generic.Commenting.DocComment"/&gt;
    &lt;/rule&gt;
&lt;/ruleset&gt;</code></pre>
<p><strong>Put it under <code>skip</code> parameter:</strong></p>
<pre><code class="language-php">use PHP_CodeSniffer\Standards\Generic\Sniffs\Commenting\DocCommentSniff;
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\EasyCodingStandard\ValueObject\Option;

return function (ContainerConfigurator $containerConfigurator): void {
    $parameters = $containerConfigurator-&gt;parameters();

    $parameters-&gt;set(Option::SKIP, [
        DocCommentSniff::class =&gt; null,
    ]);
};</code></pre>
<h2 id="4-From-XML-to-PHP-Config-Paths">4. From XML to PHP Config Paths</h2>
<p>These names are looked for in the root directory by PHP_CodeSniffer:</p>
<pre><code class="language-bash">- .phpcs.xml
- phpcs.xml
- .phpcs.xml.dist
- phpcs.xml.dist</code></pre>
<p><strong>And by ECS just plain <code>ecs.php</code> PHP file</strong></p>
<p>What about non-default locations or names?</p>
<p>From:</p>
<pre><code class="language-bash">vendor/bin/phpcs /path/to/project --standard=custom/location.xml</code></pre>
<p><strong>to:</strong></p>
<pre><code class="language-bash">vendor/bin/ecs check /path/to/project --config custom/location.php</code></pre>
<h2 id="5-Configuring-Sniff-Values">5. Configuring Sniff Values</h2>
<p>From XML configuration in PHP_CodeSniffer:</p>
<pre><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;ruleset name="ruleset"&gt;
    &lt;rule ref="Generic.Metrics.CyclomaticComplexity"&gt;
        &lt;properties&gt;
            &lt;property name="complexity" value="13"/&gt;
            &lt;property name="absoluteComplexity" value="13"/&gt;
        &lt;/properties&gt;
    &lt;/rule&gt;
&lt;/ruleset&gt;</code></pre>
<p><strong>to PHP parameters in ECS:</strong></p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

// ecs.php

use PHP_CodeSniffer\Standards\Generic\Sniffs\Metrics\CyclomaticComplexitySniff;
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();

    $services-&gt;set(CyclomaticComplexitySniff::class)
        -&gt;property('complexity', 13)
        -&gt;property('absoluteComplexity', 13);
};</code></pre>
<h2 id="6-From-Severity-and-Warning-to-Just-Errors">6. From Severity and Warning to Just Errors</h2>
<p>There are different levels in PHP_CodeSniffer. You can set severity, make sniff report as warning or as an error.</p>
<pre><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;ruleset name="ruleset"&gt;
    &lt;rule ref="Generic.Commenting.DocComment"&gt;
        &lt;severity&gt;5&lt;/severity&gt;
    &lt;/rule&gt;
&lt;/ruleset&gt;</code></pre>
<p>This complex matrix leveling lead to confused questions for many people:</p>
<ul>
<li>Is it a warning or is an accepted error?</li>
<li>What is this warning even active when it doesn't fail CI?</li>
<li>Why do we have an accepted error - is it like the tests that are allowed to fail?</li>
</ul>
<p>And so on.</p>
<p>Thus these confusing options are not supported and EasyCodingStandard simplifies that to <strong>errors only</strong>
CI server either passes or not. <strong>The rule is required and respected or removed. Simple, clear and without any confusion.</strong></p>
<p>Saying that you don't need to fill values for warning properties.</p>
<h2 id="7-From-Beautifier-to-fix-option">7. From Beautifier to <code>--fix</code> option</h2>
<p>Do you need to fix the code? From 2 commands in PHP_CodeSniffer:</p>
<pre><code class="language-bash">vendor/bin/phpcs /path/to/project --standard=custom/location.xml
vendor/bin/phpcbf /path/to/project --standard=custom/location.xml</code></pre>
<p>to 1 in EasyCodingStandard:</p>
<pre><code class="language-bash">vendor/bin/ecs check /path/to/project --config custom/location.php
vendor/bin/ecs check /path/to/project --config custom/location.php --fix</code></pre>
<p><br></p>
<h2 id="Give-it-a-Try">Give it a Try...</h2>
<p>...and you won't regret it. Sylius, <a href="https://github.com/pestphp/drift">PestPHP</a>, LMC, Shopsys, Nette did and never came back.</p>
<p><br></p>
<p>Did I forget a step that you had to fight with? <strong>Please, let me know in the comments or just send PR to this post to add it</strong>, so we help other readers.</p>
<p><br>
<br></p>
<p>In the next post we look on <a href="/blog/2018/06/07/how-to-migrate-from-php-cs-fixer-to-easy-coding-standard/">how to migrate from PHP CS Fixer</a>!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/06/04/how-to-migrate-from-php-code-sniffer-to-easy-coding-standard</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 04 Jun 2018 00:00:00 +0000</pubDate>
                                    <updated>2020-11-01UTC00:00:000</updated>
                    <atom:updated>Sun, 01 Nov 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sun, 01 Nov 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/06/04/how-to-migrate-from-php-code-sniffer-to-easy-coding-standard#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Symfony vs Laravel vs Nette - Which PHP Framework Should You Choose ]]></title>
                <link>https://tomasvotruba.com/blog/2018/05/31/symfony-vs-laravel-vs-nette-which-php-framework-you-should-choose</link>
                <description><![CDATA[ <p>I have been asked this question over hundred times, in person, as <a href="https://github.com/TomasVotruba/tomasvotruba.com/issues/278">a post request</a>. When to use Symfony? How is Laravel better than Symfony? What are Nette killer features compared to Symfony and Laravel?
<br><br>
Today, we look on the answer.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="So-Which-PHP-Framework-is-the-Silver-Bullet">So Which PHP Framework is the Silver Bullet?</h2>
<p>According to Wikipedia &quot;the only weapon that is effective against a werewolf, witch, or other monsters&quot;. But also &quot;a direct and effortless solution to a problem.&quot; Spoiler alert: <strong>Silver bullet does not exist.</strong></p>
<p>What does that mean in the software world? Let's say you use framework A. You have many problems - bad documentation, missing package in the core for command bus etc. - with it and you've heard that all of them solves framework B. So you migrate to framework B. Many problems solved. You use it for 2 years and  new problems appear and you've just heard that all of them solves framework C...</p>
<blockquote class="blockquote text-center mt-lg-5 mb-lg-5">
    There are no solutions. There are only trade-offs.
</blockquote>
<h3 id="Sex-for-One-Night-vs-Love-for-The-Lifetime">Sex for One Night vs. Love for The Lifetime</h3>
<p>And that does not apply only framework, I've seen very good programmer moving from PHP to PHP Framework, from PHP to Python, from Python to Javascript... It's a way but has some trade-offs.</p>
<p><strong>If you have a new partner every 2 years, how well do you think you'll get to know them?</strong> Same goes for frameworks (or any field, really).</p>
<h2 id="The-Best-PHP-Framework-based-on-My-Experience">The Best PHP Framework based on My Experience</h2>
<p>So which PHP framework would I recommend to you in 2018? You know from my posts and from founding PHP group &quot;Symfonists&quot; in the Czech Republic in 2016, that <strong>I'm all over the Symfony</strong>. Even though there are <a href="/blog/2017/02/12/drop-all-service-tags-in-your-nette-and-symfony-applications/#get-rid-of-tagging-in-symfony">many</a> <a href="https://github.com/symfony/symfony/pull/26686">things</a> I <a href="/blog/2018/04/23/how-to-slowly-turn-your-symfony-project-to-legacy-with-action-injection/">disagree</a> with.</p>
<p>Luckily, I'm aware of this <em>confirmation bias</em>, so when somebody asks me the question in the title, <strong>I think the right answer is</strong>:</p>
<blockquote class="blockquote text-center mt-lg-5 mb-lg-5">
    Use what you love. There is no better way to do things.
</blockquote>
<p>Yes, <strong>it can be that simple</strong>. I could give you technical arguments like:</p>
<ul>
<li>drop 3 lines of framework A code and show that in framework B it takes 20 to do the same,</li>
<li>show that framework A can process 35 % more requests than framework B,</li>
<li>show <a href="https://medium.com/@taylorotwell/measuring-code-complexity-64356da605f9">a metric that is 4 times bigger</a> in framework B than in framework A,</li>
<li>argue that this framework has 10 times more plugins, that one has autowiring and that one has not.</li>
</ul>
<p>But that's not really the point - it's not a contest, it's fun. Programming needs to be fun, because:</p>
<blockquote class="blockquote text-center mt-lg-5 mb-lg-5">
    If you're not doing a job you want to do for the rest of your life... why are you doing it?
</blockquote>
<h3 id="But-Where-to-Start">But Where to Start?</h3>
<p>Ok, let's say you're looking for your first framework to fall in love with. What is the best place to start?</p>
<p><br></p>
<h2 id="The-one-Thing-I-love-about-Nette">The one Thing I love about Nette</h2>
<img src="https://files.nette.org/git/www/nette-logo-blue.png" width="300">
<p>I really fell in love with Nette mainly because of monthly meetups called <a href="https://www.posobota.cz">Posobota</a>. In English: last Saturday shortened to &quot;LaSaturday&quot;. Maintained for last ~5 years by <a href="https://honzacerny.com">Honza Černý</a> who's keeping an awesome job of running them.</p>
<p>It's a meetup with 50 developers, a <strong>regular</strong> meetup. Regular meetups is the best place <strong>to build deep meaningful relationships</strong>, where you can <strong>learn a massive amount of knowledge</strong> over the years and <strong>to share ideas and get feedback on them</strong>.</p>
<p>This could never happen on conferences, no matter how big.</p>
<p><br></p>
<h2 id="The-one-Thing-I-love-about-Laravel">The one Thing I love about Laravel</h2>
<img src="https://www.loadsys.com/wp-content/uploads/laravel_loadsys.png" width="300">
<p>There is <strong>a place where can you learn almost everything about Laravel</strong>. It's called <strong><a href="https://laracasts.com">Laracasts</a></strong>, it's entertaining, it's short (mostly 3-5 mins long videos) and to the point. A very rare combination in software educational sources.</p>
<p>I got into it with free series <a href="https://laracasts.com/series/how-to-be-awesome-in-phpstorm">Be Awesome in PHPStorm</a> series, where <a href="https://github.com/JeffreyWay">Jeffrey Way</a> gave me the best basic about PHPStorm I could dream of. To this day I still use 70 % knowledge I learned there.</p>
<p><br></p>
<h2 id="The-one-Thing-I-love-about-Symfony">The one Thing I love about Symfony</h2>
<img src="https://www.rostemespolecne.cz/copohwegoiwhe/uploads/2017/01/symfony_black_02.png" width=300>
<p>What I love the most about Symfony? It has people, education, sharing, the newest information, dopamine-driven reward system... guess!</p>
<p><br></p>
<p><strong>It's a <a href="https://stackoverflow.com/questions/tagged/symfony">StackoverFlow support for Symfony</a>.</strong> I learned a lot of basic know-how there and almost all of the edge-cases. The answers are experienced and right to the point. I just love it. And when I find an outdated answer, I can improve it. That way it's clear, what was the best-proven practice in Symfony 2, in Symfony 3 and is now in Symfony 4 in one page - one example for all <a href="https://stackoverflow.com/questions/13901256/how-do-i-read-from-parameters-yml-in-a-controller-in-symfony2">How to get Parameter in Controller</a>. Its like <a href="https://github.com/rectorphp/rector">Rector</a> just to humans.</p>
<h2 id="It-s-all-About-You-Community">It's all About You - Community</h2>
<img src="/assets/images/posts/2018/frameworks/community.jpg">
<p>It might be weird to see that software is all about people. It's about people, emotions, relationships, what people create from their love - a post, a package, a book, a video series, a local meetup, a beer meetup, a shirt with a logo, a hat with a log, stickers, open-source package, conference, a talk...</p>
<p><strong>There would be no frameworks without you - people talking about it on meetups, online forums, people who write about it with passion in comments on Reddit.</strong></p>
<p>So just go out there on a meetup, grab a beer. No pressure, you can stay there just for 30 minutes and then go home - but try to <strong>feel the mood and see how people work in that group</strong>. See how that fits you. That way you'll know you have found the best framework for you, not by some random metrics.</p>
<p>As they say:</p>
<blockquote class="blockquote text-center mt-lg-5 mb-lg-5">
    One loves vanilla ice-cream, the other pistachio.
</blockquote>
<p><br><br></p>
<p>Spread love! That's all there is :)</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/05/31/symfony-vs-laravel-vs-nette-which-php-framework-you-should-choose</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 31 May 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/05/31/symfony-vs-laravel-vs-nette-which-php-framework-you-should-choose#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Build Your First Symfony Console Application with Dependency Injection Under 4 Files ]]></title>
                <link>https://tomasvotruba.com/blog/2018/05/28/build-your-first-symfony-console-application-with-dependency-injection-under-4-files</link>
                <description><![CDATA[ <p>Series about PHP CLI Apps continues with 3rd part about writing Symfony Console Application with Dependency Injection in the first place. Not last, not second, <strong>but the first</strong>.
<br>
Luckily, is easy to start using it and very difficult to</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Symfony-Evolution">Symfony Evolution</h2>
<p><a href="http://richardmiller.co.uk/2011/04/15/symfony2-controller-as-service">7 years ago it was a total nightmare to use Controllers as services</a>. Luckily, Symfony evolved a lot in this matter and using Symfony 4.0 packages in a brand new application is much simpler than it was in Symfony 2.8 or even 3.2. The very same evolution allowed to enter Dependency Injection to Symfony Console-based PHP CLI App.</p>
<h3 id="Commands-as-Services">Commands as Services</h3>
<p>I already wrote about <a href="/blog/2018/05/07/why-you-should-combine-symfony-console-and-dependency-injection/#3-symfony-console-meets-symfony-dependencyinjection">why is this important</a>, today we look at <strong>how to actually do it</strong>. To be clear, how to do it without the need of bloated FrameworkBundle, that is an official but <a href="https://matthiasnoback.nl/2013/10/symfony2-console-commands-as-services-why">rather bad-practice solution</a>.</p>
<h2 id="3-Steps-to-First-Command-as-a-Service">3 Steps to First Command as a Service</h2>
<p>All we need are these 3 elements:</p>
<ul>
<li><code>service.yml</code> file with PSR-4 autodiscovery,</li>
<li>classic Kernel</li>
<li>and the bin file - entry point to our application.</li>
</ul>
<p>The simplest things first.</p>
<h3 id="1-services-yml">1. <code>services.yml</code></h3>
<p>Create <code>config/services.yml</code> with classic <a href="https://github.com/symfony/symfony/pull/21289#issue-101559374">PSR-4 autodiscovery/autowire setup</a> and register <code>Symfony\Component\Console\Application</code> as well. We will use this class later.</p>
<pre><code class="language-yaml"># config/services.yml
services:
    _defaults:
        autowire: true

    App\:
        resource: '../app'

    Symfony\Component\Console\Application:
        # why public? so we can get it from container in bin file
        # via "$container-&gt;get(Application::class)"
        public: true</code></pre>
<h3 id="2-Kernel">2. Kernel</h3>
<p>The basic stone of all Symfony Applications. Nothing extra here, we just load the <code>config/services.yml</code> from the previous step:</p>
<pre><code class="language-php">&lt;?php

# app/AppKernel.php

use Symfony\Component\Config\Loader\LoaderInterface;
use Symfony\Component\HttpKernel\Kernel;
use Symfony\Component\DependencyInjection\ContainerBuilder;

final class AppKernel extends Kernel
{
    /**
     * In more complex app, add bundles here
     */
    public function registerBundles(): array
    {
        return [];
    }

    /**
     * Load all services
     */
    public function registerContainerConfiguration(LoaderInterface $loader): void
    {
        $loader-&gt;load(__DIR__ . '/../config/services.yml');
    }
}</code></pre>
<p>There is one more thing. We'll have to do.</p>
<h3 id="3-The-bin-file">3. The bin file</h3>
<p>Last but not least the entry point to our application - <code>bin/some-app</code>. That's basically twin-brother of <a href="https://github.com/symfony/demo/blob/beb3aa8e988527f16ac50f792eede240fafbfdfc/public/index.php#L35-L39"><code>public/index.php</code></a>, just for CLI Apps.</p>
<pre><code class="language-php"># bin/some-app

require_once __DIR__ . '/vendor/autoload.php';

use Symfony\Component\Console\Application;

$kernel = new AppKernel;
$kernel-&gt;boot();

$container = $kernel-&gt;getContainer();
$application = $container-&gt;get(Application::class);
$application-&gt;run();</code></pre>
<p><br></p>
<p>So let's say we have a <code>App\Command\SomeCommand</code> with <code>some</code> name and we want to run it:</p>
<pre><code class="language-bash">bin/some-app some</code></pre>
<p><br></p>
<p>But we get:</p>
<pre><code class="language-bash">Command "some" is not defined.</code></pre>
<p><br></p>
<p>Why? We're sure that:</p>
<ul>
<li>the <code>App\Command\SomeCommand</code> class exists</li>
<li>it's located in <code>app/Command/SomeCommand.php</code> file</li>
<li>the <code>config/services.yml</code> loads it</li>
<li><code>composer.json</code> section <code>autoload</code> is correctly configured</li>
<li><code>vendor/autoload.php</code> was dumped with <code>composer dump</code>...</li>
</ul>
<p>What are we missing? Oh, we forgot to <strong>load commands to the <code>Application</code> service</strong>. Everything works, but our application doesn't know about our commands. It's like if the web application doesn't know where to find the controller.</p>
<h3 id="How-to-Add-All-Services-of-Type-A-to-Service-of-Type-B">How to Add All Services of Type A to Service of Type B</h3>
<p>With FrameworkBundle we'd add <code>autoconfigure</code> option to <code>services.yml</code> config - it works with tags, but here we need to use clean PHP.
<a href="/blog/2017/02/12/drop-all-service-tags-in-your-nette-and-symfony-applications/">Tags magic that is often overused in wrong places</a>, so this extra works is actually a good thing. We know what happens... but <strong>mainly readers of our code know it too</strong>.</p>
<p>This is the place to use <a href="/blog/2018/03/08/why-is-collector-pattern-so-awesome/#drop-that-expression-language-magic">famous collector pattern</a> via <code>CompilerPass</code>:</p>
<pre><code class="language-php"># app/DependencyInjection/CompilerPass/CommandsToApplicationCompilerPass.php

namespace App\DependencyInjection\CompilerPass;

use Symfony\Component\Console\Application;
use Symfony\Component\Console\Command\Command;
use Symfony\Component\DependencyInjection\Compiler\CompilerPassInterface;
use Symfony\Component\DependencyInjection\ContainerBuilder;
use Symfony\Component\DependencyInjection\Reference;

final class CommandsToApplicationCompilerPass implements CompilerPassInterface
{
    public function process(ContainerBuilder $containerBuilder): void
    {
        $applicationDefinition = $containerBuilder-&gt;getDefinition(Application::class);

        foreach ($containerBuilder-&gt;getDefinitions() as $name =&gt; $definition) {
            if (is_a($definition-&gt;getClass(), Command::class, true)) {
                $applicationDefinition-&gt;addMethodCall('add', [new Reference($name)]);
            }
        }
    }
}</code></pre>
<p><br></p>
<p>And make our <code>Kernel</code> aware of it:</p>
<pre><code class="language-php"># app/AppKernel.php

// ...

use App\DependencyInjection\CompilerPass\CommandsToApplicationCompilerPass;
use Symfony\Component\Console\Application;
use Symfony\Component\Console\Command\Command;

// ...

{
    protected function build(ContainerBuilder $containerBuilder): void
    {
        $containerBuilder-&gt;addCompilerPass(new CommandsToApplicationCompilerPass);
    }

    // ...
}</code></pre>
<p><br></p>
<p>This will compile to container to something like this:</p>
<pre><code class="language-php">function createSomeCommand()
{
    return new SomeCommand();
}

function createApplication()
{
    $application = new Application;
    $application-&gt;add(createSomeCommand());

    return $application;
}</code></pre>
<p>Now let's try it again:</p>
<pre><code class="language-bash">bin/some-app some</code></pre>
<p>It works! And that's it. I told you it'll be easy - how can we not love Symfony :).</p>
<p><strong>Do you still struggle with some parts?</strong> Don't worry, this post is tested by PHPUnit, so you can find all the code mentioned here - just click on &quot;Tested&quot; in the top of the post to see it.</p>
<p><br><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/05/28/build-your-first-symfony-console-application-with-dependency-injection-under-4-files</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 28 May 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/05/28/build-your-first-symfony-console-application-with-dependency-injection-under-4-files#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ The Boss vs. The Masseuse Way to Add Coding Standards to a Big Project ]]></title>
                <link>https://tomasvotruba.com/blog/2018/05/24/boss-vs-masseuse-way-to-add-coding-standards-to-big-project</link>
                <description><![CDATA[ <p>Do you prefer a <strong>boss who's watching you</strong> how you sit at the desk telling how to sit right
or a <strong>masseuse who's taking care of your hands</strong> tired from programming with her gentle hands?
<br><br>
When it comes to coding standards, the love and fun is the best experience with it. Let's look how such &quot;masseuse&quot; can be added to your big project.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="and-quot-The-Boss-and-quot-Way-to-Add-Coding-Standard">&quot;The Boss&quot; Way to Add Coding Standard</h2>
<p>It's very rare that projects have coding standards right from the first line. That applies to CI, tests, coverage, and docs. Why? They come with experience and with a need. <strong>The biggest added value of coding standards is to bring more fun to your team, as it works for you</strong>.</p>
<p>Saying that <strong>the most projects need and then add coding standards when they grow up to a large code base</strong>.</p>
<p>The most <a href="https://akrabat.com/checking-your-code-for-psr-2">popularized way</a> to do this is:</p>
<pre><code class="language-bash">composer require squizlabs/php_codesniffer --dev
vendor/bin/phpcs --standard=PSR2 /app /src</code></pre>
<p>I bet you're able to run these command even if you see it for the first time.</p>
<p>But what will happen next?</p>
<img src="/assets/images/posts/2018/cs-masseuce/unknown-error.png">
<p><strong>You'll get ~ <em>X</em> hundreds of errors you don't understand</strong>. It can feel embarrassing like having the boss' eyes on you all the time.</p>
<p>This is often the reason coding standard is not part of many great PHP projects, which makes me very sad.</p>
<h2 id="and-quot-The-Masseuse-and-quot-Way-to-Add-Coding-Standard">&quot;The Masseuse&quot; Way to Add Coding Standard</h2>
<p>How to make this first experience better? Start slowly, one touch at a time, like a masseuse with your hands.</p>
<h3 id="1-Install-Your-Favoring-Coding-Standard-Tool">1. Install Your Favoring Coding Standard Tool</h3>
<p>For me, it's obviously <a href="https://github.com/symplify/easy-coding-standard">ECS</a>:</p>
<pre><code class="language-bash">composer require symplify/easy-coding-standard --dev</code></pre>
<h3 id="2-Use-One-Sniff-Fixer-that-Helps-You-The-Most">2. Use One Sniff/Fixer that Helps You The Most</h3>
<p>This is the most important step. This checker should be</p>
<ul>
<li>easy to understand</li>
<li>helpful for you as a programmer (not a <code>{</code> or <code>"</code> position)</li>
<li>helpful to your project</li>
<li>and easy to fix code for you (like <code>array()</code> → <code>[]</code>)</li>
</ul>
<h3 id="3-Make-it-Pass-Without-Any-Code-Change">3. Make it Pass Without Any Code Change</h3>
<p>Last week a <a href="/blog/2018/05/21/is-your-code-readable-by-humans-cognitive-complexity-tells-you/">Cognitive Complexity Rule</a> was published there was <a href="https://github.com/symplify/symplify/issues/834">very positive feedback</a> on it.</p>
<p><strong>If your coding standard should have only 1 rule - this is the one.</strong></p>
<pre><code class="language-yaml"># phpstan.neon
includes:
    - vendor/symplify/phpstan-rules/packages/cognitive-complexity/config/cognitive-complexity-services.neon

services:
    -
        class: Symplify\PHPStanRules\CognitiveComplexity\Rules\FunctionLikeCognitiveComplexityRule
        tags: [phpstan.rules.rule]
        arguments:
            maxMethodCognitiveComplexity: 8</code></pre>
<p>But when you run your tool (<code>vendor/bin/phpstan analyse /src</code>), it will probably drop dozens of errors. And we don't want to go to the boss approach.</p>
<p><br></p>
<p>Saying that, <strong>we make the rule so free, that your code passes it</strong>:</p>
<pre><code class="language-diff"> services:
     -
         class: Symplify\PHPStanRules\CognitiveComplexity\Rules\FunctionLikeCognitiveComplexityRule
         tags: [phpstan.rules.rule]
         arguments:
-            maxMethodCognitiveComplexity: 8
+            maxMethodCognitiveComplexity: 50</code></pre>
<p><strong>0 errors!</strong></p>
<p>You can now add this to your GitHub Actions and make the PR. Merge it and take a 2 weeks break.</p>
<p><br></p>
<p>Then decrease the criteria for 10 %:</p>
<pre><code class="language-diff"> services:
     -
         class: Symplify\PHPStanRules\CognitiveComplexity\Rules\FunctionLikeCognitiveComplexityRule
         tags: [phpstan.rules.rule]
         arguments:
-            maxMethodCognitiveComplexity: 8
+            maxMethodCognitiveComplexity: 45</code></pre>
<ul>
<li>Fix couple the cases that will appear.</li>
<li>One at a time.</li>
<li>Then repeat previous workflow: PR, merge and take a week break.</li>
</ul>
<p>When <strong>you feel ready</strong>, you can add 1 more checker, make a rule more strict... you get the idea to enjoy your massage :).</p>
<h2 id="Proven-Practice">Proven Practice</h2>
<p>This way I was able to add coding standards to quite a big codebase in <a href="https://github.com/lekarna">Lekarna.cz</a> a few years ago with not many troubles, and learn how they work along the way.</p>
<p><br></p>
<p><strong>I wish you the same experience in your huge project.</strong></p>
<p><br><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/05/24/boss-vs-masseuse-way-to-add-coding-standards-to-big-project</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 24 May 2018 00:00:00 +0000</pubDate>
                                    <updated>2021-02-01UTC00:00:000</updated>
                    <atom:updated>Mon, 01 Feb 2021 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Mon, 01 Feb 2021 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/05/24/boss-vs-masseuse-way-to-add-coding-standards-to-big-project#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Is Your Code Readable By Humans? Cognitive Complexity Tells You ]]></title>
                <link>https://tomasvotruba.com/blog/2018/05/21/is-your-code-readable-by-humans-cognitive-complexity-tells-you</link>
                <description><![CDATA[ <p>Cyclomatic complexity is a static analysis measure of how difficult is code to test.
<strong>Cognitive complexity</strong> tells us, how difficult code is to understand by a reader.
<br>
<br>
Today, we'll see why is the later better and how to check it in your code with a Sniff.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="What-is-Cognitive-Complexity">What is Cognitive Complexity?</h2>
<p><em>Tomáš Horváth</em> referenced me to <a href="https://blog.sonarsource.com/cognitive-complexity-because-testability-understandability">Cognitive Complexity, Because Testability != Understandability</a> under the <a href="https://pehapkari.cz/blog/2018/04/04/cyklomaticka-komplexita">Cyclomatic Complexity</a> post. Thank you Tomas.</p>
<p>The most important source about <em>Cognitive Complexity</em> is <a href="https://www.sonarsource.com/docs/CognitiveComplexity.pdf">a 21-page long PDF</a>. Instead of explaining in words (you can read that in the PDF), <strong>here are 2 examples that speak more than a thousand words</strong>:</p>
<p><br></p>
<h3 id="Example-A">Example A</h3>
<p>Cyclomatic Complexity: 4</p>
<pre><code class="language-php">function getWords($number) {    // +1
    switch ($number) {
      case 1:                   // +1
        return "one";
      case 2:                   // +1
        return "a couple";
      default:                  // +1
        return "lots";
    }
}</code></pre>
<p><strong>vs. Cognitive Complexity: 1</strong></p>
<pre><code class="language-php">function getWords($number) {
    switch ($number) {          // +1
      case 1:
        return "one";
      case 2:
        return "a couple";
      default:
        return "lots";
    }
}</code></pre>
<h3 id="Example-B">Example B</h3>
<p>Cyclomatic Complexity: 4</p>
<pre><code class="language-php">function sumOfPrimes($max) {            // +1
    $total = 0;
    for ($i = 1; $i &lt; $max; ++$i) {     // +1
        for ($j = 2; $j &lt; $i; ++$j) {   // +1
            if ($i % $j === 0) {        // +1
                continue 2;
            }
        }

        $total += $i;
    }

    return $total;
}</code></pre>
<p><strong>vs. Cognitive Complexity: 7</strong></p>
<pre><code class="language-php">function sumOfPrimes($max) {
    $total = 0;
    for ($i = 1; $i &lt; $max; ++$i) {     // +1
        for ($j = 2; $j &lt; $i; ++$j) {   // +2
            if ($i % $j === 0) {        // +3
                continue 2;             // +1
            }
        }

        $total += $i;
    }

    return $total;
}</code></pre>
<p>If I should put it in own words, the <em>cognitive complexity</em> is <strong>how difficult is to understand
a function and all its possible paths</strong>.</p>
<ul>
<li>
<p>Example A: <strong>there is a <code>switch()</code> and based on <code>$number</code> returns a specific value.</strong> Even if there are 50 <code>case:</code>, the story is still the same.</p>
</li>
<li>
<p>Example B: <strong>there are 3 <code>for</code>s, with nesting and one continue to non-self level</strong>.</p>
</li>
</ul>
<h2 id="Automation-Over-Information">Automation Over Information</h2>
<p>This all is nice to know information. The one that you might find interesting, remember it for few days and then forget it and never meet it again. But I'm too lazy to <em>learn to just forget</em>, so I <em>learn to automate</em>. This is place <a href="/blog/2017/07/17/how-to-write-custom-sniff-for-code-sniffer-3/">to write a Sniff</a>.</p>
<p>It took me 5 days to understand academic writings in the PDF, to convert Java and Python examples to PHP and reverse-engineer the algorithm to compute cognitive complexity to match results in the PDF. <strong>The most difficult was to change the cyclomatic complexity approach I used for last 4 years to a human one</strong>.</p>
<p>Today, I'm happy to show you the first version of <code>CognitiveComplexitySniff</code>.</p>
<h2 id="3-Steps-to-Check-Cognitive-Complexity-of-Your-Code">3 Steps to Check Cognitive Complexity of Your Code</h2>
<p><strong>1. Install Symplify\CodingStandard</strong></p>
<pre><code class="language-bash">composer require symplify/coding-standard symplify/easy-coding-standard --dev</code></pre>
<p><strong>2. Create <code>phpstan.neon</code></strong></p>
<pre><code class="language-yaml"># phpstan.neon
includes:
    - vendor/symplify/coding-standard/packages/cognitive-complexity/config/cognitive-complexity-rules.neon

parameters:
    symplify:
        max_cognitive_complexity: 8 # default
        max_class_cognitive_complexity: 50 # default</code></pre>
<p><strong>3. Run it</strong></p>
<pre><code class="language-bash">vendor/bin/phpstan analyse src</code></pre>
<h2 id="Refactor-to-Lower-Cognitive-Complexity-in-Examples">Refactor to Lower Cognitive Complexity in Examples</h2>
<p><a href="https://github.com/symplify/symplify/pull/823/files" class="btn btn-dark btn-sm">
See pull-request
</a></p>
<p>Saying &quot;refactoring this&quot; is very simple, but actual work and teaching others is a very challenging task. To make this a bit easier for you, I've extracted few refactorings I made in Symplify thanks to this Sniff.</p>
<h3 id="1-Refactoring-to-Shorter-Condition">1. Refactoring to Shorter Condition</h3>
<pre><code class="language-diff">index 83ca0da5..125f7c7f 100644
--- a/packages/TokenRunner/src/Wrapper/FixerWrapper/DocBlockWrapper.php
+++ b/packages/TokenRunner/src/Wrapper/FixerWrapper/DocBlockWrapper.php
@@ -160,17 +160,9 @@ final class DocBlockWrapper
         }

         if ($typeNode instanceof IdentifierTypeNode) {
-            if ($typeNode-&gt;name === 'array') {
-                return true;
-            }
-
-            return false;
-        }
-
-        if ($typeNode instanceof ArrayTypeNode) {
-            return true;
+            return $typeNode-&gt;name === 'array';
         }

-        return false;
+        return $typeNode instanceof ArrayTypeNode;
     }
 }</code></pre>
<h3 id="2-Refactoring-with-Method-Extraction">2. Refactoring with Method Extraction</h3>
<pre><code class="language-diff">--- a/packages/CodingStandard/src/Fixer/Commenting/RemoveEmptyDocBlockFixer.php
+++ b/packages/CodingStandard/src/Fixer/Commenting/RemoveEmptyDocBlockFixer.php
@@ -48,16 +48,7 @@ final class RemoveEmptyDocBlockFixer extends AbstractFixer
     protected function applyFix(SplFileInfo $file, Tokens $tokens): void
     {
         for ($index = count($tokens); $index &gt; 0; --$index) {
-            if (! isset($tokens[$index])) {
-                continue;
-            }
-
-            $token = $tokens[$index];
-            if (! $token-&gt;isGivenKind(T_DOC_COMMENT)) {
-                continue;
-            }
-
-            if (! preg_match('#^/\*\*[\s\*]*\*/$#', $token-&gt;getContent())) {
+            if ($this-&gt;shouldSkip($tokens, $index)) {
                 continue;
             }

@@ -77,4 +68,18 @@ final class RemoveEmptyDocBlockFixer extends AbstractFixer
             }
         }
     }
+
+    private function shouldSkip(Tokens $tokens, int $index): bool
+    {
+        if (! isset($tokens[$index])) {
+            return true;
+        }
+
+        $token = $tokens[$index];
+        if (! $token-&gt;isGivenKind(T_DOC_COMMENT)) {
+            return true;
+        }
+
+        return (bool) ! preg_match('#^/\*\*[\s\*]*\*/$#', $token-&gt;getContent());
+    }
 }</code></pre>
<h3 id="3-Refactoring-to-Responsible-Method">3. Refactoring to Responsible Method</h3>
<pre><code class="language-diff">diff --git a/packages/CodingStandard/src/Fixer/Import/ImportNamespacedNameFixer.php b/packages/CodingStandard/src/Fixer/Import/ImportNamespacedNameFixer.php
index 1d532ca58..8aa7981cb 100644
--- a/packages/CodingStandard/src/Fixer/Import/ImportNamespacedNameFixer.php
+++ b/packages/CodingStandard/src/Fixer/Import/ImportNamespacedNameFixer.php
@@ -148,10 +148,6 @@ public function fix(SplFileInfo $file, Tokens $tokens): void
             }

             if ($token-&gt;isGivenKind(T_DOC_COMMENT)) {
-                if (! $this-&gt;configuration[self::INCLUDE_DOC_BLOCKS_OPTION]) {
-                    continue;
-                }
-
                 $this-&gt;processDocCommentToken($index, $tokens);
                 continue;
             }
@@ -274,6 +270,10 @@ private function processStringToken(Token $token, int $index, Tokens $tokens): v

     private function processDocCommentToken(int $index, Tokens $tokens): void
     {
+        if (! $this-&gt;configuration[self::INCLUDE_DOC_BLOCKS_OPTION]) {
+            return;
+        }
+
         $phpDocInfo = $this-&gt;phpDocInfoFactory-&gt;createFrom($tokens[$index]-&gt;getContent());
         $phpDocNode = $phpDocInfo-&gt;getPhpDocNode();</code></pre>
<p><br><br></p>
<p>Happy Code Reading!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/05/21/is-your-code-readable-by-humans-cognitive-complexity-tells-you</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 21 May 2018 00:00:00 +0000</pubDate>
                                    <updated>2020-05-01UTC00:00:000</updated>
                    <atom:updated>Fri, 01 May 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Fri, 01 May 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/05/21/is-your-code-readable-by-humans-cognitive-complexity-tells-you#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Test Private Services in Symfony ]]></title>
                <link>https://tomasvotruba.com/blog/2018/05/17/how-to-test-private-services-in-symfony</link>
                <description><![CDATA[ <p>2 versions of Symfony are affected by this dissonance between services and tests.
<strong>Do you use Symfony 3.4 or 4.0? Do you want to test your services, but struggle to get them in a clean way?</strong>
<br><br>
Today we look at possible solutions.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Since <a href="https://symfony.com/blog/new-in-symfony-3-4-services-are-private-by-default">Symfony 3.4 all services are private by default</a>.
That means you can't get service by <code>$this-&gt;get(App\SomeService::class)</code> or <code>$this-&gt;container-&gt;get(App\SomeService::class)</code> anymore, but <strong>only only via constructor</strong>.</p>
<p>That's ok until you need to test such service:</p>
<pre><code class="language-php">use App\SomeService;
use PHPUnit\Framework\TestCase;

final class SomeServiceTest extends TestCase
{
    public function testSomeMethod()
    {
        $kernel = new AppKernel;
        $kernel-&gt;boot();
        $container = $kernel-&gt;getContainer();

        // this line is important ↓
        $someService = $container-&gt;get(SomeService::class);
        // ...
    }
}</code></pre>
<p>When we run the test:</p>
<pre><code class="language-bash">vendor/bin/phpunit tests</code></pre>
<p>This exception will stop us:</p>
<pre><code class="language-yaml">The "App\SomeService" service or alias has been removed or inlined when the container
was compiled. You should either make it public, or stop using the container directly
and use dependency injection instead.</code></pre>
<p>...<em>make it public</em>...</p>
<p>Ok!</p>
<pre><code class="language-diff"> # app/config/config.yml
 services:
     _defaults:
         autowire: true

     App\:
         resource: ..
+
+    App\SomeService:
+        public: true</code></pre>
<p><br></p>
<p>And run tests again:</p>
<pre><code class="language-bash">vendor/bin/phpunit tests</code></pre>
<p class="text-success pt-3 pb-3">
    ✅ Voilá!
</p>
<h2 id="Down-the-Smelly-Rabbit-Hole">Down the Smelly Rabbit Hole</h2>
<p>As you can see, we can load dozens of service from <code>App\</code> by 2 lines. But to test 1, we need to add 2 extra lines to config.</p>
<pre><code class="language-diff"> # app/config/config.yml
 services:
     _defaults:
         autowire: true

     App\:
         resource: ..
+
+    # for tests only
+    App\SomeService:
+        public: true
+
+    App\AnotherService:
+        public: true
+
+    App\YetAnotherService:
+        public: true</code></pre>
<p>This is <em>one to many</em> code smell.</p>
<p>Also, we can <strong>extract it to test config</strong> <code>tests/config/config.yml</code>, so it's easier to hide the smell.</p>
<p>Or just <strong>make everything public</strong>, like <a href="https://github.com/symplify/symplify/commit/d0457773915fa32df08e7342d5cd0093f97850ff">I did in Symplify 6 months ago</a>:</p>
<pre><code class="language-diff"> services:
     _defaults:
         autowire: true
+        # for tests only
+        public: true

      App\:
          resource: ..</code></pre>
<p>But Symfony folks will not be happy to see this, because they need people to use private services. Why? So they learn to use constructor injection in services instead of <code>$this-&gt;get(...)</code>. So how should we do it <em>the Symfony-way</em>?</p>
<p><strong>We're not alone asking this question</strong>. There are over <a href="https://stackoverflow.com/search?q=symfony+tests+private+services+is%3Aquestion">52 results for &quot;symfony tests private services&quot; on StackOverflow</a> at the time being:</p>
<img src="/assets/images/posts/2018/private-services/popular.png" class="img-thumbnail">
<p>But what saint options we have?</p>
<h2 id="1-In-Symfony-4-1-with-FrameworkBundle">1. In Symfony 4.1 with FrameworkBundle</h2>
<p>This is now fixed in
<a href="https://symfony.com/blog/new-in-symfony-4-1-simpler-service-testing">Symfony 4.1 with Simpler service testing</a>.</p>
<p>Do you use</p>
<ul>
<li><code>Symfony\Bundle\FrameworkBundle\Test\KernelTestCase</code> or</li>
<li><code>Symfony\Bundle\FrameworkBundle\Test\WebTestCase</code></li>
</ul>
<p>for your tests? <strong>Just upgrade to Symfony 4.1 and you're done.</strong></p>
<h2 id="2-In-Symfony-4-1-Standalone-or-Symfony-3-4-4-0">2. In Symfony 4.1 Standalone or Symfony 3.4/4.0</h2>
<p>But if you create open-source, you usually stick with last LTS, Symfony 3.4. How to solve it there?</p>
<p>It's reasonable we want to <strong>keep all configs untouched</strong>, no matter if we're in dev or tests.</p>
<pre><code class="language-yaml"># app/config/config.yml
services:
    _defaults:
        autowire: true

    App\:
        resource: ..</code></pre>
<p>And tests as well:</p>
<pre><code class="language-php">use App\SomeService;
use PHPUnit\Framework\TestCase;

final class SomeServiceTest extends TestCase
{
    public function testSomeMethod()
    {
        $kernel = new AppKernel;
        $kernel-&gt;boot();
        $container = $kernel-&gt;getContainer();

        $someService = $container-&gt;get(SomeService::class);
        // ...
    }
}</code></pre>
<p>If there would only be one place with a switch, that would make that all code smells go away and let us test. That would be awesome, right? How can we achieve that? Any ideas?</p>
<h3 id="Compiler-Pass-Possible-Solution">Compiler Pass = Possible Solution?</h3>
<p>Compiler pass allows us to write nice, decoupled and reusable code. After all, the solution for Symfony 4.1 is done by <a href="https://github.com/symfony/symfony/pull/26499/files#diff-ce4ed09b11d8fa531159e96df52124f3">a compiler pass</a>, that creates public 'test.service-name' aliases.</p>
<p>Let's create one for our PHPUnit test cases:</p>
<pre><code class="language-php">&lt;?php

use Symfony\Component\DependencyInjection\Compiler\CompilerPassInterface;
use Symfony\Component\DependencyInjection\ContainerBuilder;

final class PublicForTestsCompilerPass implements CompilerPassInterface
{
    public function process(ContainerBuilder $containerBuilder): void
    {
        if (! $this-&gt;isPHPUnit()) {
            return;
        }

        foreach ($containerBuilder-&gt;getDefinitions() as $definition) {
            $definition-&gt;setPublic(true);
        }

        foreach ($containerBuilder-&gt;getAliases() as $definition) {
            $definition-&gt;setPublic(true);
        }
    }

    private function isPHPUnit(): bool
    {
        // there constants are defined by PHPUnit
        return defined('PHPUNIT_COMPOSER_INSTALL') || defined('__PHPUNIT_PHAR__');
    }
}</code></pre>
<p>And register it in our Kernel:</p>
<pre><code class="language-php">&lt;?php

final class AppKernel extends Kernel
{
    protected function build(ContainerBuilder $containerBuilder): void
    {
        $containerBuilder-&gt;addCompilerPass(new PublicForTestsCompilerPass());
    }
}</code></pre>
<p>This removes all <code>public: true</code> lines from all your configs.</p>
<img src="/assets/images/posts/2018/private-services/gone.png" class="img-thumbnail">
<p class="text-success pt-3 pb-3">
    ✅ That's it!
</p>
<h2 id="But-Why">But Why?</h2>
<ul>
<li>&quot;So we can remove the <code>public: true</code> from our configs.&quot;</li>
<li>&quot;That's a consequence, not a reason. So why?&quot;</li>
<li>&quot;So we can get services from container in tests.&quot;</li>
<li>&quot;That's a goal. I ask for why this way?&quot;</li>
<li>&quot;Well, it's universal and just works.&quot;</li>
</ul>
<p>It is. But in 6 months of using this method <strong>I got different feedback from the PHP community</strong>:</p>
<ul>
<li>Why there are no public services, but we can get them from container anyway? ❌</li>
<li>Why test and dev services behave differently? ❌</li>
<li>Why I can't get the service from container in the second application as in the first one? ❌ (They <a href="/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock/">forgot to add</a> a compiler pass to new Kernel.)</li>
<li>Why I have to add <code>public: true</code> for Symfony\Console\Application in bin file, but not in tests? ❌</li>
</ul>
<p><strong>People were confused 😕🤔</strong>. The trade of compiler pass feature was putting too much knowledge pressure on the programmers. <strong>The application uses constructor injection everywhere, so there is no real added value by working with term <em>public/private</em> services</strong>.</p>
<h2 id="Final-Proven-Practise">Final Proven Practise</h2>
<p>In the end <strong>I removed the compiler pass and moved back to <code>public: true</code> in all configs</strong> right bellow <code>autowire: true</code>:</p>
<pre><code class="language-diff"> services:
     _defaults:
         autowire: true
+        public: true</code></pre>
<p>Thanks to that, the <strong>whole process became clear</strong>:</p>
<ul>
<li>We're using native Symfony syntax, you don't have to learn compiler passes ✅</li>
<li>Configs are clear and people know what to expect ✅</li>
<li>The location is always behind <code>autowire: true</code> → all configs have the same setup ✅</li>
</ul>
<p><br><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/05/17/how-to-test-private-services-in-symfony</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 17 May 2018 00:00:00 +0000</pubDate>
                                    <updated>2019-04-01UTC00:00:000</updated>
                    <atom:updated>Mon, 01 Apr 2019 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Mon, 01 Apr 2019 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/05/17/how-to-test-private-services-in-symfony#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Load --config With Services in Symfony Console ]]></title>
                <link>https://tomasvotruba.com/blog/2018/05/14/how-to-load-config-with-services-in-symfony-console</link>
                <description><![CDATA[ <p>PHP CLI apps usually accept config, to setup their behavior. For PHPUnit it's <code>phpunit.xml</code>, for PHP CS Fixer it's <code>.php_cs</code>, for ECS it's <code>ecs.php</code>, for PHPStan it's <code>phpstan.neon</code> and so on.
<br><br>
In the first post about PHP CLI Apps I wrote about <a href="/blog/2018/05/07/why-you-should-combine-symfony-console-and-dependency-injection/">poor DI support in PHP CLI projects</a>.
<br><br>
Today we look on the first barrier that leads most people to prefer static over DI - <strong>how to load config with services</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <pre><code class="language-bash">vendor/bin/phpstan --configuration phpstan.neon
vendor/bin/ecs --config ecs.php</code></pre>
<p>Can you spot the difference? Same CLI input, but:</p>
<ul>
<li>
<p>first has only <a href="/blog/2018/05/07/why-you-should-combine-symfony-console-and-dependency-injection/#2-container-inceptions">in-command container build for few classes</a>,</p>
</li>
<li>
<p>second is <a href="/blog/2018/05/07/why-you-should-combine-symfony-console-and-dependency-injection/#3-symfony-console-meets-symfony-dependencyinjection">Application with full DI support</a>, like a Symfony App.</p>
</li>
</ul>
<p>Today you'll learn <strong>how</strong> to get from first to second, knowing <strong>why</strong> and all the pros and cons.</p>
<h2 id="Who-Comes-First">Who Comes First?</h2>
<img src="/assets/images/posts/2018/config-di-console/chicken-egg.jpg" class="img-thumbnail">
<p>This addresses a problem (or rather mind-exercise) of <a href="/blog/2018/05/07/why-you-should-combine-symfony-console-and-dependency-injection/#injection-inception-problem">injection inception</a> aka <em>chicken vs. egg</em>. Because this might be a little bit confusing, I try to describe it in 3 different forms:</p>
<h3 id="A-In-Chicken-vs-Egg-Form">A. In Chicken vs. Egg Form</h3>
<p>We need <em>an egg</em>, so we can create <em>a chicken</em>. We can get <em>an egg</em> thanks to <em>a chicken</em>.  With <em>this egg</em>, we can create <em>a chicken</em>. Then we need to get a chicken to &quot;cluck&quot;.</p>
<h3 id="B-In-Container-vs-Config-Form">B. In Container vs. Config Form</h3>
<p>We need a config to create a container. We can get a config thanks to <code>Symfony\Component\Console\Application</code>. With this value, we can create a container. Then we need to get a <code>Symfony\Component\Console\Application</code> service and call <code>run()</code> method on it.</p>
<h3 id="C-In-Implementation-Form">C. In Implementation Form</h3>
<p>Are you lost? That's all right. Let's see it in a list:</p>
<ul>
<li>Get a user-provided config from CLI (e.g. <code>--config ecs.php</code>)</li>
<li>Use <code>Symfony\Component\Console\Application</code> to get this value</li>
<li>Create a DI container with this config</li>
<li>Get <code>Application</code> service from the container</li>
<li>Invoke the <code>Application</code> with provided config</li>
<li>Get a user-provided config from CLI (e.g. <code>--config ecs.php</code>)</li>
<li>...</li>
</ul>
<p>Very nice recursion, isn't it?</p>
<h2 id="Why-this-Problem-Even-Exists">Why this Problem Even Exists?</h2>
<p>To get the main config in PHP App is easy. Symfony has <a href="https://github.com/symfony/demo/blob/v1.0.0/app/AppKernel.php#L59">a common path in <code>Kernel</code></a>, Nette <a href="https://github.com/nette/sandbox/blob/b3bd786d71bdecec441121cafc63086e58355130/app/bootstrap.php#L18">in Configurator</a> and other frameworks likewise.</p>
<p>It's usually <strong>absolute path defined in PHP code</strong>, usually <code>app/config/config.php</code> or <code>app/config/config.neon</code>. It doesn't change and every developer knows that. If we put the file to <code>app/config.php</code>, it won't be loaded. PHP Apps are nice and clear in this matter.</p>
<h3 id="PHP-CLI-Apps-are-Free">PHP CLI Apps are Free</h3>
<p>Users can configure the path to the main config, they can have multiple configs, <code>.dist</code> configs, config located in the root or nested in <code>/config</code> directory, it can be named <code>my-own-super-cool-config.php</code> and so on.</p>
<p>Legacy bound architecture design or static code is a price for the freedom we have to pay here. <strong>So can we pay less?</strong></p>
<h3 id="3-Possible-and-quot-Solutions-and-quot">3 Possible &quot;Solutions&quot;</h3>
<p>Imagine we call EasyCodingStandard with following <code>--config</code>:</p>
<pre><code class="language-bash">vendor/bin/ecs --config some-config.php</code></pre>
<h2 id="1-The-Mainstream-No-Container">1. The Mainstream: No Container</h2>
<p>Use static approach, no services config, just list of items. Most spread solution so far.</p>
<h3 id="How-if-Fits">How if Fits?</h3>
<p>✅ Ready in 2 minutes</p>
<p>❌ Well, static</p>
<h2 id="2-DI-for-Poor-People-Container-in-a-Command">2. DI for Poor People: Container in a Command</h2>
<p>I'm used to container <a href="/blog/2017/06/01/thank-you-david/">thanks to great work of David Grudl</a> and many posts <a href="https://phpfashion.com/co-je-dependency-injection">he wrote about dependency injection</a>, so this one is very counter-intuitive to me, but I still see it quite often in the wild.</p>
<p><strong>The easiest way to start</strong> using Container in a static application is to <strong>create it at the class we need it:</strong></p>
<pre><code class="language-php">use Symfony\Component\Console\Command\Command;

class SomeCommand extends Command
{
    // ...

    protected function execute(InputInterface $input, OutputInterface $output): int
    {
        $containerBuilder = new ContainerBuilder;
        $containerBuilder-&gt;addConfig($input-&gt;getOption('config'));
        $container = $containerBuilder-&gt;build();

        $someService = $container-&gt;get(SomeService::class);
        // ...
    }
}</code></pre>
<h3 id="How-if-Fits">How if Fits?</h3>
<p>✅ Ready in 10 minutes</p>
<p>❌ Only local scope, we need to re-create container everywhere we need it</p>
<p>❌ The Chicken vs. Egg problem still remains very clear</p>
<h2 id="3-Kill-the-Egg-The-bin-File-Tuning">3. Kill the Egg: The bin File Tuning</h2>
<p>When I worked on the first version of <a href="https://github.com/nette/coding-standard">nette/coding-standard</a>
almost a year ago, David came with question: &quot;how to use ECS with 2 different configs - one for PHP 5.6 and one for PHP 7.0&quot;?</p>
<pre><code class="language-bash">vendor/bin/ecs check src --config vendor/nette/cofing-standard/php56.php
vendor/bin/ecs check src --config vendor/nette/cofing-standard/php70.php</code></pre>
<p>I had no idea. So I created <a href="https://github.com/symplify/symplify/issues/192">this issue at Symplify</a> and praised the open-source Gods, because current version of <code>bin/ecs</code> was as simple as:</p>
<pre><code class="language-php"># bin/ecs
require_once __DIR__ . '/../vendor/autoload.php';

$container = (new ContainerFactory)-&gt;create();

// ...

$application = $container-&gt;get(Symfony\Component\Console\Application::class);
$application-&gt;run();</code></pre>
<p><br></p>
<p>So what now?</p>
<h3 id="ArgvInput-to-the-Rescue"><code>ArgvInput</code> to the Rescue</h3>
<p><a href="https://github.com/symplify/symplify/pull/198" class="btn btn-dark btn-sm">
See pull-request #198
</a></p>
<p>Do you know <code>ArgvInput</code> class? It's a Symfony\Console input helper around native PHP <code>$_SERVER['argv']</code>, that holds all the <code>arguments --options 1</code> passed via CLI.</p>
<p>Let's use it:</p>
<pre><code class="language-php">$config = null;
$argvInput = new Symfony\Component\Console\Input\ArgvInput;
if ($argvInput-&gt;hasParameterOption('--config')) {
    $config = $argvInput-&gt;getParameterOption('--config');
}

if ($config) {
    $container = (new ContainerFactory)-&gt;createWithConfig($config);
} else {
    $container = (new ContainerFactory)-&gt;create();
}

$application = $container-&gt;get(Symfony\Component\Console\Application::class);
$application-&gt;run();</code></pre>
<p>Run it:</p>
<pre><code class="language-bash">bin/ecs check src --config custom-config.php</code></pre>
<p>And see how all nicely works on the 1st run:</p>
<img src="/assets/images/posts/2018/config-di-console/ups.png" class="img-thumbnail">
<p>Or not. Oh, it looks like we need to add <code>config</code> option to the <code>CheckCommand</code> definition:</p>
<pre><code class="language-diff"> final class CheckCommand extends Command
 {
     // ...

     protected function configure(): void
     {
         $this-&gt;setName('check');
         // ...
+        $this-&gt;addOption('config', null, InputOption::VALUE_REQUIRED, 'Config file.');
     }
 }</code></pre>
<pre><code class="language-bash">bin/ecs check src --config custom-config.php</code></pre>
<img src="/assets/images/posts/2018/config-di-console/yes.png" class="img-thumbnail">
<h3 id="How-if-Fits">How if Fits?</h3>
<p>❌ Ready in 15 minutes</p>
<p>✅ Setup &amp; Forget</p>
<p>✅ Much more legacy-proof</p>
<p>✅ We can now use Dependency Injection <strong>everywhere we need</strong></p>
<p>✅ And make use off Symfony, Nette or any other container features we're used to from Web Apps.</p>
<p><br></p>
<h2 id="Where-to-Go-Next">Where to Go Next?</h2>
<p>Do you have a CLI App and do you find DI approach useful? Do you have <code>--config</code> or <code>-c</code> or <code>--configuration</code> options and do you want to migrate them to this?</p>
<p>Then go <a href="https://github.com/symplify/set-config-resolver">symplify/set-config-resolver</a>. <strong>Special package dedicated to this problem.</strong></p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/05/14/how-to-load-config-with-services-in-symfony-console</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 14 May 2018 00:00:00 +0000</pubDate>
                                    <updated>2020-11-01UTC00:00:000</updated>
                    <atom:updated>Sun, 01 Nov 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sun, 01 Nov 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/05/14/how-to-load-config-with-services-in-symfony-console#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Rectify: Turn All Action Injects to Constructor Injection in Your Symfony Application ]]></title>
                <link>https://tomasvotruba.com/blog/2018/05/10/rectify-turn-all-action-injects-to-constructor-injection-in-your-symfony-application</link>
                <description><![CDATA[ <p>Action Injections are much fun, but it can turn your project to legacy very fast. How to <strong>refactor out of the legacy back to constructor injection</strong> and still keep that smile on your face?</p> ]]></description>
                <content:encoded><![CDATA[ <p>I wrote about <a href="/blog/2018/04/23/how-to-slowly-turn-your-symfony-project-to-legacy-with-action-injection/">How to Slowly Turn your Symfony Project to Legacy with Action Injection</a> a few weeks ago. It surprised me that <strong>the approach had mostly positive <a href="/blog/2018/04/23/how-to-slowly-turn-your-symfony-project-to-legacy-with-action-injection/#comments">feedback</a></strong>:</p>
<blockquote class="blockquote">
    Couldn't agree more with pretty much everything said! Action injection makes it really confusing on whether an object is treated stateful or stateless (very grey area with the Session for example).
    <footer class="blockquote-footer text-right">Iltar van der Berg</footer>
</blockquote>
<blockquote class="blockquote">
    I'm a Symfony trainer and I'm told to teach people how to use Symfony and talk about this injection pattern. Sob.
    <footer class="blockquote-footer text-right">Alex Rock</footer>
</blockquote>
<blockquote class="blockquote">
    I'm working on a Project that uses action injection pattern and I hate it. I like autowiring but the whole idea about action injection is broken. And this project is in sf28 do we don't use autowiring. Maintainance and development with this pattern is a total nightmare.
    <footer class="blockquote-footer text-right">A</footer>
</blockquote>
<p><br></p>
<p>It's natural to <strong>try new patterns with an open heart</strong> and validate them in practice, but <strong>what if</strong> you find this way as not ideal and want to go to constructor injection instead?</p>
<p>How would you change all your 50 controllers with action injections...</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace App\Controller;

final class SomeController
{
    public function detail(int $id, Request $request, ProductRepository $productRepository)
    {
        $this-&gt;validateRequest($request);
        $product = $productRepository-&gt;find($id);
        // ...
    }
}</code></pre>
<p><strong>...to the constructor injection:</strong></p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace App\Controller;

final class SomeController
{
    /**
     * @var ProductRepository
     */
    private $productRepository;

    public function __construct(ProductRepository $productRepository)
    {
        $this-&gt;productRepository = $productRepository;
    }

    public function detail(int $id, Request $request)
    {
        $this-&gt;validateRequest($request);
        $product = $this-&gt;productRepository-&gt;find($id);
        // ...
    }
}</code></pre>
<h3 id="How-to-Waste-Week-in-1-Team">How to Waste Week in 1 Team</h3>
<ul>
<li>50 controllers, 4 actions per each → 200 services</li>
<li>some of them are duplicated</li>
<li>identify services, <a href="https://symfony.com/doc/current/controller.html#controller-request-argument"><code>Request</code> objects</a> and <a href="https://symfony.com/doc/current/controller/argument_value_resolver.html">Argument Resolver objects</a></li>
<li>code-reviews and discussions that might take up-to 5-10 days</li>
<li>and rebase on new merged PRs... well, you have 4-10 hours of team-work wasted ahead of you.</li>
</ul>
<p><br></p>
<p><strong>I find the time of my team very precious</strong>, don't you? So I Let Rector do the work.</p>
<h2 id="3-Steps-to-Instant-Refactoring-of-All-Controllers">3 Steps to Instant Refactoring of All Controllers</h2>
<h3 id="1-Install-Rector">1. Install Rector</h3>
<pre><code class="language-bash">composer install rector/rector --dev</code></pre>
<h3 id="2-Prepare-Config">2. Prepare Config</h3>
<p>Add the <code>action-injection-to-constructor-injection</code> set and configure your Kernel class name.</p>
<pre><code class="language-php">use Rector\Core\Configuration\Option;
use Rector\Set\ValueObject\SetList;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;import(SetList::ACTION_INJECTION_TO_CONSTRUCTOR_INJECTION);

    $parameters = $rectorConfig-&gt;parameters();

    // the default value
    $parameters-&gt;set('kernel_class', 'App\Kernel');
};</code></pre>
<h3 id="3-Run-Rector-on-Your-Code">3. Run Rector on Your Code</h3>
<pre><code class="language-bash">vendor/bin/rector process /app --dry-run</code></pre>
<p>You should see diffs like:</p>
<pre><code class="language-diff"> &lt;?php declare(strict_types=1);

 namespace App\Controller;

 final class SomeController
 {
+    /**
+     * @var ProductRepository
+     */
+    private $productRepository;
+
+    public function __construct(ProductRepository $productRepository)
+    {
+        $this-&gt;productRepository = $productRepository;
+    }
+
-    public function detail(int $id, Request $request, ProductRepository $productRepository)
+    public function detail(int $id, Request $request)
     {
         $this-&gt;validateRequest($request);
-        $product = $productRepository-&gt;find($id);
+        $product = $this-&gt;productRepository-&gt;find($id);
         // ...
     }
 }</code></pre>
<h3 id="3-Run-It">3. Run It</h3>
<p>Are all looking good? Run it:</p>
<pre><code class="language-bash">vendor/bin/rector process /app</code></pre>
<h2 id="Clean-Code-Done-but-What-About-Beautiful">Clean Code... Done, but What About Beautiful?</h2>
<p>You've probably noticed that code itself is not looking too good. Rector's job is not to clean, but to change the code. It's not a hipster designer, but rather a thermonuclear engineer. <strong>That's why there are coding standards. You can apply your own or if not good enough use Rector's prepared set</strong>:</p>
<pre><code class="language-bash">composer require symplify/easy-coding-standard --dev
vendor/bin/ecs --config vendor/rector/rector/ecs-after-rector.php --fix</code></pre>
<p>And your code is now both <strong>refactored and clean</strong>. That's it!</p>
<p><br><br></p>
<p>Happy instant refactoring!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/05/10/rectify-turn-all-action-injects-to-constructor-injection-in-your-symfony-application</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 10 May 2018 00:00:00 +0000</pubDate>
                                    <updated>2020-08-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Aug 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Aug 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/05/10/rectify-turn-all-action-injects-to-constructor-injection-in-your-symfony-application#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Why You Should Combine Symfony Console and Dependency Injection ]]></title>
                <link>https://tomasvotruba.com/blog/2018/05/07/why-you-should-combine-symfony-console-and-dependency-injection</link>
                <description><![CDATA[ <p>I saw 2 links to Symfony\Console in <a href="http://symfony.com/blog/a-week-of-symfony-592-30-april-6-may-2018">today's Week of Symfony</a> (what a time reference, huh?).
There are plenty of such posts out there, even in Pehapkari community blog: <a href="https://pehapkari.cz/blog/2017/06/02/best-practice-for-symfony-console-in-nette">Best Practice for Symfony Console in Nette</a> or <a href="/blog/2019/08/12/standalone-symfony-console-from-scratch/">Symfony Console from the Scratch</a>.
<br>
But nobody seems to write about <strong>the greatest bottleneck of Console applications - static cancer</strong>. Why is that?</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="1-Current-Status-in-PHP-Console-Applications">1. Current Status in PHP Console Applications</h2>
<p>Your web application has an entry point in <code>www/index.php</code>, where it loads the DI Container, gets <code>Application</code> class and calls <code>run()</code> on it (with explicit or implicit <code>Request</code>):</p>
<pre><code class="language-php">require __DIR__ . '/vendor/autoload.php';

// Kernel or Configurator
$container = $kernel-&gt;getContainer();
$application = $container-&gt;get(Application::class);
$application-&gt;run(Request::createFromGlobals());</code></pre>
<p>Console Applications (further as <em>CLI Apps</em>) have very similar entry point. Not in <code>index.php</code>, but usually in <code>bin/something</code> file.</p>
<p>When we look at entry points of popular PHP Console Applications, like:</p>
<p><br></p>
<p><a href="https://github.com/squizlabs/PHP_CodeSniffer/blob/master/bin/phpcs">PHP_CodeSniffer</a></p>
<pre><code class="language-php">$runner = new PHP_CodeSniffer\Runner();
$runner-&gt;runPHPCS();</code></pre>
<p><br></p>
<p><a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer/blob/master/php-cs-fixer">PHP CS Fixer</a></p>
<pre><code class="language-php">$application = new PhpCsFixer\Console\Application();
$application-&gt;run();</code></pre>
<p><br></p>
<p><a href="https://github.com/phpstan/phpstan/blob/master/bin/phpstan">PHPStan</a></p>
<pre><code class="language-php">$application = new Symfony\Component\Console\Application('PHPStan');
$application-&gt;add(new AnalyseCommand());
$application-&gt;run();</code></pre>
<p><br></p>
<p>If we <strong>mimic such approach in web apps</strong>, how would our <code>www/index.php</code> look like?</p>
<pre><code class="language-php">require __DIR__ . '/vendor/autoload.php';

$application = new Application;
$application-&gt;addController(new HomepageController);
$application-&gt;addController(new PostController);
$application-&gt;addController(new ContactController);
$application-&gt;addController(new ProducController);
// ...
$application-&gt;run();</code></pre>
<p>How do you feel seeing such code? I feel a bit weird and <a href="/blog/2018/04/26/how-i-got-into-static-trap-and-made-fool-of-myself/">I don't get on well with static code</a>.</p>
<p>On the other hand, if we take the web app approach to cli apps:</p>
<pre><code class="language-php">$container = $kernel-&gt;getContainer();

$application = $container-&gt;get(Application::class);
$application-&gt;run(new ArgInput);</code></pre>
<h3 id="Why-is-That">Why is That?</h3>
<p>I wish I knew this answer :). In my opinion and experience with building cli apps, there might be few...</p>
<h3 id="Advantages">✅ Advantages</h3>
<ul>
<li>
<p>CLI apps almost always start with simple plain PHP code:</p>
<pre><code class="language-php"># bin/turn-tabs-to-spaces.php

$input = $argv[1];

// 1st PSR-2 rule: replace tabs with spaces
return str_replace('\t', ' ', $input);</code></pre>
<p>No container, no dependency injection, sometimes not even dependencies. Just see <a href="https://gist.github.com/fabpot/3f25555dce956accd4dd">the PHP-CS-Fixer v0.00001</a>.</p>
<p>When the proof of concepts works, the application grows.</p>
</li>
<li>
<p>It's easy, quick and simple.</p>
</li>
<li>
<p>Who would use container right from the start of 1 command, right?</p>
</li>
</ul>
<h3 id="Disadvantages">❌ Disadvantages</h3>
<ul>
<li>If you start a project with <code>new</code> static, it's difficult to migrate.</li>
<li>The need of refactoring is clear much earlier before it really happens.</li>
<li>When the application grows, new classes are added and you need to think more and more what class to pass by the constructor, which are singletons, which value objects/DTOs etc.</li>
</ul>
<h2 id="2-Container-Inceptions">2. Container Inceptions</h2>
<p>The container is slowly appearing not as the backbone of application as in web apps, but as part of commands.</p>
<p>E.g. <a href="https://github.com/phpstan/phpstan/blob/a991e94fca78b7fb7017a469b19834766787a04c/src/Command/AnalyseCommand.php#L152"><code>AnalyseCommand</code></a> in PHPStan:</p>
<pre><code class="language-php">use Symfony\Component\Console\Command\Command;

class AnalyseCommand extends Command
{
    // ...

    protected function execute(InputInterface $input, OutputInterface $output): int
    {
        $container = $this-&gt;containerFactory-&gt;createFromConfig($input-&gt;getOption('config'));

        $someService = $container-&gt;get(SomeService::class);
        // ...
    }
}</code></pre>
<p>Or in <a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer/blob/0257ccae7ddcbdd5f7d51de3ae92ffac02d0e1c1/src/FixerFactory.php#L107"><code>FixerFactory</code></a> in PHP CS Fixer:</p>
<pre><code class="language-php"># much simplified

class FixerFactory
{
    public function registerBuiltInFixers()
    {
        static $fixers = [];

        foreach (Finder::findAllFixerClasses() as $fixerClass) {
            $fixers[] = new $fixerClass;
        }
    }
}</code></pre>
<h3 id="Disadvantages">❌ Disadvantages</h3>
<ul>
<li>Well, ambiguous approach to creating service-like-classes.</li>
<li>There is an inconsistent approach to services. How do you know where to put it? Is it a service or is it a class to be created manually?</li>
<li>Should you inject dependency manually or let container (or any higher service) handle that?</li>
</ul>
<h3 id="Advantages">✅ Advantages</h3>
<ul>
<li>It's better than no container at all.</li>
<li>It gives at least some basis for future refactoring.</li>
<li>Very useful for collecting of minimal basic classes: like rules in PHPStan, Fixers in PHP CS Fixer or Sniffs in PHP Code Sniffer.</li>
</ul>
<p><br></p>
<p><strong>Imagine a code like this in your web application</strong>:</p>
<pre><code class="language-php">class ProductController
{
    /**
     * @var Connection
     */
    private $connection;

    public function __construct(Connection $connection)
    {
        $this-&gt;connection = $connectoin;
    }

    public function detail($id);
    {
        $productRepository = new ProductRepository($this-&gt;connection);
        $product = $productRepository-&gt;get($id);

        // ...
    }
}</code></pre>
<p>How do you feel about it?</p>
<h3 id="Injection-Inception-Problem">Injection Inception Problem</h3>
<p>CLI apps authors often struggle with the question: <em>When should be the container created</em>?</p>
<ul>
<li>In a bin file?</li>
<li>In a <code>Command</code>?</li>
<li>And how to get any service container outside the <code>Command</code> scope?</li>
<li>How to share services between 2 <code>Command</code>s?</li>
<li>How to avoid creating container in every single <code>Command</code>?</li>
</ul>
<p>And how to create container <strong>when user provides config with services via <code>--config</code> option</strong>?
The complexity of this question usually leads to choice 2 or 1.</p>
<p>I won't get into more details now, since I'll write about possible solutions in following posts.</p>
<img src="/assets/images/posts/2018/cli-app-di/inject-inception.jpg" class="img-thumbnail">
<p>This application cycle has these steps:</p>
<ul>
<li>call bin file</li>
<li>create <code>Application</code> with <code>new</code></li>
<li>add commands with <code>$application-&gt;add(new SomeCommand)</code></li>
<li>run <code>Application</code></li>
<li>in called command, there are 2 approaches
<ul>
<li>
<ol>
<li>create a container
<ul>
<li>load it with few services</li>
<li>use these services in the scope of this command</li>
</ul></li>
</ol>
</li>
<li>
<ol start="2">
<li>create other classes with <code>new</code>
<ul>
<li>sometimes add them to the container, so they can be used later</li>
<li>sometimes add use them in scope and re-create them again when needed</li>
</ul></li>
</ol>
</li>
</ul></li>
</ul>
<p>Compare it to a web application:</p>
<ul>
<li>call <code>www/index.php</code> file</li>
<li>create dependency injection container</li>
<li>get <code>Application</code> from it</li>
<li>run it with the current request</li>
<li>invoke controller and all other needed services in the scope of this controller</li>
</ul>
<h2 id="3-Symfony-Console-meets-Symfony-DependencyInjection">3. Symfony\Console meets Symfony\DependencyInjection</h2>
<p>Why not inspire by web apps, where Controllers are lazy and dependency injection is the first-class citizen?
Moreover, Symfony 3.4 allows <a href="https://symfony.com/blog/new-in-symfony-3-4-lazy-commands">Lazy Commands</a>, that make application cycle more and more similar to web apps. Be careful - <strong>there are few WTFs during migration to Lazy Commands</strong>, <a href="https://blog.shopsys.com/5-5-steps-to-migrate-from-symfony-2-8-lts-to-symfony-3-4-lts-in-real-prs-50c98eb0e9f6">as Shopsys describes</a>.</p>
<pre><code class="language-php"># bin/rector

// ...

$container = $kernel-&gt;getContainer();

$application = $container-&gt;get(Application::class);
$application-&gt;run();</code></pre>
<h3 id="Disadvantages">❌ Disadvantages</h3>
<ul>
<li>You need to rethink the <a href="/blog/2018/04/26/how-i-got-into-static-trap-and-made-fool-of-myself/">static <code>new</code> service approach</a>, if you're used to it.</li>
</ul>
<h3 id="Advantages">✅ Advantages</h3>
<ul>
<li>Web apps = CLI apps, nothing extra to learn for new contributors, even though they contribute a CLI app for their first time.</li>
<li>You can use all <a href="/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3/">Symfony 3.3+ super cool features</a>.</li>
<li>It's much easier to scale architecture than with non-container apps.</li>
<li>You can drop a lot of boilerplate code that sticks code together and simulates container, like singletons, <code>static::$vars</code> inside classes etc.</li>
<li>You can avoid bugs caused by unexpected behavior - like object, that looks like services but is created in 2 different places and holds different variables.</li>
</ul>
<h2 id="How-To-Migrate-from-1-to-3">How To Migrate from 1 to 3?</h2>
<p>I wish there was Rector for that like there is <a href="/blog/2018/04/02/rectify-turn-repositories-to-services-in-symfony/">for Doctrine Repositories as Services</a>, but it is a too complex task at the moment. Maybe one day.</p>
<p>In the meantime you can use few guides:</p>
<ul>
<li><a href="https://github.com/symplify/coding-standard#use-services-and-constructor-injection-over-static-method"><code>ForbiddenStaticFunctionSniff</code></a></li>
<li><a href="https://github.com/symplify/coding-standard#use-service-and-constructor-injection-rather-than-instantiation-with-new"><code>NoClassInstantiationSniff</code></a></li>
<li><a href="https://stackoverflow.com/questions/19321760/symfony2-how-to-access-the-service-in-a-custom-console-command/46007150#46007150">Stackoverflow: How to access the service in a custom console command?
</a></li>
<li><a href="https://blog.shopsys.com/5-5-steps-to-migrate-from-symfony-2-8-lts-to-symfony-3-4-lts-in-real-prs-50c98eb0e9f6">5,5 Steps to Migrate from Symfony 2.8 LTS to Symfony 3.4 LTS in Real PRs</a></li>
</ul>
<p><br></p>
<p>That's what works for me in CLI apps I've been working on. Look for yourself to get real code inspiration:</p>
<ul>
<li><a href="https://github.com/rectorphp/rector">Rector</a>,</li>
<li><a href="https://github.com/apigen/apigen">ApiGen</a>,</li>
<li>and <a href="https://github.com/symplify/easy-coding-standard">EasyCodingStandard</a>.</li>
</ul>
<p><br></p>
<p><strong>Which approach do you find the best in your own practice for the long-term code?</strong></p>
<p><br><br></p>
<p>Happy injecting!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/05/07/why-you-should-combine-symfony-console-and-dependency-injection</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 07 May 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/05/07/why-you-should-combine-symfony-console-and-dependency-injection#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How Do You Treat Your Own First AI? ]]></title>
                <link>https://tomasvotruba.com/blog/2018/05/03/how-do-you-treat-your-own-first-ai</link>
                <description><![CDATA[ <p>Artificial intelligence is at boom the last couple of years. I wrote about AI and its relation to <a href="/blog/2017/12/04/life30-what-will-you-do-when-ai-takes-over-the-world/">jobs development</a> in following years.</p>
<p>Now we'll try to look a bit closer. Not in time, but in space. Take a look around you, what do you see?
Do you see <em>your own first</em> AI already? And how do you treat it?</p> ]]></description>
                <content:encoded><![CDATA[ <p>Artificial intelligence is in its very basic form just a network of neurons connected in a specific way.
It might be a multi-layer network, it might be a deep-learning network, it might be a network designed to error rate lowering or high-speed learning. But still, it is just a set of neurons with specific weights that try to balance to achieve the certain goal.</p>
<p><strong>In short: if you want to recognize pizza from non-pizza, you can teach it and it can do it.</strong></p>
<p>I'm watching this purely machine-software discussion, by <a href="/blog/2017/12/04/life30-what-will-you-do-when-ai-takes-over-the-world/">reading books</a> or <a href="https://www.mlprague.com">visiting conferences</a> and see a connection to psychology, mentoring, education and human evolution itself in general.</p>
<p>(A psychotherapist friend of mine saw this inter-field connection as an <a href="https://en.wikipedia.org/wiki/Eugenics">eugenics</a>, but that's probably of lack of understanding of what programming and artificial intelligence is).</p>
<h2 id="Human-Brain-AI">Human Brain ~= AI?</h2>
<p>Before too much term reduction that leads to vague and irrelevant comments like &quot;humans are not machines&quot;, I don't think a human brain is just a form of artificial intelligence. It's much more than that, with subconsciousness, emotions, neurotransmitters, like serotonin, adrenalin, cortisol etc. When used properly, it's a killing machine that no general artificial intelligence can ever beat.</p>
<p><strong>When used properly.</strong></p>
<p>And that's what this post is about. <strong>How we use this grey thing we've got in our skulls, how do we take care of it, what direction and why we build it</strong>.</p>
<h2 id="Child-the-First-Program">Child, the First Program</h2>
<p>If you have a child (or anyone else you teach on daily basis for a long time) and you're a programmer, you probably already thought about this, in some way.</p>
<p>The way we build a neural network in children is very powerful. And very easy, because children have no knowledge, apart from the one we give them. It's the most effective CTRL + C (you) and CTRL + V (he or she) teaching we'll ever experience. Have you ever tried to teach your partner something completely new without any basic pre-steps?</p>
<p>They say that first 5-6 years are crucial for children:</p>
<pre><code>In the first five years of life, your child’s brain develops more and faster than at any other time in his life. Your child’s early experiences – the things he sees, hears, touches, smells and tastes – stimulate his brain, creating millions of connections. This is when the foundations for learning, health, and behavior throughout life are laid down.
&lt;footer class="blockquote-footer"&gt;&lt;a href="http://raisingchildren.net.au/articles/child_development.html"&gt;Child development: the first five years&lt;/a&gt;&lt;/footer&gt;</code></pre>
<p></blockquote></p>
<h2 id="BIOS-Axioms-a-k-a-Core-Beliefs">BIOS Axioms a.k.a. Core Beliefs</h2>
<p>Jesus power, psychosomatic self-healing or the hand of the Universe all-mighty. Whatever you believe is true in your own brain design. The same way we configure a computer program to work with maximum 2 GB memory although there is more than 8 GB RAM in total, it believes there are only 2 GB of memory in the whole universe.</p>
<p>We function the same way. If you believe that you have to work until you're 65 years old and then you'll get a reward in form of retirement, you'll build your life around it. If you believe that all you need for life is a place to sleep, good friends and helping others, you'll be &quot;working&quot; for the whole life on this image. There is no good, nor wrong, nor a better way to do things - it's the way axioms are applied to the whole neural system.</p>
<h2 id="What-3-Axioms-Would-You-Put-in-Your-BIOS">What 3 Axioms Would You Put in Your <em>BIOS</em>?</h2>
<p>My selection would be:</p>
<h3 id="1-No-Expectations">1. No Expectations</h3>
<p>Living in the present moment with minimal influence of linear regression of past experiences. Because only this way we can learn something new, or <a href="https://zenhabits.net/unschoolery">rather unlearn</a> patterns that work no more. This will be a huge challenge for disruptive changes in AI itself.</p>
<p>This is super difficult because neural networks naturally tend to build on experience. How can you recognize an apple? Because your parents showed you an apple 300 times and said &quot;apple&quot;. How can we remove such expectations and still be able to live in society?</p>
<h3 id="2-Re-validate-Core-Beliefs-from-Time-to-Time">2. Re-validate Core-Beliefs from Time to Time</h3>
<p>In my first 6 years, I probably learned dichotomic perception of worlds. This is good and this is bad, nothing like &quot;it depends&quot;, &quot;well sometimes&quot; or &quot;you and somebody else might be different persons&quot;.</p>
<p>With these base-stones I've decided that alcohol is bad, social networks are for stupid people and that I know best what everybody needs to do. I tried to re-evaluate this from time to time, but it wasn't until 25 years and my first child, till I really started. Why? Because I realized I'll just copy-paste to him all my beliefs, whether I want it or not. Did I want him to be like me? Yes, of course. But did I want to believe in dichotomic worlds of ego? Not at all.</p>
<p>Since that moment I started to think what kind of son I'd like to have and started to move from personal benefits, more and more to the community, the power of united group over individual hedonist and communication with people with different values than I have.</p>
<h3 id="3-Emotions-are-just-Navigation">3. Emotions are just Navigation</h3>
<p>I tend to suppress anger, fear, shame or love (because of fear of rejection). And other people didn't understand me, and my son didn't understand me when I was angry when he crossed a street where a car could kill him. I had to change that.</p>
<p>Without clear emotion expression, it's very difficult for others to understand us. Some people express kindness when afraid, I express happiness when I'm nervous.</p>
<p>So being ok with all kinds of emotions would be a 3rd axiom I'd pick.</p>
<h2 id="Re-Evaluate">Re-Evaluate...</h2>
<h3 id="Daily">...Daily</h3>
<p>You know the saying that it takes <a href="https://www.huffingtonpost.com/james-clear/forming-new-habits_b_5104807.html">21 days to build a habit</a>? That's because neural network is like a muscle. If you train it enough one direction, it will become natural for it.</p>
<p>What beliefs you reinforce every day? What are those you'd like to change a bit if that was possible?</p>
<h3 id="Personally">...Personally</h3>
<p>This is very typical for all the self-help posts and books you've read, but there is still nothing going on. This is also called <a href="https://en.wikipedia.org/wiki/Anecdotal_evidence">Anecdotal evidence</a>.</p>
<p>What works for me, works for me because of my history, my life events, and my complex settings. If somebody will start open-source berserk mode on Github, joining PHP communities and having a baby at the same time, it might not go so well.</p>
<p><strong>So always think about yourself, whether this or that information is useful for you personally.</strong></p>
<p>In both cases beware of <em>nihilism</em>, that leads evolution nowhere. In circles. And beyond.</p>
<h2 id="Everything-is-Optional">Everything is Optional</h2>
<p>Another idea I have is <strong>that everything is optional</strong>. If I believe that I should be a programmer, I'll do everything to make that happen. But when I start to think about myself as a writer and a person who loves to connect people no matter what, I can slowly drop programming from my daily activities.</p>
<p>So when you decide that you can quit your job, find a new partner, move from your parents, write a post about that stuff you love doing after work for free or go out and just be one day alone, I believe you can do it.</p>
<h2 id="Baby-Steps">Baby Steps</h2>
<p>I wrote that neural network is a muscle. I found out when I tried to learn too many things at once, you know <a href="/blog/2017/11/13/7-tips-you-should-know-before-going-to-university/">in university</a>, I very quickly forgot all this. I read this book about healing traumas and it has very nice approach between lines in every chapter:</p>
<blockquote>
    "The slower you go, the further you get."
</blockquote>
<p>Do you want to run a marathon? Maybe it's not a good idea to run it right away without training. Personally, I've tried to train 1 month before it and went running for 4times before I run a half marathon. But I was dead and I never want to do that again.</p>
<p>If we'd train our neural networks this way, there would be tons of closed doors soon.</p>
<p>On the other hand, most of the changes that I took slowly, like programming, turned out to be pretty well.</p>
<img src="/assets/images/posts/2018/ai/kaizen.jpg" class="img-thumbnail">
<p>This is called <a href="https://medium.com/the-mission/get-1-better-every-day-the-kaizen-approach-to-self-improvement-b79c9e045678">Kaizen</a> and <a href="https://www.petrludwig.com">Petr Ludwig</a> is doing a great job of popularizing this term.</p>
<h2 id="Neural-Network-Natural-Replication">Neural Network Natural Replication</h2>
<p>One last thing that I've noticed is that neural networks have natural tendency to replicate themselves. But not only the outer way, like telling your friend he should be programmer instead of working at McDonald's.</p>
<p>But also the inner way, in ourselves. How? When we believe in freedom at work, freedom out of national borders, freedom with drugs, with Zen spirituality... we might want freedom in relationships. Or we believe in God, strict Christianity church, strict rules, we have sex with a random stranger and we'll get pregnant. We have to keep the baby because we believe all this cohesion (true story of my friend).</p>
<p><strong>One example for all?</strong> This post is just set of my thoughts that want to be replicated or rather reflected in your neural network. In human words: I want to inspire you, to talk about this, to think about this, to give me your view of all this.</p>
<p>This all leads me to my axiom point 2., to re-evaluate what value I spread in the world and my little son.</p>
<p><br></p>
<p>So these are few thoughts from my neural network about other neural networks. Nothing more.</p>
<p>I'm happy I finally opened this topic, after 14 months of just thinking of it. <strong>I wonder, how do you see your brain?</strong></p>
<p><br><br></p>
<p>Happy self-programming!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/05/03/how-do-you-treat-your-own-first-ai</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 03 May 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/05/03/how-do-you-treat-your-own-first-ai#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Programming = Climbing a Huge Mountain ]]></title>
                <link>https://tomasvotruba.com/blog/2018/04/30/programming-climbing-a-huge-mountain</link>
                <description><![CDATA[ <p>Let's take a break after 2 long code-posts from last week and enjoy bit of philosophy. I apply <em>the mountain climber</em> in programming for last 2 years and it really helps me to overcome difficult spots.
<br><br>
Today we'll climb together.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Just a year ago I was deep-train traveling southern Europe and I worked on ApiGen (here <a href="/blog/2017/09/04/how-apigen-survived-its-own-death">is a short story about that work</a>/). I worked on a migration of the most coupled dependency, which was unmaintained for 3 years, to new one. You can imagine it like migration your application from Nette to Symfony or from Doctrine to Eloquent (or vice versa).</p>
<h2 id="Rushing-Up-is-Rushing-to-Fuck-Up">Rushing Up is Rushing to Fuck-Up</h2>
<p>First I approached this problem in very... how do they say it... agile way. Let's start committing and see what happens. I was sure I'll be over after a week. Well, I wasn't and I was angry at myself. The faster I tried to finish it the slower I went.</p>
<p>And this rush got me to a situation I had to revert the whole PR and start over again, after a week of work.</p>
<h2 id="Know-Your-Path">Know Your Path</h2>
<p>Then I stopped for a while and thought: Okay, I'm here under the mountain, there is the peak and want to get there. I don't see the peak or the way, I just know I want to climb this mountain.</p>
<img src="/assets/images/posts/2018/climb/climb-2.jpg" class="img-thumbnail">
<p>I had one package and I wanted to switch to the other. What are the minimal steps?</p>
<h2 id="Make-Safe-Spots">Make Safe Spots</h2>
<p>When you climb a mountain for the first time, you have rope, a buddy and clinch along the whole way.</p>
<img src="/assets/images/posts/2018/climb/climb-1.jpg" class="img-thumbnail">
<p><strong>These are all the safe spots and it's ok to use them.</strong> Well, unless you'd like to die climbing.</p>
<p>In programming I apply the same principles: I have tests, static analysis, coding standard fixers and CI. Without them, I'd be lost.</p>
<p>And are there no safe spots? <strong>I take a time before climbing and prepare these spots.</strong> I'll increase the code coverage for code part I'd like to work with - and that already gives me some hints, what the path looks like.</p>
<p>The same way you prepare for the climbing - you ask other climbers how it went, what are the hacks, where are the places to rest and where you should be careful.</p>
<h2 id="Be-Safe-like-a-Pro">Be Safe like a Pro</h2>
<img src="/assets/images/posts/2018/climb/climb-3.jpg" class="img-thumbnail">
<p>As you can see, it's no shame to use the spots, <del>even</del> mainly professional climbers do that.</p>
<p><strong>Because the safer you feel, the better your brain operates and the faster you climb</strong> - either a mountain or a code you write.</p>
<h2 id="Use-Safe-Spots">Use Safe Spots</h2>
<p>If you already have such safe spots, be sure to use them. I've seen many applications that had over 30 tests but didn't actually use them - no continuous integration, no <a href="https://blog.martinhujer.cz/have-you-tried-composer-scripts">simple scripts in composer</a> that could run them locally with <code>composer run-tests</code>.</p>
<img src="/assets/images/posts/2018/climb/climb-4.jpg" class="img-thumbnail">
<p>It doesn't matter that other programmer made it, that they don't cover 100 % of the code or that they use the other test framework I don't prefer. <strong>I'm grateful there is something that will help me to climb faster and that another climber made it for me, even though he didn't have to.</strong></p>
<h2 id="Staying-in-the-Present-Moment-One-Move-at-a-Time">Staying in the Present Moment - One Move at a Time</h2>
<p>Zen, Kaizen, Ikigai, Present moment, <a href="/blog/2017/09/25/3-non-it-books-that-help-you-to-become-better-programmer/#deep-work-by-cal-newport">Deep Work</a>, Flow. Whatever you call it, it matters.</p>
<p>When I program, I don't know what will happen in next 15 minutes. Maybe it will be over, or maybe I'll find a bug that I'll investigate for 2 hours in a row and then <a href="https://github.com/TomasVotruba/tomasvotruba.com/commit/a890d5100e2226d4958504a50efa282fd1b2c4a1">use this workaround</a>.</p>
<img src="/assets/images/posts/2018/climb/climb-5.jpg" class="img-thumbnail">
<p>I don't see the end, only the next step. Same is for climbing, I don't see the top of the mountain. I barely see 5 meters ahead of me. But even if I see the top of the mountain it doesn't matter. I can only move my hands or legs just a few feet ahead of me.</p>
<blockquote class="blockquote">
    The present moment contains past and future.
    <br>
    The secret of transformation is in the way we handle this very moment.
    <footer class="blockquote-footer">Thích Nhất Hạnh</footer>
</blockquote>
<p>One <a href="https://www.amazon.com/Peace-Every-Step-Mindfulness-Everyday/dp/0553351397">Peace Step</a> at a Time  (great book, just reading it). One commit at a time. One merged pull-request at a time. Not 2, just 1.</p>
<h2 id="Take-a-Break">Take a Break</h2>
<p>When you're tired, frustrated, angry or sad, will you rush to climb more and more steps? No, you'd take a break. Just hang on the rope for a while (not by the neck, it's not healthy!)... well, for <a href="https://lifehacker.com/52-minute-work-17-minute-break-is-the-ideal-productivi-1616541102">17 minutes</a> as I learned in one of the amazing <a href="https://www.danpink.com/pinkcast">Pinkcasts</a>.</p>
<p>It might be a coffee, it might be a transfer to another train, it might be toilet visit.</p>
<img src="/assets/images/posts/2018/climb/climb-6.jpg" class="img-thumbnail">
<p>You probably won't believe it, but most breakthroughs come to me in the toilet room (intellectual, not physical damaging any part of the toilet).</p>
<p>Why? Because when the brain enters <em>the serendipity-mode</em>, it starts to think subconsciously and connect thoughts more effectively than with active thinking. For example, a few paragraphs up I made a workaround because key in the array didn't match the <code>PostFile</code> <code>id</code> in one spot. It worked in 3 other places in the application, but 1 just missed it. Then in my <em>toilet time</em>, it came to me that this can be solved by using a collection. One iterable immutable object everywhere.</p>
<p>Well, now it's like standing on the top of the hill and seeing the elevator that was on the left side all along. But when I was under the mountain, I didn't see it. I needed to take a break to see.</p>
<h2 id="The-Mountain-Climber-Way">The Mountain Climber Way</h2>
<p>So this is my climbing approach to code (I'm not a climber, to be clear).</p>
<img src="/assets/images/posts/2018/climb/climb-7.jpg" class="img-thumbnail">
<p>The more you climb, the better you know the terrain and the more you can improvise. <a href="https://www.nationalgeographic.com/adventure/features/athletes/alex-honnold/most-dangerous-free-solo-climb-yosemite-national-park-el-capitan">Like this guy, who climbed a 3000-feet tall mountain in 4 hours</a>. <strong>Without a rope.</strong></p>
<p><br></p>
<p><strong>And how do you approach your coding?</strong></p>
<p><br><br></p>
<p>Happy climbing!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/04/30/programming-climbing-a-huge-mountain</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 30 Apr 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/04/30/programming-climbing-a-huge-mountain#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How I Got into Static Trap and Made Fool of Myself ]]></title>
                <link>https://tomasvotruba.com/blog/2018/04/26/how-i-got-into-static-trap-and-made-fool-of-myself</link>
                <description><![CDATA[ <p>PHP story with code examples, copy-cat killers, just a little bit of static, consistency, sniffs and way to prevent all that ever happening ever again.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Today the format will be reversed - first I'll show you practical code and its journey to legacy, then theory takeaways that would save it.</p>
<p><a href="https://github.com/symplify/coding-standard">Symplify\CodingStandard</a> contains complex Sniff and Fixers like <a href="/blog/2017/12/17/new-in-symplify-3-doc-block-cleaner-fixer/">the doc block cleaner</a>. Job of <code>RemoveUselessDocBlockFixer</code> is clear - <strong>remove any doc block that has no extra value over the php code itself</strong>:</p>
<pre><code class="language-diff"> /**
- * @param int $value value instance
- * @param $anotherValue
- * @param SomeType $someService A SomeType instance
- * @return array
  */
 public function setCount(int $value, $anotherValue, SomeType $someService): array
 {
 }</code></pre>
<p>The goal is clear, but <strong>how does it work beneath the surface</strong>? There are multiple steps that Fixer needs to perform one by one:</p>
<ul>
<li>find a method</li>
<li>find its docblock</li>
<li>find parameters in method code, detect their names and types</li>
<li>compare them to docblock</li>
<li>judge value of description (e.g. &quot;a Type instance&quot; has no value)</li>
<li>remove those that were found useless</li>
</ul>
<p>Is that all? Nope. <strong>There also code that handles php docs</strong>:</p>
<ul>
<li>doc block parser that can parse any doc comment</li>
<li>that can handle invalid and non-standard formats</li>
<li>and a doc block printer, that can keep the original spacing</li>
</ul>
<p>Just a reminder, this all started with a simple idea:</p>
<pre><code class="language-diff">-/**
- * @param int $value
- */
 public function compute(int $value)
 {
 }</code></pre>
<p>Today I'll write about <strong>how code always grows and that we should anticipate it and code the best way we know right from the beginning</strong>. And what happened to me when I thought I could handle it by <em>using static methods only where it makes sense</em> (well, everything makes sense, until it's legacy drowning you down).</p>
<h2 id="Story-Of-Static-Growth">Story Of Static Growth</h2>
<p>Let's look how the fixer grew to the point it turned into legacy, how that shot myself and what I could (and will) do better to prevent it.</p>
<p>(To skip irrelevant details, I'll use pseudocode instead of <a href="https://github.com/symplify/symplify/blob/5603ed130bfd29bfdad050b7726b9c8e65a558fd/packages/CodingStandard/src/Fixer/Commenting/RemoveUselessDocBlockFixer.php">original full code</a>.)</p>
<pre><code class="language-php">class RemoveUselessDocBlockFixer
{
    public function fix($tokens)
    {
        foreach ($tokens as $token) {
            if (! $token-&gt;isMethod()) {
                continue;
            }

            // it's a method!
            $docBlock = $this-&gt;getDocBlockByMethod($token);
            if ($docBlock === null) {
                continue;
            }

            // it has a doc block!
            $this-&gt;removeUselessContentFromDocBlock($docBlock);
        }
    }
}</code></pre>
<p>That's a basic workflow. In Easy Coding Standard 3 and below, checkers have no constructor injection, only <code>new</code> and <code>::static</code> methods were allowed. I took this inspiration from <a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer/search?utf8=%E2%9C%93&amp;q=new+TokensAnalyzer&amp;type=">PHP CS Fixer where <code>new</code> is a first class citizen</a>. There is no DI container, just static instantiations. Maybe that should warn me, but I said to myself &quot;it's a popular package, it has new fixers from time to time and it's tagged once a while, it must be good and they know what they're doing&quot;.</p>
<p>So back to the code:</p>
<pre><code class="language-php">public static function getDocBlockByMethod($token)
{
    $docBlockPosition = DocBlockFinder::find($token);
    if ($docBlockPosition === null) {
        return null;
    }

    return DocBlockFactory::createFromPosition($docBlockPosition);
}</code></pre>
<pre><code class="language-php">public static function removeUselessContentFromDocBlock($docBlock)
{
    DocBlockCleaner::processParamAnnotations($docBlock);
    DocBlockCleaner::processReturnAnnotations($docBlock);
}</code></pre>
<h3 id="Static-with-3rd-Party-Code">Static with 3rd Party Code?</h3>
<p>You see where it goes. The biggest potential black hole is always 3rd party code (unless it's your code). I could write the docblock parser myself or make use of <a href="https://github.com/phpDocumentor/ReflectionDocBlock">phpDocumentor/ReflectionDocBlock</a>. It was the best on the market in that time. Neither ready for PHP 5.5+ features like variadics nor formatter preserving printer. Except that it worked pretty well.</p>
<pre><code class="language-php">class DocBlockFactory
{
    public static function createFromPosition($docBlockPosition)
    {
        $tagFactory = new StandardTagFactory($fqsenResolver, [
            'param' =&gt; TolerantParam::class, // own overloaded class
            'return' =&gt; TolerantReturn::class, // own overloaded class
            'var' =&gt; Var_::class, // own overloaded class
        ]);

        $descriptionFactory = new DescriptionFactory($tagFactory);
        $tagFactory-&gt;addService($descriptionFactory);
        $tagFactory-&gt;addService(new TypeResolver($fqsenResolver));

        $phpDocumentorDocBlockFactory = new DocBlockFactory($descriptionFactory, $tagFactory);

        return $phpDocumentorDocBlockFactory-&gt;create($docBlockPositoin);
    }
}</code></pre>
<p>So every time a single doc block is created, more than 10 classes (counting these on background) are created too. It might be a small deal for performance, but even bigger for legacy code smell that might hit me back later. But whatever, YOLO!</p>
<p>And here all the static fun ends. Well, not yet, because it worked. I talked a lot with the maintainer of <code>phpDocumentor/ReflectionDocBlock</code> about moving it forward, but as I was the only one trying, it didn't lead much further than issue chats and PRs that were opened for too long. It was only logical that without monorepo all the time was swallowed only by maintenance of 4 interdependent packages.</p>
<h3 id="A-New-Shiny-Package">A New Shiny Package?</h3>
<p>Then <a href="https://github.com/JanTvrdik">Jan Tvrdík</a> came with a support package for PHPStan for handling php docs - <a href="https://github.com/phpstan/phpdoc-parser">phpstan/phpdoc-parser</a>. It is built on similar principles as <code>nikic/php-parser</code>, much younger and robust.</p>
<p>I thought: &quot;I'd like to try that one package in my code&quot;, but how?</p>
<p>It's easy, just replace all the old static classes with new ones:</p>
<pre><code class="language-php">class DocBlockFactory
{
    public static function createFromPosition($docBlockPosition)
    {
        $content = $this-&gt;getContentOnPosition($docBlockPosition);

        $lexer = new Lexer;
        $tokenIterator = new TokenIterator($lexer-&gt;tokenize($content));

        $phpStanPhpDocParser = new PhpStanPhpDocParser(new SomeDependency(new AnotherDependency));

        return $phpStanPhpDocParser-&gt;parse($tokenIterator);
    }
}</code></pre>
<h3 id="Adding-Depedency-to-Static-Hell-Tree">Adding Depedency to Static Hell Tree</h3>
<p>Do you need to add whitespace config? Just add it in every layer... or make it also static.</p>
<pre><code class="language-diff"> class DocBlockFactory
 {
     public static function createFromPosition($docBlockPosition)
     {
         $content = $this-&gt;getContentOnPosition($docBlockPosition);

         $lexer = new Lexer;
         $tokenIterator = new TokenIterator($lexer-&gt;tokenize($content));

         $phpStanPhpDocParser = new PhpStanPhpDocParser(new SomeDependency(new NewAnotherDependency));

-        return $phpStanPhpDocParser-&gt;parse($tokenIterator);
+        $docBlock = $phpStanPhpDocParser-&gt;parse($tokenIterator);
+        $docBlock-&gt;addWhitespaceConfig($this-&gt;whitespaceConfig);
+
+        return $docBlock;
    }
+
+    public function setWhitespaceConfig(WhitespaceConfig $whitespaceConfig)
+    {
+        $this-&gt;whitespaceConfig = $whitespaceConfig;
+    }
}</code></pre>
<p>But what if you forget to add it</p>
<pre><code class="language-diff">+    public function ensureWhitespaceConfigIsSet()
+    {
+        if ($this-&gt;whitespaceConfig) {
+            return;
+        }

+        throw new WhitespaceConfigNotSetException(sprintf('Informative message in "%s" method', __METHOD__));
+    }</code></pre>
<p>Congratulations, you've just made a static container all over your code, similar to Laravel Facades.
Uff, I just get headache by writing this code.</p>
<p>But why stopping there? Let's add a configuration that will tell the <code>DocBlockFactory</code> if the starting tag should be <code>/*</code> or <code>/**</code>.</p>
<p>Well, shoot me now!</p>
<h2 id="How-to-Get-From-Static-Hell">How to Get From Static Hell?</h2>
<h3 id="1-Dependency-Injection-First-Only">1. Dependency Injection <del>First</del> Only</h3>
<p>Dependency injection First. Not first, but <strong>only</strong> dependency injection.</p>
<p>I told myself - &quot;here the static method makes sense, it's just one little method&quot;. The problem is, that static methods work well only with other static methods. You simply can't inject a service to a class with static methods and use it statically.. well, to be honest, Laravel did it in facades and Reflections, but you should not. Unless you want to use such approach in the whole codebase. That would be the only valid reason to do it so.</p>
<p><strong>So be consistent in architecture pattern you pick.</strong></p>
<p>It took me <a href="https://github.com/symplify/symplify/pull/680">3</a> <a href="https://github.com/symplify/symplify/pull/693">pull</a> <a href="https://github.com/symplify/symplify/pull/723">requests</a> to get out of this mess. Not to try the new package, just to prepare the code to be able to do so. Instead, I could have a clear DI design, use one PR at a time to trying this package and other 2 PRs could have been new features.</p>
<h3 id="2-Beware-Your-Inner-Copy-Cat-Coder">2. Beware Your Inner Copy-Cat Coder</h3>
<blockquote>
<p>A copycat crime is a criminal act that is modeled or inspired by a previous crime that has been reported in the media or described in fiction.</p>
</blockquote>
<p>This all started with social learning - &quot;children see, children do&quot;. I saw static approach in Fixers in PHP CS Fixer and I was making a Fixer. So why not use it? I felt in my guts it's not the best way to go, but I was not sure why and I didn't see anybody else using DI in CLI applications. Now I know why.</p>
<p>If you ever have a feeling that there is a better way to do things but you'll see that some Tomas Votruba is doing it differently, take your time - <strong>trust yourself, your intuition guides you for a reason</strong>. Question him and propose your idea, even though it might be crazy at the start. Maybe you'll save yourself and him a few PRs and many frustrated days from climbing up the legacy hole.</p>
<h3 id="3-Sniff-It-Setup-and-Forget">3. Sniff It - Setup and Forget</h3>
<p>To prevent this 10 hours of trauma happening ever again, I made <code>NoClassWithStaticMethodWithoutStaticNameRule</code> that will look after our code.</p>
<p>❌</p>
<pre><code class="language-php">class SomeClass
{
    public static function someFunction()
    {
    }
}</code></pre>
<p>✅</p>
<pre><code class="language-php">class StaticSomeClass
{
    public static function someFunction()
    {
    }
}</code></pre>
<p>I've added this sniff to set before refactoring, scanned the code and <a href="https://github.com/symplify/symplify/pull/722/files#diff-a8b950982764fcffe4b7b3acd261cf91R84">added all found files to ignored</a>. That way I knew what all classes need refactoring.</p>
<h3 id="4-Remove-Static-from-Methods-One-Step-at-a-Time">4. Remove <code>Static</code> from Methods - One Step at a Time</h3>
<p>I always do this in one single PR, starting with the simplest factory from ignored files above.</p>
<p>Remove the <code>static</code> in one factory:</p>
<pre><code class="language-diff"> class UseImportsTransformer
 {
-    public static function addNamesToTokens(...)
+    public function addNamesToTokens(...)
 }</code></pre>
<p>Pass it via constructor:</p>
<pre><code class="language-diff"> class RemoveUselessDocBlockFixer
 {
+    /**
+     * @var UseImportsTransformer
+     */
+    private $userImportsTransformer;
+
+    public function __construct(UseImportsTransformer $userImportsTransformer)
+    {
+        $this-&gt;userImportsTransformer = $userImportsTransformer;
+    }
 }</code></pre>
<p>And use it in code:</p>
<pre><code class="language-diff">-UseImportsTransformer::addNamesToTokens($this-&gt;newUseStatementNames, $tokens);
+$this-&gt;useImportsTransformer-&gt;addNamesToTokens($this-&gt;newUseStatementNames, $tokens);</code></pre>
<h3 id="5-Keep-Your-Environment-Clean">5. Keep Your Environment Clean</h3>
<p>I also admit that another code smell lead to this. In Symplify and Rector there is used <a href="/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3/">Symfony 3.3 services architecture</a> with autowiring and autodiscovery. State of art in PHP DI at the moment.</p>
<p>But Fixers and Checkers were exceptions. They were registered as services, <strong>but not autowired</strong>. So I was used to not-to add dependency to them manually, but via setters, <code>new</code> or <code>::static</code>. It eventually and logically leads to this situation.</p>
<p>I learned something new and <a href="/blog/2018/03/26/new-in-easy-coding-standard-4-clean-symfony-standard-with-yaml-and-services/">migrated to full-service approach in ECS 4</a>.</p>
<h2 id="3-Takeaways-You-Should-not-Take-Statically">3 Takeaways You Should not Take Statically</h2>
<ul>
<li>Static is not only <code>::method()</code>, but also <code>new &lt;class&gt;</code> and <code>::create()</code>.</li>
<li>Use dependency injection or static methods, not a mixture. <strong>Be consistent</strong> everywhere in your code, or it will eventually backfire.</li>
<li>There is no best way to do things, <strong>you just have to experience limits of various approaches and use the one that performs the best</strong>. And re-evaluate.</li>
</ul>
<p><br><br></p>
<p>They also say that:</p>
<blockquote class="blockquote">
    Wisdom is an ability to learn from others' mistakes.
</blockquote>
<p>So I hope you learned something new today!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/04/26/how-i-got-into-static-trap-and-made-fool-of-myself</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 26 Apr 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/04/26/how-i-got-into-static-trap-and-made-fool-of-myself#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Slowly Turn your Symfony Project to Legacy with Action Injection ]]></title>
                <link>https://tomasvotruba.com/blog/2018/04/23/how-to-slowly-turn-your-symfony-project-to-legacy-with-action-injection</link>
                <description><![CDATA[ <p>The other day I saw the question on Reddit about <a href="https://www.reddit.com/r/PHP/comments/8dw8x5/symfonys_controller_action_dependency_injection">Symfony's controller action dependency injection</a>. More people around me are hyped about <a href="https://symfony.com/doc/current/service_container/3.3-di-changes.html#controllers-are-registered-as-services">this new feature in Symfony 3.3</a> that allows to autowire services via action argument typehints. It's new, it's cool and no one has a bad experience with it. The ideal candidate for any code you write today.
<br><br>
Since <a href="https://forum.nette.org/en/19365-nette-framework-2-1-0-finally-released">Nette</a> and <a href="https://mattstauffer.com/blog/laravel-5.0-method-injection">Laravel introduced</a> a similar feature in 2014, there are empirical data that we learn from.
<br><br>
<strong>Today I'll share the experience I have from consulting few Nette applications with dangerous overuse of this pattern and how this one thing turned the code to complete mess.</strong></p> ]]></description>
                <content:encoded><![CDATA[ <p><em>Disclaimer: this post is not about Symfony, nor critics of its feature. It's rather about teaching, thinking about knowledge embodied in the code, an aware approach of critical thinking to information from authorities.</em></p>
<p>What is wrong with this code?</p>
<pre><code class="language-php">class SomeService extends SomeAbstractParentService
{
    public function someMethod(SomeArgument $someArgument, SomeOtherService $someOtherService)
    {
        return $someOtherService-&gt;process($someArgument);
    }
}</code></pre>
<p>It's not unreal that this code will appear in your project in next 2 years, if you start using action injection. But we'll get to that later, let's start from the beginning.</p>
<h2 id="Welcome-Action-Injection">Welcome Action Injection</h2>
<p>Since Symfony 3.3 there is <a href="https://github.com/symfony/symfony/pull/21771">a new feature</a> that allows injecting services to controller actions. It's important to this post, that Symfony <a href="https://symfony.com/doc/current/service_container/3.3-di-changes.html#controllers-are-registered-as-services">documentation includes a warning</a>: &quot;This is only possible in a controller, and your controller service must be tagged with <code>controller.service_arguments</code> to make it happen.&quot;</p>
<h3 id="Wait-Wait-What-is-this-Feature-Again">Wait, Wait... What is this Feature Again?</h3>
<p>Oh, sorry. In case you don't know what I'm talking about, here is a little example. If you do, skip right to <a href="#injection-everywhere">the pitfall of such approach</a> below.</p>
<p>If not, let's look at this example. This is the most simple and clear way to register controller as services:</p>
<pre><code class="language-php">&lt;?php

# app/Controller/SomeController.php

namespace App\Controller;

use App\Model\SomeService;

final class SomeController
{
    /**
     * @var SomeService
     */
    private $someService;

    public function __construct(SomeService $someService)
    {
        $this-&gt;someService = $someService;
    }

    public function someAction()
    {
        $someData = $this-&gt;someService-&gt;getSomeData();
        // ...
    }
}</code></pre>
<p>with basic PSR-4 autodiscovery registration:</p>
<pre><code class="language-yaml"># app/config/services.yml
services:
    App\:
        resource: '../'

    # include all controllers and model services</code></pre>
<p>The <em>argument autowire</em> (also called <em>method injection</em> or <em>action injection</em>) will save us some writing.</p>
<p>As the name suggests, dependencies won't be passed by a constructor, as it's common in every service, but via method - the action method!</p>
<pre><code class="language-diff"> # app/Controller/SomeController.php

 namespace App\Controller

 use App\Model\SomeService;

 final class SomeController
{
-    /**
-     * @var SomeService
-     */
-    private $someService;
-
-    public function __construct(SomeService $someService)
-    {
-        $this-&gt;someService = $someService;
-    }

-    public function someAction()
+    public function someAction(SomeService $someService)
     {
-        $someData = $this-&gt;someService-&gt;getSomeData();
+        $someData = $someService-&gt;getSomeData();
         // ...
     }
 }</code></pre>
<p>On the other hand, service registration is now 3x more complex:</p>
<pre><code class="language-diff"> # app/config/services.yml
 services:
-    App\:
+    App\Controller\:
-        resource: '../'
+        resource: '../Controller'
+        tags: ['controller.service_arguments']
+
+    App\Model\:
+        resource: '../Model'</code></pre>
<h3 id="What-are-Propagated-Advantages">What are Propagated Advantages?</h3>
<ul>
<li>less writing</li>
<li>manual wiring of only used services - with no benchmark this has similar value as statements like &quot;Symfony is 3x faster than Laravel, it's true&quot;</li>
<li>smaller controllers</li>
</ul>
<h3 id="What-are-Already-Known-Disadvantages">What are Already Known Disadvantages?</h3>
<p>Paul M. Jones wrote that <a href="http://paul-m-jones.com/archives/6589">“Action Injection” As A Code Smell</a>. Why?</p>
<blockquote class="blockquote">
"The fact that your controller has so many dependencies, used only in some cases and not in others, <strong>should be an indicator that the class is doing too much</strong>. Indeed, it’s doing so much that you cannot call its action methods directly; you have to use the dependency injection container not only to build the controller object but also to invoke its action methods."
</blockquote>
<p>And I agree. It's the same code smell as adding 10th action method to the <code>ProductController</code> that now has 300 lines. Maybe you should split it into 2 classes and add <a href="https://github.com/object-calisthenics/phpcs-calisthenics-rules#7-keep-your-classes-small">sniff</a> to make sure this won't happen in production code ever again (because no-one else will do it better than continuous integration).</p>
<p>But that's just words and ideas, no legacy (yet).</p>
<p>What might really happen with <em>autowired arguments</em> approach?</p>
<h2 id="1-Injection-Everywhere">1. Injection Everywhere</h2>
<img src="/assets/images/posts/2018/action-injection/everywhere.jpg" class="img-thumbnail">
<h2 id="The-Nette-Framework-Tried-It-For-You-story">The Nette-Framework-Tried-It-For-You story</h2>
<p>Nette &quot;inject&quot; feature released in 2014 in Nette 2.1 started very similarly. It has 2 ways to inject dependencies:</p>
<h3 id="A-at-inject-Annotatoin">A. <code>@inject</code> Annotatoin</h3>
<pre><code class="language-php">namespace App\Controller;

use App\Model\SomeService;

final class SomeController
{
    /**
     * @var SomeService
     * @inject
     */
    public $someService;
}</code></pre>
<h3 id="B-inject-Method">B. <code>inject*()</code> Method</h3>
<pre><code class="language-php">namespace App\Controller;

use App\Model\SomeService;

final class SomeController
{
    /**
     * @var SomeService
     */
    private $someService;

    public function injectSomeService(SomeService $someService)
    {
        $this-&gt;someService = $someService;
    }
}</code></pre>
<p>It also have to be activated in config manually with specific <code>tags: ['inject']</code> tag, as in Symfony:</p>
<pre><code class="language-yaml"># app/config/services.neon
services:
    App\Controller\SomeController:
        tags: ['inject']

    - App\Model\SomeService</code></pre>
<p>Can you see the difference to Symfony? Well, almost none. But so far so good.</p>
<p>Note to Nette programmers: <a href="/blog/2016/12/24/how-to-avoid-inject-thanks-to-decorator-feature-in-nette/"><code>@inject</code> is often a code smell and you should do it cleaner</a></p>
<h2 id="Inspire-by-Good-Bad-Example">Inspire by (Good/Bad) Example</h2>
<p>If you prepare some &quot;dirty-hack-that-none-should-use&quot; or even better &quot;don't-ever-use-this-unless-you-know-why&quot; and make it public, you can be sure people will ignore it and use it in a very creative way. Unless there is <code>new ForbiddenUseException</code> thrown.</p>
<p>This effect appeared in Nette many months before 2.1 even became stable and <a href="https://forum.nette.org/cs/13084-presentery-property-lazy-autowire-na-steroidech#p93574">method injection was born</a> (many months before Nette 2.1 even became stable):</p>
<pre><code class="language-php">final class SomeController
{
    public function someAction(SomeService $someService)
    {
        $someData = $someService-&gt;getSomeData();
        // ...
    }
}</code></pre>
<p>So far so good, right?</p>
<h2 id="Use-in-Controllers-Nowhere-Else">Use in Controllers, Nowhere Else!</h2>
<p>Do you have children? If so, you know that &quot;be careful with that fire&quot; repeated 10 times in 60 seconds will mostly lead to the exact opposite. Human brain works on <a href="https://www.youtube.com/watch?v=o9K6GDBnByk">&quot;Neurons that Fire Together Wire Together&quot;</a> principle - so the final version can sound like &quot;fire&quot;.</p>
<p>Programmers use the feature you provided. They don't know what you wrote in that single post 2 years ago, nor explore documentation for any reference they found. Sorry jako.</p>
<h3 id="Property-Method-Injection-in-all-Services">Property/Method Injection in all Services</h3>
<p>Back to our story - it didn't take long to <a href="https://forum.nette.org/cs/17817-jak-dostat-do-basecontrol-sluzbu-aniz-by-se-ji-museli-potomci-zabyvat#p125658">new idea appeared on Nette forum</a> (Czech only): &quot;I have 6 methods in <code>SomeService</code>, why should I inject all dependencies every time one public method is called? I want to use inject there as well, it's shorter and faster&quot; This is the same argument to use <em>action injection</em> in controllers, remember?</p>
<blockquote class="blockquote text-center">
    "Where is no exception, there is a way."
</blockquote>
<p>It was super easy to turn it on:</p>
<pre><code class="language-diff"> # app/config/services.neon
     services:
     App\Controller\SomeController:
         tags: ['inject']

     App\Model\SomeService:
+        tags: ['inject']</code></pre>
<p>I confess <a href="https://forum.nette.org/cs/17817-jak-dostat-do-basecontrol-sluzbu-aniz-by-se-ji-museli-potomci-zabyvat#p139678">I liked this idea too</a>. But it's too much writing... how could we add to every service?</p>
<p>A <code>Extension</code> (~= <code>CompilerPass</code>) solved it:</p>
<pre><code class="language-php">foreach ($this-&gt;getContainerBuilder() as $definition) {
    $definition-&gt;addTag('inject');
}</code></pre>
<p>Now we can remove these annoying long constructors and use property/method injection everywhere. Be careful, <a href="https://ocramius.github.io/blog/eliminating-visual-debt">this visual debt</a> is different from <a href="https://blog.sonarsource.com/cognitive-complexity-because-testability-understandability">cognitive overload</a>.</p>
<p>Now our code looks like this:</p>
<pre><code class="language-php">class SomeService
{
    /**
     * @inject
     */
    public $someOtherService;
}</code></pre>
<p>or in Symfony</p>
<pre><code class="language-php">namespace App\Model;

final class SomeService
{
    public function someMethod(SomeArgument $someArgument, SomeOtherService $someOtherService)
    {
        return $someOtherService-&gt;process($someArgument);
    }
}</code></pre>
<p><strong>3 lines and documentation is ignored. Great job!</strong></p>
<p>To achieve similar functionality in Symfony, you'd probably have to override <a href="https://github.com/symfony/symfony/pull/21771/files#diff-58d1479352b43b312746ea6ceb4ada96">this <code>CompilerPass</code></a>. I won't show you nor try on purpose, so I don't spread too much black magic here.</p>
<h3 id="Most-People-are-to-Lazy-and-Unskilled-Write-own-CompilePasses">Most People are to Lazy and Unskilled Write own CompilePasses</h3>
<p>Let's say you're right and I live in micro-open-source cosmos, where people are too lazy not to do it. Also, it's possible, that framework checks the service against interface (<code>IPresenter</code>) or a class (<code>Controller</code>), that it really is a controller.</p>
<p>But it's still possible. How? Take 3 breaths to think about it, you'll find a way.</p>
<p><br><br></p>
<p>Yes, our favorite <a href="https://ocramius.github.io/blog/when-to-declare-classes-final">composition pattern</a>.</p>
<pre><code class="language-php">namespace App\Model;

final class SomeService extends SomeAbstractService
{
    public function someMethod(SomeArgument $someArgument, SomeOtherService $someOtherService)
    {
        return $someOtherService-&gt;process($someArgument);
    }
}</code></pre>
<p>Do you know where this goes?</p>
<pre><code class="language-php">use Symfony\..\Controller;

abstract SomeAbstractService extends Controller
{
}</code></pre>
<p>Kaboom! Method injection works in <code>SomeService</code> and we bypassed the frameworks internals :).</p>
<h3 id="True-Story">True Story</h3>
<p>I must add, I'm not writing this post because I'm bored and need a topic to babble about. <strong>This is true story, such code exists and it was so much WTF to me, that I don't want my deepest enemy to have to work on project like that</strong>. And I see that Symfony framework is slowly heading a way that opened these doors.</p>
<p>It was (maybe still is) famous Czech project (can't tell you which one, but you know who you are ;)).</p>
<blockquote class="blockquote text-center">
    Everything which is not forbidden is allowed.
</blockquote>
<p>Now you know how to take advantage of framework architecture backdoor and save you lot of writing. At least in the present moment. And also how not to fall into this. It's up to you, what you like and what code you love to write.</p>
<h2 id="Is-there-a-Way-To-Save-Your-Code-From-this-Instant-Retirement">Is there a Way To Save Your Code From this Instant Retirement?</h2>
<p>There are 2 ways ho to avoid this completely and still use your framework:</p>
<p>-
Paul M. Jones has written <a href="https://paul-m-jones.com/adr">many posts about Action-Domain-Responder</a></p>
<ul>
<li>another approach is <a href="https://jenssegers.com/goodbye-controllers-hello-request-handlers">RequestHandler</a></li>
<li>my favorite approach that <a href="https://symfony.com/doc/current/controller/service.html#invokable-controllers">Symfony</a> and <a href="https://dyrynda.com.au/blog/single-action-controllers-in-laravel">Laravel</a> support by default for a long time are <strong>invokable controllers</strong>, also called <em>single action controllers</em></li>
</ul>
<h2 id="What-is-Your-Experience-with-Action-Injects">What is Your Experience with Action Injects?</h2>
<p>I really recommend checking the <a href="https://www.reddit.com/r/PHP/comments/8dw8x5/symfonys_controller_action_dependency_injection">Reddit thread</a>, there are few experiences worth reading that will save your time and energy of personal research:</p>
<blockquote class="blockquote">
I've abandoned this [action inject] approach because it makes it harder to differentiate request parameters from services. It also makes this method definition in most cases spread to multiple lines. And it makes it harder to inject non-autowirable services
    <footer class="blockquote-footer text-right">
        <a href="https://www.reddit.com/r/PHP/comments/8dw8x5/symfonys_controller_action_dependency_injection/dxsauf2/">gadelat</a>
    </footer>
</blockquote>
<p>What inject approach do you prefer? What happy or WTF inject stories do <em>you</em> have? Let me know in the comments.</p>
<p><br><br></p>
<p>Happy Injecting!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/04/23/how-to-slowly-turn-your-symfony-project-to-legacy-with-action-injection</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 23 Apr 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/04/23/how-to-slowly-turn-your-symfony-project-to-legacy-with-action-injection#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 4 Tips To Get Emotions to Your Blogging About Programming ]]></title>
                <link>https://tomasvotruba.com/blog/2018/04/19/4-tips-to-get-emotions-to-your-blogging-about-programming</link>
                <description><![CDATA[ <p>Last week I wrote about <a href="/blog/2018/04/12/the-best-5-of-256-bloghacks-book/">top 5 bloghacks</a> I found in this book.
<br>
Today I'll share with you <strong>5 tips that proven useful during my programming/self-education career</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="1-Make-Your-Post-Ideas-Public">1. Make Your Post Ideas Public</h2>
<p>This is another place where open-source beats closed-source:</p>
<img src="/assets/images/posts/2018/blogtips/github-issues.png" alt="Github issues with posts idea as issues" class="img-thumbnail">
<p><br></p>
<p>All my post ideas public and community can up-vote it, down-vote it, comment there or <strong>add your own idea</strong>:</p>
<img src="/assets/images/posts/2018/blogtips/post-idea.png" alt="Github issues outsourced" class="img-thumbnail">
<h3 id="How-to-Use-It">How to Use It?</h3>
<ul>
<li>Do you hear the same question over and over again? Put it there.</li>
<li>Do you think it's a great idea to write about &quot;Repositories in Symfony&quot;? Put it there.</li>
<li>When I want to write, I'll just look there, let my heart pick the one that's closest to its setting at the moment and start writing.</li>
</ul>
<p>And it's not only for writing itself but also for preparation. <strong>You can put also concepts there, ask people for details or up-vote it every time you see a question about it</strong>. The post content grows without you knowing it.</p>
<h3 id="Keep-it-Fit-and-Slim">Keep it Fit and Slim</h3>
<p>I got inspired by <a href="https://github.com/Ocramius/ocramius.github.com/issues">Ocramius' blog issues</a>, where is over 20 ideas now. I tried the same approach - add every idea I have. I end up having 30+ great ideas and <strong>with <a href="https://www.hanselman.com/blog/AnalysisParalysisOverthinkingAndKnowingTooMuchToJustCODE.aspx">choice paralysis</a> every time I wanted to blog</strong>.</p>
<p>Then I remembered the healing effect of minimalism on <a href="https://mikemcquaid.com/2018/03/19/open-source-maintainers-owe-you-nothing">open-source mental health</a> and <strong>set myself a limit of 10 ideas maximum</strong>. I still drop ideas here and there and from time to time check the count. <strong>If it's &gt; 10, I pick top 10 and delete the rest - ruthlessly.</strong></p>
<h2 id="2-Write-About-Pain-Points-You-Meet">2. Write About Pain Points You Meet</h2>
<p><strong>Every one of us has a passion for something</strong>. It might be quiet due to <a href="/blog/2018/03/22/how-teaching-suicides-itself-by-killing-the-passion/">school silence treatment</a>, it might be unclear to see and maybe you think about yourself, that you have nothing to extra to add to this world that hasn't been added yet. You're probably wrong.</p>
<p><strong>If you're a programmer, you have a passion for some pattern, or framework, of the way you create your code. It might be clean code, it might be Laravel, it might be a passion for this new package or complex algorithm.</strong></p>
<p>And when you meet opposite in your life, you just feel it.</p>
<p>For me, it's clearly <em>static, services locators vs. constructor and dependency injection first</em>.</p>
<p>In every <a href="https://github.com/symplify/symplify">Symplify</a> package and <a href="https://github.com/rectorphp/rector">Rector</a> I'm trying to put constructor injection first. It's often super hard and takes a lot of <a href="https://github.com/symplify/symplify/pull/693">refactoring</a> and thinking, but I go for it because I see that DI absence is the main pillar of legacy code.</p>
<h3 id="It-s-About-You">It's About You</h3>
<p>But this is not about me. <strong>It's about you.</strong> <strong>Find your topic that makes your heart racing - either from being happy or from being angry.</strong> Readers will know and will react to it. You'll reach their passion by sharing yours. And it's also a very deep source of your inner knowledge. You can write this new feature in Symfony, but that's written, done and finished. But if you write about your passion, there will always be a topic to write about, to explore.</p>
<h2 id="3-Write-Compliments-about-Others">3. Write Compliments about Others</h2>
<ul>
<li><em>How to Setup ...?</em></li>
<li><em>5 New Features in ...?</em></li>
<li><em>3 Reasons to Install ... on Your Android?</em></li>
<li><em>4 Ways to Save Time by using ...?</em></li>
</ul>
<p>Almost every programming post is like this. Everyone is writing about themselves, their products or how to use this or that software. A software.</p>
<p>But thanks to all the coding, programming, and algorithms we almost forgot about the most important thing in the world - yes the good old offline world: <strong>relations ships</strong>.</p>
<blockquote class="blockquote text-center mt-5 mb-5">
    "You can have everything in life you want,<br>
    if you will just help other people get what they want."
    <footer class="blockquote-footer">Zig Ziglar</footer>
</blockquote>
<p>This quote gets truer every year I get older.</p>
<p>Such an expression of random gratitude will shine in the world of social networks. For inspiration:</p>
<ul>
<li>
<p><a href="/blog/2017/06/01/thank-you-david/">Thank You David</a></p>
</li>
<li>
<p><a href="/blog/2016/03/03/kolik-lidi-je-potreba-k-vytvoreni-jedne-komunity">Kolik lidí je potřeba k vytvoření jedné komunity?
</a> (in Czech)</p>
</li>
</ul>
<p>Or just start slowly:</p>
<ul>
<li>
<p>Be nice about concurrency package - <a href="/blog/2017/05/29/symplify-packages-deprecations-brought-by-symfony-33/">Symplify packages deprecations brought by Symfony 3.3</a></p>
</li>
<li>
<p>Say &quot;thank you&quot; <a href="/blog/2018/04/12/the-best-5-of-256-bloghacks-book/#4-put-a-search-on-website">to a friend who lend you a book</a> you review. And <a href="/blog/2017/09/25/3-non-it-books-that-help-you-to-become-better-programmer/#steal-like-and-artist-by-austing-kleon">again to another friend</a>.</p>
</li>
</ul>
<p>Your love expressed to others will eventually get back to you, don't worry :).</p>
<h2 id="4-But-More-Importantly-Be-Yourself">4. But More Importantly, Be Yourself</h2>
<p>I've read a lot of book and tips about writing but when you step back, it's often how the <em>write would do it to enjoy it</em>. So my last tip for your is to be yourself, write about your topics, use your style. That's the thing you're naturally the best in the worlds.</p>
<p><br><br></p>
<p>Have an awesome summer day!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/04/19/4-tips-to-get-emotions-to-your-blogging-about-programming</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 19 Apr 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/04/19/4-tips-to-get-emotions-to-your-blogging-about-programming#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 5 Steps to Your First Fixer or Sniff Test ]]></title>
                <link>https://tomasvotruba.com/blog/2018/04/16/5-steps-to-your-first-fixer-or-sniff-test</link>
                <description><![CDATA[ <p>When <a href="/blog/2017/07/17/how-to-write-custom-sniff-for-code-sniffer-3/">I wrote my first Sniff</a> 4 years ago I wanted to test it. I expected testing class, that would register sniff, provide ugly code and compare it to fixed one. So I started to explore PHP_CodeSniffer looking for such feature. Found one class, second class, warnings, errors, uff and after 10th error, I closed it.
<br><br>
When <a href="/blog/2017/07/24/how-to-write-custom-fixer-for-php-cs-fixer-24/">I wrote my first Fixer</a>, the story was a bit shorter but very similar. No wonder people don't test when the entry barrier is so huge.
<br><br>
<strong>Since I use both of them and I want to motivate people to write their own sniffs and fixers, I turned this barrier to just 5 short steps</strong> for both of them.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Imagine you have a <code>LowerBoolConstantsFixer</code> that fixes all uppercase bool constants to lowercase ones:</p>
<pre><code class="language-diff">-$value = TRUE;
+$value = true;</code></pre>
<p>And nothing more. How do we take this test case to PHPUnit? That is what <a href="https://github.com/symplify/easy-coding-standard-tester">ECS Tester</a> package will help us with.</p>
<h2 id="1-Install-the-package">1. Install the package</h2>
<pre><code class="language-bash">composer require symplify/easy-coding-standard-tester --dev</code></pre>
<h2 id="2-Create-a-config-with-checker-s-you-want-to-test">2. Create a config with checker(s) you want to test</h2>
<pre><code class="language-yaml"># /tests/Fixer/LowerBoolConstantsFixer/config.yml
services:
    Your\CodingStandard\LowerBoolConstantsFixer: ~</code></pre>
<p>(<em>Checker</em> is a group name for sniff and fixer, nothing more.)</p>
<h2 id="3-Create-a-Test-Case-and-Provide-the-Config">3. Create a Test Case and Provide the Config</h2>
<p>Create a test case that extends <code>Symplify\EasyCodingStandardTester\Testing\AbstractCheckerTestCase</code> class.</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace Your\CodingStandard\Tests\LowerBoolConstantsFixer;

use Symplify\EasyCodingStandardTester\Testing\AbstractCheckerTestCase;

final class LowerBoolConstantsFixerTest extends AbstractCheckerTestCase
{
    // ...
}</code></pre>
<p>And provide the config above in <code>provideConfig()</code> method.</p>
<ul>
<li>Try to keep this standard in every test to reduce the maintenance of the test, e.g. <code>__DIR__ . '/config.yml'</code>.</li>
<li>You can also make configured test of the same checker, <code>__DIR__ . '/configured-config.yml'</code>.</li>
</ul>
<pre><code class="language-diff"> &lt;?php declare(strict_types=1);

 namespace Your\CodingStandard\Tests\LowerBoolConstantsFixer;

 use Symplify\EasyCodingStandardTester\Testing\AbstractCheckerTestCase;

 final class LowerBoolConstantsFixerTest extends AbstractCheckerTestCase
 {
     // ...

+    protected function provideConfig(): string
+    {
+        return __DIR__ . '/config.yml';
+    }
 }</code></pre>
<h2 id="4-Test-The-Checker-Behavior">4. Test The Checker Behavior</h2>
<p>You can make use of 3 testing methods:</p>
<ul>
<li><code>doTestCorrectFile($correctFile)</code> - the file should not be affected by this checker</li>
<li><code>doTestWrongToFixedFile($wrongFile, $fixedFile)</code> - classic before/after testing</li>
<li><code>doTestWrongFile($wrongFile)</code> - <strong>only for sniff</strong> - it doesn't fix, just reports</li>
</ul>
<p><br></p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace Your\CodingStandard\Tests\LowerBoolConstantsFixer;

use Symplify\EasyCodingStandardTester\Testing\AbstractCheckerTestCase;

final class LowerBoolConstantsFixerTest extends AbstractCheckerTestCase
{
    public function test(): void
    {
        $this-&gt;doTestCorrectFile(__DIR__ . '/correct/correct.php.inc');

        $this-&gt;doTestWrongToFixedFile(
            __DIR__ . '/wrong/wrong.php.inc',
            __DIR__ . '/fixed/fixed.php.inc'
        );
    }

    protected function provideConfig(): string
    {
        return __DIR__ . '/config.yml';
    }
}</code></pre>
<h2 id="5-The-Best-For-Last-Create-the-Code-Snippets">5. The Best For Last - Create the Code Snippets</h2>
<p><strong>This part you enjoy the most because your job is to break the checker</strong>... well, at least verify it behaves as you want it to behave.</p>
<p>What should it skip? Well, since <code>NULL</code> / <code>null</code> is not a bool value...</p>
<pre><code class="language-php">// correct/correct.php.inc
$value = NULL;
$value = null;</code></pre>
<p><br></p>
<p>I guess you already know the before/after part:</p>
<pre><code class="language-php">// wrong/wrong.php.inc
$value = TRUE;
$value = FALSE;</code></pre>
<p><br></p>
<pre><code class="language-php">// fixed/fixed.php.inc
$value = true;
$value = false;</code></pre>
<p>That's it!</p>
<p>Now you know all you need to be able to test any fixer or sniff. But if you want to know more, check <a href="https://github.com/symplify/easy-coding-standardTester">the ECS Tester README</a>.</p>
<p><br><br></p>
<p>Enjoy simple testing!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/04/16/5-steps-to-your-first-fixer-or-sniff-test</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 16 Apr 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/04/16/5-steps-to-your-first-fixer-or-sniff-test#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ The Best 5 of 256 Bloghacks Book ]]></title>
                <link>https://tomasvotruba.com/blog/2018/04/12/the-best-5-of-256-bloghacks-book</link>
                <description><![CDATA[ <p>Have you heard of <a href="http://www.yegor256.com/256-bloghacks.html"><em>256 Bloghacks</em> book</a> by Yegor? Do you think about reading it, but just don't have the time and money?
<br><br>
This post is <em>the best of</em> selection just for you and if you feel you like it, you can buy it and read as a whole.</p> ]]></description>
                <content:encoded><![CDATA[ <p>I came across this book <a href="https://www.vojtechruzicka.com/book-review-256-bloghacks">in the review by Vojta Růžička</a> on <a href="http://devblogy.tk">devblogy.cz</a> (the best place to follow Czech it bloggers by <a href="https://twitter.com/kaja47">kaja47</a> whom I'm very thankful for it). You might know <a href="http://www.yegor256.com">Yegor</a> from Java world or from
<strong><a href="http://www.yegor256.com/award.html">Software Quality Award</a> he organizes for open-source projects</strong> every year. <a href="https://arkadiuszkondas.com">A friend of mine</a> won the award with <em>the</em> machine learning package in PHP - <a href="https://github.com/jorgecasas/php-ml#awards">jorgecasas/php-ml</a> - last year.</p>
<p>Vojta was so kind to lend me the book over the lunch. This post is an answer to my first question I asked: <strong>what are the top 5 tips I should take from this book if no other?</strong></p>
<p>256 items is a lot. No matter if it's a tip, a story, a class or a food item in your home. The most of them are common, some are better and only <strong>a few are golden</strong>. I look for the gold in books, so here is what I found.</p>
<h2 id="1-Blog-Once-a-Week-for-2-Years">1. Blog Once a Week for 2 Years</h2>
<p>When I posted my first post in late 2015 and it had 24 comments and I was very happy my knowledge is worth talking about. When I posted the next one and had no responses. I was frustrated and felt hopeless and as a just not good enough writer. So I stopped blogging for a few months.</p>
<p>I see now that it was a mistake, so the first tip is <strong>to blog once a week</strong>. Life is trying to tell me over and over again, that <a href="https://medium.com/@anthony_moore/consistency-beats-talent-luck-good-intentions-and-even-quality-66ba255aa4f7">Consistency Beats Talent, Luck, Good Intentions, and Even Quality</a>.</p>
<p>But not more often. I tried to blog 2x a week, right from the start and got burnout lesson (what a surprise). After a year of weekly blogging, I felt I want to blog more often and add a Thursday post. Very carefully, just once a month. Now after a couple of months I feel confident enough to write about it.</p>
<div class="card mb-5">
    <div class="card-body">
        <strong>Tip summary</strong>: start blogging slowly, once a month, once a week, be persistent and wait 1-2 years before getting the popularity.
    </div>
</div>
<h2 id="2-Be-Active-on-Reddit">2. Be Active on Reddit</h2>
<p><a href="https://www.reddit.com/r/PHP">Reddit</a> is like StackOverflow for personal opinions or like Devel.cz, but international and for everyone. It's a place, where people share ideas, comment it, up-vote it or down-vote it.</p>
<p>Vojta shared with me his first experience with Reddit: he posted 2-3 his posts and he got autoban. That <strong>kind of ban, when you don't know you're banned</strong> - everything works, there're up-votes on your posts, but they're all in grey. Also, Yegor wrote about the similar experience. My experience was a little better: I could post only once 10 minutes. Then I learned I could post more often when I got more profile points (up-votes of my ideas and posts).</p>
<h3 id="Get-what-you-Give">Get what you Give</h3>
<p>That's the way of Reddit to tell you: <strong>You've got to give to get.</strong> I tried this tip, I'm voting and engage in discussions. I must admit, it was not out of altruistic unconditional love to the world. It was to get my posts be seen. But thanks to this, <strong>I started to be open to others' opinions, learned about few weaknesses in my communication and often learned something new.</strong></p>
<p>And this could be at any other community, whether you like Twitter, Facebook, Slack, Github or Stackoverflow.</p>
<div class="card mb-5">
    <div class="card-body">
        <strong>Tip summary</strong>: pick an online community and start to learn how it works. It might take time, weeks or months, but you'll get there. Become a member. What you give, will get back to you.
    </div>
</div>
<h2 id="3-Use-Static-Website-Generator">3. Use Static Website Generator</h2>
<p>This blog runs on <a href="http://statie.org">Statie</a> and <a href="https://github.com/tomasvotruba/tomasvotruba.com">is fully open-sourced on Github</a> (found a <em>tyop</em> here? just edit this file and send a PR - there is a link right at the top right of this post).</p>
<p>I love open-source and did this right from the start, but it feels so important to me that I mention this tip again. Also, I had a meeting with Vojta and he told me <a href="https://www.vojtechruzicka.com/gatsby-migration">how he migrated from Wordpress to GatsbyJS</a> (ReactJS-based static generator) and how he loves it.</p>
<p>Static websites are fast, simple, easy for your fan/critics-base to work with and most importantly - open. No secrets, copy anything you like.</p>
<div class="card mb-5">
    <div class="card-body">
        <strong>Tip summary</strong>: use any <a href="https://www.staticgen.com/">static generator</a> you feel is the right choice for you, put it on Github and put a link to every page, so people can edit it. Who didn't have a typo fix as a first proud contribution to the open-source?
    </div>
</div>
<h2 id="4-Put-a-Search-on-Website">4. Put a Search on Website</h2>
<p>This was one of the biggest fails on my blog. Imagine you've read about &quot;symfony controller service something&quot;, you liked it, but you don't remember the exact title of the post. My blog has all posts on the main page, with no paging, so you can just use <em>Ctrl + F</em> to find... <strong>well that just sucks, right?</strong></p>
<p>Thanks to Yegor and Vojta I finally <a href="https://github.com/TomasVotruba/tomasvotruba.com/pull/286">added Google Search</a> on the homepage, so you can type &quot;symfony controller service&quot;, hit <em>Enter</em> and <a href="https://www.google.cz/search?sitesearch=tomasvotruba.com&amp;q=%22symfony+controller+service">get results you need</a>.</p>
<p>I'm sorry to all that felt frustrated when looking for any valuable content post by post, manually.</p>
<p>In case you'd like to try Algolia and <a href="https://community.algolia.com/docsearch">simple DocSearch</a> that Roman <a href="https://github.com/crazko/statie-web/commit/6c218b5d06666a098341960129617441c7cf8acb">added to Statie</a> and works very well for Statie-based website on Markdown... I tried it for you and was rejected because &quot;blog is not a documentation&quot;.</p>
<div class="card mb-5">
    <div class="card-body">
        <strong>Tip summary</strong>: working solution is better than a perfect one. Add simple stupid Google Search right from the start. I do it, Yegor does it, Google does it. Don't you know how? Just copy <a href="https://github.com/TomasVotruba/tomasvotruba.com/pull/286">these few lines</a>.
    </div>
</div>
<h2 id="5-Turn-your-Best-StackOverflow-Answers-to-Posts">5. Turn your Best StackOverflow Answers to Posts</h2>
<p>Did you provide a great answer on StackOverflow? Is that answer to duplicated and repeated questions? Do you think it might be useful to more people than StackOverflow users reading your post?</p>
<p><strong>Turn it into a blog post</strong>. I was not sure about this myself, so I tried it:</p>
<ul>
<li>
<p>Question: <a href="https://stackoverflow.com/questions/38346281/symfony-3-outsourcing-controller-code-into-service-layer/38349271#38349271">Symfony 3 - Outsourcing Controller Code into Service Layer
</a></p>
</li>
<li>
<p>Post: <a href="/blog/2017/10/16/how-to-use-repository-with-doctrine-as-service-in-symfony/">How to use Repository with Doctrine as Service in Symfony</a></p>
</li>
<li>
<p>Question: <a href="https://stackoverflow.com/questions/13901256/how-do-i-read-from-parameters-yml-in-a-controller-in-symfony2/48371606#48371606">How do I read from parameters.yml in a controller in symfony2?
</a></p>
</li>
<li>
<p>Post: <a href="/blog/2018/01/22/how-to-get-parameter-in-symfony-controller-the-clean-way/">How to Get Parameter in Symfony Controller the Clean Way</a></p>
</li>
</ul>
<p>And it works great! Now all I do is to <strong>provide a specific answer on the StackOverflow and link the post where I explain all possible pitfalls</strong>. So the question is answered and there is a follow-up, when they need to know more.</p>
<div class="card mb-5">
    <div class="card-body">
        <strong>Tip summary</strong>: Aggregate answers from StackOverflow and polish them on your blog as much as possible. Your readers will thank you and you'll make use of the energy you've already put to StackOverflow single answer. Win-win.
    </div>
</div>
<h3 id="Are-5-Tips-not-Enough-for-You">Are 5 Tips not Enough for You?</h3>
<p>Well, if you're from Prague, reach out <a href="https://www.vojtechruzicka.com">Vojta</a> and ask him about the book. He's very open-minded person and eats lunch every day.</p>
<p><br></p>
<p>Carpe postum!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/04/12/the-best-5-of-256-bloghacks-book</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 12 Apr 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/04/12/the-best-5-of-256-bloghacks-book#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Try PSR-12 on Your Code Today ]]></title>
                <link>https://tomasvotruba.com/blog/2018/04/09/try-psr-12-on-your-code-today</link>
                <description><![CDATA[ <p>The standard is still behind the door, but feedback, before it gets accepted, is very important. After accepting it will be written down and it will be difficult to change anything.
<br><br>
Try PSR-12 today and see, how it works for your code.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="PSR-12-meets-ECS">PSR-12 meets ECS</h2>
<p>Someone on <a href="https://www.reddit.com/r/PHP/comments/84vafc/phpfig_psr_status_update">Reddit referred a PSR Google Group</a>, where they <strong>asked for real-life PSR-12 ruleset implementation in a coding standard tool</strong>. Korvin Szanto already prepared 1st implementation for PHP CS Fixer, at the moment <a href="https://github.com/KorvinSzanto/PHP-CS-Fixer/commit/c0b642c186d8f666a64937c2d37442dc77f6f393">only as a commit in</a> the fork.</p>
<p>I put the ruleset to <code>PSR_12</code> set in ECS, so you can use it:</p>
<pre><code class="language-php">// ecs.php
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\EasyCodingStandard\ValueObject\Option;
use Symplify\EasyCodingStandard\ValueObject\Set\SetList;

return function (ContainerConfigurator $containerConfigurator): void {
    $containerConfigurator-&gt;import(SetList::PSR_12);
};</code></pre>
<h2 id="Do-You-Agree-or-Disagree-with-PSR12">Do You Agree or Disagree with PSR12?</h2>
<p>There are still few <a href="https://github.com/KorvinSzanto/PHP-CS-Fixer/milestones">missed cases to be covered</a>, but there is never to soon to get feedback from the community.</p>
<div class="text-center">
    <img src="/assets/images/posts/2018/psr-12/php-cs-fixer-thing.png" alt="PR in PHP CS Fixer?" class="img-thumbnail">
</div>
<p>It will be <em>a thing</em>: PSR-12 set is definitely coming to PHP CS Fixer and <a href="https://github.com/squizlabs/PHP_CodeSniffer/issues/750">PHP_CodeSniffer has also an active issue</a> as well. Both of these tools are more stable, more popular and thus more rigid than ECS. So it will take time before there will be a pull-request and then stable release with PSR-12 set.</p>
<p><strong>That's an advantage of smaller packages like ECS, they can evolve faster and live in the present.</strong> Only that way ECS 4 already has PSR-12 set on board and ready to use.</p>
<h3 id="What-do-I-Like">What do I Like?</h3>
<p>I like that PSR-12 puts to standard rules that I consider standard for years and most of them are already integrated with ECS <a href="https://github.com/symplify/symplify/tree/master/packages/EasyCodingStandard/config/common"><code>common</code> sets</a>:</p>
<ul>
<li>it applies PHP 7.1 features, like constant visibility</li>
<li>concat <code>.</code> spacing</li>
<li>mostly spacing</li>
<li>and letter casing</li>
</ul>
<h3 id="What-don-t-I-Like">What don't I Like?</h3>
<p>Symplify code is already checked by PSR-12 (<a href="https://github.com/symplify/symplify/pull/773">see pull-request</a>):</p>
<div class="text-center">
    <img src="/assets/images/posts/2018/psr-12/symplify-implementation.png" alt="Integration to project with ECS" class="img-thumbnail">
</div>
<p>It was easy to setup and works with 0 changes in the code. But as you can see, there is 1 rule I don't fully agree with.</p>
<h4 id="PhpCsFixer-Fixer-Operator-UnaryOperatorSpacesFixex"><code>PhpCsFixer\Fixer\Operator\UnaryOperatorSpacesFixex</code></h4>
<p>It takes care of spacing around <code>!</code></p>
<pre><code class="language-php">if (!$isNotTrue) {
}

if ($isNotTrue) {
}</code></pre>
<p>An important code should be visually clear, an unimportant code should not bother us. Personally, <strong>I prefer seeing the negation clearly</strong>, so I know it's a negation:</p>
<pre><code class="language-php">if (! $isNotTrue) {
}</code></pre>
<h2 id="Try-It-Yourself-Today">Try It Yourself Today</h2>
<p>Communicate, spread the ideas and find your way. This is only PSR - PS <strong>Recommendation</strong>. It's better to keep things standard for others, <a href="/blog/2018/03/12/neon-vs-yaml-and-how-to-migrate-between-them/#why-are-standards-so-important">so they can drink water if they're thirsty and not start a research on bottle colors instead</a>. But not a rigid rule that cannot be improved.</p>
<p><br></p>
<p>You love it or hate it? Let me know in the comments ↓</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/04/09/try-psr-12-on-your-code-today</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 09 Apr 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/04/09/try-psr-12-on-your-code-today#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 4 Ways to Speedup Your Symfony Development with PackageBuilder ]]></title>
                <link>https://tomasvotruba.com/blog/2018/04/05/4-ways-to-speedup-your-symfony-development-with-packagebuilder</link>
                <description><![CDATA[ <p>Symplify 4 was released and with it also one package, that contains all the Symfony tweaks that Symplify packages use.
<br><br>
Throwable render? Test services without public violation? Load parameters with glob? We got you covered!</p> ]]></description>
                <content:encoded><![CDATA[ <p>Here are 4 news that were added in Symplify 4 and that you can use in your application right away.</p>
<p>Just install it...</p>
<pre><code class="language-bash">composer require symplify/package-builder</code></pre>
<p>...and enjoy <a href="https://github.com/symplify/package-builder">more than one</a> of these 4 new features:</p>
<h2 id="1-Console-Like-vvv-Aware-Renders-for-Exceptions-and-Errors">1. Console-Like <code>-vvv</code>-Aware Renders for Exceptions and Errors</h2>
<p><a href="https://github.com/symplify/symplify/pull/732" class="btn btn-dark btn-sm mt-2 mb-3 pull-left">
Check the PR #732
</a></p>
<p><a href="https://github.com/symplify/symplify/pull/720" class="btn btn-dark btn-sm mt-2 mb-3 ml-2">
Check the PR #720
</a></p>
<p>If you use Symfony Console you are probably familiar with these errors and with <code>-vvv</code> to get full exception trace:</p>
<img src="/assets/images/posts/2018/symplify-4-pb/error-without-and-with-vvv.gif" class="img-thumbnail">
<p>Also works with <code>Error</code> like <code>ParseError</code>. That is super handy, useful and universal.</p>
<p><strong>But what if you need to use it standalone error reporting. e.g before console build?</strong></p>
<pre><code class="language-php">$containerFactory = new ContainerFactory();
$container = $containerFactory-&gt;createFromConfig('config-not-found.yml');

$application = $container-&gt;get(Application::class);
$application-&gt;run();</code></pre>
<p>Well, you could use <code>SymfonyStyle</code>:</p>
<pre><code class="language-php">use Symfony\Component\Console\Style\SymfonyStyle;
use Symfony\Component\Console\Input\ArgvInput;
use Symfony\Component\Console\Output\ConsoleOutput;

try {
    $containerFactory = new ContainerFactory();
    $containerFactory-&gt;createFromConfig('config-with-parse-error.yml');

    $application = $container-&gt;get(Application::class);
    $application-&gt;run();
} catch (Throwable $throwable) {
    (new SymfonyStyle(new ArgvInput(), new ConsoleOutput()))-&gt;error($throwable);
}</code></pre>
<p>And that will get you rather chaotic report:</p>
<pre><code class="language-bash"> [ERROR] Symfony\Component\Yaml\Exception\ParseException: Unable to parse at line 9 (near "@# global templates
         variables"). in /var/www/tomasvotruba.com/vendor/symfony/yaml/Parser.php:415
         Stack trace:
         #0 /var/www/tomasvotruba.com/vendor/symfony/yaml/Parser.php(454): Symfony\Component\Yaml\Parser-&gt;doParse(' @#
         global temp...', 768)
         #1 /var/www/tomasvotruba.com/vendor/symfony/yaml/Parser.php(315): Symfony\Component\Yaml\Parser-&gt;parseBlock(8,
         '@# global templ...', 768)
         #2 /var/www/tomasvotruba.com/vendor/symfony/yaml/Parser.php(95): Symfony\Component\Yaml\Parser-&gt;doParse(Array,
         768)
         #3 /var/www/tomasvotruba.com/vendor/symfony/yaml/Parser.php(62):
         Symfony\Component\Yaml\Parser-&gt;parse('imports:\n    - ...', 768)
         #4 /var/www/tomasvotruba.com/vendor/symfony/dependency-injection/Loader/YamlFileLoader.php(621):
         Symfony\Component\Yaml\Parser-&gt;parseFile('/var/www/tomasv...', 768)
         #5
         /var/www/tomasvotruba.com/vendor/symplify/package-builder/src/Yaml/AbstractParameterMergingYamlFileLoader.php(52
         ): Symfony\Component\DependencyInjection\Loader\YamlFileLoader-&gt;loadFile('/var/www/tomasv...')
         #6 /var/www/tomasvotruba.com/vendor/symfony/config/Loader/DelegatingLoader.php(40):
         Symplify\PackageBuilder\Yaml\AbstractParameterMergingYamlFileLoader-&gt;load('/var/www/tomasv...', NULL)
         #7 /var/www/tomasvotruba.com/vendor/symplify/statie/src/DependencyInjection/StatieKernel.php(43):
         Symfony\Component\Config\Loader\DelegatingLoader-&gt;load('/var/www/tomasv...')
         #8 /var/www/tomasvotruba.com/vendor/symfony/http-kernel/Kernel.php(614):
        ...</code></pre>
<h3 id="How-to-Get-Nice-Error-Reports-Even-out-of-Console-Application-Scope">How to Get Nice Error Reports Even out of Console Application Scope?</h3>
<p>Do you need this to work on your CLI app? Thanks to <a href="https://github.com/ondram">Ondra Machulda</a>'s motivation <a href="https://github.com/symplify/symplify/pull/716">issues</a> I came with decoupled Symfony\Console Application logic.</p>
<p>It's named <code>Symplify\PackageBuilder\Console\ThrowableRenderer</code> and use it like this:</p>
<pre><code class="language-php">use Symplify\PackageBuilder\Console\ThrowableRenderer;

try {
    $containerFactory = new ContainerFactory();
    $containerFactory-&gt;createFromConfig('config-not-found.yml');

    $application = $container-&gt;get(Application::class);
    $application-&gt;run();
} catch (Throwable $throwable) {
    (new ThrowableRenderer())-&gt;render($throwable);
}</code></pre>
<p><strong>And you'll get always nice errors for any <code>Throwable</code> :). Work anywhere right away and also respects <code>-vvv</code> option.</strong></p>
<p><br></p>
<h2 id="2-Drop-Manual-public-true-for-Every-Service-You-Test">2. Drop Manual <code>public: true</code> for Every Service You Test</h2>
<p><a href="https://github.com/symplify/symplify/pull/680" class="btn btn-dark btn-sm mt-2 mb-3">
Check the PR #680
</a></p>
<p>If you need to test a service, this is the most common way to test it using DI:</p>
<pre><code class="language-php">final class ChangelogLinkerTest extends AbstractContainerAwareTestCase
{
    protected function setUp(): void
    {
        $this-&gt;changelogLinker = $this-&gt;container-&gt;get(ChangelogLinker::class);
    }

    // ...
}</code></pre>
<p>But if you call it like this, you're informed that it must be public.</p>
<p>To make that happen, developers will take one of 2 paths. Both with high maintainability:</p>
<h3 id="1-Public-for-Every-Tested-Class">1. Public for Every Tested Class</h3>
<pre><code class="language-yaml">services:
    SomeNamespace\:
        resource: '..'

    SomeNamespace\SomeClass:
        public: true</code></pre>
<h3 id="2-Custom-Tests-only-Configs">2. Custom Tests-only Configs</h3>
<pre><code class="language-yaml"># services-tests.yml
services:
    SomeNamespace\SomeClass:
        public: true</code></pre>
<p>Both these configs rely on your manual updates. That!s not a way to go - programming should be easy, fun and without any triggers in our heads.</p>
<h3 id="How-to-Overcome-This">How to Overcome This?</h3>
<p>Just add <code>Symplify\PackageBuilder\DependencyInjection\CompilerPass\PublicForTestsCompilerPass</code>:</p>
<pre><code class="language-php">final class AppKernel extends Kernel
{
    // ...

    protected function build(ContainerBuilder $containerBuilder): void
    {
        $containerBuilder-&gt;addCompilerPass(new PublicForTestsCompilerPass());
    }
}</code></pre>
<p>It detects PHPUnit run and adds public to each service, so you don't have to add it for every new service your set.</p>
<p>Setup &amp; forget.</p>
<p><br></p>
<h2 id="3-Autowire-Singly-Implemented-Interfaces">3. Autowire Singly-Implemented Interfaces</h2>
<p><a href="https://github.com/symplify/symplify/pull/645" class="btn btn-dark btn-sm mt-2 mb-3">
Check the PR #645
</a></p>
<p>Autowiring works great in combination with PSR-4 autoloading since <a href="https://github.com/symfony/symfony/pull/25282">Symfony 3.4</a>. But what about <strong>3-rd party services that have interfaces</strong>?</p>
<pre><code class="language-yaml"># app/config/services.yml
services:
    _defaults:
        autowire: true

    Symfony\Component\Console\Input\ArgvInput: ~
    Symfony\Component\Console\Output\ConsoleOutput: ~</code></pre>
<p>If you use <code>Symfony\Component\Console\Input\InputInterace</code>, you'll get error of missing implementation.</p>
<p>To solve it you need to use an alias for every class that implements an interface:</p>
<pre><code class="language-yaml"># app/config/services.yml
services:
    _defaults:
        autowire: true

    Symfony\Component\Console\Input\ArgvInput: ~
    Symfony\Component\Console\Input\InputInterace:
        alias: Symfony\Component\Console\Input\ArgvInput

    Symfony\Component\Console\Output\ConsoleOutput: ~
    Symfony\Component\Console\Output\OutputInterace:
        alias: Symfony\Component\Console\Output\ConsoleOutput</code></pre>
<p>This way, you're actually being punished for using clean code and separation of interfaces in your code, because using <code>Symfony\Component\Console\Input\ArgvInput</code> would be easier.
But is it really necessary to break SOLID principles just to comply with Symfony behaviors? I don't think that framework should enforce bad design to your application.</p>
<h3 id="How-to-fix-this">How to fix this?</h3>
<p>I got inspired by <a href="https://github.com/symfony/symfony/pull/25282">Register singly-implemented interfaces when doing PSR-4 discovery</a> pull-request in Symfony and by Nette default behavior.</p>
<pre><code class="language-php">namespace App;

use Symfony\Component\HttpKernel\Kernel;
use Symplify\PackageBuilder\DependencyInjection\CompilerPass\AutowireSinglyImplementedCompilerPass;

final class AppKernel extends Kernel
{
    // ...
    protected function build(ContainerBuilder $containerBuilder): void
    {
        $containerBuilder-&gt;addCompilerPass(new AutowireSinglyImplementedCompilerPass());
    }
}</code></pre>
<p>And then clean your configs the same way PSR-4 autodiscovery works:</p>
<pre><code class="language-diff"> # app/config/services.yml
 services:
     _defaults:
         autowire: true

     Symfony\Component\Console\Input\ArgvInput: ~
-    Symfony\Component\Console\Input\InputInterace:
-        alias: Symfony\Component\Console\Input\ArgvInput

     Symfony\Component\Console\Output\ConsoleOutput: ~
-    Symfony\Component\Console\Output\OutputInterace:
-        alias: Symfony\Component\Console\Output\ConsoleOutput</code></pre>
<p><br></p>
<h2 id="4-How-to-Decouple-Parameters-to-multiple-files-in-Safe-Way">4. How to Decouple Parameters to multiple files in Safe Way?</h2>
<p><a href="https://github.com/symplify/symplify/pull/745" class="btn btn-dark btn-sm mt-2 mb-3">
Check the PR #745
</a></p>
<p>Do you prefer to decouple long parameter list to multiple files and them with <a href="https://symfony.com/blog/new-in-symfony-3-3-import-config-files-with-glob-patterns">Glob</a>?</p>
<pre><code class="language-yaml"># app/config/config.yml
imports:
    - { resource: 'framework/*.yml' }</code></pre>
<p>In <code>/framework</code> directory there 2 files:</p>
<pre><code class="language-yaml"># app/config/framework/symfony.yml
parameters:
    framework:
        symfony:
            controller: '&lt;?php "some Symfony code"'</code></pre>
<p>and</p>
<pre><code class="language-yaml"># app/config/framework/laravel.yml
parameters:
    framework:
        laravel:
            controller: '&lt;?php "some Laravel code"'</code></pre>
<p>How many items will <code>framework</code> parameter have? 2? 1? 0?</p>
<p><strong>One is correct</strong>. And which one? <code>laravel</code> or <code>symfony</code>? Well, according the <code>YamlFileLoader</code>, that <a href="https://github.com/symfony/symfony/blob/f77c1d0d0996cc4723bff0411c8b75fe6a575bc8/src/Symfony/Component/DependencyInjection/Loader/YamlFileLoader.php#L135"><em>last wins</em> approach</a> is used. So probably <code>symfony</code>... but it doesn't matter, because you need them all.</p>
<h3 id="How-to-Prefer-Merging-of-Parameters">How to Prefer Merging of Parameters?</h3>
<p>The official statement is to <a href="https://github.com/symfony/symfony/issues/26713">create <code>Extension</code>, <code>Configuration</code>, <code>Bundle</code> and merge class</a>, which and then add a custom implementation of <a href="https://symfony.com/blog/new-in-symfony-3-4-local-service-binding">parameter binding</a> and other Symfony parameters related features like composing of parameters, env variables and etc. I asked for this option to be allowed with no BC break in <a href="https://github.com/symfony/symfony/issues/26713">the issue</a>, but it seems it's not needed enough.</p>
<p>Symplify actually followed the suggested approach and <strong>it was a lot of duplicated code from Symfony\DependencyInjection that barely worked</strong>.</p>
<p>To save many duplicated classes and take advantage of all Symfony parameter features you could overload <code>YamlFileLoader</code>, where parameters are merged together:</p>
<pre><code class="language-yaml"># app/config/framework/symfony.yml
parameters:
    framework:
        symfony:
            controller: '&lt;?php "some Symfony code"'
        laravel:
            controller: '&lt;?php "some Laravel code"'</code></pre>
<p>Do you need this? Just use <code>Symplify\PackageBuilder\Yaml\AbstractParameterMergingYamlFileLoader</code> in your <code>Kernel</code> class:</p>
<pre><code class="language-php">use Symfony\Component\Config\Loader\DelegatingLoader;
use Symfony\Component\Config\Loader\LoaderResolver;
use Symfony\Component\DependencyInjection\ContainerBuilder;
use Symfony\Component\DependencyInjection\Loader\GlobFileLoader;
use Symfony\Component\DependencyInjection\ContainerInterface;
use Symfony\Component\HttpKernel\Kernel;

final class AppKernel extends Kernel
{
    // ...

    /**
     * @param ContainerInterface|ContainerBuilder $container
     */
    protected function getContainerLoader(ContainerInterface $container): DelegatingLoader
    {
        $kernelFileLocator = new FileLocator($this);

        $loaderResolver = new LoaderResolver([
            new GlobFileLoader($container, $kernelFileLocator),
            new class($container, $kernelFileLocator) extends AbstractParameterMergingYamlFileLoader {
            },
        ]);

        return new DelegatingLoader($loaderResolver);
    }
}</code></pre>
<p>The class is <code>abstract</code>, so you can modify it <strong>in any way you need</strong>.</p>
<p><br></p>
<p>Happy package building!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/04/05/4-ways-to-speedup-your-symfony-development-with-packagebuilder</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 05 Apr 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/04/05/4-ways-to-speedup-your-symfony-development-with-packagebuilder#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Rectify: Turn All Doctrine Repositories From Inheritance To Composition in Seconds ]]></title>
                <link>https://tomasvotruba.com/blog/2018/04/02/rectify-turn-repositories-to-services-in-symfony</link>
                <description><![CDATA[ <p>Today I start new series called <em>Rectify</em>. It will be about <strong>instant refactoring</strong> to better code not manually, but with Rector.
<br><br>
That way there is no excuse left to change your legacy application to clean code you'll love to extend.
<br><br>
We'll start with very popular post - <a href="/blog/2017/10/16/how-to-use-repository-with-doctrine-as-service-in-symfony/">Repository with Doctrine as Service in Symfony</a>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>I wrote about <a href="/blog/2017/10/16/how-to-use-repository-with-doctrine-as-service-in-symfony/">How to use Repository with Doctrine as Service Symfony</a> a while ago. There are many posts about this topic, but not as simple to apply as this one. At least for one repository.</p>
<h2 id="The-One-to-Many-Problem-of-The-Best-Practise">The One-to-Many Problem of The Best Practise</h2>
<p>It's always very simple to write 1 service, with <code>final</code>, constructor injection, design patterns and modern PHP 7.1 type hints and <code>strict_types</code>. That's why it's easy to write such posts as the one above :)</p>
<p><strong>But what if you have 50 repositories? Would I write a post about how I refactored 50 repositories to services?</strong> Probably not, because it would take so much time and energy and you'd fell asleep while reading the first 1/10.</p>
<h2 id="Turn-M-complexity-to-1-with-Rector">Turn M-complexity to 1 with Rector</h2>
<p>What if you could <strong>change just 1 case and it would be promoted to the rest of your application</strong>? From 1:M to 1:1. That's exactly what Rector help you with.</p>
<p>Let's see how it works. I'll use <a href="/blog/2017/10/16/how-to-use-repository-with-doctrine-as-service-in-symfony/#how-to-make-this-better-with-symfony-3-3">the example from the original post</a>, where I write about turning <a href="https://github.com/jupeter/clean-code-php#prefer-composition-over-inheritance">inheritance to composition</a> - one of SOLID principles.</p>
<p><br></p>
<p><strong>Instead of inheritance...</strong></p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace App\Repository;

use App\Entity\Post;
use Doctrine\ORM\EntityRepository;

final class PostRepository extends EntityRepository
{
}</code></pre>
<p><strong>...we use composition:</strong></p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace App\Repository;

use App\Entity\Post;
use Doctrine\ORM\EntityManager;
use Doctrine\ORM\EntityRepository;

final class PostRepository
{
    /**
     * @var EntityRepository
     */
    private $repository;

    public function __construct(EntityManager $entityManager)
    {
        $this-&gt;repository = $entityManager-&gt;getRepository(Post::class);
    }
}</code></pre>
<h2 id="4-Steps-to-Instant-Refactoring-of-All-Repositories">4 Steps to Instant Refactoring of All Repositories</h2>
<h3 id="1-Install-Rector">1. Install Rector</h3>
<pre><code class="language-bash">composer install rector/rector --dev</code></pre>
<h3 id="2-Setup-rector-php">2. Setup <code>rector.php</code></h3>
<p>There you name all the changes you'd like to perform on you code:</p>
<pre><code class="language-php">use Rector\Architecture\Rector\MethodCall\ReplaceParentRepositoryCallsByRepositoryPropertyRector;
use Rector\Architecture\Rector\Class_\MoveRepositoryFromParentToConstructorRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    // order matters, this needs to be first to correctly detect parent repository

    // this will replace parent calls by "$this-&gt;repository" property
    $rectorConfig-&gt;rule(ReplaceParentRepositoryCallsByRepositoryPropertyRector::class);

    // this will move the repository from parent to constructor
    $rectorConfig-&gt;rule(MoveRepositoryFromParentToConstructorRector::class);
};</code></pre>
<h3 id="3-Add-Repository-Entity-Provider">3. Add Repository → Entity Provider</h3>
<p>But how does Rector know what entity should it add to which repository? For that reasons, there is <code>Rector\Bridge\Contract\DoctrineEntityAndRepositoryMapperInterface</code> you need to implement.</p>
<p>It could be as simple as:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace App\Rector;

use Rector\Bridge\Contract\DoctrineEntityAndRepositoryMapperInterface;

final class DoctrineEntityAndRepositoryMapper implements DoctrineEntityAndRepositoryMapperInterface
{
    /**
     * @var string[]
     */
    private $map = [
        'App\Repository\PostRepository' =&gt; 'App\Entity\Post',
        'App\Repository\ProductRepository' =&gt; 'App\Entity\Product',
    ];
    public function mapRepositoryToEntity(string $name): ?string
    {
        return $this-&gt;map[$name] ?? null;
    }

    public function mapEntityToRepository(string $name): ?string
    {
        $inversedMap = array_flip($this-&gt;map);

        return $inversedMap[$name] ?? null;
    }
}</code></pre>
<p>And register it:</p>
<pre><code class="language-diff"> &lt;?php

 use Rector\Rector\Architecture\RepositoryAsService\ReplaceParentRepositoryCallsByRepositoryPropertyRector;
 use Rector\Rector\Architecture\RepositoryAsService\MoveRepositoryFromParentToConstructorRector;
 use Rector\Config\RectorConfig;

 return function (RectorConfig $rectorConfig): void {
     // order matters, this needs to be first to correctly detect parent repository

     // this will replace parent calls by "$this-&gt;repository" property
     $rectorConfig-&gt;rule(ReplaceParentRepositoryCallsByRepositoryPropertyRector::class);

     // this will move the repository from parent to constructor
     $rectorConfig-&gt;rule(MoveRepositoryFromParentToConstructorRector::class);

+    $rectorConfig-&gt;rule(\App\Rector\DoctrineEntityAndRepositoryMapper::class);
 };</code></pre>
<h3 id="4-Run-on-Your-Code">4. Run on Your Code</h3>
<p>Now the fun part:</p>
<pre><code class="language-bash">vendor/bin/rector process /app --dry-run # "--config rector.php" as default</code></pre>
<p>You should see diffs like:</p>
<pre><code class="language-diff"> use App\Entity\Post;
 use Doctrine\ORM\EntityRepository;

-final class PostRepository extends EntityRepository
+final class PostRepository
 {
     /**
+     * @var \Doctrine\ORM\EntityRepository
+     */
+    private $repository;
+    public function __construct(\Doctrine\ORM\EntityManager $entityManager)
+    {
+        $this-&gt;repository = $entityManager-&gt;getRepository(\App\Entity\Post::class);
+    }
+    /**
      * Our custom method
      *
      * @return Post[]
@@ -14,7 +22,7 @@
      */
     public function findPostsByAuthor(int $authorId): array
     {
-        return $this-&gt;findBy([
+        return $this-&gt;repository-&gt;findBy([
             'author' =&gt; $authorId
         ]);
     }</code></pre>
<p>Are all looking good? Run it:</p>
<pre><code class="language-bash">vendor/bin/rector process /app</code></pre>
<h3 id="Safety-First">Safety First</h3>
<p>When the Rector finishes, be sure to check your code. While it can manage 80 % of cases for you, it's not perfect. I love to use <code>git diff</code> and <em>PgDown</em> - the best use case for this key I know.</p>
<p>Ready? Add, commit, send an invoice for big refactoring and enjoy your coffee :)</p>
<h2 id="Clean-Code-Done-but-What-About-Beautiful">Clean Code... Done, but What About Beautiful?</h2>
<p>You've probably noticed that code itself is not looking too good. Rector's jobs is not to clean, but to change the code. It's not a hipster designer, but rather a thermonuclear engineer. <strong>That's why there are coding standards. You can apply your own or if not good enough use Rector's prepared set</strong>:</p>
<pre><code class="language-bash">composer require symplify/easy-coding-standard --dev
vendor/bin/ecs --config vendor/rector/rector/ecs-after-rector.php --fix</code></pre>
<p>And your code is now both <strong>refactored and clean</strong>. That's it!</p>
<p><br><br></p>
<p>Happy instant refactoring!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/04/02/rectify-turn-repositories-to-services-in-symfony</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 02 Apr 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/04/02/rectify-turn-repositories-to-services-in-symfony#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ New in Coding Standard 4: Long Line Breaks Automated and 3 Legacy Prevention Fixers ]]></title>
                <link>https://tomasvotruba.com/blog/2018/03/29/new-in-coding-standard-4-long-line-breaks-automated-and-3-legacy-prevention-fixers</link>
                <description><![CDATA[ <p>Legacy code prevention, lines automated and clear naming of classes in huge projects.
That all is coming to Coding Standard 4 (still in alpha).
<br><br>
Are you curious what work will now these 4 news fixers handle for you? Look inside.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="1-Let-Coding-Standard-handle-Line-Length-for-You">1. Let Coding Standard handle Line Length for You</h2>
<p><a href="https://github.com/symplify/symplify/pull/749" class="btn btn-dark btn-sm mt-2 mb-3">
Check the PR #749
</a></p>
<p><em>I'm so happy to announce this fixer, because it saved my so many times and also motivates me to use decoupling to smaller, SRP classes.</em></p>
<p>If you use <code>LineLengthSniff</code>, you know it's painful to fix every error report it makes.</p>
<pre><code class="language-php">use PHP_CodeSniffer\Standards\Generic\Sniffs\Files\LineLengthSniff;
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();

    $services-&gt;set(LineLengthSniff::class)
        -&gt;property('absoluteLineLimit', 120);
};</code></pre>
<p>The most typical use case is constructor dependencies. You code start small:</p>
<pre><code class="language-php">public function __construct(OneLittleDependency $oneLittleDependency)
{
}</code></pre>
<p>Then it grows...</p>
<pre><code class="language-php">public function __construct(OneLittleDependency $oneLittleDependency, AnotherLittleDependency $anotherLittleDependency)
{
}</code></pre>
<p>...and grows...</p>
<pre><code class="language-php">public function __construct(OneLittleDependency $oneLittleDependency, AnotherLittleDependency $anotherLittleDependency, $someParameter)
{
}</code></pre>
<p>...sniff screams, so you inline it...</p>
<pre><code class="language-php">public function __construct(
    OneLittleDependency $oneLittleDependency,
    AnotherLittleDependency $anotherLittleDependency,
    $someParameter
) {
}</code></pre>
<p>...then you refactor and merge 2 services to 1...</p>
<pre><code class="language-php">public function __construct(
    OneLittleDependency $oneLittleDependency,
    $someParameter
) {
}</code></pre>
<p>...and that is inconsistent and has no reason to be inlined, so you inline it...</p>
<pre><code class="language-php">public function __construct(OneLittleDependency $oneLittleDependency, $someParameter) {
}</code></pre>
<p>...and that is one of many reasons people don't like to decouple classes and keep them small.</p>
<p><br></p>
<p>There are other cases, where parameters, arguments or array items can change up and down:</p>
<pre><code class="language-diff">-$someObject = new SomeClass(
-    $shortArg
-);
+$someObject = new SomeClass($shortArg);</code></pre>
<pre><code class="language-diff">-$someArray = ['superlooongArgumentsover120chars', 'superlooongArgumentsover120chars', 'superlooongArgumentsover120chars'];
+$someArray = [
+    'superlooongArgumentsover120chars',
+    'superlooongArgumentsover120chars',
+    'superlooongArgumentsover120chars'
+];</code></pre>
<p>What if I told you that you'll have to never deal with this manually. Ever!</p>
<p>Welcome <code>LineLengthFixer</code>.</p>
<h3 id="How-to-Register-It">How to Register It?</h3>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\CodingStandard\Fixer\LineLength\LineLengthFixer;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();
    $services-&gt;set(LineLengthFixer::class);
};</code></pre>
<p>As you guessed, this fixer works with 120 chars as maximum line-size... by default ↓</p>
<p><br></p>
<h2 id="2-Choose-Line-Length-to-Match-Your-Display">2. Choose Line Length to Match Your Display</h2>
<p><a href="https://github.com/symplify/symplify/pull/747" class="btn btn-dark btn-sm mt-2 mb-3">
Check the PR #751
</a></p>
<ul>
<li>Do you prefer shorter or longer lines?</li>
<li>Do you want use breaks only and not inline short code?</li>
</ul>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\CodingStandard\Fixer\LineLength\LineLengthFixer;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();

    $services-&gt;set(LineLengthFixer::class)
        -&gt;call('configure', [[
            'max_line_length' =&gt; 100, # default: 120
            'break_long_lines' =&gt; true, # default: true
            'inline_short_lines' =&gt; false, # default: true
        ]]);
};</code></pre>
<p><br></p>
<h2 id="3-Make-your-Static-Classes-visible">3. Make your Static Classes visible</h2>
<p>It started as one simple static method. A helper method. They say: it's ok to use static methods, when you know when to use them. And that's <strong>how cancer started to spread slowly and lethally through Symplify code</strong>.</p>
<p>One day you wake up and from 1 static method is 60 static factories all over your code - Dependency Injection for very poor. And that not the worst. When all code works and is easy to maintain, 1 static method can't hurt it, right?</p>
<p><strong>Well until you need to replace one of nested dependencies that requires few more classes. And then you realized your work is to basically manually maintain dump of dependency injection container</strong> and that you're not coding anymore.</p>
<p>It took weeks to get from this position back to clear dependency injection and I don't want to do it ever again. That's why this PHPStan rule was born.</p>
<h3 id="How-to-Register-It">How to Register It?</h3>
<pre><code class="language-yaml">rules:
    - Symplify\CodingStandard\Rules\NoClassWithStaticMethodWithoutStaticNameRule</code></pre>
<p><br></p>
<h2 id="4-Prevent-and-amp-references-with-ForbiddenStaticFunctionSniff">4. Prevent &amp; references with <code>ForbiddenStaticFunctionSniff</code></h2>
<p><a href="https://github.com/symplify/symplify/pull/692" class="btn btn-dark btn-sm mt-2 mb-3">
Check the PR #692
</a></p>
<p>We all already know that <code>&amp;$references</code> are bad practise, since they increase cyclomatic complexity and hide dependency logic.</p>
<pre><code class="language-php">function someFunction(&amp;$var)
{
    $var + 1;
}</code></pre>
<p>And that we should prefer explicit syntax:</p>
<pre><code class="language-php">function someFunction($var)
{
    return $var + 1;
}</code></pre>
<p>I though I would never meet them again, but they somehow pop-up in PRs. So we made a PHPStan rule for it:</p>
<h3 id="How-to-Register-It">How to Register It?</h3>
<pre><code class="language-yaml"># phpstan.neon
rules:
    - Symplify\CodingStandard\Rules\NoReferenceRule</code></pre>
<p><br></p>
<h2 id="5-Clear-Child-Class-Naming-Once-and-For-All-with-ClassNameSuffixByParentFixer">5. Clear Child Class Naming Once and For All with <code>ClassNameSuffixByParentFixer</code></h2>
<p><a href="https://github.com/symplify/symplify/pull/633" class="btn btn-dark btn-sm mt-2 mb-3">
Check the PR #633
</a></p>
<p>Often in the code of private companies there are classes like:</p>
<ul>
<li><code>ProductSorter</code></li>
<li><code>ProductSorter</code></li>
<li><code>ProductSorter</code></li>
</ul>
<p>If you use PhpStorm and <em>open file</em> shortcut, you know where I aim.</p>
<p>Now, imagine you want to update the Command that sorts Products by price to Redis database. Inside, it looks like this:</p>
<pre><code class="language-php">final class ProductSorter extends Command
{
    // ...
}</code></pre>
<h3 id="Which-one-do-you-open">Which one do you open?</h3>
<p>I could also ask, which one is the interface and which is its implementation, but <a href="https://github.com/symplify/coding-standard#class-should-have-suffix-by-parent-classinterface">there is already checker for that</a>.</p>
<p>Probably each of them manually until you find the right one, which really sucks. That why not only methods names, <strong>but also class names should be as descriptive and as deterministic as possible</strong>. Like this:</p>
<pre><code class="language-diff">-final class ProductSorter extends Command
+final class ProductSorterCommand extends Command
 {
     // ...
 }</code></pre>
<p>And then you have clear class names, that you're able to distinguish without their content:</p>
<ul>
<li><code>ProductSorterCommand</code></li>
<li><code>ProductSorterRepository</code></li>
<li><code>ProductSorterController</code></li>
</ul>
<p>And that's exactly what <code>ClassNameRespectsParentSuffixRule</code> helps you to do.</p>
<h3 id="How-to-Register-It">How to Register It?</h3>
<pre><code class="language-yaml"># phpstan.neon
rules:
    - Symplify\CodingStandard\Rules\ClassNameRespectsParentSuffixRule

parameters:
    symplify:
        # it handles many default cases, but allows you to add your own
        forbidden_parent_classes: []</code></pre>
<p><br><br></p>
<p>Happy sniffing and fixing!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/03/29/new-in-coding-standard-4-long-line-breaks-automated-and-3-legacy-prevention-fixers</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 29 Mar 2018 00:00:00 +0000</pubDate>
                                    <updated>2020-08-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Aug 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Aug 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/03/29/new-in-coding-standard-4-long-line-breaks-automated-and-3-legacy-prevention-fixers#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ New in Easy Coding Standard 4: Clean Symfony Standard with Yaml and Services ]]></title>
                <link>https://tomasvotruba.com/blog/2018/03/26/new-in-easy-coding-standard-4-clean-symfony-standard-with-yaml-and-services</link>
                <description><![CDATA[ <p>I wrote about <a href="/blog/2018/03/01/new-in-symplify-3-4-improvements-in-easy-coding-standard/">news in Easy Coding Standard 3</a> a while ago. EasyCodingStandard 4 is released yet (still in alpha), but soon you'll be able to use all the news I'll show you today.
<br><br>
And what are they? Neon to YAML, semi-static to Services, customizable caching, even simpler skipper, short bin and more.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="1-Configure-Caching-Directory">1. Configure Caching Directory</h2>
<p><a href="https://github.com/symplify/symplify/pull/656" class="btn btn-dark btn-sm mt-2 mb-3">
Check the PR #661
</a></p>
<p>Docker users will be happy for this feature, since it makes ECS much more usable. To enjoy speed of caching of changed files on second run, just tune your config.</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $parameters = $containerConfigurator-&gt;parameters();
    $parameters-&gt;set('cache_directory', '.ecs_cache');
};</code></pre>
<p>Thank you <a href="https://github.com/marmichalski">Marcin Michalski</a> for adding this feature.</p>
<p><br></p>
<h2 id="2-Skip-Anything-Anywhere">2. Skip Anything, Anywhere</h2>
<p><a href="https://github.com/symplify/symplify/pull/661" class="btn btn-dark btn-sm mt-2 mb-3">
Check the PR #661
</a></p>
<p>One of the features I really like is skipping particular spots. PHP CS Fixer and PHP_CodeSniffer can ignore whole directory, 1 sniff everywhere or force to put annotation to your code and that's not the way to go. <strong>Your code should have no idea about tools you use to analyze it</strong>.</p>
<p>What you really need? Exclude 1 file but only for 1 checker. Or 1 checker for group of files and sometimes only 1 code from sniff on 1 file. That all is possible now.</p>
<p><strong>Because details matters and it's pointless to think about code or class</strong>, you can now remove <code>skip_codes</code> key from your config and use <code>skip</code> section only.</p>
<p><br></p>
<h2 id="3-Short-vendor-bin-ecs-is-the-King">3. Short <code>vendor/bin/ecs</code> is the King</h2>
<p><a href="https://github.com/symplify/symplify/pull/647" class="btn btn-dark btn-sm mt-2 mb-3">
Check the PR #647
</a></p>
<p>One last detail. Did you use this bin file to run ECS?</p>
<pre><code class="language-bash">vendor/bin/easy-coding-standard
# or
vendor/bin/easy-coding-standard.php</code></pre>
<p>I know it's pain, mainly during live demo presentations with all that tyops :).</p>
<p>Now this is the only way to use ECS:</p>
<pre><code class="language-bash">vendor/bin/ecs</code></pre>
<p>Typo proof or at least less error prone. Just change it in you <a href="https://blog.martinhujer.cz/have-you-tried-composer-scripts"><code>composer.json</code>'s <code>script</code> section</a> or CI setups and you're ready to go!</p>
<p><br></p>
<h2 id="4-DI-Migration-Finished-From-Neon-to-YAML">4. DI Migration Finished: From Neon to YAML</h2>
<p><a href="https://github.com/symplify/symplify/pull/651" class="btn btn-dark btn-sm mt-2 mb-3">
Check the PR #651
</a></p>
<p>Symplify used <code>Nette\DI</code> a long time ago and with it its markup language - Neon. Then it moved to <code>Symfony\DependencyInjection</code> in <a href="https://github.com/symplify/symplify/blob/master/CHANGELOG.md#v200---2017-06-16">Symplify 2.0</a>, because it was just impossible to reject <a href="/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3/">all these awesome Symfony 3.3 features</a> by Nicolas Grekas. But this was just partial migration - Neon files still worked.</p>
<p>That lead to situation, where 5 <em>custom-cool-classes</em> simulated loading transforming Neon to YAML format, merging it and then passing to Symfony Container, hoping all went well. And it worked. Well, most of the times.</p>
<p>Based on feedback from <a href="https://github.com/symplify/symplify/issues/565">community around Symplify</a>, rejection of ECS in <a href="https://github.com/doctrine/coding-standard">Doctrine\CodingStandard</a> where Neon was one of reasons and weird feeling from promoting &quot;local-only standard&quot;, I decided to move to Symfony completely.</p>
<p><a href="https://xkcd.com/927/"></p>
<img src="https://imgs.xkcd.com/comics/standards.png">
<p></a></p>
<p>I had one problem - missed services autocomplete in Yaml files. But you know what they say:</p>
<blockquote class="blockquote text-center mt-lg-5 mb-lg-5">
    There are no solutions. There are only trade-offs
</blockquote>
<p>I hear you community, so lets trade! <strong>From ECS 4, you can use Yaml everywhere with syntax you know, behavior from Symfony ecosystem you know and with no need to learn new standard.</strong></p>
<h3 id="How-to-Migrate">How to Migrate?</h3>
<p>Well just rename <code>easy-coding-standard.neon</code> or <code>ecs.yml</code> and
then read about it in <a href="/blog/2018/03/12/neon-vs-yaml-and-how-to-migrate-between-them/">Neon vs. Yaml and How to Migrate Between Them</a>.</p>
<p><br></p>
<h2 id="5-From-Semi-Static-Checkers-to-Services-as-First-Class-Citizen">5. From Semi-Static Checkers to Services as First-Class Citizen</h2>
<p><strong>Note: Symplify 8 now uses PHP configuration.</strong></p>
<p><a href="https://github.com/symplify/symplify/pull/660" class="btn btn-dark btn-sm mt-2 mb-3">
Check the PR #660
</a></p>
<p>Thanks to Yaml, we could use finally use full power of Symfony\DependencyInjection component, constructor injection, autowiring... again, all that you probably already know from Symfony.</p>
<p>Why? <strong>ECS is basically a Symfony application with DI Container</strong>. It loads all checkers from config you provide, turns them into services and then uses those services to check the code.</p>
<p>YAML was the only missing part to do this. And ECS has it now, so does the explicit services!
And you can do and use any feature you Symfony know. Magic no more #metoo.</p>
<p><br><br></p>
<p>Happy upgrading!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/03/26/new-in-easy-coding-standard-4-clean-symfony-standard-with-yaml-and-services</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 26 Mar 2018 00:00:00 +0000</pubDate>
                                    <updated>2020-08-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Aug 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Aug 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/03/26/new-in-easy-coding-standard-4-clean-symfony-standard-with-yaml-and-services#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How Teaching Suicides Itself by Killing the Passion ]]></title>
                <link>https://tomasvotruba.com/blog/2018/03/22/how-teaching-suicides-itself-by-killing-the-passion</link>
                <description><![CDATA[ <p>Today I wanted to write about Rector showcase how to use it to <a href="/blog/2017/10/16/how-to-use-repository-with-doctrine-as-service-in-symfony/">automate migration to Repository as Service in Symfony</a>.
<br><br>
Instead I read <a href="https://medium.com/@romaninsh/teaching-php-to-students-with-atk-500d50b49391">Teaching PHP to students</a> by Romans Malinovskis that got me thinking how outside education can easily kill any piece passion in children.
<br><br>
What if instead of outside-in - education first, we could do it inside-out - <strong>passion first</strong>?</p> ]]></description>
                <content:encoded><![CDATA[ <p>This started as reply to the post and I got literally on fire while writing it. Fire I want to share with you. It's not any <a href="/blog/2018/03/19/how-to-criticize-like-a-senior-programmer/">critique</a> to the post, it's the way I see the world.</p>
<p><br></p>
<p>Hey, thanks for this post. It’s great there is somebody who tries to make it as simple as possible to get into PHP.</p>
<p>I teach or rather mentor PHP for last 5 years on various online forums, PHP meetups, Github and personal lectures. From my own experience, nothing I show is good enough to get inside one’s head, unless it’s his own passion or desire.
For me, the PHP was not about tools, blogs under 5 minutes or the fastest framework. </p>
<h2 id="What-Pisses-YOU-of">What Pisses YOU of?</h2>
<p>I had problem, I was pissed, frustrated and angry at something and wanted a change. And everyone has such ONE THING (or maybe more). I wanted to play, to have fun in online game. There were countries, tanks, farms, factories… just game of numbers, but real fun for 14-year old. And wanted to be better, so I count the deffense of my enemies in Excel. Just put their numbers, guessed algorithm from practise and that was it. Iterative IKIGAI.</p>
<p>I think THIS is the spot that teachers, or rather mentors, parents, friends need to find to unlock one’s potential.</p>
<p>Since this SPOT I got to where I’m now, doing the same learning over and over again, just bit further, but not much different.</p>
<p>If in that spot someone would show me PHP and that it’s about websites, blogs or forms, I’d probably go different path, because that was no my problem. It was THEIRS.</p>
<h2 id="I-takes-1-Person-to-Burst-Boost-Lifetime-Passion">I takes 1 Person to <del>Burst</del> Boost Lifetime Passion</h2>
<p>Luckily, friend of mine only showed me a hosting, where I could put my excel file and then share it with. That was so awesome. And with 15 lines of code, we could share link with numbers of our enemies pre-filled! That was the best thing ever so far in my life and it lead me here to share it again with others...</p>
<p>...<strong>find the inner light in people and just give it a little attention. That's all they need</strong>.</p>
<p>Thanks for your post, it's great to remember my “the Big Bang” :)</p>
<p>And big love and thanks to my peers Lukáš Růžička and Martin Čermák, who gave me exactly what I needed.</p>
<p><br><br></p>
<p>What was your THING that got you here to the present you are now in?</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/03/22/how-teaching-suicides-itself-by-killing-the-passion</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 22 Mar 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/03/22/how-teaching-suicides-itself-by-killing-the-passion#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Criticize like a Senior Programmer ]]></title>
                <link>https://tomasvotruba.com/blog/2018/03/19/how-to-criticize-like-a-senior-programmer</link>
                <description><![CDATA[ <p>As I spend most of my socials online time on Github and PHP-related discussion, I've noticed <strong>many people do so many wrong things</strong> while giving critics.
<br>
I want to <strong>correct this</strong> once and for all, so I've prepared a guide for you.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="1-Find-an-Error">1. Find an Error</h2>
<p>This is very easy step that many people can handle. Just pick something wrong in a project, or content and point it out. Rush to create that issue! Also, comment only thing, where is no request for critics or feedback. The worst think you can do is actually help the person who want some feedback.</p>
<h2 id="2-Strong-Intro">2. Strong Intro</h2>
<p>No &quot;hello&quot; or &quot;hi&quot;, never use a surname and NEVER use a name. Just write right away what is wrong, that's the only thing that matters. Some example:</p>
<ul>
<li><em>&quot;this post is complicated...&quot;</em></li>
<li><em>&quot;well that was boring&quot;</em></li>
<li><em>&quot;this is not how to use that&quot;</em></li>
<li><em>&quot;you can't use foreach here&quot;</em></li>
</ul>
<div class="card">
    <div class="card-body">
        <p>
            <strong>Minitip: Judge Others</strong>
        </p>

        <br>

        <p>
            As a senior programmer you have right to say what is right and wrong. You should be clear and right to the point. Only that way the other person knows what is this about and can do something about that.
        </p>

        <p><em>"this is definitely wrong"</em></p>
    </div>
</div>
<div class="card mt-3">
    <div class="card-body">
        <p>
            <strong>Minitip: Point out the Other person is Below You</strong>
        </p>

        <br>

        <p>
            If that would be another way, he or she would not need a correction, right?
        </p>
        <ul>
            <li>missing education: <em>"read the docs first"</em></li>
            <li>more stupid: <em>"lol, you really think this is the way to use it?"</em></li>
        </ul>
    </div>
</div>
<h2 id="3-Never-Back-up-You-re-not-Weak">3. Never Back up - You're not Weak</h2>
<img src="/assets/images/posts/2018/critic/shout.jpg" class="img-thumbnail">
<p>When you get a response like this, it is usually very rude like for no reason:</p>
<ul>
<li><em>&quot;What do you mean by that?&quot;</em></li>
</ul>
<p>You only are trying to help the second person to stop being to stupid. The author is only pretending he doesn't know. But luckily you are smarter than him to recognize it!</p>
<h2 id="4-Repeat-the-Same-to-Make-Them-Hear-You">4. Repeat the Same to Make Them Hear You</h2>
<p>If the other doesn't want to listen, he or she probably didn't read our comments clearly. Who can blame them, it's today's world full of social media distractions (and alcohol and drugs!). There is no better solution than point that out.</p>
<ul>
<li><em>&quot;I wrote that already.&quot;</em></li>
</ul>
<p>In case you have mood for long essays:</p>
<ul>
<li><em>&quot;I wrote that already, see comment up&quot;</em></li>
</ul>
<p>If you have bless mood, you can write it explicitly for those with attention disorder:</p>
<ul>
<li><em>&quot;I wrote that already: this is wrong way to use this&quot;</em></li>
</ul>
<h2 id="5-Point-out-Places-to-Learn-From">5. Point out Places to Learn From</h2>
<p>As our mission is to educate others about their mistakes, thus we should always provide a source of knowledge.</p>
<ul>
<li><em>&quot;Read the docs first&quot;</em></li>
<li><em>&quot;it's in the manual, doh&quot;</em></li>
<li><em>&quot;read php manual&quot;</em></li>
</ul>
<p>Today, we have Google, so there is no need to use actual link. Everybody can google now.
And if they don't, they're stupid and they should learn that first.</p>
<div class="card mt-3">
    <div class="card-body">
        <p>
            <strong>Minitip: Use Shortcuts To Save Time</strong>
        </p>

        <br>

        <p>
           All people in the field know all the shortuts you do - they're programmers after all - so why not use them so save time in conversation and your elbows.
        </p>
        <ul>
            <li><em>"why don't you use IDE"?</em></li>
            <li><em>"use Docker AWS setup with DTOs lol"</em></li>
        </ul>

        <p>Again, do not add any links, Google can handle it for you.</p>
    </div>
</div>
<h2 id="6-Believe-in-Yourself">6. Believe in Yourself</h2>
<p>You know the best (as your mama and papa told you) - never forget that. And if other try to change your mind, they probably don't know a thing.Stick to your believes and don't let anyone to question it.</p>
<ul>
<li><em>&quot;no, you don't understand this&quot;</em></li>
</ul>
<p>You're the most objective person there could be, so use it. That's what intelligent means!</p>
<h2 id="7-Always-Tell-Never-Ask">7. Always Tell, Never Ask</h2>
<p>Because many people are missing parenting, you're here for them to help them with raising to proper senior programmer. Always, tell the other person what to do or how the world works. It's objective true. How can you be subjective if you're human. Asking is sign of not-knowing and weakness.</p>
<h2 id="8-Keep-it-Short-Never-Provide-a-Reason">8. Keep it Short, Never Provide a Reason</h2>
<p>To make conversion faster, always talks about your final ideas. There is not time to provide motivation reason, how you conclude it and all that life story of yours. It's obvious already and he should know it. Or just google it.</p>
<p>And so on... you get the gist.</p>
<p><br><br></p>
<h3 id="Disclaimer-Start-with-Misconceptions-First">Disclaimer: Start with Misconceptions First</h3>
<p><strong>As you probably guessed, this post is written in sarcasm language.</strong></p>
<p>I got inspired by <a href="https://www.youtube.com/watch?v=RQaW2bFieo8">Derek Muller</a>, known as author of <a href="https://www.youtube.com/channel/UCHnyfMqiRRG1u-2MsSQLbXA">Verritasium</a>, with &quot;start with misconceptions first&quot;. This list describes just few of misconceptions on feedback topic I found on Github during my open-source career. If you know any more, just tell me in the comments (<em>&quot;you forgot some&quot;</em>).</p>
<p>If you know Czech, you can check my talk <a href="https://www.youtube.com/watch?v=D827D5ILfh8&amp;ab_channel=PHPlive">Jako Vinnetou a Old Shatterhand – refaktoruj nenávist v přátelství</a> from PHPLive 2016, where I address similar topic between 2 PHP frameworks.</p>
<p>So...</p>
<h3 id="How-to-Give-Feedback-that-Helps-You-Both">How to Give Feedback that Helps You Both</h3>
<p>After misconceptions we can move to really what matters - <strong>emphatic feedback</strong>. Once I read a post about people with of 30+ years long and happy marriages:</p>
<blockquote class="blockquote text-center mb-5 mt-5">
    We have a strong feeling, that when we point out mistakes we see at other people, they will change that.
</blockquote>
<p>It nails it! So what I'm trying to do apart inversion of all the 8 points above to make my online/offline feedback communication better?</p>
<h2 id="1-Is-Feedback-Desired">1. Is Feedback Desired?</h2>
<p>Do you enjoy parenting and patronizing? Neither do I. So when I give feedback, I try to find out first if the other person is even open to some.</p>
<p>There is small trick to do that:</p>
<ul>
<li><em>&quot;Well, I have some feedback for you, but I'm not sure if you'd like to hear it.&quot;</em></li>
<li>&quot;Yes, of course.&quot;</li>
<li><em>&quot;Ok, I saw your presentation and I think the letters are so small, that no one will see it.&quot;</em></li>
</ul>
<p>vs.</p>
<ul>
<li><em>&quot;Hey John, I saw your presentation and I think the letters are so small, that no one will see it.&quot;</em></li>
</ul>
<h2 id="2-What-is-My-Motivation">2. What is My Motivation?</h2>
<blockquote class="blockquote text-center mb-5 mt-5">
    Giving advices is just talking to your younger self.
</blockquote>
<p>I know this is not easy to hear, but giving feedback is partially just projection of the one who gives the feedback. Even now, when I'm writing this post, I frustrated with something else. I'm frustrated by educational systems and misconceptions it teaches people.</p>
<p>If you know your real motivation, you can work it much better and be able to give the other person not the information that you're frustrated with but information that he or she really wants.</p>
<h2 id="3-Make-a-Rapport-instead-of-an-Enemy">3. Make a Rapport instead of an Enemy</h2>
<p>No, this is not a dinosaur nor air fighter.</p>
<blockquote class="blockquote text-center mb-5 mt-5">
    If you want to persuade someone, start in a friendly way.
</blockquote>
<p>You can find this quote in all books on persuasion. I didn't know about this for a long time, so I started with rationalization arguments:</p>
<ul>
<li><em>&quot;Hey, you have to use IDE, because it will help you with productivity a lot.&quot;</em></li>
<li><em>&quot;You should use Symfony, because it's more matured than any other frameworks!&quot;</em></li>
</ul>
<p>This only forces the other for defense, even if you don't want him to:</p>
<ul>
<li>&quot;Sublime Text is just fine. It can compare to PHPStorm and is even faster!&quot;</li>
<li>&quot;I use Nette for many years and Symfony seems too complicated and is very slow.&quot;</li>
</ul>
<p>Sorry brain! Instead, you can make a <strong>rapport</strong> - a short term friendship if you like.</p>
<ul>
<li>
<p><strong>Be curious</strong>: <em>&quot;What do you mean by &quot;this is too complicated&quot;? What part exactly is too complicated?&quot;</em></p>
</li>
<li>
<p><strong>Relate to the his or her point of view</strong>: <em>&quot;I agree you might have problems reading this, since it's your first time and I use this for over 3 years and know it by heart.&quot;</em></p>
</li>
</ul>
<h2 id="4-Replace-and-quot-You-and-quot-and-the-Future-and-quot-with-and-quot-I-and-quot-and-the-Present">4. Replace &quot;You&quot; and the Future&quot; with &quot;I&quot; and the Present</h2>
<blockquote class="blockquote text-center mb-5 mt-5">
    "I'm objective", a human said.
</blockquote>
<p>When one person claims something, it's usually his own personal experience wrapped into cognitive heuristics.</p>
<ul>
<li><em>&quot;You'll definitely find IDE useful.&quot;</em></li>
</ul>
<p>vs.</p>
<ul>
<li><em>&quot;I personally find IDE useful, because it it helps me with class autocomplete. That saves me lot of time, since I use other dependencies than my code.&quot;</em></li>
</ul>
<p>As people tend to mirror each other's communication, being personal might unlock personal approach of the other person as well.</p>
<h2 id="6-Provide-a-Reason">6. Provide a Reason</h2>
<p>I'll just reuse the example above (because it shows it already and will keep you more attentive to the detail):</p>
<ul>
<li><em>&quot;I personally find IDE useful&quot;</em></li>
</ul>
<p>vs.</p>
<ul>
<li><em>&quot;I personally find IDE useful, because it it helps me with class autocomplete. That saves me lot of time, since I use other dependencies than my code.&quot;</em></li>
</ul>
<p><br><br></p>
<p>Your feedback and tips are most welcomed as I want to get better in this, so add your comment. Even with sarcastic examples from this post ;).</p>
<p><br><br></p>
<p>Happy feedbacking!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/03/19/how-to-criticize-like-a-senior-programmer</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 19 Mar 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/03/19/how-to-criticize-like-a-senior-programmer#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Monorepo on the Rise in PHP ]]></title>
                <link>https://tomasvotruba.com/blog/2018/03/15/monorepo-on-the-rise-in-php</link>
                <description><![CDATA[ <p>Do you know what a monorepo is? How to start with it? What you need and do even other programming languages use it? And what about Facebook and Google think about it?</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Javascript-Java-C-Android-iOS-Facebook-Google-Monorepo-is-Standard">Javascript, Java, C++, Android, iOS, Facebook, Google? Monorepo is Standard</h2>
<p>When you pop out of PHP bubble, you can see in <a href="https://github.com/korfuri/awesome-monorepo">awesome-monorepo</a> a collection of monorepo tools, that are used out in a wild by another languages. Google has <a href="https://bazel.build">Bazel</a>, Facebook has <a href="https://buckbuild.com">Buck</a>, Twitter and Foursqaure have <a href="https://www.pantsbuild.org">Pants</a>.</p>
<p><strong>Still a PHP-related tool is missing</strong>. Why? It might be the case, that no global company that goes open-source uses PHP as their main language.</p>
<h2 id="Symfony-Monorepo-Spreads-the-Word">Symfony Monorepo Spreads the Word</h2>
<p>PHP is aware of monorepo term mainly thanks to <a href="https://github.com/symfony/symfony">Symfony</a>, that uses it to maintain <strong>all its components, that are split to standalone</strong> read-only repositories, e.g. <a href="https://github.com/symfony/console">Symfony\Console</a>, <a href="https://github.com/symfony/event-dispatcher">Symfony\EventDispatcher</a>.</p>
<h3 id="Tool-to-Split-With">Tool to Split With</h3>
<p>Since Symfony needed a fast tool to split over 30 repositories across 3 and more branches, Fabien Potencier came with <a href="https://twitter.com/fabpot/status/739860138564149248?lang=en">splits</a> tool.</p>
<p>He also had a <a href="https://www.youtube.com/watch?v=4w3-f6Xhvu8">very interesting talk about it</a> (<a href="https://speakerdeck.com/fabpot/a-monorepo-vs-manyrepos">slides</a>), where he explains in details, how Symfony monorepo works, what is splitting and what are the needs for a build tool managing monorepo.</p>
<p><strong>But it's still to complex to start with and it doesn't cover the most common case - building monorepo from already existing repositories</strong>.</p>
<h2 id="Shopsys-Monorepo-to-Spread-a-bit-more-Word">Shopsys Monorepo to Spread a bit more Word</h2>
<p>I work on <a href="https://www.shopsys.com">Shopsys Framework</a>, an open-source e-commerce platform on Symfony and the monorepo topic finally came to the sprint to be realized. If you've read until now, <strong>you know there is not much shared know-how or support for new-commers to adopt a monorepo pattern in PHP</strong>.</p>
<p>That's how <a href="https://github.com/shopsys/monorepo-tools"><code>shopsys/monorepo-tools</code></a>, that covers both build and split was given birth by <a href="https://github.com/PetrHeinz">Petr Heinz</a>.</p>
<p>It's slowly getting better with monorepo in PHP. But still many people don't know what is difference between <em>a monorepo</em> and <em>a monolith</em>.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/03/15/monorepo-on-the-rise-in-php</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 15 Mar 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/03/15/monorepo-on-the-rise-in-php#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ NEON vs. YAML and How to Migrate Between Them ]]></title>
                <link>https://tomasvotruba.com/blog/2018/03/12/neon-vs-yaml-and-how-to-migrate-between-them</link>
                <description><![CDATA[ <p>Do you know <code>*.neon</code> format? It's config file format created in Czech Republic by <a href="https://davidgrudl.com">David Grudl</a> (author of <a href="https://github.com/nette/nette">Nette</a>) and if you're foreigner, you might know it from or <a href="https://github.com/symplify/easy-coding-standard">EasyCodingStandard</a> and <a href="https://github.com/phpstan/phpstan">PHPStan</a>. Even suggested as <a href="https://github.com/composer/composer/issues/3228"><code>composer.neon</code></a>.
<br><br>
And <code>*.yaml</code> is similar format used almost everywhere else.
<br><br>
<strong>You spot the suffix is different, but what about syntax differences? And which one is better?</strong></p> ]]></description>
                <content:encoded><![CDATA[ <p>None of them is perfect, they both have strong parts and weak parts. But the more I travel to abroad conferences, meetups or repositories, the more I hear <strong>nobody understand differences between them or their advantages to each other</strong>. Since I meet mainly with Symfony and Nette code, I had to investigate them a bit deeper.</p>
<blockquote class="blockquote text-center mt-lg-5 mb-lg-5">
    <a href="https://www.youtube.com/watch?v=3_EtIWmja-4">There are no solutions. There are only trade-offs.</a>
    <footer class="blockquote-footer">
        Thomas Sowell, author of A Conflict of Visions: Ideological Origins of Political Struggles
    </footer>
</blockquote>
<p>Here is a summary of what I found and how to migrate to each other. I'll write about differences and places, where syntax fail me the most.</p>
<h2 id="How-is-Syntax-Differ">How is Syntax Differ?</h2>
<p>70 % of syntax is similar:</p>
<pre><code class="language-yaml">services:
    Symplify\CodingStandard\Fixer\Import\ImportNamespacedNameFixer: ~</code></pre>
<p>But what about?</p>
<pre><code class="language-yaml">items:
  -
    - { key: value }</code></pre>
<p>Of course you can Google documentation and try to understand it. But documentation is  incomplete or for older version than you use. <strong>The best way to learn it for me is</strong> with online parsers:</p>
<ul>
<li><a href="https://ne-on.org">ne-on.org</a></li>
<li><a href="http://yaml-online-parser.appspot.com">yaml-online-parser.appspot.com</a></li>
</ul>
<p><br></p>
<h3 id="1-Tabs-vs-Spaces">1. Tabs vs. Spaces</h3>
<p><strong>Neon</strong></p>
<p>As neon was born as free format, it allows to use both spaces and tabs.</p>
<p><strong>Yaml</strong></p>
<p>Only spaces are allowed. Since most of projects have coding standards, I prefer using one format in whole code.</p>
<p><br></p>
<h3 id="2-Magic-List-Combination-vs-Single-Type">2. Magic List Combination vs. Single Type</h3>
<pre><code class="language-yaml">services:
    - SomeService
    SomeService: ~</code></pre>
<p><strong>Neon</strong></p>
<p>Could you guess the output? 1 item? Syntax error?</p>
<pre><code class="language-php">array (1)
    services =&gt; array (2)
        0 =&gt; "SomeService" (11)
        SomeService =&gt; "~"</code></pre>
<p>Neon allows to combine indexed arrays and lists.
And do you work with or create with such lists in PHP?</p>
<p><strong>Yaml</strong></p>
<p>Parsing would fail there, because Yaml allows only one approach:</p>
<pre><code class="language-yaml">services:
    - SomeService
    - SomeService

# with 2 items in array</code></pre>
<p>or</p>
<pre><code class="language-yaml">services:
    SomeService: ~
    SomeService: ~

# with 1 item</code></pre>
<p>This difference is one of the biggest WTFs, because I had to think about format and possible merge error every time I used lists... or indexed arrays... or is it arrays? Uff.</p>
<p><br></p>
<h3 id="3-Content-on-Multi-lines">3. Content on Multi-lines</h3>
<p>I write posts in Statie, where you can use Yaml to configure per-post variables like perex:</p>
<p><strong>Neon</strong></p>
<pre><code class="language-yaml">perex: '''
    This is long multiline perex,
that takes too much space.
'''</code></pre>
<p>Note it can be aligned to left side.</p>
<p><strong>Yaml</strong></p>
<pre><code class="language-yaml">perex: |
    This is long multiline perex,
    that takes too much space.</code></pre>
<p>But here it must be indented on every line.</p>
<p><br></p>
<h3 id="4-Very-Complex-Syntax">4. Very Complex Syntax</h3>
<p><strong>Neon</strong></p>
<p>In Neon you can use <em>entities</em> and do this:</p>
<pre><code class="language-yaml">someValue: Column(type=int, nulls=true)</code></pre>
<p>Could you guess what it is? Parameters, arguments, service decoration?</p>
<pre><code class="language-php">array (1)
    someValue =&gt; Nette\Neon\Entity
        value =&gt; "Column" (6)
        attributes =&gt; array (2)
            type =&gt; "int" (3)
            nulls =&gt; true</code></pre>
<p>Personally <strong>I prefer explicit, clear naming</strong> combined with easier scalability:</p>
<pre><code class="language-yaml">someValue:
    value: "Column"
    attributes:
        type: "int"
        nulls: true</code></pre>
<p><strong>Yaml</strong></p>
<p>You can do similar shenaniganz with Yaml as well thanks to <code>Symfony\ExpressionLanguage</code></p>
<pre><code class="language-yaml">services:
    App\Mailer:
        arguments: ["@=service('App\\\\Mail\\\\MailerConfiguration').getMailerMethod()"]</code></pre>
<p>If you want to see real-life example, I <a href="/blog/2018/03/08/why-is-collector-pattern-so-awesome/#2-use-expression-language">tried it once</a>. But went quickly back because I could not remember what exactly that means and how it work.</p>
<h2 id="How-is-the-Ecosystem-Support">How is the Ecosystem Support?</h2>
<p>This is the most important question when it comes to open-source code. You can create your own natural language, that is smart, easy to learn, context aware and super fast. But what if <a href="https://en.wikipedia.org/wiki/List_of_languages_by_total_number_of_speakers">1.39 billion people speaks English already</a>?</p>
<h3 id="PHPStorm-Support">PHPStorm Support</h3>
<p><strong>Neon</strong></p>
<p>You can install <a href="https://plugins.jetbrains.com/plugin/7060-neon-support">Neon Plugin</a>, that handles param and class autocomplete very nicely. It's enabled for every <code>*.neon</code> file by default.</p>
<p><strong>Yaml</strong></p>
<p>Yaml support is included in <a href="https://plugins.jetbrains.com/plugin/7219-symfony-plugin">Symfony Plugin</a>. It needs to by enabled per project. It works great, there is just one last thing I miss. It already completes services for Symfony 3.2- format:</p>
<pre><code class="language-yaml">services:
    some_name:
        class: AutocompletedClass</code></pre>
<p>But since Symfony 3.3 there is <a href="https://symfony.com/blog/new-in-symfony-3-3-simpler-service-configuration#short-syntax-for-service-configuration">short syntax for services</a>:</p>
<pre><code class="language-yaml">services:
    ManuallyTypedService: ~</code></pre>
<p>And it is missing autocomplete in time being. <strong>Do you want autocomplete for this case too?</strong> <a href="https://github.com/Haehnchen/idea-php-symfony2-plugin/issues/1153">Upvote this issue</a> or send PR in Java to the plugin.</p>
<p>Also <a href="https://github.com/phpstan/phpstan/pull/222">Github lacks of Neon support</a>.</p>
<h2 id="Who-is-the-Winner">Who is the Winner?</h2>
<p>Which one to pick? It depends on what is <strong>important to you</strong>. If you use Nette and work in Czech company and Neon is weapon of choice for you - it's ok.</p>
<p>But what if you're <strong>making open source for the whole world</strong>?</p>
<p><a href="https://xkcd.com/927/"></p>
<img src="https://imgs.xkcd.com/comics/standards.png">
<p></a></p>
<h3 id="Why-are-Standards-so-Important">Why are Standards so Important?</h3>
<p>I was on a train trip in Hungary and I was thirsty. I went to classic food shop and pick first bottle <strong>with still water</strong> I saw. I wanted still water cause gas hurts me and wanted to drink a lot. And I'm drunk when it comes to water in summer.</p>
<img src="/assets/images/posts/2018/neon-yaml/bottle-mixed.jpg" class="img-thumbnail">
<p>At least I though I picked the right one until I opened it. In every single country I've been to so far, the <strong>blue is always still water</strong>. But not in Hungary!</p>
<p>As <a href="http://chrisinbrnocr.blogspot.cz/2015/08/european-heat-wave.html">Chris says</a>: &quot;In Hungary the color code is reversed where blue means sparkling and red means flat.&quot; And there is even question <a href="https://www.tripadvisor.com.au/ShowTopic-g274887-i263-k7231074-Water_bottle_cap_colour_codes-Budapest_Central_Hungary.html">on Tripadvisor</a> on this topic.</p>
<p><br></p>
<p>For all the reasons above (thirsty-human-friendly-bottle-colors included), after looking at problem from various points of view and discussing with my Github and PHP friends, I came to conclusion that Yaml is better for me.</p>
<h2 id="How-to-Migrate-from-Neon-to-YAML">How to Migrate from Neon to YAML?</h2>
<p>But EasyCodingStandard was running on Neon that was loaded by my few classes to Symfony Kernel, so how to migrate to Yaml?</p>
<p><strong>Imports</strong></p>
<pre><code class="language-diff">-includes:
+imports:
-    - packages/EasyCodingStandard/config/psr2.neon
+    - { resource: 'packages/EasyCodingStandard/config/psr2.yml' }

-    - common/array.neon
-    - common/control-structures.neon
-    - common/docblock.neon
+    - { resource: 'common/*.yml' }</code></pre>
<p><strong>Lists</strong></p>
<pre><code class="language-diff"> services:
     # class should be Abstact or Final
-    - SlamCsFixer\FinalInternalClassFixer
+    SlamCsFixer\FinalInternalClassFixer: ~
     ArrayFixer: ~</code></pre>
<p><strong>Quoting parameters</strong></p>
<pre><code class="language-diff"> parameters:
     skip:
         SlevomatCodingStandard\Sniffs\TypeHints\TypeHintDeclarationSniff:
-            - *packages/CodingStandard/src/Sniffs/*/*Sniff.php
+            - '*packages/CodingStandard/src/Sniffs/*/*Sniff.php'</code></pre>
<p><strong>Multi-lines</strong></p>
<pre><code class="language-diff">-perex: '''
+perex: |
     Do you know `*.neon` format? It's config file
-format created in Czech Republic...
+    format created in Czech Republic...
-'''</code></pre>
<p>And from <code>*.yml</code> to <code>*.neon</code>? Just revert <code>-</code> and <code>+</code> :).</p>
<p>To see what code exactly had to change:</p>
<ul>
<li>see <a href="https://github.com/symplify/symplify/pull/651">pull-request on Symplify\EasyCodingStandard</a></li>
<li>or <a href="https://github.com/rectorphp/rector/pull/335">Rector with <code>Extension</code> =&gt; <code>services</code> migration</a></li>
</ul>
<p><br></p>
<p>Which format do you prefer and why? Do you have some other WTF examples or migration tips? Let me know in the comments!</p>
<p><br><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/03/12/neon-vs-yaml-and-how-to-migrate-between-them</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 12 Mar 2018 00:00:00 +0000</pubDate>
                                    <updated>2018-12-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Dec 2018 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Dec 2018 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/03/12/neon-vs-yaml-and-how-to-migrate-between-them#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Why is Collector Pattern so Awesome ]]></title>
                <link>https://tomasvotruba.com/blog/2018/03/08/why-is-collector-pattern-so-awesome</link>
                <description><![CDATA[ <p>How to achieve <em>open for extension</em> and <em>closed for modification</em> <a href="https://github.com/jupeter/clean-code-php#openclosed-principle-ocp">one of sOlid principals</a>?
<br><br>
Why Collector pattern beats config tagging? How to use the in Symfony application? How it turns locked architecture into scaling one?</p> ]]></description>
                <content:encoded><![CDATA[ <p>I already <a href="/blog/2017/04/14/3-symfony-and-laravel-patterns-that-make-code-easy-to-extends-without-modification/#3-like-collecting-stamps-just-on-steroids">wrote about Collector pattern as one we can learn from Symfony or Laravel</a>. But they're so useful and underused I have need to write a more about them.</p>
<p>Yesterday I worked on <a href="https://github.com/rectorphp/rector">Rector</a> and <strong>needed an entry point to add one or more Rectors by user</strong>.</p>
<p><br></p>
<p>To give you a context, now you can register particular Rectors to config as in Symfony:</p>
<pre><code class="language-php">use Rector\Privatization\Rector\MethodCall\PrivatizeLocalGetterToPropertyRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;rule(PrivatizeLocalGetterToPropertyRector::class);
};</code></pre>
<h2 id="Towards-Scalable-Architecture">Towards Scalable Architecture</h2>
<p>Well, we could accept PR and hard-code it into application, that would work too. But the point is to allow end-user to <strong>add as many customs services of specific type as he or she wants without need to modify our application</strong>.</p>
<h3 id="Open-to-Extension-Closed-to-Modification">Open to Extension, Closed to Modification</h3>
<p>This is how <em>open/closed principle</em> looks like. If you still don't have the idea, see very nice and descriptive examples in <a href="https://github.com/jupeter/clean-code-php#openclosed-principle-ocp">jupeter/clean-code-php</a>.</p>
<p>Let's start with ideas:</p>
<h2 id="1-Add-a-Provider-and-Collect-it-in-CompilerPass">1. Add a Provider and Collect it in CompilerPass?</h2>
<p>My first idea was a provider that would return such Rector:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace App\Rector;

use Rector\Contract\Rector\RectorInterface;

final class SymfonyRectorProvider implements RectorInterface
{
    public function provide()
    {
        $rector = new CustomSymfonyRector;
        // some custom modifications

        return $rector;
    }
}</code></pre>
<p><br></p>
<p>Such service is registered by user to the config:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();
    $services-&gt;defaults()
        -&gt;autowire();

    $services-&gt;set(\App\Rector\SymfonyRectorProvide::class);
};</code></pre>
<p><br></p>
<p>And collected by our application via <code>CompilerPass</code>:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace Rector\RectorBuilder\DependencyInjection\CompilerPass;

use Rector\Rector\RectorCollector;
use Rector\RectorBuilder\Contract\RectorProviderInterface;
use Symfony\Component\DependencyInjection\Compiler\CompilerPassInterface;
use Symfony\Component\DependencyInjection\ContainerBuilder;
use Symfony\Component\ExpressionLanguage\Expression;
use Symplify\PackageBuilder\DependencyInjection\DefinitionFinder;

final class RectorProvidersCompilerPass implements CompilerPassInterface
{
    public function process(ContainerBuilder $containerBuilder): void
    {
        $rectorCollectorDefinition = $containerBuilder-&gt;getDefinition(RectorCollector::class);

        $rectorProviderDefinitions = DefinitionFinder::findAllByType(
            $containerBuilder,
            RectorProviderInterface::class
        );

        foreach ($rectorProviderDefinitions as $rectorProviderDefinition) {
            $providedRector = new Expression(
                sprintf('service("%s").provide()', $rectorProviderDefinition-&gt;getClass())
            );
            $rectorCollectorDefinition-&gt;addMethodCall('addRector', [$providedRector]);
        }
    }
}</code></pre>
<p>Are you curious what <code>DefinitionFinder</code>? It's just <a href="https://github.com/symplify/symplify/blob/3d058becb57efefe2307c88ee94acbfbd15ebd1c/packages/PackageBuilder/src/DependencyInjection/DefinitionFinder.php">a helper class</a> around <code>ContainerBuilder</code>.</p>
<h2 id="2-Use-Expression-Language">2. Use Expression Language?</h2>
<p>Wait, what is this?</p>
<pre><code class="language-php">$providedRector = new Expression(
    sprintf('service("%s").provide()', $rectorProviderDefinition-&gt;getClass())
);</code></pre>
<p>That is part of <a href="https://symfony.com/doc/current/service_container/expression_language.html">Symfony Expression Language</a> that allows calling methods on services before container compilation.</p>
<p>Could you guess, how the final code in compiled container would look like?</p>
<p><br></p>
<p>Something like this:</p>
<pre><code class="language-php">$rectorCollector = new Rector\Rector\RectorCollector;
$rectorCollector-&gt;addRector((new App\Rector\SymfonyRectorProvider)-&gt;provide());</code></pre>
<p><br></p>
<p><strong>To be honest, it's magic and unclear code to me.</strong> It also needs <code>symfony\expression</code> package to be installed manually. I don't want to refer people to this paragraph just to understand 3 lines in <code>CompilerPass</code>. That code smells bad.</p>
<p>But what now?</p>
<h3 id="From-One-to-One-to-One-to-Many">From One-to-One to One-to-Many</h3>
<p>To simulate real life we should have at least 2 problems at once :)</p>
<p>The most common case is product in e-commerce. Product <em>JBL Charge 3</em> has 1 category - <em>speaker</em>. Ok, you write a code with Doctrine Entity that each product has one category. But as it happens in life, <em>change is the only constant</em>, website grows and search expands with new request from your boss: &quot;A product needs to have multiple categories&quot;. What now?</p>
<p>The same happened for Rector - <strong>I need to add multiple Rectors in <code>RectorProvider</code></strong>. What now?</p>
<p>Damn! Mmm, tell people to use one provider per Rector?</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();
    $services-&gt;defaults()
        -&gt;autowire();

    $services-&gt;set(\App\Rector\SymfonyRectorProvider::class);

    $services-&gt;set(\App\Rector\AnotherSymfonyRectorProvider::class);
};</code></pre>
<p>Quick solution, yet smelly:</p>
<ul>
<li>But how to share common code between similar RectorProvider?</li>
<li>Duplicate and decouple services?</li>
<li>And what is the point of provider, if it can only add 1 new Rector?</li>
<li>Why not register them in <code>services:</code> directly like the others?</li>
</ul>
<p>And flow of <em>WTFs</em> is coming at you.</p>
<h2 id="3-Does-Collector-Scale">3. Does Collector Scale?</h2>
<p>Let's try a different approach that Colletor pattern screams at us. We now have one-to-one <code>RectorColletor</code> implementation:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace Rector\Rector;

use Rector\Core\Contract\Rector\RectorInterface;

final class RectorCollector
{
    // ...

    public function addRector(RectorInterface $rector): void
    {
        $this-&gt;rectors[] = $rector;
    }
}</code></pre>
<h3 id="What-do-we-want">What do we want?</h3>
<ul>
<li>drop that expression language magic</li>
<li>support one-to-many case</li>
<li>have clear API with priority in PHP code rather in <code>CompilerPass</code> or config</li>
<li>have typehint control</li>
</ul>
<h3 id="Drop-that-Expression-Language-Magic">Drop that Expression Language Magic</h3>
<p>Thanks to Collector pattern we now <strong>have 1 place to solve these problems</strong> at:</p>
<pre><code class="language-diff"> &lt;?php declare(strict_types=1);

 namespace Rector\Rector;

 use Rector\Contract\Rector\RectorInterface;
 use Rector\RectorBuilder\Contract\RectorProviderInterface;

 final class RectorCollector
 {
     public function addRector(RectorInterface $rector): void
     {
         $this-&gt;rectors[] = $rector;
     }
+
+    public function addRectorProvider(RectorProviderInterface $rectorProvider): void
+    {
+         $this-&gt;addRector($rectorProvider-&gt;provide());
+    }
 }</code></pre>
<p><br></p>
<p>And thanks to that, <strong>we can cleanup</strong> <code>CompilerPass</code>:</p>
<pre><code class="language-diff">&lt;?php declare(strict_types=1);

namespace Rector\RectorBuilder\DependencyInjection\CompilerPass;

use Rector\Rector\RectorCollector;
use Rector\RectorBuilder\Contract\RectorProviderInterface;
use Symfony\Component\DependencyInjection\Compiler\CompilerPassInterface;
use Symfony\Component\DependencyInjection\ContainerBuilder;
use Symfony\Component\ExpressionLanguage\Expression;
use Symplify\PackageBuilder\DependencyInjection\DefinitionFinder;

final class RectorProvidersCompilerPass implements CompilerPassInterface
{
    public function process(ContainerBuilder $containerBuilder): void
    {
        $rectorCollectorDefinition = $containerBuilder-&gt;getDefinition(RectorCollector::class);

        $rectorProviderDefinitions = DefinitionFinder::findAllByType(
            $containerBuilder,
            RectorProviderInterface::class
        );

        foreach ($rectorProviderDefinitions as $rectorProviderDefinition) {
-           $providedRector = new Expression(
-               sprintf('service("%s").provide()', $rectorProviderDefinition-&gt;getClass())
-           );
-           $rectorCollectorDefinition-&gt;addMethodCall('addRector', [$providedRector]);
+           $rectorCollectorDefinition-&gt;addMethodCall('addRectorProvider', [
+               '@' . $rectorProviderDefinition-&gt;getClass()
+           ]);
        }
    }
}</code></pre>
<p><br></p>
<h3 id="How-do-we-Provide-Multiple-Items">How do we Provide Multiple Items?</h3>
<p>I didn't forget, our dear manager. Do you have idea how would you add it?</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace Rector\RectorBuilder\Contract;

use Rector\Core\Contract\Rector\RectorInterface;

interface RectorProviderInterface
{
   /**
    * @return RectorInterface[]
    */
   public function provide(): array
}</code></pre>
<p><br></p>
<p>And update <code>RectorCollector</code> class:</p>
<pre><code class="language-diff"> &lt;?php declare(strict_types=1);

 namespace Rector\Rector;

 use Rector\Contract\Rector\RectorInterface;
 use Rector\RectorBuilder\Contract\RectorProviderInterface;

 final class RectorCollector
 {
     public function addRector(RectorInterface $rector): void
     {
         $this-&gt;rectors[] = $rector;
     }

     public function addRectorProvider(RectorProviderInterface $rectorProvider): void
     {
-         $this-&gt;addRector($rectorProvider-&gt;provide());
+         foreach ($rectorProvider-&gt;provide() as $rector) {
+             $this-&gt;addRector($rector);
+         }
     }
 }</code></pre>
<p>Now we have:</p>
<p>✅ single entry point for <code>Collector</code> + <code>Provider</code></p>
<p>✅ typehinted <code>RectorInterface</code> control in code</p>
<p>✅ clean config for use and compiler for our code</p>
<p>✅ removed <code>symfony/expression-language</code> dependency</p>
<h2 id="4-Add-Tagging">4. Add Tagging?</h2>
<p>We forget tagging, right? The most <a href="/blog/2017/02/12/drop-all-service-tags-in-your-nette-and-symfony-applications/">spread useless code in Symfony configs</a>.</p>
<p><br></p>
<blockquote class="blockquote text-center">
    "Perfection is achieved, not when there is nothing more to add, but when there is nothing left to take away."
    <footer class="blockquote-footer">Antoine de Saint-Exupery</footer>
</blockquote>
<p><br></p>
<p>Why would you add it and where? I don't take arguments like &quot;well, it's historical reasons&quot; and <a href="https://symfony.com/blog/new-in-symfony-3-4-simpler-injection-of-tagged-services"><code>!tagged</code></a>, since it add more coupling.</p>
<p>Try to convince me though if you're sure about its advantages.</p>
<h3 id="How-was-our-Path-from-the-End">How was our Path from the End?</h3>
<p>✅ Add provider</p>
<p>❌ Use expression language?</p>
<p>✅ Does collector scale?</p>
<p>❌ Add tagging</p>
<h2 id="and-quot-Git-Story-and-quot-over-git-history">&quot;Git Story&quot; over git history</h2>
<p>I want to share with you one last idea. I could show you the final commit - or even worse - just the final versions of <code>RectorProviderInterface</code>, <code>RectorCollector</code> and <code>RectorProvidersCompilerPass</code>. But what could you take from such a code? <strong>Nothing, because only when we fail, we learn something new.</strong></p>
<p><strong>Same can be applied to git history. When I see 2 final files with 2 commits, I learn nothing new.</strong> And pose questions and comments on blind paths, that author already took (and explains me again in words to my comments).</p>
<p>Next time you squash 20 commits to 1, remember:</p>
<blockquote class="blockquote text-center">
    Git should tell the story, as the human history does.
</blockquote>
<p><br><br></p>
<p>Happy collecting!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/03/08/why-is-collector-pattern-so-awesome</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 08 Mar 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/03/08/why-is-collector-pattern-so-awesome#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Rector: Part 3 - Why Instant Upgrades ]]></title>
                <link>https://tomasvotruba.com/blog/2018/03/05/rector-part-3-why-instant-upgrades</link>
                <description><![CDATA[ <p>Why are instant upgrades better than old school <em>manual upgrades</em>? Why is the path to find exact before/after like hell-road?
Why you should use Rector and when?</p> ]]></description>
                <content:encoded><![CDATA[ <p><em>Read also:</em></p>
<ul>
<li><a href="/blog/2018/02/19/rector-part-1-what-and-how/">Part 1 - What and How</a></li>
<li><a href="/blog/2018/02/26/rector-part-2-maturity-of-php-ecocystem-and-founding-fathers/">Part 2 - Maturity of PHP Ecosystem and Founding Fathers</a></li>
</ul>
<p><br></p>
<h2 id="Why-was-Rector-needed">Why was Rector needed</h2>
<p>You need 2 things to upgrade PHP application to newer version of the framework you use:</p>
<h3 id="1-The-Knowledge">1. The Knowledge</h3>
<p>Most of you follow changes in Symfony or Nette. You know that <a href="https://github.com/symfony/symfony/blob/master/UPGRADE-4.0.md#process"><code>ProcessBuilder</code> was removed</a> and that you'll have to migrate to <code>Process</code> class only. You know that <a href="https://forum.nette.org/cs/26250-pojdte-otestovat-nette-2-4-rc"><code>Nette\Object</code> was removed</a> and that you'll have to rewrite all <code>@method</code> annotation to real methods.</p>
<p>You read blogs, follow news on forum, read all <code>CHANGELOG.md</code> and <code>UPGRADE.md</code> files and sometimes commits, to find out what all has changed. <strong>You have the knowledge</strong>.</p>
<p>Or don't you? <strong>Imagine you could drop delegate all this to a computer.</strong></p>
<h3 id="2-The-Resources">2. The Resources</h3>
<p>You work in a company where up-to-date it very important value. Your employer finances upgrades and also your education in it (pays you to get the knowledge). Once a 6 months you have dedicated paid time to update all packages to most recent versions. <strong>You have the resources</strong></p>
<p>Do you find yourself in such situation? If so, <strong>you belong to 5 % blessed and active people around me.</strong></p>
<h2 id="How-Expensive-are-Upgrades-Now">How Expensive are Upgrades Now?</h2>
<p>From my experience with consulting over 50 PHP projects in last 4 years, it can take 80-400 hours per one minor version upgrade (e.g. Symfony 2.7 → 2.8), including all deprecations.</p>
<h3 id="1-Teams-are-not-Supported-in-Upgrades">1. Teams are not Supported in Upgrades</h3>
<p>Teams don't have space to find out what changed between Symfony 2.7 and Symfony 2.8. They don't care, because their employer cares mostly about creating new website as fast and as cheap as possible. And that's logical.</p>
<p>That's why most of <a href="/trainings">lectures</a> I make is about giving teams <em>the knowledge</em> that they can use with their very limited resources to make the best out of it.</p>
<p>Such approach also naturally leads to huge legacy code, team performance drop from 100 % to 20 %, which consequently leads to hiring 5x more people to keep productivity the same, more money, and pressure to faster development, which lead to huge legacy code...</p>
<h3 id="2-Are-Deprecations-Easy-to-Find">2. Are Deprecations Easy to Find?</h3>
<p>Let's say you have time to explore the Internet, follow <a href="https://twitter.com/symfony_en">Symfony News on Twitter</a>, read <a href="https://symfony.com/blog/category/living-on-the-edge">every news post on Symfony Blog</a> or know where on the Nette forum are located <a href="https://forum.nette.org/en/f78-release-announcements-news">Release Notes</a>.</p>
<p>Sometimes if you're lucky there is <code>UPGRADE-x.md</code> in project's Github repository, like <a href="https://github.com/symfony/symfony/blob/master/UPGRADE-4.0.md"><code>UPGRADE-4.0.md</code></a> in Symfony 4 repository. But what if you need upgrade to version 3.x? Could you find it? Well no, but yes in <a href="https://github.com/symfony/symfony/tree/3.4">3.x branch</a>.</p>
<p>And sometimes these changes are in files called <code>CHANGELOG-x.md</code>. But more often <strong>they're newer to be seen and you have to go <code>git blame</code> in Github specific line and hope for an answer</strong>. And just pray that there is PR with more detailed changes with tests as well and not direct set of commits to the <code>master</code> branch without context.</p>
<img src="/assets/images/posts/2018/rector-3/frustration.jpg" class="img-thumbnail">
<h3 id="3-When-We-Find-Them-are-They-Valid">3. When We Find Them, are They Valid?</h3>
<p>Sometimes there can be bare useless description, like <a href="https://github.com/symfony/symfony/blob/master/UPGRADE-4.0.md#process">in <code>UPGRADE-4.0</code></a>:</p>
<p><em>The <code>Symfony\Component\Process\ProcessBuilder</code> class has been removed, use the <code>Symfony\Component\Process\Process</code> class directly instead.</em></p>
<p>Do you mean like this?</p>
<pre><code class="language-diff">-use Symfony\Component\Process\ProcessBuilder;
+use Symfony\Component\Process\Process;

-$builder = new ProcessBuilder();
+$builder = new Process();
 $builder-&gt;setArguments(['build', '-force', '-var "blah=blah"', 'path/to/json.json'])
    -&gt;getProcess();</code></pre>
<p>Unfortunately no and our investigative programming begins. Git blame..., Google? Symfony Docs?</p>
<p>Sometimes <strong>they are embodied in the best place - the code</strong>. Kudos to all developers who do it like that! When running this method, you'll be informed:</p>
<pre><code class="language-php">public function add()
{
    trigger_error('Method add() is deprecated, use addHtml() instead.', E_USER_DEPRECATED);
}</code></pre>
<h3 id="4-Found-them-and-Valid-But-are-They-Standardized">4. Found them and Valid! But are They Standardized?</h3>
<p>Sometimes the maintainer goes as far to deprecate code slowly (!= remove):</p>
<pre><code class="language-php">trigger_error('Method add() is deprecated, use addHtml() instead.', E_USER_DEPRECATED);</code></pre>
<p>Which is good enough for start. Symfony even has <a href="https://symfony.com/doc/current/components/phpunit_bridge.html">PHPUnit Bridge</a> that tries to detect those deprecations. Would you know what exactly do you need to change?</p>
<img src="/assets/images/posts/2018/rector-3/report.png" class="img-thumbnail">
<p>But what class? What line?</p>
<p>But that's not the only &quot;standard&quot;.</p>
<p><a href="https://xkcd.com/927/
"></p>
<img src="https://imgs.xkcd.com/comics/standards.png" class="img-thumbnail">
<p></a></p>
<p>There is one more way I wrote about in <a href="/blog/2017/09/11/how-to-write-open-source-in-php-3-deprecating-code/#today-s-topic-changed-method-name">How to write Open-Source in PHP 3: Deprecating Code</a>.</p>
<p>The <code>@deprecated</code> annotation:</p>
<pre><code class="language-php">/**
 * @deprecated Method add() is deprecated, use addHtml() instead
 */
public function add()
{
    // ...
}</code></pre>
<p>Which is rather note in the code than helpful to user, like concept post about that great idea your never published. <strong>What happens when <code>-&gt;add()</code> method is called? Nothing.</strong> And in next mayor version you get <em>calling non-existing method</em> error.</p>
<p>Similar tool to PHPUnit Bridge is <a href="https://github.com/sensiolabs-de/deprecation-detector"><code>deprecation-detector</code></a>, that tries to catch code with <code>@deprecated</code> annotation. Again, not much standardized.</p>
<p>And that's Symfony, my friends, which <strong>does the best job for <a href="https://symfony.com/doc/current/contributing/code/bc.html">Backward Compatibility Promise</a> in PHP</strong>. <strong>What about those other 50 packages your application uses?</strong></p>
<h3 id="Outsource-all-this">Outsource all this?</h3>
<p>Would you like to do this job instead of developing your application? Most people wouldn't, so they hire me as a consultant to help them with it. <strong>But would you hire somebody, who would download all dependencies your application need in correct version for you or would you rather start using composer?</strong></p>
<h2 id="Embodied-Cognition-instead-of-Investigative-Programming">Embodied Cognition instead of Investigative Programming</h2>
<p>I consulted over 50 projects in great depth of legacy. We always tried to figure out, where to start.</p>
<ul>
<li>&quot;This is how it's done in your project, and this is the way in Symfony.&quot;</li>
</ul>
<p>or</p>
<ul>
<li>&quot;This is how it's done in Symfony 2.8 and this is the way in Symfony 3.0.&quot;</li>
</ul>
<h3 id="Legacy-Projects-Well-Paid-Projects-The-Way-Go">Legacy Projects === Well Paid Projects !== The Way Go</h3>
<p>Over and over again, just version numbers and the desired framework change. After few years I started to feel like <em>a dumb copy-paster</em>. I follow every new feature on Symfony, test it, verify its usefulness, then distill 100 hours of my work to 3 hour lecture. I'm lazy and this started to itch my mind. Is this the really education I want to encourage in the world? Well, majority of lecturers do exactly same work, well paid work. But is that reason to do it too?</p>
<h3 id="Delegate-Procreate">Delegate → Procreate</h3>
<p>I borrow a term from psychology - <strong>embodied cognition</strong>. It's something you don't have to remember, cause it's in you. It's like riding a bike. I don't know what words to use and where to find out how to ride a bike - I just know it, cause it's in  my internal reflexes.</p>
<p>Could something similar happen to upgrading applications? A single place that knows what to do and doesn't have to explain every programmer over and over again?</p>
<p><br></p>
<p>These all kinds of problems Rector solves for you.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/03/05/rector-part-3-why-instant-upgrades</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 05 Mar 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/03/05/rector-part-3-why-instant-upgrades#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ New in Symplify 3: 4 Improvements in EasyCodingStandard ]]></title>
                <link>https://tomasvotruba.com/blog/2018/03/01/new-in-symplify-3-4-improvements-in-easy-coding-standard</link>
                <description><![CDATA[ <p>What is new in Easy Coding Standard 3?
Nice diffs for fixable sniffs, smart excluding, support for sniff warnings and one more...</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="1-Exclude-Files-or-Dirs">1. Exclude Files or Dirs</h2>
<p>Do you have <code>src/Migrations</code> that you need to skip from your <code>vendor/bin/ecs check src</code> command?</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\EasyCodingStandard\ValueObject\Option;

return function (ContainerConfigurator $containerConfigurator): void {
    $parameters = $containerConfigurator-&gt;parameters();

    $parameters-&gt;set(Option::EXCLUDE_PATHS, [
        __DIR__ . '/src/Migrations/*Migration.php',
    ]);
};
</code></pre>
<p>With favorite <a href="http://php.net/manual/en/function.fnmatch.php"><code>fnmatch()</code> function</a> on board.</p>
<h2 id="2-Warnings-are-Reported-for-Specific-Sniffs">2. Warnings are Reported for Specific Sniffs</h2>
<p><a href="https://github.com/symplify/symplify/pull/481" class="btn btn-dark btn-sm mb-3 mt-2">
Check the PR #481
</a></p>
<p>Sniff warnings are skipped by default, because it doesn't make sense to differentiate errors vs warnings. Yet some official Sniffs only produce warnings and that made them useless. Like <code>PHP_CodeSniffer\Standards\Squiz\Sniffs\PHP\CommentedOutCodeSniff</code>.</p>
<p>That changed. New property <a href="https://github.com/symplify/symplify/blob/3d058becb57efefe2307c88ee94acbfbd15ebd1c/packages/EasyCodingStandard/packages/SniffRunner/src/File/File.php#L52"><code>$reportWarningsSniffs</code> in <code>Symplify\EasyCodingStandard\SniffRunner\File\File</code></a> now lists all sniffs, that report warnings in ECS as well.</p>
<p><strong>Do you miss useful Sniff that reports only warnings?</strong> Send PR to add it.</p>
<h2 id="3-Nice-and-Clear-Diff-over-Boring-Table-Report">3. Nice and Clear Diff over Boring Table Report</h2>
<p><a href="https://github.com/symplify/symplify/pull/474" class="btn btn-dark btn-sm mb-3 mt-2">
Check the PR #474
</a></p>
<p>Inspired by <a href="https://github.com/friendsofphp/php-cs-fixer">PHP CS Fixer</a> we've decided to <strong>use files diffs everywhere wherever it saves user daunting reading</strong>.</p>
<p>When a <strong>fixable sniff found an error</strong>, ECS reported it like this:</p>
<pre><code class="language-bash"> ------ --------------------------------------------------------------------------------------------
  Line   src/Posts/Year2017/Ast/SomeClass.php
 ------ --------------------------------------------------------------------------------------------
  10     Property $someProperty should use doc block instead of one liner
         (SomeSniff)</code></pre>
<p>But why bother with such detailed text information, if the ECS will fix it to better form anyway?</p>
<p>From now on, <strong>it is reported the PHP CS Fixer-way like all the fixers</strong>:</p>
<pre><code class="language-diff">@@ -1,14 +1,13 @@
 final class SomeClass
 {
+    /**
+     * @var SomeType
+     */
-    /** @var SomeType */
     private $someProperty;
 }

    ----------- end diff -----------

Applied checkers:

 - SomeSniff</code></pre>
<p>Which one do you prefer?</p>
<h2 id="4-Skip-Sniff-Codes-instead-of-Whole-Sniffs">4. Skip Sniff Codes instead of Whole Sniffs</h2>
<p><a href="https://github.com/symplify/symplify/pull/388" class="btn btn-dark btn-sm mb-3 mt-2">
Check the PR #388
</a></p>
<p>If you wanted to skip specific part of sniff, you had to <strong>exclude whole sniff</strong> via &quot;skip&quot; option.
But what if you liked all the other codes? <strong>Now you can:</strong></p>
<pre><code class="language-php">use PHP_CodeSniffer\Standards\Generic\Sniffs\PHP\LowerCaseTypeSniff;
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\EasyCodingStandard\ValueObject\Option;

return function (ContainerConfigurator $containerConfigurator): void {
    $parameters = $containerConfigurator-&gt;parameters();

    $parameters-&gt;set(Option::SKIP, [
        // old in Symplify 2
        LowerCaseTypeSniff::class =&gt; null,

        // new in Symplify 3
        LowerCaseTypeSniff::class . '.SpecificCode' =&gt; null,

        // new in Symplify 3 - only some files
        LowerCaseTypeSniff::class . '.SpecificCode' =&gt; [
            __DIR__ . '/src/Command/*'
        ]
    ]);
};</code></pre>
<p>Thanks <a href="https://github.com/ostrolucky">@ostrolucky</a> for taking adding fnmatch() skip of files.</p>
<p>Enjoy the news and thanks to the people who push these tools further by every single PR or issue report!</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/03/01/new-in-symplify-3-4-improvements-in-easy-coding-standard</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 01 Mar 2018 00:00:00 +0000</pubDate>
                                    <updated>2020-08-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Aug 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Aug 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/03/01/new-in-symplify-3-4-improvements-in-easy-coding-standard#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Rector: Part 2 - Maturity of PHP Ecosystem and Founding Fathers ]]></title>
                <link>https://tomasvotruba.com/blog/2018/02/26/rector-part-2-maturity-of-php-ecocystem-and-founding-fathers</link>
                <description><![CDATA[ <p>What it took for Rector to be born?
<br><br>
Paradigm shift, ecosystem maturity, need for speed to solve common problems community has. <strong>And a great team you share <a href="https://austinkleon.com/show-your-work">your work with</a> that feedbacks and reflects.</strong></p> ]]></description>
                <content:encoded><![CDATA[ <p><em>Read also:</em></p>
<ul>
<li><a href="/blog/2018/02/19/rector-part-1-what-and-how/">Part 1 - What and How</a></li>
<li><a href="/blog/2018/03/05/rector-part-3-why-instant-upgrades/">Part 3 - Why Instant Upgrades</a></li>
</ul>
<p><br></p>
<p>It's not that PHP projects didn't need to be updated until 2017. I surely could delegate hundreds of <em>upgrade-hours</em> for my whole career. So <strong>why Now?</strong></p>
<h2 id="Codemods-as-Standard"><em>Codemods</em> as Standard</h2>
<p><em>Codemod</em> is a tool that modifies your code. And you're ok with it.</p>
<p><strong>Many years ago <a href="https://github.com/squizlabs/PHP_CodeSniffer">PHP_CodeSniffer</a> was born</strong> by <a href="https://gregsherwood.blogspot.cz/search/label/PHP_CodeSniffer">Greg Sherwood</a> from Australia. Guess how long ago? <a href="https://gregsherwood.blogspot.cz/2006/12/if-not-test-first-then-test-really-soon.html">In 2006</a>! Tool that checks your coding standard, tabs and spaces, brackets and quotes. First of it's kind to be mainstream in PHP community.</p>
<p><strong>It was followed by <a href="https://github.com/friendsofphp/php-cs-fixer">PHP CS Fixer</a></strong> with <a href="http://fabien.potencier.org/php-cs-fixer-finally-reaches-version-1-0.html">it's first release in 2014</a> by <a href="http://fabien.potencier.org">Fabien Potencier</a>. Did you know the first script <a href="https://gist.github.com/fabpot/3f25555dce956accd4dd">had only 106 lines</a>?</p>
<p>I use daily both of these tools, <a href="/blog/2017/05/03/combine-power-of-php-code-sniffer-and-php-cs-fixer-in-3-lines/">they're both awesome and work best together</a>. Both of them fix the code for you, so you can sleep or have a coffee instead.</p>
<p>It took 12 years and 2 tools with over 4000 stars on Github to get here.</p>
<h2 id="Is-PHP-Ready-for-AST">Is PHP Ready for AST?</h2>
<p>A few years ago <a href="https://www.npopov.com">Nikita Popov</a> started an ambitious project <a href="https://github.com/nikic/PHP-Parser">nikic/PHP-Parser</a>. PHP-Parser parses PHP code to AST. If you're new to Abstract Syntax Tree (AST), check <a href="/blog/2017/11/06/wow-to-change-php-code-with-abstract-syntax-tree/">this post that describes 2 big changes in PHP ecosystem</a> thanks to AST.</p>
<h3 id="Both-Read-and-amp-Write">Both Read &amp; Write?</h3>
<p>PHP_CodeSniffer was read only, which is great for letting you know what is wrong, but not much for getting a coffee instead. So fixing part was added.</p>
<p>Same was for PHP-Parser. It can read a code and allow it analysis.
That's what <a href="https://ondrej.mirtes.cz">Ondřej Mirtes</a> uses in <a href="/blog/2017/01/28/why-I-switched-scrutinizer-for-phpstan-and-you-should-too/">PHPStan</a> - context aware PHP analysis (&quot;this variable is of this type&quot;).</p>
<p>Again useful, but what about that coffee? It won't make itself.</p>
<p><strong>I must say, this is breaking point for Rector</strong>. Without this, Rector would be just annoying tool telling you what is wrong and what you should do (and we had enough control already, right?). Super fortunately, <a href="https://github.com/nikic/PHP-Parser/blob/master/doc/component/Pretty_printing.markdown#formatting-preserving-pretty-printing">write feature was added and released in 2018</a> with php-parser 4.</p>
<p><em>Did you know?</em> That Fabien wanted to use PHP-Parser for PHP CS Fixer in <a href="https://github.com/nikic/PHP-Parser/issues/41">2012</a>, but could not, because the writing part was missing? <em>Patience makes perfect</em> - 6 years later it's there.</p>
<h3 id="Coding-Standard-Tool-that-makes-Code-Nice-and-Shiny">Coding Standard + Tool that makes Code Nice and Shiny</h3>
<p>PHP AST can be saved, but it still needed a bit polishing:</p>
<pre><code class="language-diff"> namespace App;

 use Symfony\Component\HttpFoundation\DeprecatedRequest;

 class Controller
 {
-    public function actionIndex(): DeprecatedRequest
+    public function actionIndex(): \Symfony\Component\HttpFoundation\NewRequest
     {
     }
 }</code></pre>
<p>There was no tool that could do this for you, until <a href="https://github.com/symplify/easy-coding-standard">EasyCodingStandard</a> + <a href="https://github.com/symplify/coding-standard"><code>Symplify\CodingStandard</code></a>.</p>
<p>With that combination, just run <code>vendor/bin/ecs</code> with <a href="https://github.com/symplify/coding-standard#types-should-not-be-referenced-via-a-fullypartially-qualified-name-but-via-a-use-statement">proper setup</a> to fix that:</p>
<pre><code class="language-diff"> namespace App;

+use Symfony\Component\HttpFoundation\NewRequest;
-use Symfony\Component\HttpFoundation\DeprecatedRequest;

 class Controller
 {
-    public function actionIndex(): \Symfony\Component\HttpFoundation\NewRequest
+    public function actionIndex(): NewRequest
     {
     }
 }</code></pre>
<h2 id="Founding-Fathers-of-Rector">Founding Fathers of Rector</h2>
<p>That's how <a href="https://github.com/rectorphp/rector">Rector</a> was born one part after another. At least the ideas.</p>
<p>It's not only about writing code. It's about discussing the idea, finding the right API that not only me but others would understand right away, it's about using other tools. It's about talking with people who already made AST tools, ask for advices and find possible pitfalls. It's about reporting issues and talking with people who maintain  projects you depend on.</p>
<h3 id="FDD-Friendship-Driven-Development">FDD = Friendship-Driven Development</h3>
<p>I don't work for at any company so development of Rector doesn't solve my personal issues. That's how most project is born, like PHPStan to check Slevomat's code. That means I needed other motivation - when my frustration of wasted thousands human-hours was not enough.</p>
<ul>
<li>
<p><strong>Here I'd like to thank <a href="http://petrvacha.com">Petr Vácha</a></strong> for cowork weekend in Brno with in summer 2017, where it all started - in those times named as <em>Refactor</em>. You've been great friend for years and courage in times, when I needed it the most.</p>
</li>
<li>
<p><strong>And <a href="https://davidgrudl.com">David Grudl</a></strong>, who gave me the motivation to dig deep and &quot;just try it&quot; when I felt desperate and useless always with lightness of Zen master.</p>
</li>
<li>
<p><strong>And also <a href="http://nikic.github.com">Nikita Popov</a></strong>, who patiently answered, taught me and fixed all my issues on <code>nikic/php-parser</code>.</p>
</li>
</ul>
<p>Without you, I would not make it here today.</p>
<p><br><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/02/26/rector-part-2-maturity-of-php-ecocystem-and-founding-fathers</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 26 Feb 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/02/26/rector-part-2-maturity-of-php-ecocystem-and-founding-fathers#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Rector: Part 1 - What and How ]]></title>
                <link>https://tomasvotruba.com/blog/2018/02/19/rector-part-1-what-and-how</link>
                <description><![CDATA[ <p>Rector is a PHP tool that handles 2 things: <strong>instant upgrades</strong> and <strong>architecture refactorings</strong>.
<br><br>
What exactly Rector does and how does it work?</p> ]]></description>
                <content:encoded><![CDATA[ <p><em>Read also:</em></p>
<ul>
<li><a href="/blog/2018/02/26/rector-part-2-maturity-of-php-ecocystem-and-founding-fathers/">Part 2 - Maturity of PHP Ecosystem and Founding Fathers</a></li>
<li><a href="/blog/2018/03/05/rector-part-3-why-instant-upgrades/">Part 3 - Why Instant Upgrades</a></li>
</ul>
<p><br></p>
<h2 id="What-is-Rector">What is Rector?</h2>
<p>Rector is a PHP CLI tool build on <a href="https://symfony.com/components">Symfony Components</a> that changes your PHP code for better.
It only does what you tell it to do. You can use it to <em>instantly upgrade</em> your application or to do <em>architecture refactorings</em> once for the whole codebase.</p>
<p>Rector won't do your job. It's here to <strong>do the boring stuff for you</strong>. Its help is similar to coding standard tools' help with code reviews - move focus from spaces and commas to architecture of the code.</p>
<h3 id="Where-is-it">Where is it?</h3>
<p>You can <a href="https://github.com/rectorphp/rector">find it on Github</a>. It has now <a href="https://github.com/rectorphp/rector/graphs/contributors">6 contributors</a> in total. I want to thank young talented PHP developer <a href="https://github.com/carusogabriel">Gabriel Caruso</a> from Brazil for his great contributions since December 2017 that pushed Rector to a brand new level.</p>
<h2 id="What-are-Instant-Upgrades">What are Instant Upgrades?</h2>
<p><em>I'll show examples on <a href="https://symfony.com">Symfony</a>, because that's the framework I know and love the best.</em></p>
<p>Let's say you have a project on Symfony 2.7. And you have a huge <code>service.yml</code>. You know that Symfony 2.8/3.0 brought an awesome <a href="https://symfony.com/blog/new-in-symfony-2-8-service-auto-wiring">autowiring</a> feature that evolved to pure awesomenes in Symfony 3.3 and <a href="/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3/#4-use-psr-4-based-service-autodiscovery-and-registration">PSR-4 services feature</a>.</p>
<p><strong>Would you prefer to do this upgrade manually?</strong> No? Use Rector instead:</p>
<ol>
<li>Install Rector</li>
</ol>
<pre><code class="language-bash">composer require rector/rector --dev</code></pre>
<ol start="2">
<li>Then create <code>rector.php</code></li>
</ol>
<pre><code class="language-bash">vendor/bin/rector init</code></pre>
<ol start="3">
<li>Configure it with set:</li>
</ol>
<pre><code class="language-php">use Rector\Symfony\Set\SymfonySetList;
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $containerConfigurator-&gt;import(SymfonySetList::SYMFONY_33);
};</code></pre>
<ol start="4">
<li>Run Rector on <code>/src</code> directory:</li>
</ol>
<pre><code class="language-bash">vendor/bin/rector process src</code></pre>
<p>That's it!</p>
<h2 id="What-are-Architecture-Refactorings">What are Architecture Refactorings?</h2>
<p>The great task Rector can handle is to architecture refactorings. Your code might use a framework, but that's just 50 % of the code. The other 50 % is up to you, how you decide to use it - I mean static calls, services locators, facades over dependency injections etc.</p>
<p>I've seen many applications built on Symfony that used very interesting patterns:</p>
<pre><code class="language-php">class LoggingEventSubscriber implements EventSubscriberInterface
{
    public function setController($controller)
    {
        $this-&gt;controller = $controller;
    }

    public function process()
    {
        $logger = $this-&gt;controller-&gt;get('logger');
        $logger-&gt;log('it happened!');
    }
}</code></pre>
<p>Let's say you'd like to remove all <code>$this-&gt;get('logger')</code> and replace them with dependency injection of <code>LoggerInterface</code> type. It's not strictly coupled to the Symfony (both <a href="https://forum.nette.org/en/22075-context-on-presenter-is-deprecated">Nette</a> and <a href="https://laravel.com/docs/5.5/facades#facade-class-reference">Laravel</a> allows this in some version) but you want to change this in the whole application.</p>
<p>From this:</p>
<pre><code class="language-php">class LectureController extends BaseController
{
    public function listAction()
    {
        $logger = $this-&gt;get('logger');
        $logger-&gt;log('it happened!');
    }
}</code></pre>
<p>To this:</p>
<pre><code class="language-php">class LectureController extends BaseController
{
    /**
     * @var LoggerInterface
     */
    private $logger;

    public function __construct(LoggerInterface $logger)
    {
        $this-&gt;logger = $logger;
    }

    public function listAction()
    {
        $this-&gt;logger-&gt;log('it happened!');
    }
}</code></pre>
<p>Rector can handle it for you.</p>
<p>Do you use Laravel and want to move from facades to constructor injection? Rector can help you.</p>
<h2 id="How-does-it-Work">How does it Work?</h2>
<p>Rector parses the code to <a href="/blog/2017/11/06/wow-to-change-php-code-with-abstract-syntax-tree/">AST</a> thanks to PHP superman <a href="https://www.npopov.com">nikic</a>'s <a href="https://github.com/nikic/PHP-Parser">php-parser</a>.</p>
<p>Then it finds specific places in the code, e.g. all variables that contain <code>Symfony\Component\HttpFoundation\Request</code> type and call <code>isMethodSafe()</code> method.</p>
<p>Then it changes it into <code>isMethodCacheable()</code> (see <a href="https://github.com/symfony/symfony/blob/master/UPGRADE-4.0.md#httpfoundation">UPGRADE-4.0.md</a>).</p>
<p>Such a configuration looks like this (as shown in <a href="https://github.com/rectorphp/rector#change-a-method-name"><code>README</code></a>):</p>
<pre><code class="language-php">use Rector\Renaming\Rector\MethodCall\RenameMethodRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;ruleWithConfiguration(RenameMethodRector::class, [
        new MethodCallRename('Symfony\Component\HttpFoundation\Request', 'isMethodSafe', 'isMethodCacheable')
    ]);
};</code></pre>
<h3 id="Member-of-Big-AST-PHP-Family">Member of Big AST PHP Family</h3>
<p>Rector is not the only tool that uses <code>nikic\php-parser</code> for context-aware operation on your code.</p>
<p>You've probably heard of <a href="/blog/2017/01/28/why-I-switched-scrutinizer-for-phpstan-and-you-should-too/">PHPStan</a>. But unfortunately it's read-only for deterministic cases = when 1 error has exactly 1 possible solution.</p>
<p>Another static analysis tool - <a href="https://github.com/vimeo/psalm">vimeo/psalm</a> by <a href="https://github.com/muglug">Matthew Brown</a>, which fixes such code. Great job Matthew!</p>
<h2 id="Easter-Egg-Has-Google-Own-and-quot-Rector-and-quot">Easter Egg: Has Google Own &quot;Rector&quot;?</h2>
<p>This <em>setup and forget</em> approach is so addictive, that Google must have it too, right?</p>
<p>And it does! I found 4-page case study <em><a href="https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/41342.pdf">Large-Scale Automated Refactoring Using ClangMR</a></em>, that was <a href="https://www.youtube.com/watch?v=ZpvvmvITOrk">presented by <em>Hyrum Wright</em> on CppCon2014</a> in 57 minutes. Hyrum doesn't work at Google anymore (as he wrote me), yet I still love his detailed and practical talk.</p>
<p>I'm still amazed by how their approach is 90% similar to Rector, just for C++.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/02/19/rector-part-1-what-and-how</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 19 Feb 2018 00:00:00 +0000</pubDate>
                                    <updated>2020-11-01UTC00:00:000</updated>
                    <atom:updated>Sun, 01 Nov 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sun, 01 Nov 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/02/19/rector-part-1-what-and-how#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Sleep Shorter to Get 62 % Smarter ]]></title>
                <link>https://tomasvotruba.com/blog/2018/02/12/sleep-shorter-to-get-62-percent-smarter</link>
                <description><![CDATA[ <p>Even though I see <a href="/blog/2017/11/13/7-tips-you-should-know-before-going-to-university/">University as very poor place to learn something useful</a>, I studied Psychology in Brno for 3 years.
<br><br>
<em>Psychological Impacts of Polyphasic Sleep</em> is the topic of my <a href="https://is.muni.cz/th/363896/fss_b/Tomas-Votruba-Psychological-Impacts-of-Polyphasic-Sleep.pdf">bachelor thesis</a> I wrote in 2012. In the end it gave me clear answer to question: <strong>can we sleep less than 4,5 hours a night to get smarter?</strong></p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="From-6-to-4-5-hours-of-Sleep-in-3-Months">From 6 to 4,5 hours of Sleep in 3 Months</h2>
<p>I switched from monophasic sleep schedule (6 hours in a row) to <strong>Everyman 3</strong> (4,5 hours in a row + 3 naps during the day) for <strong>3 months</strong> and tested myself daily in attention span, short term memory and working memory.</p>
<p>To give you the idea <strong>how polyphasic sleep can look like</strong>:</p>
<div class="text-center">
    <img src="/assets/images/posts/2018/polyphasic/polyphasic-charts.jpg" class="img-thumbnail">

    <em>blue = sleep, yellow = awake</em>
</div>
<p><br></p>
<p>And this is how my real sleep schedule looked like:</p>
<img src="/assets/images/posts/2018/polyphasic/phase-a-b.png" class="img-thumbnail">
<img src="/assets/images/posts/2018/polyphasic/phase-b.png" class="img-thumbnail">
<p><br></p>
<p>On average, I slept <strong>3.78 times a day</strong> with <strong>4.48 hours in total</strong>.</p>
<h2 id="62-Better-Short-Term-Memory">62 % Better Short Term Memory</h2>
<p><strong>One of hypothesis was that short term memory improves</strong>. It was measured by table of random-generated list of words I had to remember during 2 minutes and then type back in next 60 seconds:</p>
<img src="/assets/images/posts/2018/polyphasic/short-term.png" class="img-thumbnail">
<p><br></p>
<p>I remembered much more of these words on polyphasic sleep:</p>
<table class="table table-bordered table-responsive">
    <thead class="thead-inverse">
        <tr>
            <th>Sleep Schedule</th>
            <th>Words Recalled</th>
            <th>Improvement to Monophasic</th>
        </tr>
    </thead>
    <tr>
        <td>Monophasic</td>
        <td>12.82 words</td>
        <td>–</td>
    </tr>
    <tr>
        <td>Polyphasic (Phase 3)</td>
        <td>20.66 words</td>
        <td>+62 %</td>
    </tr>
    <tr>
        <td>Polyphasic (Phase 4)</td>
        <td>16.96 words</td>
        <td>+32 %</td>
    </tr>
</table>
<p><br></p>
<p>And in linear regression:</p>
<div class="text-center">
    <img src="/assets/images/posts/2018/polyphasic/short-term-linear-regression.png" class="img-thumbnail">

    <em>Phase 3: first half of polyphasic period, Phase 4: second half of polyphasic period"</em>
</div>
<p><br></p>
<h2 id="23-Better-Working-Memory">23 % Better Working Memory</h2>
<p>Another test measured time that takes to click whole path from the lowest to the highest letter and number (A, 1, B, 2...):</p>
<img src="/assets/images/posts/2018/polyphasic/line.png" class="img-thumbnail">
<p><br></p>
<table class="table table-bordered table-responsive">
    <thead class="thead-inverse">
        <tr>
            <th>Sleep Schedule</th>
            <th>Path Duration</th>
            <th>Change to Monophasic
        </th></tr>
    </thead>
    <tr>
        <td>Monophasic</td>
        <td>32.58 s</td>
        <td>–</td>
    </tr>
    <tr>
        <td>Polyphasic (Phase 3)</td>
        <td>25.07 s</td>
        <td><strong>+ 30 %</strong></td>
    </tr>
    <tr>
        <td>Polyphasic (Phase 4)</td>
        <td>27.73 s</td>
        <td><strong>+ 17 %</strong></td>
    </tr>
</table>
<p><br></p>
<p>And in linear regression:</p>
<div class="text-center">
    <img src="/assets/images/posts/2018/polyphasic/line-linear-regression.png" class="img-thumbnail">

    <em>Phase 3: first half of polyphasic period, Phase 4: second half of polyphasic period"</em>
</div>
<p><br></p>
<p>The very similar <strong>improvement 23 %</strong> was in <a href="https://www.jobtestprep.co.uk/group-bourdon-test">Group Bourdon Test</a>. It is <strong>standard for driver licences</strong> and tests attention, pattern recognition and <strong>concentration for long period of time</strong> (related to so precious <a href="/blog/2017/09/25/3-non-it-books-that-help-you-to-become-better-programmer/#deep-work-by-cal-newport">deep work</a>).</p>
<p>Just select all 4-dots images:</p>
<img src="/assets/images/posts/2018/polyphasic/working.png" class="img-thumbnail">
<p><br></p>
<h2 id="Win-Win">Win-Win</h2>
<p>Not all hypothesis were confirmed. But even though I was ill in phase 4 (see section 5.2), the results were more then clear<strong>. Polyphasic sleep improved my attention, working memory and short term memory from 23 % to 63 %</strong>.</p>
<p>And not only that. And <strong>I also got extra 1,5 hours a day</strong>!</p>
<h2 id="Polyphasic-Sleep-Universal-Tool-to-Boost-Production">Polyphasic Sleep - Universal Tool to Boost Production?</h2>
<p>It depends on what you need in your life. I needed time to produce because I got many time-demanding goals in that time. In time I learned to prioritize, to focus on what is important and to flow in a deep works session.</p>
<p>I still take a nap roughly once a week and feel fresh, when day is hard. And if I ever be father of another baby, I'd be happy to polyphase with him or her, since it's babies natural sleep schedule.</p>
<h2 id="Do-you-Need-More-Time-Try-it">Do you Need More Time? Try it</h2>
<p>Would you use extra hour a day? Have you tried it? Nap a day won't hurt and you don't even have to fall asleep. Modern medicine confirms that mindfulness meditation (which polyphasic sleep often is) has great benefits for your mind.</p>
<h3 id="Where-is-What-in-Thesis">Where is What in Thesis?</h3>
<p>I picked the most interesting parts for you, so you can avoid <a href="https://is.muni.cz/th/363896/fss_b/Tomas-Votruba-Psychological-Impacts-of-Polyphasic-Sleep.pdf">reading whole 63 pages</a> and go right to the part that you're interested in:</p>
<ul>
<li>4.4 <em>Hypothesis</em> - what needs to be validated</li>
<li>4.5 <em>Materials</em> - test battery, how it looked like, what exactly is measured</li>
<li>5 <em>Results</em> - numbers, graphs</li>
<li>6 <em>Discussion</em> - looking at numbers from perspective, why and what actually happened</li>
</ul>
<h3 id="Do-you-have-question-to-specific-part-of-the-thesis">Do you have question to specific part of the thesis?</h3>
<p>Just go to <a href="https://docs.google.com/document/d/12gTjk_q403nt9nhqZTo9gsHFB8oZGz_-YpKDJV-ekow/edit?usp=sharing">Google Docs</a> version and ask in comment there.</p>
<p><br><br></p>
<p>Happy napping!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/02/12/sleep-shorter-to-get-62-percent-smarter</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 12 Feb 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/02/12/sleep-shorter-to-get-62-percent-smarter#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Run Symfony Processes Asynchronously ]]></title>
                <link>https://tomasvotruba.com/blog/2018/02/05/how-to-run-symfony-processes-asynchronously</link>
                <description><![CDATA[ <p>It takes quite a long time to split Symplify <a href="https://github.com/Symplify/Monorepo">monorepo</a> packages: exactly <strong>420 s for 8 packages</strong> of Symplify.
<br><br>
Could we go 200 % faster by putting processes from serial to parallel?</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Process-Run-One-by-One">Process Run One by One</h2>
<p>This is our code now. Each process waits on each other - one is finished, then next starts.</p>
<pre><code class="language-php">foreach ($splitConfiguration as $directory =&gt; $repository) {
    $process = new Process(['git', 'subsplit', $directory . ':' . $repository]);
    $process-&gt;run();

    // here the process is finished
    if (! $process-&gt;isSuccessful()) {
        throw new PackageToRepositorySplitException($process-&gt;getErrorOutput());
    }

    // report exactly what happened, so it's easier to know result and debug
    $symfonyStyle-&gt;success(sprintf(
        'Split from "%s" to "%s" is done',
        $directory,
        $repository
    ));
}</code></pre>
<h2 id="How-to-Go-Async-in-PHP">How to Go Async in PHP?</h2>
<p>We tried <a href="https://github.com/spatie/async">spatie/async</a> which has very nice README at first sight and works probably very well for simple functions. But it turned out to be rather magic <a href="https://github.com/spatie/async/blob/master/src/Runtime/ParentRuntime.php">by passing service as serialized string</a> to <a href="https://github.com/spatie/async/blob/master/src/Runtime/ChildRuntime.php">CLI that desirializes it and runs on own thread</a>. It also caused other process commands fail on success message. It is probably good enought for Laravel, but not for my <a href="https://github.com/jupeter/clean-code-php#solid">SOLID standards</a>.</p>
<h3 id="What-are-the-Other-options">What are the Other options?</h3>
<p>We could go <a href="https://github.com/amphp/amp">amp</a> or <a href="https://reactphp.org">reactphp</a>, but wouldn't that be an overkill?</p>
<p>There is also faster way like <a href="https://github.com/splitsh/lite">splitsh/lite</a>, but <strong>we aim on PHP + Git combination so PHP developers could extend the code</strong>.</p>
<p>Luckily, Symfony Process already <strong>allows <a href="https://symfony.com/doc/current/components/process.html#running-processes-asynchronously">standalone process</a></strong> without waiting on each other.</p>
<h2 id="What-We-Actually-Need">What We Actually Need?</h2>
<p>Picking the right tool is important, since it vendor locks our code to package, but lets step back a little.</p>
<p><strong>What is the exact goal we need?</strong></p>
<ol>
<li>Run all processes at once</li>
<li>Wait until they're finished</li>
<li>Report their success/error status</li>
</ol>
<h2 id="1-To-run-all-Processes-at-Once">1. To run all Processes at Once</h2>
<pre><code class="language-php">$runningProcesses = [];

foreach ($splitConfiguration as $directory =&gt; $repository) {
    $process = new Process(['git', 'subsplit', $directory . ':' . $repository]);
    // start() doesn't wait until the process is finished, oppose to run()
    $process-&gt;start();

    // store process for later, so we evaluate it's finished
    $runningProcesses[] = $process;
}</code></pre>
<p>This foreach starts all processes in parallel. Without knowing they're finished or not.</p>
<p><strong>Don't forget to check that your CPU is not burned by running many processes at once</strong> by limiting concurrency.
In our case it's only 8, so we survive this.</p>
<h2 id="2-Wait-Until-They-re-Finished">2. Wait Until They're Finished</h2>
<pre><code class="language-php">while (count($activeProcesses)) {
    foreach ($activeProcesses as $i =&gt; $runningProcess) {
        // specific process is finished, so we remove it
        if (! $runningProcess-&gt;isRunning()) {
            unset($activeProcesses[$i]);
        }

        // check every second
        sleep(1);
    }
}

// here we know that all are finished</code></pre>
<h2 id="3-Report-their-Success-Error-Status">3. Report their Success/Error Status</h2>
<pre><code class="language-php">$symfonyStyle-&gt;success('Split was successful');</code></pre>
<p>But how useful is this message compared to previous one?</p>
<pre><code class="language-php">$symfonyStyle-&gt;success(sprintf(
    'Split from "%s" to "%s" is done',
    $directory,
    $repository
));</code></pre>
<p>And what if any processes failed?</p>
<h3 id="Let-s-improve-this">Let's improve this</h3>
<pre><code class="language-diff"> $runningProcesses = [];
+$allProcessInfos = [];

 foreach ($splitConfiguration as $directory =&gt; $repository) {
     $process = new Process(['git', 'subsplit', $directory . ':' . $repository]);
     $process-&gt;start();

     $runningProcesses[] = $process;
+    // value object with types would be better and faster here, this is just example
+    $allProcessInfos[] = [
+        'process' =&gt; $process,
+        'directory' =&gt; $subdirectory,
+        'repository' =&gt; $repository
+    ];
 }</code></pre>
<p>So final reporting would look like this:</p>
<pre><code class="language-php">foreach ($allProcessInfos as $processInfo) {
    /** @var Process $process */
    $process = $processInfo['process'];
    if (! $process-&gt;isSuccessful()) {
        throw new PackageToRepositorySplitException($process-&gt;getErrorOutput());
    }

    $symfonyStyle-&gt;success(sprintf(
        'Push of "%s" directory to "%s" repository was successful',
        $processInfo['directory'],
        $processInfo['repository']
    ));
}</code></pre>
<h3 id="Speed-up-From-420-to-139-s">Speed up From 420 to 139 s</h3>
<p>Symplify has 8 packages to build at the moment. Putting split commands to async had amazing improvement!</p>
<p><a href="https://github.com/symplify/symplify/pull/620" class="btn btn-dark btn-sm">
See pull-request #620
</a></p>
<p>That's it!</p>
<p><br><br></p>
<p>pyHpa ansyc rusn!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/02/05/how-to-run-symfony-processes-asynchronously</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 05 Feb 2018 00:00:00 +0000</pubDate>
                                    <updated>2018-12-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Dec 2018 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Dec 2018 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/02/05/how-to-run-symfony-processes-asynchronously#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Deal With Haters in Comments and Github ]]></title>
                <link>https://tomasvotruba.com/blog/2018/01/29/how-to-deal-with-haters-in-comments-and-github</link>
                <description><![CDATA[ <p>That's what I was asked yesterday for about 5th person already. How do I deal with that when I write an article, when I tweet or comment on Github and someone is throwing dirt on me?</p> ]]></description>
                <content:encoded><![CDATA[ <p>I learned this process while being a maintainer of <a href="/blog/2017/09/04/how-apigen-survived-its-own-death/">ApiGen</a> for 1 year and then 6 months again, where I got to dozens of online-hate-wars and found that it leads nowhere.</p>
<img src="/assets/images/posts/2018/haters-in-comments/hearth-mind.jpg" class="img-thumbnail">
<p>Then I tried another way - a <strong><a href="https://zenhabits.net/compassion">compassion</a>.</strong></p>
<p>We could sum it up in 4 steps:</p>
<h2 id="1-Process-Emotion-Take-a-Breath">1. Process Emotion - Take a Breath</h2>
<p>Yes, it hurts. When I write a tutorial on how to deal with hater, and someone writes me: <em>IT'S STUPID</em> - it hurts. I put so much work in it and instead of a like I get slapped. <strong>In fact, that could be a feedback. With a little effort even constructive.</strong></p>
<p><strong>What information</strong> he or she wants to communicate to me? In 90% of cases:</p>
<ul>
<li>&quot;I do not understand that.&quot;</li>
<li>&quot;I understood it differently than you meant.&quot;</li>
<li>&quot;I see it differently.&quot;</li>
</ul>
<p><strong>You don't respond right away</strong>. When you feel uncomfortable right after reading the comment, you'd only return the same emotion and the same would probably get back to you. Take an hour break if you need. It's ok.</p>
<h2 id="2-Investigate-Get-more-Intel">2. Investigate - Get more Intel</h2>
<p>We want to know what's on the other's mind. We want to find <strong>something useful for us, to make our work better next time</strong>.</p>
<h3 id="How-to-Respond">How to Respond?</h3>
<ul>
<li>&quot;It's a total crap&quot; =&gt; What you disagree?</li>
<li>&quot;That never works&quot; =&gt; How so? What could work then?</li>
<li>&quot;You're doing it wrong&quot; =&gt; Why do you think so? How would that look right?</li>
</ul>
<p><em>This is how damaged 10-years marriage on therapy looks like.</em></p>
<h3 id="Follow-Context">Follow Context</h3>
<p>It's the same in programming. There is no ultimate answer to a sentence out of context - reaction always depends on it. We behave differently in a group of friends people or while writing first comment on repository maintained by programmer from South America.</p>
<p>But in the most cases <strong>the reaction to such question is more constructive than the first comment</strong>. And that's enough for me - <strong>I'll take more from it than if I'd remain silent and returned back emotion</strong>.</p>
<img src="/assets/images/posts/2017/feedback/feedback.jpg" class="img-thumbnail">
<h2 id="3-Is-it-Worth-it-Iterate">3. Is it Worth it? Iterate</h2>
<p>Baby steps. I do not expect that I get <a href="http://www.rightattitudes.com/2008/02/20/sandwich-feedback-technique">sandwich feedback</a> to my first answer - after all, it took me year to get from <em>that's wrong</em> to useful and well-accepted feedback.</p>
<p>Sometimes it takes time, sometimes I regress and mirror anger back, but I try to remember the first point - <strong>process emotion</strong>. When it doesn't work, I just stop and focus somewhere else.</p>
<p><strong>Often we get from potential argument to his or her sending a new pull-request</strong>.</p>
<h2 id="4-Is-it-too-much-Let-it-go">4. Is it too much? Let it go</h2>
<p>It is possible, that there is no useful information at all. In that case, <a href="https://www.youtube.com/watch?v=L0MK7qz13bU">let it</a> <a href="https://zenhabits.net/past">go</a>. You can leave in silence...</p>
<p>...<strong>but how useful is silence to you, when you don't understand something</strong>?</p>
<p>What I try to do, <strong>is to express that</strong>. It's the last and least I can do:</p>
<ul>
<li>&quot;Let's agree we disagree.&quot;</li>
<li>&quot;I think we both tried to understand each other but I was not enough&quot;</li>
<li>&quot;I'm sorry, I still don't understand your points and I don't want to put more energy into thi&quot;</li>
</ul>
<p>Next time, this person might realize it's not personal attack similar to his childhood experience in school or with his parents, but it's <strong>only about miss interpretation</strong> of words. And he or she might <strong>call you</strong> to express it better, like I do when I feel keyboard doesn't <em>work</em>. After all, <a href="http://ubiquity.acm.org/article.cfm?id=2043156">only 7 % of communication is verbal</a>.</p>
<h2 id="Tip-for-Github-Maintainers-and-quot-24-hour-Take-a-Breath-and-quot">Tip for Github Maintainers - &quot;24-hour Take a Breath&quot;</h2>
<p>Github has this <a href="https://github.com/blog/2370-introducing-temporary-interaction-limits">super feature</a> right in <em>Settings</em> of every repository, that can give everyone time to process and realize what happened. Outsize the emotional tornado. With calm and peaceful mind.</p>
<img src="/assets/images/posts/2018/haters-in-comments/temporary-interaction-limits.png" class="img-thumbnail">
<p>I wish I knew this before. It would save many words I could not take back.</p>
<p><br><br></p>
<p>Don't worry, be happy!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/01/29/how-to-deal-with-haters-in-comments-and-github</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 29 Jan 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/01/29/how-to-deal-with-haters-in-comments-and-github#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Get Parameter in Symfony Controller the Clean Way ]]></title>
                <link>https://tomasvotruba.com/blog/2018/01/22/how-to-get-parameter-in-symfony-controller-the-clean-way</link>
                <description><![CDATA[ <p>Services are already moving to Constructor Injection in Symfony.
<br>
Now it's time for parameters to follow.</p> ]]></description>
                <content:encoded><![CDATA[ <h3 id="The-Easy-Way">The Easy Way</h3>
<pre><code class="language-php">final class LectureController extends SymfonyController
{
    public function registerAction()
    {
        $bankAccount = $this-&gt;container-&gt;getParameter('bankAccount');
    }
}</code></pre>
<p>It works, but it breaks <a href="https://github.com/jupeter/clean-code-php#solid">SOLID encapsulation of dependencies</a>. Controller should not be aware of whole DI container and every service in it. <strong>It should take only what it needs</strong> as any other <a href="/blog/2018/01/08/clean-and-decoupled-controllers-commands-and-event-subscribers-once-and-for-all-with-delegator-pattern/#delegator-pattern-to-the-strike-rescue-strike-prevention">delegator</a>.</p>
<p><strong>What if we need a service</strong> to pay a registration fee to our bank account?</p>
<p>Since <a href="https://symfony.com/blog/new-in-symfony-2-8-service-auto-wiring">Symfony 2.8 with autowiring</a> we can go for constructor injection with no obstacles:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

final class LectureController extends SymfonyController
{
    /**
     * @var PaymentService
     */
    private $paymentService;

    public function __construct(PaymentService $paymentService)
    {
        $this-&gt;paymentService = $paymentService;
    }

    public function registerAction(): void
    {
        $bankAccount = $this-&gt;container-&gt;getParameter('bankAccount');

        $this-&gt;paymentService-&gt;payAmountToAccount(1000, $bankAccount);
    }
}</code></pre>
<p>This can go completely wrong, not because dependency injection is better than service locator, but <strong>because code is now inconsistent</strong>. It's not clear:</p>
<ul>
<li>When should we use constructor injection? For services?</li>
<li>When should we use service locator? For parameters?</li>
</ul>
<p>At that's what we think about when <em>we</em> refactored code and know about it's previous state.</p>
<p>When your colleague will extends this code 3 months later, he might <a href="https://blog.codinghorror.com/the-broken-window-theory">broke your window</a>:</p>
<pre><code class="language-diff">&lt;?php declare(strict_types=1);

final class LectureController extends SymfonyController
{
    /**
     * @var PaymentService
     */
    private $paymentService;

    public function __construct(PaymentService $paymentService)
    {
        $this-&gt;paymentService = $paymentService;
    }

    public function registerAction(): void
    {
        $bankAccount = $this-&gt;container-&gt;getParameter('bankAccount');

        $this-&gt;paymentService-&gt;payAmountToAccount(1000, $bankAccount);
    }
+
+    public function refundAction(): void
+    {
+        $refundService = $this-&gt;container-&gt;get(RefundService::class);
+        $refundService-&gt;refundToLoggedUser(1000);
+    }
}</code></pre>
<h2 id="Consistency-over-Per-Change-Pattern">Consistency over Per Change Pattern</h2>
<p>You understand your code = you know reasons why it's written this way and the boundaries. You know when to use dependency injection and when service (or pamater) locator.</p>
<p><strong>But that's you. Only you.</strong> Other people don't have your experience and your memory. <strong>They read the code and learn while reading</strong>.</p>
<p>That's why it's important to use as less rules as possible to prevent <a href="https://chrismm.com/blog/writing-good-code-reduce-the-cognitive-load">cognitive overload</a>. Which leads to poor understanding of the code and coding further in the same file but in own personal way, not related to original code much.</p>
<h3 id="DI-is-the-Flow-and-ndash-Go-With-It">DI is the Flow &ndash; Go With It</h3>
<p>Symfony 3.3 and 3.4/4.0 brought <a href="/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3/">many new DI features</a> and <strong>with it an evolution to developer experience paradigm</strong>. Thanks to <a href="https://github.com/nicolas-grekas">Nicolas Grekas</a>, and subsequently <a href="https://github.com/dunglas">Kévin Dunglas</a> and <a href="https://github.com/hason">Martin Hasoň</a>.</p>
<h2 id="The-Clean-Way">The Clean Way</h2>
<p>Service is created in the container and passed via constructor where needed.
<strong>Why not parameter, which is also loaded by the container?</strong></p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

final class LectureController extends SymfonyController
{
    /**
     * @var string
     */
    private $bankAccount;

    /**
     * @var PaymentService
     */
    private $paymentService;

    public function __construct(string $bankAccount, PaymentService $paymentService)
    {
        $this-&gt;paymentService = $paymentService;
        $this-&gt;bankAccount = $bankAccount;
    }

    public function registerAction(): void
    {
        $this-&gt;paymentService-&gt;payAmountToAccount(1000, $this-&gt;bankAccount);
    }
}</code></pre>
<h3 id="Change-the-Config">Change the Config</h3>
<p>We need to:</p>
<ul>
<li>register controller <strong>manually</strong> in every instance</li>
<li>pass the parameter to constructor <strong>manually</strong> in every instance</li>
<li>autowire the rest</li>
</ul>
<p>It's lot of work, but it's worth it!</p>
<pre><code class="language-yaml"># config.yml
parameters:
    bankAccount: '1093849023/2013'

services:
    _defaults:
        autowire: true

    App\Controller\LectureController:
        arguments:
            - '%bankAccount%'</code></pre>
<p>Would you use this approach? 5 lines for 1 parameter in 1 service? Maybe.</p>
<p>What about 2, 3 or 40 controllers/services using it?</p>
<pre><code class="language-yaml">services:
    autowire: true

    App\Controller\LectureController:
        arguments:
            - '%bankAccount%'

    App\Controller\ContactController:
        arguments:
            - '%bankAccount%'

    # and 40 more services with manual setup
    App\Model\PaymentService:
        arguments:
            # with care when used with another position then 1st one
            2: '%bankAccount%'</code></pre>
<p><strong>Doh, so much work :(</strong></p>
<p>I find <a href="#the-easy-way">the easy way</a> now much more likeable:</p>
<pre><code class="language-php">$this-&gt;container-&gt;getParameter('bankAccount');</code></pre>
<p><strong>Wait! No need to go easy and dirty. There <em>is</em> simpler way.</strong></p>
<p>Since Symfony 3.3 we can use <a href="/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3/#4-use-psr-4-based-service-autodiscovery-and-registration">PSR-4 service loading</a> and since <a href="https://symfony.com/blog/new-in-symfony-3-4-local-service-binding">Symfony 3.4/4.0 parameter binding</a>.</p>
<p>How changed previous steps?</p>
<ul>
<li><del>register controller manually</del> → use PSR4 <strong>once for all services</strong></li>
<li><del>pass the parameter to constructor</del> → use binding <strong>once for all services</strong></li>
<li>autowire the rest</li>
</ul>
<pre><code class="language-yaml">services:
    _defaults:
        autowire: true
        bind:
            $bankAccount: '%bankAccount%'

    App\Controller\:
        resource: ..</code></pre>
<p><strong>Now you can add 50 more services using <code>$bankAccount</code> as constructor dependency with no extra edit on config</strong>. Win-win!</p>
<p><br><br></p>
<p>Happy Config Fit &amp; Slimming!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/01/22/how-to-get-parameter-in-symfony-controller-the-clean-way</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 22 Jan 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/01/22/how-to-get-parameter-in-symfony-controller-the-clean-way#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Is Your CHANGELOG Useful or Just Boring Plain Text? And How to Fix That ]]></title>
                <link>https://tomasvotruba.com/blog/2018/01/15/is-your-changelog-useful-or-just-boring-plain-text-and-how-to-fix-that</link>
                <description><![CDATA[ <p>Do you <a href="https://keepachangelog.com">keep a CHANGELOG</a>? You should! I <a href="https://github.com/symplify/symplify/blob/master/CHANGELOG.md">do</a>, because it's the main story about the open-source package.
<br><br>
And if you do, is it boring plain text or <strong>useful rich markdown</strong>?</p> ]]></description>
                <content:encoded><![CDATA[ <p><br></p>
<p>This post is written in Markdown. Would you read it if it looked like this?</p>
<div class="card">
    <div class="card-body">
        I wrote about monorepo before and - as ShopSyS and Google agrees - it's the best choice for longterm projects, like children or planet projects.
        <br>
        <br>
        Moreover now, when Vitek showed me awesome tool called Tomono, that can merge git history from multiple repositories...
    </div>
</div>
<p>Or this one:</p>
<div class="card">
    <div class="card-body">
I <a href="/blog/2017/01/31/how-monolithic-repository-in-open-source-saved-my-laziness/">wrote about monorepo before</a> and - as <a href="https://blog.shopsys.com/how-to-maintain-multiple-git-repositories-with-ease-61a5e17152e0">ShopSys</a> and <a href="https://cacm.acm.org/magazines/2016/7/204032-why-google-stores-billions-of-lines-of-code-in-a-single-repository/fulltext">Google agrees</a>) - <strong>it's the best choice for longterm projects</strong>, like children or planet projects.
    <br><br>
    Moreover now, when <a href="https://github.com/vitek-rostislav">Vitek</a> showed me awesome tool called <a href="https://github.com/unravelin/tomono">Tomono</a><a>, that can <strong>merge git history from multiple repositories</strong>...
    </a></div>
</div>
<p><br></p>
<h2 id="What-is-Sad-about">What is Sad about..</h2>
<h3 id="Missing-References">...Missing References?</h3>
<p>Imagine you'll read my post first <em>plain text</em> version. While reading it, you might think:</p>
<ul>
<li>What is this monorepo? Isn't that <em>monolith</em> - an antipattern?</li>
<li>I didn't know Google is using monorepo?</li>
<li>Is that true name or made-up one?</li>
</ul>
<p>You could read answer to all those questions if I'd only provide links - but <strong>you can't, because there are no links</strong>. You'd have to go to comments, ask them, wait for answers... So you'll probably end up closing my blog and never come again.</p>
<h3 id="Plain-Text-CHANGELOG-md">...Plain Text <code>CHANGELOG.md</code>?</h3>
<p>It takes maintainer <strong>a lot of effort</strong> to <a href="https://keepachangelog.com">keep a changelog</a>, keep it updated, with every version and every new pull-request, refer issues, pull-request, @author references...</p>
<blockquote class="blockquote text-center mt-5 mb-5">
    "Too many cooks spoil the broth."
</blockquote>
<p>No surprise that most <code>CHANGELOG.md</code> files look like this:</p>
<pre><code class="language-markdown">## v3.2.0 - 2018-01-18

### Changed

- #560 Added `PhpdocVarWithoutNameFixer` to `docblock.neon` level, thanks to @carusogabriel
- #578 Use `@doesNotPerformAssertions` in tests, thanks to @carusogabriel</code></pre>
<p>Does your <code>CHANGELOG.md</code> look like this too? Is it just dump of <a href="https://github.com/symplify/symplify/issues?q=is%3Apr+is%3Aclosed">pull-requests</a> combined with <a href="https://github.com/symplify/symplify/releases">releases</a>?</p>
<h2 id="Why-do-we-Look-to-Changelog">Why do we Look to Changelog?</h2>
<p>To find an answer:</p>
<ul>
<li>What has changed in new version?</li>
<li>If it was <code>@deprecated</code>, what is the replacement?</li>
<li><strong>Most often when it broke our code</strong> and we're angry: what are the reasons for this change?</li>
<li>How did it work before?</li>
<li>Was there some issue?</li>
<li>Who is that active person behind all pull-requests for this release?</li>
</ul>
<p>I've asked all these questions when I was investigating bug in packages I used.</p>
<p>Often, release descriptions are not so detailed. In that case it is <strong>really helpful to have comparison to previous version</strong>, e.g. <a href="https://github.com/symplify/symplify/compare/v3.1.0...v3.2.0">3.1 to 3.2</a>.</p>
<p>But all of this requires time. A time that maintainer usually puts to new features or resolving bugs.</p>
<p>When I added <a href="https://github.com/symplify/symplify/blob/master/CHANGELOG.md"><code>CHANGELOG.md</code> to Symplify</a> and moved all notes from <a href="https://github.com/symplify/symplify/releases">Github Releases</a> there, I was in the same situation. Do I create new features or rather play and cuddle with my <code>CHANGELOG.md</code>?</p>
<h2 id="Can-t-let-go-Automate">Can't let go? Automate!</h2>
<p>I wanted both. Why? Because I was used to Github Released that work like I needed:</p>
<pre><code class="language-markdown">## v3.2.0 - 2018-01-18

### Changed

- [#560](https://github.com/symplify/symplify/pull/560) Added `PhpdocVarWithoutNameFixer` to `docblock.yml` level,
   thanks to [@carusogabriel](https://github.com/carusogabriel)
- [#578](https://github.com/symplify/symplify/pull/578) Use `@doesNotPerformAssertions` in tests,
   thanks to [@carusogabriel](https://github.com/carusogabriel)</code></pre>
<p>I've closed myself to coffee house for 3 hours and I've came up with solution!</p>
<p><strong>A <a href="https://github.com/Symplify/ChangelogLinker">Changelog Linker</a> was born</strong>.</p>
<img src="/assets/images/posts/2018/changelog/links.png" class="img-thumbnail">
<h2 id="3-Steps-To-Add-Links-To-Your-CHANGELOG-md">3 Steps To Add Links To Your <code>CHANGELOG.md</code></h2>
<h3 id="1-Install">1. Install</h3>
<pre><code class="language-bash">composer require symplify/changelog-linker --dev</code></pre>
<h3 id="2-Run-it">2. Run it</h3>
<pre><code class="language-bash">vendor/bin/changelog-linker run</code></pre>
<p>It will complete links to:</p>
<ul>
<li>
<p><strong>PRs and issues</strong></p>
<pre><code class="language-markdown">[#1](https://github.com/symplify/symplify/pull/1) - fix everything</code></pre>
</li>
<li>
<p><strong>Version Diffs</strong></p>
<pre><code class="language-markdown"># [v2.0.0](https://github.com/symplify/symplify/compare/v1.5.0...v2.0.0)</code></pre>
</li>
<li>
<p><strong>Users</strong></p>
<pre><code class="language-markdown">Thanks to [@SpacePossum](https://github.com/SpacePossum)</code></pre>
</li>
</ul>
<h3 id="3-Commit-and-Push">3. Commit and Push</h3>
<pre><code class="language-bash">git add .
git commit -m "CHANGELOG: add links to PRs, issues, version diffs and user names"
git push origin master</code></pre>
<p>That's it!</p>
<p><br></p>
<p>I'm sorry I didn't follow this rule from <a href="http://phppackagechecklist.com/#1,2,3,4,5,6,7,8,9,10,11,12,13,14">PHP Package Checklist</a> and used Github Releases instead. But <strong>now I have no more excuses</strong>.</p>
<p>I hope you to...</p>
<p><a href="htts://keepachangelog.com"></p>
<img src="/assets/images/posts/2018/changelog/keep-a-changelog.jpg" class="img-thumbnail">
<p></a></p>
<p>Huge thanks to @olivierlacan for keepachangelog.com! It helped me a lot.</p>
<p><em>Oh, sorry...</em></p>
<p><strong>Huge thanks to <a href="https://github.com/olivierlacan">@olivierlacan</a></strong> for <a href="https://keepachangelog.com">keepachangelog.com</a>!</p>
<p><br></p>
<p>Happy lazy linking!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/01/15/is-your-changelog-useful-or-just-boring-plain-text-and-how-to-fix-that</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 15 Jan 2018 00:00:00 +0000</pubDate>
                                    <updated>2018-06-01UTC00:00:000</updated>
                    <atom:updated>Fri, 01 Jun 2018 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Fri, 01 Jun 2018 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/01/15/is-your-changelog-useful-or-just-boring-plain-text-and-how-to-fix-that#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Clean and Decoupled Controllers, Commands and Event Subscribers Once and for All with Delegator Pattern ]]></title>
                <link>https://tomasvotruba.com/blog/2018/01/08/clean-and-decoupled-controllers-commands-and-event-subscribers-once-and-for-all-with-delegator-pattern</link>
                <description><![CDATA[ <p>Do you write your application for <strong>better future sustainability</strong> or just to get paid for it today?
If you're the first one, you care about design patterns. I'm happy to see you!
<br>
<br>
Today I will show you <strong>why and how to use <em>delegator pattern</em></strong> in your application so it makes it to the pension.</p> ]]></description>
                <content:encoded><![CDATA[ <p><br></p>
<blockquote class="blockquote text-center">
    "Every code is trash!"
</blockquote>
<p><br></p>
<p>You'll see. But before we dig into code... what are the reasons to write sustainable code and how it looks like?</p>
<h2 id="Why-Should-You-Care-About-Future-Sustainability">Why Should You Care About Future Sustainability</h2>
<p>There are 3 levels of developers by the time-frame focus they work on. Every group has it's advantages and disadvantages. You'll soon see which one you fit in.</p>
<h3 id="1-Developers-who-Code-for-NOW">1. Developers who <strong>Code for NOW</strong></h3>
<p>This project. Single site for 2018 elections. Microsite for new product release in 2019. Include anything that is hype in socials last year.</p>
<p><strong>If the code would be a trash</strong> (literally!), they'd throw everything to 1 bag or maybe right in the city streets or nature. <strong>Someone
else will handle cleaning up the city</strong> #yolo</p>
<img src="/assets/images/posts/2018/delegator/trash-everywhere.jpg" class="img-thumbnail">
<h3 id="2-Developers-who-Code-for-next-1-2-YEARS">2. Developers who Code for next 1-2 YEARS</h3>
<p>The project has tests, continuous integration, uses stable packages with 1.0 release. It's startup or a project with profit. The team is fine and slowly growing. It's their first or second project and they try to take good care about it, with experiences they have.</p>
<p>They don't make any mess around the city and <strong>put all trash to 1 trash bin</strong>. Take them out regularly once a week. They're nice to the world. Well, at least at first sight.</p>
<img src="/assets/images/posts/2018/delegator/orbit-junk.jpg" class="img-thumbnail">
<h3 id="3-Developer-who-Code-for-next-5-10-YEARS-Future-Sustainability">3. Developer who Code for next 5-10 YEARS - Future Sustainability</h3>
<p>...or at least with that mindset in their minds. The code won't probably work with PHP 9.0, but they do their best to make it as easy as possible to do so.</p>
<p>They have great experience with handful of project described in previous group. They already worked on 5 open-source projects <strong>they need to last as long as possible without as little maintenance as possible</strong>.</p>
<p><strong>To the trash again...</strong></p>
<p>It's like recycling plastic bags, glass bottler and papers.</p>
<p>You put effort to it:</p>
<ul>
<li>create space in your home to keep 3 separated trash bins,</li>
<li>explain everyone to use them and split every product to own bin</li>
<li>and when it's full you take these bags out for 5 minutes walk to their destination.</li>
</ul>
<img src="/assets/images/posts/2018/delegator/manage-it-right.jpg" class="img-thumbnail">
<p><strong>Though you never see the trash again, you believe it's good for your future self and for your children</strong>, to keep planet clean and away from trash lands. Economists would call it <em>positive externality</em>.</p>
<p><br></p>
<p>Now you know <strong>why it's good to separate waste</strong> (= code), let's get to real code.</p>
<h2 id="4-years-in-life-of-New-Web-Application">4 years in life of New Web Application</h2>
<p>Let's have a project that was born in 2015 and see how it slowly grew. It will eventually use all patterns we described in the beginning - except <em>delegator</em>, which is unfortunate for the investors of this project.</p>
<h3 id="2015-Start-with-Controllers">2015 - Start with Controllers</h3>
<p>Project start with few controllers that contain most of logic. It's fast and easy to add new controller with new logic.</p>
<p>By the end of the year there are 50 controllers like this:</p>
<pre><code class="language-php">class ProductController extends Controller
{
    public function allAction()
    {
        $allProducts = $this-&gt;getEntityManager()-&gt;getRepository(Product::class)
            -&gt;fetchAll();

        return new TemplateResponse('all.twig', [
            'allProducts' =&gt; $allProducts
        ]);
    }
}</code></pre>
<p>Also, it's in the documentation of the framework, so it must be <a href="https://matthiasnoback.nl/2014/10/unnecessary-contrapositions-in-the-new-symfony-best-practices">the best practise</a>.</p>
<p>Little we know, here starts our <a href="https://blog.codinghorror.com/the-broken-window-theory">Broken Window Theory</a>, the most underestimated effect from social science in software world.</p>
<h3 id="2016-Add-few-Commands">2016 - Add few Commands</h3>
<p>Application grows and the size needs pre-caching handled by running commands in CRON. So you start using <a href="/blog/2019/08/12/standalone-symfony-console-from-scratch/">Symfony\Console</a>. You get inspired by <code>Controller</code>, because <code>Command</code> looks like it and by the end of year, there are many command like this one:</p>
<pre><code class="language-php">class CacheProductsCommand extends Command
{
    /**
     * @var EntityManager
     */
    private $entityManager;

    public function __construct(EntityManager $entityManager)
    {
        $this-&gt;entityManager = $entityManager;
    }

    public function execute()
    {
        $allProducts = $this-&gt;entityManager-&gt;getRepository(Product::class)
            -&gt;fetchAll();

        // cache them all
    }
}</code></pre>
<h3 id="2017-Add-just-few-more-EventSubscribers">2017 - Add just few more EventSubscribers</h3>
<p>It's 2017, AI is on hype and you start thinking about product recommendation feature. You use <a href="/blog/2019/08/05/standalone-symfony-event-dispatcher-from-the-scratch/">EventSubscribers</a> that saves many information about user behavior and return best producs just for him.</p>
<pre><code class="language-php">class RecommendedProductsEventSubscriber implements EventSubscriber
{
    /**
     * @var EntityManager
     */
    private $entityManager;

    public function __construct(EntityManager $entityManager)
    {
        $this-&gt;entityManager = $entityManager;
    }

    public static function subscribe()
    {
        return ['onPageVisit' =&gt; 'setRecommendedProducts'];
    }

    public function setRecommendedProducts(BehaviorPatternEvent $behaviorPatternEvent)
    {
        $productRepository = $this-&gt;entityManager-&gt;getRepository(Product::class);

        $product = $productRepository-&gt;findBestByBehavior($behaviorPatternEvent-&gt;getBehavior());
        $behaviorPatternEvent-&gt;setRecommendedProducts($product;
    }
}</code></pre>
<p>So far so good?</p>
<h3 id="2018-Year-of-Changes">2018 - Year of Changes</h3>
<blockquote class="blockquote text-center mt-5 mb-5">
    "Change is the only constant."
    <footer class="blockquote-footer">John Candee Dean</footer>
</blockquote>
<p>New owner with technical skills comes the the play. And he wants to finally use <code>VueJs</code>, the company is now big enough to use Docker as standards and <strong>there are more programmers that know <a href="https://laravel.com/docs/eloquent">Eloquent</a> than <a href="/blog/2017/03/27/why-is-doctrine-dying/">Doctrine</a> in his country</strong>:</p>
<p><em>&quot;Alibaba is catching up and we might lose the position #1 leader on market. Just switch it to Eloquent, so we can hire and on board faster.</em>&quot;</p>
<p>Ups! Your code is coupled to the Doctrine and Symfony pretty hard. You're standing in front of important question: <strong>Do you get extra $ 10 000 to refactor the code?</strong></p>
<p>Posing this question, now we finally understand <a href="https://blog.codinghorror.com/the-broken-window-theory">Broken Window Theory</a>...</p>
<img src="/assets/images/posts/2018/delegator/broken-window.jpg" class="img-thumbnail">
<p>...because we have personal experience with going it the wrong way. Little to late.</p>
<h2 id="Prevention-over-Experience">Prevention over Experience</h2>
<ul>
<li>What could be done better?</li>
<li>Could you prevent this?</li>
<li><strong>Do you separate your trash or do you wait till your country becomes plastic land?</strong></li>
</ul>
<img src="/assets/images/posts/2018/delegator/plastic-land.jpg" class="img-thumbnail">
<p>No. You think for <strong>the future</strong> with prevention!</p>
<blockquote class="blockquote text-center mt-5 mb-5">
    "Plan like you will live forever, and then live like there is no tomorrow."
    <footer class="blockquote-footer"> Mahatma Gandhi</footer>
</blockquote>
<p>Same can be applied to your code.</p>
<h3 id="Delegator-Pattern-to-the-Rescue-Prevention">Delegator Pattern to the <del>Rescue</del> Prevention</h3>
<p>This is what we did in <a href="https://www.lekarna.cz">Lekarna.cz</a> - The biggest online drugstore in the Czech Republic. It started on Nette 2.4 and Doctrine 2.5, with <a href="/blog/2017/12/25/composer-local-packages-for-dummies/">monorepo approach</a>.</p>
<p>When a class pattern is marked as <em>delegator</em>, it <strong>can't contain any direct connection to database layer</strong> (Doctrine in this case).</p>
<p>Among most popular delegators belongs:</p>
<ul>
<li>Controller</li>
<li>Command</li>
<li>EventSubscriber</li>
<li>Presenter or Component in <a href="https://nette.org">Nette</a></li>
<li>CommandHandler from <a href="https://ocramius.github.io/ShittyCQRSPresentation">CQRS</a> etc.</li>
</ul>
<p>In Lekarna, these classes can only use own service to access products - <code>ProductRepository</code>:</p>
<pre><code class="language-php">class ProductRepository
{
    public function __construct(EntityManager $entityManager)
    {
        $this-&gt;repository = $entityManager-&gt;getRepository(Product::class);
    }

    public function fetchAll()
    {
        return $this-&gt;repository-&gt;fetchAll();
    }
}</code></pre>
<p>You don't want to check this in code reviews (imagine 5 years doing it), just <a href="/blog/2017/07/17/how-to-write-custom-sniff-for-code-sniffer-3/">write a sniff for that</a> and forget it.</p>
<p>This will remove any database layer reference from all our <code>delegators</code>:</p>
<pre><code class="language-php">class CacheProductsCommand extends Command
{
    /**
     * @var ProductRepository
     */
    private $productRepository;

    public function __construct(ProductRepository $productRepository)
    {
        $this-&gt;productRepository = $productRepository;
    }

    public function execute()
    {
        $allProducts = $productRepository-&gt;fetchAll();

        // cache them all
    }
}</code></pre>
<p>Do you need to switch database layer? Easy!</p>
<pre><code class="language-diff"> class ProductRepository
 {
-     public function __construct(EntityManager $entityManager)
-     {
-         $this-&gt;repository = $entityManager-&gt;getRepository(Product::class);
-     }
+     public function __construct(Eloquent $eloquent)
+     {
+         $this-&gt;repository = $eloquent-&gt;getRepository(Product::class);
+     }

      public function fetchAll()
      {
          return $this-&gt;repository-&gt;fetchAll();
      }
 }</code></pre>
<p><strong>1 day of work instead of hundreds of hours.</strong> That's what delegator pattern is all about.</p>
<h2 id="Start-with-Best-on-the-Knowledge-Market">Start with Best on the Knowledge Market</h2>
<p>When you start with the best known approach possible, you'll end-up in well grown project that you'll love to contribute more the older it gets.</p>
<p><strong>Just like with children - invest in them right from the start and it will get back to you</strong>!</p>
<p><br></p>
<p>Happy Children and Project Raising!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/01/08/clean-and-decoupled-controllers-commands-and-event-subscribers-once-and-for-all-with-delegator-pattern</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 08 Jan 2018 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/01/08/clean-and-decoupled-controllers-commands-and-event-subscribers-once-and-for-all-with-delegator-pattern#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ New in Symplify 3: 4 Time-saving Coding Standard Checkers ]]></title>
                <link>https://tomasvotruba.com/blog/2018/01/01/new-in-symplify-3-4-time-saving-coding-standard-checkers</link>
                <description><![CDATA[ <p>Coding Standard in Symplify 3 brings <strong>checkers build from practical use in PHPStorm</strong>. It can do lot of work for you, like add getters, remove trailing spaces, but has still some room for automation and improvement.
<br>
I already wrote about <a href="/blog/2017/12/17/new-in-symplify-3-doc-block-cleaner-fixer/">doc block cleaner fixer</a> and here 4 more checkers, <strong>that saves you from monkey-typing and let you focus on algorithms</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Starting with the simple checkers and moving to those, which save you even hours of manual work.</p>
<h2 id="1-Absolutely-Require-and-Include">1. Absolutely Require and Include</h2>
<p><a href="https://github.com/symplify/symplify/pull/385" class="btn btn-dark btn-sm mb-3 mt-2">
Check the pull-request
</a></p>
<p>You probably recognize this:</p>
<pre><code class="language-php">require 'vendor/autoload.php';</code></pre>
<p><strong>Why is this bad?</strong> It promotes relative paths by default, supports magic path resolving and can cause errors, because we expects existing file by default. You can easily end-up in ambiguous file paths like:</p>
<pre><code class="language-php">var_dump($relativeFile);
"/var/path/fileName.php"
# or
"/var//path/fileName.php"
# or
"/varpath/fileName.php"</code></pre>
<p>Of course there are cases when using absolute paths is not suitable, like templates in Symfony application, but <strong>when we know the absolute path we should prefer it</strong>:</p>
<pre><code class="language-diff">-require 'vendor/autoload.php';
+require __DIR__.'/vendor/autoload.php';</code></pre>
<p>And that's what this Rector rule does for you:</p>
<pre><code class="language-php">use Rector\CodingStyle\Rector\Include_\FollowRequireByDirRector;
use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;rule(FollowRequireByDirRector::class);
};</code></pre>
<p><br></p>
<h2 id="2-Empty-Line-after-declare-strict-types-1">2. Empty Line after <code>declare(strict_types=1)</code></h2>
<p><a href="https://github.com/symplify/symplify/pull/443" class="btn btn-dark btn-sm mb-3 mt-2">
Check the pull-request
</a></p>
<p>The next one started as issue <a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer/issues/1793">PHP CS Fixer in January 2016 (if not earlier)</a>. The story <a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer/issues/2062">continues in next issue</a>, but final fixer is not in near sight.</p>
<img src="/assets/images/posts/2018/symplify-3-checkers/long-time.png" class="img-thumbnail">
<p>Why all these issues? Official fixer modifies code like this:</p>
<pre><code class="language-diff">-&lt;?php
+&lt;?php declare(strict_types=1);
-
 namespace Abc;</code></pre>
<p>Which is not what we want.</p>
<p><code>BlankLineAfterStrictTypesFixer</code> fixer was needed so <strong>EasyCodingStandard could refactor open-source packages without any manual work</strong>:</p>
<ul>
<li>see <a href="https://github.com/cpliakas/git-wrapper/pull/137/files">cpliakas/git-wrapper PHP 7 pull-request</a></li>
<li>or <a href="https://github.com/phpDocumentor/ReflectionDocBlock/pull/137/files">phpDocumentor/ReflectionDocBlock PHP 7  pull-request</a></li>
</ul>
<p>When the official fixer is finished, I'd be happy to use it and recommend it. But <strong>right now you can use</strong>:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\CodingStandard\Fixer\Strict\BlankLineAfterStrictTypesFixer;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();

    $services-&gt;set(BlankLineAfterStrictTypesFixer::class);
};</code></pre>
<p>Which helps official fixer to keep the space:</p>
<pre><code class="language-diff">-&lt;?php
+&lt;?php declare(strict_types=1);

 namespace Abc;</code></pre>
<h2 id="3-One-Way-To-Use-Namespace-Imports">3. One Way To Use Namespace Imports</h2>
<p>What do you think about this?</p>
<img src="/assets/images/posts/2018/symplify-3-checkers/import-fixer.png" class="img-thumbnail">
<p><em>Import class</em> is great PHPStorm feature. It sometimes does only partial imports, sometimes is unable to resolve conflict of 2 <code>SameClass</code> names and it still requires your time and attention to work.</p>
<p>If you don't care about this, your code can look like this:</p>
<pre><code class="language-php">&lt;?php

namespace SomeNamespace;

final class SomeClass extends \SubNamespace\PartialNamespace\AnotherClass
{
    public function getResult(): \ExternalNamespace\Result
    {
        $someOtherClass = new \SomeNamespace\PartialNamespace\SomeOtherClass;
        // ...
    }
}</code></pre>
<p><strong>If you do care</strong> - which is probably why you're reading this post - you'd prefer code like this:</p>
<pre><code class="language-diff"> &lt;?php

 namespace SomeNamespace;

+use ExternalNamespace\Result;
+use SubNamespace\PartialNamespace\AnotherClass
+use SubNamespace\PartialNamespace\SomeOtherClass;

-final class SomeClass extends \SubNamespace\PartialNamespace\AnotherClass
+final class SomeClass extends AnotherClass
 {
-    public function getResult(): \ExternalNamespace\Result
+    public function getResult(): Result
     {
-        $someOtherClass = new \SomeNamespace\PartialNamespace\SomeOtherClass;
+        $someOtherClass = new SomeOtherClass;
         // ...
     }
 }</code></pre>
<p>To enable this behavior, add one parameter to Rector config:</p>
<pre><code class="language-php">use Rector\Config\RectorConfig;

return function (RectorConfig $rectorConfig): void {
    $rectorConfig-&gt;importNames();
};</code></pre>
<p><br></p>
<h3 id="Do-You-Want-More">Do You Want More?</h3>
<p>There are <strong>over 30 standalone checkers</strong> in Symplify\CodingStandard 3.0 with more added every release.</p>
<p>See <a href="https://github.com/symplify/coding-standard#rules-overview">visual examples in <code>README</code></a> and decide for yourself, which you like and which you don't.</p>
<p>Thanks <a href="https://twitter.com/carusogabriel">@carusogabriel</a> for the <code>diff</code> idea in <code>README</code>. It's brilliant!</p>
<p><br><br></p>
<p>Happy fixing and sniffing!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2018/01/01/new-in-symplify-3-4-time-saving-coding-standard-checkers</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 01 Jan 2018 00:00:00 +0000</pubDate>
                                    <updated>2020-08-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Aug 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Aug 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2018/01/01/new-in-symplify-3-4-time-saving-coding-standard-checkers#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Composer Local Packages for Dummies ]]></title>
                <link>https://tomasvotruba.com/blog/2017/12/25/composer-local-packages-for-dummies</link>
                <description><![CDATA[ <p>This is the simplest way to start using <code>/packages</code> directory in your application, that <strong>leads to cleaner code, maintainable architecture</strong> and is <strong>the best to start testing</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>I wrote about <a href="/blog/2017/02/07/how-to-decouple-monolith-like-a-boss-with-composer-local-packages/">pros and cons of local packages before</a>.
After year of using this in <a href="https://github.com/symplify/symplify">practice</a> and <a href="/trainings">mentorings</a> I polished this approach to even <strong>simpler version that is easy to start with</strong>.</p>
<h3 id="Do-You-Have">Do You Have?</h3>
<ul>
<li><strong>monolithic code in <code>/app</code></strong></li>
<li><strong>no unit tests</strong></li>
<li>code that is using 3rd party services, like payments, invoice API and coding standards</li>
<li>namespaces</li>
<li>old application you maintain for many years</li>
</ul>
<h3 id="Do-You-Want-to">Do You Want to?</h3>
<ul>
<li><strong>start testing</strong></li>
<li><strong>have decoupled code</strong></li>
<li>board new programmer with <strong>no explaining</strong></li>
<li>understand how to scale architecture by decreasing code complexity</li>
</ul>
<p><br></p>
<p>There is no need to use Github, <a href="/blog/2017/01/31/how-monolithic-repository-in-open-source-saved-my-laziness/">love open-source</a>, understand <a href="https://leanpub.com/principles-of-package-design">package design</a> or understand <a href="/blog/2020/06/08/drop-robot-loader-and-let-composer-deal-with-autoloading/">composer beyond PSR-4</a>.
No <a href="https://johannespichler.com/developing-composer-packages-locally">symlink issues</a>, no forgotten <code>composer update</code>. <strong>Anyone can start using this!</strong></p>
<div class="text-center">
    <img src="/assets/images/posts/2017/composer-local-packages/composer.png">
</div>
<h2 id="4-Steps-to-first-Dummy-Local-Package">4 Steps to first Dummy Local Package</h2>
<p>Your application now looks similar to this:</p>
<pre><code class="language-bash">/app
/temp
/vendor
composer.json</code></pre>
<h3 id="1-Create-Packages-directory">1. Create <code>Packages</code> directory</h3>
<pre><code class="language-diff">/app
/temp
+/packages
/vendor
composer.json</code></pre>
<h3 id="2-Create-First-Package">2. Create First Package</h3>
<p>Start with something simple like filesystem or string utils.</p>
<pre><code class="language-diff">/app
/temp
/packages
+   /file-system
+       /src
/vendor
composer.json</code></pre>
<h3 id="3-Move-first-Class-to-new-package-directory">3. Move first Class to new package directory</h3>
<pre><code class="language-diff">/app
/temp
/packages
    /file-system
        /src
+           FileSystem.php
/vendor
composer.json</code></pre>
<p><br></p>
<p>The best practise is to use your <strong>company or application name</strong> as namespace, e.g. <a href="https://www.entrydo.com"><code>EntryDo</code></a>.
Second part of namespace will be <strong>package name</strong> (<code>file-system</code>) in <strong>CamelCaps format</strong>.</p>
<pre><code class="language-php">namespace EntryDo\FileSystem;

final class FileSystem
{
    public function readFile(string $filePath): string
    {
        // is file or directory?
        // is readable?
        // ...
    }
}</code></pre>
<p><strong>You're awesome! Congratulations</strong>, you've just made your first local packages and you're definitely not a dummy anymore.</p>
<h3 id="4-Autoload-with-Composer">4. Autoload with Composer</h3>
<p>The class is now decoupled. Now we have to <strong>tell composer where to find it</strong>!</p>
<p>This is your <code>composer.json</code>:</p>
<pre><code class="language-json">{
    "require": {
        "favorite/framework": "^4.0"
    },
    "autoload": {
        "classmap": "app"
    }
}</code></pre>
<p>Maybe your already have PSR-4 structure (great job if you do!), but let's say you maintain an old application.</p>
<p><br></p>
<p>Add our new package:</p>
<pre><code class="language-diff">{
    "require": {
        "favorite/framework": "^4.0"
    },
    "autoload": {
        "classmap": "app",
+       "psr-4": {
+           "EntryDo\FileSystem\": "packages/file-system/src
+       }
    }
}</code></pre>
<p><br></p>
<p>And now the answer to most questions on StackOverflow around this topic- <strong>rebuild the composer autoload file</strong> (<code>/vendor/autoload.php</code>) from CLI:</p>
<pre><code class="language-bash">composer dump
# which is shortcut for:
# composer dump-autoload</code></pre>
<p>That's it. You are ready to go!</p>
<h2 id="5-Bonus-Add-Your-First-Test">5. Bonus: Add Your First Test</h2>
<p>Add test for a class was never easier. Create Test file for <code>FileSystem</code> class:</p>
<pre><code class="language-diff">/app
/temp
/packages
    /file-system
        /src
            FileSystem.php
+       /tests
+           FileSystemTest.php
/vendor
composer.json</code></pre>
<p><br></p>
<p>Add <code>\Tests</code> to <code>EntryDo\FileSystem</code> namespace:</p>
<pre><code class="language-php">namespace EntryDo\FileSystem\Tests;

use PHPUnit\Framework\TestCase;

final class FileSystemTest extends TestCase
{
    public function testReadFile(): void
    {
        // test readFile() method
    }
}</code></pre>
<p><br></p>
<p>Update <code>phpunit.xml</code> to cover all tests of local packages:</p>
<pre><code class="language-xml">&lt;phpunit bootstrap="vendor/autoload.php" colors="true"&gt;
   &lt;testsuite&gt;
       &lt;directory&gt;packages/*/tests&lt;/directory&gt;
   &lt;/testsuite&gt;
&lt;/phpunit&gt;</code></pre>
<p><br></p>
<p>And run tests:</p>
<pre><code class="language-bash">vendor/bin/phpunit</code></pre>
<p><br></p>
<p>So this is the easiest way how to use composer local packages in 2018. I hope you enjoy it the same way your application does.</p>
<p><br></p>
<p>Happy packaging!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/12/25/composer-local-packages-for-dummies</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 25 Dec 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/12/25/composer-local-packages-for-dummies#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ New in Symplify 3: DocBlock Cleaner Fixer ]]></title>
                <link>https://tomasvotruba.com/blog/2017/12/17/new-in-symplify-3-doc-block-cleaner-fixer</link>
                <description><![CDATA[ <p>Focus on docblock has increased thanks to <a href="https://php.net/manual/en/migration70.new-features.php#migration70.new-features.scalar-type-declarations">PHP 7 scalar types</a> and PHPStan with <a href="https://medium.com/@ondrejmirtes/phpstan-0-9-a-huge-leap-forward-1e9b0872d1cc">intersection and union types</a>. Thanks to that, more and more <strong>docblocks become just visual noise</strong> causing <a href="https://en.wikipedia.org/wiki/Cognitive_load">cognitive overload</a>.
<br><br>
Symplify 3 introduces a new help hand - <strong>fixer that cleans doc block noise for you and makes your code more valuable to the reader</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <blockquote class="blockquote text-center">
    ...when you program, you have to <strong>think about how someone will read your code</strong>, not just how a computer will interpret it.
    <footer class="blockquote-footer">
        <a href="https://en.wikiquote.org/wiki/Kent_Beck">Kent Beck</a>, creator of the Extreme Programming and Test Driven Development
    </footer>
</blockquote>
<p><br></p>
<p>Do you find similar patterns in your code?</p>
<p><br></p>
<pre><code class="language-php">/**
 * @param string $name
 */
public function addVisitor(string $name)
{
    // ...
}</code></pre>
<p><br></p>
<pre><code class="language-php">/**
 * @param InputInterface $input An Input instance
 */
public function getArguments(InputInterface $input)
{
    // ...
}</code></pre>
<p><br></p>
<pre><code class="language-php">/**
 * @param array $items
 */
public function prependItems(array $items)
{
    // ...
}</code></pre>
<p><br></p>
<pre><code class="language-php">/**
 * @return boolean
 */
public function getStorage(): bool
{
    // ...
}</code></pre>
<p><br></p>
<p>Do you know what do they have in common?
<strong>They only duplicate the typehint information and bring no extra value to the reader</strong>.</p>
<div class="text-center">
    <img src="/assets/images/posts/2017/doc-block-cleaner/use-only-what-you-need.jpg" class="img-thumbnail">
</div>
<p><em>No big deal</em> you might say as code author. But your code is much more read that written, so making it as readable as possible should be your priority.</p>
<p><br></p>
<h2 id="How-to-Remove-Manually-Automatically">How to Remove <del>Manually</del> Automatically?</h2>
<p>Cleaning every single case would be crazy. Luckily, we <strong>live in CLI-refactoring generation</strong>,
so all we need is <code>Symplify\CodingStandard\Fixer\Commenting\RemoveUselessDocBlockFixer</code>.</p>
<p><a href="https://github.com/symplify/symplify/pull/427" class="btn btn-dark btn-sm">
See pull-request #427
</a></p>
<p>This fixer scans docs blocks, compares it with code types, evaluates value of each one (like you would do) and <strong>drops</strong> those, which do not add any extra value and only slow down the code reading time.</p>
<h3 id="Tested-on-many-Open-Source-Projects">Tested on many Open-Source Projects</h3>
<p>Docblocks don't have any standard format, so I <strong>first tested this Fixer</strong> on handful of PHP open-source projects. <strong>Open them</strong> to see, what this fixer can do in real code:</p>
<ul>
<li><a href="https://github.com/phpDocumentor/ReflectionDocBlock/pull/137">ReflectionDocBlock</a></li>
<li>and <a href="https://github.com/symfony/symfony/pull/24931">Symfony</a></li>
</ul>
<p>Thanks to that Fixer now <strong>covers dozens of edge cases</strong>.</p>
<h2 id="Challenge-Your-Code">Challenge Your Code</h2>
<h3 id="1-Install">1. Install</h3>
<pre><code class="language-bash">composer require symplify/easy-coding-standard --dev</code></pre>
<h3 id="2-Create-Config">2. Create Config</h3>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\CodingStandard\Fixer\Commenting\RemoveEmptyDocBlockFixer;
use Symplify\CodingStandard\Fixer\Commenting\RemoveSuperfluousDocBlockWhitespaceFixer;
use Symplify\CodingStandard\Fixer\Commenting\RemoveUselessDocBlockFixer;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();

    $services-&gt;set(RemoveUselessDocBlockFixer::class);

    $services-&gt;set(RemoveSuperfluousDocBlockWhitespaceFixer::class);

    $services-&gt;set(RemoveEmptyDocBlockFixer::class);
};</code></pre>
<h3 id="3-Run-It">3. Run It</h3>
<pre><code class="language-bash">vendor/bin/ecs check src</code></pre>
<h3 id="4-See-the-Diff">4. See the Diff</h3>
<div class="text-center">
    <img src="/assets/images/posts/2017/doc-block-cleaner/diff.png" class="img-thumbnail">
</div>
<h3 id="5-And-Fix-It">5. And Fix It</h3>
<pre><code class="language-bash">vendor/bin/ecs check src --fix</code></pre>
<p>Happy eye resting!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/12/17/new-in-symplify-3-doc-block-cleaner-fixer</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Sun, 17 Dec 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/12/17/new-in-symplify-3-doc-block-cleaner-fixer#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ New in Symplify 3: Statie Generators ]]></title>
                <link>https://tomasvotruba.com/blog/2017/12/11/new-in-symplify-3-statie-generators</link>
                <description><![CDATA[ <p>Statie missed one important feature. <strong>Posts were the only elements</strong> that you could render as standlone page.
But what if you want a web porfolio, not with posts but with features projects? Or lectures pages?
<br><br>
<strong>Statie 3 to the rescue!</strong></p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Coupled-Approach-in-old-Statie">Coupled Approach in old Statie</h2>
<p>Posts in Statie 2 were enabled by defaults with following hard coded logic:</p>
<ul>
<li>find all <code>*.md</code> files in <code>_posts</code> directory</li>
<li>create <code>PostFile</code> objects from them</li>
<li>save all of them to global variable <code>posts</code></li>
<li>use route defined in <code>parameters &gt; post_route</code> to render it</li>
<li>render it with <code>_layouts/post.twig</code> layout</li>
</ul>
<p>You could change a <code>post_route</code> or <code>layout</code> in specific post file, but that was it. No flexibility, no extendability and modification of <code>PostFile</code> class was not possible.</p>
<p>In <a href="https://pehapkari.cz">Pehapkari.cz</a> we're staring community <a href="https://pehapkari.cz/vzdelavej-se">lectures</a> and we need not only posts, but <strong>also lectures to be on stand-alone page</strong>, e.g.</p>
<ul>
<li><a href="https://pehapkari.cz/course/doctrine-from-basics">https://pehapkari.cz/course/doctrine-from-basics</a>,</li>
<li><a href="https://pehapkari.cz/course/phpstorm-hacks-and-tips">https://pehapkari.cz/course/phpstorm-hacks-and-tips</a> etc.</li>
</ul>
<p>If this could be only configurable, it would benefit many websites that are more than just a list of posts.</p>
<h2 id="Configurable-Approach-in-Statie-3-with-Generators">Configurable Approach in Statie 3 with Generators</h2>
<p><strong>So here comes Statie 3 Generators</strong>. Same posts approach is now set by default, but also configurable in <code>parameters &gt; generators</code> section:</p>
<pre><code class="language-yaml">parameters:
    generators:
        posts: # key useful for exception reports
            # name of variable inside single such item
            variable: post
            # name of variable that contains all items
            varbiale_global: posts
            # directory, where to look for them
            path: '_posts'
            # which layout to use
            layout: '_layouts/post.twig'
            # and url prefix, e.g. /blog/some-post.md
            route_prefix: 'blog'
            # an object that will wrap it's logic, you can add helper methods into it and use it in templates
            object: 'Symplify\Statie\Renderable\File\PostFile'</code></pre>
<p>The whole old posts logic is now configurable.</p>
<p>Do you need to change path to <code>_articles</code>?</p>
<pre><code class="language-yaml">parameters:
    generators:
        posts:
            path: '_articles'</code></pre>
<p>Or do you want to use own simpler object?</p>
<pre><code class="language-yaml">parameters:
    generators:
        posts:
            object: 'MyWebsite\Statie\SimplePostFile'</code></pre>
<h2 id="How-to-Add-Own-Generator">How to Add Own Generator?</h2>
<p>So how did we solved lectures in Pehapkari.cz website?</p>
<p>Adding new Generator Element is now easy:</p>
<pre><code class="language-yaml"># statie.yml
parameters:
    generators:
        lectures:
            variable: 'lecture'
            variable_global: 'lectures'
            path: '_lectures'
            layout: '_layouts/lecture.twig'
            route_prefix: 'kurz'
            object: 'Pehapkari\Website\Statie\Generator\LectureFile'</code></pre>
<p>Do you want <strong>real code</strong>? See <a href="https://github.com/pehapkari/pehapkari.cz/pull/358/commits/e68d8f98172b2a04e4cf80e635c036c3f2a7bef2">this commit</a> that has it all.</p>
<p>The configuration is as simple as possible, so <code>object</code> is optional. You can read <strong>how to set own file</strong> in <a href="https://www.statie.org/docs/generators">documentation</a>.</p>
<h3 id="How-to-add-new-Lecture">How to add new Lecture?</h3>
<ol>
<li>Create <a href="https://github.com/pehapkari/pehapkari.cz/pull/358/commits/e68d8f98172b2a04e4cf80e635c036c3f2a7bef2#diff-f5b8e6c24f5a089810b255d7d0757105">new <code>*.md</code> file</a> in <code>source/_lectures/</code> directory</li>
<li>Have <a href="https://github.com/pehapkari/pehapkari.cz/pull/358/commits/e68d8f98172b2a04e4cf80e635c036c3f2a7bef2#diff-63d6418d873273aad1011eb0c40b5f3b"><code>_layout/lecture.twig</code></a> ready</li>
<li>Create <a href="https://github.com/pehapkari/pehapkari.cz/pull/358/commits/e68d8f98172b2a04e4cf80e635c036c3f2a7bef2#diff-34b7c0f32f7935ef12a8b2f732c8a9d6"><code>LectureFile</code></a> with extra <code>getTitle()</code> method</li>
</ol>
<p>That's all!</p>
<p>These lectures will be available <strong>in every template under <code>{$lectures}</code> variable</strong>, as configured in <code>variable_global</code> option.</p>
<p>So you can create page <code>source/all-lectures.twig</code> with all lectures (ordered by filename):</p>
<pre><code class="language-twig">{% for lecture in lectures %}
    &lt;h2&gt;{{ lecture.getTitle() }}&lt;/h2&gt;
{% endfor %}</code></pre>
<h2 id="Try-Generators-Out">Try Generators Out</h2>
<p>Just upgrade Statie:</p>
<pre><code class="language-bash">composer update symplify/statie</code></pre>
<p>and add lectures, talks with details, docs... anything you need.</p>
<h3 id="Date-Me">Date Me!</h3>
<p>One more surprise to prevent. In case you use <code>route_prefix</code> with date in it:</p>
<pre><code class="language-yaml"># statie.yaml
parameters:
    generators:
        posts:
            route_prefix: 'blog/:year/:month/:day'</code></pre>
<p>remember, <strong>the date has to be in start of the filename</strong>:</p>
<pre><code class="language-bash">_lectures/2018-01-30-use-open-source-statie-for-open-blogging.md</code></pre>
<p>When setup properly, you get this file in generated code:</p>
<pre><code class="language-bash">2018/01/30/use-open-source-statie-for-open-blogging</code></pre>
<h2 id="How-to-Upgrade-from-Statie-2-to-Statie-3">How to Upgrade from Statie 2 to Statie 3?</h2>
<blockquote class="blockquote text-center mt-lg-5 mb-5">
    "Real code is worth of thousand words describing it."
    <footer class="blockquote-footer">Anonymous Lazy Programmer</footer>
</blockquote>
<p>See these PRs:</p>
<ul>
<li><a href="https://github.com/TomasVotruba/tomasvotruba.com/pull/204">upgrading tomasvotruba.com</a></li>
<li>and <a href="https://github.com/pehapkari/pehapkari.cz/pull/358">Pehapkari.cz</a></li>
</ul>
<p><br></p>
<p>Happy Generating!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/12/11/new-in-symplify-3-statie-generators</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 11 Dec 2017 00:00:00 +0000</pubDate>
                                    <updated>2018-09-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Sep 2018 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Sep 2018 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/12/11/new-in-symplify-3-statie-generators#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Life 3.0: What Will You Do When AI Takes Over the World ]]></title>
                <link>https://tomasvotruba.com/blog/2017/12/04/life30-what-will-you-do-when-ai-takes-over-the-world</link>
                <description><![CDATA[ <p>Do you remember cell phones? Those that could only call and send SMS. I bought a Nokia phone that could <strong>also play mp3s</strong> when I was 14 years old.
Who would have thought <strong>we could play movies and use internet on those phones</strong> just 10 years later.
<br><br>
Artificial Intelligence is now in same level as mobile phones playing mp3s. Or <strong>maybe it already took over the world without knowing us</strong>, as <em>Life 3.0</em> story unveils...</p> ]]></description>
                <content:encoded><![CDATA[ <p><br></p>
<blockquote class="blockquote text-center">
    "The poorest 50 % of Earth's population had earned only about 4 % of the global income, enabling the Omega-controller companies to win their hearts (and votes) by sharing only a modest fraction of their profits with them."
    <footer class="blockquote-footer">Life 3.0, The Omega Team</footer>
</blockquote>
<p><br></p>
<h2 id="Being-Human-in-the-Age-of-Artificial-Intelligence">Being Human in the Age of Artificial Intelligence</h2>
<p>Daniel Pink in one of his <a href="http://www.danpink.com/pinkcast">PinkCast</a> (the best value/time  deal vlogs I know, just ~ 2 minutes) shared a link to book <a href="https://www.amazon.com/Life-3-0-Being-Artificial-Intelligence/dp/1101946598">Life 3.0: Being Human in the Age of Artificial Intelligence</a> by Max Tegmark.</p>
<p>Few more people liked it too, so why not give it a try:</p>
<img src="/assets/images/posts/2017/life30/ai-bestseller.png" class="img-thumbnail">
<p>Until then I only thought about artificial intelligence <strong>from Maths and Psychology point of view</strong>, which is great combination but merely enough to understand the topic properly. This book is mix of fiction, utopia, dystopia, number of researches, <strong>with focus on beneficial intelligence</strong>.</p>
<h3 id="Complex-put-Simple">Complex put Simple</h3>
<p>Max is skilled in putting complex technical concepts in very simple way.</p>
<p>From DeepMind AI playing Atari games:</p>
<img src="/assets/images/posts/2017/life30/deep-mind-atari.png" class="img-thumbnail">
<p>to Alpha GO beating the greatest human master in 2016:</p>
<img src="/assets/images/posts/2017/life30/alpha-go.png" class="img-thumbnail">
<h2 id="Ask-Elon-Musk">Ask Elon Musk</h2>
<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">Worth reading Life 3.0 by <a href="https://twitter.com/tegmark?ref_src=twsrc%5Etfw">@Tegmark</a>. AI will be the best or worst thing ever for humanity, so let’s get it right.<a href="https://t.co/lT0uMH3ujZ">https://t.co/lT0uMH3ujZ</a></p>— Elon Musk (@elonmusk) <a href="https://twitter.com/elonmusk/status/902452162625544193?ref_src=twsrc%5Etfw">August 29, 2017</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>I knew Elon Musk is making cars and rockets, but I didn't knew he supported non-profit <a href="https://futureoflife.org">Future of Life Institute</a> with <a href="https://futureoflife.org/2015/10/12/elon-musk-donates-10m-to-keep-ai-beneficial">$10M</a>.</p>
<p><br></p>
<blockquote class="blockquote text-center">
    "What we really need to do is make sure that life continues into the future. […] It’s best to try to prevent a negative circumstance from occurring than to wait for it to occur and then be reactive."
    <footer class="blockquote-footer">Elon Musk on keeping AI safe and beneficial</footer>
</blockquote>
<h2 id="What-Will-You-Do-when-AI-comes">What Will You Do when AI comes?</h2>
<p>The book made me think really hard. I tried to answer questions that never occur relevant to me:</p>
<ul>
<li><strong>How I want to focus my career in world, where human tasks get more and more automated?</strong></li>
<li>How I want to <strong>raise my child to be adaptable</strong> in the future?</li>
</ul>
<p>I love this part of book:</p>
<p>&quot;What career advice <em>should</em> we give to our kids? I'm encouraging mine to go into professions that machines are currently bad at, and therefore seem unlikely to get automated in the near future.</p>
<ul>
<li>Does it require interacting with people and using social intelligence?</li>
<li>Does it involve creativity and coming up with clever solutions?</li>
<li>Does it require working in an unpredictable environment?&quot;</li>
</ul>
<h2 id="What-are-my-Takeaways">What are my Takeaways?</h2>
<p>The books states that every field have <strong>parts that can be easily automated and parts that will take some time</strong>.</p>
<img src="/assets/images/posts/2017/life30/job-chart.png" class="img-thumbnail">
<p>And not only in non-IT positions. As a programmer you can:</p>
<ul>
<li><strong>create e-commerce</strong> one after another,</li>
<li>focus on <strong>prediction of nearest next product the customer wants to buy before he knows</strong>.</li>
</ul>
<p><br></p>
<p>I found lot of inspiration and possible blind paths for <a href="https://github.com/rectorphp/rector">RectorPHP</a> project. It's <em>narrow intelligence</em>, that upgrades code for you based on your dependencies (I will write about it soon).</p>
<p>If I should apply the same logic as above, <strong>you can be teacher</strong>:</p>
<ul>
<li>who <strong>explains news and trends in software for last 2 years</strong></li>
<li>or the one who teaches people <strong>how to write a tool, that applies those trends to the code and is usable for next 10 years with minimal work</strong></li>
</ul>
<p><br></p>
<p>I realized how I underestimate the AI and remembered my (dead) Nokia:</p>
<img src="/assets/images/posts/2017/life30/nokia-mp3.jpg">
<h3 id="Reading-Protip">Reading Protip!</h3>
<p>The 2nd half of the book focuses on future of 100+ years. The main focus for me lies in first part: <strong>where are we now, what could happens soon and how can we prepare</strong>.</p>
<p>So if you read first half, you'll get most of this book. Of course, if you like sci-fi stories of harvesting Saturn into circu-planet colony keep on reading.</p>
<p><br></p>
<p>Happy reading!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/12/04/life30-what-will-you-do-when-ai-takes-over-the-world</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 04 Dec 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/12/04/life30-what-will-you-do-when-ai-takes-over-the-world#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ United PHP 7.1 Adoption 6 Months Later ]]></title>
                <link>https://tomasvotruba.com/blog/2017/11/27/united-php-71-adoption-6-months-later</link>
                <description><![CDATA[ <p>A year since it's release and 6 months since GoPHP71 initiative.
PHP 7.1 is <strong>the fastest adopted</strong> minor version of PHP already beating PHP 7.0.
<br><br>
How is adoption going in open-source and why it should continue from bleeding-edge projects?</p> ]]></description>
                <content:encoded><![CDATA[ <p><br></p>
<blockquote class="blockquote text-center">
    "United we stand, divided we fall."
    <footer class="blockquote-footer">ancient Greek storyteller Aesop</footer>
</blockquote>
<p><br></p>
<img src="/assets/images/posts/2017/go-php-71-later/unity.jpg">
<h2 id="How-is-GoPHP71-org-Doing">How is GoPHP71.org Doing?</h2>
<p>I've created a page gophp71.org half year ago, inspired by gophp7.org and by <a href="https://www.garfieldtech.com/blog/go-php-5-go">Go PHP 5</a> - read this one if you care about background values of this movement.</p>
<p>In <a href="/blog/2017/06/05/go-php-71/">release post</a> I've explained <strong>why right to PHP 7.1</strong> and not PHP 7.0, how important is <strong>united community</strong> in this and how this can <strong>bring positive energy to open-source</strong> and as well host providers upgrades.</p>
<p><br></p>
<p>From 2 projects in <em>June 2015</em>:</p>
<img src="/assets/images/posts/2017/go-php-71/first-version.png">
<p>Now there are <strong>11 projects</strong>, including <em>big 3</em> - Symfony, Doctrine and Laravel.</p>
<img src="/assets/images/posts/2017/go-php-71-later/current-version.png">
<p>Is your project missing? <a href="https://github.com/TomasVotruba/gophp71.org/edit/master/_data/projects.yaml">Go and it!</a></p>
<h3 id="Prove-beats-Promise-Packagist-Stats">Prove beats Promise - Packagist Stats</h3>
<p>To support &quot;PHP 7.1 is the fastest adopted minor version of PHP&quot; statement, <a href="https://seld.be">Jordi</a> recently released <a href="https://seld.be/notes/php-versions-stats-2017-2-edition">PHP Versions Stats - 2017.2 Edition</a> with very nice result from packagist stats:</p>
<img src="/assets/images/posts/2017/go-php-71-later/composer-bump.png" class="img-thumbnail">
<h2 id="Great-Job-PHP-Community">Great Job, PHP Community!</h2>
<p>It makes me very happy, that <strong>people from PHP community are able to <a href="/blog/2017/10/30/what-can-you-learn-from-menstruation-and-symfony-releases/">synchronize</a></strong> despite their different opinions on things.
<br></p>
<h3 id="Special-Thanks-to-Doctrine-Project">Special Thanks to Doctrine Project</h3>
<p>I really loved this <a href="http://www.doctrine-project.org/2017/07/25/php-7.1-requirement-and-composer.html">Doctrine bump PHP 7.1 announcement</a>. I completely agree with &quot;Why dropping PHP support in a minor version is not a BC break&quot; part. If you think PHP version bump is BC break, you should read it.</p>
<p>I admit <a href="/blog/2017/03/27/why-is-doctrine-dying/">I wasn't nice</a> to Doctrine Project this Spring and <strong>I'm sincerely sorry about that</strong>. I'm trying to <a href="/blog/2017/10/16/how-to-use-repository-with-doctrine-as-service-in-symfony/">influence this better way</a>.</p>
<p>Ever since I <strong>see Doctrine community are doing great</strong> - from <a href="https://github.com/doctrine/doctrine2/pull/5932">removing YAML references</a>, to <a href="https://github.com/doctrine/DoctrineBundle/pull/727">cleaner Symfony support</a>.</p>
<h2 id="But-I-want-to-go-PHP-7-0">But I want to go PHP 7.0</h2>
<p>Still not convinced about reasons?</p>
<p><a href="https://github.com/dmonllao">@dmonllao</a> poses an idea: <em>I want to take is slowly <or another reason> and go only to PHP 7.0</em>.</p>
<p>Let me explain how that could influence PHP ecosystem and slow down productivity of many projects:</p>
<ul>
<li>Imagine that in 6 months all of those 11 projects on gophp71.org will <strong>require PHP 7.1 in their LTS versions</strong>.</li>
<li><em>Moodle</em> (could be any other package, it's just example) decides to go with <strong>PHP 7.0</strong>.</li>
<li>If you work with PHP, there is quite big chance you'll be using at least one of those 11 packages.</li>
<li>Let's say you want to use newest features + LTS, so you <strong>bump your local nad server to PHP 7.1</strong>.</li>
</ul>
<p>All good for now, but then:</p>
<ul>
<li>You need to use <em>Moodle</em> in your project. <strong>Its code contains only PHP 7.0 features</strong>.</li>
<li>Your code naturally <strong>extends or implements 3rd party classes</strong>. You can use PHP 7.1 on most of them - e.g. <code>void</code> and nullable typehints of interfaces.</li>
<li>But then your need to extends <em>Moodle</em>'s code and <strong>you have to be careful and use only PHP 7.0 features</strong>. Features like <code>void</code> or <code>nullable</code> would break it.</li>
</ul>
<h3 id="Result-Double-Measures-and-amp-Dichotomic-Coding">Result? Double Measures &amp; Dichotomic Coding</h3>
<ul>
<li>You have to have <strong>2 different coding standards</strong> - one for PHP 7.0 and one for PHP 7.1 with various paths to scan.</li>
<li>If you use static analysis like <a href="/blog/2017/01/28/why-I-switched-scrutinizer-for-phpstan-and-you-should-too/">PHPStan</a>, you have to have 2 configs again to validate code properly.</li>
<li>2 testing approaches etc.</li>
</ul>
<p>And that's <strong>only 1 package with different PHP version</strong>. Imagine there would another package that requires PHP 7.2... or if you combine PHP 7.0 and PHP 7.1 interface in single class.</p>
<h2 id="But-I-don-t-want-to-Drop-Support-for-PHP-7-0">But I don't want to Drop Support for PHP 7.0</h2>
<img src="/assets/images/posts/2017/go-php-71-later/old-releases.png" class="img-thumbnail">
<p>I've borrowed this amazing picture from <a href="https://seld.be/notes/php-versions-stats-2016-2-edition">Jordi</a>.</p>
<p>You <strong>can keep support for older PHP version</strong> even if you bump minimal requirement to PHP 7.1, just won't add new features to them.</p>
<h3 id="Spread-the-Word">Spread the Word</h3>
<p>At the moment only 4 projects on are tagged and it will take some timer before this becomes mainstream. Yet, we can see obvious trend moving to PHP 7.1 as minimal requirement. <strong>Thanks to community and people that are bold enough to ask the question</strong> or <a href="https://github.com/laravel/framework/pull/21995">even sending a PR</a>.</p>
<p><br></p>
<p><strong>If you see some next project bumping to PHP 7.0, think about possible consequences of that decision.</strong></p>
<p><br><br></p>
<p>Happy bumping!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/11/27/united-php-71-adoption-6-months-later</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 27 Nov 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/11/27/united-php-71-adoption-6-months-later#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Write Interesting Jobs Offers for Programmers ]]></title>
                <link>https://tomasvotruba.com/blog/2017/11/20/how-to-write-interesting-job-offers-for-programmers</link>
                <description><![CDATA[ <p>A few years watching the labor market from a position of PHP programmers from the perspective of companies. With both sides have a good relationship. I think what they need and what is bothering you. <strong>I see that they want each other, just communication is little stuck</strong>.
<br><br>
I gave feedback on Jobs.cz, Skrz.cz and few more ads and this is <strong>summary of tips, which I want to share with every company trying to hire programmer</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="AD-is-an-Advertising-Article-Get-a-Copywriter">AD is an Advertising Article - Get a Copywriter</h2>
<p>The entire ad is one long seduction. At the end of it you should get the candidate to bed and satisfy him. So he will come next morning to your company.</p>
<h2 id="It-s-not-About-You-It-s-About-Who-You-Look-For"><del>It's not About You</del> - It's About Who You Look For</h2>
<p>Plenty of ads are written more like a self-presentation of the company - what they do, what they are best in and what they accomplished.</p>
<p>But <strong>people actually read because they want something for themselves</strong> - information, money or entertainment. <strong>What the job will be, should be right at the beginning. Give it to them in the first sentence!</strong></p>
<h2 id="Be-honest">Be honest</h2>
<p>Write about technology that you really have. Not those which you plan or want, but that you <em>really have</em>. Imagine when somebody who is looking forward to PHP 7 will come to your interview and will find out that it's plan for 2018 - <strong>you've just lost a candidate</strong>.</p>
<p><strong>The text must be honest with and the reader must get what he expects. Only then he or she will trust you and come back to you.</strong></p>
<h2 id="Friends-with-Benefits">Friends with Benefits</h2>
<p><strong>When you work with someone skilled and popular in the community</strong>, mention him or her. People will follow known friend more likely than <em>bare company</em>.</p>
<h2 id="Ask-for-Feedback-Inside-and-Outside">Ask for Feedback - Inside and Outside</h2>
<p><strong>1. Ask people you've already hired</strong></p>
<ul>
<li>&quot;What ultimately led you to us instead of the competitor?&quot;</li>
</ul>
<p><strong>2. Ask somebody outside your company</strong></p>
<ul>
<li>Your employees will naturally be less critical, since you give them money. People from the outside will give you <strong>more honest feedback</strong> and rather say what they need to establish a relationship.</li>
</ul>
<p><strong>3. What 2 things are the best and which 2 could you improve?</strong></p>
<ul>
<li>Write few people from your target group and ask them this. This is a chance to learn how you perceived in the outside.</li>
</ul>
<h2 id="Open-Source-Strip">Open Source Strip</h2>
<p>Show how you do it - really. Evidence beats promise.</p>
<p><strong>Are you doing open-source? Show it!</strong> I know that Jobs, Slevomat, PeckaDesign and ShopSys have packages on GitHub. but just few of them share it in the advertisement.</p>
<p>At least, your potential coworkers will get insight into the code of applications you make.</p>
<p>One example for all: I love <a href="http://www.delejcoumis.cz">delejcoumis.cz</a>. <strong>Its <a href="https://github.com/peckadesign/DelejCoUmis.cz">open-sourced on Github</a></strong> and it allows me:</p>
<ul>
<li>to easily determine the company's skill level</li>
<li>find if I <strong>understand the code</strong></li>
<li>find if I can <strong>learn something</strong></li>
<li>and with <a href="https://github.com/peckadesign/DelejCoUmis.cz/blob/master/composer.json"><code>composer.json</code></a> - see what technology they know and use</li>
</ul>
<p><strong>Open-source is a very underrated hiring tool.</strong></p>
<h2 id="Sell-your-Differences">Sell your Differences</h2>
<p>That's <strong>why people go to you</strong>. Not because you're making <em>PHP, Symfony and Doctrine e-commerce</em>.</p>
<h3 id="What-is-Attractive-difference">What is Attractive difference?</h3>
<ul>
<li>
<p>&quot;<strong>Every month we have a half-day training</strong> - voluntary and optional programmers&quot;</p>
</li>
<li>
<p>I've also heard <strong>&quot;each month we have a half-day training&quot;</strong> . But this is a mandatory and picked by manager - ouch. There is no greater pain than to be in training <em>How be Instagram Star</em>, when I want to learn <em>how to scale with AWS</em>.</p>
</li>
<li>
<p>&quot;<strong>We give each year 10 000 CZK for education</strong> and can themselves choose how to invest&quot;</p>
</li>
<li>
<p>&quot;<strong>Every last Friday of the month we give programmers the option to refactor</strong> any part of the code they want&quot;</p>
</li>
<li>
<p>&quot;<strong>10 % of work time is for you personal projects</strong>&quot;</p>
</li>
</ul>
<p>True stories, bro!</p>
<h2 id="Size-and-Age-Doesn-t-Matter">Size and Age Doesn't Matter</h2>
<p>Concepts such as <em>junior</em> and <em>senior</em> make no sense to me. <strong>Why?</strong> Imagine 2 people who are looking for work:</p>
<ul>
<li>
<p>A. Senior may be a <strong>developer with 10 years of experience</strong>, knows the framework A, which he self-taught and does not want to try other, because he thinks it's the best.</p>
</li>
<li>
<p>B. Junior may be a <strong>19 year-old guy</strong>, who didn't write any framework. But he knows about Elastic, Doctrine, Nette and begins to read about Symfony.</p>
</li>
</ul>
<p><strong>Who would you pick?</strong></p>
<p>From reader's point of view - if you write <em>We look for Senior</em> in the ad, which one will write you? People tent to underestimate them selves, moreover programmers.</p>
<img src="/assets/images/posts/2017/job-offers/attitude.jpg" class="img-thumbnail" alt="Attitude for skill">
<p><br></p>
<p>That is my experience collection with PHP job adverts. And what about you?</p>
<p><strong>What got you to your current job?</strong> Throw me a link in the comments.</p>
<p>Happy hiring!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/11/20/how-to-write-interesting-job-offers-for-programmers</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 20 Nov 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/11/20/how-to-write-interesting-job-offers-for-programmers#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 7 Tips You Should Know Before Going To University ]]></title>
                <link>https://tomasvotruba.com/blog/2017/11/13/7-tips-you-should-know-before-going-to-university</link>
                <description><![CDATA[ <p>It's been 4 years since I finished university without having any degree out of it. During those 4 years, I was asked about university by people I could count on the fingers of one hand. And the about the degree? <strong>Not one.</strong>
<br><br>
<strong>I recently talked with one high-school guy and I realized that college is still seen as something sacred, important and mostly from no other than teachers and parents</strong>. I told myself that I'll write down my insights and advice that I would give my 8 years younger self. <strong>If you are 18-19 years're considering what to do next, go ahead</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p><strong>Disclaimer: these is my personal experience with universities in Brno, Czech Republic between 2008 and 2013. It can differ for your country, your city, your year spend on collage, your field etc. Please consider that while reading. Well, if you are already on university. The main goal of this post to start discussion and challenge you and your personal experiences.</strong></p>
<h2 id="1-Ask-Someone-Who-Didn-t-Go-to-College">1. Ask Someone Who Didn't Go to College</h2>
<p>I often received information from parents or from high-school teachers. <strong>It's like asking a Christian priest about religion</strong>. He will probably know a lot about Christianity, but he won't mention Buddhism or Islam in much depth.</p>
<p>This is called <a href="https://en.wikipedia.org/wiki/Confirmation_bias">Confirmation Bias</a> - <strong>people tend to take the information that supports their own point of view</strong> over those which would confront them. Watch out for him :)</p>
<h2 id="2-Find-Experienced-People-in-the-Field-You-Enjoy">2. Find Experienced People in the Field You Enjoy</h2>
<p>I didn't do this because I did not know anybody like that. Today I would go to Facebook and look for a &quot;psychology, php programming&quot; and invited the top 3 results for coffee.</p>
<p><strong>Why?</strong> These people can share real experience, with university, with job - they're like my 5 years older self I could ask for my path instead of having to walk it myself. This could save me 1-2 years of blind shooting.</p>
<h3 id="Where-to-find-such-people">Where to find such people?</h3>
<p>There are cheap ways to find such people (in Czech Republic):</p>
<ul>
<li><a href="https://www.naucmese.cz">Naučmese</a> - courses from hundreds different people, who will gladly tell you about their experiences - I met a many interesting people here</li>
<li><strong>Facebook Groups</strong> - anything you like, it's there: media, programmers, marketers, copywriters, business, ppc...</li>
<li><a href="https://eventigo.cz">Eventigo</a> - with similar focus groups as those above, Eventigo sends you weekly newsletter about <strong>free meetups and events</strong> you can visit and meet real people with same passions (or ideas)</li>
</ul>
<h2 id="3-The-University-can-be-Incubator">3. The University can be Incubator</h2>
<p>Without too much trouble, you can get <strong>3 years time</strong> to explore the World and yourself. Rent and food is super cheap (like 4x times less than my current one), parent might help you with financing or you can find part-time - as student are very favorite labour force.</p>
<p>Don't wait it out, <strong>take advantage of it</strong>:</p>
<ul>
<li>Experiment with different activities in and outside university</li>
<li>Take each semester <strong>1 course from another field (faculty)</strong> - you don't even have to finish them, just go and see</li>
<li><strong>Taste the diversity</strong> of habits that will bring <strong>peers from other cities or country</strong></li>
<li><strong>Take a risk, failure will never be cheaper</strong> - with a girlfriend, wife, business, contract, full-time work, child or mortgage this all will be very complicated</li>
</ul>
<p>Fortunately, I got this idea already in high-school. Where I risked the most? <strong>I started to say more money for my work than peers</strong>. I risked unemployment and I was terribly scared that I would be rejected. If I had a monthly cost that I'd have pay (like now), I wouldn't dare.</p>
<p>As a result, I learned that <strong>the price is only contract</strong>. It's not about skills, not about work, not about experience, not about, not about contacts, not about age, not about degree. Well it is, but much less than what you really agree upon.</p>
<p>When we agree on 4 € per hour, it will be 4 €. When we arrange 40 € per hour, it will be 40 €.</p>
<h3 id="It-Will-Be-Over-Soon">It Will Be Over Soon</h3>
<p>You will experience a lot of changes in freshman (first) year which you will need your time and effort.
But remember - you have 3 years, they will end and so will this nice-and-easy period. <strong>Even if you're having a great time, try to do something extra</strong>.</p>
<h2 id="4-Treat-School-as-an-Option-not-as-Salvation">4. Treat School as an Option, not as Salvation</h2>
<p>A lot of my peers devoted <strong>90 % of their energy to school</strong> and they didn't have any side interests.</p>
<p>It's like a work:</p>
<img src="/assets/images/posts/2017/university/procrastination.png" class="img-thumbnail">
<p>This is followed by...</p>
<h2 id="5-Grades-and-Pareto-80-20-Principle">5. Grades and <a href="https://en.wikipedia.org/wiki/Pareto_principle">Pareto 80/20 Principle</a></h2>
<p>This took me 1,5 year to find out. So simple, yet to easy to miss.</p>
<ul>
<li>to <strong>pass an exam</strong>, it takes <strong>20 %</strong> of work</li>
<li>to pass an exam with <strong>A</strong>, it takes <strong>80 %</strong> of work</li>
</ul>
<p>The grade has nothing to do with intelligence, social status and skills. It's just <strong>a number on a test</strong>. That's it.</p>
<p>Same is for IQ. <strong>IQ only indicates your ability to achieve high scores on IQ tests</strong>. Nothing more. Trust me, I've studied on <a href="http://psych.fss.muni.cz">Faculty of Psychology</a>.</p>
<p><strong>The mark is an indicator ability to succeed in this test.</strong> Consider what is <strong>important to you</strong> and if you want to invest those 60 % to:</p>
<ul>
<li><em>raising letters and numbers in a database</em> which will vanish in history when you leave academic land</li>
<li>or in the <em>self-development</em> that you can build upon for the rest of your life</li>
</ul>
<h2 id="6-Most-College-Teachers-are-not-Practitioners">6. Most College Teachers are not Practitioners</h2>
<p>This is my huge regret. Teachers teach at the school. People who stay at the school since their student years. They often have <strong>little experience in the art they teach</strong>. How it looks?</p>
<ul>
<li>The computer science <strong>was not taught by architect</strong>, who designs real processors or programs.</li>
<li>The human psyche <strong>was not taught by therapist</strong> with 10 years' experience, who has helped hundreds of people.</li>
</ul>
<p>But the professor who writes researches, marks exams and its main practice is lecturing and conducting seminars.</p>
<p>Could you imagine a world where this works?</p>
<h2 id="7-Know-How-Lag">7. Know-How Lag</h2>
<p>The same way people social skills are lagging behind technical evolution, universities are lagging behind knowledge of present day.</p>
<p>I expected to learn hot news from the field. But I <strong>received more education in the history</strong>.</p>
<p>In my times, web technologies were forbidden topic. &quot;It does not matter that PHP runs most of Internet, you will learn the electrical circuitry and programming processors.&quot;</p>
<p>This <em>know-how-lag</em> is even greater than on primary and secondary school. To find news, I had to rely on the Internet or my older friends.</p>
<p><br></p>
<h3 id="Where-are-you">Where are you?</h3>
<p>Are you in high school? Do you think about going to university? Or do you already work?</p>
<p>Which point do find most useful? What would your advice be?</p>
<p>Let me know in the comments.</p>
<p><br></p>
<p>Happy learning!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/11/13/7-tips-you-should-know-before-going-to-university</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 13 Nov 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/11/13/7-tips-you-should-know-before-going-to-university#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to change PHP code with Abstract Syntax Tree ]]></title>
                <link>https://tomasvotruba.com/blog/2017/11/06/how-to-change-php-code-with-abstract-syntax-tree</link>
                <description><![CDATA[ <p>Today we can do amazing things with PHP. Thanks to AST and <a href="https://github.com/nikic/PHP-Parser">nikic/php-parser</a> we can create very <strong>narrow artificial intelligence, which can work for us</strong>.
<br><br>
Let's create first its synapse!</p> ]]></description>
                <content:encoded><![CDATA[ <p>We need to make clear what are we talking about right at the beginning. When we say &quot;PHP AST&quot;, you can talk about 2 things:</p>
<h3 id="1-php-ast">1. php-ast</h3>
<p>This is native extension which exports the AST internally used by PHP 7.0+. It allows <strong>read-only</strong> and is very fast, since it's native C extension. Internal AST was added to PHP 7.0 by skill-full Nikita Popov in <a href="https://wiki.php.net/rfc/abstract_syntax_tree">this RFC</a>. You can find it on GitHub under <a href="https://github.com/nikic/php-ast">nikic/php-ast</a>.</p>
<h3 id="2-PHP-AST">2. PHP AST</h3>
<p>This is AST of PHP in Object PHP. It will take your PHP code, turn into PHP object with autocomplete in IDE and <strong>allows you to modify code</strong>. You can find it on GitHub under <a href="https://github.com/nikic/PHP-Parser"><code>nikic/PHP-Parser</code></a>.</p>
<p>Nikita explains <a href="https://github.com/nikic/php-ast#differences-to-php-parser">differences between those 2 in more detailed technical way</a>. Personally I love <a href="https://github.com/nikic/PHP-Parser/blob/master/doc/0_Introduction.markdown#what-is-this-for">this human reason</a> the most:</p>
<p><br></p>
<blockquote class="blockquote">
    "Why would I want to have a PHP parser written in PHP? Well, PHP might not be a language especially suited for fast parsing, but processing the AST is much easier in PHP than it would be in other, faster languages like C. Furthermore the people most probably wanting to do programmatic PHP code analysis are incidentally PHP developers, not C developers."
    <footer class="blockquote-footer text-right">Nikita Popov</footer>
</blockquote>
<p><br></p>
<p>Which one would you pick? If you're <strong>lazy like me and hate reading code and writing code</strong> over and over again, the 2nd one.</p>
<h2 id="What-work-can-nikic-PHP-Parser-do-for-us">What work can <code>nikic/PHP-Parser</code> do for us?</h2>
<p>Saying that, <strong>we skip the read-feature</strong> of this package - it's used by <a href="https://github.com/phpstan/phpstan">PHPStan</a> or <a href="https://github.com/Roave/BetterReflection">BetterReflection</a> - and <strong>move right to the writing-feature</strong>. Btw, back in 2012, even <a href="https://github.com/nikic/PHP-Parser/issues/41">Fabien wanted to use it in PHP CS Fixer</a>, but it wasn't ready yet.</p>
<h3 id="When-we-say-modify-and-AST-together-what-can-you-brainstorm">When we say <em>modify</em> and <em>AST</em> together, what can you brainstorm?</h3>
<ul>
<li>change method name</li>
<li>change class name</li>
<li>rename property</li>
<li>change property to method call</li>
<li>move method from one class to another</li>
<li>split class to multiple ones</li>
<li>refactor <code>$this-&gt;get('name')</code> to constructor injection in Symfony App</li>
<li>upgrade App from Symfony 3.0 to 4.0</li>
<li>refactor Laravel App to Symfony App</li>
<li>...</li>
</ul>
<p>It can do many things for you, depends on how much work you put in it. Today we will try to <strong>change method name</strong>.</p>
<h2 id="4-Steps-to-Changing-a-name">4 Steps to Changing a name</h2>
<h3 id="1-Parse-code-to-Nodes">1. Parse code to Nodes</h3>
<pre><code class="language-bash">composer require nikic/php-parser</code></pre>
<p>Create parser and parse the file:</p>
<pre><code class="language-php">use PhpParser\Parser;
use PhpParser\ParserFactory;

$parserFactory = new ParserFactory();

// or PREFER_PHP5, if your code is older
$parser = $parserFactory-&gt;create(ParserFactory::PREFER_PHP7);

$nodes = $parser-&gt;parse(file_get_contents(__DIR__ . '/SomeClass.php'));</code></pre>
<h3 id="2-Find-Method-Node">2. Find Method Node</h3>
<p>The best way to work with Nodes is to <strong>traverse them with <a href="https://github.com/nikic/PHP-Parser/blob/master/lib/PhpParser/NodeTraverser.php"><code>PhpParser\NodeTraverser</code></a></strong>:</p>
<pre><code class="language-php">$nodeTraverser = new PhpParser\NodeTraverser;

$traversedNodes = $nodeTraverser-&gt;traverse($nodes);</code></pre>
<p>Now we traversed all nodes, but nothing actually happened. Do you think we forgot to invite somebody in?</p>
<p>Yes, <strong>we need <a href="https://github.com/nikic/PHP-Parser/blob/master/lib/PhpParser/NodeVisitor.php"><code>PhpParser\NodeVisitor</code></a></strong> - an interface with 4 methods. We can either implement all 4 of them, or use <a href="https://github.com/nikic/PHP-Parser/blob/master/lib/PhpParser/NodeVisitorAbstract.php"><code>PhpParser\NodeVisitorAbstract</code></a> to save some work:</p>
<pre><code class="language-php">use PhpParser\NodeVisitorAbstract;

final class ChangeMethodNameNodeVisitor extends NodeVisitorAbstract
{
}</code></pre>
<p>We need to find a <code>ClassMethod</code> node. I know that, because I use this package often, <strong>but you can <a href="https://github.com/nikic/PHP-Parser/tree/master/lib/PhpParser/Node">find all nodes here</a></strong>. To do that, we'll use <code>enterNode()</code> method:</p>
<pre><code class="language-php">use PhpParser\Node;
use PhpParser\NodeVisitorAbstract;
use PhpParser\Node\Stmt\ClassMethod;

final class ChangeMethodNameNodeVisitor extends NodeVisitorAbstract
{
    public function enterNode(Node $node)
    {
        if (! $node instanceof ClassMethod) {
            return null;
        }

        // so we got it, what now?
    }
}</code></pre>
<h3 id="3-Change-Method-Name">3. Change Method Name</h3>
<p>No we find it's name and change it!</p>
<pre><code class="language-php">use PhpParser\Node;
use PhpParser\Node\Name;
use PhpParser\Node\Stmt\ClassMethod;
use PhpParser\NodeVisitorAbstract;

final class ChangeMethodNameNodeVisitor extends NodeVisitorAbstract
{
    public function enterNode(Node $node)
    {
        if (! $node instanceof ClassMethod) {
            return null;
        }

        $node-&gt;name = new Name('newName');

        // return node to tell parser to modify it
        return $node;
    }
}</code></pre>
<p>To work with <strong>class names, interface names, method names</strong> etc., we need to <strong>use <code>PhpParser\Node\Name</code></strong>.</p>
<p>Oh, I almost forgot, we need to actually <strong>invite visitor to the <code>NodeTraverser</code></strong> like this:</p>
<pre><code class="language-php">$nodeTraverser = new PhpParser\NodeTraverser;
$nodeTraverser-&gt;addVisitor(new ChangeMethodNameNodeVisitor);

$traversedNodes = $nodeTraverser-&gt;traverse($nodes);</code></pre>
<h3 id="4-Save-to-File">4. Save to File</h3>
<p>Last step is saving the file (<a href="https://github.com/nikic/PHP-Parser/blob/master/doc/component/Pretty_printing.markdown">see docs</a>). We have 2 options here:</p>
<p><br></p>
<p><strong>A. Dumb Saving</strong></p>
<pre><code class="language-php">$prettyPrinter = new PhpParser\PrettyPrinter\Standard;
$newCode = $prettyPrinter-&gt;prettyPrintFile($traversedNodes);

file_put_contents(__DIR__ . '/SomeClass.php', $newCode);</code></pre>
<p>But this will actually <strong>removes spaces and comments</strong>. How to make it right?</p>
<p><br></p>
<p><strong>B. Format-Preserving Printer</strong></p>
<p>It requires more steps, but you will have output much more under control.</p>
<p>Without our code, it would look like this:</p>
<pre><code class="language-php">use PhpParser\Lexer\Emulative;
use PhpParser\NodeTraverser;
use PhpParser\NodeVisitor;
use PhpParser\NodeVisitor\CloningVisitor;
use PhpParser\Parser\Php7;
use PhpParser\PrettyPrinter\Standard;

$lexer = new Emulative([
    'usedAttributes' =&gt; [
        'comments',
        'startLine', 'endLine',
        'startTokenPos', 'endTokenPos',
    ],
]);

$parser = new Php7($lexer);
$traverser = new NodeTraverser;
$traverser-&gt;addVisitor(new CloningVisitor);

$oldStmts = $parser-&gt;parse($code);
$oldTokens = $lexer-&gt;getTokens();

$newStmts = $traverser-&gt;traverse($oldStmts);

// our code start

$nodeTraverser = new NodeTraverser;
$nodeTraverser-&gt;addVisitor($nodeVisitor);

$newStmts = $traversedNodes = $nodeTraverser-&gt;traverse($newStmts);

// our code end

$newCode = (new Standard)-&gt;printFormatPreserving($newStmts, $oldStmts, $oldTokens);</code></pre>
<p>Congrats, now you've successfully renamed method to <code>newName</code>!</p>
<h2 id="Advanced-Changes-With-Rector">Advanced Changes? With Rector!</h2>
<p>Do you want to see more advanced operations, like those we <a href="#when-we-say-em-modify-em-and-em-ast-em-together-what-can-you-brainstorm">brainstormed in the beginning</a>? Look at package I'm working on which should <strong>automate application upgrades</strong> - <strong><a href="https://github.com/RectorPHP/Rector">RectorPHP</a></strong>.</p>
<p><br></p>
<p>Let me know in the comments, what would you like to read about AST and its Traversing and Modification. I might inspire by your ideas.</p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/11/06/how-to-change-php-code-with-abstract-syntax-tree</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 06 Nov 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/11/06/how-to-change-php-code-with-abstract-syntax-tree#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ What can You Learn from Menstruation and Symfony Releases ]]></title>
                <link>https://tomasvotruba.com/blog/2017/10/30/what-can-you-learn-from-menstruation-and-symfony-releases</link>
                <description><![CDATA[ <p>I <a href="/blog/2017/01/31/how-monolithic-repository-in-open-source-saved-my-laziness/">wrote about monorepo and how it turned me into lazy programmer</a> before.
<br><br>
As monorepo is use <a href="https://blog.shopsys.com/how-to-maintain-multiple-git-repositories-with-ease-61a5e17152e0">more and more</a>, we should look at it again.
Today from a bit atypical point of view: <strong>combined with bit of blood and sunshine</strong>.
<br><br>
Are you ready?</p> ]]></description>
                <content:encoded><![CDATA[ <p><em>Disclaimer: this post has no intention to put menstruation into any bad light. Exactly the opposite - I admire women and love to learn from them.</em></p>
<h2 id="Technical-Natural-Releases"><del>Technical</del> Natural Releases</h2>
<p>We will look on release management. Non from traditional technical point of view that is already described in <a href="http://semver.org">semantic versioning</a>, <a href="https://symfony.com/doc/current/contributing/code/bc.html">Symfony BC Promise</a> etc., but rather from view of <em>nature</em>.</p>
<p><strong>Why?</strong> When I'm stuck with complicated architectural problem and can't figure it out, I take a break and <strong>go for a walk</strong>. <strong>Just observing world around me</strong>, absorbing inspiration without expectations - <em>serendipity</em>.</p>
<p>To be honest, <strong>many technologies we use originated from the nature</strong>. Processor and hard drives from brain, camera lenses from eyes and design pattern from pattern of nature. What else are falling leaves of tree in autumn? An <strong>event subscriber</strong>.</p>
<h3 id="Menstruation-Cycle-as-Inspiration">Menstruation Cycle as Inspiration</h3>
<img src="/assets/images/posts/2017/menstruation/periods.jpg" class="img-thumbnail">
<p>When we look at our main ability to survive - to reproduce ourselves, we see it's very easy to follow. Menstruation comes in cycles of ~28 days. All 4 parts of period have special meaning for the body of woman and her ability to get pregnant. We <strong>know when it happens, how long it takes and when it ends</strong> (roughly).</p>
<p>Now the interesting part: <em>can you imagine software having release cycles in 28 days?</em></p>
<p>Just keep reading.</p>
<h3 id="Four-Seasons-Cycle">Four Seasons Cycle</h3>
<img src="/assets/images/posts/2017/menstruation/seasons.jpg" class="img-thumbnail">
<p>A bit longer periodical system in nature that works for some time now. Again, each of 4 parts of this cycle has its meaning:</p>
<ul>
<li><em>Spring</em> - growing and getting stronger</li>
<li><em>Summer</em> - reaching the peak and making seeds</li>
<li><em>Autumn</em> - preparing for rest, cleaning up</li>
<li><em>Winter</em> - peaceful time of sleep and retrospective</li>
</ul>
<p>Every part takes 3 months and restarts every 12 month. <strong>You just know when winter comes</strong>.</p>
<p>Now back to the interesting part: <em>could you imagine having release plan synced with the year period?</em></p>
<p><br></p>
<p>Also, did you know women that spend lot of time together <strong>tend to sync their menstruation cycle with each other</strong>? We will get back to the later software-wise.</p>
<h2 id="What-is-Basic-Stone-for-Evolution">What is Basic Stone for Evolution?</h2>
<p>When we look at those patterns of nature, they have one important sign in common. A sign that we can see more and more in software development - <strong>predictability</strong>.</p>
<p>You <strong>know</strong> when the winter comes or when <strong>your spouse needs more attention and care</strong> when her period starts. You can plan, you can prepare and you can learn this by heart. As a result, <strong>you can focus on more dynamic things that are not to predictable</strong> - like your emotions, ideas or <strong>priorities on development of your project</strong>.</p>
<h3 id="Symfony-Cycle-meets-Nature-Cycle">Symfony Cycle meets Nature Cycle</h3>
<img src="/assets/images/posts/2017/menstruation/symfony.jpg" class="img-thumbnail">
<p>I first realized this at Fabien's talk about Symfony new release cycle on <a href="https://pariscon2015.symfony.com">SymfonyCon Paris 2015</a>:</p>
<ul>
<li><strong>Major versions every 2 years, minor every 6 months.</strong></li>
</ul>
<p>So simple yet so amazing. I don't think about &quot;when will the new Symfony come?&quot; any more.</p>
<h3 id="What-about-PHP">What about PHP?</h3>
<img src="/assets/images/posts/2017/menstruation/php.png" class="img-thumbnail">
<p>I recall wondering when PHP 5.5, 5.6 or 7.0 will be out. No more thanks to <strong><a href="https://php.net/supported-versions.php">yearly period beginning of December</a></strong> since PHP 7.0.</p>
<h3 id="Menstruation-Synchronization">Menstruation Synchronization</h3>
<p>As I wrote earlier, women that spend lot of time together tend to sync their menstruation cycle with each other. Have you noticed that <strong>Symfony matches PHP cycle every 2 years</strong>? Coincidence? I&nbsp;don't think so.</p>
<img src="/assets/images/posts/2017/menstruation/together.png" class="img-thumbnail">
<p>I think they're doing <strong>the right thing</strong> right.</p>
<h2 id="Why-We-Should-Menstruate-Together">Why We Should Menstruate Together?</h2>
<p>We're getting back to software releases and monorepo. (If you see term <em>monorepo</em> first time, read <a href="http://danluu.com/monorepo">this legendary post by <em>danluu</em></a>).</p>
<p>Some people say that big disadvantage of monorepo is that <strong>they have to tag their packages all together</strong> (like Symfony) even if nothing changed in any of them.</p>
<p>I see it as <strong>advantage</strong>, because that systematically leads to release cycle and open possibility to synchronization with other projects, like PHP + Symfony.</p>
<h3 id="See-for-Yourself">See for Yourself</h3>
<p>Which of these 3 applications would you pick to maintain and upgrade based on their <code>composer.json</code>?</p>
<p><br></p>
<p><strong>A</strong> with <em>per-package</em> versioning:</p>
<pre><code class="language-javascript">{
      "require": {
        "symfony/http-foundation": "3.3",
        "symfony/console": "3.1",
        "symfony/dependency-injection": "2.8",
        "symfony/event-dispatcher": "3.2",
        "doctrine/orm": "2.5",
        "doctrine/dbal": "2.3",
        "doctrine/annotations": "1.7",
        "nette/utils": "2.3",
        "nette/finder": "3.0"
      }
}</code></pre>
<p><br></p>
<p>or <strong>B</strong> with <a href="https://getcomposer.org/doc/04-schema.md#name"><em>per-vendor-sync</em></a></p>
<pre><code class="language-javascript">{
      "require": {
        "symfony/http-foundation": "3.3",
        "symfony/console": "3.3",
        "symfony/dependency-injection": "3.3",
        "symfony/event-dispatcher": "3.3",
        "doctrine/orm": "2.5",
        "doctrine/dbal": "2.5",
        "doctrine/annotations": "2.5",
        "nette/utils": "3.0",
        "nette/finder": "3.0"
      }
}</code></pre>
<p><br></p>
<p>or <strong>C</strong> that looks like sci-fi:</p>
<pre><code class="language-javascript">{
      "require": {
        "symfony/http-foundation": "3.3",
        "symfony/console": "3.3",
        "symfony/dependency-injection": "3.3",
        "symfony/event-dispatcher": "3.3",
        "doctrine/orm": "3.3",
        "doctrine/dbal": "3.3",
        "doctrine/annotations": "3.3",
        "nette/utils": "3.3",
        "nette/finder": "3.3"
      }
}</code></pre>
<p><br></p>
<h3 id="Advantages-of-Synced-Vendor-project-B">Advantages of Synced Vendor - project <em>B</em></h3>
<p>Single version for every <code>symfony/*</code> package gives me so much freedom:</p>
<ul>
<li>to update it, I just change 1 version and run <code>composer update</code></li>
<li>they work the best together - I don't have to check if <code>symfony/console</code> 3.3 is or isn't compatible with <code>event-dispatcher</code> 4.0</li>
<li>and <strong>I know when</strong> I can upgrade my application - <strong>the first week in december every 2 years</strong></li>
</ul>
<h3 id="Disadvantage-of-Per-Package-Versioning-project-A">Disadvantage of Per Package Versioning - project <em>A</em></h3>
<p>And what if every package has it's own destiny?</p>
<ul>
<li><strong>I'm stressed when</strong> any of my 20 <code>symfony/*</code> dependencies changes</li>
<li>I'm afraid that I will have to Google on Github, what version depend on which</li>
<li><strong>I can't plan any upgrades</strong>, because nobody knows the future</li>
</ul>
<h2 id="Call-Out-to-Package-Maintainers">Call Out to Package Maintainers</h2>
<p>All this is not related just to Symfony, Doctrine, Nette or any other big PHP players like Zend, Laravel, CakePHP or Yii.</p>
<p><strong>Every package, every dependency that has own versioning system means increased work PHP developers</strong>. That's stands if you agree with cycles or not. <strong>Version C</strong> being the easiest to upgrade and version <strong>A</strong> being the most difficult and also the most expensive.</p>
<p><strong>Do you want to add extra work</strong> to developer's back to study your vendor release system?</p>
<h3 id="Waiting-for-Tagging">Waiting for Tagging</h3>
<p>On the other hand a <em>package user</em>, I bet you recall at least one package you <strong>longed to be tagged, but were frustrated not knowing when</strong>. It's quite common that first 3 versions are tagged in within 1 year, but then followed by 1+ year long pause.</p>
<h2 id="Syncing-with-Symfony-and-quot-menstruation-and-quot-cycle">Syncing with Symfony &quot;menstruation&quot; cycle</h2>
<p>I like this synchronization, predictability, stability and maturation in our PHP ecosystem. That's why I'm trying to <strong>synchronize with Symfony release cycles</strong>. As from huge to small, as from seasons of year to menstruation, as from PHP to Symfony,</p>
<p>I bet you didn't notice, but with <a href="https://github.com/Symplify">Symplify</a> I try to <strong>release major version to minor of Symfony</strong>. Version 2.0 was released on <a href="https://github.com/symplify/symplify/releases/tag/v2.0.0">July 6th 2017</a>, right after <a href="https://symfony.com/roadmap?version=3.3#checker">Symfony 3.3 release</a> in May.</p>
<p>Being predictable with BC breaks, support for older version and consistent with adding new version.</p>
<h3 id="No-Force-Just-Inspiration">No Force, Just Inspiration</h3>
<p>Do you maintain a package? What approach do you have on predictability of releases and why? Please, let me know in comments. I always love to hear new ideas.</p>
<p><br></p>
<p>Happy syncing!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/10/30/what-can-you-learn-from-menstruation-and-symfony-releases</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 30 Oct 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/10/30/what-can-you-learn-from-menstruation-and-symfony-releases#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ IMbox Zero ]]></title>
                <link>https://tomasvotruba.com/blog/2017/10/23/imbox-zero</link>
                <description><![CDATA[ <p>You have probably heard about Inbox Zero. <a href="https://zenhabits.net/zen-to-done-ztd-the-ultimate-simple-productivity-system">ZTD</a> technique, <strong>to keep your email inbox clean and your brain well rested</strong>.
<br><br>
Let's take it a step further into 2017 - <strong>to instant messaging</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>My huge inspiration <a href="https://zenhabits.net">Leo Babauta</a> has <a href="https://zenhabits.net/email-zen-clear-out-your-inbox">popularized</a> Inbox Zero <a href="https://zenhabits.net/email-sanity">concept</a> of <strong>having 0 emails after every visit of your inbox</strong>.</p>
<p>All emails are resolved, postponed (will return in 5 days) or archived:</p>
<img src="/assets/images/posts/2017/imbox-zero/inbox.png" class="img-thumbnail">
<p><strong>The less noise you let to your brain, the better and <a href="/blog/2017/09/25/3-non-it-books-that-help-you-to-become-better-programmer/#deep-work-by-cal-newport">deeper your can focus</a> on single task</strong>.</p>
<p><br></p>
<p>The state you try to avoid is called <em>cognitive overflow</em>:</p>
<img src="/assets/images/posts/2017/imbox-zero/full-inbox.jpg" class="img-thumbnail">
<p>This applies to email.</p>
<h2 id="What-is-Zero-IM-box-then">What is Zero IM-box then?</h2>
<p>Ever since smartphones went viral, it is common to have <strong>7 SMS on single display. 1 new, 6 already resolved</strong>.
That would be ok, if you're used to full inbox, where your brain is programmed to filter the noise. <strong>But not if you're appling inbox zero method</strong>.</p>
<p>That is my case too and <strong>I was tired of having 2 contradictive approaches</strong> in my brain.</p>
<p><br></p>
<p><strong>So I've tried to archive all messages.</strong></p>
<img src="/assets/images/posts/2017/imbox-zero/sms.png" class="img-thumbnail col-md-4">
<p>And it works like a charm. My ability to response sms rise and blood pressure from switching visual modes decreases :)</p>
<h2 id="Give-Your-Brain-a-Comfort-Spa">Give Your Brain a Comfort Spa</h2>
<p>Now it's much easier for me to:</p>
<ul>
<li><strong>remember what to resolve</strong></li>
<li><strong>know who to response</strong></li>
<li>approach sms just few times a day <strong>in chunks</strong> - just like in Google Inbox</li>
<li>and resolve messages <strong>more quickly</strong></li>
</ul>
<p>And you don't have to stop at SMS. I talk about smartphones, remember?</p>
<p><br></p>
<p><strong><a href="https://messenger.com">Messenger</a></strong></p>
<img src="/assets/images/posts/2017/imbox-zero/messenger.png" class="img-thumbnail">
<p><br></p>
<p><strong>WhatsApp</strong></p>
<img src="/assets/images/posts/2017/imbox-zero/whatsapp.png" class="img-thumbnail col-md-4">
<p><br></p>
<p><strong>Hangouts</strong></p>
<img src="/assets/images/posts/2017/imbox-zero/hangouts.png" class="img-thumbnail col-md-4">
<p>Same rules applied, same profit got ;)</p>
<p><br></p>
<h2 id="Gain-for-Brains">Gain for Brains</h2>
<p>Once I've read <a href="https://en.wikipedia.org/wiki/The_Universe_in_a_Nutshell">The Universe in a Nutshell</a> by this guy Stephen Hawking in my before-teenage days. I still remember single quote from it:</p>
<blockquote class="blockquote">
    "Think in structures."
</blockquote>
<img src="/assets/images/posts/2017/imbox-zero/universe.jpg" class="img-thumbnail">
<p>I didn't know what that means, but my dad talked nicely about Steve, so I though he might be a smart guy - so tried to. In our use case, <strong>instead of having 2 algorithms to resolve incoming message, we will have 1</strong>. Thus having more neurons to do job we need them to do thanks to neuroplasticity.</p>
<p>Like finding a good coffee anywhere you are :)</p>
<p><br></p>
<p>Happy thinking!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/10/23/imbox-zero</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 23 Oct 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/10/23/imbox-zero#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to use Repository with Doctrine as Service in Symfony ]]></title>
                <link>https://tomasvotruba.com/blog/2017/10/16/how-to-use-repository-with-doctrine-as-service-in-symfony</link>
                <description><![CDATA[ <p>Dependency injection with autowiring is super easy <a href="/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3/">since Symfony 3.3</a>. Yet on my mentoring I still meet service locators.
<br><br>
Mostly due to traditional registration of Doctrine repositories.
<br><br>
The way out from <em>service locators</em> to <em>repository as service</em> was <a href="https://matthiasnoback.nl/2014/05/inject-a-repository-instead-of-an-entity-manager">described</a> by many <a href="https://medium.com/@adamquaile/composition-over-inheritance-in-doctrine-repositories-f6a53a026f60">before</a> and <strong>now we put it into Symfony 3.3 context</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>This post is follow up to <a href="https://stackoverflow.com/questions/38346281/symfony-3-outsourcing-controller-code-into-service-layer/38349271#38349271">StackOverflow answer</a> to clarify key points and show the sweetest version yet.</p>
<p>The person who kicked me to do this post was <a href="http://www.ucinnejsiweb.cz">Václav Keberdle</a> - <em>thank you for that</em>.</p>
<h2 id="Clean-Reusable-Independent-and-SOLID-Goal">Clean, Reusable, Independent and SOLID Goal</h2>
<p>Our goal is to have clean code using <em>constructor injection</em>, <em>composition over inheritance</em> and <em>dependency inversion principles</em>.</p>
<p>With as simple registration as:</p>
<pre><code class="language-php">// app/config/services.php
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();

    $services-&gt;defaults()
        -&gt;autowire();

    $services-&gt;load('App\\Repository\\', __DIR__ . '/../src/Repository');
};</code></pre>
<p>Nothing more, nothing less. Today, we'll try to get there.</p>
<h2 id="How-do-we-Register-Repositories-Now">How do we Register Repositories Now?</h2>
<h3 id="1-Entity-Repository">1. Entity Repository</h3>
<pre><code class="language-php">namespace App\Repository;

use App\Entity\Post;
use Doctrine\ORM\EntityRepository;

final class PostRepository extends EntityRepository
{
    /**
     * Our custom method
     * @return Post[]
     */
    public function findPostsByAuthor(int $authorId): array
    {
        return $this-&gt;findBy([
            'author' =&gt; $authorId
        ]);
    }
}</code></pre>
<h3 id="Advantages">Advantages</h3>
<ul>
<li>It's easy and everybody does that ✅</li>
<li>You can use prepared methods like <a href="https://github.com/doctrine/doctrine2/blob/2.5/lib/Doctrine/ORM/EntityRepository.php#L177"><code>findBy()</code></a>, <a href="https://github.com/doctrine/doctrine2/blob/2.5/lib/Doctrine/ORM/EntityRepository.php#L192"><code>findOneBy()</code></a> right away ✅</li>
</ul>
<h3 id="Disadvantages">Disadvantages</h3>
<ul>
<li>What if we try to register repository as a service? ❌</li>
</ul>
<img src="/assets/images/posts/2017/repository-as-service/autowire-fail.png" class="img-thumbnail mb-4">
<ul>
<li>
<p>Why? Because parent constructor of <code>Doctrine\ORM\EntityRepository</code> is <a href="https://github.com/doctrine/doctrine2/blob/2.5/lib/Doctrine/ORM/EntityRepository.php#L64">missing <code>EntityManager</code> typehint</a> (this is fixed in doctrine/orm 2.7+)</p>
</li>
<li>
<p><strong>We can't get another dependency</strong>, because parent constructor <a href="https://github.com/doctrine/doctrine2/blob/2.5/lib/Doctrine/ORM/EntityRepository.php#L64">requires <code>EntityManager</code> and <code>ClassMetadata</code> instances</a> ❌</p>
</li>
</ul>
<pre><code class="language-php">namespace App\Repository;

use App\Sorter\PostSorter;
use Doctrine\ORM\EntityRepository;

final class PostRepository extends EntityRepository
{
    public function __construct(PostSorter $postSorter)
    {
        $this-&gt;postSorter = $postSorter;
    }
}</code></pre>
<ul>
<li>Prepared methods like <code>findBy()</code> <strong>don't have param and return type declarations</strong> ❌</li>
</ul>
<pre><code class="language-php">// param should be "int", but whatever passes
$this-&gt;postRepository-&gt;find('someString');</code></pre>
<ul>
<li>We don't know what object we get back ❌</li>
</ul>
<pre><code class="language-php">$post = $this-&gt;postRepository-&gt;find(1);
// some object?
$post-&gt;whatMethods()!</code></pre>
<p><br></p>
<h3 id="2-Entity">2. Entity</h3>
<pre><code class="language-php">namespace App\Entity;

use Doctrine\ORM\Entity;
use Doctrine\ORM\EntityRepository;

/**
 * @Entity(repositoryClass="App\Repository\PostRepository")
 */
final class Post
{
    ...
}</code></pre>
<p>This is a code smell of circular dependency. Why should entity know about its repository?</p>
<h3 id="Static-Service-Locator-Code-Smell">Static Service Locator Code Smell</h3>
<p>Do you know why we need <code>repositoryClass="PostRepository"</code>? <strong>It's form of static service locator</strong> inside Doctrine:</p>
<pre><code class="language-php">$this-&gt;entityManager-&gt;getRepository(Post::class);</code></pre>
<p>It basically works like this:</p>
<ul>
<li>Find <code>Post</code> entity</li>
<li>Find repository in <code>@Entity</code> annotation</li>
<li><a href="https://github.com/doctrine/doctrine2/blob/2.5/lib/Doctrine/ORM/Repository/DefaultRepositoryFactory.php#L61">Creates repository</a></li>
</ul>
<p>Instead of <strong>registration to Symfony container like any other service, here is uses logic coupled to annotation of specific class</strong>. Just a reminder: <a href="https://www.google.cz/search?q=occams+razor&amp;oq=occams+razor&amp;aqs=chrome..69i57j0l5.2630j0j7&amp;sourceid=chrome&amp;ie=UTF-8">Occam's razor</a>.</p>
<p><br></p>
<h3 id="Advantages">Advantages</h3>
<ul>
<li>It's in documentation ✅</li>
</ul>
<h3 id="Disadvantages">Disadvantages</h3>
<ul>
<li>
<p>What if I want to have <code>PostRedisRepository</code> for Redis-related operations and <code>PostFrontRepository</code> for reading-only? It is <strong>not possible to have more repositories</strong> for one entity ❌</p>
</li>
<li>
<p>Would you have one Controller for every operation related to <code>Product</code> entity?</p>
</li>
<li>
<p><strong>We're losing all features</strong> of our framework's Dependency Injection container (events, autowiring, automated registration, logging etc.). ❌</p>
</li>
</ul>
<p><br></p>
<h3 id="3-Use-in-Controller">3. Use in Controller</h3>
<p>You have to use this <a href="https://matthiasnoback.nl/2014/05/inject-a-repository-instead-of-an-entity-manager/#factory-service">complicated service registration in YAML</a>:</p>
<pre><code class="language-php">// app/config/services.php
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use function Symfony\Component\DependencyInjection\Loader\Configurator\service;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();

    $services-&gt;defaults()
        -&gt;autowire();

    $services-&gt;set('app.post_repository', \Doctrine\ORM\EntityRepository::class)
        -&gt;factory([service('@doctrine.orm.default_entity_manager'), 'getRepository'])
        -&gt;args(['App\Entity\Post']);
};</code></pre>
<p>...or just pass <code>EntityManager</code>.</p>
<pre><code class="language-php">namespace App\Controller;

use App\Entity\Post;
use App\Repository\PostRepository;
use Doctrine\ORM\EntityManagerInterface;

final class PostController
{
    private PostRepository $postRepository;

    public function __construct(EntityManagerInterface $entityManager)
    {
        $this-&gt;postRepository = $entityManager-&gt;getRepository(Post::class);
    }
}</code></pre>
<h3 id="Advantages">Advantages</h3>
<ul>
<li>Again, status quo = that's how Doctrine and Symfony Documentation promotes it ✅</li>
</ul>
<h3 id="Disadvantages">Disadvantages</h3>
<ul>
<li>
<p>IDE doesn't know it's <code>App\Repository\PostRepository</code>, so <strong>we have add extra typehint for every single method</strong> ❌</p>
</li>
<li>
<p>Example above would work because there is typehinted property, but these would fail ❌</p>
</li>
</ul>
<pre><code class="language-php">$postRepository = $entityManager-&gt;getRepository(Post::class);
// object?
$postRepository-&gt;...?;

$post = $this-&gt;postRepository-&gt;find(1);
// object?
$post-&gt;...?;</code></pre>
<ul>
<li>To enable autocomplete, we have to add them manually ❌</li>
</ul>
<pre><code class="language-php">/** @var App\Entity\Post $post */
$post = $this-&gt;postRepository-&gt;find(1);
$post-&gt;getName();</code></pre>
<p><br></p>
<h2 id="Advantages-Summary">Advantages Summary</h2>
<ul>
<li>It's easy to copy-paste if already present in our code ✅</li>
<li>It's spread in most of documentation, both in Doctrine and Symfony and in many posts about Doctrine ✅</li>
<li>No brain, no gain ✅</li>
</ul>
<h2 id="Disadvantages-Summary">Disadvantages Summary</h2>
<ul>
<li>We <strong>cannot use autowiring</strong> ❌</li>
<li>We <strong>cannot inject repository to other service just via constructor</strong> ❌</li>
<li>We have to <strong>typehint manually</strong> everything (IDE Plugins put aside) ❌</li>
<li><strong>We have Doctrine in our Controller</strong> - Controller should only delegate to model, without knowing what Database package is used. ❌</li>
<li>To allow constructor injection, we have to prepare for much <em>config programming</em> ❌</li>
<li>Thus <strong>it's coupled to the framework you use and less reusable</strong> ❌</li>
<li>We cannot use multiple repository for single entity. <strong>It naturally leads to huge repositories</strong> ❌</li>
<li>We cannot use constructor injection in repositories, which <strong>can easily lead you to creating static helper classes</strong> ❌</li>
<li>Also, you directly depend on Doctrine's or Symfony's API, so if <code>find()</code> changes to <code>get()</code> in one <code>composer update</code>, your app is down ❌</li>
</ul>
<h2 id="How-to-make-this-Better-with-Symfony-3-3-and-Composition">How to make this Better with Symfony 3.3+ and Composition?</h2>
<p>It require few steps, but <strong>all builds on single one change</strong>. Have you heard about <em>composition over inheritance</em>?</p>
<pre><code class="language-diff"> namespace App\Repository;

 use App\Entity\Post;
+use Doctrine\ORM\EntityManagerInterface;
 use Doctrine\ORM\EntityRepository;

-final class PostRepository extends EntityRepository
+final class PostRepository
 {
+    private EntityRepository $repository;
+
+    public function __construct(EntityManagerInterface $entityManager)
+    {
+        $this-&gt;repository = $entityManager-&gt;getRepository(Post::class);
+    }
 }</code></pre>
<p><strong>Update entity that is now independent</strong> on specific repository:</p>
<pre><code class="language-diff"> &lt;?php declare(strict_types=1);

 namespace App\Entity;

 use Doctrine\ORM\Entity;

 /**
- * @Entity(repositoryClass="App\Repository\PostRepository")
+ * @Entity
  */
 final class Post
 {
     ...
 }</code></pre>
<p>Without this, you'd get a segfault error due to circular reference.</p>
<p>That's all! Now you can program the way <em>which is used in the rest of your application</em>:</p>
<ul>
<li><em>class</em>,</li>
<li><em>service</em></li>
<li>and <em>constructor injection</em></li>
</ul>
<p><strong>And how it influenced our 4 steps?</strong></p>
<p><br></p>
<h3 id="1-Entity-Repository">1. Entity Repository</h3>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace App\Repository;

use App\Entity\Post;
use App\Sorter\PostSorter;
use Doctrine\ORM\EntityManagerInterface;
use Doctrine\ORM\EntityRepository;

final class PostRepository
{
    private EntityRepository $repository;

    private PostSorter $postSorter;

    public function __construct(EntityManagerInterface $entityManager, PostSorter $postSorter)
    {
        $this-&gt;repository = $entityManager-&gt;getRepository(Post::class);
        $this-&gt;postSorter = $postSorter;
    }

    public function find(int $id): ?Post
    {
        return $this-&gt;repository-&gt;find($id);
    }
}</code></pre>
<h3 id="Advantages">Advantages</h3>
<ul>
<li>Everything is <strong>strictly typehinted</strong>, <strong>no more frustration from missing autocompletion</strong> ✅</li>
<li><strong>Constructor injection works</strong> like you expect it to ✅</li>
<li>You can get another dependency if you like ✅</li>
</ul>
<p><br></p>
<h3 id="2-Entity">2. Entity</h3>
<pre><code class="language-php">namespace App\Entity;

use Doctrine\ORM\Entity;

/**
 * @Entity
 */
class Post
{
    ...
}</code></pre>
<h3 id="Advantages">Advantages</h3>
<ul>
<li>Clean and standalone object ✅</li>
<li>No service locators smells ✅</li>
<li><strong>Allows multiple repositories per entity</strong> ✅</li>
</ul>
<pre><code class="language-php">// app/config/services.php
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();

    $services-&gt;defaults()
        -&gt;autowire();

    $services-&gt;set(App\Repository\ProductRepository::class);
    $services-&gt;set(App\Repository\ProductRedisRepository::class);
    $services-&gt;set(App\Repository\ProductBenchmarkRepository::class);
};</code></pre>
<p><br></p>
<h3 id="3-Use-in-Controller">3. Use in Controller</h3>
<pre><code class="language-php">namespace App\Controller;

use App\Repository\PostRepository;

final class PostController
{
    private PostRepository $postRepository;

    public function __construct(PostRepository $postRepository)
    {
        $this-&gt;postRepository = $postRepository;
    }
}</code></pre>
<h3 id="Advantages">Advantages</h3>
<ul>
<li><strong>IDE knows</strong> the type and autocomplete 100% works ✅</li>
<li>PHPStan and Rector knows types too ✅</li>
<li>There is no sign of Doctrine, the code is cleanly decoupled ✅</li>
<li><strong>The code easier to maintain and extend, thanks to composition over inheritance</strong> ✅</li>
<li>The possibility to decouple to <a href="/blog/2017/02/07/how-to-decouple-monolith-like-a-boss-with-composer-local-packages/">local packages</a> is now opened ✅</li>
</ul>
<p><br></p>
<h3 id="4-Registration-services-php">4. Registration <code>services.php</code></h3>
<p>We have a new extra step - registration of services in application container:</p>
<pre><code class="language-php">// app/config/services.php
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();

    $services-&gt;defaults()
        -&gt;autowire();

    $services-&gt;load('App\\Repository\\', __DIR__ . '/../src/Repository');
};</code></pre>
<p><br></p>
<p>All we needed is to apply <strong>composition over inheritance</strong> pattern.</p>
<h2 id="Quality-Test-How-to-Add-new-Repository">Quality Test: How to Add new Repository?</h2>
<p>The main goal of all this was to make work with repositories typehinted, safe and reliable for you to use and easy to extend. <strong>It also minimized space for error</strong>, because <strong>strict types and constructor injection now validates</strong> much of your code for you.</p>
<p>The answer is now simple: <strong>just create repository in <code>App\Repository</code></strong>.</p>
<p>Try the same example with your current approach and let me know in the comments.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/10/16/how-to-use-repository-with-doctrine-as-service-in-symfony</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 16 Oct 2017 00:00:00 +0000</pubDate>
                                    <updated>2021-02-01UTC00:00:000</updated>
                    <atom:updated>Mon, 01 Feb 2021 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Mon, 01 Feb 2021 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/10/16/how-to-use-repository-with-doctrine-as-service-in-symfony#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Get the Most Valuable Feedback You Can Get ]]></title>
                <link>https://tomasvotruba.com/blog/2017/10/09/how-to-get-the-most-valuable-feedback-you-can-get</link>
                <description><![CDATA[ <p>Feedback is one of the best way to improve yourself. To make it really work it have to be able to get to you. &quot;That's wrong&quot; usually doesn't work as the person giving the feedback intended.
<br><br>
If the feedback is <strong>honest, understandable, from trustful person who knows your history and values</strong> it can make your mind shine for the brighter future with gratitude.
<br><br>
How to get such feedback?</p> ]]></description>
                <content:encoded><![CDATA[ <p><strong>We meet with feedback everyday</strong>. In work on how to improve your project, with your spouse on how to be emphatic or with your mentoring skills with your students.</p>
<p>Feedback is great! You can improve your weak points and make them stronger.</p>
<p><strong>The longer you know the person, the better feedback can get</strong> (and give). You know his or her weak points, traumas, know the language they understand and - the most important thing when it comes to learning - <strong>have a trust bond</strong>.</p>
<h2 id="How-Do-You-Know">How Do You Know?</h2>
<p>To take the best out of the feedback, we have to compare it - <em>before</em> and <em>after</em>.</p>
<p>Thing is, we can barely process present moment and reflecting the past isn't much better. Do you know who you were a month back? A year back?</p>
<p>And do you <em>know it</em> or do you <em>imagine it</em>?</p>
<p>How do you <em>know</em> you made a progress?</p>
<p>But more important, how can you <strong>really appreciate yourself</strong> for making it through.</p>
<h2 id="The-One-Person">The One Person</h2>
<p>Putting these question together, I get the best feedback when:</p>
<ul>
<li>I get it from the person, <strong>who knows me the longest</strong></li>
<li>I actually <strong>feel his or her feelings</strong> while giving the feedback</li>
</ul>
<p>Sounds like <em>futuristic empath</em> skills?</p>
<img src="/assets/images/posts/2017/futureme/empath.jpg" class="img-thumbnail">
<h2 id="Who-is-it">Who is it?</h2>
<p>Your spouse? Your sister or brother or your partners?</p>
<p>Almost there...</p>
<p><br></p>
<p>Actually everyone can do it themselves. <strong>You can do it right now.</strong></p>
<p><strong>YOU!</strong></p>
<h2 id="Talk-With-Your-Future-Self">Talk With Your Future Self</h2>
<p>This is what I do for past 10 years and I'm very happy to share this little hack with you.</p>
<p><strong>I write every 6 months (at least) with letter arrival a 1 year in the future</strong>. If I write today, the letter would arrive October 8th, 2018.</p>
<img src="/assets/images/posts/2017/futureme/past.png" class="img-thumbnail">
<h2 id="What-I-write-about">What I write about?</h2>
<p>Usually I describe the present moment:</p>
<ul>
<li>How is work doing?</li>
<li>How are my relations?</li>
<li>My girlfriend and family?</li>
<li>Where I live?</li>
<li>What I'm afraid off?</li>
<li>What I'm dealing with?</li>
<li><strong>What I want to be different in 1 year from now?</strong></li>
</ul>
<p>It can look like this:</p>
<img src="/assets/images/posts/2017/futureme/example.png" class="img-thumbnail">
<h2 id="What-I-Learned-from-this">What I Learned from this?</h2>
<ul>
<li>
<p><strong>That nothing is permanent.</strong> Nor success, nor joy, nor pain, nor ideas about the world I'm living in.</p>
</li>
<li>
<p>That when I feel something is impossible or difficult or the best way to do it, it <em>is</em> in the present I'm just in. Nothing more.</p>
</li>
<li>
<p><strong>That I change a lot from year to year</strong> (for good ;)), even though I don't move at all before writing these.</p>
</li>
</ul>
<h2 id="Try-It-Yourself">Try It Yourself</h2>
<p>I don't use any local postal service nor home made box for this.</p>
<p>There is <a href="https://www.futureme.org">futureme.org</a> for this:</p>
<img src="/assets/images/posts/2017/futureme/logo.png" class="img-thumbnail">
<p>You can start with one and if you'll like it, you can get more. That's what I did :)</p>
<h2 id="Inspire-at-Public-Letters">Inspire at Public Letters</h2>
<p>The other interesting thing you can do is read public letter by other people. There are some very moving honest confessions, like alcoholism or domestic violence, from both sides.</p>
<img src="/assets/images/posts/2017/futureme/public.png" class="img-thumbnail">
<p>Happy writing!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/10/09/how-to-get-the-most-valuable-feedback-you-can-get</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 09 Oct 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/10/09/how-to-get-the-most-valuable-feedback-you-can-get#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ EasyCodingStandard and PHPStan meet 3 Symfony E-Commerce Projects ]]></title>
                <link>https://tomasvotruba.com/blog/2017/10/02/easy-coding-standard-and-phpstan-meet-3-symfony-ecommerce-projects</link>
                <description><![CDATA[ <p><a href="/blog/2017/08/28/shopsys-spriker-and-sylius-under-static-analysis/">In the last post</a>, we looked at the static analysis of 3 Symfony E-Commerce projects.</p>
<p><strong>Lines of code, Duplicated code, Cyclomatic complexity or Method length</strong>. These metrics are very rarely used in practise (even though there is a <a href="https://github.com/symplify/symplify/blob/bf802422b9528946a8bd7e7f0331d858a9bf5740/easy-coding-standard.neon#L27-L28">sniff for that</a>).</p>
<p>Today, I am going to show you how you can check them with tools that can help you keep your code better on daily basis - <a href="https://github.com/symplify/easy-coding-standard">EasyCodingStandard</a> and <a href="https://github.com/phpstan/phpstan">PHPStan</a>.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Try-It-Yourself">Try It Yourself</h2>
<p>I've updated <a href="https://github.com/TomasVotruba/shopsys-spryker-and-sylius-analysis">the repository on Github</a> with both tools, so you can verify all the results in this post locally.</p>
<p><br></p>
<div class="col-6 mb-3">
    <a href="https://www.shopsys.com/">
        <img src="/assets/images/posts/2017/shopsys-static-anal/shopsys.png">
    </a>
</div>
<div class="col-5">
    <a href="http://sylius.org/">
        <img src="/assets/images/posts/2017/shopsys-static-anal/sylius.png">
    </a>
</div>
<div class="col-5">
    <a href="https://spryker.com/">
        <img src="/assets/images/posts/2017/shopsys-static-anal/spryker.png">
    </a>
</div>
<p><em>(Tip: logos lead to projects' landing pages. Be sure to explore.)</em></p>
<h2 id="Why-These-Tools">Why These Tools?</h2>
<p>When a project uses coding standards - moreover CI-checkers - it is very easy to contribute to it. <strong>I don't have to be afraid a PR gets rejected or at least postponed due to a wrong bracket position</strong> (yea, that happens).</p>
<p>Second, <a href="https://github.com/phpstan/phpstan">PHPStan</a> is the best tool when it comes to <strong>passing type validations</strong> (arrays of objects, like <code>Type[]</code>), <strong>incorrect namespaces</strong>, <strong>calling non-existing methods</strong> <a href="https://medium.com/@ondrejmirtes/phpstan-2939cd0ad0e3#b18f">and more</a>.</p>
<p>To get the idea how it improves your code in practice, just <a href="https://github.com/ApiGen/ApiGen/commit/9ab5d1f94e95ac91a6cf2d0edd1d0c384f6299d7">check this commit</a> in <a href="/blog/2017/09/04/how-apigen-survived-its-own-death/">ApiGen</a>.</p>
<h2 id="Coding-Style-Violations-with-EasyCodingStandard">Coding Style Violations with EasyCodingStandard</h2>
<h3 id="PSR2">PSR2</h3>
<p><strong>PSR-2 is the most spread coding standard in PHP</strong>, described in <a href="https://www.php-fig.org/psr/psr-2">PHP-FIG guide</a>. Both PHP_CodeSniffer and PHP CS Fixer have a set of ~30 rules, so why not to <a href="https://github.com/symplify/easy-coding-standard/blob/master/config/psr2.yml">combine them</a> and use them on our projects?</p>
<p><br></p>
<table class="table table-bordered table-responsive">
    <thead class="thead-inverse">
        <tr>
            <th>Shopsys</th>
            <th>Spryker</th>
            <th>Sylius</th>
        </tr>
    </thead>
    <tr>
        <td>0 errors</td>
        <td>9 723 errors</td>
        <td>133 errors</td>
    </tr>
</table>
<p><br></p>
<h3 id="What-Would-Be-the-Takeaways">What Would Be the Takeaways?</h3>
<p>If you’re used to PSR2 style, you probably use PHPStorm to check it and <strong>contributing to Sylius would mean no extra work for you</strong>. <a href="https://github.com/Sylius/Sylius/blob/b5f6a4e4383fcbf5b1b9730094d1e1aa756de7a2/etc/phpcs/.php_cs">Sylius' ruleset</a> contains just handful of checkers though.</p>
<p>Spryker has <a href="https://github.com/spryker/code-sniffer">own package just for coding-standard</a> build on PHP_CodeSnifer, but they don't comply with some rules of PHP CS Fixer. <strong>This might be issue if you're in the Symfony world</strong> and you use that tool in your projects.</p>
<p>Shopsys <strong>has its own <a href="https://github.com/shopsys/coding-standards">coding-standard package</a> build on both tools</strong> - PHP CS Fixer and PHP_CodeSniffer - compatible with PSR-2. I'd say that's the best solution, because you have <strong>the least responsibility as a contributor</strong>. CI tools will handle the code style for you.</p>
<h2 id="The-Four-Cleaners">The Four Cleaners</h2>
<p>This is another <a href="/blog/2017/09/18/4-simple-checkers-for-coding-standard-haters-but-clean-code-lovers/">small and easy-to-understand set</a> I use to keep the code of open-source packages clean. In Sylius <a href="https://github.com/Sylius/Sylius/pull/8557">it removed 500 lines of unused code</a> just few days ago as of writing this article.</p>
<p>The full set looks like this:</p>
<pre><code class="language-php">use PhpCsFixer\Fixer\ArrayNotation\ArraySyntaxFixer;
use PhpCsFixer\Fixer\Import\NoUnusedImportsFixer;
use PhpCsFixer\Fixer\Import\OrderedImportsFixer;
use SlevomatCodingStandard\Sniffs\Classes\UnusedPrivateElementsSniff;
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();

    // use short array []
    $services-&gt;set(ArraySyntaxFixer::class)
        -&gt;call('configure', [['syntax' =&gt; 'short']]);

    // drop dead code
    $services-&gt;set(UnusedPrivateElementsSniff::class);

    // drop dead use namespaces
    $services-&gt;set(NoUnusedImportsFixer::class);

    // and sort them A → Z
    $services-&gt;set(OrderedImportsFixer::class);
};</code></pre>
<p><br></p>
<p>And results for our 3 projects?</p>
<p><br></p>
<table class="table table-bordered table-responsive">
    <thead class="thead-inverse">
        <tr>
            <th>Shopsys</th>
            <th>Spryker</th>
            <th>Sylius</th>
        </tr>
    </thead>
    <tr>
        <td>39 errors</td>
        <td>97 errors</td>
        <td>7 errors</td>
    </tr>
</table>
<p><br></p>
<h2 id="Code-Violations-with-PHPStan">Code Violations with PHPStan</h2>
<p><strong>There are 8 levels in PHPStan to this day</strong> - from 0 to 7. Level 0 being <em>the starter</em> and 7 <em>the Mission Impossible</em> for most projects.</p>
<p>If you never used this tools before, <strong>you probably don’t know how strict PHPStan is</strong>.
Doctrine2 has now level 1 and successfully passes it, thanks to <a href="https://github.com/Majkl578">Majkl578</a>. In order to get the idea of what had to be done, <a href="https://github.com/doctrine/doctrine2/pull/6535/files">see the PR</a>.</p>
<p>Do you want to add PHPStan to your project? <a href="/blog/2017/01/28/why-I-switched-scrutinizer-for-phpstan-and-you-should-too/">Read this short intro</a>.</p>
<div class="text-center">
    <img src="/assets/images/posts/2017/shopsys-static-anal-2/phpstan.png" class="img-thumbnail">
</div>
<p><br></p>
<p>To have an idea about real numbers, <strong>I picked results for lvl 0 and lvl 7</strong>:</p>
<p><br></p>
<table class="table table-bordered table-responsive table-striped">
    <tr>
        <thead class="thead-inverse">
            <th>PHPStan levels \ Projects</th>
            <th>Shopsys</th>
            <th>Spryker</th>
            <th>Sylius</th>
        </thead>
    </tr>
    <tr>
        <th>0
        </th><td>1 406 errors</td>
        <td>7 905 errors</td>
        <td>1 404 errors</td>
    </tr>
    <tr>
        <th>7
        </th><td>1 413 errors</td>
        <td>12 977 errors</td>
        <td>3 715 errors</td>
    </tr>
</table>
<p><br></p>
<p>As you can see, both <strong>Shopsys and Sylius are doing great</strong>. Sylius is just falling bit behind in higher levels.</p>
<p>As we have seen in <a href="/blog/2017/08/28/shopsys-spriker-and-sylius-under-static-analysis/">the previous article</a>, <strong>not all the projects are of the same size</strong>. It might not be fair to Spryker to count only PHPStan violations as its codebase is considerably larger. <strong>If we count violations relative to the size of the project</strong> (measured in lines of code) the graph changes significantly:</p>
<p><br></p>
<div class="text-center">
    <img src="/assets/images/posts/2017/shopsys-static-anal-2/phpstan-relative.png" class="img-thumbnail">
</div>
<p><br></p>
<p><strong>Results for lvl 0 and lvl 7</strong>:</p>
<p><br></p>
<table class="table table-bordered table-responsive table-striped">
    <tr>
        <thead class="thead-inverse">
            <th>Relative to LOC</th>
            <th>Shopsys</th>
            <th>Spryker</th>
            <th>Sylius</th>
        </thead>
    </tr>
    <tr>
        <th>0
        </th><td>0.014</td>
        <td>0.021</td>
        <td>0.012</td>
    </tr>
    <tr>
        <th>7
        </th><td>0.014</td>
        <td>0.035</td>
        <td>0.033</td>
    </tr>
</table>
<p><br></p>
<p>This point of view shows that, on the less strict levels of analysis, <strong>Sylius and Shopsys are ahead of Spryker in terms of PHPStan violations</strong>. During the second level of analysis this changes and number of problems found notably rises, only <strong>Shopsys stands out</strong> with less than a half of the issues of both other frameworks. This trend does not change even while moving to the higher levels of scrutiny from mr. PHPStan.</p>
<p>Shopsys has long way to passing level 7 with 0 errors, but it has still <a href="https://blog.shopsys.com/we-have-started-with-our-regular-releases-public-beta-coming-soon-c1f879657bd4">some time till the release</a> to improve this.</p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/10/02/easy-coding-standard-and-phpstan-meet-3-symfony-ecommerce-projects</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 02 Oct 2017 00:00:00 +0000</pubDate>
                                    <updated>2018-12-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Dec 2018 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Dec 2018 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/10/02/easy-coding-standard-and-phpstan-meet-3-symfony-ecommerce-projects#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 3 non-IT Books That Help you to Become Better Programmer ]]></title>
                <link>https://tomasvotruba.com/blog/2017/09/25/3-non-it-books-that-help-you-to-become-better-programmer</link>
                <description><![CDATA[ <p>I love reading books. It helps me to create much deeper and persistent neural connections than any other form of self-education.
<br><br>
These books accidentally help me to <strong>write more readable code, create understandable and smart architecture</strong> or <strong>manage open-source in more polite and leading way</strong>.
<br><br>
Are you tired of reading technical books? Take a rest with these 3.</p> ]]></description>
                <content:encoded><![CDATA[ <p>(Ordered from the shortest to the longest, in both reading time and personal change.)</p>
<p><br></p>
<blockquote class="blockquote text-center">
    "<a href="http://notes.torrez.org/2011/04/an-empathetic-plan.html">
    Complain about the way other people make software<br>
    by making software.</a>"

    <footer class="blockquote-footer text-right">
        Antoine de Saint-Exupery
    </footer>
</blockquote>
<p><br></p>
<h2 id="Steal-Like-and-Artist-by-Austing-Kleon">Steal Like and Artist by Austing Kleon</h2>
<p>Evolution of art is based on stealing. So is software. <strong>Pattern are replicated through languages and frameworks</strong>. Just imagine how many frameworks are using MVC pattern.</p>
<div class="text-center">
    <img src="/assets/images/posts/2017/non-it-books/steal.jpg" class="img-thumbnail">
</div>
<p>Instead of describing ideas in this master piece, <strong>just <a href="https://www.youtube.com/watch?v=oww7oB9rjgw">see this 11min TedX video</a></strong>. Then you can decide if you like this idea just enough to open first page.</p>
<p>I'd like to thank <a href="http://honzacerny.com">Honza Černý</a> who lend me this book about a year ago and helped me to <strong>build bridge between programming and art</strong>.</p>
<p>Btw, if you read this short book, there also <em>second</em> part: <a href="https://austinkleon.com/show-your-work">Show Your Work</a>.</p>
<h2 id="Deep-Work-by-Cal-Newport">Deep Work by Cal Newport</h2>
<h3 id="Isn-t-it-only-Hype">Isn't it only Hype?</h3>
<p>I heard about this book from <a href="https://tomaskazatel.cz">many</a> <a href="https://www.vzhurudolu.cz/blog/75-hluboka-prace">friends</a> (Czech only) just in the end of 2016. So many at once, that <strong>I was afraid of buy-but-not-read-hype</strong>. That's when <strong>everyone is talking about the book, buying it, but nobody actually read it</strong>.</p>
<p>Like <a href="https://www.amazon.com/Clean-Code-Handbook-Software-Craftsmanship/dp/0132350882"><em>Clean Code</em></a>. It's really great book - well it was the best you could buy in 2008. But now it's obsolete, too verbose, not to the point and difficult to understand by anyone else than Java programmers.</p>
<p>What can you do better?  <strong>You could reach for 80 % shorter and PHP-related <a href="https://leanpub.com/principles-of-package-design">Principles of Package Design</a></strong> or go to fresh <a href="https://github.com/jupeter/clean-code-php"><em>clean-code</em> repository on Github</a> single page <strong>PHP yes/no examples-based</strong> which has over <strong>3625 stars</strong> as of time writing this post. I help to maintain it, but main credits goes to <a href="https://github.com/jupeter">@jupeter</a>.</p>
<img src="/assets/images/posts/2017/non-it-books/deep.jpg" class="img-thumbnail">
<p>Imagine peace with combination of 5hour train trips, <a href="/blog/2017/01/20/4-emotional-reasons-why-I-quit-my-twitter/">disabling twitter</a> and other <a href="/blog/2017/01/05/why-I-deleted-my-linkedin-account/">social networks</a> on your mobile and computer and <a href="https://zenhabits.net/unline">cutting of Facebook</a> activity, it is powerful skill-set that will <strong>give you head start before any concurrency you have</strong>.</p>
<p>Again, instead of few bullet points that <strong>got my</strong> opinionated attention, check <a href="https://www.youtube.com/watch?v=3E7hkPZ-HTk">this 13min youtube video</a>.</p>
<h3 id="Protip-Skip-the-first-third">Protip - Skip the first third</h3>
<p>The book will then drag you into the stories about 1st class plane trips that produce books over weekend.</p>
<p>Thanks to <a href="https://tomaskazatel.cz">Tomáš Kazatel</a> for lending me and <em>selling</em> me this book with this tip.</p>
<h2 id="No-More-Mr-Nice-Guy-by-Dr-Robert-A-Glover">No More Mr. Nice Guy by Dr. Robert A. Glover</h2>
<p>This book is more transformative then 2 before. It's related to family system, partners, about <strong>money you feel you deserve in your job</strong> or about your.</p>
<p>I see many nice-guys among programmers, un-happy with their work, payment, skill level or they spouse and children, thank to <a href="https://pehapkari.cz">organizing PHP meetups</a> in Czech Republic. I could relate to them with <a href="https://www.youtube.com/watch?v=GFu5ONiHnMA">my own experience</a> (Czech only).</p>
<img src="/assets/images/posts/2017/non-it-books/nice.jpg" class="img-thumbnail">
<p>This book helped my to take over responsibility for things I'm un-happy with and take the first step to unknown future hidden in fog. Pain worth it!</p>
<p>Here, I'm not aware of any useful youtube video, so <strong>I recommend to start with first chapter and then continue or stop</strong> based on your preferences.</p>
<p>Thanks to all my women and Jakub Lipus for recommendation.</p>
<hr />
<p>And the last take away? <strong>If you want to read some book, let somebody recommend it to you</strong>. Your friend probably know you better then you know the book by the cover :)</p>
<p>Happy reading!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/09/25/3-non-it-books-that-help-you-to-become-better-programmer</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 25 Sep 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/09/25/3-non-it-books-that-help-you-to-become-better-programmer#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 4 Simple Checkers for Coding Standard Haters but Clean Code Lovers ]]></title>
                <link>https://tomasvotruba.com/blog/2017/09/18/4-simple-checkers-for-coding-standard-haters-but-clean-code-lovers</link>
                <description><![CDATA[ <p>Do you find coding standards too <strong>annoying in telling you where to put that bracket</strong>?
Is that the reason you haven't tried them yet?
<br><br>
Great! This post is for you. There are <a href="/blog/2017/07/31/how-php-coding-standard-tools-actually-work/#write-1-checke-save-hundreds-hours-of-work">other ways to use coding standard</a> and <strong>clean code</strong> is one of them.</p> ]]></description>
                <content:encoded><![CDATA[ <p>There are some checkers in coding standard world, that don't check spaces, tabs, commas nor brackets. They <strong>actually do code-review for you</strong>.</p>
<p>I use a set of 4 checkers to <strong>check open-source packages to help them keeping their code clean</strong>.</p>
<p>In Sylius they <a href="https://github.com/Sylius/Sylius/pull/8557">removed 500 lines of unused code</a> just few days ago.</p>
<p>Among others it <strong>removed dead constructor dependencies</strong>.</p>
<img src="/assets/images/posts/2017/clean-checkers/dependency-drop.png" class="img-thumbnail">
<p>It will not only make your code cleaner, but also can <strong>speed up you container build</strong> as a side effect.</p>
<h2 id="4-Simple-Checkers">4 Simple Checkers</h2>
<pre><code class="language-php">use PhpCsFixer\Fixer\ArrayNotation\ArraySyntaxFixer;
use PhpCsFixer\Fixer\Import\NoUnusedImportsFixer;
use PhpCsFixer\Fixer\Import\OrderedImportsFixer;
use SlevomatCodingStandard\Sniffs\Classes\UnusedPrivateElementsSniff;
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();

    // use short array []
    $services-&gt;set(ArraySyntaxFixer::class)
        -&gt;call('configure', [['syntax' =&gt; 'short']]);

    // drop dead code
    $services-&gt;set(UnusedPrivateElementsSniff::class);

    // drop dead use namespaces
    $services-&gt;set(NoUnusedImportsFixer::class);

    // and sort them A → Z
    $services-&gt;set(OrderedImportsFixer::class);
};</code></pre>
<h2 id="4-Steps-to-Make-Your-Code-Cleaner">4 Steps to Make Your Code Cleaner</h2>
<ol>
<li>
<p>Install it</p>
<pre><code class="language-bash">composer require symplify/easy-coding-standard --dev</code></pre>
</li>
<li>
<p>Add checkers to <code>ecs.php</code> file</p>
</li>
<li>
<p>Check your code</p>
<pre><code class="language-bash">vendor/bin/ecs check src</code></pre>
</li>
<li>
<p>Fix the code</p>
<pre><code class="language-bash">vendor/bin/ecs check src --fix</code></pre>
</li>
</ol>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/09/18/4-simple-checkers-for-coding-standard-haters-but-clean-code-lovers</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 18 Sep 2017 00:00:00 +0000</pubDate>
                                    <updated>2020-08-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Aug 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Aug 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/09/18/4-simple-checkers-for-coding-standard-haters-but-clean-code-lovers#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to write Open-Source in PHP 3: Deprecating Code ]]></title>
                <link>https://tomasvotruba.com/blog/2017/09/11/how-to-write-open-source-in-php-3-deprecating-code</link>
                <description><![CDATA[ <p>Humans, world and PHP Frameworks constantly evolve - their code functionality changes. Class or method is renamed, method has 1 new argument or new class is decoupled.
<br><br>
In Symfony world you probably know about <a href="https://symfony.com/doc/current/contributing/code/bc.html">Backward Compatibility Promise</a>.
It <strong>prevents from unexpected and frustrating BC breaks</strong> and helps users to upgrade gradually thanks to deprecation messages.
<br><br>
In this post I will show you <strong>how to work with deprecation messages</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>This technique is quite rare to see (apart PHP frameworks). It's very simple to add to your open-source code workflow though - let me convince you.</p>
<h2 id="Why-Write-Deprecation-Messages">Why Write Deprecation Messages?</h2>
<h3 id="If-you-DON-T">If you DON'T</h3>
<ul>
<li>people will have to find deprecations themselves in the commits - <strong>from programmer to detective</strong></li>
<li>you'll <strong>find issues</strong> like &quot;autowire() method missing - what should I do?&quot; at your package on Github</li>
<li>you'll have to remember, when you upgrade some project using your package few months later</li>
</ul>
<h3 id="If-you-DO">If you DO</h3>
<ul>
<li>people will like you</li>
<li>you'll be able to do more BC breaks in your code, because people will know they're taken care off</li>
<li><strong>upgrade of your package will be much easier</strong></li>
<li><strong>machine-readable messages will allow automate upgrades</strong></li>
</ul>
<p>To explain last point a bit more: if you write your message in a way, that some parser would be able to understand it, <strong>it would be able to refactor other code accordingly</strong>.</p>
<ol>
<li>
<p>Read</p>
<pre><code class="language-bash">SomeClass::oldMethod =&gt; SomeClass::newMethod</code></pre>
</li>
<li>
<p>Run</p>
<pre><code class="language-bash">bin/refactor app src</code></pre>
</li>
<li>
<p>Enjoy new code!</p>
</li>
</ol>
<p>That was <a href="https://github.com/tomasvotruba/Rector">the future</a>, now back to the present.</p>
<h2 id="Today-s-topic-Changed-Method-Name">Today's topic: Changed Method Name</h2>
<p>Let's take real example from real code - a class from <a href="https://doc.nette.org/en/2.4/html-elements#toc-elements-content"><code>Nette\Utils</code> 2.4</a>.</p>
<p>What we need to know?</p>
<ul>
<li><strong>a method name has changed</strong></li>
<li>from &quot;add&quot; to &quot;addHtml&quot;</li>
<li>on <code>Nette\Utils\Html</code> object</li>
</ul>
<p><strong>Before</strong> this change you used:</p>
<pre><code class="language-php">$html = Html::el('div');
$html-&gt;add('&lt;strong&gt;I am brand new!&lt;/strong&gt;');</code></pre>
<p>And <strong>after</strong> this change you will use:</p>
<pre><code class="language-php">$html = Html::el('div');
$html-&gt;addHtml('&lt;strong&gt;I am brand new!&lt;/strong&gt;');</code></pre>
<p>This is the snippet from the <code>Nette\Util\Html</code> class we are interested in:</p>
<pre><code class="language-php">namespace Nette\Utils;

class Html
{
    public function add(...)
    {
        // ...
    }
}</code></pre>
<p>So how to inform all ends users about this?</p>
<p>You can choose from <strong>2 ways to write deprecations messages</strong>, based on your preference.</p>
<h3 id="1-A-at-deprecate-annotation">1. A <code>@deprecate</code> annotation</h3>
<pre><code class="language-php">namespace Nette\Utils;

class Html
{
    /**
     * @deprecated
     */
    public function add(...)
    {
        $this-&gt;addHtml(...);
    }

    public function addHtml(...)
    {
        // ...
    }
}</code></pre>
<p>This is the least you can do. But you could do better, right?</p>
<pre><code class="language-php">/**
 * @deprecated Method add() is deprecated.
 */
public function add(...)</code></pre>
<p>Should I delete all those methods calls in my code?</p>
<pre><code class="language-php">/**
 * @deprecated Method add() is deprecated, use addHtml() instead.
 */
public function add(...)</code></pre>
<p><strong>A-ha, that's better!</strong></p>
<p><br></p>
<p>I Have 1 Question for you: <strong>What happens when programmer runs <code>$html-&gt;add(...)</code> method now?</strong></p>
<p>...</p>
<p>Well, exactly... <strong>nothing</strong>. <strong>Annotations have no influence on code run</strong>, so it will work and programmer won't notice anything.</p>
<p><br></p>
<p>Luckily, there is option that <strong>will actually inform about the deprecation</strong>.</p>
<h3 id="2-A-trigger-error">2. A <code>trigger_error()</code></h3>
<p>A <a href="https://php.net/manual/en/function.trigger-error.php"><code>trigger_error()</code></a> is native PHP function, that can inform user about changes in the code.</p>
<p>With the 2nd argument is level of these messages - there is special constant <code>E_USER_DEPRECATED</code> destined for this case.</p>
<pre><code class="language-php">namespace Nette\Utils;

class Html
{
    public function add(...)
    {
        # we already know how to write useful mesagges
        trigger_error('Method add() is deprecated, use addHtml() instead.', E_USER_DEPRECATED);

        $this-&gt;addHtml(...);
    })

    public function addHtml(...)
    {
        // ...
    }
}</code></pre>
<p>You can <a href="https://github.com/nette/utils/blob/f1584033b5af945b470533b466b81a789d532034/src/Utils/Html.php#L362">see it used in similar way</a> in the original code.</p>
<p><strong>What happens when programmer runs <code>$html-&gt;add(...)</code> method with this type of deprecation?</strong></p>
<p>2 things:</p>
<ul>
<li>The code will run</li>
<li><strong>The programmer will be informed</strong></li>
</ul>
<p>In case he or she is not ready for upgrade, it can be disabled in application <code>bootstrap</code> file:</p>
<pre><code class="language-php">error_reporting(~E_USER_DEPRECATED);</code></pre>
<p><a href="https://phpfashion.com/jak-spravne-updatovat-nette">Source</a> (Czech only)</p>
<p>I said...</p>
<p><em>It's very simple to add to your open-source code workflow...</em></p>
<p>...and this is it!</p>
<p>That was <a href="https://symfony.com/doc/current/contributing/code/bc.html">Symfony's Backward Compatibility Promise</a> in a nutshell.</p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/09/11/how-to-write-open-source-in-php-3-deprecating-code</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 11 Sep 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/09/11/how-to-write-open-source-in-php-3-deprecating-code#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How ApiGen Survived its Own Death ]]></title>
                <link>https://tomasvotruba.com/blog/2017/09/04/how-apigen-survived-its-own-death</link>
                <description><![CDATA[ <p><a href="https://github.com/apigen/apigen">ApiGen</a> was broken for a long time. It depended on Reflection package, that was not developed since 2013 and was unable to parse <em>newer</em> code. When I say newer, I mean <em>hot</em> PHP features like <code>::class</code> in 5.5. I don't even talk about 5.6 or 7.</p>
<p>I got frustrated. I spent a year on a project that is still not working out of the box. So I took spring off to change it. <strong>My goal was to replace reflection or let the project die in peace</strong>.</p>
<p>This is story about the whole journey of ups and downs.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Prepare for deep darkness, (almost) burning out and... team work that helped me to make it to the end.</p>
<img src="/assets/images/posts/2017/apigen-revival/apigen.png" class="img-thumbnail">
<h2 id="Step-1-Bump-to-PHP-7-1">Step 1: Bump to PHP 7.1</h2>
<p>I love PHP 7.1 and I use it everywhere since its release in 2016. This year <a href="/blog/2017/06/05/go-php-71/">more and more big projects are migrating</a>, yet this is still low % of all packages.</p>
<p>So my condition was to <a href="https://github.com/ApiGen/ApiGen/issues/779#issuecomment-285960383">bump minimal requirement to PHP 7.1</a>. Current maintainers agreed, so I had green on. Thank you <a href="https://github.com/jankal">Alexander Jank</a> for your support in my first PRs to ApiGen this year.</p>
<h2 id="Step-2-Pick-the-right-Reflection-Successor">Step 2: Pick the right Reflection Successor</h2>
<p>ApiGen uses reflection to analyze classes, their methods, interfaces, traits, parent class of the class, their methods etc.</p>
<p><strong>Pure PHP reflection can be barely used for advanced tasks like the last one</strong>, so I'd have to rewrite whole package myself. That's not a way to go if you want to have a calm life and normal sleep.</p>
<p>The question was, <strong>where to find the right one?</strong></p>
<p>I knew a few, but not any that would be able to parse PHP 7.1 by itself. I was aware of <a href="https://github.com/nikic/PHP-Parser">nikic/php-parser</a>, that was maintained and future-compatible (Nikic even added PHP 7.2 features recently). But it was only parsing tool, not smart reflection wrapper.</p>
<h3 id="Reaching-out-for-Help">Reaching out for Help</h3>
<p>In that time, I came across <a href="https://github.com/nikic/PHP-Parser/wiki/Projects-using-the-PHP-Parser">Projects using the PHP Parser</a> on Wiki of PHP-Parse, I consulted with <a href="https://github.com/jantvrdik">Jan Tvrdik</a> and <a href="https://twitter.com/OndrejMirtes">Ondrej Mirtes</a>.</p>
<p>This all <a href="https://github.com/ApiGen/ApiGen/issues/817">led me to a package</a> called <a href="https://github.com/roave/better-reflection">Roave/BetterReflection</a> by <a href="https://www.jamestitcumb.com">James Titcumb</a> and <a href="https://ocramius.github.io">Marco Pivetta</a>.</p>
<p>I'm bit suspicious to projects that were lastly tagged a half year ago, but I felt I could gave it a go.</p>
<h2 id="Step-3-Replace-Reflection">Step 3: Replace Reflection</h2>
<p>All right, package picked! The <del>fun</del> hell was about to begin.</p>
<p>Imagine your whole application uses everywhere a package, that got stuck 4 PHP versions ago. You feel it more and more. Everyday you need to patch it because there are other packages that are up-to-date. You know, like PHP itself.</p>
<p>When I maintained the ApiGen in 2014, I felt I should <a href="https://ocramius.github.io/blog/when-to-declare-classes-final">interface everything</a> - thank you for that <em>past me</em>. All reflection classes were interfaced, and there was somewhat of a bridge between TokenReflection (the old package) and ApiGen value objects for Reflections.</p>
<p>Still, I could not drop all old reflections without having prepared all new ones.</p>
<p>But the algorithm alone was simple (well after stepping back from ~3 k lines of code):</p>
<ul>
<li>
<ol>
<li>a 3rd party package's <code>&lt;class&gt;Reflection</code> goes in</li>
</ol>
</li>
<li>
<ol start="2">
<li>ApiGen transforms it</li>
</ol>
</li>
<li>
<ol start="3">
<li>an ApiGen Reflection comes out</li>
</ol>
</li>
</ul>
<h3 id="Collector-Transformer-Router-to-the-rescue">Collector + Transformer + Router to the rescue</h3>
<p>I don't know how that happened, but I managed to combine 3 patterns to make this work.</p>
<p>By &quot;making this work&quot; I mean:</p>
<ul>
<li><strong>keep old</strong> reflection package as stable fallback</li>
<li><strong>use new reflection package</strong> only on single reflection class, e.g. <code>ClassConstantReflection</code></li>
</ul>
<p>The main service that takes cares of this is <a href="https://github.com/ApiGen/ApiGen/blob/a6f56691d87f74a64b31a15b7866d5a839aecb60/packages/Reflection/src/TransformerCollector.php#">TransformerCollector</a>.</p>
<p>All particular Transformers are <strong>collected</strong> into it.</p>
<p>When reflection is passed, ApiGen will decide what to do with it - that is <a href="https://github.com/ApiGen/ApiGen/blob/a6f56691d87f74a64b31a15b7866d5a839aecb60/packages/Reflection/src/TransformerCollector.php#L68-L71">the Router part</a>.</p>
<p>Having this setup ApiGen could:</p>
<ul>
<li>
<ol>
<li>have old TokenReflection</li>
</ol>
</li>
<li>
<ol start="2">
<li>match specific classes and reparse them with BetterReflection</li>
</ol>
</li>
<li>
<ol start="3">
<li>output ApiGen Reflection value objects</li>
</ol>
</li>
</ul>
<p>In time, I've added more and more BetterReflection transformers, like <a href="https://github.com/ApiGen/ApiGen/blob/a6f56691d87f74a64b31a15b7866d5a839aecb60/packages/Reflection/src/Transformer/BetterReflection/Class_/ClassReflectionTransformer.php#L46">ClassReflectionTransformer</a> that handles ClassReflection.</p>
<p><em><a href="https://github.com/ApiGen/ApiGen/issues/817">10 PRs later...</a></em></p>
<p>There was light in the of the tunnel.</p>
<p><strong>Rule of a thumb: when you need to replace something, build a bridge/router and do it gradually. You'll be both safe and in progress.</strong></p>
<p><strong>Never rewrite running project from scratch</strong>, unless you really have to.</p>
<h2 id="Step-4-Is-Ship-Going-Down">Step 4: Is Ship Going Down?</h2>
<p>I had dilemma about global constants that BetterReflection doesn't support, yet TokenReflection does. I didn't know what to do with that and I was stuck.</p>
<p>Then, Jan Tvrdik and I have a chat at one grill party about this. Jan helped me to realize, <strong>that single issue should not stand in a way of saving the project</strong>. I could drop it and if anyone needs it, he or she might implement it. That was a huge step forward for me and the project.</p>
<h3 id="Drop-Everything-You-don-t-Need-Just-to-Breathe">Drop Everything You don't Need - Just to Breathe</h3>
<p>I also came to the state, when there was too much coupling of <strong>features I didn't feel like they were useful anymore</strong>.</p>
<p>Using Markdown in docblock descriptions to highlight them was one of them. I never saw that in any code except ApiGen and I still don't think using Markdown in PHP code is a good idea.</p>
<p>I proposed issue <a href="https://github.com/ApiGen/ApiGen/issues/782#issuecomment-285988252">of turning Markdown down</a> and adding event instead, so anyone could implement if really needed and <a href="https://github.com/ApiGen/ApiGen/pull/795">it solved around 10 issues</a>. Just like that.</p>
<p><strong>Rule of a thumb? When you're stuck in open-source project, drop things that are the least relevant to the project.</strong> It might give you space to breathe and to move forward to next release.</p>
<h2 id="Step-5-Reflection-Replaced">Step 5. Reflection Replaced</h2>
<p><em>10 more PRs later</em></p>
<p>Reflection works - PHP 7.1 code is perfectly parsed with no issues!</p>
<img src="/assets/images/posts/2017/apigen-revival/done.png" class="img-thumbnail">
<p>It didn't have cool features like tree references, but I was able to parse PHP 5.5, PHP 5.6, PHP 7.0 and PHP 7.1 with no problem at all. We could finally close over 30 opened issues that spread for last 4 years.</p>
<p>This gave me a dopamine shot, yet worsts was about to come.</p>
<h2 id="Step-6-Burnout">Step 6. Burnout</h2>
<p>It was June 2017. The main issue was solved and there was plenty space to improve ApiGen. <strong>But not motivation</strong>. I didn't use it personally and I felt I was there mainly to replace reflection, because I was the one was responsible for its design.</p>
<p>After I finished that, I was looking for co-maintainer and somebody who's using the project to took over me.</p>
<p>Personally, I felt <del>bit</del> burned out. What now? Give up the project? Go to cinema? Go to a coach? ✓</p>
<p>What helped me was a <a href="https://github.com/dbrock/semver-howto#release-candidates-100-foo">release-candidate</a>. An illusion of milestone, that closes huge part of dev work.</p>
<p>I released <a href="https://github.com/ApiGen/ApiGen/releases/tag/v5.0.0-RC1">ApiGen 5.0-RC1</a> on June 3rd 2017. It <strong>actually brought more attention then I expected</strong>. Release Candidates are apparently sign that project is back to life.</p>
<h2 id="Step-7-Saved">Step 7. Saved!</h2>
<p>Situation changed with <a href="https://github.com/ApiGen/ApiGen/releases/tag/v5.0.0-RC3">5.0-RC3</a>.</p>
<img src="/assets/images/posts/2017/apigen-revival/rc3.png" class="img-thumbnail">
<p>As you can see, <a href="https://github.com/vlastavesely">Vlasta Vesely</a> did almost 90 % of work on the release. I went to Brno to meet Vlasta, we had great chat and wine - thank you for both.</p>
<p><strong>I asked Vlasta to join ApiGen maintainer team and he agreed</strong>. The future is bright now.</p>
<p>And that is the whole journey up to present moment.</p>
<h3 id="What-would-be-the-main-takeway">What would be the main takeway?</h3>
<p>It's all about team work, priorities, communication of miss-understandings and dealing with your own shit you find on the way home.</p>
<p>Now to the shorter practical part...</p>
<h2 id="What-changed-and-what-was-removed">What changed and what was removed?</h2>
<p>If I should mention 4 most important changes you should know about, it would be:</p>
<ul>
<li>Version 4.0 worked fine with PHP 5.4 code - newer usually crashed it. ApiGen <strong>can deal with PHP 5.5, 5.6, 7.0 and 7.1 code</strong> now.</li>
<li>Min PHP version bumped <strong>from PHP 5.4 to PHP 7.1</strong>. ApiGen is still able to parse older code.</li>
<li><strong>TokenReflection refactored to BetterReflection</strong> - thanks to James and Marco for fast responses on our issues and pull-requests.</li>
<li>Switched to <a href="https://github.com/ApiGen/ApiGen/pull/880">Symfony 3.3 Dependency Injection</a> with <a href="/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3/">time-saving features</a> - thanks <a href="https://martinhujer.cz">Martin Hujer</a> for the idea.</li>
</ul>
<p>Look at particular releases to get complete list of changes. Changelogs are nice and clean:</p>
<ul>
<li><a href="https://github.com/ApiGen/ApiGen/releases/tag/v5.0.0-RC1">ApiGen 5.0-RC1</a></li>
<li><a href="https://github.com/ApiGen/ApiGen/releases/tag/v5.0.0-RC2">ApiGen 5.0-RC2</a></li>
<li><a href="https://github.com/ApiGen/ApiGen/releases/tag/v5.0.0-RC3">ApiGen 5.0-RC3</a></li>
<li><a href="https://github.com/ApiGen/ApiGen/releases/tag/v5.0.0-RC4">ApiGen 5.0-RC4</a></li>
<li><a href="https://github.com/ApiGen/ApiGen/releases/tag/v5.0.0-RC5">ApiGen 5.0-RC5</a></li>
</ul>
<h2 id="Run-ApiGen-Yourself">Run ApiGen Yourself</h2>
<p>ApiGen uses BetterReflection that is still not tagged, so you need to install it like:</p>
<pre><code class="language-json">{
    "require-dev": {
        "apigen/apigen": "5.0.0-RC5",
        "roave/better-reflection": "dev-master#7ce58dd"
    }
}</code></pre>
<p>and run with composer:</p>
<pre><code class="language-bash">composer update</code></pre>
<p>And you are read to go.</p>
<p>Happy generating!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/09/04/how-apigen-survived-its-own-death</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 04 Sep 2017 00:00:00 +0000</pubDate>
                                    <updated>2018-12-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Dec 2018 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Dec 2018 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/09/04/how-apigen-survived-its-own-death#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Shopsys, Spryker &amp; Sylius under Static Analysis ]]></title>
                <link>https://tomasvotruba.com/blog/2017/08/28/shopsys-spriker-and-sylius-under-static-analysis</link>
                <description><![CDATA[ <p>When you're building a new web project based on open-source, you'll pick a package you know, have good experience with or try a new one that might be even better.</p>
<p>Lines of code, cyclomatic complexity, method count per class, length of method, number of interfaces relative to classes - these all can be just a superficial number or a <strong>quick measure how well is the project built</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p><br></p>
<blockquote class="blockquote text-center">
 "Never trust any statistics that you didn't forge yourself."
 <footer class="blockquote-footer">Nazi propaganda about Winston Churchill</footer>
</blockquote>
<p><br></p>
<h2 id="Understanding-Statistics">Understanding Statistics</h2>
<p>I never trust posts with statistics without any data to re-run the results on or with such a complicated methodology that discourages me to try anything and rather trust the source.</p>
<p>Therefore, I wanted to make this post different. To have you in control, not the hype.</p>
<h3 id="Try-It-Yourself">Try It Yourself</h3>
<p>I've put all the used data and methodology in an open-source way in a <a href="https://github.com/TomasVotruba/shopsys-spryker-and-sylius-analysis">Github repository</a>, where <strong>you can install it and re-run on your own</strong>. You'll need to <a href="https://www.shopsys.com/#contact">ask for a access to open-beta of Shopsys Framework</a> - that's the one extra step. I will update both this post and repository after Shopsys Framework is open-source in late 2017.</p>
<h3 id="No-Black-and-White">No Black and White</h3>
<p>The aim of posts like these is usually just to put together arguments supporting author's opinion, so they are pretty useless for you if you disagree with the author.</p>
<p>To be clear, I work with Shopsys as an open-source consultant. I try to be as strict and honest with them as possible in order to make the product better. And this article is another example of if.</p>
<p>There is no winner and no loser, as you'll see. <strong>Let's dive into the numbers now</strong>.
From over 50 various metrics, I've picked 4 of them. After reading them, you'll have a bit better picture of the code quality of these projects.</p>
<p><br></p>
<p>We are going to analyze 3 e-commerce projects build on Symfony components:</p>
<p><br></p>
<div class="col-6 mb-3">
    <a href="https://www.shopsys.com/">
        <img src="/assets/images/posts/2017/shopsys-static-anal/shopsys.png">
    </a>
</div>
<div class="col-5">
    <a href="http://sylius.org/">
        <img src="/assets/images/posts/2017/shopsys-static-anal/sylius.png">
    </a>
</div>
<div class="col-5">
    <a href="https://spryker.com/">
        <img src="/assets/images/posts/2017/shopsys-static-anal/spryker.png">
    </a>
</div>
<h2 id="1-Lines-of-code">1. Lines of code</h2>
<p>Smaller projects are easier to understand, especially when you want to send a PR and need to understand their architecture.</p>
<h3 id="Lines-of-code">Lines of code</h3>
<ul>
<li>Shopsys: <strong>94 590</strong></li>
<li>Sylius: <strong>109 111</strong></li>
<li>Spryker: <strong>368 245</strong></li>
</ul>
<p><a href="https://github.com/TomasVotruba/shopsys-spryker-and-sylius-analysis/blob/89ff354b5298ba831c9124039f217dd0c5687e3d/src/Finder/PhpFilesFinder.php#L27-L31">Tests excluded</a>.</p>
<h2 id="2-Duplicated-Code">2. Duplicated Code</h2>
<p>Duplicated code can be a sign of coupled code and flaws in reusability.
<strong>Sylius has 0,24 % duplicated lines</strong>, Shopsys 0,67 % and lastly <strong>Spryker with 1,20 %</strong>.</p>
<h2 id="3-Cyclomatic-Complexity">3. Cyclomatic Complexity</h2>
<p>Cyclomatic Complexity is something like a train path with switches.</p>
<p><strong>The number of paths you can take in the method.</strong></p>
<p><strong>A.</strong> This is what we desire for in our code:</p>
<div>
    <img src="/assets/images/posts/2017/shopsys-static-anal/split-2.png" class="img-thumbnail">
</div>
<p><strong>B.</strong> And this what we often end-up with:</p>
<div>
    <img src="/assets/images/posts/2017/shopsys-static-anal/split-m.png" class="img-thumbnail">
</div>
<p>Which one would you pick if you'd be a programmer, in a method you never saw?</p>
<p>Cyclomatic complexity in PHP code would, <strong>for the example B</strong>, look like this:</p>
<pre><code class="language-php">final class ProductController extends Controller
{
    public function renderDetail(Request $request)
    {
        $id = $request-&gt;get('id'); # 1
        if ($id === null) { # 2
            throw new ProductIdMissingException('Id is required for product detail'.);
        }

        $product = $this-&gt;productRepository-&gt;get($id);
        if ($product === null) { # 3
            throw new ProductNotFoundException(sprintf('Product with id %d was not found.', $id);
        }

        if (! $product-&gt;isAvailable) { # 4
            $this-&gt;redirect('sold-out');
        }

        if ($this-&gt;isOnMobile()) { # 5
            foreach ($product-&gt;getImages() as $image) { # 6
                $image-&gt;resizeToMobile();
            }
        }

        $this-&gt;render('detail', [
            'product' =&gt; $product;
        ]);
    }
}</code></pre>
<p>...<strong>6 in total</strong>.</p>
<p>And for <strong>the example A</strong> like this:</p>
<pre><code class="language-php">final class ProductController extends Controller
{
    public function renderDetail(Product $product)
    {
        $this-&gt;ensureIsAvailable($product); # 1
        $this-&gt;prepareForMobile($product);

        $this-&gt;render('detail', [
            'product' =&gt; $product;
        ]);
    }
}</code></pre>
<p>...with <strong>just 1</strong>.</p>
<p>This metric can give you a decent overview of hot spots that might need refactoring.
<strong>When looking at this score, the lower the number the better</strong>. This applies to areas as readability, maintainability and testability.</p>
<p><strong>Consider writing a unit test and having a function with a cyclomatic complexity of 12</strong>. This means that, <strong>if you want 100% code coverage</strong>, you need to test every of these 12 paths and end up in pretty messy tests.</p>
<p>The results are:</p>
<p><em>Shopsys</em></p>
<ul>
<li>Complexity / Class: <strong>2.89</strong></li>
<li>Complexity / Method: <strong>1.53</strong></li>
</ul>
<p><em>Sylius</em></p>
<ul>
<li>Complexity / Class: <strong>2.52</strong></li>
<li>Complexity / Method: <strong>1.52</strong></li>
</ul>
<p><em>Spryker</em></p>
<ul>
<li>Complexity / Class: <strong>2.46</strong></li>
<li>Complexity / Method: <strong>1.46</strong></li>
</ul>
<p><br></p>
<h3 id="Extreme-Is-Never-Good">Extreme Is Never Good</h3>
<p>However, having the <strong>cyclomatic complexity = 1 in combination with low co-location</strong> could lead to issues like <a href="https://news.ycombinator.com/item?id=13364649"><em>ehnto</em> describes</a>:</p>
<p><em>&quot;What you want is never nearby, and thanks to the Facade system used for service location it also isn't always clear which class is actually being used without digging through some configuration files...</em></p>
<p><em>This leaves you digging through dozens of tiny files, some barely longer than the class definition itself, just to find even high level logic. I normally learn frameworks by simply reading the code, but I can't help but feel fatigued when having to try and find where a line of logic actually lives in Laravel. It is almost always a journey.&quot;</em></p>
<p>You can <a href="https://medium.com/@taylorotwell/measuring-code-complexity-64356da605f9">read similar comparison of Code Complexity in Symfony and Laravel</a> by Taylor Otwell. <a href="https://blog.sonarsource.com/discussing-cyclomatic-complexity">Maintainer vs. contributor view on Cyclomatic Complexity</a> is briefly described on SonarCube.</p>
<h2 id="4-It-s-All-About-Methods">4. It's All About Methods</h2>
<p>Last metrics focuses on the most used parts of the code - methods. Even if a project is small, long and complex methods can make it very difficult to use. On the other hand: <strong>huge projects with lines of clean and narrow methods can be fun and easy to work with</strong>.</p>
<p>Let's look at the metrics of methods:</p>
<p><em>Shopsys</em></p>
<ul>
<li>Max. Method Length: <strong>261 lines</strong></li>
<li>Max. Method Cyclomatic Complexity: <strong>12</strong></li>
</ul>
<p><em>Sylius</em></p>
<ul>
<li>Max. Method Length: <strong>26 lines</strong></li>
<li>Max. Method Cyclomatic Complexity: <strong>22</strong></li>
</ul>
<p><em>Spryker</em></p>
<ul>
<li>Max. Method Length: <strong>117 lines</strong></li>
<li>Max. Method Cyclomatic Complexity: <strong>64</strong></li>
</ul>
<p><br></p>
<p>Finally, I have a question for you. Based just on these numbers and without personal preferences, <strong>which one of the three projects would you pick and why</strong>?</p>
<h2 id="Stay-Tuned">Stay Tuned!</h2>
<p>In the follow up post, we'll look at these projects under PHPStan and Easy Coding Standard with PSR2 rulesets.</p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/08/28/shopsys-spriker-and-sylius-under-static-analysis</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 28 Aug 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/08/28/shopsys-spriker-and-sylius-under-static-analysis#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 5 Useful Rules From Symplify Coding Standard ]]></title>
                <link>https://tomasvotruba.com/blog/2017/08/21/5-useful-rules-from-symplify-coding-standard</link>
                <description><![CDATA[ <p><a href="https://github.com/symplify/coding-standard">Symplify Coding Standard</a> was born from Zenify, back from the days I was only Nette programmer. It focuses on <strong>maintainability and clean architecture</strong>. I try to make them simple: <strong>each of them does one job</strong>.
<br><br>
With over 108 000 downloads I think I should write about 5 of them you can use in your projects today.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Most of the content was outdated for technical changes or idea was proven to be not very helpful. To avoid confusion among readers, to content was removed.</p>
<p>If you want, you can still see it in the git history, as this blog is <a href="https://github.com/tomasvotruba/tomasvotruba.com">fully open-sourced</a>.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/08/21/5-useful-rules-from-symplify-coding-standard</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 21 Aug 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/08/21/5-useful-rules-from-symplify-coding-standard#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Apply Nette Coding Standard in Your Project ]]></title>
                <link>https://tomasvotruba.com/blog/2017/08/14/how-to-apply-nette-coding-standard-in-your-project</link>
                <description><![CDATA[ <p><strong>Pull-requests are more fun</strong> thanks to automated coding standard. You don't have explain where to put space or bracket. You <strong>can talk about architecture or meaning of the code</strong> instead. Moreover in open-source. <strong>I wanted to make this possible in Nette</strong>, but Coding Standards could be found only in <a href="https://nette.org/en/coding-standard">documentation</a>.
<br><br>
This year I started to work on a Nette Coding Standard (<em>NCS</em>) that you can put to CLI. And you'll <strong>be able set it up in in your project</strong> yourself today.</p> ]]></description>
                <content:encoded><![CDATA[ <p><a href="https://github.com/nette/coding-standard">Nette\CodingStandard</a> 2.0 was released 2 months. This version <strong>is ready to use, includes all important checkers and is used on all <code>Nette\*</code> packages in Travis</strong>.</p>
<p><strong>NCS checks every pull-request you make to Nette</strong>:</p>
<div>
    <a href="https://travis-ci.org/nette/application/jobs/261987910#L349">
        <img src="/assets/images/posts/2017/nette-coding-standard/travis-check.png" class="img-thumbnail">
    </a>
</div>
<p>All that need is to <a href="https://github.com/nette/application/blob/2f545e64fc4bfc941d7e48a95e3faca7c468ac35/.travis.yml#L31-L41">define stage in <code>travis.yml</code></a>:</p>
<div>
    <img src="/assets/images/posts/2017/nette-coding-standard/travis-setup.png" class="img-thumbnail">
</div>
<p>That's it! Just 2 commands and it checks any project you have.</p>
<p>But first...</p>
<h2 id="PHP-7-1">PHP 7.1+</h2>
<p>This packages requires PHP 7.1 to run as the rest of the Nette (mostly current <code>master</code> or <code>3.0</code>).</p>
<p>If you still don't know why should you **join Symfony, Nette, Doctrine, Zend or Sylius. You can read <a href="/blog/2017/06/05/go-php-71/#why-go-right-to-php-7-1">this post</a> or wait a bit longer. It's up to you.</p>
<h2 id="Setup-Your-Project">Setup Your Project</h2>
<p>Install the package to your dev dependencies:</p>
<pre><code class="language-bash">composer require nette/coding-standard --dev</code></pre>
<p>Good! Now just pick the prepared set.</p>
<p>At the moment there are <strong>3 configs with set of checkers</strong>:</p>
<ul>
<li><a href="https://github.com/nette/coding-standard/blob/master/coding-standard-php71.yml"><code>coding-standard-php71.yml</code></a></li>
<li><a href="https://github.com/nette/coding-standard/blob/master/coding-standard-php70.yml"><code>coding-standard-php70.yml</code></a></li>
<li><a href="https://github.com/nette/coding-standard/blob/master/coding-standard-php56.yml"><code>coding-standard-php56.yml</code></a></li>
</ul>
<p>Just pick the one that suits you:</p>
<pre><code class="language-bash">vendor/bin/ecs check src tests --config vendor/nette/coding-standard/coding-standard-php71.yml</code></pre>
<p>Then, fix the code:</p>
<pre><code class="language-bash">vendor/bin/ecs check src tests --config vendor/nette/coding-standard/coding-standard-php71.yml --fix</code></pre>
<p>Config with higher PHP version includes all lower versions, so with <code>coding-standard-php71.yml</code> you cover the other 2 configs as well.</p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/08/14/how-to-apply-nette-coding-standard-in-your-project</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 14 Aug 2017 00:00:00 +0000</pubDate>
                                    <updated>2018-12-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Dec 2018 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Dec 2018 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/08/14/how-to-apply-nette-coding-standard-in-your-project#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 7 New Features in Easy Coding Standard 2.2 ]]></title>
                <link>https://tomasvotruba.com/blog/2017/08/07/7-new-features-in-easy-coding-standard-22</link>
                <description><![CDATA[ <p>After extensive cooperation with <a href="https://twitter.com/geekovo/status/885152407948333056">David Grudl on Nette\CodingStandard</a> ECS got new features with <strong>focus on developer experience</strong>. Smart experience.</p>
<p>Prepared configs, reduction of config to few lines, <code>--config</code> option and more.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Today we'll look on <strong>new features it uses from ECS</strong>.</p>
<h2 id="1-Shorter-Bin">1. Shorter Bin</h2>
<pre><code class="language-bash"># before
vendor/bin/easy-coding-standard

# now
vendor/bin/ecs</code></pre>
<h2 id="2-Prepared-Rule-Sets">2. Prepared Rule Sets</h2>
<p>Before you had to name all the checkers manually in your config. There was no <em>PSR2</em> group nor <em>Symfony</em> like there is in other tools. <strong>Now you can pick from 10 prepared configs</strong>.</p>
<p><em>PHP_CodeSniffer + PHP CS Fixer</em></p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\EasyCodingStandard\ValueObject\Option;
use Symplify\EasyCodingStandard\ValueObject\Set\SetList;

return function (ContainerConfigurator $containerConfigurator): void {
    $containerConfigurator-&gt;import(SetList::PSR_12);
    $containerConfigurator-&gt;import(SetList::COMMON);
    $containerConfigurator-&gt;import(SetList::SYMPLIFY);
    // ...
    // explore the constants on `SetList` class
};</code></pre>
<h2 id="3-Use-Whole-Set-But-1-Checker">3. Use Whole Set But 1 Checker</h2>
<p>Imagine you love the PSR-12 set, <strong>except that 1 checker</strong>. Do you skip the set completely or copy all the rules manually except the one?</p>
<p>Not anymore!</p>
<pre><code class="language-php">use PhpCsFixer\Fixer\Operator\UnaryOperatorSpacesFixer;
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\EasyCodingStandard\ValueObject\Option;
use Symplify\EasyCodingStandard\ValueObject\Set\SetList;

return function (ContainerConfigurator $containerConfigurator): void {
    $containerConfigurator-&gt;import(SetList::PSR_12);

    $parameters = $containerConfigurator-&gt;parameters();
    $parameters-&gt;set(Option::SKIP, [
        // ignore 1 rule everywhere
        UnaryOperatorSpacesFixer::class =&gt; null,
    ]);
};
</code></pre>
<h2 id="4-Skip-More-Than-1-File-For-Specific-Checker">4. Skip More Than 1 File For Specific Checker</h2>
<p>Do you need to skip more files for 1 specific checker? <strong>Now you can <a href="https://php.net/manual/en/function.fnmatch.php"><code>fnmatch</code></a> pattern</strong>:</p>
<pre><code class="language-php">use SlevomatCodingStandard\Sniffs\TypeHints\TypeHintDeclarationSniff;

// ...
$parameters-&gt;set(Option::SKIP, [
    TypeHintDeclarationSniff::class =&gt; [
        '*packages/CodingStandard/src/Sniffs/*/*Sniff.php'
    ],
]);</code></pre>
<h2 id="5-New-Command-Show-Display-Used-Checkers">5. New Command <code>Show</code> Display Used Checkers</h2>
<p>Do you know, what checkers do you use?</p>
<pre><code class="language-bash">vendor/bin/ecs show</code></pre>
<p>This is rather debug or info tool, but it might come handy.</p>
<p><strong>You can find <a href="https://github.com/symplify/easy-coding-standard">more options of this command in README</a></strong>.</p>
<h2 id="6-Scan-php-and-phpt-Files">6. Scan <code>*.php</code> and <code>*.phpt</code> Files</h2>
<p>EasyCodingStandard checks only <code>*.php</code> files by default. But what if you want to check <code>*.phpt</code> as well as in case of <a href="https://github.com/nette/coding-standard">Nette\CodingStandard</a>?</p>
<p>Use <code>Option::FILE_EXTENSIONS</code>:</p>
<pre><code class="language-php">// ...
$parameters-&gt;set(Option::FILE_EXTENSIONS, ['php', 'phpt']);</code></pre>
<h2 id="7-Are-you-Tabs-Person">7. Are you Tabs Person?</h2>
<p>There you go:</p>
<pre><code class="language-php">// ...
$parameters-&gt;set(Option::INDENTATION, Option::INDENTATION_TAB);</code></pre>
<h3 id="Like-it-Try-It">Like it? Try It</h3>
<p>If you find these 7 news useful, try <a href="https://github.com/symplify/easy-coding-standard">ECS</a> right now.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/08/07/7-new-features-in-easy-coding-standard-22</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 07 Aug 2017 00:00:00 +0000</pubDate>
                                    <updated>2020-11-01UTC00:00:000</updated>
                    <atom:updated>Sun, 01 Nov 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sun, 01 Nov 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/08/07/7-new-features-in-easy-coding-standard-22#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How PHP Coding Standard Tools Actually Work ]]></title>
                <link>https://tomasvotruba.com/blog/2017/07/31/how-php-coding-standard-tools-actually-work</link>
                <description><![CDATA[ <p>Do you use <a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer">PHP CS Fixer</a> or <a href="https://github.com/squizlabs/PHP_CodeSniffer">PHP_CodeSniffer</a>? Do you know the way they work is ~80 % the same? Do you wonder how they work under the hood?
<br><br>
Today I will share <strong>3 main pillars of their architecture</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Why should these 3 pillars be even important for you? When I understood tools behind them and their basic principals, <strong>I was able to more effective Sniffs and Fixers</strong> (<em>Checkers</em> further on) <strong>that were clear to their communities</strong>.</p>
<h2 id="Write-1-Checker-Save-Hundreds-Hours-of-Work">Write 1 Checker, Save Hundreds Hours of Work</h2>
<p>Coding Standards are my greatest passion for last couple of years. I love their efficiency: <strong>with one rule (class) you can improve thousands of lines in your code</strong> in matters of milliseconds. And not only yours if you share it in a package.</p>
<p>With a Checker you can change <code>array()</code> to <code>[]</code>. And more then that. Coding Standard are not exclusively about spaces, tabs and brackets nowadays.</p>
<p>You can use them to <a href="https://daniel-siepmann.de/Posts/2017/2017-03-20-phpcs-code-migration.html">refactor to newer version of your framework</a>,
<a href="https://github.com/wimg/PHPCompatibility">upgrade your codebase to newer PHP</a> or <a href="https://github.com/kukulich/php-type-hints-convertor">add PHP 7.1 typehints to your methods</a>.</p>
<p>That's laziness on a completely different level :)</p>
<h2 id="So-Much-for-The-Hype">So Much for The Hype</h2>
<div class="text-center">
    <img src="https://content.artofmanliness.com/uploads/2015/08/Small-Things-Over-Time-2.jpg">
</div>
<p>A lot is possible to do with these tools and I'll write about that in the future, but today we'll start with a much <a href="/blog/2017/02/22/fast-and-easy-way-to-learn-complex-topics/">smaller step</a>: a Checker that will inform us about coding standard violation. No changes, no refactoring.</p>
<p>To know how to build a Checker you need to understand 3 terms: <em>token</em>, <em>dispatcher</em> and <em>subscriber</em>.</p>
<p>I'll explain them one by one.</p>
<h2 id="1-Token">1. Token</h2>
<p>We see PHP as:</p>
<pre><code class="language-php">&lt;?php echo "hi";</code></pre>
<p>Coding Standard tools see it in <a href="https://php.net/manual/en/tokens.php">tokens</a>:</p>
<pre><code class="language-php">$phpCodeInTokens = token_get_all('&lt;?php echo "hi";');
var_dump($phpCodeInTokens);</code></pre>
<pre><code class="language-php">array(5) {
  [0]=&gt;
      array(3) {
        [0]=&gt;
        int(379) # token id
        [1]=&gt;
        string(6) "&lt;?php " # token content
        [2]=&gt;
        int(1)
      }
  [1]=&gt;
      array(3) {
        [0]=&gt;
        int(328) # token id
        [1]=&gt;
        string(4) "echo" # token content
        [2]=&gt;
        int(1)
      }
  [2]=&gt;
      array(3) {
        [0]=&gt;
        int(382) # token id
        [1]=&gt;
        string(1) " " # token content
        [2]=&gt;
        int(1)
      }
  [3]=&gt;
      array(3) {
        [0]=&gt;
        int(323) # token id
        [1]=&gt;
        string(4) ""hi"" # token # content
        [2]=&gt;
        int(1)
  }
  [4]=&gt;
      string(1) ";"
}</code></pre>
<p>Don't worry, this is not a content we need to work with. <strong>It will be converted to arrays or objects like these</strong>:</p>
<pre><code class="language-php">$token = [
    'type' =&gt; 328, # token id stated by PHP, you can use also more readable constant: T_ECHO (with value 328)
    'content' =&gt; 'echo'
];</code></pre>
<p>Now you know what &quot;token&quot; is.</p>
<h2 id="2-Dispatcher">2. Dispatcher</h2>
<p>Do you know <a href="/blog/2019/08/05/standalone-symfony-event-dispatcher-from-the-scratch/">Event Dispatcher</a>?</p>
<p>If not, it's a pattern (like <em>repository</em> or <em>factory</em>) that says: <strong>when this action happens, call all methods that listen to it</strong>, e.g. when order is finished (event), send confirmation SMS to user and send him thank-you box full of candies (subscribed methods).</p>
<pre><code class="language-php">$dispatcher-&gt;dispatch('order_finished');</code></pre>
<p>For Coding Standard tools <strong>it works the same</strong> but with different naming:</p>
<ul>
<li>Event &lt;=&gt; <em>Token</em></li>
<li>Subscriber &lt;=&gt; <em>Checker</em></li>
</ul>
<p>Almost there.</p>
<h2 id="3-Subscriber">3. Subscriber</h2>
<p>You already know that <em>subscriber</em> is a <em>Checker</em>. Checker is a class that waits for a specific token.</p>
<p>In pseudo code:</p>
<pre><code class="language-php">class Checker
{
    public function subscribeToToken()
    {
        return T_ECHO; // number for "echo" by PHP
    }

    public function someMethodThatWillBeCalled(array $token)
    {
        if ($token['content'] !== 'echo') {
            // mallformed echo, probably "ECHO", "eCHO" etc.
        }
    }
}</code></pre>
<p>Internally Coding Standard tools <strong>dispatch all tokens found in specific file</strong>:</p>
<pre><code class="language-php">$tokens = $this-&gt;getAllTokens(file_get_contents($file));
foreach ($tokens as $token) {
    $codingStandardTool-&gt;dispatch($token['type']);
}</code></pre>
<p>When the dispatcher gets a token with type <code>T_ECHO</code> (= <code>328</code>) it will call  <code>Checker::someMethodThatWillBeCalled()</code> method.</p>
<p>I think now you are ready for the real code.</p>
<h3 id="Do-You-Want-Real-Code">Do You Want Real Code?</h3>
<p>I already wrote <a href="/blog/2017/07/17/how-to-write-custom-sniff-for-code-sniffer-3/">how to write a Sniff for PHP_CodeSniffer</a> or <a href="/blog/2017/07/24/how-to-write-custom-fixer-for-php-cs-fixer-24/">how to write a Fixer for PHP CS Fixer</a> on this topic where I write code to solve  real life use cases.</p>
<p>Enjoy saved time by writing a code that works for you.</p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/07/31/how-php-coding-standard-tools-actually-work</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 31 Jul 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/07/31/how-php-coding-standard-tools-actually-work#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Write Custom Fixer for PHP CS Fixer 3 ]]></title>
                <link>https://tomasvotruba.com/blog/2017/07/24/how-to-write-custom-fixer-for-php-cs-fixer-24</link>
                <description><![CDATA[ <p>You already know <a href="/blog/2017/07/17/how-to-write-custom-sniff-for-code-sniffer-3/">how coding standard tools work with tokens and how to write a Sniff</a>.
<br><br>
Today we'll explore another tool - <a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer">PHP CS Fixer</a> and we get <strong>from finding the smelly spot to fixing it</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p><strong>Are you new to PHP Coding Standard Tools</strong>? You can read intro <a href="/blog/2017/07/31/how-php-coding-standard-tools-actually-work/">How PHP Coding Standard Tools Actually Work</a> to grasp the idea behind them. Or <a href="https://www.youtube.com/watch?v=t99KH0TR-J4&amp;feature=youtu.be&amp;t=16">just go on</a> if you're ready to start...</p>
<p><br></p>
<p>When a coding standard tool finds over 1000 violations in our code is nice to know, but it doesn't save us any time and energy we need for <a href="http://calnewport.com/books/deep-work/">a deep work</a>.</p>
<h3 id="Find-and-amp-Fix-It">Find &amp; Fix It</h3>
<p>That main difference of PHP CS Fixer to PHP_CodeSniffer is that <strong>every Fixer has to fix issues it finds</strong>. That's why there is no <code>LineLengthFixer</code>, because fixing line length is difficult to automate.</p>
<p>Personally I like PHP CS Fixer a bit more, <strong>because of more friendlier API, active community and openness to 3rd party packages</strong>:</p>
<div class="text-center">
    <img src="/assets/images/posts/2017/php-cs-fixer-intro/php-cs-fixer-require.png" class="img-thumbnail">
    <br>
    <a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer/blob/1c10240da97479274fd40a136c3857ff94f7f93f/composer.json#L16-L33">
        <code>composer.json</code> from PHP CS Fixer
    </a>
</div>
<p><br></p>
<div class="text-center">
    <img src="/assets/images/posts/2017/php-cs-fixer-intro/code-sniffer-require.png" class="img-thumbnail">
    <br>
    <a href="https://github.com/squizlabs/PHP_CodeSniffer/blob/1e440f47e304e640217645e843cdacaacc5339b6/composer.json#L27-L32"><code>composer.json</code> from PHP_CodeSniffer</a>
</div>
<p><br></p>
<p>Apart that, they are similar: they share <a href="/blog/2017/07/17/how-to-write-custom-sniff-for-code-sniffer-3/#1-token">tokens</a>,
<a href="/blog/2017/07/17/how-to-write-custom-sniff-for-code-sniffer-3/#2-dispatcher">dispatcher</a>
and <a href="/blog/2017/07/17/how-to-write-custom-sniff-for-code-sniffer-3/#2-dispatcher">subscribers</a>.</p>
<p>Yet still, working with tokens is counter intuitive to way we work with the code (class, method, property...), but I'll write about that later.</p>
<p>Now we jump to writing the Fixer class.</p>
<h2 id="7-Steps-to-Make-an-ExceptionNameFixer">7 Steps to Make an <code>ExceptionNameFixer</code></h2>
<p>&quot;An exception class should have &quot;Exception&quot; suffix.&quot;</p>
<p>In last post, we made
<a href="/blog/2017/07/17/how-to-write-custom-sniff-for-code-sniffer-3/#let-s-make-code-exceptionnamesniff-code-together">ExceptionNameSniff</a>, that will:</p>
<ul>
<li>find an &quot;extends&quot; token</li>
<li>check if parent class is an Exception</li>
<li>find a current class name</li>
<li>check if ends &quot;Exception&quot;</li>
</ul>
<p>Today we'll add one more step:</p>
<ul>
<li><strong>fix the name to end with &quot;Exception&quot;</strong></li>
</ul>
<h3 id="1-Implement-an-Interface">1. Implement an Interface</h3>
<p>Create a fixer class and implement a <code>PhpCsFixer\Fixer\FixerInterface</code> interface.</p>
<p>It covers 7 required methods, but most of them are easy one-liners:</p>
<pre><code class="language-php">use PhpCsFixer\Fixer\FixerInterface;
use PhpCsFixer\FixerDefinition\FixerDefinitionInterface;
use PhpCsFixer\Tokenizer\Tokens;
use SplFileInfo;

final class ExceptionNameFixer implements FixerInterface
{
    # first 5 methods are rutine and descriptive

    public function getName(): string
    {
    }

    public function getDefinition(): FixerDefinitionInterface
    {
    }

    public function isRisky(): bool
    {
    }

    public function supports(SplFileInfo $file): bool
    {
    }

    public function getPriority(): int
    {
    }

    # in last 2 methods, the magic happens :)

    public function isCandidate(Tokens $tokens): bool
    {
    }

    public function fix(SplFileInfo $file, Tokens $tokens): void
    {
    }
}</code></pre>
<h3 id="2-Easypicks-First">2. Easypicks First</h3>
<p>I start with implementing first 5 methods, to make the easy work first:</p>
<pre><code class="language-php">&lt;?php

use PhpCsFixer\FixerDefinition\CodeSample;
use PhpCsFixer\FixerDefinition\FixerDefinition;
use PhpCsFixer\FixerDefinition\FixerDefinitionInterface;
use PhpCsFixer\Tokenizer\Tokens;
use SplFileInfo;

final class ExceptionNameFixer implements FixerInterface
{
    public function getName(): string
    {
        return self::class;
    }

    // this methods return the error message
    // and it might include a sample code, that would fix it
    public function getDefinition(): FixerDefinitionInterface
    {
        return new FixerDefinition(
            'Exception classes should have suffix "Exception".',
            [
                new CodeSample(
                    '&lt;?php
    class SomeClass extends Exception
    {
    }'
                ),
            ]
        );
    }

    // if the fixer changes code behavior in any way, return "true"
    // changing a class name is such case
    public function isRisky(): bool
    {
        return true;
    }

    // in 99.9% this is true, since only *.php are passed
    // you can detect specific names, e.g. "*Repository.php"
    public function supports(SplFileInfo $file): bool
    {
        return true;
    }

    // it's used to order all fixers before running them
    // `0` by default, higher value is first
    public function getPriority(): int
    {
        return 0;
    }
}</code></pre>
<h3 id="3-Subscribe-the-Fixer">3. Subscribe the Fixer</h3>
<p>Now we get to more interesting parts. Method <code>isCandidate(Tokens $tokens): bool</code> is like a <strong>subscriber</strong>. It gets all tokens of the file. We can check <strong>more than one token and create more strict conditions</strong> thanks to that:</p>
<pre><code class="language-php">public function isCandidate(Tokens $tokens): bool
{
    return $tokens-&gt;isAllTokenKindsFound([T_CLASS, T_EXTENDS, T_STRING]);
}</code></pre>
<p><code>extends</code> token without class and its name is useless and not a code we want to match.</p>
<h3 id="4-Add-and-quot-Fix-it-and-quot-part">4. Add &quot;Fix it&quot; part</h3>
<pre><code class="language-php">public function fix(SplFileInfo $file, Tokens $tokens): void
{
}</code></pre>
<p>This methods get same tokens as <code>isCandidate()</code> and the file info.</p>
<p><strong>How to build a fixer?</strong></p>
<ul>
<li>First we need to detect, if this is the use case we try to match - <strong>an exception class</strong>. Because <code>T_EXTENDS</code> doesn't tell a lot.</li>
<li>Then we need to check if it meets our rules</li>
<li>and fix if so.</li>
</ul>
<p>Let's take it one a by one:</p>
<h3 id="5-Detect-the-Exception-Class">5. Detect the Exception Class</h3>
<p><em>A class that extends another class that has suffix &quot;Exception&quot;.</em></p>
<p>There is a bit different paradigm compared to PHP_CodeSniffer. We don't get position of the <code>extends</code> token, but <strong>all the tokens</strong>. Instead of investigating one token and it's relation to other, <strong>we need to iterate through all tokens and match them with conditions</strong>:</p>
<pre><code class="language-php">public function fix(SplFileInfo $file, Tokens $tokens): void
{
    foreach ($tokens as $index =&gt; $token) {
        // is there extends token?
        if (! $token-&gt;isGivenKind(T_EXTENDS)) {
            continue;
        }

        // is this exception class?
        if (! $this-&gt;isException($tokens, $index)) {
            continue;
        }

    }
}</code></pre>
<p><strong>How to detect an exception class?</strong></p>
<p><code>Tokens</code> (like <code>File</code> in PHP_CodeSniffer) has helper methods to make our life easier.</p>
<p><strong>First of them is <code>getNextMeaningfulToken()</code>, which skips spaces and comments and seeks for first useful one</strong>. In our case, after <code>extends</code> we look for a parent class name.</p>
<pre><code class="language-php">private function isException(Tokens $tokens, int $index): bool
{
    $parentClassNamePosition = $tokens-&gt;getNextMeaningfulToken($index);
    // $tokens support array access - to get a token with some index, call $tokens[25]
    $parentClassNameToken = $tokens[$parentClassNamePosition];
    $parentClassName = $parentClassNameToken-&gt;getContent();

    return $this-&gt;stringEndsWith($parentClassName, 'Exception');
}

private function stringEndsWith(string $name, string $needle): bool
{
    return substr($name, -strlen($needle)) === $needle;
}</code></pre>
<p>Back to iteration! When this passes, we know <strong>we have a class that extends an exception</strong>.</p>
<p>Do you know what we need to do now? You're right, <strong>we have to check its name</strong>. We can use another helper method: <code>getPrevMeaningfulToken()</code>.</p>
<pre><code class="language-php">public function fix(SplFileInfo $file, Tokens $tokens): void
{
    foreach ($tokens as $index =&gt; $token) {
        // is there extends token?
        if (! $token-&gt;isGivenKind(T_EXTENDS)) {
            continue;
        }

        // is this exception class?
        if (! $this-&gt;isException($tokens, $index)) {
            continue;
        }

        // does this class ends with "Exception"?
        $classNamePosition = (int) $tokens-&gt;getPrevMeaningfulToken($index);
        // get the token
        $classNameToken = $tokens[$classNamePosition];
        // check its content
        if ($this-&gt;stringEndsWith($classNameToken-&gt;getContent(), 'Exception')) {
            continue;
        }

    }
}</code></pre>
<h3 id="6-Fixing-the-Error">6. Fixing the Error</h3>
<p>Fixing is right to the point. To change a name, replace old name (<code>T_STRING</code> <code>Token</code>) with new <code>Token</code> object with different value:</p>
<pre><code class="language-php">// Token(token type, value)
$tokens[$classNamePosition] = new Token([T_STRING, $classNameToken-&gt;getContent() . 'Exception']);</code></pre>
<p>Is that it? Yea, that's it :)</p>
<h3 id="7-Put-Together-The-Final-Fixer">7. Put Together The Final Fixer</h3>
<pre><code class="language-php">&lt;?php

namespace App\CodingStandard\Fixer;

use PhpCsFixer\Fixer\FixerInterface;
use PhpCsFixer\FixerDefinition\CodeSample;
use PhpCsFixer\FixerDefinition\FixerDefinition;
use PhpCsFixer\FixerDefinition\FixerDefinitionInterface;
use PhpCsFixer\Tokenizer\Token;
use PhpCsFixer\Tokenizer\Tokens;
use SplFileInfo;

final class ExceptionNameFixer extends FixerInterface
{
    public function getName(): string
    {
        return self::class;
    }

    public function getDefinition(): FixerDefinitionInterface
    {
        return new FixerDefinition(
            'Exception classes should have suffix "Exception".',
            [
                new CodeSample(
                    '&lt;?php
    class SomeClass extends Exception
    {
    }'
                ),
            ]
        );
    }

    public function isCandidate(Tokens $tokens): bool
    {
        return $tokens-&gt;isAllTokenKindsFound([T_CLASS, T_EXTENDS, T_STRING]);
    }

    public function isRisky(): bool
    {
        return false;
    }

    public function supports(SplFileInfo $file): bool
    {
        return true;
    }

    public function getPriority(): int
    {
        return 0;
    }

    public function fix(SplFileInfo $file, Tokens $tokens): void
    {
        foreach ($tokens as $index =&gt; $token) {
            if (! $token-&gt;isGivenKind(T_EXTENDS)) {
                continue;
            }

            if (! $this-&gt;isException($tokens, $index)) {
                continue;
            }

            $classNamePosition = (int) $tokens-&gt;getPrevMeaningfulToken($index);
            $classNameToken = $tokens[$classNamePosition];
            if ($this-&gt;stringEndsWith($classNameToken-&gt;getContent(), 'Exception')) {
                continue;
            }

            $tokens[$classNamePosition] = new Token([T_STRING, $$classNameToken-&gt;getContent() . 'Exception']);
        }
    }

    private function isException(Tokens $tokens, int $index): bool
    {
        $parentClassNamePosition = $tokens-&gt;getNextMeaningfulToken($index);
        $parentClassNameToken = $tokens[$parentClassNamePosition];
        $parentClassName = $this-&gt;getParentClassName($tokens, $index);

        return $this-&gt;stringEndsWith($parentClassName, 'Exception');
    }

    private function stringEndsWith(string $name, string $needle): bool
    {
        return (substr($name, -strlen($needle)) === $needle);
    }
}</code></pre>
<h2 id="How-to-Run-Fixer-in-ECS">How to Run Fixer in ECS?</h2>
<p>Register fixer in <code>ecs.php</code>:</p>
<pre><code class="language-php">use App\CodingStandard\Fixer\ExceptionNameFixer;
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();
    $services-&gt;set(ExceptionNameFixer::class);
};</code></pre>
<p>And run:</p>
<pre><code class="language-bash">vendor/bin/ecs check src</code></pre>
<p>That was your first fixer.</p>
<p>Happy fixing!</p>
<p>And if you want <strong>more detailed tutorial</strong>, there is one in <a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer/blob/master/doc/cookbook_fixers.rst">official cookbook</a>.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/07/24/how-to-write-custom-fixer-for-php-cs-fixer-24</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 24 Jul 2017 00:00:00 +0000</pubDate>
                                    <updated>2021-10-01UTC00:00:000</updated>
                    <atom:updated>Fri, 01 Oct 2021 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Fri, 01 Oct 2021 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/07/24/how-to-write-custom-fixer-for-php-cs-fixer-24#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Write Custom Sniff for Code Sniffer 3.3 ]]></title>
                <link>https://tomasvotruba.com/blog/2017/07/17/how-to-write-custom-sniff-for-code-sniffer-3</link>
                <description><![CDATA[ <p>When I give talks about coding standards, I ask people 2 questions: do you use coding standards? Do you write your own sniffs? On average, above 50 % uses it, but only 1-2 people wrote their own sniff.
<br><br>
PSR-2 is great for start, but main power is in those own sniffs. Every project has their own need, every person has different preferences.
<br><br>
I Google then and found outdated or complicated sources, so I've decided to write down a reference post for those, who want to start with sniffs.
Let's look what will show all you need (and nothing more) to <strong>know to write your first sniff</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p><strong>Are you new to PHP Coding Standard Tools</strong>? You can read intro <a href="/blog/2017/07/31/how-php-coding-standard-tools-actually-work/">How PHP Coding Standard Tools Actually Work</a> to grasp the idea behind them. Or <a href="https://www.youtube.com/watch?v=t99KH0TR-J4&amp;feature=youtu.be&amp;t=16">just go on</a> if you're ready to start...
<br></p>
<p>Today we'll pick an example a from my friend <a href="https://www.martinhujer.cz">Martin Hujer</a>. Once told me about sniff that checks <strong>that all exception classes have &quot;Exception&quot; suffix</strong>.</p>
<p>I said: How is it useful in practise? We all know that is common knowledge to write them this way. He replied: Well, we found some even in our code base.</p>
<p>The point is not in the count of fixed cases, but in <em>CI based responsibility</em>. From now on, <strong>people'll NEVER have to think about it</strong> and they can <strong>focus on more valuable processes</strong> that CI cannot do, like writing AliPay integration.</p>
<h2 id="6-Steps-To-ExceptionNameSniff">6 Steps To <code>ExceptionNameSniff</code></h2>
<h3 id="1-Start-With-Sentence-That-Declares-What-Sniff-Does">1. Start With Sentence That Declares What Sniff Does</h3>
<p>&quot;An exception class should have &quot;Exception&quot; suffix.&quot;</p>
<h3 id="2-Create-a-Sniff-Class-and-Implement-a-PHP-CodeSniffer-Sniffs-Sniff-interface">2. Create a Sniff Class and Implement a <code>PHP_CodeSniffer\Sniffs\Sniff</code> interface</h3>
<p>It covers 2 required methods:</p>
<pre><code class="language-php">use PHP_CodeSniffer\Sniffs\Sniff;

final class ExceptionNameSniff implements Sniff
{
    /**
     * @return int[]
     */
    public function register(): array
    {
    }

    public function process(File $file, $position): void
    {
    }
}</code></pre>
<p>A <code>register()</code> method returns list of tokens to subscribe to. Which token should we put there?</p>
<p><em>Note: You can find all tokens in <a href="https://php.net/manual/en/tokens.php">PHP manual</a>.</em></p>
<p>From &quot;An exception class should have &quot;Exception&quot; suffix.&quot; I thought the <code>T_CLASS</code> would be ideal:</p>
<pre><code class="language-php">public function register(): array
{
    return [T_CLASS];
}</code></pre>
<p>It would match this part of php code:</p>
<pre><code class="language-php">**class** SomeException extends Exception { # this is one line in your code</code></pre>
<p><code>T_CLASS</code> would match also these false positives:</p>
<pre><code class="language-php">new **class**() extends Exception { # anonymous class
**class** SomeClass { # class without parent</code></pre>
<p>It might be a little tricky to find out the easiest way to check the rule. Here you'd have to detect these cases and skip them as well.</p>
<p>What is exception in natural language description (not PHP)? <em>A class that extends another class that has suffix &quot;Exception&quot;.</em></p>
<p>So this would save us bit of coding and thinking:</p>
<pre><code class="language-php">public function register(): array
{
    return [T_EXTENDS];
}</code></pre>
<h3 id="3-Create-process-Method">3. Create <code>process()</code> Method</h3>
<p>This method has 2 arguments.</p>
<pre><code class="language-php">public function process(File $file, $position)
{
}</code></pre>
<ul>
<li>
<ol>
<li>The <code>File $file</code> object holds all tokens of the file and helper methods.</li>
</ol>
</li>
<li>
<ol start="2">
<li>The <code>$position</code> is int for current located <code>T_EXTENDS</code> token.</li>
</ol>
</li>
</ul>
<p>There are 2 parts while writing a sniff:</p>
<ul>
<li>First we need to detect, if this is the use case we try to match - an exception class. Because <code>T_EXTENDS</code> doesn't tell a lot.</li>
<li>Then we need to check if it meets our rules and add error if not.</li>
</ul>
<p>Let's take it one a by one:</p>
<h3 id="4-Detect-the-Exception-Class">4. Detect the Exception Class</h3>
<p><em>A class that extends another class that has suffix &quot;Exception&quot;.</em></p>
<p>A <code>File</code> has useful <code>findNext()</code> method:</p>
<pre><code class="language-php">$file-&gt;findNext(array ['tokens to find'], int 'where to start looking');</code></pre>
<p>It returns position of token found or null, if none.</p>
<p>We need to <strong>find a string after</strong> <code>T_EXTENDS</code>.</p>
<pre><code class="language-php">$parentClassNamePosition = $file-&gt;findNext([T_STRING], $position);
// File has all the tokens, so we get the one with name
$parentClassNameToken = $file-&gt;getTokens()[$parentClassNamePosition];

// and check it's Exception
if (substr($parentClassNameToken['content'], -strlen('Exception')) !== 'Exception')) {
    // the parent class it not and exception
    return;
}</code></pre>
<p>When the code gets pass this check, we know we have exception there.</p>
<h3 id="5-Make-Sure-it-Ends-with-and-quot-Exception-and-quot">5. Make Sure it Ends with &quot;Exception&quot;</h3>
<p>Would you what to do know? The process will be the same - to check if class name ends with &quot;Exception&quot; -, but instead of <code>findNext()</code> method we'll use <code>findPrevious()</code>:</p>
<pre><code class="language-php">// Get position of nearest previous string token
$classNamePosition = $file-&gt;findPrevious([T_STRING], $position);
// Get the token for it
$classNameToken = $file-&gt;getTokens()[$classNamePosition];
// Detect the content of token ends with "Exception"
if (substr($classNamePosition['content'], -strlen('Exception')) === 'Exception')) {
    // the current class ends with "Exception"
    return;
}</code></pre>
<p>When this section passes, we know we have exception without &quot;Exception&quot; suffix there.</p>
<p><strong>Reporting the error</strong></p>
<p>The last method we will use is <code>addFixableError()</code>.</p>
<p>In pseudo code:</p>
<pre><code class="language-php">$file-&gt;addFixableError(
    'Infomative message about error',
    'Where is the token with invalid content',
    'ID of this Sniff to display in error report - class or some string'
);</code></pre>
<p>In out case:</p>
<pre><code class="language-php">$file-&gt;addFixableError(
    'An exception class should have "Exception" suffix.',
    $position - 2,
    self::class
);</code></pre>
<p>Tada!</p>
<h3 id="6-Put-Together-The-Final-Sniff">6. Put Together The Final Sniff</h3>
<p>And extract <code>stringEndsWith()</code> method to make code more readable.</p>
<pre><code class="language-php">use PHP_CodeSniffer\Sniffs\Sniff;

final class ExceptionNameSniff implements Sniff
{
    /**
     * @return int[]
     */
    public function register(): array
    {
        return [T_EXTENDS];
    }

    public function process(File $file, $position): void
    {
        $parentClassNamePosition = $file-&gt;findNext([T_STRING], $position);
        $parentClassNameToken = $file-&gt;getTokens()[$parentClassNamePosition];

        // Does it ends with "Exception"?
        if (! $this-&gt;stringEndsWith($parentClassNameToken['content'], 'Exception')) {
            // The parent class it not and exception, neiter it this
            return;
        }

        $classNamePosition = $file-&gt;findPrevious([T_STRING], $position);
        $classNameToken = $file-&gt;getTokens()[$classNamePosition];
        if ($this-&gt;stringEndsWith($classNamePosition['content'], 'Exception')) {
            // The current class ends with "Exception", it's ok
            return;
        }

        $file-&gt;addFixableError('An exception class should have "Exception" suffix.', $position - 2, self::class)
    }

    private function stringEndsWith(string $name, string $needle): bool
    {
        return (substr($name, -strlen($needle)) === $needle);
    }
}</code></pre>
<p>You can find <a href="https://github.com/symplify/symplify/blob/eeeaab688f6b349e55ab0b3179749dc9e5e49035/packages/CodingStandard/src/Sniffs/Naming/ExceptionNameSniff.php">final Sniff on Github</a> and use it right away of course.</p>
<h2 id="How-to-run-it">How to run it?</h2>
<p>With <a href="https://github.com/symplify/easy-coding-standard">ECS</a> put the class to <code>ecs.php</code>:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
use Symplify\CodingStandard\Sniffs\Naming\ExceptionNameSniff;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();
    $services-&gt;set(ExceptionNameSniff::class);
};</code></pre>
<p>And run:</p>
<pre><code class="language-bash">vendor/bin/ecs check src</code></pre>
<p>Congrats to your first sniffs! How do you like it?</p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/07/17/how-to-write-custom-sniff-for-code-sniffer-3</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 17 Jul 2017 00:00:00 +0000</pubDate>
                                    <updated>2020-08-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Aug 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Aug 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/07/17/how-to-write-custom-sniff-for-code-sniffer-3#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Deprecate PHP Package Without Leaving Anyone Behind ]]></title>
                <link>https://tomasvotruba.com/blog/2017/07/03/how-to-deprecate-php-package-without-leaving-anyone-behind</link>
                <description><![CDATA[ <p>You create PHP open-source packages because you personally use them in your projects. <strong>And you take care of them.</strong>
In time you change a job or switch a programming language and you don't have time to take care of them properly. Number of issues and PRs grows and <strong>package is getting obsolete</strong>.
<br><br>
You can do 2 things in this situation: nothing like most people do or <strong>take responsibility, deprecate package and inform your users about better alternative</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Why-Care-About-Deprecation-as-a-Maintainer">Why Care About Deprecation as a Maintainer</h2>
<p>I created over 10 packages for <a href="https://nette.org">Nette</a> in the past under <em>Zenify</em> namespace. I used them in my projects extensively and they were growing in downloads. Then I switched to <a href="https://symfony.com">Symfony</a> and I worked mostly with Symfony projects.</p>
<p>If I tell you this in person, you'd know that future of <em>Zenify</em> is not based on daily usage of it's author and you'd consider switching to concurrent packages.</p>
<p><strong>The thing is: 95 % of users of your package don't know about your personal development and life path. They use <code>composer require vendor/package-name</code> and that's it.</strong> Of course, few people follow issues and PRs around your package and they might notice 6-months gap in activity.</p>
<h3 id="Open-Source-Holidays">Open-Source Holidays</h3>
<p>But in open-source these <em>pauses</em> are normal: you need to finish your work project, focus on boost of another package, you have some personal or family events (wedding, newborn child, break-up, moving to another country etc.), so you take a break.</p>
<p><strong>6-months pause gap and 6-months end-of-development pause look the same. But they are way different.</strong></p>
<p>This is the second case.</p>
<p>As <a href="https://www.amazon.com/No-More-Mr-Nice-Guy/dp/0762415339">No more Mr. Nice Guy</a> would say:</p>
<h2 id="Don-t-do-Anything-in-Secret">Don't do Anything in Secret</h2>
<h3 id="A-If-you-DON-T-inform-people-they-might">A. If you DON'T inform people, they might:</h3>
<ul>
<li>build new open-source or application that depends <strong>on non-supported package</strong></li>
<li>integrate your package deeply in their architecture</li>
<li><strong>promote bad practice</strong> that you don't support anymore but don't have time to put them in the package</li>
<li><strong>wait in darkness</strong> thinking &quot;Author is on a vacation&quot;</li>
</ul>
<h3 id="B-If-you-DO-inform-people-they-will">B. If you DO inform people, they will:</h3>
<ul>
<li><strong>be informed</strong> - either notified by composer or on your blog (I will your show how later)</li>
<li><strong>know</strong> what part of their application won't be upgraded anymore</li>
<li><strong>be able to plan</strong> next upgrade much better</li>
</ul>
<p><br></p>
<img src="/assets/images/posts/2017/deprecate/trust.jpg" class="img-thumbnail">
<h2 id="Packages-like-Relationships-Stand-on-Trust">Packages like Relationships Stand on Trust</h2>
<p>You have a meeting with a friend on Saturday on his birthday party. During the week you got close with a girl you like and you'd like to spend a weekend with her, because it's great opportunity to get to know her better. But what about your friend?</p>
<p>You can either:</p>
<ul>
<li>A. Wait it out and don't tell him anything. He probably wouldn't even notice.</li>
<li>B. Call him, explain the situation and let him know, you'll come next week as alternative.</li>
</ul>
<p><em>What would you choose if you were your friend?</em></p>
<p>Actually, <strong>B builds foundations of great and strong relationship</strong>, because people know they can trust you if anything difficult ever happens between you.</p>
<h2 id="Deprecate-Package-Delete-Package">Deprecate Package !== Delete Package</h2>
<p>I thought when I deprecate package, application who use it as a dependency stops working. This could be <strong>caused by deleting a package</strong>, but not by deprecating it. Imagine <strong>dropping from level 50 to 20</strong>.</p>
<p><strong>Deprecating a package</strong> is like <strong>having level 50 and staying there</strong> forever. It will never be worse, but it won't be better either. Deprecation won't break anything and won't improve anything.</p>
<p><a href="https://seld.be/notes/php-versions-stats-2016-2-edition"></p>
<img src="https://seld.be/images/update-reqs.png" class="img-thumbnail">
<p></a></p>
<p>It works the same for releases. When you release version 2.0 that <a href="/blog/2017/06/05/go-php-71/">requires PHP 7.1</a>, it doesn't mean your package won't work on PHP 5.6. Version 1.0 still does.</p>
<h2 id="3-Steps-To-Perform-Safe-Deprecation">3 Steps To Perform Safe Deprecation</h2>
<h3 id="1-Explain-Why">1. Explain Why</h3>
<p>&quot;This package is deprecated&quot; isn't satisfying, is it?</p>
<p>It's common psychological effect that people accept change with <a href="https://startwithwhy.com"><strong>an explanation behind it</strong></a> more than without it.</p>
<h3 id="2-Suggest-Replacement">2. Suggest Replacement</h3>
<p>Software develops all the time. New and better packages are born everyday.
It so much helpful if you suggest a way to go. It doesn't have to share 100 % features of your package. <strong>A package that you'd use if your package won't exist is fine</strong>.</p>
<p>You can combine both <a href="/blog/2016/03/10/autowired-controllers-as-services-for-lazy-people/">like this</a>:</p>
<blockquote>
<p>Since Symfony 3.3 you can use PSR4-based service discovery and registration. It does pretty much the
same thing - registers autowired controllers (and more) - and it has native support in Symfony.</p>
<p>I recommend using it instead!</p>
</blockquote>
<h3 id="3-Inform-People-on-All-Possible-Places-They-can-Meet-Your-Package">3. Inform People on All Possible Places They can Meet Your Package</h3>
<p>How many places are there to get in contact with your package? Programmer A added package to his composer, programmer B read about it on Github, programmer C saw a blog post that your wrote about it.</p>
<p>To make sure there are no deprecation leaks, put a sign on all sources:</p>
<p><br></p>
<p><strong>Packagist</strong></p>
<ul>
<li>
<p>Go to your package on Packagist, in my case <a href="https://packagist.org/packages/symplify/symfony-event-dispatcher">symplify/symfony-event-dispatcher</a></p>
</li>
<li>
<p>Hit &quot;Abandon&quot; button</p>
<img src="/assets/images/posts/2017/deprecate/packagist-abandon.png" class="img-thumbnail">
</li>
<li>
<p>Pick a replacement</p>
<img src="/assets/images/posts/2017/deprecate/packagist-replacement.png" class="img-thumbnail">
</li>
<li>
<p>And confirm</p>
<img src="/assets/images/posts/2017/deprecate/packagist-abandoned.png" class="img-thumbnail">
</li>
</ul>
<p>Now you hope that everybody is going to packagist to check if any of packages they're using are abandoned and seek their replacement... No it's not so painful.</p>
<p>Composer will tell you for every <code>composer require/update</code> that includes this package from now on:</p>
<img src="/assets/images/posts/2017/deprecate/composer-info.png" class="img-thumbnail">
<p><br></p>
<p><strong>Github Repository</strong></p>
<p>The best way to make people know the package is deprecated on Github <strong>is not by a note in <code>README</code></strong>. Nobody reads readme if he doesn't use the package first time. Note in a description is also small to spot.</p>
<p>Much more effective <strong>by changing an organization</strong>.</p>
<p>(And if you still need an access to the package, let me know. I'll add it for you.)</p>
<ul>
<li>
<p>Go to your package on Github, in my case <a href="https://github.com/Symplify/SymfonyEventDispatcher">Symplify/SymfonyEventDispatcher</a></p>
</li>
<li>
<p>Go to <em>Settings</em></p>
</li>
<li>
<p>Scroll down to <em>Danger Zone</em> and Pick <em>Transfer</em></p>
<img src="/assets/images/posts/2017/deprecate/github-danger-zone.png" class="img-thumbnail">
</li>
<li>
<p>Fill in the package name and <a href="https://github.com/DeprecatedPackages">&quot;DeprecatedPackages&quot; organization</a></p>
<img src="/assets/images/posts/2017/deprecate/github-transfer.png" class="img-thumbnail">
</li>
<li>
<p>And you're done!</p>
</li>
</ul>
<p>This is the most obvious way to let people know on Github.</p>
<p>If this process is too difficult for you, you can <a href="https://github.com/DeprecatedPackages/ControllerAutowire#controller-autowire---deprecated-in-core-of-symfony-33">add a &quot;deprecated&quot; note to README title</a> as well.</p>
<p><strong>The League of Deprecated Packages</strong></p>
<p><a href="https://github.com/DeprecatedPackages"></p>
<img src="https://avatars0.githubusercontent.com/u/22506867?v=3&s=200" class="img-thumbnail">
<p></a></p>
<p><em>Thanks to <a href="https://f3l1x.io">Milan Šulc</a> for making this beautiful logo that tells all the story.</em></p>
<p>I've come with this organization a year ago, when me and my friends needed to deprecate more package together. As some of you already figured out, it's a place to put all deprecated packages into.</p>
<p><br></p>
<p><strong>Blog Post(s) about Package</strong></p>
<p>One the most underestimated places is a blog post. I consider it the most important place for people who don't know the package yet, but might start using it. I'd feel bad if people would start using package <strong>after I deprecated them</strong>, instead of reaching out for the replacement right away.</p>
<p>I've <a href="https://github.com/TomasVotruba/tomasvotruba.com/pull/88">created a simple warning system</a> on my blog:</p>
<ul>
<li>
<p>Open post about the package.</p>
</li>
<li>
<p>Add warning above the perex with reasoning and suggested replacement:</p>
<img src="/assets/images/posts/2017/deprecate/blog-deprecate-note.png" class="img-thumbnail">
</li>
<li>
<p>Profit! Thousands of programmer pain-hours saved.</p>
</li>
</ul>
<h2 id="What-s-in-it-For-You-as-Maintainer">What's in it For You as Maintainer?</h2>
<p>This all you do is for package users - what a great and altruistic person you are!
<strong>But it has one great upside for you as well.</strong> When I've <a href="/blog/2017/05/29/symplify-packages-deprecations-brought-by-symfony-33/">deprecated 5 of Symplify packages</a> I was sad to lose a legacy, my baby, my work... <strong>But it's worth it!</strong></p>
<p>In following weeks I found:</p>
<ul>
<li>I have <strong>more energy</strong> to work on the rest of packages,</li>
<li>I have <strong>much less responsibility</strong> so I can breathe more lightly,</li>
<li>and I can put more work into less projects</li>
</ul>
<p>Thanks to that, I've <a href="/blog/2017/05/03/combine-power-of-php-code-sniffer-and-php-cs-fixer-in-3-lines/">added new features to ECS</a>, released <a href="/blog/2017/06/26/php-object-calisthenics-rules-made-simple-version-3-0-is-out-now/">Object Calisthenics Coding Standard 3.0</a> and <a href="https://github.com/ApiGen/ApiGen/releases/tag/v5.0.0-RC2">released ApiGen 5.0-RC2</a>. The last one is secret in progress, so don't tell anybody.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/07/03/how-to-deprecate-php-package-without-leaving-anyone-behind</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 03 Jul 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/07/03/how-to-deprecate-php-package-without-leaving-anyone-behind#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ PHP Object Calisthenics Made Simple - Version 3.0 is Out Now ]]></title>
                <link>https://tomasvotruba.com/blog/2017/06/26/php-object-calisthenics-rules-made-simple-version-3-0-is-out-now</link>
                <description><![CDATA[ <p>Object Calisthenics are 9 language-agnostic rules to help you write better and cleaner code.
They help you to get rid of &quot;else&quot; statements, method chaining, long classes or functions, unreadable short names and much more.
<br><br>
<strong>Object Calisthenics 3.0 runs on CodeSniffer 3.0 and PHP 7.1. It brings 6 of them with fancy configuration and code examples</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>If you are a coding standard nerd like me, you'll probably have more than just PSR-2 standard in your ruleset. But even if you don't, <a href="https://github.com/object-calisthenics/phpcs-calisthenics-rules">Object Calisthenics</a> is a developer-friendly game changer for your code.</p>
<h2 id="Much-Simpler-than-2-0">Much Simpler than 2.0</h2>
<p><strong>1. You don't have to know a single thing about coding standards to start</strong></p>
<p><strong>2. Simple to install</strong></p>
<pre><code class="language-bash">composer require object-calisthenics/phpcs-calisthenics-rules</code></pre>
<p><strong>3. You can start with 1 sniff</strong></p>
<p>Quick quiz: what is this variable?</p>
<pre><code class="language-php">$this-&gt;di-&gt;...;</code></pre>
<p><em>Dependency Injection? Dependency Injection Container?</em> Who would guess it's <em>Donation Invoice</em>!</p>
<p><strong><a href="https://github.com/object-calisthenics/phpcs-calisthenics-rules#6-do-not-abbreviate">Rule #6 - Do Not Abbreviate</a></strong> checks these cases. <strong>It detects short names that are ambiguous and hard to decode.</strong></p>
<p>For a quick check, just run the full config:</p>
<pre><code class="language-bash">vendor/bin/ecs check src --config vendor/object-calisthenics/phpcs-calisthenics-rules/config/object-calisthenics.yml</code></pre>
<p>You can run this locally or put to your CI and you are ready to go.</p>
<h2 id="Fancy-Readme-With-Examples">Fancy Readme With Examples</h2>
<p>We put lots of work to README for the new release. It isn't a long text describing what exactly the rule does and how it originated - there is already <a href="http://williamdurand.fr/2013/06/03/object-calisthenics">a blog post for that</a>.</p>
<p>Instead, README goes right to the point:</p>
<ul>
<li><strong>YES and NO code snippets</strong>,</li>
<li><strong>how to use them</strong> - copy/paste CLI command</li>
<li>and <strong>how to configure them</strong> - link to particular config lines</li>
</ul>
<img src="/assets/images/posts/2017/object-calisthenics/rule6.png" class="img-thumbnail">
<h3 id="Configure-What-You-Need">Configure What You Need</h3>
<p>As you can see in the bottom part of screenshot, most of rules are configurable. It allows you <strong>to adapt their strictness to your specific needs and needs of your project</strong>.</p>
<p><em>Do you prefer to require min 4 chars?</em></p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();
    $services-&gt;set('ObjectCalisthenics\Sniffs\NamingConventions\ElementNameMinimalLengthSniff')
        -&gt;property('minLength', 4);
};</code></pre>
<p><em>Do you want to add own allowed short names?</em></p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();

    // Rule 6: Do not abbreviate
    $services-&gt;set(ObjectCalisthenics\Sniffs\NamingConventions\ElementNameMinimalLengthSniff::class)
        -&gt;property('minLength', 4)
        // default: ["i", "id", "to", "up"]
        -&gt;property('allowedShortNames', ['y', 'i', 'id', 'to', 'up']);
};</code></pre>
<h3 id="Minitip-What-Can-You-Configure-in-Particular-Sniff">Minitip: What Can You Configure in Particular Sniff?</h3>
<ul>
<li>Open <code>ElementNameMinimalLengthSniff</code> class in your IDE.</li>
<li><strong>Look for public properties</strong>. CodeSniffer uses them to set any configuration.</li>
</ul>
<p>That was Rule 6.</p>
<h2 id="5-more-Rules">5 more Rules</h2>
<h3 id="1-Only-X-Level-of-Indentation-per-Method">1. Only X Level of Indentation per Method</h3>
<p>❌</p>
<pre><code class="language-php">foreach ($sniffGroups as $sniffGroup) {
    foreach ($sniffGroup as $sniffKey =&gt; $sniffClass) {
        if (! $sniffClass instanceof Sniff) {
            throw new InvalidClassTypeException;
        }
    }
}</code></pre>
<p>✅</p>
<pre><code class="language-php">foreach ($sniffGroups as $sniffGroup) {
    $this-&gt;ensureIsAllInstanceOf($sniffGefroup, Sniff::class);
}

// ...
private function ensureIsAllInstanceOf(array $objects, string $type)
{
    // ...
}</code></pre>
<h3 id="2-Do-Not-Use-and-quot-else-and-quot-Keyword">2. Do Not Use &quot;else&quot; Keyword</h3>
<p>❌</p>
<pre><code class="language-php">if ($status === self::DONE) {
    $this-&gt;finish();
} else {
    $this-&gt;advance();
}</code></pre>
<p>✅</p>
<pre><code class="language-php">if ($status === self::DONE) {
    $this-&gt;finish();
    return;
}

$this-&gt;advance();</code></pre>
<h3 id="5-Use-Only-One-Object-Operator-and-gt-per-Line">5. Use Only One Object Operator (<code>-&gt;</code>) per Line</h3>
<p>❌</p>
<pre><code class="language-php">$this-&gt;container-&gt;getBuilder()-&gt;addDefinition(SniffRunner::class);</code></pre>
<p>✅</p>
<pre><code class="language-php">$containerBuilder = $this-&gt;getContainerBuilder();
$containerBuilder-&gt;addDefinition(SniffRunner::class);</code></pre>
<h3 id="7-Keep-Your-Classes-Small">7. Keep Your Classes Small</h3>
<p>❌</p>
<pre><code class="language-php">class SimpleStartupController
{
    // 300 lines of code
}</code></pre>
<p>✅</p>
<pre><code class="language-php">class SimpleStartupController
{
    // 50 lines of code
}</code></pre>
<p>❌</p>
<pre><code class="language-php">class SomeClass
{
    public function simpleLogic()
    {
        // 30 lines of code
    }
}</code></pre>
<p>✅</p>
<pre><code class="language-php">class SomeClass
{
    public function simpleLogic()
    {
        // 10 lines of code
    }
}</code></pre>
<p>❌</p>
<pre><code class="language-php">class SomeClass
{
    // 20 properties
}</code></pre>
<p>✅</p>
<pre><code class="language-php">class SomeClass
{
    // 5 properties
}</code></pre>
<p>❌</p>
<pre><code class="language-php">class SomeClass
{
    // 20 methods
}</code></pre>
<p>✅</p>
<pre><code class="language-php">class SomeClass
{
    // 5 methods
}</code></pre>
<h3 id="9-Do-not-Use-Getters-and-Setters">9. Do not Use Getters and Setters</h3>
<p>Classes should not contain public properties.</p>
<p>❌</p>
<pre><code class="language-php">class ImmutableBankAccount
{
    public $currency = 'USD';</code></pre>
<p>✅</p>
<pre><code class="language-php">class ImmutableBankAccount
{
    private $currency = 'USD';</code></pre>
<p>Method should represent behavior, not set values.</p>
<p>❌</p>
<pre><code class="language-php">    private $amount;

    public function setAmount(int $amount)
    {
        $this-&gt;amount = $amount;
    }
}</code></pre>
<p>✅</p>
<pre><code class="language-php">    private $amount;

    public function withdrawAmount(int $withdrawnAmount)
    {
        $this-&gt;amount -= $withdrawnAmount;
    }
}</code></pre>
<p>Check <a href="https://github.com/object-calisthenics/phpcs-calisthenics-rules#implemented-rule-sniffs">the README</a> to see how to use them and configure them.</p>
<h2 id="9-and-ndash-6-3-Where-is-the-Rest-of-Rules">9 &ndash; 6 = 3... Where is the Rest of Rules?</h2>
<p>There are 3 more rules to complete the list from <a href="https://www.amazon.com/ThoughtWorks-Anthology-Technology-Innovation-Programmers/dp/193435614X">the original manifesto</a>:</p>
<ol start="3">
<li>Wrap Primitive Types and Strings</li>
<li>Use First Class Collections</li>
<li>Do Not Use Classes With More Than Two Instance Variables</li>
</ol>
<p>They are mostly related to DDD (<a href="https://github.com/dddinphp">Domain Driven Design</a>), <a href="https://github.com/object-calisthenics/phpcs-calisthenics-rules#not-implemented-rules---too-strict-vague-or-annoying">too strict to use in practise or too vague to cover them with semantic rule</a>.</p>
<h2 id="Thanks-to-all-Contributors">Thanks to all Contributors</h2>
<p>Last but not least, I'd like to personally thank contributors who helped to make this version happen as it is:</p>
<ul>
<li><a href="https://github.com/frenck">@frenck</a></li>
<li><a href="https://github.com/mihaeu">@mihaeu</a></li>
<li><a href="https://github.com/roukmoute">@roukmoute</a></li>
<li><a href="https://github.com/UFOMelkor">@UFOMelkor</a></li>
</ul>
<p>Without your help, this would not have been possible.
Thank you guys.</p>
<h2 id="To-Sum-up-Object-Calisthenics-3-0">To Sum up Object Calisthenics 3.0</h2>
<ul>
<li><strong>Simple setup over boring academic explanations</strong>.</li>
<li>Rules are <em>explained in examples</em>.</li>
<li>0-setup. You can just <strong>copy-paste CLI commands and run it</strong>.</li>
<li>You can choose a <strong>level of strictness that suits you</strong> thanks to flexible configuration.</li>
</ul>
<p>To find more details about this release see <a href="https://github.com/object-calisthenics/phpcs-calisthenics-rules/releases/tag/v3.0.0">Release notes on Github</a>.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/06/26/php-object-calisthenics-rules-made-simple-version-3-0-is-out-now</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 26 Jun 2017 00:00:00 +0000</pubDate>
                                    <updated>2020-08-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Aug 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Aug 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/06/26/php-object-calisthenics-rules-made-simple-version-3-0-is-out-now#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Symbiotic Controller: Nette Presenter with Freedom ]]></title>
                <link>https://tomasvotruba.com/blog/2017/06/19/symbiotic-controller-nette-presenter-with-freedom</link>
                <description><![CDATA[ <p>Symfony and Laravel allow decoupled controllers by default thanks to simple principle: <em>controller/presenter = callback</em>. No base class or interface is needed.</p>
<p>People around me are already using single action presenters, but still depend on Nette. Why? Coupling of <code>IPresenter</code> in Application and Router.</p>
<p>I think framework should help you and not limit you in a way how you write your code. <strong>Today we look how to make that happen even for Nette presenters and how to set them free</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="3-Misconceptions-First">3 Misconceptions First</h2>
<p>When I talked about <a href="https://www.facebook.com/pehapkari/videos/1285464581503349">single action or rather invokable presenters in Nette</a> on 87. Posobota meetup in Prague, <strong>people were talking about 3 missconceptions</strong>. I'd like clarify them first.</p>
<h3 id="1-Nette-needs-IPresenter">1. Nette needs <code>IPresenter</code></h3>
<p>My first attempt decouple presenter from Nette <a href="https://github.com/nette/application/blob/0941b6b7023a43ddd0627ad5ac3ffba606709ef5/src/Application/PresenterFactory.php#L78-L79">failed on <code>PresenterFactory</code></a>:</p>
<pre><code class="language-php">// ...
if (!$reflection-&gt;implementsInterface(IPresenter::class)) {
    throw new InvalidPresenterException("Cannot load presenter '$name', class '$class' is not Nette\\Application\\IPresenter implementor.");
}</code></pre>
<p>This took me few weeks to figure out because of coupling to latte, providers and layout autodiscovery.
I needed to modify <code>PresenterFactory</code>, <code>Application-&gt;run()</code> and create own <code>PresneterRoute</code>.</p>
<p><strong>So yes, when you modify few places, you can use it without <code>IPresenter</code> interface.</strong></p>
<h3 id="2-What-about-ajax-What-about-Components">2. What about ajax? What about Components?</h3>
<p><strong>If you use ajax and components, this approach is not probably for you application</strong>.</p>
<p>I thought it's impossible to use Nette without components as well, but <a href="https://ondrej.mirtes.cz">Ondrej Mirtes</a> from Slevomat take me out of my misery: &quot;We don't use components in Slevomat, just presenters.&quot; So feel free to ask him how they do it.</p>
<p><strong>You'll appreciate this approach in applications, where</strong>:</p>
<ul>
<li>frontend is managed not by Nette ajax, but by <strong>ReactJS, Angular or any other frontend framework</strong></li>
<li><strong>API, Rest or GraphQL</strong> is the main entry point to the application</li>
<li>your application is growing and you want to <strong>avoid god classes like presenters with 10 actions methods</strong> in next couple of years</li>
</ul>
<h3 id="3-There-should-be-an-Interface-for-that">3. There should be an Interface for that</h3>
<p>Even when some people agreed with invokable/single action approach, they still missed some interface that would enforce a method. I must say <code>__invoke()</code> method seemed weird to me at first too.</p>
<p><strong>Give <code>invoke()</code> a try, it's Fine</strong></p>
<p>But I've learned what <a href="https://php.net/manual/en/language.oop5.magic.php#object.invoke"><code>__invoke()</code> is</a> and that <a href="https://symfony.com/doc/current/controller/service.html#invokable-controllers">Symfony</a> and <a href="https://laravel.com/docs/5.4/controllers#single-action-controllers">Laravel use</a> it for years.</p>
<p>Also, <strong>using an interface would only create a new dependency</strong> for something that is already used in specific way. Moreover for controller which <a href="https://book.cakephp.org/2.0/en/controllers.html#controller-actions">every</a> <a href="http://www.yiiframework.com/doc-2.0/guide-structure-controllers.html#actions">framework</a> <a href="https://book.cakephp.org/3.0/en/controllers.html">bend</a> <a href="https://laravel.com/docs/5.4/controllers#defining-controllers">to</a> <a href="https://doc.nette.org/en/2.4/presenters#toc-processing-presenter-action">its</a> <a href="https://symfony.com/doc/current/best_practices/controllers.html#what-does-the-controller-look-like">own</a> needs.</p>
<p><code>__invoke()</code> is normal method, just like <code>__constructor()</code> is normal for passing dependencies nowadays.</p>
<h2 id="Inspiration-from-Symfony-Community-Matthias-Noback-and-amp-Kevin-Dunglas">Inspiration from Symfony Community - Matthias Noback &amp; Kevin Dunglas</h2>
<p><strong>Why Decouple Controller From Framework?</strong></p>
<p>If you look for reasons to decouple from framework, read <a href="https://php-and-symfony.matthiasnoback.nl/tags/controller">this 3 parts series: Framework Independent Controllers</a> by <a href="https://matthiasnoback.nl">Matthias Noback</a> about independent controllers in Symfony.</p>
<p><strong>Why are Single Action Presenters Great for Growing Projects?</strong></p>
<p>Similar <a href="https://dunglas.fr/2016/01/dunglasactionbundle-symfony-controllers-redesigned">package and post</a> was made by Kevin Dunglas exactly 1,5 year ago. You'll find your answers there.</p>
<p>No more questions, right to the code.</p>
<h2 id="How-Single-Action-Controller-looks-like">How Single Action Controller looks like?</h2>
<p>The goal was:</p>
<ul>
<li><strong>don't depend on any interface or class</strong></li>
<li>have <strong>1 public method</strong> <code>__invoke()</code></li>
</ul>
<p>Ideal code for Nette-agnostic presenter would look like this:</p>
<pre><code class="language-php">namespace App\Presenter;

use Symplify\SymbioticController\Adapter\Nette\Template\TemplateRenderer;

final class StandalonePresenter
{
    /**
     * @var TemplateRenderer
     */
    private $templateRenderer;

    public function __construct(TemplateRenderer $templateRenderer)
    {
        $this-&gt;templateRenderer = $templateRenderer;
    }

    public function __invoke(): string
    {
        return $this-&gt;templateRenderer-&gt;renderFileWithParameters(
            __DIR__ . '/templates/Contact.latte'
        );
    }
}</code></pre>
<p>Or if you use API and json:</p>
<pre><code class="language-php">namespace App\Presenter;

use Nette\Application\Responses\JsonResponse;

final class ApiPresenter
{
    public function __invoke(): JsonResponse
    {
        return new JsonResponse('Hi!');
    }
}</code></pre>
<h3 id="Clickable-template-paths-as-Positive-Side-Effect">Clickable template paths as Positive Side-Effect</h3>
<p><code>Module:Presenter:template</code> =&gt; <code>__DIR__ . '/templates/template.latte</code></p>
<p>Instead of using magic notation, you can go right with absolute path for templates.</p>
<p>If this would be used by every controller and framework, there would be much lower entry barrier for front-end developers. Another new way to use your IDE the right-way:</p>
<div class="text-center">
    <img src="/assets/images/posts/2017/symbiotic-controller/presenter.gif" class="img-thumbnail">
</div>
<h2 id="And-Router">And Router?</h2>
<p>But how to register this presenter in router? Since the called action is now <em>not a method in a class</em> but <em>a class</em>, we cannot use common way to add route:</p>
<pre><code class="language-php"># this won't work
$routes[] = new Route('/contact', 'Contact:default');
$routes[] = new Route('/contact', 'Contact:__invoke');</code></pre>
<p>We need to use presenter as target:</p>
<pre><code class="language-php">use App\Presenter\ContactPresenter;

$routes[] = new Route('/contact', ContactPresenter::class);</code></pre>
<p>But that won't work either as <code>Route</code> class requires <code>&lt;presenter&gt;:&lt;method&gt;</code> format for target.</p>
<h3 id="Presenter-Route">Presenter Route</h3>
<p>To solve this, <strong>we'll use custom Route that accepts Presenter class as argument</strong>.</p>
<pre><code class="language-php"># app/Router/RouterFactory.php

use App\Presenter\ContactPresenter;
use Symplify\SymbioticController\Adapter\Nette\Routing;

final class RouterFactory
{
    public function create(): RouteList
    {
        $routes = new RouteList;
        $routes[] = new PresenterRoute('/contact', ContactPresenter::class);
        $routes[] = new Route('&lt;presenter&gt;/&lt;action&gt;', 'Homepage:default');

        return $routes;
    }
}</code></pre>
<p>It has 2 important tasks:</p>
<ul>
<li><strong>it validates that class has <code>__invoke()</code> method</strong></li>
<li>you can <strong>click right to the presenter class</strong> in your IDE</li>
</ul>
<h2 id="From-Stringly-Route-to-Strongly-Route">From Stringly Route to Strongly Route</h2>
<p>Same way you can use your IDE to open the template, you can use it to open presenter target.</p>
<p>From magic <code>Homepage:default</code> to clickable class:</p>
<div class="text-center">
    <img src="/assets/images/posts/2017/symbiotic-controller/router.gif" class="img-thumbnail">
</div>
<h2 id="3-Steps-To-Your-First-Framework-Agnostic-Presenter-in-Nette">3 Steps To Your First Framework Agnostic Presenter in Nette</h2>
<h3 id="1-Install-Symplify-SymbioticController-package">1. Install <a href="https://github.com/DeprecatedPackages/SymbioticController">Symplify\SymbioticController</a> package</h3>
<pre><code class="language-yaml">composer require symplify/symbiotic-controller</code></pre>
<h3 id="2-Register-Needed-Extensions">2. Register Needed Extensions</h3>
<pre><code class="language-yaml"># app/config/config.neon

extensions:
    - Symplify\SymbioticController\Adapter\Nette\DI\SymbioticControllerExtension
    - Contributte\EventDispatcher\DI\EventDispatcherExtension</code></pre>
<h3 id="3-Create-Your-Presenter-and-Use-It">3. Create Your Presenter and Use It</h3>
<p>That's all :)</p>
<h2 id="Takeaways">Takeaways</h2>
<ul>
<li>Using framework agnostics controllers has its use cases. <strong>The best are: API, backend-mostly and fast growing applications</strong>.</li>
<li>Don't be afraid of <code>__invoke()</code>. It is your friend, mainly for future.</li>
<li><strong>Use Strong types over String types and forget the magic</strong>.</li>
</ul>
<h3 id="How-do-YOU-approach-using-controller-in-Nette">How do YOU approach using controller (in Nette)?</h3>
<ul>
<li>Do you use components?</li>
<li>Do you know why you depend on Nette?</li>
<li>Do you try some other approach than traditional one?</li>
</ul>
<p>Let me know in the comments. I always like to hear different opinions.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/06/19/symbiotic-controller-nette-presenter-with-freedom</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 19 Jun 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/06/19/symbiotic-controller-nette-presenter-with-freedom#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Require Minimal Code Coverage for Github Pull-Requests with Coveralls ]]></title>
                <link>https://tomasvotruba.com/blog/2017/06/12/how-to-require-minimal-code-coverage-for-github-pull-requests-with-coveralls</link>
                <description><![CDATA[ <p>Do you maintain tested open-source project? Are you sad of your code-coverage decreasing over time in wave of pull-requests? <strong>Are you tired of telling &quot;could you add tests&quot;</strong>?
<br><br>
I will show you how to let Travis and Coveralls do this job for you.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Why-Code-Coverage-Shouldn-t-be-Ignored">Why Code Coverage Shouldn't be Ignored</h2>
<p><a href="https://twitter.com/Ocramius">Marco Pivetta</a> wrote a post about <a href="https://ocramius.github.io/blog/automated-code-coverage-check-for-github-pull-requests-with-travis">automated code coverage check with PHPUnit</a> few years ago. In the post he explains <strong>how important is code coverage for code quality of open-source projects</strong>:</p>
<blockquote>
<p>&quot;[Code Coverage] is <strong>not an universal metric to define if our code works</strong>, and there is tons of examples of how your code can still be buggy even if every line of code was executed at least once. It should anyway not be ignored, and <strong>it is up to us to decide</strong> how hard we want to test each part of our application.&quot;</p>
</blockquote>
<h3 id="He-shows-setup-for-Travis-CI-that-will">He shows setup for Travis CI, that will</h3>
<ul>
<li>generate <code>coverage.xml</code> with phpunit</li>
<li>computed total coverage in % with PHP script</li>
<li>check it against your minimal requirement</li>
<li>fails CI if it is lower than that</li>
</ul>
<img src="/assets/images/posts/2017/coveralls/coverage-checker.png" class="img-thumbnail">
<p>Simple setup to let computer handle &quot;please, add tests&quot; response for you.</p>
<h2 id="and-quot-Setup-and-forget-and-quot">&quot;Setup and forget&quot;</h2>
<ul>
<li>You <strong>move responsibility to a tool</strong>, so you don't have to check code coverage for every project of yours manually. <strong>CI looks after  it for you.</strong></li>
<li>You don't have to explain at PRs, that &quot;tests are missing&quot;. <strong>In my experience, less people read <code>CONTRIBUTING.md</code> than red Travis CI error note</strong>.</li>
<li>Let's be honest - do you check your coding standards manually? If so, <a href="https://github.com/symplify/easy-coding-standard">start with this</a>.</li>
</ul>
<h2 id="3-Steps-to-Automate-Minimal-Coverage-Check-With-Coveralls">3 Steps to Automate Minimal Coverage Check With Coveralls</h2>
<p>Nowadays, <a href="http://coveralls.io">Coveralls CI</a> can handle this process completely for you.</p>
<p>Here is how:</p>
<h3 id="1-Create-coveralls-yml">1. Create <code>.coveralls.yml</code></h3>
<pre><code class="language-yaml">service_name: travis-ci
coverage_clover: coverage.xml # file generated by phpunit
json_path: coverage.json # file generated by php-coveralls</code></pre>
<h3 id="2-Send-coverage-xml-to-Coveralls-in-travis-yml">2. Send <code>coverage.xml</code> to Coveralls in <code>.travis.yml</code></h3>
<p>If you already generate coverage with <code>phpunit</code> skip to <code>after_script</code> section.</p>
<pre><code class="language-yaml">language: php

php:
  - 7.1

install:
  - composer install

script:
  - vendor/bin/phpunit --coverage-clover coverage.xml

after_script:
  # upload coverage.xml file to Coveralls to analyze it
  # minimal required coverage is set to 80+ %
  - wget https://github.com/satooshi/php-coveralls/releases/download/v1.0.1/coveralls.phar
  - php coveralls.phar --verbose</code></pre>
<p><em>Performance note: This is the simplest setup with single build. If you run more builds with multiple PHP versions or ENV values, <a href="https://github.com/symplify/symplify/blob/e6ef5aeef11fc292841f204bd7ddcd2a55aace12/.travis.yml#L3-L30">you should run coverage only once</a>, because code coverage uses <code>xdebug</code> extension and thus is very slow.</em></p>
<h3 id="3-Setup-Minimal-Require-Code-Coverage-in-Coveralls-io">3. Setup Minimal Require Code Coverage in Coveralls.io</h3>
<p>Add your repository on <a href="https://coveralls.io">Coveralls.io</a>, go to &quot;Settings&quot; and find &quot;Coverage Threshold fo Failure&quot;.</p>
<img src="/assets/images/posts/2017/coveralls/coveralls-threshold.png" class="img-thumbnail">
<p><strong>There you can put a value you're ok with</strong>. No need to push yourself too hard.
I personally start with coverage bit below current level.</p>
<p>That's all setup you need. Just push your pull-request and see the result.</p>
<h2 id="WTFs-You-Might-Meet">WTFs You Might Meet</h2>
<h3 id="1-and-quot-I-cannot-see-Coveralls-check-under-PR-and-quot">1. &quot;I cannot see Coveralls check under PR&quot;</h3>
<p>Travis or Scrutinizer appear there right after you create a PR, because they're set up as services (<em>Settings → Integrations &amp; Services</em>).</p>
<img src="/assets/images/posts/2017/coveralls/build-checks-scrutinizer.png" class="img-thumbnail">
<p>This is not the case for Coverrals.</p>
<img src="/assets/images/posts/2017/coveralls/report-at-first.png" class="img-thumbnail">
<p>Don't worry, it's there. It will appear when Travis will upload <code>coverage.xml</code> to it:</p>
<pre><code class="language-yaml">after_script:
  # ...
  - php coveralls.phar --verbose</code></pre>
<img src="/assets/images/posts/2017/coveralls/report-after-ping.png" class="img-thumbnail">
<h3 id="2-and-quot-There-is-no-Report-about-Required-Limit-under-PR-and-quot">2. &quot;There is no Report about Required Limit under PR&quot;</h3>
<p>As you can see above if build fails due to low coverage, Coveralls actually <strong>doesn't show the number for required minimal code coverage</strong>.</p>
<p>This is the reason I've put a note to <code>.travis.yml</code>:</p>
<pre><code class="language-yaml">after_script:
  # upload coverage.xml file to Coveralls to analyze it
  # minimal required coverage is set to 80+ %</code></pre>
<p>And yes, <a href="https://github.com/lemurheavy/coveralls-public/issues/982">there is issue for that</a>. Feel free to upvote it or suggest a better solution.</p>
<p>These 2 were surprises for me and took me a while to figure out. Let me know in comments below if you came across any other.</p>
<h2 id="To-Sum-Up">To Sum Up</h2>
<ul>
<li>Coveralls can help you not only with coverage, <strong>but also with its minimal limit</strong>.</li>
<li><strong>Use CI in cases where you can save your attention leaks</strong>. You'll have more time for your friends, family and other joys of life - like coding.</li>
<li>Setup your repository and forget this post.</li>
</ul>
<p>Enjoy your day!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/06/12/how-to-require-minimal-code-coverage-for-github-pull-requests-with-coveralls</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 12 Jun 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/06/12/how-to-require-minimal-code-coverage-for-github-pull-requests-with-coveralls#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Go PHP 7.1! ]]></title>
                <link>https://tomasvotruba.com/blog/2017/06/05/go-php-71</link>
                <description><![CDATA[ <p>PHP frameworks start to require PHP 7.1, leading with Nette 3 and Symfony 4.
<br><br>
Why skip PHP 7.0 and go directly to PHP 7.1? When is the best time to join?
What projects are already &quot;on the move&quot;?</p> ]]></description>
                <content:encoded><![CDATA[ <p><br></p>
<blockquote class="blockquote text-center">
    "Never believe that a few caring people can't change the world.<br>
    For, indeed, that's all who ever have."
    <footer class="blockquote-footer">Margaret Mead</footer>
</blockquote>
<p><br></p>
<h2 id="Why-Go-Right-to-PHP-7-1">Why Go Right to PHP 7.1</h2>
<ul>
<li>
<p>When you migrate your project from 5.x to PHP 7.x, <strong>there is no reason not to jump right to 7.1</strong>. You get more features (like <code>void</code> and nullable types), longer security support and with that, <strong>you will have a longer break from another upgrade</strong>. Are you lazy enough to have a year longer break? I am.</p>
</li>
<li>
<p><strong>Frameworks are migrating</strong>. And let's be honest - huge frameworks are flag ships of evolution. Join them and you won't be left behind.</p>
</li>
<li>
<p>It would be easier to develop open-source, if we were able to agree on one recent PHP version to support.</p>
</li>
</ul>
<p>And I think you are already able to come with few more reasons of your own.</p>
<h2 id="How-to-Move-Hosts">How to Move Hosts?</h2>
<p>As in every new version of PHP, <strong>most of us still <del>depends on</del> waits for hosts to catch up</strong>. The situation was the same with PHP 5. New software version was already there, but hosts took their time. If there would be some way to move this.</p>
<p><strong>And then, a <a href="https://www.garfieldtech.com/blog/go-php-5-go">GoPHP5</a> movement was born, to rapidly speed this up.</strong></p>
<p>Quoting Larry:</p>
<p>&quot;The solution a few people suggested was team work. If all PHP projects stopped supporting PHP 4 and made the jump to PHP 5 at the same time, none of them is penalized in the market for being &quot;first&quot; and web hosts will have a clear business case to upgrade their systems to PHP 5. We can then all start offering faster, cleaner, more powerful, more secure web software.</p>
<p><strong>But how does one get all PHP projects together to agree on something like that? Actually, it's fairly simple. You ask them.</strong>&quot;</p>
<p>Well said.</p>
<h3 id="Go-PHP-7-1-as-One">Go PHP 7.1 as One</h3>
<p>I was reading a post about <a href="https://symfony.com/blog/why-will-symfony-2-0-finally-use-php-5-3">Symfony 2 min version bump 5.3</a>.
It was a huge step in PHP development. Even if PHP 5.3 seem like an prehistoric version, many projects still uses that.</p>
<p>We are in same situation with PHP 7.1 now. <strong>If PHP community can cooperate as one, we are able to create brighter future for ourselves</strong>.</p>
<h2 id="When-and-Who-goPHP71-org">When and Who? goPHP71.org</h2>
<p>To better coordinate min version bump, I've created gophp71.org in last 2 evenings.</p>
<p>There you can see <strong>who and when is bumping min version</strong>.</p>
<img src="/assets/images/posts/2017/go-php-71/first-version.png" class="img-thumbnail">
<h2 id="How-Can-You-Help">How Can You Help?</h2>
<ul>
<li>Do you want to express your support for PHP 7.1?</li>
<li>Do you want to help others to coordinate their package development?</li>
</ul>
<p><strong>If you answered YES at least once, add your framework or package</strong>.</p>
<p>Website is <a href="https://github.com/tomasvotruba/goPHP71.org">hosted on Github Pages</a>, so you just <a href="https://github.com/TomasVotruba/gophp71.org/edit/master/index.html">edit <code>index.html</code></a> and send PR.</p>
<h3 id="Spread-the-Word">Spread the Word</h3>
<p>If you believe in this, share this page so we let hosts know, what we really need. <strong>It's our need to express and responsibility to take.</strong>
We can do it! Thank you.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/06/05/go-php-71</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 05 Jun 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/06/05/go-php-71#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Thank you David Grudl ]]></title>
                <link>https://tomasvotruba.com/blog/2017/06/01/thank-you-david</link>
                <description><![CDATA[ <p>While using open-source, we rarely realize that there is one or few people behind it. <strong>People who work in their free time and put an effort in it</strong>.
We feel like using a product - it should work and when it doesn't, it's broken. And when our application is constantly broken, we will be angry for them.
<br><br>
But if our application is smooth and ready, do we love and say thank you?
<br><br>
I'd like to express <strong>my gratitude and tribute for you, <a href="https://davidgrudl.com/">David</a> - you made my programming life very joyful and curious experience</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>A great friend of mine <a href="http://honzacerny.com">Honza Černý</a> lend me a book <em><a href="http://austinkleon.com/steal">Steal Like An Artist</a></em> few months ago. I'm very grateful for that, because I don't have much art-people in my social circle. You may think, it's about art (so did I), but it's <strong>more about relationships, sharing, caring, showing your vulnerability and cooperation</strong>. And open-source software!</p>
<p>One of lessons that lead me to this was...</p>
<h2 id="Write-Letters-to-Your-Heroes">Write Letters to Your Heroes</h2>
<blockquote>
<p>Often when we write fan letters we’re looking for a blessing or an affirmation.
But if you truly love somebody's work, you shouldn't need a response from them.
Write a blog post about someone's work that you admire and link to their site.
Make something and dedicate it to your hero.
Answer a question they've asked, solve a problem for them or improve their work and share it online.</p>
</blockquote>
<p>After reading this, I had my hero in mind, whom I'd like to write. I also shared this though with <a href="https://github.com/JanMikes">Honza Mikeš</a>, who answered me by showing a beautiful thank you email he wrote.</p>
<p>So here is my turn:</p>
<h2 id="Thank-you-David">Thank you David</h2>
<p>I'd like to really thank you for 3 things you gave me.</p>
<h2 id="Thank-You-for-My-Job">Thank You for My Job</h2>
<p>I'm very grateful you've created Nette and you have been taking care of it for the last 10 years. I could work on many interesting web projects, earn a living from it and learn best practise in open-source. I've been maintaining like dozens of packages for a few years and <strong>I could barely remotely imagine, what it takes to maintain one project mostly by yourself. I envy you your huge persistence and determination</strong>.</p>
<p><strong>Thanks to you, I could bring together 3 things I love the most in the world - people, open-source and education</strong> - and get to teaching, learning and growing a community. I must say it was a relief, because when I was at university, I felt like I could do only programming or only work with people in psychology field.</p>
<h3 id="It-s-easy-to-be-a-leader-isn-t-it">It's easy to be a leader, isn't it?</h3>
<p><strong>I remember one moment, when I got much more respect for you.</strong> We had a social training group at university, when me and 15 more schoolmates went to a cottage near Brno to experience social dynamics in games. So there was a boat. And every person on this boat had his or her role and I was chosen to be the captain of the boat.</p>
<p>I thought it must be easy to be a captain (or Nette creator), <strong>because you can tell people what to do and you can decide mostly by yourself</strong>. Oh how hard lesson was about to come. We sailed over the sea, sun was shining, we had enough food and I was looking at my shiny boat and life was great.</p>
<p>Later, we had a hole in our boat, we started to run out of food and we saw some sharks around us - everybody was asking me: &quot;Captain, what should we do? Where do we go? Captain? Captain?&quot; <strong>I felt so much pressure and had thousand of issues to solve</strong>. My head was about to explode. Even though it was just a game.</p>
<p>In that exact moment I realized that every time I needed something to be changed or fixed or explained in Nette, I was putting my responsibility to you. My &quot;I don't care, you do it&quot; approach was very one-sided. <strong>And I started to see how freaking difficult it must be to manage website, community, meetups, program a software, do lectures, learn PHP in-depth and invent new revolutionary approaches in PHP.</strong></p>
<p><strong>Deep bow to you for all this and I'm sorry for every bad word I spread about your work online or offline. I'd love to take it back, because now I realize it originated from my in-experience with the other side.</strong></p>
<p>Since then, I recommend every programmer to maintain an open-source project for half a year to get similar powerful experience.</p>
<h2 id="Thank-you-for-Joyful-Way-to-Learn-PHP">Thank you for Joyful Way to Learn PHP</h2>
<p>I must say, Nette put a joy to my PHP programming. After all this <code>$_GET</code> and <code>$_POST</code> putting together in 1 file, I could see there is more advanced software that is mostly intuitive and ready to use.</p>
<p><strong>Thanks for explaining principals <a href="https://phpfashion.com/co-je-dependency-injection">Dependency Injection in many blog posts</a></strong>. I realized how only this thing helped me a lot while designing apps and understanding other frameworks. After travelling around European conferences and meetups, <strong>I see this pattern is very advanced in our country and miles ahead compared to other frameworks - thanks to you</strong>.</p>
<h2 id="Thank-you-for-Showing-me-That-Programming-Can-Be-Fun">Thank you for Showing me That Programming Can Be Fun</h2>
<p>Last but not least, <strong>I really enjoy your talks</strong>. Because they are not usually tech talks - deep, long, boring or complex. <strong>You are very funny and that's what makes you great teacher.</strong></p>
<p>&quot;They best way to learn something is to learn without knowing it.&quot;</p>
<p>I don't know any speaker similar to you who could do such a performance. And also these <a href="https://phpfashion.com/pet-duvodu-upgradovat-na-nette-2-2-3">puns</a> in the <a href="https://phpfashion.com/jak-vyvijet-komfotrneji">posts</a>. Love it :)</p>
<p><strong>I consider master peace to combine entertainment and education in one piece. To teach others by making them feel happy.</strong></p>
<p>Maybe that's the reason I still love Nette and your work, even though I know Symfony on the same level and a bit of Laravel.</p>
<h2 id="To-Sum-Up">To Sum Up</h2>
<p>I just wanted to say a few words to let you know how important you are and how much your work means to me.</p>
<p>No need to reply and enjoy your day!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/06/01/thank-you-david</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 01 Jun 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/06/01/thank-you-david#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Symplify packages deprecations brought by Symfony 3.3 ]]></title>
                <link>https://tomasvotruba.com/blog/2017/05/29/symplify-packages-deprecations-brought-by-symfony-33</link>
                <description><![CDATA[ <p><a href="/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3/">Symfony 3.3 brings new Dependency Injection features</a>,
that were supplemented by few of Symplify packages in Symfony 3.2 and below.
There is no need - as <a href="https://github.com/JanMikes">Honza Mikes</a> said - to <em>bring the wood to the forest</em>. So they were deprecated.
<br><br>
I will show <strong>why and what packages were deprecated and how to upgrade your app to use Symfony 3.3 instead</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>I will provide you some insights behind deprecations first. It was not an instant decision based on few Symfony blog posts,
but a long process of maturing inspired by community, feedback and intuition.</p>
<p>If you only want to see before/after changes in you application, you can <a href="#a-href-https-github-com-deprecatedpackages-defaultautowire-defaultautowire-a">skip right to the code</a>.</p>
<div class="text-center">
    <img src="/assets/images/posts/2017/symplify-deprecations/pr-notes.png" class="img-thumbnail">
</div>
<h2 id="Bringing-The-Wood-to-the-Open-Source-Forest">Bringing The Wood to the Open Source Forest</h2>
<p>One of motivations to create and build open-source project is <strong>competition</strong>. You want to create better software
than there already is, to push the society further in the development. If my project is the best, there is much less motivation to develop it.</p>
<p>That's why it's the best to have <strong>2 elements of similar level so they push each other forward</strong>, like:
Google &amp; Facebook, USA &amp; Russia, Symfony &amp; Laravel or PHP &amp; Javascript (in a way).</p>
<h2 id="Swallowing-My-Open-Source-Ego">Swallowing My Open-Source Ego</h2>
<p>When <a href="/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3/">Symfony 3.3 introduced new Dependency Injection features</a>,
I realized they have 90% similar to feature I created my packages for.</p>
<p>Internal dialog of my Ego and inner Zen master started:</p>
<ul>
<li>&quot;It's still not the same, I should keep them and promote them.&quot;</li>
<li>&quot;But I can do much greater good than adding 10% value. I could focus on completely new packages that bring 100 % value.&quot;</li>
<li>&quot;But I have created them and I have been taking care of them for a long time. People should use them.&quot;</li>
<li>&quot;It's ok, they were good in the past, but things have changed.&quot;</li>
<li>&quot;Ok, maybe I could ask community, what they think about it.&quot;</li>
</ul>
<p><strong>So I <a href="https://github.com/symplify/symplify/pull/162">asked people on Slack and Github</a></strong> what they think about it. Almost everybody (my inner Zen master included)
agreed <strong>to drop them and let Symfony handle that</strong>.</p>
<p>I must say, it was much easier to decide after getting such feedback. <strong>Thank you <a href="https://filip-prochazka.com">Filip Prochazka</a>,
<a href="https://www.tomasfejfar.cz">Tomas Fejfar</a>,  <a href="https://github.com/symplify/symplify/issues/161">Stof</a>,
<a href="https://github.com/symfony/symfony/pull/22234#issuecomment-297999703">theofidry</a>,
<a href="https://github.com/enumag">Jachym Tousek</a>, <a href="https://github.com/JanMikes">Jan Mikes</a>
and <a href="https://github.com/symplify/symplify/pull/162#issuecomment-299441503">Javier Eguilez</a></strong>
for your help with this.</p>
<h2 id="Letting-Package-Go">Letting Package Go</h2>
<p>I realized I could let packages go and I made these PRs:</p>
<ul>
<li><a href="https://github.com/symplify/symplify/pull/162#issuecomment-299441503">drop DefaultAutowire</a></li>
<li><a href="https://github.com/symplify/symplify/pull/155">drop ServiceDefinitionDecorator, AutoServiceRegistration, ControllerAutowire and SymfonyEventDispatcher</a></li>
</ul>
<p>That eventually lead to:</p>
<ul>
<li><a href="https://github.com/symplify/symplify/pull/170">dropping EventDispatcher integration to Nette</a></li>
</ul>
<p>Don't worry:</p>
<ul>
<li><strong>all have better replacement</strong> (I will show you below)</li>
<li><strong>you can still use them</strong> (they just won't get any updates)</li>
</ul>
<p>Let's look on each package now:</p>
<h2 id="DefaultAutowire"><a href="https://github.com/DeprecatedPackages/DefaultAutowire">DefaultAutowire</a></h2>
<p>This package turned on autowiring by default for most of services.</p>
<h3 id="Before">Before</h3>
<p>All services were autowired.</p>
<h3 id="After">After</h3>
<p><a href="/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3/#1-let-s-add-code-defaults-code">Use <code>_defaults</code> section</a>:</p>
<pre><code class="language-yaml"># app/config/services.yml
services:
    _defaults:
        autowire: true</code></pre>
<p>All services in this config will be autowired now. You can use it in any <code>.yml</code> file.</p>
<h2 id="ServiceDefinitionDecorator"><a href="https://github.com/DeprecatedPackages/ServiceDefinitionDecorator">ServiceDefinitionDecorator</a></h2>
<p>This package helped with service tagging and method calls by type.</p>
<h3 id="Before">Before</h3>
<pre><code class="language-yaml"># app/config/config.yml
decorator:
    Symfony\Component\Console\Command\Command:
        tags:
            - { name: "console.command" }

    AbstractEntityRepository:
        calls:
            - ["setEntityManager", ["@event_manager"]]</code></pre>
<h3 id="After">After</h3>
<p>Use <a href="/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3/#2-use-autoconfigure"><code>autoconfigure</code></a>
and <a href="/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3/#5-use-code-instanceof-code"><code>_instanceof</code></a>
features.</p>
<pre><code class="language-yaml"># app/config/services.yml
services:
    autoconfigure: true

    Symfony\Component\Console\Command\Command: ~

    _instanceof:
        AbstractEntityRepository:
            calls:
                - ["setEntityManager", ["@event_manager"]]</code></pre>
<h3 id="Minitip">Minitip</h3>
<p>You can also use <code>@required</code> annotation instead of <code>_instanceof</code> in this case, as <strong><a href="/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3/#comment-3306767439">shared by Kevin Bond</a></strong> - thank you Kevin!</p>
<h2 id="AutoServiceRegistration"><a href="https://github.com/DeprecatedPackages/AutoServiceRegistration">AutoServiceRegistration</a></h2>
<p>This package helped you to register multiple services at once with Finder.</p>
<h3 id="Before">Before</h3>
<pre><code class="language-yaml"># app/config/config.yml
symplify_auto_service_registration:
    directories_to_scan:
        - %kernel.root_dir%
    class_suffixes_to_seek:
        - Controller</code></pre>
<h3 id="After">After</h3>
<p>Use <a href="/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3/#4-use-psr-4-based-service-autodiscovery-and-registration">PSR-4 based service autodiscovery and registration</a>.</p>
<pre><code class="language-yaml"># app/config/services.yml

services:
    App\: # no more manual registration of similar groups of services
        resource: ../{Controller,Command,Subscriber}</code></pre>
<p>Tada!</p>
<p>And just like that, you can drop 4 of Symplify bundles and use Symfony 3.3 happily and safely ever after.</p>
<hr />
<p>That's all for today. In next post I will show you <strong>how to deprecate package without letting anyone behind</strong>.
Not even your blog readers that could come across and old post about it.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/05/29/symplify-packages-deprecations-brought-by-symfony-33</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 29 May 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/05/29/symplify-packages-deprecations-brought-by-symfony-33#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to refactor to new Dependency Injection features in Symfony 3.3 ]]></title>
                <link>https://tomasvotruba.com/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3</link>
                <description><![CDATA[ <p>This May will be released Symfony 3.3 with many DependencyInjection improvements.
Each of them is quite nice, <strong>but combined together - they are huge jump</strong> compare to what we have now.
<br><br>
Today I will show you what code can you drop and how to migrate it.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="What-is-New">What is New?</h2>
<p>Symfony 3.3+ brings new that will completely <strong>change they we register services</strong>:</p>
<ul>
<li><a href="https://symfony.com/blog/new-in-symfony-3-3-service-autoconfiguration"><code>autoconfigure</code></a></li>
<li><a href="https://symfony.com/blog/new-in-symfony-3-3-simpler-service-configuration"><code>_defaults</code> and <code>instanceof</code></a></li>
<li><a href="https://symfony.com/blog/new-in-symfony-3-3-optional-class-for-named-services">named services → class services</a></li>
<li><a href="https://github.com/symfony/symfony/pull/21289">PSR-4-based service autodiscovery</a></li>
</ul>
<p>You can click read post/PR in detail, but you take <strong>this shortcut to learn them</strong>...</p>
<p><br></p>
<blockquote class="blockquote text-center">
    "A full code example is worth ten thousand words of explanation."
    <footer class="blockquote-footer">Stephen P. Thomas</footer>
</blockquote>
<p><br></p>
<h2 id="Refactor-Service-Config-in-5-Steps">Refactor Service Config in 5 Steps</h2>
<p>This is service config in Application in Symfony 3.2 or lower.</p>
<p>We apply all features we can and I always add a small <code># comment</code> to the code with explanation.</p>
<pre><code class="language-yaml"># app/config/services.yml
services:
    some_service:
        class: App\SomeService
        autowire: true

    some_controller:
        class: App\Controller\SomeController
        autowire: true

    first_repository:
        class: App\Repository\FirstRepository
        autowire: true
        calls:
            - ["setEntityManager", ["@entity_manager"]]
    second_repository:
        class: App\Repository\SecondRepository
        autowire: true
        calls:
            - ["setEntityManager", ["@entity_manager"]]

    first_command:
        class: App\Command\FirstCommand
        autowire: true
        tags:
            - { name: console.command }
    second_command:
        class: App\Command\SecondCommand
        autowire: true
        tags:
            - { name: console.command }</code></pre>
<h3 id="1-Let-s-add-defaults">1. Let's add <code>_defaults</code></h3>
<pre><code class="language-yaml"># app/config/services.yml
services:
    _defaults:
        autowire: true # all services in this config are now autowired

    some_service:
        class: App\SomeService

    some_controller:
        class: App\Controller\SomeController

    first_repository:
        class: App\Repository\FirstRepository
        calls:
            - ["setEntityManager", ["@entity_manager"]]
    second_repository:
        class: App\Repository\SecondRepository
        calls:
            - ["setEntityManager", ["@entity_manager"]]

    first_command:
        class: App\Command\FirstCommand
        tags:
            - { name: console.command }
    second_command:
        class: App\Command\SecondCommand
        tags:
            - { name: console.command }</code></pre>
<h3 id="2-Use-autoconfigure">2. Use autoconfigure</h3>
<pre><code class="language-yaml"># app/config/services.yml
services:
    _defaults:
        autowire: true
        autoconfigure: true # all Symfony native tags are now added automatically

    some_service:
        class: App\SomeService

    some_controller:
        class: App\Controller\SomeController

    first_repository:
        class: App\Repository\FirstRepository
        calls:
            - ["setEntityManager", ["@entity_manager"]]
    second_repository:
        class: App\Repository\SecondRepository
        calls:
            - ["setEntityManager", ["@entity_manager"]]

    first_command:
        class: App\Command\FirstCommand
    second_command:
        class: App\Command\SecondCommand</code></pre>
<h3 id="3-Use-Class-Named-Services">3. Use Class-Named Services</h3>
<pre><code class="language-yaml"># app/config/services.yml
services:
    _defaults:
        autowire: true
        autoconfigure: true

    App\SomeService: ~ # no more thinking about creative and unique service name

    App\Controller\SomeController: ~

    App\Repository\FirstRepository:
        calls:
            - ["setEntityManager", ["@entity_manager"]]
    App\Repository\SecondRepository:
        calls:
            - ["setEntityManager", ["@entity_manager"]]

    App\Command\FirstCommand: ~
    App\Command\SecondCommand: ~</code></pre>
<h3 id="4-Use-PSR-4-based-service-autodiscovery-and-registration">4. Use PSR-4 based service autodiscovery and registration</h3>
<pre><code class="language-yaml"># app/config/services.yml
services:
    _defaults:
        autowire: true
        autoconfigure: true

    App\: # no more manual registration of similar groups of services
        resource: '../'

    App\Repository\FirstRepository:
        calls:
            - ["setEntityManager", ["@entity_manager"]]
    App\Repository\SecondRepository:
        calls:
            - ["setEntityManager", ["@entity_manager"]]</code></pre>
<h3 id="5-Use-instanceof">5. Use <code>_instanceof</code>...</h3>
<pre><code class="language-yaml"># app/config/services.yml
services:
    _defaults:
        autowire: true
        autoconfigure: true

    App\:
        resource: '../'

    _instanceof: # clean and explicit dependency injection to abstract services
        App\Repository\AbstractRepository:
            calls:
                - ["setEntityManager", ["@entity_manager"]]</code></pre>
<h3 id="5-or-Setter-Injection">5. ...or Setter Injection</h3>
<p>You can even remove the <code>_instanceof</code> with setter injection. First, modify the abstract repository to add the <code>@required</code> annotation to <code>setEntityManager</code>:</p>
<pre><code class="language-php">&lt;?php

namespace App\Repository;

use Doctrine\ORM\EntityManagerInterface;

abstract class AbstractRepository
{
    /**
     * @var EntityManagerInterface
     */
    private $entityManager;

    /**
     * @required
     */
    public function setEntityManager(EntityManagerInterface $entityManager): void
    {
        $this-&gt;entityManager = $entityManager;
    }

    // ...
}</code></pre>
<p>Now, remove the <code>_instanceof</code> in your <code>services.yml</code>:</p>
<pre><code class="language-yaml"># app/config/services.yml
services:
    _defaults:
        autowire: true
        autoconfigure: true

    App\:
        resource: '../'</code></pre>
<p>You're awesome! Now you're using all the shiny new Symfony 3.3 Dependency Injection features.</p>
<p><br></p>
<p><strong>What is your favorite change?</strong></p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Sun, 07 May 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Combine power of PHP_CodeSniffer and PHP CS Fixer in 3 lines ]]></title>
                <link>https://tomasvotruba.com/blog/2017/05/03/combine-power-of-php-code-sniffer-and-php-cs-fixer-in-3-lines</link>
                <description><![CDATA[ <p>PHP_CodeSniffer has over <strong>5 381 stars</strong> on Github and <strong>210 default sniffs</strong>,
PHP CS Fixer with <strong>6 467 stars</strong> brings you <strong>160 fixers</strong>.
<br><br>
Both powerful tools dealing with coding standards with <strong>huge communities behind them</strong>.
Can you imagine using them both and actually enjoy it? Today I will show you how.</p> ]]></description>
                <content:encoded><![CDATA[ <div class="text-center">
    <img src="/assets/images/posts/2017/easy-coding-standard-intro/together.png" class="img-thumbnail">
</div>
<h3 id="Right-to-The-Answer">Right to The Answer</h3>
<p>Let's say we want to check arrays. We add first <em>checker</em> that requires short PHP 5.4 <code>[]</code> syntax:</p>
<pre><code class="language-php">use PHP_CodeSniffer\Standards\Generic\Sniffs\Arrays\DisallowLongArraySyntaxSniff;
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();
    $services-&gt;set(DisallowLongArraySyntaxSniff::class);
};
</code></pre>
<p>Great start. Then we want to check for trailing commas, so every line has them.</p>
<p>So add one more checker:</p>
<pre><code class="language-php">use PHP_CodeSniffer\Standards\Generic\Sniffs\Arrays\DisallowLongArraySyntaxSniff;
use PhpCsFixer\Fixer\ArrayNotation\TrailingCommaInMultilineArrayFixer;
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $services = $containerConfigurator-&gt;services();
    $services-&gt;set(DisallowLongArraySyntaxSniff::class);
    $services-&gt;set(TrailingCommaInMultilineArrayFixer::class);
};</code></pre>
<p>Great job! <strong>You have just combined PHP_CodeSniffer and PHP CS Fixer in 3 lines.</strong></p>
<p>With a help of <a href="https://github.com/symplify/easy-coding-standard">ECS</a>. Now, when title promise is fulfilled, I will show how to install it, run it and how nice and clear reports it generates.</p>
<h2 id="How-to-add-ECS-in-3-steps">How to add ECS in 3 steps</h2>
<h3 id="1-Install-Package">1. Install Package</h3>
<pre><code class="language-bash">composer require symplify/easy-coding-standard --dev</code></pre>
<h3 id="2-Configure">2. Configure</h3>
<p>Create a <code>ecs.php</code> file in your project and desired checkers as above.</p>
<p>You can add a comment to groups, so everyone can easily orientate when there are more checkers.</p>
<h3 id="Be-Lazy-with-PHP">Be Lazy with PHP</h3>
<p>Do you use PHPStorm? Just use PHP to autocomplete everything as you're used to since ECS 8.</p>
<p><strong>No more looking to documentation</strong>, what string matches what sniff or fixer, if there are any checkers for arrays or debugging typos.</p>
<h3 id="3-Run-it-and-amp-Fix-it">3. Run it &amp; Fix it</h3>
<pre><code class="language-bash">vendor/bin/ecs check src

# ...

vendor/bin/ecs check src --fix</code></pre>
<div class="text-center">
    <img src="/assets/images/posts/2017/easy-coding-standard-intro/run-and-fix.gif" class="img-thumbnail">
</div>
<p>That's all for short ECS intro.</p>
<p>Do you want to know more? Learn <a href="/blog/2017/07/17/how-to-write-custom-sniff-for-code-sniffer-3/">how to write own sniff</a> or <a href="/blog/2017/07/24/how-to-write-custom-fixer-for-php-cs-fixer-24/">even better - a fixer</a>.</p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/05/03/combine-power-of-php-code-sniffer-and-php-cs-fixer-in-3-lines</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Wed, 03 May 2017 00:00:00 +0000</pubDate>
                                    <updated>2020-08-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Aug 2020 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Aug 2020 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/05/03/combine-power-of-php-code-sniffer-and-php-cs-fixer-in-3-lines#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 3 Symfony and Laravel Patterns that Make Code Easy to Extend Without Modification ]]></title>
                <link>https://tomasvotruba.com/blog/2017/04/14/3-symfony-and-laravel-patterns-that-make-code-easy-to-extends-without-modification</link>
                <description><![CDATA[ <p>Do you write open-source? If so, you probably get many PR and issues about adding new feature, that people miss.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="How-is-Open-Source-Different-from-Private-Code">How is Open-Source Different from Private Code</h2>
<p>There is a big mind-shift from closed-source to open-source. To make it really work, you need to move from <em>my ego first</em> to <em>other people's feelings first</em>.</p>
<p>It is like building Matrix open to everybody. <strong>You have to predict future and unexpected use cases</strong>. Your code have to be <strong>extendable without making any changes in it</strong>.</p>
<h3 id="and-quot-Opened-for-Extension-Closed-for-Modification-and-quot">&quot;Opened for Extension, Closed for Modification&quot;</h3>
<p>Now, I can refer to <a href="https://en.wikipedia.org/wiki/Open/closed_principle"><strong>Open/closed principle</strong> on Wikipedia</a>, which is the worst way to explain it.</p>
<p>Instead, <strong>I took a time to find simple example</strong> (pro tip: Google with &quot;simple&quot;) and actually found one - <a href="https://github.com/wataridori/solid-php-example/blob/b84657cb736f86dda1453061d15df01f260e5140/2-open-closed-principle.php#L20-L32">go check it</a>, it clearly shows wrong approach.</p>
<p>Today I will show you 3 ways to create such entrances.</p>
<h2 id="1-Interfaces-for-Everything">1. Interfaces for Everything</h2>
<p>When I first saw Laravel, I've noticed one big difference to other PHP projects I've seen. There is <a href="https://github.com/laravel/framework/tree/master/src/Illuminate/Contracts">Contracts</a> directory, that contains <strong>interface for every service there is in Laravel</strong>. And they're not only in this directory, but used everywhere in the code. Crazy move by <a href="https://medium.com/@taylorotwell">Taylor Otwell</a> in that times, but very useful.</p>
<h3 id="Why-is-this-Useful">Why is this Useful?</h3>
<ul>
<li>You don't have to think about every service, if it could be replaced or not.</li>
<li>People <strong>will love your package</strong>, because they will <strong>see freedom and understanding</strong>, not obedience as in other packages. That's what happened for me.</li>
</ul>
<h3 id="Don-t-forget-to-have-Final-Word">Don't forget to have Final Word</h3>
<p>To promote using interfaces instead of extending your classes like this:</p>
<pre><code class="language-php">class BoothCallEntrance implements MatrixEntranceInterface
{

}

class ComputerEntrance extends BoothCallEntrance
{

}</code></pre>
<p><strong>always <a href="https://ocramius.github.io/blog/when-to-declare-classes-final">mark your classes final</a></strong>. There is event <a href="https://github.com/symplify/coding-standard/blob/master/src/Fixer/Solid/FinalInterfaceFixer.php">sniff for that</a>. Use it.</p>
<pre><code class="language-php">final class BoothCallEntrance implements MatrixEntranceInterface
{

}

final class ComputerEntrance implements MatrixEntranceInterface
{

}</code></pre>
<p>Programmers won't have to think about raping your classes in the night - <strong>they just use the interface you provide</strong>.</p>
<div class="text-center">
    <img src="/assets/images/posts/2017/extendable-open-source/override.jpg" class="img-thumbnail">
</div>
<p><strong>This is code-embodied composition over inheritance</strong>. No documentation nor Wikipedia links required.</p>
<h2 id="2-Go-to-Party-Events-when-in-the-Mood">2. Go to Party Events, when in the Mood</h2>
<p>Back to Matrix world: imagine you can listen to every phone booth. Let's say you <strong>write a script, that sends you sms with geo location of the booth every time it gets called</strong> (favorite tool for agent Smith ;-)).</p>
<div class="text-center">
    <img src="/assets/images/posts/2017/extendable-open-source/booth.png" class="img-thumbnail">
</div>
<p>This approach is implemented in PHP under name of EventDispatcher. While working with Symfony, <strong>events gave me very similar feeling of freedom</strong> - <a href="https://symfony.com/doc/current/reference/events.html#kernel-events">in docs</a> as well in small book <a href="https://leanpub.com/a-year-with-symfony">A Year with Symfony</a>.</p>
<p>Do you want simple example of such listening script? <a href="/blog/2019/08/05/standalone-symfony-event-dispatcher-from-the-scratch/">Check this tested post</a> with all code snippets you need.</p>
<h3 id="While-on-Event-Listen-Carefully">While on Event, Listen Carefully</h3>
<p>Matrix situation above would look like this:</p>
<p>Code of your package:</p>
<pre><code class="language-php">// some CRON script checking all booths are working

if ($booth-&gt;isCalled()) {
    // you with people could get here without sending you a PR for everything they might need? Easy! ↓

    // this is the entry point, just listen to 'boothCall'
    $this-&gt;eventDispatcher-&gt;dispatch('boothCall', $booth-&gt;getLocation();
    // ...
}</code></pre>
<p>And custom script listening:</p>
<pre><code class="language-php">final class BoothSpy
{
    public function listenTo()
    {
        return 'boothCall';
    }

    public function runOnPing($location)
    {
        $this-&gt;smsSender-&gt;sendABoothAlert($location);
    }
}</code></pre>
<h3 id="Why-is-this-Useful">Why is this Useful?</h3>
<ul>
<li>You can introduce entry point via event.</li>
<li>You can <strong>also pass metadata</strong>, like location. Those data <strong>can be open to change</strong>, but don't have to be.</li>
</ul>
<p>It might be confusing while using at first, but after few weeks I get used to it. Trust me, it's the best.</p>
<h2 id="3-Like-Collecting-stamps-just-on-Steroids">3. Like Collecting stamps, just on Steroids</h2>
<p>This is most powerful and less known architecture pattern.</p>
<p><strong>1 service collects all services of specific type</strong></p>
<h3 id="Where-it-came-from">Where it came from?</h3>
<p>Do you know <a href="https://symfony.com/doc/current/reference/dic_tags.html">service tagging in Symfony</a>?</p>
<pre><code class="language-yaml">services:
    app.custom_subscriber:
        class: AppBundle\EventListener\CustomSubscriber
        tags:
            - { name: kernel.event_subscriber }</code></pre>
<p>All services of <code>EventSubscriber</code> type are collected by EventDispatcher.</p>
<h3 id="You-Probably-Already-Use-It">You Probably Already Use It</h3>
<ul>
<li>Console Commands → Console Application</li>
<li><a href="https://symfony.com/doc/current/security/voters.html">Security Voters</a> → Access Decision Manager</li>
</ul>
<p>As for tags - <a href="/blog/2017/02/12/drop-all-service-tags-in-your-nette-and-symfony-applications/#bare-tagging-is-duplicated-information">they often promote bad practise of duplicated information</a>. Don't use it if you don't have to.</p>
<h3 id="Why-is-this-Useful">Why is this Useful?</h3>
<ul>
<li>It goes very well with step 1.</li>
<li><strong>It's easy to integrate into huge systems</strong>. All you need to do is add 1 line of code:</li>
</ul>
<pre><code class="language-yaml">services:
    - YourSubscriber</code></pre>
<ul>
<li>It gives you powers of constructor injection. <strong>Your service can use any other services.</strong></li>
<li>It's the best prevention and antidote to <a href="http://sahandsaba.com/nine-anti-patterns-every-programmer-should-be-aware-of-with-examples.html#god-class">God classes</a>.</li>
</ul>
<h3 id="Back-to-the-Matrix">Back to the Matrix</h3>
<div class="text-center">
    <img src="/assets/images/posts/2017/extendable-open-source/renderer.jpg" class="img-thumbnail">
</div>
<p>Let's say we have a service to render Matrix. It might look like this:</p>
<pre><code class="language-php">final class MatrixRenderer()
{
    public function render()
    {
        $this-&gt;agents-&gt;render();
        $this-&gt;environment-&gt;render();
        $this-&gt;people-&gt;render();
    }
}</code></pre>
<p>Later, one customer wants to render night clubs. Another customer wants to add weather. How to do that without modifying the code?  Like this:</p>
<pre><code class="language-php">final class MatrixRenderer()
{
    /**
     * @var LayerRendererInterface[]
     */
    private $layerRenderers = [];

    public function addLayerRenderer(LayerRendererInterface $layerRenderer)
    {
        $this-&gt;layerRenderers[] = $layerRenderer;
    }

    public function render()
    {
        foreach ($this-&gt;layerRenderers as $layerRenderer) {
            $layerRenderer-&gt;render();
        }
    }
}</code></pre>
<p>And decouple to services:</p>
<pre><code class="language-yaml">services:
    - AgentLayerRenderer
    - EnvironmentLayerRenderer
    - PeopleLayerRenderer

    # added by customers
    - NightClubsLayerRenderer
    - WeatherLayerRenderer</code></pre>
<p><em>Do you want to use collectors without pain? In case you use Symfony, Nette or Laravel, here is <a href="https://github.com/symplify/package-builder/blob/54ca56f850867b5ba9c5d96d2a00f4e2f0bb63a4/src/Adapter/Symfony/DependencyInjection/DefinitionCollector.php">PackageBuilder</a> that makes it simple.</em></p>
<h3 id="How-do-You-Make-your-Packages-Easy-to-Extend">How do You Make your Packages Easy to Extend?</h3>
<p>Let me know if you use any of these patterns. Or do you use something else? I'd love to hear about that!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/04/14/3-symfony-and-laravel-patterns-that-make-code-easy-to-extends-without-modification</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Fri, 14 Apr 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/04/14/3-symfony-and-laravel-patterns-that-make-code-easy-to-extends-without-modification#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Why Is Doctrine Dying ]]></title>
                <link>https://tomasvotruba.com/blog/2017/03/27/why-is-doctrine-dying</link>
                <description><![CDATA[ <p>Do you use Doctrine ORM? If so, do you follow its evolution on Github? Symfony is evolving, Laravel is evolving, Nette is evolving, the world is evolving... Doctrine not. Today I will show you 3 reasons why.</p> ]]></description>
                <content:encoded><![CDATA[ <p>I've been thinking over 2 years about this post. I wasn't sure if it's only a negative hype feeling or the real thing. It's still the same so it's time to write about it.</p>
<h2 id="Doctrine-is-Awesome-Tool">Doctrine is Awesome Tool</h2>
<p>To be clear, I have been using Doctrine for many years and it is <strong>the best ORM there is</strong>. Of course there is <a href="http://propelorm.org">Propel ORM</a> and <a href="https://laravel.com/docs/eloquent">Eloquent</a> from Laravel,
<strong>but they use active record</strong>.</p>
<p>I'm not an expert in databases, so active record might be actually a useful pattern, even architectonically, but I don't favor it now.</p>
<h2 id="Doctrine-is-stuck-in-its-Legacy-Unable-to-Evolve">Doctrine is stuck in its Legacy, Unable to Evolve</h2>
<p>But the main I see is that Doctrine is not evolving. Last useful feature was the <strong><a href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/second-level-cache.html">2nd Level cache</a></strong> in <code>doctrine/orm</code> <a href="https://github.com/doctrine/doctrine2/releases/tag/v2.5.0">released in 2015</a>. In meaning not a few-person feature, but a feature, that can influence most of the applications.</p>
<p>Would you be still using Symfony if the last feature was released 2 years ago? <strong>No, you would probably go for Laravel</strong>, Yii2, CakePHP, Nette or <strong>any other framework to see, if it works better for you</strong>. Because we programmers evolve and we need to do the same work in less time and work.</p>
<h3 id="Who-Caused-This">Who Caused This?</h3>
<p><strong>This has nothing to do with code quality, number of active maintainers or too few people contributing.</strong> Although all have a great part in an open-source life cycle.</p>
<p>To put you in my seat, I've maintained many own and foreign packages. They had difficulty to stay alive with the same amount of energy invested. Does that sound like legacy code to you? Yep!</p>
<p><strong>I see this is rather a system setup.</strong> Like any other system, it can lead both ways - slow down, or speed up. Depends on the vector you prepare.</p>
<h3 id="Donate-Your-Liver-For-Free">Donate Your Liver, For Free</h3>
<p>To demonstrate an example of how a system can go both ways, I will show you something nice to do when you die.</p>
<p>Do you need your liver when you die? Somebody else might does, but it depends on your country's default law system, what will happen to it.</p>
<ul>
<li>In some countries, you can save a person by default.</li>
<li>In some countries, you are just dead.</li>
</ul>
<div class="text-center">
    <img src="/assets/images/posts/2017/dying-doctrine/organ-donation.jpg" class="img-thumbnail">
</div>
<p>Of course, you can write an extra card saying &quot;Take my organs when I die&quot;, but who will actually do it?</p>
<h2 id="Things-That-Might-Save-Doctrine">Things That Might Save Doctrine</h2>
<p>Where is death, there is life. I believe Doctrine or any slowly dying project can be saved - by just a system setup.</p>
<h3 id="1-Create-a-Competition">1. Create a Competition</h3>
<p>&quot;Where you are the best, there is no one to learn from, so you stop.&quot;</p>
<p>If Symfony would be the only framework, there would be no other choice, everyone would be using it. And Symfony would have no motivation to be better (better than who?).</p>
<p>I think Fabien was aware of that, so he wrote a series <a href="http://fabien.potencier.org/create-your-own-framework-on-top-of-the-symfony2-components-part-1.html">Create your own framework... on top of the Symfony2 Components</a> in 2012, which promoted using only components of Symfony to create an own framework. So <a href="https://laravel.com">Laravel</a> was made on top of Symfony components.</p>
<p><strong>Now these 2 frameworks are pushing industry standard like never before</strong>. Awesome to watch!</p>
<p>There is no more powerful motivation than competition. Moreover in man's worlds. Missing one? Create one!</p>
<h3 id="2-Using-Monolithic-Repository">2. Using Monolithic Repository</h3>
<p>I see Symfony, Laravel and many huge projects <a href="/blog/2017/01/31/how-monolithic-repository-in-open-source-saved-my-laziness/">using this pattern</a> and I am profiting a lot from it. After ~8 years in open-source, I've tried too (don't judge, just try for yourself) and it's the best! Trust me.</p>
<p><strong>Having Doctrine (or any other project) split in over 20 repositories requires a lot of work</strong>.</p>
<p>Now each repository:</p>
<ul>
<li>has own coding standard (if any)</li>
<li>is tested on different database versions</li>
<li>relies on the hope that new change won't break other 19 packages</li>
<li>has different maintainer signature and standards</li>
</ul>
<p>That's how you spend more work on maintenance than on feature very easily.</p>
<h3 id="3-Using-Dependency-Injection-by-Default">3. Using Dependency Injection by Default</h3>
<p>The last thing that might turn it to the right direction is Dependency Injection via Constructor, also called autowiring.
In many projects I see, while consulting big companies, this pattern <strong>would save them from 20-30 % complexity they have now</strong> (when used properly). Just by using it from the start.</p>
<p>1,5 year ago, I sent a pull-request for a simple thing - <a href="https://github.com/doctrine/doctrine2/pull/1453">having modular filters</a>. It is actually just a single-service constructor injection implementation. Huge problem to integrate. And there is a lot more static code like <code>new SomeService</code> that could be easily resolved with this.</p>
<h2 id="That-s-Why-I-m-Dropping-My-Doctrine-Packages">That's Why I'm Dropping My Doctrine Packages</h2>
<p>I miss an evolution with Doctrine. When some packages are stuck for 2-3 years in one place, there is probably already a better replacement. Either on Packagist or in your mind.</p>
<p>As <a href="/trainings">I mentor and coach teams</a> to write better code with less work, <strong>I'd go against my own beliefs by putting a vendor lock-in their applications.</strong></p>
<p>That's why I'm dropping support for my Zenify packages built for Doctrine.</p>
<h3 id="What-Repositories-are-This-Concerned">What Repositories are This Concerned?</h3>
<ul>
<li><a href="https://github.com/Zenify/DoctrineFixtures">Zenify/DoctrineFixtures</a> - use <a href="https://github.com/nettrine/fixtures">nettrine/fixtures</a> or <a href="https://github.com/nelmio/alice">Nelmio/Alice</a> instead</li>
<li><a href="https://github.com/Zenify/DoctrineBehaviors">Zenify/DoctrineBehaviors</a></li>
<li><a href="https://github.com/Zenify/DoctrineExtensionsTree">Zenify/DoctrineExtensionsTree</a> - use <a href="https://github.com/nettrine/extensions">nettrine/extensions</a> instead</li>
<li><a href="https://github.com/Zenify/DoctrineMigrations">Zenify/DoctrineMigrations</a> - use <a href="https://github.com/robmorgan/phinx">phinx</a> or <a href="https://github.com/nettrine/migrations">nettrine/migrations</a> instead</li>
</ul>
<h2 id="What-about-Your-Project">What about Your Project?</h2>
<p>When you take a step back, you realize, all this can happen to your project too.
I recommend taking some time to reflect, where your project goes and what is the reason - you, company or project's system?</p>
<h2 id="Let-me-Know-Your-Opinion">Let me Know Your Opinion</h2>
<p>What do you think? Do you see prosperity? Or alternatives like <a href="https://github.com/nextras/orm">NextrasORM</a> or <a href="https://github.com/atlasphp/Atlas.Orm">Atlas ORM</a>? Or even different pattern than ORM?
Let me know. My knowledge is very limited and I'd be happy to learn something new. Thank you!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/03/27/why-is-doctrine-dying</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 27 Mar 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/03/27/why-is-doctrine-dying#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Statie - part 4: How to Create The Simplest Blog ]]></title>
                <link>https://tomasvotruba.com/blog/2017/03/13/statie-4-how-to-create-the-simplest-blog</link>
                <description><![CDATA[ <p>Statie is very powerful tool for creating small sites. But you will use just small part of it's features, having just micro-sites. How to get to full 100%? <strong>build a blog</strong>.
<br><br>
Today I will show you, <strong>how to publish your first post</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Create-a-Blog-Page">Create a Blog Page</h2>
<p>This might be the simplest page to show all your posts:</p>
<pre><code class="language-twig">&lt;!-- /source/blog.twig --&gt;

---
layout: "_layouts/default.twig"
---

{% block content %}
    &lt;h2&gt;Shouts Too Loud from My Hearth&lt;/h2&gt;

    {% for post in posts %}
        &lt;a href="/{{ post.relativeUrl }}/"&gt;
            &lt;h3&gt;{{ post.title }}&lt;/h3&gt;
        &lt;/a&gt;
    {% endfor %}
{% endblock %}</code></pre>
<h3 id="You-already-see">You already see</h3>
<ul>
<li>that all posts are in stored in <code>posts</code> variable</li>
<li>that every post has <code>relativeUrl</code></li>
<li>that every post should have a <code>title</code> (optional, but recommended)</li>
</ul>
<h2 id="How-Does-it-Work">How Does it Work?</h2>
<p>Statie will do 3 steps:</p>
<ol>
<li><strong>Scans <code>/source/_posts</code> for any files</strong>
<ul>
<li>those files have to be in <code>YYYY-MM-DD-url-title.md</code> format</li>
<li>that's how Statie can determine the date</li>
</ul></li>
<li><strong>Converts Markdown and TWIG/Latte syntax to HTML</strong></li>
<li>Stores them to <code>posts</code> variable.</li>
</ol>
<h2 id="How-does-a-Post-Content-Look-Like">How does a Post Content Look Like?</h2>
<pre><code class="language-html">&lt;!-- source/_posts/2017-03-05-my-last-post.md --&gt;

---
title: "This my Last Post, Ever!"
---

This is my last post to all</code></pre>
<h3 id="How-to-Show-Post-in-Own-Layout">How to Show Post in Own Layout</h3>
<p>Posts use <code>_layouts/post.twig</code> by default. It should include the common parts for all layouts - like header, menu or footer.</p>
<pre><code class="language-twig">&lt;!-- /source/_layouts/post.twig --&gt;

{% include "_snippets/header.twig" %}

{% block content %}
    &lt;h2&gt;{{ post.title }}&lt;/h2&gt;

    {{ post.content|raw }}
{% endblock %}

{% include "_snippets/footer.twig" %}</code></pre>
<p>That should be it.</p>
<p>Save file, <a href="http://localhost:8000/blog">look on the blog page</a> and see:</p>
<div class="text-center">
    <img src="/assets/images/posts/2017/statie-4/statie-blog.png" class="img-thumbnail">
</div>
<p>When you click a post title:</p>
<div class="text-center">
    <img src="/assets/images/posts/2017/statie-4/statie-post.png" class="img-thumbnail">
</div>
<h3 id="ProTip-Change-Post-Url">ProTip: Change Post Url</h3>
<p>You see the url for the post is <code>blog/2017/03/05/my-last-post/</code>.</p>
<p>This <strong>can be changed by configuration</strong> in <code>statie.yml</code>:</p>
<pre><code class="language-yaml">parameters:
    generators:
        posts:
            route_prefix: 'my-blog/:year' # "blog/:year/:month/:day" by default</code></pre>
<p>That produces <code>my-blog/2017/my-last-post/</code> url.</p>
<p>Got it? I know you do! <strong>You are smart.</strong></p>
<h2 id="Now-You-Know">Now You Know</h2>
<ul>
<li><strong>That all posts are placed in <code>/source/_posts</code> directory and in <code>$posts</code> variable</strong>.</li>
<li>That post has to be in <strong>named as <code>YYYY-MM-DD-title.md</code> format</strong></li>
<li>That you can change the post generated url in <code>statie.yml</code> in <code>parameters &gt; generators &gt; posts &gt; route_prefix</code>.</li>
</ul>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/03/13/statie-4-how-to-create-the-simplest-blog</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 13 Mar 2017 00:00:00 +0000</pubDate>
                                    <updated>2018-09-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Sep 2018 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Sep 2018 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/03/13/statie-4-how-to-create-the-simplest-blog#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Statie - part 3: How to Add Reusable Parts of Code ]]></title>
                <link>https://tomasvotruba.com/blog/2017/03/09/statie-3-how-to-add-reusable-parts-of-code</link>
                <description><![CDATA[ <p>You already know <a href="/blog/2017/02/20/statie-how-to-run-it-locally/">how to run Statie with layout</a> and <a href="/blog/2017/03/06/statie-2-how-to-add-contact-page-with-data/">how to add data structures</a>.
<br><br>
Today you'll learn how to <strong>decouple big templates to smaller and reusable snippets</strong>. Like Google Analytics code.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Sometimes you need to add part of template, that you want to use on multiple pages (in the same form or with smaller changes) or that makes your template less readable.</p>
<h2 id="Google-Analytics">Google Analytics</h2>
<p>Often you start a new web with settings up Google Analytics measure code.</p>
<p>It looks like this:</p>
<pre><code class="language-javascript">&lt;script&gt;
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'YXZ', 'auto');
    ga('send','pageview');
&lt;/script&gt;
&lt;script async defer src="https://www.google-analytics.com/analytics.js"&gt;&lt;/script&gt;</code></pre>
<p>We put into layout:</p>
<pre><code class="language-twig">&lt;!-- source/_layouts/default.twig --&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;meta charset="utf-8"&gt;
    &lt;/head&gt;
    &lt;body&gt;
        {% block content %}{% endblock %}

        &lt;script&gt;
            ga=function(){ ga.q.push(arguments) };
            ga.q=[];
            ga.l=+new Date;
            ga('create', 'XYZ', 'auto');
            ga('send','pageview');
        &lt;/script&gt;
        &lt;script async defer src="https://www.google-analytics.com/analytics.js"&gt;&lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>This layout might be small, but it will be definitely bigger in real app and <strong>will keep growing and growing in time</strong>.</p>
<p>Google Analytics code is not something we change or extend too much. Why not outsource it?</p>
<h2 id="Sexy-and-amp-Small-Snippet">Sexy &amp; Small Snippet</h2>
<p>What if you could use some &quot;include googleAnalytics snippet&quot; command?</p>
<p>With Statie you can!</p>
<pre><code class="language-twig">{% include "_snippets/googleAnalytics.twig" %}</code></pre>
<h3 id="How-does-it-Work">How does it Work?</h3>
<p>Statie scans <code>/_snippets</code> directory and turns all files to snippets. Relative path of the file in <code>/source</code> directory = key for including the snippets.</p>
<ul>
<li>&quot;_snippets/googleAnalytics.twig&quot; =&gt; <code>snippets/googleAnalytics.twig</code></li>
</ul>
<h3 id="Decoupling-the-Snippet">Decoupling the Snippet</h3>
<p>First, we create the snippet file and move the Google Analytics code there:</p>
<pre><code class="language-html">&lt;!-- source/_snippets/googleAnalytics.twig --&gt;

&lt;script&gt;
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'XYZ', 'auto');
    ga('send','pageview');
&lt;/script&gt;
&lt;script async defer src="https://www.google-analytics.com/analytics.js"&gt;&lt;/script&gt;</code></pre>
<p>Then clean the layout:</p>
<pre><code class="language-twig">&lt;!-- source/_layouts/default.twig --&gt;

&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;meta charset="utf-8"&gt;
    &lt;/head&gt;
    &lt;body&gt;
        {% block content %}{% endblock %}
        {% include "_snippets/googleAnalytics.twig" %}
    &lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>There is one last think that bothers me:</p>
<pre><code class="language-javascript">ga('create', 'XYZ', 'auto');</code></pre>
<p>Can you see it?</p>
<h2 id="ProTip-1-Why-Always-Put-IDs-to-Config-and-Not-to-Code">ProTip #1: Why Always Put IDs to Config and Not to Code</h2>
<p>When you start using static site generator, you'll <strong>appreciate its power in scaling</strong>:</p>
<ul>
<li>First web might take some time to setup.</li>
<li>Second is mostly copy-pasting previous settings and changing only layout and content.</li>
<li>And third? Way too easy and well paid job.</li>
</ul>
<p>To allow this flow, I recommend <strong>keeping all IDs</strong> that change from site to site - Google Analytics, Facebook Pixel, Disqus ID... - in <code>_config/config.yml</code> file. When you create a new website, <strong>all you have to do is change one file</strong> to make it customized.</p>
<h3 id="How-To-Do-It">How To Do It</h3>
<p>I wrote about config in previous post - <a href="/blog/2017/03/06/statie-2-how-to-add-contact-page-with-data#2-global-or-bigger-amount-of-data">go read it, if you missed it</a>.</p>
<p>So you should end up with this:</p>
<pre><code class="language-javascript">ga('create', '{{ $googleAnalytics }}', 'auto');</code></pre>
<p>Nice work!</p>
<h2 id="ProTip-2-Too-Many-Snippets-Group-them-by-Type">ProTip #2: Too Many Snippets? Group them by Type</h2>
<p>Often, I've ended up with many unrelated snippets in one directory.</p>
<pre><code class="language-bash">/source
    /_snippets
        comments.twig
        header.twig
        footer.twig
        postMetadata.twig
        postHeadline.twig
        postRecommendations.twig</code></pre>
<p>There is no need for that. You can group them to subdirs as you like:</p>
<pre><code class="language-bash">/source
    /_snippets
        /layout
            header.twig
            footer.twig
        /post
            comments.twig
            postMetadata.twig
            postHeadline.twig
            postRecommendations.twig</code></pre>
<h2 id="Now-You-Know">Now You Know</h2>
<ul>
<li>That using snippets will save lot of time.</li>
<li><strong>That snippets are named by their filename</strong>: <code>{% include "_snippest/fileName.twig" %}</code>.</li>
<li><strong>That snippets work the best with <a href="/blog/2017/03/06/statie-2-how-to-add-contact-page-with-data#2-global-or-bigger-amount-of-data">global configuration</a></strong>.</li>
</ul>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/03/09/statie-3-how-to-add-reusable-parts-of-code</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 09 Mar 2017 00:00:00 +0000</pubDate>
                                    <updated>2018-09-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Sep 2018 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Sep 2018 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/03/09/statie-3-how-to-add-reusable-parts-of-code#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Symfony Static Dumper - part 2: How to add Contact Page With Data ]]></title>
                <link>https://tomasvotruba.com/blog/2017/03/06/statie-2-how-to-add-contact-page-with-data</link>
                <description><![CDATA[ <p><a href="/blog/2017/02/20/statie-how-to-run-it-locally/">In previous post</a> we generated simple index with layout. Today we look on first dynamic feature - <strong>parameters</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Contact-Page-with-Socials-Accounts-Data-Separated">Contact Page with Socials Accounts Data Separated</h2>
<p>First, create a <code>contact.twig</code> file in the <code>/templates</code> directory:</p>
<pre><code class="language-html">{% extends "_layouts/default.twig" %}

{% block content %}
    &lt;h1&gt;First Hour is on me - Call me now!&lt;/h1&gt;

    &lt;ul&gt;
        &lt;li&gt;Email: &lt;a href="mailto:hi@gmail.com"&gt;hi@gmail.com&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;Twitter: &lt;a href="https://twitter.com/wise-programmer"&gt;@wiseProgrammer&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;Github: &lt;a href="https://github.com/wise-programmer"&gt;@WiseProgrammer&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
{% endblock %}</code></pre>
<p>Second, create a controller that render this file:</p>
<pre><code class="language-php">namespace App\Controller;

use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Routing\Annotation\Route;

final class ContactController extends AbstractController
{
    #[Route(path: 'contact', name: 'contact')]
    public function __invoke(): Response
    {
        return $this-&gt;render('contact.twig');
    }
}</code></pre>
<p><br></p>
<h2 id="How-to-Refactor-to-Parameters">How to Refactor to Parameters?</h2>
<p>We are programmers and we don't like data coupled to the code. You wouldn't put your repository class to your <code>Homepage.twig</code> template, would you?</p>
<p>What if...</p>
<ul>
<li>we want to <strong>add new contact</strong>,</li>
<li><strong>change it</strong></li>
<li>or <strong>use in multiple parts</strong> of website.</li>
</ul>
<p>First, we modify the template to work with dynamic <code>contact_methods</code> variable:</p>
<pre><code class="language-html">{% block content %}
    &lt;h1&gt;First Hour is on me - Call me now!&lt;/h1&gt;

    &lt;ul&gt;
        {% for contact_method in contact_methods %}
            &lt;li&gt;
                {{ contact_method.type }}:
                &lt;a href="{{ contact_method.link }}"&gt;{{ contact_method.name }}&lt;/a&gt;
            &lt;/li&gt;
        {% endfor %}
    &lt;/ul&gt;
{% endblock %}</code></pre>
<p>Second, we add a new parameter to <code>config/config.php</code>:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return function (ContainerConfigurator $containerConfigurator): void {
    $contactMethods = [
        [
            'type' =&gt; 'Email',
            'link' =&gt; 'mailto:hi@gmail.com',
            'name' =&gt; 'hi@gmail.com'
        ], [
            'type' =&gt; 'Twitter',
            'link' =&gt; 'https://twitter.com/wise-programmer',
            'name' =&gt; '@wiseProgrammer'
        ], [
            'type' =&gt; 'Github',
            'link' =&gt; 'https://github.com/wise-programmer',
            'name' =&gt; '@WiseProgrammer'
        ]
    ];

    $parameters = $containerConfigurator-&gt;parameters();
    $parameters-&gt;set('contact_methods', $contactMethods);
};</code></pre>
<p>Third, we use this parameter in controller to pass it to the template:</p>
<pre><code class="language-php">namespace App\Controller;

use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\DependencyInjection\ParameterBag\ParameterBagInterface;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Routing\Annotation\Route;

final class ContactController extends AbstractController
{
    public function __construct(
        private ParameterBagInterface $parameterBag
    ) {
    }

    #[Route(path: 'contact', name: 'contact')]
    public function __invoke(): Response
    {
        return $this-&gt;render('contact.twig', [
            'contact_methods' =&gt; $this-&gt;parameterBag-&gt;get('contact_methods')
        ]);
    }
}</code></pre>
<p>Save the file, <a href="http://localhost:8000/contact">look on the contact page</a> and works!</p>
<div class="text-center">
    <img src="/assets/images/posts/2017/statie-2/statie-contact.png" class="img-thumbnail">
</div>
<h2 id="Now-You-Know">Now You Know</h2>
<ul>
<li>How to add parameter to your Symfony Static Dumper page.</li>
<li><strong>Where to put them</strong></li>
<li>That its basically Symfony config convention</li>
</ul>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/03/06/statie-2-how-to-add-contact-page-with-data</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 06 Mar 2017 00:00:00 +0000</pubDate>
                                    <updated>2021-02-01UTC00:00:000</updated>
                    <atom:updated>Mon, 01 Feb 2021 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Mon, 01 Feb 2021 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/03/06/statie-2-how-to-add-contact-page-with-data#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Fast and Easy Way to Learn Complex Topics ]]></title>
                <link>https://tomasvotruba.com/blog/2017/02/22/fast-and-easy-way-to-learn-complex-topics</link>
                <description><![CDATA[ <p>This little trick helps me to learn complex topic both fast and easy. It works very well during my lectures and posts. In Informatics, people tend to make issues more complex than it is necessary. It slows down the learning steep with no added value.
<br><br>
I think it's about time to take it back to <strong>the simplest step</strong> and make learning faster (or machines will). Today I will show you how.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Philosophy-Everywhere">Philosophy Everywhere</h2>
<p>Do you know <a href="https://simple.wikipedia.org/wiki/Occam&#039;s_razor">Occam's razor</a>, <a href="https://en.wikipedia.org/wiki/Pareto_principle">Pareto principle</a> or <a href="https://en.wikipedia.org/wiki/Lowest_common_denominator">Lowest common denominator</a>?</p>
<p>This is the term from their neighborhood. Don't be scared it's of those philosophers. Those are actually mind hack useful in everyday life.</p>
<h2 id="Coaching-example-Create-a-School-and-Destroy-it-With-Coaching">Coaching example: Create a School and Destroy it With Coaching</h2>
<p>When I talked to my coach recently, I realized that <strong>my biggest dream is founding a school</strong>. I immediately started thinking about the building, how much money does it cost, who would be the teachers and who would be the students.</p>
<p>That's not so <a href="https://en.wikipedia.org/wiki/SMART_criteria">SMART</a>, is it? I got overwhelmed and was unable to produce any real step I could do next day.</p>
<p>The coach got me <strong>from huge and long-life dream to reality of every day life</strong> by these questions:</p>
<ul>
<li>What can you do this year?</li>
<li>What can you do this month?</li>
<li><strong>What can you do this week?</strong></li>
</ul>
<p>Then it become much more real to me, as I live only 1 day at a time. <strong>I could imagine</strong>, next week I would write a testament on Google Docs, just to put it out. <strong>When you can imagine some concept with your fantasy, you're on the right path</strong>.</p>
<p><strong>Same process can be applied to learning and teaching</strong>.</p>
<h2 id="Learning-Software-example-Narrow-Nette-Extension-Down-to-one-Line">Learning Software example: Narrow Nette Extension Down to one Line</h2>
<p>Btw, in software, this is also called <a href="https://en.wikipedia.org/wiki/Lean_software_development">Lean Software Development</a>.</p>
<p>Recently, I applied this approach to article about How to Create Your First Nette Extension.</p>
<h3 id="I-Learned-Extensions-the-Hard-Way">I Learned Extensions the Hard Way</h3>
<ol>
<li>
<p><strong>By Reading Nette documentation</strong> <a href="https://doc.nette.org/en/di-extensions">that describes over 20 features and uses cases it has</a>. That is information, which is useful, because I can use the tool to it's potential, but not the best adopt the skill.</p>
</li>
<li>
<p><strong>By Reading extension of open-source packages</strong>. They are similar to documentation: many features on various use cases I didn't understand yet.</p>
</li>
</ol>
<p>That lead to <strong>overstretching my brain muscle</strong>. It's like trying to jump over huge hole before even walking.</p>
<p>Before starting and article, I tried to find this easiest step.</p>
<h3 id="Could-it-be-simpler">Could it be simpler?</h3>
<p>What is essential purpose of the extension? It registers services to Nette Dependency Injection Container.</p>
<ul>
<li>Register services to Container?</li>
<li>Register services?</li>
<li><strong>Register 1 service</strong> - that's the one and only step we'll make today.</li>
</ul>
<p>And that was the topic I wrote about.</p>
<h2 id="Pause-Bad-Feelings-and-Take-Your-Time-to-Think">Pause Bad Feelings and Take Your Time to Think</h2>
<p>So next time you'll think &quot;gosh, this is so hard, I don't understand it, I'm so slow/lazy/...&quot;, <strong>stop for a moment and carefully look at the problem</strong>. <strong>There might be an easier way.</strong></p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/02/22/fast-and-easy-way-to-learn-complex-topics</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Wed, 22 Feb 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/02/22/fast-and-easy-way-to-learn-complex-topics#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Statie - part 1: How to run it Locally ]]></title>
                <link>https://tomasvotruba.com/blog/2017/02/20/statie-how-to-run-it-locally</link>
                <description><![CDATA[ <p><a href="https://statie.org">Statie</a> is a tool to create semi-static webpages. It allows you to host your website on Github for free. Event with own domain and https. It was created in late 2016 based on <a href="https://github.com/sculpin/sculpin">Scuplin</a> and its major feature is simplicity.
<br><br>
That was the &quot;pitch&quot;, now I will show you how to use it.</p> ]]></description>
                <content:encoded><![CDATA[ <h3 id="Create-Empty-Project">Create Empty Project...</h3>
<p>...and require <a href="https://github.com/Symplify/Statie">Statie</a> package.</p>
<pre><code class="language-bash">composer require symplify/statie</code></pre>
<h3 id="3-Steps-Life-Cycle">3 Steps Life-Cycle</h3>
<p>Statie has very simple life-cycle:</p>
<ol>
<li>Create code in <code>/source</code> directory, using HTML, TWIG, Latte and Markdown</li>
<li>Generate HTML code via console</li>
<li>See the generated HTML output code in <code>/output</code> via local PHP server</li>
</ol>
<p>Later, you can push output code to Github Pages or your server via FTP or SSH. But let's start with small step.</p>
<h2 id="1-Create-your-Code">1. Create your Code</h2>
<p>Statie supports <strong>HTML</strong>, <strong>TWIG</strong> and <strong>Markdown</strong> (in <code>.md</code> files only). For most of pages, HTML and TWIG/Latte is enough. Markdown is useful for repeated items like posts.</p>
<p>Let's create our index page.</p>
<pre><code class="language-html">&lt;!-- source/index.twig --&gt;

Hi!</code></pre>
<h3 id="Setup-Layout">Setup Layout</h3>
<pre><code class="language-html">&lt;!-- source/_layouts/default.twig --&gt;

&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;meta charset="utf-8"&gt;
    &lt;/head&gt;
    &lt;body&gt;
        {% block content %}{% endblock %}
    &lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>And add layout and block content to the <code>index.twig</code>:</p>
<pre><code class="language-html">---
layout: "layouts/default.twig"
---

{% block content %}
    Hi, my job is to help you grow any direction you choose!
{% endblock %}</code></pre>
<p><strong>Section between <code>---</code> is used to configure system or own variables</strong>. I will tell you more about that later.</p>
<h2 id="2-Generate-Final-HTML-Code">2. Generate Final HTML Code</h2>
<p>Run in project root in CLI:</p>
<pre><code class="language-bash">vendor/bin/statie generate source</code></pre>
<h2 id="3-See-Generate-Code">3. See Generate Code</h2>
<p>Create PHP local server in CLI:</p>
<pre><code class="language-bash">php -S localhost:8000 -t output</code></pre>
<p>and open <a href="https://localhost:8000">localhost:8000</a> in your browser.</p>
<p>Voilá!</p>
<div class="text-center">
    <img src="/assets/images/posts/2017/statie-1/statie-cycle.gif">
    <br>
    <em>The same demo as above, just with Latte syntax</em>
</div>
<p><br></p>
<h2 id="Minitip-Use-Gulp-Work-For-You">Minitip: Use Gulp Work For You</h2>
<p>It is quite annoying to refresh regenerate content manually every time you change the code.</p>
<p>Simple Gulp script can regenerate content for use.</p>
<p>Install <code>gulp</code> and <code>gulp-watch</code>:</p>
<pre><code class="language-bash">npm install -g gulp gulp-watch</code></pre>
<pre><code class="language-javascript">var gulp = require('gulp');
var watch = require('gulp-watch');
var exec = require('child_process').exec;

gulp.task('default', function () {
    // Run local server, open localhost:8000 in your browser
    exec('php -S localhost:8000 -t output');

    // Generate current version
    // For Windows use: exec('vendor\\bin\\statie generate', function (err, stdout, stderr) {
    exec('vendor/bin/statie generate', function (err, stdout, stderr) {
        console.log(stdout);
        console.log(stderr);
    });

    return watch(['source/**/*', '!**/*___jb_tmp___'], { ignoreInitial: false })
    // For the second arg see: https://github.com/floatdrop/gulp-watch/issues/242#issuecomment-230209702
        .on('change', function() {
            // For Windows use: exec('vendor\\bin\\statie generate', function (err, stdout, stderr) {
            exec('vendor/bin/statie generate', function (err, stdout, stderr) {
                console.log(stdout);
                console.log(stderr);
            });
        });
});</code></pre>
<p>And run the script via:</p>
<pre><code class="language-bash">gulp</code></pre>
<p>Now open <a href="http://localhost:8000">localhost:8000</a> and change <code>source/index.twig</code>.</p>
<p>It works!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/02/20/statie-how-to-run-it-locally</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 20 Feb 2017 00:00:00 +0000</pubDate>
                                    <updated>2018-09-01UTC00:00:000</updated>
                    <atom:updated>Sat, 01 Sep 2018 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Sat, 01 Sep 2018 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/02/20/statie-how-to-run-it-locally#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Minimalistic Way to Create Your First Nette Extension ]]></title>
                <link>https://tomasvotruba.com/blog/2017/02/15/minimalistic-way-to-create-your-first-nette-extension</link>
                <description><![CDATA[ <p>Nette extension allows you not only to create open-source packages, but also to <strong>split your application to small and logical chunks of code</strong>.
<br><br>
Open-source extensions are more complex using many Nette\DI features, but today I will show you, how to <strong>start with one Nette\DI method and one service only</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>I consider <a href="https://github.com/nette/sandbox">Nette Sandbox</a> the best way to show learn any Nette feature. Let's use it.</p>
<h2 id="Register-service-in-Nette-Sandbox">Register service in Nette Sandbox</h2>
<p>If you want to register a service, what will you do?</p>
<pre><code class="language-yaml"># app/config/config.neon

services:
    - App\Model\UserManager # put it there</code></pre>
<p>File <code>app/config/config.neon</code> is like a socket.</p>
<img src="/assets/images/posts/2017/nette-extension/single-socket.jpg" class="img-thumbnail">
<p>There is <strong>one place to active your computer</strong>, when you plug it in.</p>
<p>But what if your want to <strong>plug in computer and mobile charger</strong> in the same time?</p>
<img src="/assets/images/posts/2017/nette-extension/multi-socket.jpg" class="img-thumbnail">
<p>To load more services, we use the same interface as <code>app/config/config.neon</code>: <strong>a file with service section that lists services</strong>.</p>
<h2 id="Create-Local-Extension-in-5-Steps">Create Local Extension in 5 Steps</h2>
<p>Let's say we want to decouple a FileSystem utilities.</p>
<h3 id="1-Pick-a-Name-for-Directory">1. Pick a Name for Directory</h3>
<p>What about &quot;FileSystem&quot;? If you agree, create <code>src/FileSystem</code> directory.
We will put configuration (sevices.neon) and classes there.</p>
<h3 id="2-Create-or-move-Related-Classes-there">2. Create or move Related Classes there</h3>
<p>Starting small, one service will do. When it grows, we can decouple it later.</p>
<pre><code class="language-php"># src/FileSystem/FileSystem.php

&lt;?php declare(strict_types=1);

namespace FileSystem;

final class FileSystem
{
    // some awesome methods!
}
</code></pre>
<h3 id="3-Create-config">3. Create config</h3>
<p>This is similar to <code>app/config/services.neon</code>, just in different location:</p>
<pre><code class="language-yaml"># src/FileSystem/config/services.neon

- FileSystem\FileSystem</code></pre>
<h3 id="4-Create-an-Extension">4. Create an Extension</h3>
<pre><code class="language-php"># src/FileSystem/DI/FileSystemExtension.php

&lt;?php declare(strict_types=1);

namespace FileSystem\DI;

use Nette\DI\Compiler;
use Nette\DI\CompilerExtension;

final class FileSystemExtension extends CompilerExtension
{
    public function loadConfiguration()
    {
        // this method loads servcies from config and registers them do Nette\DI Container
        Compiler::loadDefinitions(
            $this-&gt;getContainerBuilder(),
            $this-&gt;loadFromFile(__DIR__.'/../config/services.neon')
        );
    }
}</code></pre>
<h3 id="5-Register-it-in-Application">5. Register it in Application</h3>
<pre><code class="language-yaml"># app/config/config.neon

extensions:
    - FileSystem\DI\FileSystemExtension</code></pre>
<p>That's it!</p>
<h2 id="Try-it-Out">Try it Out</h2>
<p>Now try using <code>FileSystem\FileSystem</code> in HomepagePresenter:</p>
<pre><code class="language-php"># app/presenters/HomepagePresenter.php

&lt;?php declare(strict_types=1);

namespace App\Presenters;

use FileSystem\FileSystem;

class HomepagePresenter extends BasePresenter
{
    public function __construct(FileSystem $fileSystem)
    {
        $this-&gt;fileSystem = $fileSystem;
    }
}</code></pre>
<p>and running application:</p>
<img src="/assets/images/posts/2017/nette-extension/bug.png" class="img-thumbnail">
<p><strong>Fails</strong>? Damn, I can't put this on my blog.</p>
<p>Oh, <strong>we need to tell composer about these classes</strong>. He doesn't know, where to find it.</p>
<pre><code class="language-javascript">{
    "require-dev": {
        "..."
    },
    "autoload": {
        "psr-4": {
            "FileSystem\\": "src/FileSystem"
        }
    }
}</code></pre>
<p>And manually rebuild <code>autoload.php</code> (composer does by default only after <code>composer update</code>):</p>
<pre><code class="language-bash">composer dump-autoload</code></pre>
<p>Refresh and...</p>
<img src="/assets/images/posts/2017/nette-extension/good.png" class="img-thumbnail">
<p>...it works!</p>
<p>Phew! That would have been embarrassing.</p>
<h3 id="To-Sum-Up">To Sum Up</h3>
<p><strong>Now you know how to do your first extension</strong>.</p>
<ul>
<li>create a directory in <code>/src</code></li>
<li>add <code>/src/&lt;package-name&gt;/services.neon</code></li>
<li>add <code>/src/DI/&lt;package-name&gt;Extension.neon</code></li>
<li>register extension to <code>app/config/config.neon</code></li>
<li>and extend <code>autoload</code> section in <code>composer.json</code> (prevents from putting failing code to public blog :))</li>
</ul>
<p><strong>Let me know if you get stuck somewhere</strong>. I want this tutorial to be as easy to understand as possible.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/02/15/minimalistic-way-to-create-your-first-nette-extension</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Wed, 15 Feb 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/02/15/minimalistic-way-to-create-your-first-nette-extension#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Drop all Service Tags in Your Nette and Symfony Applications ]]></title>
                <link>https://tomasvotruba.com/blog/2017/02/12/drop-all-service-tags-in-your-nette-and-symfony-applications</link>
                <description><![CDATA[ <p>What is tagging for? Why we should get rid of it?
Today I will show you, how to do it gradually without breaking the application.</p> ]]></description>
                <content:encoded><![CDATA[ <p>This post is follow up to <em><a href="/blog/2016/12/24/how-to-avoid-inject-thanks-to-decorator-feature-in-nette/">How to Avoid Inject Thanks to Decorator feature in Nette</a></em>. Go read it if you missed it.</p>
<h2 id="What-is-Tagging-For">What is Tagging For?</h2>
<pre><code class="language-yaml"># app/config/services.neon / app/config/services.yml

services:
    simple_console_command:
        class: "App\Command\SimpleConsoleCommand"
        tags:
            - "console.command"</code></pre>
<p>It is a method to mark services, so Dependency Injection Container could find them easily.</p>
<p>With that, we can add all Commands to Console Application during Dependency Injection Container compilation.</p>
<pre><code class="language-php">$commands = $this-&gt;container-&gt;findByTag('console.command');
$application-&gt;addMethod('addCommands', [$commands]);</code></pre>
<h2 id="Bare-Tagging-is-Duplicated-Information">Bare Tagging is Duplicated Information</h2>
<p>But is it really needed?</p>
<p>Without tags, you would probably write something like this:</p>
<pre><code class="language-php">$commands = $this-&gt;container-&gt;findAllByType(Command::class);
$application-&gt;addMethod('addCommands', [$commands]);</code></pre>
<p><strong>But it's here, because of historical reasons</strong>. Both Nette and Symfony ecosystem support it, so many packages adopted
it without thinking twice.</p>
<h3 id="The-Only-Place-To-Consider-Using-Tags-Metadata">The Only Place To Consider Using Tags: Metadata</h3>
<p>If you need to setup service priority registration or <strong>any information, that you can't put inside the class
itself</strong>, tagging is the only way:</p>
<pre><code class="language-yaml"># app/config/services.neon / app/config/services.yml

services:
    simple_console_command:
    class: "App\Command\SimpleConsoleCommand"
    tags:
        name: "console.command"
        priority: 20</code></pre>
<p>It's often used <strong>to duplicate information about a class or interface this service extends or implements</strong>. <code>Symfony\Component\Console\Command\Command</code> in this case.</p>
<h3 id="How-to-get-rid-of-them-Decorator-to-the-rescue">How to get rid of them? Decorator to the rescue!</h3>
<p>When I see this pollution in the code, I try to explain there is no added value. Till now, there was only solution in
Nette and Symfony application were doomed to use this anti-pattern.</p>
<p>Now there is Decorator in Symfony as well. Let's see.</p>
<h2 id="Get-Rid-of-Tagging-in-Nette">Get Rid of Tagging in Nette</h2>
<p>In you Nette Application, you probably already use</p>
<pre><code class="language-yaml"># app/config/config.neon

services:
    -
        class: App\Console\FirstCommand
        tags: [kdyby.console.command]
    -
        class: App\Console\SecondCommand
        tags: [kdyby.console.command]
    -
        class: App\Console\ThirdCommand
        tags: [kdyby.console.command]
    -
        class: App\EventSubscriber\FirstEventSubscriber
        tags: [kdyby.subscriber]
    -
        class: App\EventSubscriber\SecondEventSubscriber
        tags: [kdyby.subscriber]
    -
        class: App\EventSubscriber\ThirdEventSubscriber
        tags: [kdyby.subscriber]</code></pre>
<p>So much reading, huh? Imagine 50 more of these.</p>
<p>This is exactly the place to use <a href="/blog/2016/12/24/how-to-avoid-inject-thanks-to-decorator-feature-in-nette/">Nette Decorator feature</a>.</p>
<pre><code class="language-yaml"># app/config/config.neon

services:
    - App\Console\FirstCommand
    - App\Console\SecondCommand
    - App\Console\ThirdCommand
    - App\EventSubscriber\FirstEventSubscriber
    - App\EventSubscriber\SecondEventSubscriber
    - App\EventSubscriber\ThirdEventSubscriber

decorator:
    Symfony\Component\Console\Command\Command:
        tags: [kdyby.console.command]
    Symfony\Component\EventDispatcher\EventSubscriberInterface:
        tags: [kdyby.subscriber]</code></pre>
<p>The more services you have, the more cleaner and readable code this approach brings.</p>
<h3 id="Minitip">Minitip</h3>
<p>If you don't like the decorator and don't like to one service take 3 lines of config instead of 1, you can use this
shortage:</p>
<pre><code class="language-yaml"># app/config/config.neon

services:
    - { class: App\Console\FirstCommand, tags: [kdyby.console.command] }</code></pre>
<p>This is what I did, before I used Decorator and before I dropped tags from my coding habbits.</p>
<h2 id="Get-Rid-of-Tagging-in-Symfony">Get Rid of Tagging in Symfony</h2>
<p>Symfony <a href="https://symfony.com/doc/current/reference/dic_tags.html">has over 40 tags</a> that are coupled to many internal parts. This is barely half of it:</p>
<img src="/assets/images/posts/2017/decorator/symfony-tags-half.png" class="img-thumbnail" alt="Tag list">
<p>If we use the same setup as we used in Nette above, in Symfony it would look like this:</p>
<pre><code class="language-yaml"># app/config/config.yml

services:
    App\Console\FirstCommand:
        tags:
            - { name: console.command }
    App\Console\SecondCommand:
        tags:
            - { name: console.command }
    App\Console\ThirdCommand:
        tags:
            - { name: console.command }
    App\EventSubscriber\FirstEventSubscriber:
        tags:
            - { name: kernel.event_subscriber }
    App\EventSubscriber\SecondEventSubscriber:
        tags:
            - { name: kernel.event_subscriber }
    App\EventSubscriber\ThirdEventSubscriber:
        tags:
            - { name: kernel.event_subscriber }</code></pre>
<p>I want to quit this project already... but wait!</p>
<h3 id="You-can-use-new-autoconfigure-since-Symfony-3-3">You can use new <a href="https://symfony.com/blog/new-in-symfony-3-3-service-autoconfiguration">autoconfigure</a> since Symfony 3.3</h3>
<pre><code class="language-yaml"># app/config/config.yml

services:
    _defaults:
        autowire: true # recommended
        autoconfigure: true

    App\Console\FirstCommand: ~
    App\Console\SecondCommand: ~
    App\Console\ThirdCommand: ~
    App\EventSubscriber\FirstEventSubscriber: ~
    App\EventSubscriber\SecondEventSubscriber: ~
    App\EventSubscriber\ThirdEventSubscriber: ~</code></pre>
<p>That's it. Pretty cool, huh?</p>
<h2 id="How-do-you-Approach-This">How do you Approach This?</h2>
<p>Again, this is my point of view on making things easy, KISS and DRY.</p>
<p><strong>How do you approach this duplication?</strong> What do you like about it apart &quot;it's in the docs&quot; or &quot;everybody does that&quot;?</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/02/12/drop-all-service-tags-in-your-nette-and-symfony-applications</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Sun, 12 Feb 2017 00:00:00 +0000</pubDate>
                                    <updated>2017-05-01UTC00:00:000</updated>
                    <atom:updated>Mon, 01 May 2017 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Mon, 01 May 2017 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/02/12/drop-all-service-tags-in-your-nette-and-symfony-applications#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Decouple Monolith like a Boss with Composer Local Packages ]]></title>
                <link>https://tomasvotruba.com/blog/2017/02/07/how-to-decouple-monolith-like-a-boss-with-composer-local-packages</link>
                <description><![CDATA[ <p>While building PHP applications that grows and grows, you often get to the situation when there is too much code. You get easily lost, duplicate and code smells and rottens. The cognitive upkeep to add a new class is bigger every day.
<br><br></p> ]]></description>
                <content:encoded><![CDATA[ <p>I found first <a href="http://www.whitewashing.de/2015/04/11/monolithic_repositories_with_php_and_composer.html">article about this topic</a> in 2015, when Benjamin Eberlei created a tool called Fiddler. I was using similar approach in that time for a few months and I was happy I'm not alone.</p>
<p>Benjamin wrote about an idea, that is <strong>now integrated in composer by default</strong>. To my surprise, nobody knows about it!
That's similar case for great Composer tools like <a href="https://github.com/hirak/prestissimo">prestissimo</a> or <a href="https://github.com/Soullivaneuh/composer-versions-check">versions-check</a>.</p>
<p>But first, we'll look at current solutions and why I don't see them scalable. We all tried them in Lekarna.cz and learned by painful experience that they don't work.</p>
<h2 id="1-Just-Put-The-Code-to-libs-or-src-Directory">1. Just Put The Code to <code>/libs</code> or <code>/src</code> Directory</h2>
<p>This is most common solution I see. Is there a login logic? Just put the code to <code>/libs/Login</code> or <code>/src/LoginBundle</code>.
Add it to <code>$robotLoader</code> (Nette) or Composer in Symfony and it works.</p>
<h3 id="Advantages">Advantages</h3>
<ul>
<li>it's simple</li>
<li>it's the least you can do</li>
</ul>
<h3 id="Disadvantages">Disadvantages</h3>
<ul>
<li>still coupled to the application, just now on 2 different places instead of 1</li>
<li>service/route registration is in <code>app</code> - this is cyclic dependency (also known as &quot;vicious circle&quot;)</li>
<li>it shows others that putting code to 2 or 3 places is ok</li>
<li>the &quot;package&quot; is coupled to the application and it's not easy to use somewhere else</li>
<li>dependencies of this &quot;package&quot; are unknown</li>
</ul>
<p><strong>It doesn't scale!</strong></p>
<h2 id="2-Create-Private-Packages">2. Create Private Packages</h2>
<p>This way is a bit pro. We used Gitlab and Satis - it took a month to set up all access rights correctly (Gitlab CI and Satis server tend to argue). It's so much pain, there is even <a href="https://packagist.com">official paid service</a> for it.</p>
<h3 id="Advantages">Advantages</h3>
<ul>
<li>all is clean, separated and leads to good practices</li>
<li>all code and test are in separated extension</li>
<li>package have own README.md with documentation, so it's natural to document it</li>
</ul>
<h3 id="Disadvantages">Disadvantages</h3>
<ul>
<li>development is 4 step hell:
<ul>
<li>add feature to the package</li>
<li>push and tag package</li>
<li>wait</li>
<li>run <code>composer update</code> in application and see the results</li>
</ul></li>
<li>it requires lot of maintainer skills (I would say at least 1 year in open-source) to do it fine</li>
<li>it's premature decoupling that doesn't bring joy</li>
</ul>
<p><strong>It doesn't scale!</strong></p>
<h2 id="3-Publish-Open-source-Packages">3. Publish Open-source Packages</h2>
<p>I love this most and it was great for some packages. That's how many <a href="https://github.com/Zenify">Zenify</a> Doctrine-related packages were born.</p>
<h3 id="Advantages">Advantages</h3>
<ul>
<li>you feel great for giving back to community</li>
<li>people will help improve the package</li>
<li>open-source packages tend to have longer lifespan than private packages</li>
</ul>
<h3 id="Disadvantages">Disadvantages</h3>
<ul>
<li>even more steps to hell</li>
<li>it's less flexible in experiments - somebody else is using it</li>
<li>you can't money or security related packages like that</li>
</ul>
<p><strong>It doesn't scale.</strong></p>
<p>During this path of packages we started to feel desperate. Nothing was good enough. I was losing my belief in open source packages and packages themselves.</p>
<h2 id="Composer-Saved-my-Life">Composer Saved my Life!</h2>
<p>Not sure why and how, but in composer <a href="https://getcomposer.org/doc/05-repositories.md#path">&quot;path&quot; feature</a> was added. <strong>And it was exactly what we looked for!</strong></p>
<p>This is so simple that many people find it hard to believe. Forget private and open-sourced packages. Forget Gitlab, Satis and Github. This is <strong>local filesystem only</strong> solution. <strong>All you need is composer</strong>.</p>
<h3 id="Lets-create-First-Local-Package-Filesystem">Lets create First Local Package - Filesystem</h3>
<p>Back to Lekarna.cz. We had application that used own <em>filesystem services</em>. It was registered in <code>app/config/config.neon</code> (Nette app) and it was used in various scenarios. Once we needed to create directory, store image, create image from database, download remote <code>.xml</code> etc. <strong>It was growing and more and more coupled.</strong></p>
<p>People started to create new classes and methods for what was already there, because there was too much code and nobody knew about it.</p>
<p>I had enough!</p>
<p>So I started to decouple this filesystem logic. How?</p>
<h3 id="1-Create-Directory-For-Local-Package">1. Create Directory For Local Package</h3>
<pre><code class="language-bash">/packages
    /lekarna
        /filesystem</code></pre>
<h3 id="2-Add-Basic-Package-Directories-and-Files">2. Add Basic Package Directories and Files</h3>
<pre><code class="language-bash">/packages
    /lekarna
        /filesystem
            /src
            /tests
            README.md
            composer.json</code></pre>
<h3 id="3-Name-the-Package-in-its-composer-json">3. Name the Package in its <code>composer.json</code></h3>
<p>The file is <code>packages/lekarna/filesystem/composer.json</code>:</p>
<pre><code class="language-javascript">{
    "name": "lekarna/filesystem",
    "require": {
        "php": "^7.1",
        "nette/utils": "^2.4"
    },
    "autoload": {
        "psr-4": {
            "Lekarna\\Filesystem\\": "src"
        }
    }
}</code></pre>
<h3 id="4-Register-Package-to-Main-composer-json">4. Register Package to Main <code>composer.json</code></h3>
<pre><code class="language-javascript">{
    "require": {
        "lekarna/filesystem": "@dev"
    },
    "repositories": [
        { "type": "path", "url": "packages/lekarna/filesystem" }
    ]
}</code></pre>
<p>Run</p>
<pre><code class="language-bash">composer update</code></pre>
<p>and your package is ready. That's it! Easy, step-by-step maturing and scalable architecture pattern.</p>
<p><strong>How do you maintain huge code bases?</strong></p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/02/07/how-to-decouple-monolith-like-a-boss-with-composer-local-packages</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Tue, 07 Feb 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/02/07/how-to-decouple-monolith-like-a-boss-with-composer-local-packages#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How Monolithic Repository in Open Source saved my Laziness ]]></title>
                <link>https://tomasvotruba.com/blog/2017/01/31/how-monolithic-repository-in-open-source-saved-my-laziness</link>
                <description><![CDATA[ <p>I've started creating open-source about 6 years ago. Now I'm maintaining over 20 repositories. I used classic standalone repositories, but with each new package I wanted to add, I realized, how much work it needs to keep everything up-to-date and consistent. So I didn't and got stuck.
<br><br>
Fortunately, I noticed <a href="https://www.youtube.com/watch?v=4w3-f6Xhvu8">talk from Fabien</a> about <a href="http://danluu.com/monorepo/">monorepo</a> and Symfony. I said to myself: &quot;I don't know a thing about it. Let's try it out. I can always return if it sucks.&quot;
<br><br>
I never did. Today I will show you <strong>why I see monorepo approach in open-source so awesome</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>If you don't have 50 minutes to watch the talk (my case), here are <strong><a href="https://speakerdeck.com/fabpot/a-monorepo-vs-manyrepos">40 slides</a></strong> from it.</p>
<p>Fabien introduces a tool, that helps you with splits - <a href="https://github.com/splitsh/lite">splitsh</a>. Do you understand it? Me neither. Splitsh is fast yet complex tool to maintain Symfony and Blackfire ecosystem. <strong>All we need is one git command</strong>.</p>
<p>But we'll get to that later. First things first.</p>
<h3 id="What-is-Monorepo">What is Monorepo?</h3>
<p><strong>Monorepo</strong> (for monolithic repository) is single repository, which contains code for group of packages (framework, application...).</p>
<p>Not only Symfony, but also:</p>
<ul>
<li><a href="https://github.com/laravel/framework">Laravel</a></li>
<li><a href="https://github.com/Sylius/Sylius">Sylius</a></li>
<li><a href="https://github.com/elcodi/elcodi">Elcodi</a> - which is dead now</li>
</ul>
<p>Opposed to this is <strong>manyrepo</strong> approach (for many repositories), meaning every package is in his own repository.</p>
<p>It is used by:</p>
<ul>
<li><a href="https://github.com/nette">Nette</a></li>
<li><a href="https://github.com/doctrine">Doctrine</a></li>
<li><a href="https://github.com/thephpleague">PHPLeague</a></li>
</ul>
<p>and almost everybody else.</p>
<p>So how does this monorepo work?</p>
<h2 id="From-One-Heart-to-Many-Arteries">From One Heart to Many Arteries</h2>
<p>Imagine flow of a oxygenated blood from heart to arteries. All blood that was in heart, will drift to all arteries.</p>
<img src="/assets/images/posts/2017/monorepo/blood-vein.png" alt="Blod vein" class="img-thumbnail">
<p>From <strong>1 heart</strong> to <strong>many arteries</strong> in one direction. Same relation is between <strong>1 monolithic repository</strong> and <strong>many repositories</strong>.</p>
<p>This is related to commits and tagging:</p>
<ul>
<li><strong>Every commit</strong> that does changes is Symfony\Console code in monorepo, is also in Symfony\Console manyrepo.</li>
<li><strong>Every tag</strong> in monorepo, is also in all manyrepos.</li>
</ul>
<h2 id="What-Are-top-4-Advantages-of-Monorepo">What Are top 4 Advantages of Monorepo?</h2>
<h3 id="1-It-scales">1. It scales</h3>
<p>You have one repo to maintain.</p>
<ul>
<li>New package? Not a problem.</li>
<li>Changing name of method that is used by 10 other packages? Easier than ever.</li>
<li>Starting a framework? Ideal.</li>
</ul>
<p>That's the way Nette, Symfony and Laravel started and grew so much, even if only one person was behind majority of commits.</p>
<h3 id="2-Upgrade-Fast-Upgrade-Safe">2. Upgrade Fast, Upgrade Safe</h3>
<p>It's easy to make changes that affect all packages - bump to PHP 7.1, Symfony 3.2 or Nette 3.0 is a matter of minutes.
And I know it works on all packages. Before monorepo, I had to upgrade every package manually, which resulted in dissonance:
one package used Symfony\Console 3.2, but other only 2.8 and it got messy for no reason.</p>
<h3 id="3-Test-Both-on-Monorepo-and-Manyrepo-Level-With-Ease">3. Test Both on Monorepo and Manyrepo Level With Ease</h3>
<p>Another thing I love is testing both monorepo (all packages together) and manyrepo level. Once I spend 5 hours fixing a bug in Symfony\Process. It was difficult to find, because all tests were passing. Even for testing just the Symfony\Process directory made it pass. But when I copied only the Symfony\Process code to the standalone directory, it failed. Few hours later I found out, it's somehow related to having Symfony\Stopwatch package. Yea, WTF.</p>
<p><strong>That could be caught testing on monorepo level.</strong></p>
<p>On the other hand, monorepo testing is also important. When Nette was split from monorepo to manyrepo only, all tests were passing packages were standalone. But in combination some of them didn't.</p>
<p>This is not issue of the code itself, but of the testing architecture.</p>
<h3 id="4-The-Burnout-is-Much-More-Harder">4. The Burnout is Much More Harder</h3>
<p>When maintaining 15 own packages, <a href="https://github.com/Apigen">ApiGen</a> and co-maintaining few more repositories, I spent a lot of time by package management and not coding. It wasn't fun and I contributed less and less.</p>
<p>Many packages like <a href="https://github.com/doctrine">Doctrine</a> or <a href="https://github.com/Kdyby">Kdyby</a> are slowing down in evolution because of this.</p>
<p>Again, it's a matter of project architecture rather than the code or maintainers.</p>
<p>These are the best for me, but there are many more described in <a href="https://speakerdeck.com/fabpot/a-monorepo-vs-manyrepos">those slides</a> by Fabien.</p>
<h2 id="Example-How-it-s-done-in-Symplify">Example: How it's done in Symplify</h2>
<h3 id="Monorepo">Monorepo</h3>
<p><a href="https://github.com/symplify/symplify">symplify/symplify</a></p>
<pre><code class="language-bash">/packages
    /Symplify
        /DefaultAutowire
            /src
            /tests
            composer.json</code></pre>
<h3 id="Run-Git-Command">Run Git Command</h3>
<p>Inspired by <a href="https://github.com/laravel/framework/tree/17ee3fd536d1db54dd4ae117c5665b6d03761337/build">Laravel</a>, all we really need is one git command. To split:</p>
<pre><code class="language-bash">git subsplit init git@github.com:symplify/symplify.git
git subsplit publish --heads="master" packages/DefaultAutowire:git@github.com:Symplify/DefaultAutowire.git
rm -rf .subsplit/</code></pre>
<p>It says: take code from <code>packages/DefaultAutowire</code> directory and put it to <code>git@github.com:Symplify/DefaultAutowire.git</code> repository.</p>
<h3 id="Manyrepo">Manyrepo</h3>
<p><a href="https://github.com/Symplify/DefaultAutowire">Symplify/DefaultAutowire</a></p>
<p>As a result, we have this:</p>
<pre><code class="language-bash">/src
/tests
composer.json</code></pre>
<p>That's it! Could it be simpler?</p>
<h3 id="Further-reading-Local-Packages">Further reading - Local Packages</h3>
<p>I recommend to read <a href="http://www.whitewashing.de/2015/04/11/monolithic_repositories_with_php_and_composer.html">Monolithic Repositories with PHP and Composer</a> by Benjamin Eberlei (Doctrine Core Maintainer). It's surpassed by composer <em>local packages</em>, but points remain the same. Don't worry, I will write about <em>local packages</em> in the near future.</p>
<p>If you like monorepo approach, but prefer own tagging per package, Martin Zlámal recently wrote about <a href="http://zlml.cz/vy-jeste-nemate-svuj-superprojekt">git submodule approach</a> (in Czech).</p>
<h3 id="How-do-you-like-this">How do you like this?</h3>
<p>This is my point of view.</p>
<p>Do you maintain lot of repositories? How do you make it fun to code and care for all of them?</p>
<p>Let me know in the comments. Thank you.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/01/31/how-monolithic-repository-in-open-source-saved-my-laziness</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Tue, 31 Jan 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/01/31/how-monolithic-repository-in-open-source-saved-my-laziness#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Why I Switched Scrutinizer for PHPStan and You Should Too ]]></title>
                <link>https://tomasvotruba.com/blog/2017/01/28/why-I-switched-scrutinizer-for-phpstan-and-you-should-too</link>
                <description><![CDATA[ <p>I used Scrutinizer for a few years now for code coverage and code quality. Configuration was far complex, some issues appeared and build kept failing. But I really wanted a code quality checker for my open-source projects and this was the best tool available.</p>
<p>But last week I had an issue with simple <code>composer install</code> command and I have had enough. Then <strong>my attention turned to PHPStan</strong>, soon-to-be its replacement.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="What-is-PHPStan">What is PHPStan</h2>
<p><strong>PHPStan is a tool for static analysis of PHP code</strong>. It's open source and free to use.
You can read more about it in this post with very true title - <a href="https://medium.com/@ondrejmirtes/phpstan-2939cd0ad0e3">PHPStan: Find Bugs In Your Code Without Writing Tests!</a></p>
<img src="https://raw.githubusercontent.com/phpstan/phpstan/master/build/phpstan.gif" alt="PHPStan in action" class="img-thumbnail">
<h2 id="Why-I-Prefer-It-over-Scrutinizer-and-You-Should-Too">Why I Prefer It over Scrutinizer (and You Should Too)</h2>
<h3 id="It-Is-Open-Source">It Is Open-Source</h3>
<p><strong>I can improve it, I can add an issue, I can see its development</strong>. I can't do anything like that with Scrutinizer. It used to be <a href="https://github.com/scrutinizer-ci/scrutinizer">open-source</a> but got closed. That's was a huge step back.</p>
<h3 id="It-Focuses-Just-on-PHP">It Focuses Just on PHP</h3>
<p><strong>It's a PHP tool that checks PHP code.</strong> Scrutinizer, on the other hand, focuses on various languages - Python, Ruby, soon Java and Scala. That's definitely a good direction, but not if a simple <code>composer install</code> command breaks and is not fixed for months.</p>
<h3 id="I-Can-Control-It">I Can Control It</h3>
<p>I can use it for private packages. I can download it, extend it in various ways (I can define magic behaviour of my classes) and even write my own checks.</p>
<h2 id="How-to-Switch-from-Scrutinizer-to-PHPStan-in-4-Steps">How to Switch from Scrutinizer to PHPStan in 4 Steps</h2>
<h3 id="1-Disable-Scrutinizer-Code-Rating">1. Disable Scrutinizer Code Rating</h3>
<p>Drop this from <code>.scrutinizer.yml</code>:</p>
<pre><code class="language-yaml">checks:
    php:
        code_rating: true</code></pre>
<h3 id="2-Add-PHPStan-Dependency">2. Add PHPStan Dependency</h3>
<pre><code class="language-bash">composer require phpstan/phpstan --dev</code></pre>
<h3 id="3-Setup-Command-in-composer-json">3. Setup Command in <code>composer.json</code></h3>
<p>This step is optional and it might seem weird seeing it for the first time, but I like the united usage (on all different projects and environments).</p>
<pre><code class="language-json">{
    "scripts": {
        "phpstan": "vendor/bin/phpstan analyse src --level=0"
    }
}</code></pre>
<p>Now you can run with the same script, even if the settings changes (and it will):</p>
<pre><code class="language-bash">composer phpstan</code></pre>
<h3 id="4-Setup-you-CI">4. Setup you CI</h3>
<pre><code class="language-yml"># .travis.yml
script:
    - composer phpstan</code></pre>
<p>Commit and... push! Now you are running PHPStan on your open-source project. Congrats!</p>
<h2 id="The-One-Thing-I-Love-About-PHPStan">The One Thing I Love About PHPStan</h2>
<p>One last thing. You may have noticed the <code>level</code> option. What's that for? PHPStan has now 6 levels (in time of writing this article) - <strong>0 = least strict, 5 = the most strict</strong>.</p>
<p>This allowed me to <strong>put PHPStan to action without any huge work</strong>. I start with level 0, 12 errors were found and fixed them.</p>
<p>Next week, when I'm rested and full of joy, I can go to level 1, fix another 8 errors.</p>
<p>I love this approach over traditional overwhelming &quot;500 errors found. Fix them all or CI will keep failing.&quot;. That usually leads to removing the tool and to very long fixing process. I remember my long night hours with Scrutinizer just to get from code quality from 6 to 10.</p>
<h3 id="Try-It-Out">Try It Out...</h3>
<p>...on your open-source or local projects and let me know how you like it.</p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/01/28/why-I-switched-scrutinizer-for-phpstan-and-you-should-too</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Sat, 28 Jan 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/01/28/why-I-switched-scrutinizer-for-phpstan-and-you-should-too#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 4 Emotional and Honest Reasons Why I Quit my Twitter ]]></title>
                <link>https://tomasvotruba.com/blog/2017/01/20/4-emotional-reasons-why-I-quit-my-twitter</link>
                <description><![CDATA[ <p>Nowadays we tend to live busy life with all those social networks, notifications and pings. So busy, we don't have emotional space to just evaluate &quot;How do I like that?&quot;. In my life, this creates cycles, where I keep doing over and over the same thing without any progress.<br><br>After few months feeling bad with Twitter, I've finally decided to quit. Instead of technical point of view <strong>I will focus on my feelings - because that's what matters the most</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Before I started this article, I read
<a href="http://www.forbes.com/sites/laurenorsini/2015/11/11/i-quit-twitter-and-my-life-got-better-heres-why-im-going-back">I Quit Twitter And My Life Got Better. Here's Why I'm Going Back</a>. In the article Lauren describes <strong>what was it like to have 1 week without Twitter and why she got back</strong>. If you use Twitter, I recommend you reading it. There are some great insights on autopilot behavior.</p>
<p>Now here is my story...</p>
<p>I felt bad using Twitter last few months. <strong>I wasn't sure</strong> if I really want to quit Twitter.</p>
<h3 id="I-Tried-Small-Experiments-Hoping-To-Get-Better">I Tried Small Experiments Hoping To Get Better</h3>
<ul>
<li>I un-followed people down to zero.</li>
<li>I limited my time there to 10 minutes in the evening.</li>
<li>I tried different approach for Tweets and retweets:
<ul>
<li>pools to engage with followers</li>
<li>retweet the most popular Tweets from the past</li>
<li>mention multiple people</li>
<li>use 5+ hashtags</li>
<li>add 1 to 5 images</li>
</ul></li>
<li>I talked with friends how do they enjoy Twitter.</li>
<li>I requested feedback from marketing expert to my Tweets.</li>
<li>I tried using services to automate like <a href="https://buffer.com">Buffer</a> (thank you <a href="https://www.tomasfejfar.cz">Tomáš Fejfar</a> for the tip) or <a href="https://github.com/search?l=PHP&amp;q=twitter&amp;type=Repositories&amp;utf8=%E2%9C%93">Twitter API PHP packages</a>.</li>
</ul>
<p>I really tried, but none of these made me feel significantly better. So last experiment: I quit.</p>
<p><em>Interesting. This is very similar to my approach to crisis in relationships.</em></p>
<p><strong>What were those deal breakers that tear us apart?</strong></p>
<h2 id="1-I-was-Addicted-Give-me-my-Dopamine-Shot">1. I was Addicted - Give me my Dopamine Shot!</h2>
<p>Every like made me happy. <strong>Every retweet made happier three-times</strong>. I only wanted to invest just a little attention, so I refocused on numbers instead of content.
<strong>It's like trying to build a deep connection with somebody having only a 20 minutes a day</strong>. This frustrated me a lot, because I prefer working on content over collecting numbers.</p>
<p>I talked about my addiction with <a href="http://petrvacha.com">Petr Vácha</a> and my intentions to quit, and he <strong>suggested me to use it only once a day</strong>.
I tried it for few days and it was great. I got higher dopamine shots in the end of the day.</p>
<p>The only issue for me was <strong>I had to focus to not to think on Twitter throughout the whole day</strong>. It was like starving the whole day to eat once in the evening.
It worked technically, <strong>but it didn't feel right</strong>. I could spend 5 minutes on 10 social networks and spend less than hour, but I want to enjoy this by heart, not by my inner computer.</p>
<p>I know I can't do something for only 50 %. I either do it close to 100 % or go another way.</p>
<h2 id="2-I-Tried-so-Hard-to-Look-Good">2. I Tried so Hard to Look Good</h2>
<ul>
<li>I planned Tweets for one per day, so I won't spam.</li>
<li>I retweeted Tweets I found interesting.</li>
<li>I've added images, hashtags.</li>
<li>I have read many how-to-tweet articles.</li>
<li>I tweeted only valuable and positive stuffs. Not in relation to reality, really.</li>
</ul>
<p>Few month later I realized <strong>I'm turning into news machine</strong>. So I asked my followers, <a href="https://twitter.com/VotrubaT/status/816753682482085896">how do you use Twitter</a>?</p>
<p>I found there are many news channel that already cover this field.</p>
<p>Second, <strong>I found I have reactive-response syndrome: for every message I have to have an answer</strong>. It's close to <a href="https://zenhabits.net/miss">fear of missing out</a>.</p>
<p>That included conversations under tweets, checking Twitter often for new answers, and trials to explain complex problems and miss-understandings under 140 characters.</p>
<h2 id="3-It-s-Boring">3. It's Boring</h2>
<p>Twitter innovated its service maybe twice since I used it, not much news. Also social adaptions is slow - not many new people are joining Twitter.</p>
<p>I was trying to find fun in service that didn't gave it to me. <strong>It's like seeking a passion in relationship with woman I'm not attracted to.</strong></p>
<p>What I like about Facebook, Github or PHPStorm is that <strong>they evolve and innovate</strong>. Sometimes I like it, sometimes I don't, but <strong>I know they are trying to be better</strong>.</p>
<p>If Twitter was a person, it would be fearful virgin in his 30ties sticking to first job with no girlfriend.</p>
<h2 id="4-I-already-Love-Somebody-Else">4. I already Love Somebody Else</h2>
<p>140 limit for Tweet is fine, but I want to get deeper. I also don't like random Tweet stream: one day 50 tweets, other day 5. What the hell, man? That's so schizophrenic.</p>
<p><strong>I love system, regularity and predictability</strong>. This is the best way to educate constantly in certain speed.</p>
<p>That's why I switched from Tweetdeck-hashtag-group-following based to regular newsletter one in last year.</p>
<p>I started to follow:</p>
<ul>
<li><a href="https://info.jetbrains.com/PHP-Annotated-Subscription.html">PHP Annotated Monthly</a> from JetBrains (PHPStorm guys)</li>
<li><a href="http://www.phpweekly.com">PHP Weekly</a></li>
<li><a href="https://pehapkari.cz/#newsletter">Měsíčník pro Péhápkaře</a></li>
<li><a href="https://www.respekt.cz/echo/neco-konci-neco-zacina">Jan Růžička - Týden v Médiích</a> (in the bottom)</li>
<li><a href="http://www.danpink.com/pinkcast">Pink Cast</a></li>
</ul>
<p>And it's much better.</p>
<h2 id="I-Love-Experiments">I Love Experiments</h2>
<p>Leo Babauta happily dropped Twitter in 2013. In <a href="https://zenhabits.net/unline">Simplify the internet</a> he wrotes:</p>
<blockquote>
<p>If you’re going to do Facebook, don’t do other ones too. You can quit Twitter and Instagram. Really you can!</p>
</blockquote>
<p>Reading this first time in December, I felt it's the right thing to do, yet brain was opposing with &quot;that is insane!&quot;.</p>
<p>My great inspiration from polyphasic sleep days Steve Pavlina <a href="http://www.stevepavlina.com/blog/2014/07/social-media-you-got-dumped">got social media dumped hard</a>.</p>
<blockquote>
<p>I basically asked myself which scenario seemed best over the next 10 years — going social media-free vs. continuing to use it.</p>
</blockquote>
<p>Followed by <a href="http://www.stevepavlina.com/blog/2015/07/one-year-without-social-media">a year later reflection</a>.</p>
<p><strong>I love social experiments.</strong> After <a href="https://psychologie.cz/serialy/polyfazicky-spanek">polyphasic sleep</a>, switching main job focus after 8 years, having a baby while being infertile, dropping from university, moving to Prague after settling down in Brno, <a href="/blog/2017/01/05/why-I-deleted-my-linkedin-account/">dropping LinkedIn</a> and moving completely alone for the first time, <strong>I really look forward to this one</strong>.</p>
<h3 id="Where-Do-You-Find-Me">Where Do You Find Me?</h3>
<p>See <a href="/contact">contact page</a>.</p>
<h3 id="What-about-Your-Socials-Experiments">What about Your Socials Experiments?</h3>
<p>I've already asked, why and what social networks do you use. Now, I would like to know, <strong>have you made any social network experiment?</strong>
How did it go? Did you like that?</p>
<p>I look forward to your answers!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/01/20/4-emotional-reasons-why-I-quit-my-twitter</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Fri, 20 Jan 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/01/20/4-emotional-reasons-why-I-quit-my-twitter#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 7 rad, které bych si dal před odchodem na vysokou školu ]]></title>
                <link>https://tomasvotruba.com/blog/2017/01/15/7-rad-ktere-bych-si-dal-pred-odchodem-na-vysokou-skolu</link>
                <description><![CDATA[ <p>Už jsou to 4 roky, co jsem ukončil vysokou školu, aniž by mi za to dali titul. Během těch 4 let se mě na vysokou školu ptalo lidí, které bych spočítal na prstech jedné ruky. A na titul? Nikdo.<br><br>
<strong>Nedávno jsem si volal s jedním středoškolákem a zjistil jsem, že vysoká škola je stále brána jako něco posvátného, důležitého a hlavně bez vhledu nikoho jiného než učitelů a rodičů.</strong> Řekl jsem si, že sepíšu svoje postřehy a rady, které bych si moc rád dal 8 let zpátky. <strong>Jestli je ti 18-19 let a zvažuješ co dál, pokračuj.</strong></p> ]]></description>
                <content:encoded><![CDATA[ <p><strong>Disclaimer: Moje závěry plynou ze zkušeností ze studia v Brně na FIT VUT a FSS MUNI a kolem 300 rozhovorů se spolužáky a (po)vysokoškoláky z Brna, Prahy a Liberce. Pokud je to na tvé škole jinak, budu rád za tvůj pohled a tipy.</strong></p>
<h2 id="1-Zeptej-se-nekoho-kdo-na-vysokou-nesel">1. Zeptej se někoho, kdo na vysokou nešel</h2>
<p>Často jsem dostával informace od rodičů (mamka výšku má) nebo od učitelů na střední (tam ji mají všichni). <strong>To je jako se ptát na náboženství křesťanského kněze</strong>. Nejspíš bude vědět hodně o křesťanství, ale o budhismu ti sám od sebe neřekne.</p>
<p>Tomu se říká <a href="https://cs.wikipedia.org/wiki/Konfirma%C4%8Dn%C3%AD_zkreslen%C3%AD">Confirmation Bias</a> - lidé mají tendenci přijímat ty informace, které podporují jejich vlastní názor. Bacha na něj :)</p>
<h2 id="2-Najdi-si-zkusene-lidi-z-oboru-ktery-te-bavi">2. Najdi si zkušené lidi z oboru, který tě baví</h2>
<p>Já tohle neudělal, protože jsem nikoho takového neznal. Nebo jsem netušil, že je to důležité. Dneska bych šel na Facebook a vyhledal si &quot;podnikatel php programování&quot; a pozval první 3 výsledky na kafe.</p>
<h3 id="Kde-takove-lidi-najit">Kde takové lidi najít?</h3>
<p>Pro začátek asi nebudeš chtít <a href="https://poradci.cz">platit za profíka</a> řádově 1000 Kč. Naštěstí jsou levnější cesty:</p>
<ul>
<li><a href="https://www.naucmese.cz">Naučmese</a> - na kurzech za pár stovek najdeš různé lidi, kteří ti rádi poví o svých zkušenostech - sám jsem tam potkal pár zajímavých osobností</li>
<li><strong>FB skupiny</strong> - dneska už je snad na všechno skupina: programátoři, markeťáci, copywriteři, podnikatelé...</li>
</ul>
<h2 id="3-Vyska-je-inkubator-da-ti-cas-abys-mohl-najit-co-te-bavi">3. Výška je inkubátor: dá ti čas, abys mohl najít co tě baví</h2>
<p>Bez větších potíží na vysoké <strong>snadno získáš 3 roky času</strong>. Nájem a jídlo ti budou platit rodiče, nebudeš muset 3 roky nic dělat. Takový předčasný důchod &ndash; tak ho využij pro sebe:</p>
<ul>
<li>zkoušej různé aktivity, ve škole i mimo školu</li>
<li>dej si každý semestr <strong>1 předmět z jiného oboru</strong> (někde ho nemusíš dodělat, někde si ho ani nemusíš registrovat, stačí chodit)</li>
<li><strong>ochutnej rozmanitost zvyků, kterou ti přinesou vrstevníci z jiných měst či zemi</strong></li>
<li><strong>riskuj, nikdy nebude neúspěch levnější</strong> - s přítelkyní, ženou, firmou, smlouvou, full-time prací, dítětem nebo hypotékou už to nebude zadarmo</li>
</ul>
<p>Já tohle využil tak, že jsem při výšce začal podnikat. Kde jsem riskoval nejvíc? <strong>Začal jsem si říkat o větší peníze</strong>, než vrstevníci. Riskoval jsem nezaměstnanost, ale to mi mohlo být jedno (nebylo, byl jsem strašně vystrašenej, že mě odmítnou). Kdybych měl velké měsíční náklady, které musím zaplatit, určitě bych si to netroufnul. Paradoxní, že?</p>
<p>Díky tomu jsem se naučil, <strong>že cena je smluvní</strong>. Jak se domluvíme, taková bude. Když se domluvíme na 100 Kč/hod., tak to tak bude. Když se domluvíme na 800 Kč/hod., tak to tak bude.</p>
<h3 id="Neusni-na-vavrinech">Neusni na vavřínech</h3>
<p>V prváku budeš zažívat hodně změn, kterým budeš muset věnovat čas a úsilí. Stále si ale pamatuj, že je to na 3 roky - <strong>čas běží a i když je to pohoda, začni dělat něco navíc</strong>.</p>
<h2 id="4-Mej-skolu-jako-jednu-z-moznosti">4. Měj školu jako jednu z možností</h2>
<p>Spousta mých vrstevníků věnovalo 90 % času škole, protože neměli výrazné boční zájmy.
Zbytečně.</p>
<p>Je to podobně jako s prací:</p>
<img src="/assets/images/posts/2017/university/procrastination.png" class="img-thumbnail">
<p>Na to navazuje...</p>
<h2 id="5-Na-znamky-aplikuj-pravidlo-80-20">5. Na známky aplikuj pravidlo 80/20</h2>
<p>Nebo taky <a href="https://cs.wikipedia.org/wiki/Paret%C5%AFv_princip">Paretovo pravidlo</a>.</p>
<ul>
<li><strong>Abys prošel, stačí 20 % práce</strong></li>
<li><strong>Abys prošel na A, potřebuje 80 % práce.</strong></li>
</ul>
<p>Trvalo mi asi 1,5 roku, než jsem pochopil, že známka opravdu nevypovídá o mé inteligenci, společenském postavení a schopnostech. Je to jen číslo z nějakého testu. Tím to končí.</p>
<p>Stejně jako IQ je jen ukazatel schopnosti dosáhnout vysokého skóre v IQ testu, je známka ukazatel schopnosti uspět v daném testu.</p>
<p>Zvaž, co je pro tebe důležité a jestli těch 60 % energie chceš investovat do *<em>zvyšování písmenek a čísel v databázi nebo do rozvoje sebe sama</em>.</p>
<h2 id="6-Na-vysoke-skole-jsou-vyuceni-ucitele-ne-lide-z-praxe">6. Na vysoké škole jsou vyučení učitelé, ne lidé z praxe</h2>
<p>Co mě nejvíc mrzí je, že na škole učí učitelé. Lidé, kteří na škole zůstali už od svých studentských let. Často pak mají minimální praxi z oboru, který učí. Jak to vypadlo?</p>
<p>O počítačích nás neučil člověk, který navrhuje efektivní procesory...
O lidské psychice nás neučil terapeut s 10letou praxí, který pomohl stovkám lidí...</p>
<p>...ale profesor, co píše výzkumy, opravuje písemky a jeho hlavní praxí je přednášení a vedení seminářů.</p>
<p>To všechno znamená...</p>
<h2 id="7-Priprav-se-na-know-how-lag">7. Připrav se na know-how-lag</h2>
<p>Čekal jsem, že se naučím něco aktuálního z oboru, kterému se chci věnovat. <strong>Dostalo se vzdělání spíše v historii mého oboru.</strong></p>
<p>Webové technologie byly zakázané téma. To nevadí, že na <a href="https://w3techs.com/technologies/details/pl-php/all/all">PHP jede 82 % webů</a>, budeš se učit elektrické obvody a programování procesorů.</p>
<p>Tento <em>know-how-lag</em> je ještě větší než na základní a střední škole. Pro aktuální informace musíš na internet nebo mezi lidi.</p>
<h3 id="Kde-jsi-ted">Kde jsi teď?</h3>
<p>Napiš mi klidně do komentářů, jestli jsi na střední škole, o výšce uvažuješ, na výšce už jsi nebo podnikáš.</p>
<p>Který bod ti přišel neujužitečnější? Co naopak vidíš úplně jinak?</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/01/15/7-rad-ktere-bych-si-dal-pred-odchodem-na-vysokou-skolu</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Sun, 15 Jan 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/01/15/7-rad-ktere-bych-si-dal-pred-odchodem-na-vysokou-skolu#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Jak psát zajímavé inzeráty pro ajťáky ]]></title>
                <link>https://tomasvotruba.com/blog/2017/01/10/jak-psat-zajimave-inzeraty-pro-ajtaky</link>
                <description><![CDATA[ <p>Už pár let sleduji pracovní PHP trh z pozice programátorů i z pohledu firem. S oběma stranami mám dobrý vztah. Tuším, co potřebují a co je trápí. <strong>Vidím, že se navzájem chtějí, jen komunikace trochu vázne</strong>.<br><br>Původně z toho měl být feedback na inzeráty Jobs.cz a Skrz.cz. Při jejich čtení mě ale napadlo <strong>spoustu dalších tipů, o které se chci podělit</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Cim-zacneme">Čím začneme?</h2>
<h3 id="Inzerat-je-reklamni-clanek-mel-by-vypadat-jako-od-copywritera">Inzerát je reklamní článek, měl by vypadat jako od copywritera</h3>
<p>Celý inzerát je jedno svádění. Na konci musíte kandidáta dostat do postele, tak aby se mu to líbilo. Až tak, že vám druhý den ráno napíše.</p>
<h2 id="Neni-to-o-vas-je-to-o-tom-kdo-vas-hleda">Není to o vás, je to o tom, kdo vás hledá</h2>
<p>Spousta inzerátu je psáno spíše jako sebeprezentace firmy - co umí, v čem je nejlepší a co dokázala. <strong>Lidi čtou, protože chtějí něco pro sebe</strong> - informace, peníze nebo zábavu. <strong>Co z pracovní pozice budou mít, hledají hned na začátku. Dejte jim to do první třetiny!</strong></p>
<h3 id="Budte-uprimni">Buďte upřímní</h3>
<p>Uvádějte jen technologie, které opravdu máte. Ne ty, které plánujte nebo chcete, ale ty které opravdu máte. Když vám na pohovor přijde člověk, který se těší na PHP 7, a vy ho budete teprve nasazovat, začne mít pocit, že vaříte z vody.</p>
<p><strong>Text musí být upřímný, aby čtenář dostal to, co očekává. Jedině tak vám bude věřit a vrátí se k vám.</strong></p>
<h3 id="Kamarad-taky-rad">Kamarád taky rád</h3>
<p><strong>Když u vás pracuje někdo šikovný, zmiňte ho v inzerátu</strong>. Lidé půjdou spíše za kamarádem nebo někým v komunitě známým, než jen do firmy.</p>
<p>Sám si pamatuju tyhle dvojice (i když už tam někteří nepracují):</p>
<ul>
<li>Filip Procházka - DámeJídlo, Rohlík</li>
<li>Ondrej Mirtes - Slevomat</li>
<li>Patrik Votoček - Shipito</li>
<li>Vašek Purchart - Lavito</li>
</ul>
<h3 id="Reknete-si-o-feedback-dovnitr-i-ven">Řeknete si o feedback - dovnitř i ven</h3>
<p><strong>1. Řekněte si o feedback v práci</strong></p>
<p>„Co tě nakonec dovedlo k nám místo ke konkurenci?“</p>
<p><strong>2. Dejte to přečíst někomu zvenčí</strong></p>
<p>Vaši zaměstnanci vás přirozeně vidí lépe než někdo, koho neživíte. Lidé zvenčí vám dají upřímnější zpětnou vazbu a spíše řeknou, co potřebují pro navázání vztahu.</p>
<p><strong>3. Které dvě věci se ti nejvíc líbí a které dvě bys zlepšil?</strong></p>
<p>Napište 3 lidem z cílovky. Tak máte šanci se dozvědět, jak působíte navenek &ndash; očima člověka, kterého hledáte.</p>
<h3 id="Svleknete-se">Svlékněte se</h3>
<p>Ukažte, jak to doopravdy děláte. Důkaz místo slibů.</p>
<p><strong>Děláte open-source?</strong> Ven s ním. Vím, že Skrz, Jobs, Slevomat, PeckaDesign nebo Shopsys mají balíčky na Githubu. Bohužel, ani u jednoho z inzerátů jsem odkaz nenašel.</p>
<p>Více informací mi může dát jenom náhled do zdrojáků aplikace. <strong>Open-source je velmi podceňovaný hiring nástroj.</strong></p>
<h3 id="Prodejte-sve-odlisnosti">Prodejte své odlišnosti</h3>
<p>Proto k vám lidi jdou, ne protože stejně jako ostatní děláte v PHP, Symfony, Nette a Doctrine.</p>
<h3 id="Priklady-pritazlivych-odlisnosti">Příklady přitažlivých odlišností</h3>
<p>Znám firmy, které:</p>
<ul>
<li>
<p><strong>Každý měsíc mají půldenní školení</strong> - dobrovolné a na přání programátorů.</p>
</li>
<li>
<p>Znám taky <strong>„každý měsíc máme půldenní školení“</strong>. To je ale povinné a zadání volí ředitel nebo jiné oddělení. Není větší pain, než být na školení „Jak dělat marketing na Instagramu“, když se chci naučit škálovat výkon přes sharding serverů.</p>
</li>
<li>
<p><strong>Dávají každému ročně 10 000 Kč na vzdělání</strong> a může si sám vybrat, jak je investuje.</p>
</li>
<li>
<p><strong>Každý poslední pátek v měsící dávají programátorům možnost refaktorovat</strong> jakoukoliv část kódu chtějí.</p>
</li>
</ul>
<h3 id="Na-velikosti-a-veku-nezalezi">Na velikosti a věku nezáleží</h3>
<p>Pojmy jako junior a senior mi nedávají smysl. Proč?</p>
<p>Představte si, že máme 2 lidi, kteří hledají práci:</p>
<p>A. Senior může být <strong>vývojář s 10 lety praxe</strong>, zná 1 framework, který se učil sám a nechce zkoušet druhý, protože ten jeden mu stačí.</p>
<p>B. Junior může být <strong>19letý borec</strong> před výškou, který říká, že ještě žádný framework nenapsal, tak asi úplně nebude dobrej. To že umí Elastic, Doctrine, Nette a začíná se Symfony nevidí jako výhodu (true story).</p>
<p><strong>Koho byste vzali?</strong></p>
<p>A teď si vemzměte, že do inzerátu napíšte <em>Senior</em>. Který z nich se vám přihlásí? Lidé se podceňují a o programátorech to platí desetinásob. Myslete na to.</p>
<img src="/assets/images/posts/2017/job-offers/attitude.jpg" class="img-thumbnail" alt="Attitude for skill">
<p>Zmínil jsem všechno, co jsem chtěl, tak se teď pojďme podívat na konkrétní inzeráty.</p>
<h2 id="Co-zlepsit-na-Jobs-cz">Co zlepšit na Jobs.cz</h2>
<p>Konkrétně na <a href="http://lmc.jobs.cz/pridej-se-k-nam/detail/?id=G2-1151391350-aden_brand0&amp;rps=186">tomto inzerátu</a>.</p>
<h3 id="Libi-se-mi">Líbí se mi</h3>
<ul>
<li>
<p><em>A co tě u nás bude dělat šťastným?</em> - Parádní nadpis!</p>
</li>
<li>
<p>„Místo CV nám klidně můžeš poslat jen link na tvůj profil na LinkedIn“ - super, použití běžného nástroje pro CV! Překvapuje mě, jak málo to vidím.</p>
</li>
<li>
<p>Děláte open-source zaměřený na testování - někam bych tam <a href="https://github.com/lmc-eu/steward">Stewarda</a> hodil.</p>
</li>
<li>
<p>V práci máte velkou monitorovací obrazovku. Tu bych do inzerátu přidal. Určitě zaujme a ujistí, že to s testy myslíte vážně. Jinde říkají, že testují, ale když chcete vidět testy, tak nějak nejsou.</p>
</li>
</ul>
<h3 id="Zmenil-bych">Změnil bych</h3>
<ul>
<li>
<p>Když čtu „znalost PHP 5“, říkám si: myslí 5.3 nebo 5.6? Mají tam projekty na všech těchto verzích? Buď bych napsal konkrétní verzi nebo jen PHP.</p>
</li>
<li>
<p>Mezi „JS frameworky“ patří Angular 1 a 2, ReactJs, jQuery a další. Umím třeba Angular 1, ale nevím, jestli to stačí. Může se stát, že potřebujete právě někoho přes Angular 1, ale protože to není napsáno, tak se takový člověk nepřihlásí. Radši bych vypsal o které konkrétní chcete.</p>
</li>
<li>
<p>Cokoliv po „spíš“ působí nejistě a nejasně. Upravil bych to do jednoznačného sdělení.</p>
</li>
</ul>
<h2 id="Co-zlepsit-na-Skrz-cz">Co zlepšit na Skrz.cz</h2>
<p>Konkrétně na <a href="https://www.startupjobs.cz/nabidka/5101/senior-php-developer-ka-chces-proniknout-do-automatizace-v-projektu-postavenem-na-symfony">tomto inzerátu</a></p>
<h3 id="Libi-se-mi">Líbí se mi</h3>
<ul>
<li>
<p>Líbí se mi tučně zvýrazněné důležité texty, nadpisy působí přehledně a odkazy lákají ke klinutí.</p>
</li>
<li>
<p>Pěkně a konkrétně rozepsané, co můžu získat:</p>
<ul>
<li>„společné páteční snídaně“ &dash; mňam - k tomu fotku a už mě máte</li>
<li>„ovoce, zelenina, káva a čaj volně dostupné :)“</li>
<li>„jistotu, domácí prostředí, otevřený přístup, <strong>otevřenou komunikaci</strong>, <strong>prostor k seberealizaci</strong> i <strong>vzdělání</strong>, na kterém si hodně zakládáme“ - tučné body zní fakt dobře, klidně bych je rozepsal. Taky bych nezapomněl na vlastního hapiness managera.</li>
</ul>
</li>
</ul>
<h3 id="Zmenil-bych">Změnil bych</h3>
<ul>
<li>
<p>Spojení „tvrdě makat“ má dost negativní, těžký náboj a může zabarvit zbytek inzerátu. Sám si pod tím představuju přesčasy a nabourávání osobního života. Dokážu tvrdě makat, když v tom vidím smysl. <strong>Pokud tam nějaký smysl je, přidal bych ho hned za tyhle slova.</strong> Jde-li třeba o <em>důraz na kvalitu</em>: „Píšeš radši kvalitní kód s testy než bastl s technickým dluhem?“</p>
</li>
<li>
<p>První 2/3 jsou o firmě, až pak je „Co za to“. Vyměnil bych pořadí a info o firmě zkrátil na  polovic. „Co za to“ zní obchodně a rázně. Použil bych spíš „Co pro tebe máme“.</p>
</li>
<li>
<p>Ubral bych počet odkazů na polovic. Je jich tam docela dost a jako programátor nevím, jestli si je mám načít, jsou důležité pro práci nebo je to jen reference na nějaký produkt.</p>
</li>
</ul>
<h2 id="Borci-na-konci">Borci na konci</h2>
<p>Na závěr na odlehčení 2 inzeráty, které se mi líbí.</p>
<h3 id="PeckaDesign-jde-do-naha-a-jeste-te-nauci">PeckaDesign jde do naha a ještě tě naučí</h3>
<p>Tento inzerát najdeš ho na <a href="http://www.delejcoumis.cz">www.delejcoumis.cz</a>.</p>
<p>Co je killer? <a href="https://github.com/peckadesign/DelejCoUmis.cz">Jeho zdrojáky jsou open-source</a>. To mi umožní si snadno zjistit, jaká je úroveň kódu - jestli mu rozumím nebo jestli se tam mám co naučit. A v <a href="https://github.com/peckadesign/DelejCoUmis.cz/blob/master/composer.json"><code>composer.json</code></a> najdu používané technologie.</p>
<p>A <strong>tohle je 100% výhoda proti všem ostatním inzerátům</strong>:</p>
<img src="/assets/images/posts/2017/job-offers/naucime-te.png" class="img-thumbnail">
<h3 id="Lidska-Sila-hleda-posilu">Lidská Síla hledá posilu</h3>
<p>Zrovna včera mi padl do inzerát z LidskáSíla.cz:</p>
<p>Barevné a s logy - nemusím luštit text, <strong>jen proskenuju loga</strong>. Je to stručné a čtivé - mám z toho pocit, že se s nimi <strong>půjde domluvit na čemkoliv a že mě ocení</strong>.</p>
<p>Netušil jsem, že Startupjobs.cz umožňují stylování barev. Divím se, že tohle je 1. inzerát, který toho využívá.</p>
<blockquote>
<p>„Jeden obrázek řekne více než tisíc slov.“</p>
</blockquote>
<img src="/assets/images/posts/2017/job-offers/php7.png" class="img-thumbnail" alt="PHP 7.1 when stable">
<p>Co jste z něj poznali? Já odhaduju, že:</p>
<ul>
<li>projekt jde s dobou &ndash; PHP 7.1 vyšlo v prosinci 2016</li>
<li>je tam někdo, kdo ví, že první stable verze není tolik stable, protože není otestovaná v praxi</li>
</ul>
<h2 id="A-co-se-libi-tobe-Co-zaujalo-tebe-ze-jsi-ve-sve-soucasne-praci">A co se líbí tobě? Co zaujalo tebe, že jsi ve své současné práci?</h2>
<p>Jaký inzerát tě zaujal a čím? Hoď mi link do komentářů, rád se mrknu. Díky.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/01/10/jak-psat-zajimave-inzeraty-pro-ajtaky</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Tue, 10 Jan 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/01/10/jak-psat-zajimave-inzeraty-pro-ajtaky#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Why I deleted my LinkedIn account ]]></title>
                <link>https://tomasvotruba.com/blog/2017/01/05/why-I-deleted-my-linkedin-account</link>
                <description><![CDATA[ <p>I used LinkedIn since 2008 when it was sending spam to all my friends. After 8 years of tuning my profile to 95 % score, reading mostly copy-pasted messages,
checking false notifications, flirting with HR girls and hoping for up votes for my recent skills, <strong>I've decided it is time to let it go</strong>. Why and what I'm gonna do now?</p> ]]></description>
                <content:encoded><![CDATA[ <p><em>Disclaimer: even if I get few abroad offers, my experience is related to work environment in the Czech Republic.</em></p>
<p>I was reviewing my 2016 and how <strong>I started to disconnect from social networks</strong> (<a href="http://www.stevepavlina.com/blog/2015/07/one-year-without-social-media">thanks Steve</a>): I reduced 350 friends on Facebook to 20, unfollowed all but 2 groups and I dropped all people I follow on Twitter.
<strong>My attention got better and I could focus</strong> on things that really matter to me &ndas; reading books, writing and real friends. That's when I started to focus on quality of my environment.</p>
<p>And the LinkedIn account was scratching my mind for a long time.</p>
<p>So I asked myself?</p>
<h2 id="What-is-LinkedIn-Good-for">What is LinkedIn Good for?</h2>
<ul>
<li>It helped me in <strong>first 3 years in paid</strong> PHP programming field.</li>
<li>I got some references and up-votes for my skills, I attended university so I thought <strong>it gives me credibility</strong>.</li>
<li>It gave me <strong>self-confidence when talking about money</strong>.</li>
<li><strong>Everybody did it</strong>, so did I (like that time I jumped out of the window ;)).</li>
</ul>
<h2 id="Where-LinkedIn-Fails">Where LinkedIn Fails</h2>
<h3 id="It-s-kinda-Broken-and-Stuck-Service">It's kinda Broken and Stuck Service</h3>
<p>I was getting fake notifications of new connections. I got over 20 pings for 6 moths old and answered message.
Also, I didn't notice many changes between 2008 and 2016. It could be so much more. Btw, do you remember MySpace?</p>
<h3 id="Irrelevant-Messages-95-Job-Offers-are-Spam">Irrelevant Messages - 95 % Job Offers are Spam</h3>
<p>Only <strong>2 jobs offers end up in real contract</strong> during the whole 8 years. Most of offers are general random messages from bots or people,
who don't even read descriptions like <em>part-time only</em> or <em>Symfony project only</em>.</p>
<h3 id="Target-group-Bias">Target group Bias</h3>
<p><strong>I never look for PHP full-time job</strong>. I wanted part-times only. Not really favorite position on LinkedIn, is it?
Last 2 years I only offered consultancy and lecturing. Well, is that a full-time position?</p>
<h3 id="More-info-sources-more-outdated-info">More info sources = more outdated info</h3>
<p>I put my work information on places like my website, Facebook and LinkedIn. In the begging it's all up-to-date. But in time...</p>
<ul>
<li>on website there is last reference from 2014</li>
<li>on LinkedIn I'm still in university</li>
<li>and on Facebook I just left job I started in 2015</li>
</ul>
<p><strong>The more such places I have, the more outdated they will become</strong>. And I'm not alone.
I often see friends who have 3 years empty space on LinkedIn and website, yet still looking for new job.</p>
<h3 id="Skill-Lagging">Skill Lagging</h3>
<p>What can you tell about me from this picture?</p>
<img src="/assets/images/posts/2017/linked-in/skills.png" class="img-thumbnail" alt="Skill list">
<p>The oldest skills are upvoted the most. Also short and traditional, like Git. Even if I excel in coaching and open-source,
it looks like I'm 3× better in Git. No, I'm not. <strong>So when I got new skill, it took LinkedIn 3 years to reflect that</strong>. In that time, I'm already somewhere else.</p>
<h2 id="Dying-in-Comfort-Zone">Dying in Comfort Zone</h2>
<p><strong>This is the most important takeaway.</strong></p>
<p><strong>LinkedIn was my comfort zone. It's like being a woman on Tinder</strong>. When I want sex, I have it. And I get many messages and attention from females with not much work.
This backfires.</p>
<p>Having so much attention and job position anytime I want makes me lazy. I don't need to improve. With this state of mind I would not probably reach the dream job as if I would be <strong>proactive</strong>.</p>
<img src="/assets/images/posts/2017/linked-in/allstar.jpg" alt="The Fake Allstar">
<p>Moreover, I've got quite a long profile:</p>
<ul>
<li>5 great jobs</li>
<li>3 startups</li>
<li>3 talks</li>
<li>2 abroad conferences</li>
<li>25 skills</li>
<li>7 recommendations</li>
</ul>
<p>As friend of mine Albert once said:</p>
<blockquote>
<p>&quot;Once you stop learning you start dying.&quot;</p>
</blockquote>
<p>I want to improve inside <a href="https://zenhabits.net/limits">limits</a> I set. <strong>Now I naturally tend to build something real.</strong></p>
<h2 id="Is-it-Your-Time-to-Let-Go">Is it Your Time to Let Go?</h2>
<p>If you:</p>
<ul>
<li>are on the start of your career,</li>
<li>don't have own website,</li>
<li>don't have 3+ references,</li>
<li>look for full-time job</li>
<li>and don't want to work for yourself but rather for company,</li>
</ul>
<p>I would recommend keeping that profile.</p>
<p>But when you answered <em>NO</em> to all of these, here what you could do:</p>
<h2 id="Be-Proactive-and-ndash-Find-Yourself-better-Job">Be Proactive &ndash; Find Yourself better Job</h2>
<ul>
<li><strong>Build personal brand on good old relationships</strong>.</li>
<li>Talk with people.</li>
<li><strong>Find active social networks where you interact with peers</strong> - for me it is Facebook or our Czech &amp; Slovak PHP Community <a href="http://pehapkari.slack.com">Péhápkaři Slack</a>.</li>
<li>Go to meetup.</li>
</ul>
<p>But this is my story, my personal needs and my personal experience. It probably won't work for everybody. Your experience might be different.</p>
<p>So, what about you?</p>
<h3 id="How-do-you-work-with-LinkedIn-Is-it-worth-your-time">How do you work with LinkedIn? Is it worth your time?</h3> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2017/01/05/why-I-deleted-my-linkedin-account</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 05 Jan 2017 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2017/01/05/why-I-deleted-my-linkedin-account#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to avoid @inject thanks to Decorator feature in Nette ]]></title>
                <link>https://tomasvotruba.com/blog/2016/12/24/how-to-avoid-inject-thanks-to-decorator-feature-in-nette</link>
                <description><![CDATA[ <p>I often find <code>@inject</code> being overused in projects I review while mentoring. They often bring less writing, but in exchange they break <a href="https://en.wikipedia.org/wiki/SOLID_(object-oriented_design)">SOLID principles</a>.
<br><br>
Today I will show you solution that will <strong>keep your code both small and clean</strong> - <strong>Decorator feature in Nette</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <p>As <a href="https://www.ted.com/talks/simon_sinek_how_great_leaders_inspire_action">Derek Simons says</a> says...</p>
<h2 id="Start-with-and-quot-Why-and-quot">...Start with &quot;Why&quot;</h2>
<p>Why am I writing this article? I try to improve knowledge interoperability between frameworks so it <strong>is easier to understand and use each other</strong>. The goal is to discourage Nette- (or any framework-) specific things <strong>in favor of those that may be common</strong>.</p>
<p>Today, I will try to agree on setter injection with you.</p>
<h2 id="at-Inject-Overuse-is-Spreading"><code>@Inject</code> Overuse is Spreading</h2>
<p>This code is common to 80 % Nette applications I came across in last year:</p>
<pre><code class="language-php">// app/Presenter/ProductPresenter.php

namespace App\Presenter;

final class ProductPresenter extends AbstractBasePresenter
{
    /**
     * @inject
     * @var ProductRepository
     */
    public $productRepository;
}</code></pre>
<p>Using <code>@inject</code> annotations over constructor injection is <strong>fast, short and it just works</strong>.</p>
<p>Ok, why not use it everywhere:</p>
<pre><code class="language-php">// app/Repository/ProductRepository.php

namespace App\Repository;

class ProductRepository
{
    /**
     * @inject
     * @var Doctrine
     */
    public $entityManager;
}</code></pre>
<p>and</p>
<pre><code class="language-yaml"># app/config/config.neon

services:
    -
        class: App\Repository\ProductRepository
        inject: on</code></pre>
<h2 id="Your-Code-is-Seen-as-Manual-How-to-Write">Your Code is Seen as Manual How to Write</h2>
<p>Why? Because &quot;what you see is what you write&quot;. New programmer joins the teams, sees this handy <code>@inject</code> feature and uses when possible and handy.</p>
<p>Some of you, who already talked about <code>@inject</code> method usage already there are some and only few specific places to use it.</p>
<h2 id="Where-to-only-at-inject">Where to only <code>@inject</code>?</h2>
<p><strong>To prevent constructor hell</strong>. If you meet this term first time, go read <a href="https://phpfashion.com/di-a-predavani-zavislosti#toc-constructor-hell">this short explanation</a> by David Grudl.</p>
<p>The best use case is <code>AbstractBasePresenter</code>.
Let's say I need <code>Translator</code> service in all of my presenters.</p>
<pre><code class="language-php">// app/Presenter/AbstractBasePresenter.php

namespace App\Presenter;

abstract class AbstractBasePresenter extends Nette\Application\UI\Presenter
{
    /**
     * @inject
     * @var Translator
     */
    public $translator;
}</code></pre>
<p>And I can use it in <code>ProductPresenter</code> along with constructor injection</p>
<pre><code class="language-php">// app/Presenter/ProductPresenter.php

namespace App\Presenter;

final class ProductPresenter extends AbstractBasePresenter
{
    /**
     * @var ProductRepository
     */
    private $productRepository;

    public function __construct(ProductRepository $productRepository)
    {
        $this-&gt;productRepository = $productRepository;
    }
}</code></pre>
<p>This is quite clean and easy to use, because presenters have injects <a href="https://github.com/nette/application/blob/3165d3a8dab876f4364cdcba450a33ab0182049a/src/Bridges/ApplicationDI/ApplicationExtension.php#L111-L116">enabled by default</a>.</p>
<h2 id="Level-up">Level up</h2>
<p>But what if we have other objects that:</p>
<ul>
<li><strong>inherit from abstract parent</strong></li>
<li>needs <strong>1 service available everywhere</strong></li>
</ul>
<p>2 common case pop to my mind:</p>
<ul>
<li><code>AbstractBaseRepository</code> for all our repositories</li>
<li><code>AbstractBaseControl</code> for all our components</li>
</ul>
<p>Let's take the first one:</p>
<pre><code class="language-php">// app/Repository/AbstractBaseRepository.php

namespace App\Repository;

use Doctrine\ORM\EntityManagerInterface;

abstract class AbstractBaseRepository
{
    /**
     * @var EntityManagerInterface
     */
    protected $entityManager;

    public function setEntityManager(EntityManagerInterface $entityManager)
    {
        $this-&gt;entityManager = $entityManager;
    }
}</code></pre>
<p>And specific repository with some dependency:</p>
<pre><code class="language-php">// app/Repository/ProductRepository.php

namespace App\Repository;

use App\Model\Product\ProductSorter;

final ProductRepository extends AbstractBaseRepository
{
    /**
     * @var ProductSorter
     */
    private $productSorter;

    public function __construct(ProductSorter $productSorter)
    {
        $this-&gt;productSorter = $productSorter;
    }
}</code></pre>
<p>So our config would look like:</p>
<pre><code class="language-yaml"># app/config/config.neon

services:
    -
        class: App\Repository\ProductRepository
        setup:
            - setEntityManager
    # and for other repositories
    -
        class: App\Repository\UserRepository
        setup:
            - setEntityManager
    -
        class: App\Repository\CategoryRepository
        setup:
            - setEntityManager</code></pre>
<h3 id="SO-much-writing">SO much writing!</h3>
<p>It is cleaner, but with so much writing? Thanks, but no, thanks. Let's go back to <code>@inject</code>...</p>
<p>Wait! Before any premature conclusion, let's set the goal first.</p>
<h3 id="What-is-Desired-Result">What is Desired Result?</h3>
<pre><code class="language-yaml"># app/config.config.neon

services:
    - App\Repository\ProductRepository
    - App\Repository\UserRepository
    - App\Repository\CategoryRepository</code></pre>
<p>That would be great, right? Is that possible in Nette while keeping the code clean?</p>
<h2 id="Decorator-Extension-to-the-Rescue">Decorator Extension to the Rescue</h2>
<p>This feature is in Nette <a href="https://github.com/nette/di/commit/28fdac304b967ae43a90936069d94316ee2daca4">since 2014</a> (&lt;= the best documentation for it so far).</p>
<p>How does it work?</p>
<pre><code class="language-yaml"># app/config/config.neon

decorator: # keyword used by Nette
    App\Repository\AbstractBaseRepository: # 1. find every service this type
        setup: # same setup as we use in service configuration
            - setEntityManager # 2. call this setter injection on it

    # or do you need to call "setTranslator" on every component?
    App\Component\AbstractBaseControl:
        setup:
            - setTranslator</code></pre>
<p>That's it!</p>
<h2 id="What-Have-You-Learned-Today">What Have You Learned Today?</h2>
<ul>
<li>It is easy to overuse <code>@inject</code> in places where it doesn't solve any problem</li>
<li>The problem <code>@inject</code>/<code>inject&lt;method&gt;</code> method were born to solve is called <em>dependency hell</em></li>
<li>If you need to <strong>decorate service of some type</strong>, use <em>Decorator Extension</em></li>
<li>This will lead <strong>to better framework understandability and usability</strong></li>
<li>...and world peace in time :)</li>
</ul>
<p>In next article, we will look at other practical use cases for Decorator Extension.</p>
<p><br></p>
<p>How do you use <code>@inject</code>, constructor injection or Decorator Extension? Let me know in the comments, I'm curious.</p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2016/12/24/how-to-avoid-inject-thanks-to-decorator-feature-in-nette</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Sat, 24 Dec 2016 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2016/12/24/how-to-avoid-inject-thanks-to-decorator-feature-in-nette#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Decouple Controller from Symfony using Traits ]]></title>
                <link>https://tomasvotruba.com/blog/2016/12/12/decouple-controller-from-symfony-using-smart-traits</link>
                <description><![CDATA[ <p>If you start using controllers as services, you still <strong>often need helpers methods of Controller from FrameworkBundle</strong>. So your code still depends on service locator and decoupling is not really happening.<br><br>Today I will show you <strong>how to remove the dependency on Controller and keep those fancy methods at the same time</strong>.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Typical-use-case-of-Mixing-Principles">Typical use case of Mixing Principles</h2>
<ol>
<li>Constructor Injection</li>
<li>Service locator (container) from parent Controller class</li>
</ol>
<p>Today it's not about which one is better and when to use it, but about consistency. I recommend either using first or second. Mixing them together is confusing and adds complexity without bringing value or improving readability.</p>
<p>Let's see an example:</p>
<pre><code class="language-php">namespace Symfony\Bundle\FrameworkBundle\Controller;

final class ProductController extends Controller
{
    /**
     * @var ProductRepository
     */
    private $productRepository;

    // constructor injection
    public function __construct(ProductRepository $productRepository)
    {
        $this-&gt;productRepository = $productRepository;
    }

    public function actionList()
    {
        // using parent method that uses service locator (container)
        return $this-&gt;render('mytemplate.html.twig', [
             'products' =&gt; $this-&gt;productRepository-&gt;fetchAll()
        ]);
    }
}</code></pre>
<p>Seeing this code anyone could easily extends it like this, and I would not blame him.</p>
<pre><code class="language-php">public function actionList()
{
    return $this-&gt;render('mytemplate.html.twig', [
         'products' =&gt; $this-&gt;productRepository-&gt;fetchAll(),
         // using parent method that uses service locator (container)
         'title' =&gt; $this-&gt;get('title_manager')-&gt;fetchForProducts()
    ]);
}</code></pre>
<h2 id="Real-Issue-See-3-PRs-to-Symfony-Core">Real Issue? See 3 PRs to Symfony Core</h2>
<p>There are some trials to make this bit more decoupled:</p>
<ul>
<li><a href="https://github.com/symfony/symfony/pull/17608">[DependencyInjection] Autowiring: add setter injection support</a>, but is was <a href="https://github.com/symfony/symfony/pull/20384">reverted</a></li>
<li><a href="https://github.com/symfony/symfony/pull/16863">[FrameworkBundle] Split abstract Controller class into traits</a> - opened in December 2015 and without attention</li>
<li><a href="https://github.com/symfony/symfony/pull/18193">[FrameworkBundle] Introduce autowirable ControllerTrait</a> - similar to previous one, but depending on reverted setter injection</li>
</ul>
<p>There are some trials, but I guess <strong>this feature is not coming anytime soon</strong>.</p>
<h3 id="How-to-make-a-Change">How to make a Change</h3>
<p>When it's <strong>difficult to estimate if this would be useful feature to merge</strong>, somebody creates a bundle and test it in practise.</p>
<p>Similar thing happened for <a href="https://github.com/knpuniversity/KnpUGuardBundle">knpuniversity/KnpUGuardBundle</a> that later became core part of Symfony.</p>
<p>So...</p>
<h3 id="Is-There-a-Bundle-for-This">Is There a Bundle for This?</h3>
<p>Few months ago <a href="https://twitter.com/PetrOlisar">Petr Olišar</a> reported <a href="https://github.com/symplify/symplify/issues/14">similar issue</a> to <a href="https://github.com/Symplify/ControllerAutowire">ControllerAutowire</a> package.</p>
<p>I realized it perfectly fits there and <strong>I added it</strong>.</p>
<p>Thank you Petr!</p>
<h2 id="How-Does-it-Work">How Does it Work?</h2>
<p>Now you can do use bare Controller with only what you need:</p>
<pre><code class="language-php">use Symplify\ControllerAutowire\Controller\Templating\ControllerRenderTrait;

final class ProductController
{
    use ControllerRenderTrait;

    /**
     * @var ProductRepository
     */
    private $productRepository;

    public function __construct(ProductRepository $productRepository)
    {
        $this-&gt;productRepository = $productRepository;
    }

    public function actionList()
    {
        return $this-&gt;render('mytemplate.html.twig', [
             'products' =&gt; $this-&gt;productRepository-&gt;fetchAll()
        ]);
    }
}</code></pre>
<p><strong>You can use few small traits</strong> or <strong>just 1</strong> - <code>ControllerTrait</code>. Pick what fits your needs the best.</p>
<p>You will <a href="https://github.com/Symplify/ControllerAutowire/tree/master/src/Controller">find them in repository</a> or just type <code>ControllerTrait</code> in your IDE:</p>
<h2 id="Try-This-Out-and-Let-Us-Know">Try This Out and Let Us Know</h2>
<p>There were many suggestions around those PR, but no package to really try it out in  practice.</p>
<p>So feel free to install this package and try this out. Feedback is much appreciated.</p>
<p><strong>It will be helpful in PRs to Symfony core and helps to make conscious decision about this topic</strong>.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2016/12/12/decouple-controller-from-symfony-using-smart-traits</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 12 Dec 2016 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2016/12/12/decouple-controller-from-symfony-using-smart-traits#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to Use Symfony Bundles in Nette Without Rewriting DI Logic ]]></title>
                <link>https://tomasvotruba.com/blog/2016/10/05/how-to-use-symfony-bundles-in-nette-without-rewriting-di-logic</link>
                <description><![CDATA[ <p>Every framework has its own unique Dependency Injection Container (DIC), where you register your services. <strong>Imagine a set of special glues that are required to add the same paper on different surfaces.</strong> Today I will show you how to use universal glue for Nette surface.</p> ]]></description>
                <content:encoded><![CDATA[ <p>To be specific:</p>
<ul>
<li>In Nette you use <a href="https://github.com/nette/di">Nette\DI package</a> and make an <strong>extension</strong>.</li>
<li>In Symfony, you have to use <a href="https://symfony.com/doc/current/components/dependency_injection.html">Symfony\DependencyInjection package</a> and create a <strong>bundle</strong>.</li>
</ul>
<p>So when you hear somebody saying:</p>
<blockquote>
<p>&quot;I saw that in Symfony bundle and want to use in Nette&quot;</p>
</blockquote>
<p>you know it won't be easy.</p>
<h2 id="DRY-Do-Repeat-Yourself-in-Package-Ratio">DRY (Do-Repeat-Yourself) in Package Ratio</h2>
<p>That's why you see &quot;double&quot; integrations for 3rd party packages like:</p>
<p><strong><a href="https://github.com/doctrine/migrations">Doctrine\Migrations</a></strong></p>
<ul>
<li>for Symfony: <a href="https://github.com/doctrine/DoctrineMigrationsBundle">Doctrine/DoctrineMigrationsBundle</a></li>
<li>for Nette: <a href="https://github.com/Zenify/DoctrineMigrations">Zenify/DoctrineMigrations</a></li>
</ul>
<p><strong><a href="http://docs.simplebus.io">MessageBus - CQRS</a></strong></p>
<ul>
<li>for Symfony: <a href="https://github.com/SimpleBus/SymfonyBridge">SimpleBus/SymfonyBridge</a></li>
<li>for Nette: <a href="https://github.com/newPOPE/Nette-CQRS-Commands">newPOPE/Nette-CQRS-Commands</a></li>
</ul>
<p><strong><a href="https://github.com/ruflin/Elastica">Elastica</a></strong></p>
<ul>
<li>for Symfony: <a href="https://github.com/FriendsOfSymfony/FOSElasticaBundle">FriendsOfSymfony/FOSElasticaBundle</a></li>
<li>for Nette: <a href="https://github.com/Kdyby/ElasticSearch">Kdyby/ElasticSearch</a></li>
</ul>
<p>And so on. Let's ignore the syntax sugar that every programmer adds to his own integrations.</p>
<h3 id="This-leads-to">This leads to</h3>
<ul>
<li><strong>lot of duplicated code</strong> (register event subscribers, commands and all the services from 3rd party package)</li>
<li><strong>lot of duplicated maintenance</strong> (fix compatibility with new version of 3rd party package)</li>
<li>greater possibility of <strong>burnout syndrome</strong></li>
</ul>
<h2 id="Is-this-really-needed">Is this really needed?</h2>
<p>Well, if you look closer to Nette and Symfony DICs, you see <strong>they are quite similar</strong>. So answer is <strong>NO</strong>.</p>
<p>Both Nette and Symfony have 3 basic operations dealing with DIC:</p>
<h3 id="1-Register-a-service">1. Register a service</h3>
<p>Common for all packages.</p>
<ul>
<li>Nette: <code>loadConfiguration()</code> method</li>
<li>Symfony: <code>Extension</code> class</li>
</ul>
<h3 id="2-Decorate-already-registered-services">2. Decorate already registered services</h3>
<p>Add setter, pass arguments, add reference to other service, collect services of certain type.
Used less often, yet still very useful.</p>
<ul>
<li>Nette: <code>beforeCompile()</code> method</li>
<li>Symfony: <code>CompilerPassInterface</code> classes</li>
</ul>
<h3 id="3-Add-some-magic-or-static-code-in-the-end">3. Add some magic or static code in the end</h3>
<p>Usually workarounds, hacks, tweaks or performance tuning. Quite rare.</p>
<ul>
<li>Nette: <code>afterCompile()</code> method</li>
<li>Symfony: specific <code>CompilerPassInterface</code> classes</li>
</ul>
<h2 id="Enough-Theory-Give-me-the-Solution">Enough Theory, Give me the Solution!</h2>
<p>Okay, okay... These are last few lines before the code, I promise.</p>
<p>Thanks to step 1. and 2. I could create an extension, that will <strong>take any Symfony bundle and register its services into the Nette application</strong>: <a href="https://github.com/TomasVotruba/NetteAdapterForSymfonyBundles">TomasVotruba/NetteAdapterForSymfonyBundles</a></p>
<h2 id="How-to-register-a-Symfony-Bundle-into-your-Nette-Application-in-3-steps">How to register a Symfony Bundle into your Nette Application in 3 steps</h2>
<h3 id="1-Install-package">1. Install package</h3>
<pre><code class="language-yaml">composer require symplify/nette-adapter-for-symfony-bundles</code></pre>
<h3 id="2-Register-extension">2. Register extension</h3>
<pre><code class="language-yaml"># app/config/config.neon
extensions:
    symfonyBundles: Symplify\NetteAdapterForSymfonyBundles\DI\NetteAdapterForSymfonyBundlesExtension</code></pre>
<h3 id="3-Register-desired-Symfony-Bundle">3. Register desired Symfony Bundle</h3>
<pre><code class="language-yaml"># app/config/config.neon
symfonyBundles:
    bundles:
        - League\Tactician\Bundle\TacticianBundle</code></pre>
<p>And that's it!</p>
<p>For further use, <strong>just check Readme for <a href="https://github.com/Symplify/NetteAdapterForSymfonyBundles">Symplify/NetteAdapterForSymfonyBundles</a></strong>.</p>
<hr />
<p>So next time you see a Symfony bundle you would like to use in Nette, stop thinking about writing brand new duplicated extension and try this bundle first. You might save yourself great amount of time :)</p>
<h2 id="Made-for-you">Made for you</h2>
<p>Missing some feature or found a bug? Let me know. I want to make this package suit your needs and work as best as possible.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2016/10/05/how-to-use-symfony-bundles-in-nette-without-rewriting-di-logic</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Wed, 05 Oct 2016 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2016/10/05/how-to-use-symfony-bundles-in-nette-without-rewriting-di-logic#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to get more than Request in Controller Action ]]></title>
                <link>https://tomasvotruba.com/blog/2016/09/19/how-to-get-more-than-request-in-controller-action</link>
                <description><![CDATA[ <p>You already know you can get <code>Request</code> object in your controller action. Cool, but there is more.</p>
<p>In <em>Symfony 3.1</em> is new <a href="https://symfony.com/doc/current/controller/argument_value_resolver.html">Action Argument Resolving feature</a>, so you can <strong>get any service you need</strong>. With a bit of work. Today I will show you how.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Disclaimer-What-happened-to-controller-constructor-injection">Disclaimer: What happened to controller constructor injection?</h2>
<p><strong>I still prefer constructor injection in controllers</strong>. Are you asking why and how to achieve that in Symfony?</p>
<p>In 3 minutes <a href="/blog/2016/03/10/autowired-controllers-as-services-for-lazy-people/">you will find out in my other article</a>.
I will wait here...</p>
<p><br>
<br>
<br></p>
<p>...ok. Now you are probably in one of these 2 groups:</p>
<h3 id="1-You-want-to-use-constructor-injection-in-controllers-because-you-like-advantages-of-service-design">1. You want to use constructor injection in controllers, because you like advantages of service design</h3>
<p>Stop reading, because this article describes only method injection, which is not so clean. It would add unnecessary complexity to your
already solid system with no added value.
So go <a href="https://github.com/Symplify/ControllerAutowire">install Symplify/ControllerAutowire bundle</a> and enjoy your day!</p>
<h3 id="2-You-consider-constructor-injection-in-controller-too-much-writing-with-not-much-added-value">2. You consider constructor injection in controller too much writing with not much added value</h3>
<p><strong>This is article for you. Keep reading!</strong></p>
<p>To be honest, first I was completely ignoring this second group, but <a href="https://twitter.com/enumag">Jáchym</a> explained me why it's important.</p>
<h2 id="How-named-services-bring-less-writing">How named services bring less writing</h2>
<p>Typical controller in Symfony looks like this:</p>
<pre><code class="language-php">// src/AppBundle/Controller/MeetupController.php
namespace AppBundle\Controller;

use Symfony\Bundle\FrameworkBundle\Controller\Controller;

class MeetupController extends Controller
{
    public function listAction()
    {
        $meetupRepository = $this-&gt;get('meetup_repository');

        return $this-&gt;render('meetup/list.twig', [
            'meetups' =&gt; $meetupRepository-&gt;findAll()
        ]);
    }
}</code></pre>
<p>These 2 lines are the most important:</p>
<pre><code class="language-php">$meetupRepository = $this-&gt;get('meetup_repository');
['meetups' =&gt; $meetupRepository-&gt;findAll()]</code></pre>
<h2 id="Hidden-vendor-lock">Hidden vendor lock</h2>
<p><strong>How do we know, that <code>meetup_repository</code> service has <code>findAll()</code> method?</strong></p>
<p>You need <strong>3 things</strong> to work at once:</p>
<ul>
<li>PHPStorm</li>
<li>Symfony plugin</li>
<li>correct setup for particular project structure
<ul>
<li>Symfony 2 and Symfony 3 have <a href="https://knpuniversity.com/screencast/symfony3-upgrade/new-dir-structure">different directory structure</a>, so plugin has to be setup manually to suit it</li>
</ul></li>
</ul>
<h2 id="Is-this-really-necessary">Is this really necessary?</h2>
<p>Nope. <strong>Any IDE can autocomplete on object or interface typehint. And without plugins.</strong></p>
<p>But how to get that there? We can use constructor injection with typehints, <strong>but it would be too much writing</strong>.</p>
<p>Compare yourself this:</p>
<pre><code class="language-php">/**
 * @var MeetupRepository
 */
private $meetupRepository;

public function __construct(MeetupRepository $meetupRepository)
{
    $this-&gt;meetupRepository = $meetupRepository;
}

public function listAction()
{
    // $this-&gt;meetupRepository;
}</code></pre>
<p>to this:</p>
<pre><code class="language-php">public function listAction()
{
    // $this-&gt;get('meetup_repository');
}</code></pre>
<p>I've counted that for you:</p>
<p><strong>It's 11 lines to 1 just to just get a service!</strong></p>
<p>I must admit, this is killer argument <strong>why not to use constructor injection in controllers</strong>.</p>
<h3 id="Meet-me-half-way">Meet me half way?</h3>
<p>What if you could inject the service via method?</p>
<pre><code class="language-php">public function listAction(MeetupRepository $meetupRepository)
{
    $meetups = $meetupRepository-&gt;findAll();
    // ...
}</code></pre>
<h3 id="Result">Result?</h3>
<ul>
<li>Now we are down to <strong>0 extra lines</strong> to get a dependency</li>
<li>We can use <strong>any IDE</strong></li>
<li>We are <strong>independent on project structure</strong></li>
</ul>
<p>This all brings greater secondary advantages:</p>
<ul>
<li>Less stuff to remember, <strong>less complexity</strong>.</li>
<li><strong>Faster on-boarding</strong> of new programmers.</li>
<li><strong>More joy</strong> to your daily work.</li>
</ul>
<p>To make this happened, I made <a href="https://github.com/Symplify/ActionAutowire">Symplify\ActionAutowire bundle</a>.</p>
<h2 id="How-to-enable-controllers-action-autowiring-in-3-steps">How to enable controllers action autowiring in 3 steps</h2>
<h3 id="1-Install-package">1. Install package</h3>
<pre><code class="language-yaml">composer require symplify/action-autowire</code></pre>
<h3 id="2-Register-bundle">2. Register bundle</h3>
<pre><code class="language-php">// app/AppKernel.php
class AppKernel extends Kernel
{
    public function registerBundles()
    {
        $bundles = [
            new Symplify\ActionAutowire\SymplifyActionAutowireBundle(),
            // ...
        ];
    }
}</code></pre>
<h3 id="3-Add-some-dependency-for-your-controller-via-constructor">3. Add some dependency for your controller via constructor</h3>
<pre><code class="language-php">// src/AppBundle/Controller/MeetupController.php
namespace AppBundle\Controller;

class MeetupController extends Controller
{
    public function listAction(MeetupRepository $meetupRepository)
    {
        return $this-&gt;render('meetup/list.twig', [
            'meetups' =&gt; $meetupRepository-&gt;findAll()
        ]);
    }
}</code></pre>
<p>And that's it!</p>
<p>For further use, <strong>just check Readme for <a href="https://github.com/Symplify/ActionAutowire">Symplify/ActionAutowire</a>.</strong></p>
<h2 id="Made-for-you">Made for you</h2>
<p>Missing some feature or found a bug? Let me know. I want to make this package suit your needs and work as best as possible.</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2016/09/19/how-to-get-more-than-request-in-controller-action</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 19 Sep 2016 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2016/09/19/how-to-get-more-than-request-in-controller-action#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to write open-source in PHP 2: Rise value of your package with help of skeleton ]]></title>
                <link>https://tomasvotruba.com/blog/2016/09/16/how-to-write-open-source-in-php-2-enjoy-skeletons</link>
                <description><![CDATA[ <p>After creating a repo, we have to fill it with something useful. Our code! Of course, but we also need some <strong>metadata files</strong>.
What are they for? Is there some prepared code we can use? What are badges for? <strong>I will answer all these questions today.</strong></p> ]]></description>
                <content:encoded><![CDATA[ <p>Other programmers who want to use your package are usually looking for <strong>long term value</strong>.
To estimate the value they need <strong>to answer 4 important questions</strong>.</p>
<ol>
<li><strong>What is quality of package?</strong></li>
<li><strong>Does it solve my issue?</strong></li>
<li><strong>Is it trustworthy?</strong></li>
<li><strong>How well maintained is it?</strong></li>
</ol>
<p>Even if you know your code is the best and the cleanest, if they don't trust you, they will never use it.</p>
<p>I will let you think about them a little bit. We will relate with specific files to them in second part of this article.</p>
<h2 id="Use-solid-skeleton-start-solid-brand">Use solid skeleton → start solid brand</h2>
<p>Now, the first step that can positively influence all the 4 answers is <strong>using a skeleton</strong> with prepared metadata files. Guys from <a href="https://thephpleague.com">The PHP League</a> already did the job for you and created a <a href="https://github.com/thephpleague/skeleton">skeleton</a> package.</p>
<h2 id="How-to-get-Skeleton-code-to-your-local-Repository-in-4-steps">How to get Skeleton code to your local Repository in 4 steps</h2>
<ol>
<li>Go to repository on Github and click on <em>Clone or download</em></li>
<li>Then <em>Download a ZIP</em></li>
<li>Unzip the zip file to your local repository</li>
<li>
<p>And push new files to Github</p>
<pre><code class="language-bash">git add .
git commit -m "add metadata files"
git push origin master</code></pre>
</li>
</ol>
<h3 id="Great-for-start-yet-obsolete-later">Great for start, yet obsolete later</h3>
<p>This skeleton is great for start and to learn about metadata files.</p>
<p>But when I create my package now, <strong>I just copy the most recent package I made</strong>, delete <code>/src</code> and <code>/tests</code>
directories and I'm ready to roll. This is because:</p>
<ul>
<li>I upgrade my packages more often then some <code>skeleton</code> package</li>
<li>and because my preferences and required code are evolving
<ul>
<li>e.g. A new PHP version is out, I tune my continuous integration (CI) setup etc.</li>
</ul></li>
</ul>
<h2 id="What-is-the-Purpose-of-these-Files">What is the Purpose of these Files?</h2>
<p>Now we look on every directory and file and how it's related to the 4 key questions.
Just to remind you, the end user is interested in:</p>
<ol>
<li>Quality - <strong>What is quality of package?</strong></li>
<li>Usability - <strong>Does it solve my issue? Is it easy to use?</strong></li>
<li>Trust - <strong>Is it trustworthy?</strong></li>
<li>Maintenance - <strong>How well maintained is it?</strong></li>
</ol>
<h3 id="src-directory"><code>/src</code> directory</h3>
<p><em>Meaning</em></p>
<ul>
<li>all your PHP source code will go here</li>
</ul>
<p><em>Profit</em></p>
<ul>
<li>musthave :)</li>
</ul>
<h3 id="tests-directory"><code>/tests</code> directory</h3>
<p><em>Meaning</em></p>
<ul>
<li>all tests for your code in <code>/src</code></li>
<li>basically 1:1 mirror, just every file has <code>Test</code> suffix, e.g.
<ul>
<li><code>src/Cleaner.php</code></li>
<li><code>tests/CleanerTest.php</code></li>
</ul></li>
</ul>
<p><em>Profit</em></p>
<ul>
<li><strong>Quality</strong>: tested code is perceived better quality</li>
<li><strong>Trust</strong>: I don't have to hope that code works, <strong>I can trust the code</strong></li>
</ul>
<h3 id="gitattributes"><code>.gitattributes</code></h3>
<p><em>Meaning</em></p>
<ul>
<li>here are all files that are ignored by composer (using the <code>export-ignore</code> attribute)</li>
<li>when somebody will install your package via <code>composer require you/your-package</code>, they won't get these files downloaded to <code>/vendor</code> directory</li>
<li>usually its metadata files and tests, because application of end user does not need them</li>
</ul>
<p><em>Profit</em></p>
<ul>
<li><strong>Usability</strong>: Since your package save some internet traffic and space on hard drives, it's a bit more usable.</li>
</ul>
<h3 id="gitignore"><code>.gitignore</code></h3>
<p><em>Meaning</em></p>
<ul>
<li>here are files, that you will have locally but won't be uploaded to the remote git repository</li>
<li>for packages ignore <code>composer.lock</code>, for applications rather not - on Stackoverflow you can find <a href="https://stackoverflow.com/questions/12896780/should-composer-lock-be-committed-to-version-control">more detailed answer</a></li>
<li>also <code>/vendor</code> is there, as dependencies are installed by composer</li>
</ul>
<p><em>Profit</em></p>
<ul>
<li><strong>Trust</strong>: Without this I would not trust you know anything about open-source.</li>
</ul>
<h3 id="ecs-php"><code>ecs.php</code></h3>
<p><em>Meaning</em></p>
<ul>
<li>config for <a href="https://github.com/symplify/easy-coding-standard">Easy Coding Standard</a> - the easiest tool for coding standard</li>
<li>it checks code to keep it in one compatible coding standard format</li>
</ul>
<p><em>Profit</em></p>
<ul>
<li><strong>Quality</strong>: coders can contribute in any format their like and the coding standard tool will take care of it for them</li>
</ul>
<h3 id="phpstan-neon"><code>phpstan.neon</code></h3>
<p><em>Meaning</em></p>
<ul>
<li>configuration for <a href="https://phpstan.org/">PHPStan</a> - <em>the</em> best static analyzer to PHP</li>
<li>it run on every commit, checking obvious mistakes for you, like call on possible <code>null</code></li>
</ul>
<p><em>Profit</em></p>
<ul>
<li><strong>Trust</strong>: you and your contributors can stop thinking about detailed code and go a relax - everyone can contribute easily</li>
<li><strong>Quality</strong>: tested code is perceived better quality</li>
</ul>
<h3 id="composer-json"><code>composer.json</code></h3>
<ul>
<li>list of dependencies</li>
<li>configuration for <a href="https://packagist.org">Packagist</a>, where you need to add your package, so it can be installed by others</li>
<li>to enable it, you have to:
<ul>
<li>go there</li>
<li>add repository</li>
<li>go to settings of package, <strong>Integration and services</strong> and <strong>Add Service</strong></li>
<li>select &quot;Packagist&quot; and add your name and token from your <a href="https://packagist.org/profile">user profile</a></li>
</ul></li>
</ul>
<h3 id="LICENSE"><code>LICENSE</code></h3>
<p><em>Meaning</em></p>
<ul>
<li>license goes here</li>
<li>it's important to have it as every country has different default approach, when this file is missing</li>
<li><a href="https://opensource.org/licenses/MIT">MIT</a> is the easiest to understand open-source license</li>
</ul>
<p><em>Profit</em></p>
<ul>
<li><strong>Usability</strong>: With licence, I know what I can do with the code. Usually everything.</li>
</ul>
<h3 id="phpunit-xml"><code>phpunit.xml</code></h3>
<p><em>Meaning</em></p>
<ul>
<li>configuration for <a href="https://phpunit.de">PHPUnit</a> - testing tool</li>
<li>this can be used either by end user or Travis</li>
</ul>
<p><em>Profit</em></p>
<ul>
<li><strong>Usability</strong>: I can run <code>vendor/bin/phpunit</code> with no manual configuration. It makes life easy.</li>
</ul>
<h3 id="README"><code>README</code></h3>
<p><em>Meaning</em></p>
<ul>
<li>last but the most important - your welcome article for user</li>
<li>THE MOST IMPORTANT FILE IN THE PACKAGE!</li>
<li>Don't worry. We'll talk about writing a good readme later.</li>
</ul>
<p><em>Profit</em></p>
<ul>
<li><strong>Usability</strong>: If I understand the usage, I can rely to the issue I want to solve.</li>
<li><strong>Trust</strong>: Having code quality, Travis and coverage badges helps to identify the quality of the package.</li>
</ul>
<p>So that are all files and their purpose.</p>
<h2 id="No-time-Fast-Now-Tell-your-story-with-an-image">No time! Fast! Now! → Tell your story with an image</h2>
<p>Today people are scanning the text rather then actually reading. That's why badges are so important!</p>
<p>Look on these 2 - what information can we get?</p>
<img src="/assets/images/posts/2016/open-source/badge-2.png" alt="Confusing badge">
<ul>
<li>Test are passing - <strong>GOOD</strong></li>
<li>There is stable tag with &quot;?&quot; coverage - <strong>CONFUSING</strong></li>
<li>Master has 89% test coverage - <strong>GOOD</strong></li>
<li>Last version is probably 2.5, but not sure. Do they update manually? - <strong>CONFUSING</strong></li>
<li>Why is master promoted on first place? Should I use that? - <strong>CONFUSING</strong></li>
</ul>
<p><small>From <a href="https://github.com/doctrine/orm/blob/master/README.md">Doctrine2 repository</a>.</small></p>
<img src="/assets/images/posts/2016/open-source/badge-1.png" alt="Well informative badge">
<ul>
<li>Test are passing - <strong>GOOD</strong></li>
<li>Code quality is 10 - <strong>GOOD</strong></li>
<li>Code coverage 93% test coverage - <strong>GOOD</strong></li>
<li>It has 166 downloads. Here it depends on the age of package. → Go check release date! - <strong>GOOD</strong></li>
<li>It's tagged and has stable version. - <strong>GOOD</strong></li>
</ul>
<h2 id="What-have-we-Done-Today">What have we Done Today?</h2>
<ul>
<li>Where to go when <strong>starting a new repository</strong>.</li>
<li>What is <strong>the purpose meta files</strong>.</li>
<li>How to <strong>enable online services</strong> that help us to build better code.</li>
</ul>
<h2 id="What-s-next">What's next?</h2>
<ul>
<li>We'll peek on <strong>coding standards</strong>.</li>
<li>How do <strong>releases</strong> work a what is <strong>semantic versioning</strong>.</li>
<li>How to <strong>pick min PHP version and package versions in composer</strong>.</li>
</ul>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2016/09/16/how-to-write-open-source-in-php-2-enjoy-skeletons</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Fri, 16 Sep 2016 00:00:00 +0000</pubDate>
                                    <updated>2021-02-01UTC00:00:000</updated>
                    <atom:updated>Mon, 01 Feb 2021 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Mon, 01 Feb 2021 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2016/09/16/how-to-write-open-source-in-php-2-enjoy-skeletons#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ How to write open-source in PHP 1: Create a repository on Github ]]></title>
                <link>https://tomasvotruba.com/blog/2016/09/09/how-to-write-open-source-in-php-1-create-a-repository</link>
                <description><![CDATA[ <p>Do you have some code you want to share but you don't know exactly how? Well, writing open-source is complex process.
In this series, I'll break it down to <strong>the smallest steps possible</strong>, so that you
can <strong>start your own open-source project with zero-knowledge</strong>.
Ready? Let's start with creating a Github repository!</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Meet-GitHub-OS-s-best-friend">Meet GitHub, OS's best friend</h2>
<p>If not already, <a href="https://github.com">register on Github</a>. It's a place where all open-source lives and breathes. For free!</p>
<p>Then create a repository with <a href="https://github.com/new">New Repository</a> button.</p>
<h3 id="Name-repository-well-well-how">Name repository well... well how?</h3>
<ul>
<li>name should be explicit</li>
<li>noun... well pretty <strong>same rules as for class naming</strong></li>
<li>if you wrap or extend some other service/package, prefix with it</li>
<li>it's like headline &ndash; everyone should have clue what it does without peaking on readme</li>
<li>don't be cool... you already are!</li>
</ul>
<p>Nice theory. What about some examples?</p>
<ul>
<li><strong>good names</strong>: <em>datagrid</em>, <em>image-resizer</em>, <em>doctrine-filters</em></li>
<li><strong>bad names</strong>: <em>TomasPackage</em>, <em>DoctrineExtras</em>, <em>Translate</em></li>
</ul>
<p>That's all you need now. Hit &quot;Create repository&quot; and you are done!</p>
<h2 id="Little-book-of-git">Little book of git</h2>
<p>Now we practise first few git lines.</p>
<h3 id="Get-to-the-right-place">Get to the right place</h3>
<p>Move to the directory, where you want to host your package locally.
Open command line or Terminal in PHPStorm. Actually the PHPStorm way will open terminal already in right place. So you don't have to browse directories via <code>cd</code> command.
And call these commands there.</p>
<p>Do you know git?</p>
<p>Just follow commands, that appeared on your Github repository and <a href="#your-code-is-online">skip to next headline</a>.</p>
<pre><code class="language-bash">echo "# OpenSourcePackageDemo" &gt;&gt; README.md
git init
git add README.md
git commit -m "first commit"
git remote add origin git@github.com:tomasvotruba/open-source-package-demo.git
git push -u origin master</code></pre>
<h3 id="You-don-t-understand-those-geek-lines-I-ll-explain">You don't understand those geek lines? I'll explain</h3>
<p>These commits can be divided into 2 groups:</p>
<ol>
<li>to setup repository, <strong>just once</strong></li>
<li>to add some code, <strong>use repeatedly</strong></li>
</ol>
<h4 id="1-Setup-repository">1. Setup repository</h4>
<p>Create an empty repository git repository</p>
<pre><code class="language-bash">git init</code></pre>
<p>Add ONLINE address where we want publish your code</p>
<pre><code class="language-bash">git remote add origin git@github.com:tomasvotruba/open-source-package-demo.git</code></pre>
<h4 id="2-Add-some-code">2. Add some code</h4>
<p>Create a file README.md and add &quot;Unziping Package&quot; in it (this is just command line for geeks, I do this manually in my PHPStorm of course)</p>
<pre><code class="language-bash">echo "Unziping Package" &gt;&gt; README.md</code></pre>
<p>Tell git to NOTICE this file to be added later</p>
<pre><code class="language-bash">git add README.md</code></pre>
<p>Group all NOTICED files to single COMMIT (group of changes)</p>
<pre><code class="language-bash">git commit -m "first commit"</code></pre>
<p>Send ALL COMMITS online. Now your local system and Github repository are synced 1:1</p>
<pre><code class="language-bash">git push -u origin master</code></pre>
<p><a name="your-code-is-online"></a></p>
<h2 id="Your-code-is-online">Your code is online!</h2>
<p>Just feel the smell of success.</p>
<hr />
<h2 id="Do-you-want-get-deeper-than-that-Check-the-Checklist-2-min">Do you want get deeper than that? Check the Checklist (~2 min)</h2>
<p>Fast and clear? Go to <a href="http://phppackagechecklist.com">PHP Package Checklist</a>, that is easy to read and easy to follow.
This helped me to integrate workflow to all my packages in the start. I've selected <a href="http://phppackagechecklist.com/#1,2,3,4,6,7,11,12,13">9 most important points</a>.</p>
<p>Some of them I've already mentioned. Other will follow in next 2 articles.</p>
<p>Before creating next package, just go trough it to remind yourself what is most relevant.</p>
<hr />
<h2 id="So-our-first-step-is-behind-us">So our first step is behind us</h2>
<p>What have you learned today?</p>
<ul>
<li>That <em>OS</em> stands for <em>open-source</em>. You can also find <em>OSS</em> as for <em>open-source software</em>.</li>
<li>How to <strong>create proper OS repository</strong>.</li>
<li>How to <strong>add few lines there with git</strong>.</li>
</ul>
<h2 id="What-is-coming-next">What is coming next?</h2>
<ul>
<li>How does package skeleton make your work much easier.</li>
<li>What are <strong>repository meta files</strong>.</li>
<li>How and why to <strong>use badges</strong>.</li>
</ul>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2016/09/09/how-to-write-open-source-in-php-1-create-a-repository</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Fri, 09 Sep 2016 00:00:00 +0000</pubDate>
                                    <updated>2021-02-01UTC00:00:000</updated>
                    <atom:updated>Mon, 01 Feb 2021 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Mon, 01 Feb 2021 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2016/09/09/how-to-write-open-source-in-php-1-create-a-repository#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Forget &quot;autowire&quot; and just use it ]]></title>
                <link>https://tomasvotruba.com/blog/2016/07/18/forget-autowire-just-use-it</link>
                <description><![CDATA[ <p>Autowiring is a great feature that was added in Symfony 2.8. It moves Dependency Injection pattern to the next level.
If you want to use it to its full potential, you still have to add 1 extra line to every service configuration.
Today I will show you, how to get rid of that line.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="When-to-autowire">When to autowire?</h2>
<p>If you use autowiring daily, you might came across this thinking process before you place <code>autowired: true</code> to your config:</p>
<p><em>1) Has this service constructor dependency?</em></p>
<ul>
<li>No =&gt; skip</li>
<li>Yes =&gt; go on</li>
</ul>
<p><em>2) Is it object?</em></p>
<ul>
<li>No =&gt; skip</li>
<li>Yes =&gt; go on</li>
</ul>
<p><em>3) Is it unique service type?</em></p>
<ul>
<li>No =&gt; add <a href="https://github.com/symfony/symfony/pull/21494"><code>alias</code> for specific name to required service</a></li>
<li>Yes =&gt; autowire</li>
</ul>
<p><em>4) Has the constructor changed during development?</em></p>
<ul>
<li>Start from point 1.</li>
</ul>
<p>Plus some more logic for edge cases like parameters and factories.</p>
<h2 id="Seems-like-function-Could-this-be-automated">Seems like function... Could this be automated?</h2>
<p>You are right! <strong>It can be automated.</strong></p>
<p>This is exactly what <a href="https://github.com/Symplify/DefaultAutowire">Symplify/DefaultAutowire</a> bundle does.</p>
<p>Apart handling feature above for you, it will turn this...</p>
<pre><code class="language-yaml"># app/config/config.yml
services:
    PriceCalculator:
        autowire: true

    ProductRepository:
        autowire: true

    UserFactory:
        autowire: true</code></pre>
<p>...into this:</p>
<pre><code class="language-yaml"># app/config/config.yml
services:
    PriceCalculator: ~

    ProductRepository: ~

    UserFactory: ~</code></pre>
<h2 id="Get-It-Done-in-2-steps">Get It Done in 2 steps</h2>
<h3 id="1-Install-package">1. Install package</h3>
<pre><code class="language-yaml">composer require symplify/default-autowire</code></pre>
<h3 id="2-Register-bundle">2. Register bundle</h3>
<pre><code class="language-php">// app/AppKernel.php

final class AppKernel extends Kernel
{
    public function registerBundles(): array
    {
        $bundles = [
            new Symplify\DefaultAutowire\SymplifyDefaultAutowireBundle(),
            // ...
        ];
    }
}</code></pre>
<p>And that's it!</p>
<p>For further use, <strong>just check Readme for <a href="https://github.com/Symplify/DefaultAutowire">Symplify/DefaultAutowire</a>.</strong></p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2016/07/18/forget-autowire-just-use-it</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 18 Jul 2016 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2016/07/18/forget-autowire-just-use-it#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Filters Pattern in Nette Database ]]></title>
                <link>https://tomasvotruba.com/blog/2016/06/17/filters-pattern-in-nette-database</link>
                <description><![CDATA[ <p>You want to delete comments, so your readers won't see any spam or violent content.
But you want to see them in administration. So you would have to create 2 different methods.
Today I will show you, how to make only single one.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Current-way-to-do-this">Current way to do this</h2>
<p>Let's say we have a <code>CommentRepository</code> class, where we put all methods that work with &quot;comment&quot; table.</p>
<p>In it, we have 2 methods:</p>
<ul>
<li>1 for frontend</li>
<li>1 for administration</li>
</ul>
<pre><code class="language-php">namespace App\Repository;

use Nette\Database\Context;
use Nette\Database\Table\Selection;

class CommentRepository
{

    /**
     * @var Selection
     */
    private $commentTable;

    public function __construct(Context $database)
    {
        $this-&gt;commentTable = $database-&gt;table('comment');
    }

    /**
     * Returns only comments, that are not deleted.
     */
    public function fetchCommentsForFrontend()
    {
        return $this-&gt;commentTable-&gt;where('is_deleted = ?', FALSE)
            -&gt;fetchAll();
    }

    public function fetchCommentsForAdministration()
    {
        return $this-&gt;commentTable-&gt;fetchAll();
    }

}</code></pre>
<p>And <strong>decide manually</strong>, where to use <code>fetchCommentsForFrontend()</code> and where to use <code>fetchAllCommentsForAdministration()</code>.</p>
<p>This approach is bad practise, because it will eventually <strong>make your every repository class double its size</strong>.</p>
<p>No need for that! This has been already solved somewhere else.</p>
<p>Do you know Doctrine Filters? No? Go check <a href="/blog/2016/04/30/decouple-your-doctrine-filters/">this short article to get the clue</a>. I'll wait here.</p>
<h2 id="Soft-delete-filter-in-theory">Soft delete filter - in theory</h2>
<p>In short, with filters you can modify any query. In our case:</p>
<ul>
<li>detect if the query is for &quot;comment&quot; table</li>
<li>detect if we are frontend or backend</li>
<li>if frontend, add where &quot;is_deleted=0&quot; condition to hide deleted comment</li>
</ul>
<p>This will influence <strong>every query for &quot;comment&quot; table</strong>.
So you can be sure you'll never forget to add the condition.</p>
<h2 id="Show-me-the-code">Show me the code</h2>
<p>There is not much to talk about, because filters are made to be simple. So here is filter:</p>
<pre><code class="language-php"># app/Database/Filter/SoftDeletableFilter.php

namespace App\Database\Filter;

use Nette\Application\Application;
use Nette\Database\Table\Selection;
use Zenify\NetteDatabaseFilters\Contract\FilterInterface;

class SoftDeletableFilter implements FilterInterface
{

    public function __construct(Application $application)
    {
        $this-&gt;application = $application;
    }

    public function applyFilter(Selection $selection)
    {
        // 1. apply only to "comment" table
        $tableName = $selection-&gt;getName();
        if ($tableName !== 'comment') {
            return;
        }

        // 2. skip for admin presenters
        // add your custom method, that detects admin presenter via name or class inheritance
        if ($this-&gt;isAdminPresenter($this-&gt;application-&gt;getPresenter())) {
            return;
        }

        // 3. show only visible (not deleted) comments
        $selection-&gt;where('is_deleted = ?', FALSE);
    }

}</code></pre>
<p>And that's all.</p>
<p>These filters are possible in Nette\Database only thanks to <a href="https://github.com/Zenify/NetteDatabaseFilters">Zenify/NetteDatabaseFilters</a> package.</p>
<p>Do you want to try it for yourself? Let's go.</p>
<h2 id="Your-First-Filter-in-4-steps">Your First Filter in 4 steps</h2>
<h3 id="1-Install-package">1. Install package</h3>
<pre><code class="language-bash">composer require zenify/nette-database-filters</code></pre>
<h3 id="2-Register-Extension">2. Register Extension</h3>
<pre><code class="language-yaml"># app/config/config.neon
extensions:
    - Zenify\NetteDatabaseFilters\DI\NetteDatabaseFiltersExtension</code></pre>
<h3 id="3-Create-your-filter">3. Create your filter</h3>
<p>The one above...</p>
<h3 id="4-Register-it-as-a-service">4. Register it as a service</h3>
<pre><code class="language-yaml"># app/config/config.neon
services:
    - App\Database\Filter\SoftDeletableFilter</code></pre>
<p>And that's it! Now your filter will be reflected in whole application.</p>
<p>So you can reduce your repository code and use <code>fetchComments()</code> in all places.</p>
<pre><code class="language-php"># app/Repository/CommentRepository.php

namespace App\Repository;

use Nette\Database\Context;
use Nette\Database\Table\Selection;

class CommentRepository
{

    /**
     * @var Selection
     */
    private $commentTable;

    public function __construct(Context $database)
    {
        $this-&gt;commentTable = $database-&gt;table('comment');
    }

    public function fetchComments()
    {
        return $this-&gt;commentTable-&gt;fetchAll();
    }

}</code></pre>
<p>For further use just <strong>check Readme for <a href="https://github.com/Zenify/NetteDatabaseFilters#nette-database-filters">Zenify/NetteDatabaseFilters</a></strong>.</p>
<h2 id="Protip-for-multiple-tables-with-the-same-column">Protip for multiple tables with the same column!</h2>
<p>What if you have <strong>multiple tables with &quot;is_deleted&quot; column</strong>? &quot;comment&quot;, &quot;article&quot;, &quot;page&quot; table... maybe &quot;banner&quot;, &quot;user&quot; in the furture.</p>
<ul>
<li>
<p>Do you have to create filter for every one of them? <strong>No.</strong></p>
</li>
<li>
<p>Do you have to name them all in the filter class? <strong>No.</strong></p>
</li>
<li>
<p>Do you need to check the column presence only? <strong>YES!</strong></p>
</li>
</ul>
<p>And I will show you how do it:</p>
<pre><code class="language-php"># app/Database/Filter/SoftDeletableFilter.php

// ...

public function applyFilter(Selection $selection)
{
    if (!$this-&gt;isSoftdelable($selection)) {
        return;
    }

    // ... condition code
}

/**
 * @return bool
 */
private function isSoftdelable(Selection $selection)
{
    $selectionToCheck = clone $selection;
    return $selectionToCheck-&gt;fetch()
        -&gt;offsetExists('is_deleted');
}</code></pre>
<p>Pretty neat, huh?</p>
<h2 id="What-Have-You-Learned-Today">What Have You Learned Today?</h2>
<ul>
<li>that Database Filters is a pattern for decorating query of specific table</li>
<li>that Nette Database can implement this pattern in a form of service</li>
<li>that you can add filter via simple service with <a href="https://github.com/Zenify/NetteDatabaseFilters">Zenify/NetteDatabaseFilters</a></li>
</ul>
<p>If you have some tips how to this simpler or want to share your experience with filters, just let me know below.</p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2016/06/17/filters-pattern-in-nette-database</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Fri, 17 Jun 2016 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2016/06/17/filters-pattern-in-nette-database#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Decouple Your Doctrine Filters ]]></title>
                <link>https://tomasvotruba.com/blog/2016/04/30/decouple-your-doctrine-filters</link>
                <description><![CDATA[ <p>Doctrine filters are powerful tool. Yet their registration and management are bit overcomplicated. Today I will show you how to decouple them to standalone services that can take care of everything you need.</p> ]]></description>
                <content:encoded><![CDATA[ <h2 id="Standard-Process-to-Enable-Filter">Standard Process to Enable Filter</h2>
<p>If you don't know Doctrine Filters, <a href="https://knpuniversity.com">KnpUniversity</a> has very nice, short and funny tutorial about them. <a href="https://knpuniversity.com/screencast/doctrine-queries/filters">Go check it</a>, I'll wait here...</p>
<blockquote>
<p>Are you busy and smart? Just check <a href="https://www.slideshare.net/rosstuck/extending-doctrine-2-for-your-domain-model-13257781/13">slides 13 to 31</a> from <a href="https://twitter.com/rosstuck">@RossTuck</a>'s presentation about cool features of Doctrine.</p>
</blockquote>
<p>So now you know, that to enable filter in Symfony you have to:</p>
<ol>
<li>register them manually under DoctrineBundle configuration (in one global config file <code>app/config/config.yml</code>)</li>
<li>get Doctrine's EntityManager in Controller</li>
<li>get filter by it's name previously defined in <code>app/config/config.yml</code></li>
<li>enable it</li>
</ol>
<p>You have to do all these steps just to turn something on. Imagine you'd have to do this for every Voter, Command or EventSubscriber.</p>
<h2 id="Could-We-Make-It-Easier">Could We Make It Easier?</h2>
<p>In the tutorial from KnpUniversity, there is way to skip enabling filters in controller - by creating own <a href="https://knpuniversity.com/screencast/doctrine-queries/filters#enabling-a-filter-globally">BeforeRequestListener</a>.</p>
<p>It's quite nice, but it just moves all these steps from controller's responsibility somewhere else. So you have to enable them again, just in different place.</p>
<p>Let's say this is fine enough. <strong>But what about modular applications with own per module filters?</strong> Not so easy.</p>
<h2 id="Minimal-Viable-Product">Minimal Viable Product</h2>
<p>For better understanding what is really important, let's break down the purpose of the filter.</p>
<ul>
<li>it's a <strong>piece of code in class that must inherit from <code>Doctrine\ORM\Query\Filter\SQLFilter</code></strong></li>
<li>it <strong>decorates SQL queries</strong> with custom code</li>
<li><strong>sometimes it's conditional</strong> - you want it to be enabled or disabled</li>
</ul>
<p>That's all it does. Everything else is just syntax sugar, glue code or entry point to work with them.</p>
<p>Saying that, we can <strong>get rid of Controllers, Subscribers, DoctrineBundle, <code>app/config/config.yml</code></strong> and yet still make use of them.</p>
<h2 id="Decouple-Your-Doctrine-Filter-to-Service">Decouple Your Doctrine Filter... to Service</h2>
<p>When we remove everything we don't need, we could end up with simple service:</p>
<pre><code class="language-php">use Doctrine\ORM\Mapping\ClassMetadata;
use Symplify\DoctrineFilters\Contract\Filter\FilterInterface;

final class ActiveFilter implements FilterInterface
{
    /**
     * {@inheritdoc}
     */
    public function addFilterConstraint(ClassMetadata $entity, $alias)
    {
        return "$alias.active = 1";
    }
}</code></pre>
<p>And register it as service:</p>
<pre><code class="language-yaml"># Resoureces/config.yml
services:
    module.softdeletable_filter:
        class: SoftdeletableFilter</code></pre>
<p>That's all we really need to do.</p>
<h2 id="Decoupling-of-Doctrine-Filter-in-4-steps">Decoupling of Doctrine Filter in 4 steps</h2>
<p>This is already possible thanks to <a href="https://github.com/Lekarna/DoctrineFilters">Lekarna/ModularDoctrineFilters</a> package.</p>
<p>Let's try it together!</p>
<h3 id="1-Install-package">1. Install package</h3>
<pre><code class="language-bash">composer require symplify/modular-doctrine-filters</code></pre>
<h3 id="2-Register-Bundle">2. Register Bundle</h3>
<pre><code class="language-php">// app/AppKernel.php
class AppKernel extends Kernel
{
    public function registerBundles()
    {
        $bundles = [
            new Symplify\ModularDoctrineFilters\SymplifyModularDoctrineFiltersBundle(),
            // ...
        ];
    }
}</code></pre>
<h3 id="3-Create-Service">3. Create Service</h3>
<pre><code class="language-php">// src/SomeBundle/Doctrine/Filter/SoftdeletableFilter.php
namespace SomeBundle\Doctrine\Filter;

use Symplify\DoctrineFilters\Contract\Filter\FilterInterface;

final class SoftdeletableFilter implements FilterInterface
{
    /**
     * {@inheritdoc}
     */
    public function addFilterConstraint(ClassMetadata $entity, $alias)
    {
        if ($entity-&gt;getReflectionClass()-&gt;hasProperty('isDeleted')) {
            // or another condition to integrate enable/disable process
            return "$alias.isDeleted = 0";
        }
        return '';
    }
}</code></pre>
<blockquote>
<p>This could be filter for <a href="https://github.com/KnpLabs/DoctrineBehaviors#softDeletable">Softdeletable</a> from <a href="https://github.com/KnpLabs/DoctrineBehaviors">DoctrineBehaviors</a>.</p>
</blockquote>
<h3 id="4-Register-it-as-a-service-to-your-module">4. Register it as a service to your module</h3>
<pre><code class="language-yaml"># src/SomeBundle/Resources/config/services.yml
services:
    some_module.softdeletable_filter:
        class: SomeBundle\Doctrine\Filter\SoftdeletableFilter</code></pre>
<p>And that's it! Now your filter will be reflected in whole application.</p>
<p>For further use <strong>just check Readme for <a href="https://github.com/Symplify/ModularDoctrineFilters">Symplify/ModularDoctrineFilters</a></strong>.</p>
<h2 id="What-Have-You-Learned-Today">What Have You Learned Today?</h2>
<ul>
<li>that Doctrine Filters can decorate every query in your application from single place</li>
<li>that Doctrine Filter is basically just an object that might add some code to query</li>
<li><strong>that you can add filter via simple service with <a href="https://github.com/Symplify/ModularDoctrineFilters">Symplify/ModularDoctrineFilters</a></strong></li>
</ul>
<p>If you have some tips how to this simpler or want to share your experience with filters, just let me know below.</p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2016/04/30/decouple-your-doctrine-filters</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Sat, 30 Apr 2016 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2016/04/30/decouple-your-doctrine-filters#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Autowired Controllers as Services for Lazy People ]]></title>
                <link>https://tomasvotruba.com/blog/2016/03/10/autowired-controllers-as-services-for-lazy-people</link>
                <description><![CDATA[ <p>With new autowiring feature in Symfony 2.8+, it is now easier to manage dependencies for services. But what about for controllers? Unfortunately, there are 3 annoying steps you have to do. Today I will show you, how to reduce them to 0.</p> ]]></description>
                <content:encoded><![CDATA[ <h3 id="Disclaimer-Why-even-use-controllers-as-services">Disclaimer: Why even use controllers as services?</h3>
<p><strong>The goal of this article is not to discuss pro and cons of &quot;controller as service&quot; (further CAS) approach</strong>. If you
haven't decided yet to use CAS, I recommend checking these articles:</p>
<ul>
<li><a href="https://knpuniversity.com/screencast/question-answer-day/controllers-services">Symfony2: Make my Controllers Services?</a> [released 2013 by KNPUniversity]</li>
<li><a href="http://php-and-symfony.matthiasnoback.nl/2014/06/how-to-create-framework-independent-controllers">Symfony2: How to create framework independent controllers?</a> [released 2014]</li>
<li><a href="http://richardmiller.co.uk/2011/04/15/symfony2-controller-as-service">Symfony2: Controller as Service</a> [released 2011]</li>
</ul>
<p><br></p>
<p>But now, back to the topic.</p>
<h2 id="Autowire-service-Easy">Autowire service? Easy!</h2>
<p>With <a href="https://dunglas.fr/2015/10/new-in-symfony-2-83-0-services-autowiring">autowire feature</a>, managing dependencies for services is now as simple as:</p>
<pre><code class="language-yaml">services:
    post.publisher:
        class: PostPublisher
        autowire: true # all you got to do is add this line</code></pre>
<h2 id="Autowire-controller-Hell">Autowire controller? Hell!</h2>
<p>Managing dependencies for controllers in same way is complicated. To apply the same effect, you have to make following 3 steps:</p>
<ol>
<li>
<p>Register controller manually as service to the config</p>
<pre><code class="language-yaml"># app/config/services.yml
services:
    post_controller: # you have to use this name everywhere, so pick it wisely
        class: PostController
        autowire: true</code></pre>
</li>
<li>
<p>Add <code>@Route</code> annotation with service name</p>
<pre><code class="language-php">// src/AppBundle/Controller/PostController.php
namespace AppBundle\Controller\PostController;

use Sensio\Bundle\FrameworkExtraBundle\Configuration\Route;

/**
 * @Route(service="post_controller") # watch for typo here!
 */
class PostController
{
    public function listAction()
    {
    }
}</code></pre>
<p>or route using service name:</p>
<pre><code class="language-yaml"># app/config/routing.yml
post_list:
    path: /post-list
    defaults:
        _controller: post_controller:listAction
        # and not bundle like approach
        # _controller: AppBundle:Post:list</code></pre>
<blockquote>
<p>This difference is so difficult to spot, that it <a href="https://stackoverflow.com/a/27221394/1348344">created question on StackOverflow</a>.</p>
</blockquote>
</li>
<li>
<p>Finally, you have to use service name and single colon for referring:</p>
<pre><code class="language-php">// any controller
$this-&gt;forward('post_controller:listAction'));</code></pre>
</li>
</ol>
<blockquote>
<p>There is <a href="https://stackoverflow.com/questions/31366074/how-exactly-can-i-define-a-controller-as-service-using-annotations/31366589#31366589">nice answer on StackOverflow explaining with more details</a>.</p>
</blockquote>
<p>This process is exhausting already and difficult to remember.</p>
<h3 id="Did-you-make-it-Here-comes-much-deeper-hell">Did you make it? Here comes much deeper hell</h3>
<p>Even if you do manage to finish these steps, <strong>these issues will appear</strong>:</p>
<ul>
<li>
<p><a href="https://stackoverflow.com/questions/33857659/symfony-autowiring-services-with-the-controller">drawback</a> of FrameworkBundle, when it tries to autowire controller</p>
<img src="http://i.stack.imgur.com/r4cBD.png">
</li>
<li>
<p>it's complicated to apply constructor dependency injection for extended 3rd party controllers (Sonata, FOS...), due to missing step 2 and 3 (that were mentioned above) and the &quot;bundle naming&quot; inside the bundle's code</p>
</li>
</ul>
<h3 id="Is-there-some-way-back-from-hell-to-heaven">Is there some way back from hell to heaven?</h3>
<p>Author of autowiring feature and Symfony core contributor Kévin Dunglas <a href="https://github.com/symfony/symfony/pull/16863#issuecomment-162221353">sees similar problem</a> and <a href="https://dunglas.fr/2016/01/dunglasactionbundle-symfony-controllers-redesigned">proposes solution with ADR pattern</a>. I think it's the right direction, but it bends controllers too much.</p>
<p>But the goal is to keep controllers' code without touching.</p>
<h2 id="Autowiring-in-Controllers">Autowiring in Controllers</h2>
<p>This is wheremade <a href="https://github.com/Symplify/ControllerAutowire">Symplify\ControllerAutowire</a> bundle helps. It solves problems mentioned above.</p>
<p>How does it work?</p>
<ul>
<li>find controllers in <code>/src</code> directory</li>
<li>register them as services</li>
<li>autowire its constructors</li>
<li>handle routing properly for both &quot;service name&quot; and &quot;bundle name&quot; approaches</li>
<li>and all on compile time</li>
</ul>
<p>Let's try it together.</p>
<h3 id="1-Install-package">1. Install package</h3>
<pre><code class="language-yaml">composer require symplify/controller-autowire</code></pre>
<h3 id="2-Register-bundle">2. Register bundle</h3>
<pre><code class="language-php">// app/AppKernel.php
class AppKernel extends Kernel
{
    public function registerBundles()
    {
        $bundles = [
            new Symplify\ControllerAutowire\SymplifyControllerAutowireBundle(),
            // ...
        ];
    }
}</code></pre>
<h3 id="3-Add-some-dependency-for-your-controller-via-constructor">3. Add some dependency for your controller via constructor</h3>
<pre><code class="language-php">// src/AppBundle/Controller/DefaultController.php
namespace AppBundle\Controller;

use Sensio\Bundle\FrameworkExtraBundle\Configuration\Route;
use Symfony\Bundle\FrameworkBundle\Controller\Controller;
use Symfony\Component\EventDispatcher\EventDispatcherInterface;
use Symfony\Component\HttpFoundation\Request;

class DefaultController extends Controller
{
    /**
     * @var EventDispatcherInterface
     */
    private $eventDispatcher;

    public function __construct(EventDispatcherInterface $eventDispatcher)
    {
        $this-&gt;eventDispatcher = $eventDispatcher;
    }

    /**
     * @Route("/", name="homepage")
     */
    public function indexAction(Request $request)
    {
        $this-&gt;eventDispatcher-&gt;dispatch('someEvent');

        return $this-&gt;render('default/index.html.twig', [
            // ...
        ]);
    }
}</code></pre>
<p>And that's it!</p>
<p>For further use, <strong>just check Readme for <a href="https://github.com/Symplify/ControllerAutowire">Symplify/ControllerAutowire</a>.</strong></p>
<p><br></p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2016/03/10/autowired-controllers-as-services-for-lazy-people</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 10 Mar 2016 00:00:00 +0000</pubDate>
                                    <updated>2017-05-01UTC00:00:000</updated>
                    <atom:updated>Mon, 01 May 2017 00:00:00 +0000</atom:updated>
                    <lastBuildDate>Mon, 01 May 2017 00:00:00 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2016/03/10/autowired-controllers-as-services-for-lazy-people#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ Modular Routing in Symfony ]]></title>
                <link>https://tomasvotruba.com/blog/2016/02/25/modular-routing-in-symfony</link>
                <description><![CDATA[ <p>Modular routing in Symfony is bounded to <code>routing.yml</code>. Adding few lines for each new module can create large mess. Can we make it bit simpler? Sure we do and I will show you how.</p> ]]></description>
                <content:encoded><![CDATA[ <p>Let's say you have fairly standalone module or package and you want to add its routes as simple as:</p>
<pre><code class="language-php">// app/AppKernel.php

final class AppKernel extends Kernel
{
    public function registerBundles(): array
    {
        $bundles = [
            new App\MeetupModule\AppMeetupModuleBundle(),
            // ...
        ];
    }
}</code></pre>
<h2 id="So-what-you-can-do">So, what you can do?</h2>
<ul>
<li>add your routes manually to <code>routing.yml</code> - <strong>requires routing.yml modification</strong></li>
<li>implement <a href="https://symfony.com/doc/current/cookbook/routing/custom_route_loader.html">custom Route Loader</a> - <strong>requires routing.yml modification</strong></li>
<li>use <a href="https://github.com/symfony-cmf/RoutingBundle">Symfony CMF RoutingBundle</a> and hook to <a href="https://symfony.com/doc/current/cmf/components/routing/chain.html">ChainRouter</a> - <strong>requires lots of reading and programming</strong></li>
</ul>
<p><br></p>
<div class="text-center">
    <img src="/assets/images/posts/2016/modular-router/mess.jpg" alt="Wow, so many options!">
    <br>
    <em>Wow, so many options!</em>
</div>
<p><br></p>
<p>As <a href="https://twitter.com/matthiasnoback">Matthias Noback</a> <a href="http://php-and-symfony.matthiasnoback.nl/2012/01/symfony2-dynamically-add-routes">wrote 4 years ago</a>, in Symfony 1 you could use <code>routing.load_configuration</code> event to do this, but it was removed in Symfony 2. As a replacement, Matthias suggests creating custom Route Loader. It's the best solution so far I used before.</p>
<p>But I'm older and more lazy now so I tried to find a simpler way.</p>
<blockquote>
<p>Warning!<br>
If you prefer <strong>YAML, XML or PHP definition, good news - continue</strong>.<br>
In case you use <code>@Route</code> annotation, following solution won't help you.</p>
</blockquote>
<h2 id="Load-your-routes-in-1-method">Load your routes in 1 method</h2>
<p>Routes are usually in form of a simple array with <code>url</code> → <code>controller</code> records.</p>
<p><strong>What if loading of this simple array could be done via simple service? Something as simple as:</strong></p>
<pre><code class="language-php">use Symfony\Component\Routing\Route;
use Symfony\Component\Routing\RouteCollection;

public function getRouteCollection(): RouteCollection
{
    return $this-&gt;loadRouteCollectionFromFile(__DIR__ . '/routes.yml');

    // OR xml
    return $this-&gt;loadRouteCollectionFromFile(__DIR__ . '/routes.xml');

    // OR even multiple files
    return $this-&gt;loadRouteCollectionFromFiles([
        __DIR__ . '/front_routes.yml',
        __DIR__ . '/admin_routes.yml'
    ]);

    // OR pure PHP with some tweaks
    $routeCollection = new RouteCollection();
    $routeCollection-&gt;add('my_route', new Route('/hello'));

    return $routeCollection;
}</code></pre>
<h2 id="Load-your-routes-in-modular-way-in-4-steps">Load your routes in modular way in 4 steps</h2>
<p>All those options above are available in Symfony, thanks to <a href="https://github.com/Symplify/ModularRouting">Symplify\ModularRouting package</a>.</p>
<p>Let's try it together.</p>
<h3 id="1-Install-package">1. Install package</h3>
<pre><code class="language-bash">composer require symplify/modular-routing</code></pre>
<h3 id="2-Register-bundles">2. Register bundles</h3>
<pre><code class="language-php">// app/AppKernel.php
final class AppKernel extends Kernel
{
    public function registerBundles(): array
    {
        return [
            new Symfony\Bundle\FrameworkBundle\FrameworkBundle(),
            new Symfony\Cmf\Bundle\RoutingBundle\CmfRoutingBundle(),
            new Symplify\ModularRouting\SymplifyModularRoutingBundle(),
            // ...
        ];
    }
}</code></pre>
<h3 id="3-Create-services-to-load-your-YAML-file">3. Create services to load your YAML file</h3>
<pre><code class="language-php">// src/SomeBundle/Routing/SomeRouteCollectionProvider.php
namespace SomeBundle\Routing;

use Symfony\Component\Routing\RouteCollection;
use Symplify\ModularRouting\Routing\AbstractRouteCollectionProvider;

final class SomeRouteCollectionProvider extends AbstractRouteCollectionProvider
{
    public function getRouteCollection(): RouteCollection
    {
        # routes.yml is the file, where all your routes are located
        return $this-&gt;loadRouteCollectionFromFile(__DIR__ . '/routes.yml');
    }
}</code></pre>
<h3 id="4-Register-it-as-a-service-to-your-module">4. Register it as a service to your module</h3>
<pre><code class="language-yaml"># src/SomeBundle/Resources/config/services.yml
services:
    SomeBundle\Routing\SomeRouteCollectionProvider: ~</code></pre>
<p>And that's it! Now all routes are loaded along with your bundle registration.</p>
<p>For further use, <strong>just check <a href="https://github.com/Symplify/ModularRouting">Readme for Symplify/ModularRouting</a></strong>.</p>
<p><br></p>
<div class="text-center">
    <img src="/assets/images/posts/2016/modular-router/you-are-king.jpg">
</div>
<p><br></p>
<h2 id="What-have-you-learned-today">What have you learned today?</h2>
<ul>
<li>that registering routes usually requires using <code>app/routing/routing.yml</code> - unfortunately :(</li>
<li>that routes is basically array of <code>url</code> → <code>controller</code> records</li>
<li><strong>that you can load them per module via service with <a href="https://github.com/Symplify/ModularRouting">Symplify/ModularRouting</a></strong></li>
</ul>
<p>If you have some questions or tips for how to make loading of routes simpler, just let me know below.</p>
<p>Happy coding!</p> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2016/02/25/modular-routing-in-symfony</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Thu, 25 Feb 2016 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2016/02/25/modular-routing-in-symfony#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ The Best of SymfonyCon 2015 ]]></title>
                <link>https://tomasvotruba.com/blog/2015/12/20/the-best-of-symfonycon-2015</link>
                <description><![CDATA[ <p>Annual SymfonyCon held this year in Paris. Despite all the attacks, Paris lives on. Maybe more. An example of this can be 1000 visitors who arrived at the event. I represented Bohemia with Dennis, and also with Petr and Cuba from Lmc.eu.</p> ]]></description>
                <content:encoded><![CDATA[ <div class="text-center">
    <img src="/assets/images/posts/2015/symfonycon/symfonycon-divadlo.jpg" class="img-thumbnail">
    <br>
    <em>The queue on the Symfony Elephpants. No more left in 2 hours.</em>
</div>
<p><br></p>
<p>And now to the point. There were over 20 lectures in the beautiful theater and affiliated cinema.</p>
<p>Today we will look at the 4 best.</p>
<h2 id="1-10-years-of-Symfony">1. 10 years of Symfony</h2>
<p>The Symfony have been with us for 10 years. Although the project was founded by Fabien Potencier, it is worth more and more personalities that move it towards greater clarity and usability.</p>
<p>Fabien mentioned over 20 people he had met on his journey and showed who contributed to the Symphony. It sounded like a toy. Very inspiring for those who want to scale their open-source projects and indulge in their long life.</p>
<h3 id="1-Thing-Worth-Remembering">1 Thing Worth Remembering</h3>
<p>Among others, he introduced a <a href="https://symfony.com/blog/improving-the-symfony-release-process">new release process</a>, that will facilitate <em>continuous upgrades</em>.</p>
<div class="text-center">
    <img class="img-thumbnail" src="/assets/images/posts/2015/symfonycon/symfonycon-release-process.jpg">
</div>
<p><br></p>
<p>Simply put:</p>
<ul>
<li>with every new major version the old one comes out</li>
<li>both will be LTS</li>
<li>both will have the same feat</li>
<li>as well as 2.8 and 3.0</li>
</ul>
<p>The transition to the new major version will be under much greater control than ever before.</p>
<h2 id="2-Symfony2-at-BlaBlaCar">2. Symfony2 at BlaBlaCar</h2>
<p><a href="https://speakerdeck.com/odolbeau/symfony-at-blablacar" class="btn btn-warning btn-sm">
See Slides
</a></p>
<p>This seemingly random-generated company deals with blah blah blah... ridesharing, that is, together.</p>
<div class="text-center">
    <img src="/assets/images/posts/2015/symfonycon/symfonycon-bla-bla-car.png" class="img-thumbnail">
</div>
<p><br></p>
<p>This was a case study firm that started out as a small startup, growing fast and learning to scroll along the march. They tried lots of ways that did not work to find the right ones (for their context, of course).</p>
<p>It's about these &quot;do's and don't's&quot; that our lecturers shared:</p>
<ul>
<li>upgrade as soon as you can</li>
<li>failure is beginning</li>
<li>Doctrine - fast, but issues with MVC, cache, integrity problems, scale, decoupling...</li>
<li>Event Dispatching in RabbitMQ</li>
</ul>
<h3 id="1-Thing-Worth-Remembering">1 Thing Worth Remembering</h3>
<p>The more varied the development of other applications where it usually passes monolithic repository for separate microservices using the REST API?</p>
<p>Microservices not use their internal APIs that they came too difficult to maintain, but their own solutions.</p>
<p>They call him <strong>The Gateway</strong> (<a href="https://speakerdeck.com/odolbeau/symfony-at-blablacar?slide=64">slajd</a>) and its advantages are DDD, separation of business logic and data přístwupu and transparent organization. Interesting idea.</p>
<h2 id="3-New-Symfony-Tips-and-Tricks">3. New Symfony Tips and Tricks</h2>
<p><a href="https://www.slideshare.net/javier.eguiluz/new-symfony-tips-tricks-symfonycon-paris-2015" class="btn btn-warning btn-sm">
See Slides
</a></p>
<p>And now something for everyone:</p>
<div class="text-center">
    <img src="/assets/images/posts/2015/symfonycon/symfonycon-tips-and-tricks.jpg" class="img-thumbnail">
</div>
<p><br></p>
<p><a href="https://twitter.com/javiereguiluz">Javier Eguiluz</a>, whom we all know as:</p>
<div class="text-center">
    <img src="/assets/images/posts/2015/symfonycon/symfonycon-javier.png" class="img-thumbnail">
</div>
<p><br></p>
<p>He shared with us about tips and tricks that gathered over the last year - not only for writing <a href="https://symfony.com/blog/category/a-week-of-symfony">Week of Symfony</a>.</p>
<p>For me it was the most interesting lecture from which I took a large number of tips in their own practice.</p>
<p><strong>Tips are for beginners and advanced</strong>, such as</p>
<ul>
<li>nested Doctrine transactions</li>
<li>custom logger formatter - no ugly confusing logos</li>
</ul>
<p>The lecture was full of useful tips that simply could not absorb all at once.</p>
<p>I was pleased that it was even a few tips from <a href="https://twitter.com/hasonm">Martin Hasoň</a>.</p>
<p>This inspired me a great overview and blink on <a href="https://www.slideshare.net/javier.eguiluz/symfony-tips-and-tricks">the version from last year</a>.</p>
<h3 id="1-Thing-Worth-Remembering">1 Thing Worth Remembering</h3>
<p>If you assume an application without testing and want to add at least some control, will you throw &quot;smoke testing&quot; for all services:</p>
<pre><code class="language-php">public function testContainerServices()
{
    $client = static::createClient();

    foreach ($client-&gt;getContainer()-&gt;getServiceIds() as $serviceId) {
        $service = $client-&gt;getContainer()-&gt;get($serviceId);
        $this-&gt;assertNotNull($service);
    }
}</code></pre>
<h2 id="4-Symfony-Your-next-Microframework">4. Symfony: Your next Microframework</h2>
<p><a href="https://www.slideshare.net/weaverryan/symfony-your-next-microframework-symfonycon-2015" class="btn btn-warning btn-sm">
See Slides
</a></p>
<p>Ryan Weaver is awesome. Surely you know him even you - from Symfony blog, which he gives a gripping read. And just as gripping and funny (maybe even funnier) is in person. His lecture that Symfony can now be used as microframework (thanks <a href="https://github.com/symfony/symfony/blob/3.0/src/Symfony/Bundle/FrameworkBundle/Kernel/MicroKernelTrait.php">MicroKernelTrait</a>) was absolutely great.</p>
<p>He showed us new ways and means...</p>
<ul>
<li>as having &quot;multiple applications&quot; in one project,</li>
<li>how to make a minimalist website with all the magical widgets Symfony,</li>
<li>and most importantly, how to kill Silex because this lecture him totally whacked.</li>
</ul>
<p>On this issue will soon come out at the source article, where you show everything in detail.</p>
<h3 id="1-Thing-Worth-Remembering">1 Thing Worth Remembering</h3>
<p>Previously, the choice was clear:</p>
<ul>
<li>Silex small and simple applications</li>
<li>Symfony for larger ones</li>
</ul>
<p>Thus, when used MicroKernel?</p>
<ul>
<li>MicroKernel comes in handy when you start a small application, but want it in time scale. In addition to Silex supports Bundle.</li>
</ul>
<h3 id="Other-Talks-Worth-of-Click">Other Talks Worth of Click</h3>
<ul>
<li><em>Marc Morena</em> - When e-commerce meets Symfony (<a href="https://www.slideshare.net/MarcMorera/when-ecommercemeetssymfonyparissymfonycon2015">see slides</a>)</li>
<li><em>Benjamin Eberlei</em> - Doctrine 2 - to use or not to use (<a href="https://qafoo.com/resources/presentations/symfonycon_paris_2015/doctrine2_to_use_or_not_to_use.html">see slides</a>)</li>
</ul>
<p><strong>All available slides from the conference to find <a href="https://joind.in/event/symfonycon-paris-2015/schedule/list">Joind.in</a></strong>.</p>
<h2 id="What-are-my-Takeaways">What are my Takeaways?</h2>
<p>In addition to the 5 Elephants, 1 T-shirts and contacts to the lead developers of open-sources projects, I met at the conference...</p>
<ul>
<li>with the latest trends in Symfony and other large projects</li>
<li>with how to build a community built on equality and people</li>
<li>with people with open-source environment, which I previously knew only from the avatar on GitHub</li>
</ul>
<p>A lot of taste experiences bizarre French cuisine :).</p>
<div class="text-center">
    <img src="/assets/images/posts/2015/symfonycon/symfonycon-stage.jpg" class="img-thumbnail">
</div> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2015/12/20/the-best-of-symfonycon-2015</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Sun, 20 Dec 2015 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2015/12/20/the-best-of-symfonycon-2015#disqus_thread</comments>
            </item>
                    
            <item>
                <title><![CDATA[ 4 Hot News in Symfony 3 ]]></title>
                <link>https://tomasvotruba.com/blog/2015/11/09/4-hot-news-in-symfony-3</link>
                <description><![CDATA[ <p>In November 2015 except for a <a href="https://wiki.php.net/rfc/php7timeline">PHP 7</a> and <a href="https://www.drupal.org/node/2605142">Drupal 8</a>,
Symfony 3 is about to come.
<br><br>
<strong>What changes and news it brings?</strong></p> ]]></description>
                <content:encoded><![CDATA[ <p>Symfony already knows that a lot. The new version places great emphasis on the <a href="https://symfony.com/blog/making-the-symfony-experience-exceptional">DX (developer experience)</a>. It brings us a <strong>simpler and more straightforward API</strong>, <strong>better decoupled components</strong>, <strong>standards <a href="https://www.php-fig.org/psr/psr-3">PSR-3</a> and <a href="https://symfony.com/doc/current/cookbook/psr7.html">PSR-7</a> integration</strong>. A lot of other innovations that will make writing applications just got more fun.</p>
<h2 id="When-is-What-Version-Out">When is What Version Out?</h2>
<p>Have you migrated from Symfony 1 to 2 and do you want to avoid a similar massacre? Don't worry - although there are lot of news, Symfony now respects <a href="https://symfony.com/doc/current/contributing/code/bc.html">backward compatibility promise</a>.</p>
<p>Migration Symfony 2 to 3 will be greatly simplified by the fact that <strong>along with the version 3 will be released and version 2.8</strong>. <strong>It will have all the new feature in version 3 and will include BC layer to the 2.x series</strong>. Version 2.8 will be long term supported (LTS) - so you can <strong>count on the support until the end of 2018</strong>.</p>
<p><br></p>
<div class="text-center">
    <img src="/assets/images/posts/2015/symfony3/release-plan.png">
    <br>
    <em>Version 2.8 will LTS. The first LTS new series will be up to 3.3 (to be released in May 2017).</em>
</div>
<p><br></p>
<p>What are the 2 main differences between 3.0 and 2.8 then?</p>
<ul>
<li>min. PHP version 5.5</li>
<li>removing all deprecated code that provides compatibility to the BC 2.x (~ 10% of the code)</li>
</ul>
<p>And now 4 the most expected news.</p>
<h2 id="1-Service-Autowiring">1. Service Autowiring</h2>
<p><a href="https://github.com/symfony/symfony/pull/15613" class="btn btn-dark btn-sm">
See pull-request
</a></p>
<p>Symfony now supports constructor autowiring. When you are creating a service definition so you can turn on <code>autowiring</code> and skip the manual passing arguments.</p>
<p>Autowiring is quite popular in the Czech Republic due to bundles like <a href="https://github.com/skrz/autowiring-bundle">Skrz</a> or <a href="https://github.com/kutny/autowiring-bundle">Kutny</a></p>
<p><strong>How it looks like in practice?</strong></p>
<p>Earlier long registration</p>
<pre><code class="language-yaml"># services.yml

services:
    myService:
        class: MyBundle\MyService
        arguments: [ @dependency1, @dependency2 ]

    dependency1:
        class: MyBundle\Dependency1

    dependency2:
        class: MyBundle\Dependency2</code></pre>
<p>Now you can cut to</p>
<pre><code class="language-yaml"># services.yml

services:
    myService:
        class: MyBundle\MyService
        autowiring: true</code></pre>
<p><strong>How does it work?</strong></p>
<p>Dependency Injection container analyze constructor and services:</p>
<ul>
<li>if the services are available → forward them</li>
<li>if not → is registered as a private service</li>
</ul>
<p><strong>What about the interface?</strong></p>
<p>Instead of a specific type of service you require an interface that implements the service. But what if we have multiple services to one interface (typical chain pattern)? Just for the service explicitly state:</p>
<pre><code class="language-yaml"># services.yml

services:
    dependency1:
        class: MyBundle\Dependency1
        autowiring_types: MyBundle\MyInterface</code></pre>
<h2 id="2-More-Logical-Folders">2. More Logical Folders</h2>
<p>Symfony 3 full-stack brings order. Get rid of chaos in the <code>/app</code> folder.</p>
<p><strong>How?</strong></p>
<p>Temporary files, logs, settings for PHPUnit, console files...</p>
<p>All this is now obvious location separate from the code of our application.</p>
<p><br></p>
<div class="text-center">
    <img src="/assets/images/posts/2015/symfony3/directory-structure.png" class="img-thumbnail">
</div>
<p><br></p>
<p>Tests you can run simply in command line via <code>vendor/bin/phpunit</code>.</p>
<h2 id="3-Symfony-Profiler-in-a-New-Jacket">3. Symfony Profiler in a New Jacket</h2>
<p><a href="https://github.com/symfony/symfony/pull/15523" class="btn btn-dark btn-sm">
See pull-request
</a></p>
<p>For the programmer it is important not only to clear the code, but also arranged the meta-information about the application. Those in Symfony easily displayed using Symfony Profiler.</p>
<p>He had displayed so much information that it began to lose programmer. After 4 years he has finally made flat design.</p>
<p>Important information and above all error messages are now much easier to read.</p>
<p><br></p>
<div class="text-center">
    <img src="/assets/images/posts/2015/symfony3/profiler-before-after.png" class="img-thumbnail">
</div>
<p><br></p>
<div class="text-center">
    <img src="/assets/images/posts/2015/symfony3/profiler-old-new.png" class="img-thumbnail">
</div>
<p><br></p>
<div class="text-center">
    <img src="/assets/images/posts/2015/symfony3/profiler-go-back.gif" class="img-thumbnail">
    <br>
    <em>Easy to get from profiler back to page</em>
</div>
<h2 id="4-Micro-Kernel">4. Micro Kernel</h2>
<p><a href="https://github.com/symfony/symfony/pull/15990" class="btn btn-dark btn-sm">
See pull-request
</a></p>
<p>Great joy will have smaller applications developers, who enjoy the comfort of the ecosystem full-stack Symfony. A few days ago, on November 5, was added to FrameworkBundle <strong>Micro Kernel</strong>.</p>
<p>That is precisely suited to applications that require simple configuration, bundle and that Silex enough.</p>
<p>Micro Kernel namely:</p>
<ul>
<li>requires no additional configuration files</li>
<li>allows extension without adding bundles</li>
<li>supports routing</li>
</ul>
<p><strong>How does the Micro Kernel looks like?</strong></p>
<pre><code class="language-php">&lt;?php

use Symfony\Bundle\FrameworkBundle\Kernel\MicroKernelTrait;
use Symfony\Bundle\FrameworkBundle\FrameworkBundle;
use Symfony\Component\Config\Loader\LoaderInterface;
use Symfony\Component\DependencyInjection\ContainerBuilder;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\HttpKernel\Kernel;
use Symfony\Component\Routing\RouteCollectionBuilder;

class ConcreteMicroKernel extends Kernel
{
    use MicroKernelTrait;

    public function halloweenAction()
    {
        return new Response('halloween');
    }

    public function registerBundles()
    {
        return [new FrameworkBundle()];
    }

    protected function configureRoutes(RouteCollectionBuilder $routes)
    {
        $routes-&gt;add('/', 'kernel:halloweenAction');
    }

    protected function configureContainer(ContainerBuilder $containerBuilder, LoaderInterface $loader)
    {
        $containerBuilder-&gt;loadFromExtension('framework', [
            'secret' =&gt; '$ecret',
        ]);

        $containerBuilder-&gt;setParameter('title', 'Symfony 3 is painless');
    }
}</code></pre>
<hr>
<h2 id="Now-you-know">Now you know...</h2>
<ul>
<li>That version 2.8 will LTS and released along with version 3.0.</li>
<li>How did autowiring saves work when writing the definition of services.</li>
<li>How do you clean up the ingredients <code>/app</code> to make it make sense.</li>
<li>That work with the profiler will be much clearer.</li>
<li>And for small applications you available Micro Kernel.</li>
</ul>
<h3 id="In-Symfony-they-Know">In Symfony they Know...</h3>
<p><em>When the programmer may resort to more simple solution, he or she will.</em></p>
<p>Therefore, they are trying to use it without its obstacles.</p>
<p><br></p>
<div class="text-center">
    <img src="/assets/images/posts/2015/symfony3/you-got-this-meme.png" class="img-thumbnail">
</div> ]]></content:encoded>
                <guid isPermaLink="false">https://tomasvotruba.com/blog/2015/11/09/4-hot-news-in-symfony-3</guid>
                <dc:creator><![CDATA[ Tomas Votruba ]]></dc:creator>

                                <pubDate>Mon, 09 Nov 2015 00:00:00 +0000</pubDate>
                                    <updated>2022-08-08UTC00:10:460</updated>
                    <atom:updated>Mon, 08 Aug 2022 00:10:46 +0000</atom:updated>
                    <lastBuildDate>Mon, 08 Aug 2022 00:10:46 +0000</lastBuildDate>
                
                <comments>https://tomasvotruba.com/blog/2015/11/09/4-hot-news-in-symfony-3#disqus_thread</comments>
            </item>
            </channel>
</rss>
